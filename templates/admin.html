<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lecture Processor Admin</title>
    <style>
        :root {
            --primary: #4F46E5;
            --secondary: #0EA5E9;
            --success: #10B981;
            --danger: #EF4444;
            --bg: #F8FAFC;
            --card: #FFFFFF;
            --text: #0F172A;
            --muted: #64748B;
            --border: #E2E8F0;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: Inter, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #EFF6FF 0%, var(--bg) 45%, #F8FAFC 100%);
            color: var(--text);
            min-height: 100vh;
        }
        a:focus-visible, button:focus-visible, [role="button"]:focus-visible, [role="menuitem"]:focus-visible, input:focus-visible, select:focus-visible, textarea:focus-visible {
            outline: 2px solid var(--primary);
            outline-offset: 2px;
            box-shadow: 0 0 0 3px rgba(79,70,229,0.16);
        }
        button:focus:not(:focus-visible), a:focus:not(:focus-visible) { outline: none; box-shadow: none; }
        .container { max-width: 1250px; margin: 0 auto; padding: 24px; }
        .topbar {
            display: flex;
            justify-content: space-between;
            gap: 12px;
            align-items: center;
            margin-bottom: 16px;
            background: rgba(255, 255, 255, 0.85);
            border: 1px solid var(--border);
            padding: 14px 16px;
            border-radius: 14px;
            backdrop-filter: blur(8px);
        }
        .topbar h1 { font-size: 1.25rem; font-weight: 700; }
        .topbar .meta { color: var(--muted); font-size: 0.9rem; margin-top: 2px; }
        .actions { display: flex; gap: 8px; flex-wrap: wrap; }
        .filters {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
            background: rgba(255, 255, 255, 0.85);
            border: 1px solid var(--border);
            border-radius: 14px;
            padding: 10px;
            flex-wrap: wrap;
        }
        .deploy-panel {
            margin-bottom: 12px;
        }
        .deploy-grid {
            display: grid;
            grid-template-columns: repeat(4, minmax(0, 1fr));
            gap: 10px;
        }
        .deploy-item {
            border: 1px solid #EEF2FF;
            border-radius: 10px;
            background: #F8FAFC;
            padding: 10px;
            min-height: 74px;
        }
        .deploy-item .label {
            color: var(--muted);
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.04em;
            margin-bottom: 6px;
            display: block;
        }
        .deploy-item .value {
            color: var(--text);
            font-size: 0.9rem;
            font-weight: 700;
            line-height: 1.35;
            word-break: break-word;
        }
        .deploy-badges {
            margin-top: 10px;
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        .status.warn {
            color: #7C2D12;
            background: #FFEDD5;
        }
        .status.ok {
            color: #065F46;
            background: #D1FAE5;
        }
        .btn {
            border: 1px solid var(--border);
            background: #fff;
            color: var(--text);
            padding: 9px 12px;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
        }
        .btn:hover { background: #F8FAFC; }
        .btn.primary {
            border: none;
            color: #fff;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
        }
        .btn.filter.active {
            border: 1px solid transparent;
            color: #fff;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
        }
        .metrics {
            display: grid;
            grid-template-columns: repeat(5, minmax(0, 1fr));
            gap: 12px;
            margin-bottom: 16px;
        }
        .metric {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 14px;
            padding: 14px;
        }
        .metric .label { color: var(--muted); font-size: 0.84rem; margin-bottom: 6px; }
        .metric .value { font-size: 1.3rem; font-weight: 800; }
        .metric .sub { font-size: 0.78rem; color: var(--muted); margin-top: 2px; }
        .charts {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-bottom: 12px;
        }
        .chart-panel {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 14px;
            padding: 14px;
        }
        .chart-panel h2 { font-size: 1rem; margin-bottom: 10px; }
        .chart-wrap {
            display: flex;
            align-items: flex-end;
            gap: 4px;
            height: 180px;
            border: 1px solid #F1F5F9;
            border-radius: 10px;
            padding: 8px;
            background: #F8FAFC;
            overflow: hidden;
        }
        .bar-col {
            flex: 1;
            min-width: 8px;
            display: flex;
            flex-direction: column;
            justify-content: flex-end;
            align-items: center;
            gap: 4px;
            height: 100%;
        }
        .bar {
            width: 100%;
            max-width: 20px;
            border-radius: 6px 6px 0 0;
            min-height: 2px;
        }
        .bar.success { background: linear-gradient(180deg, #34D399, #10B981); }
        .bar.revenue { background: linear-gradient(180deg, #60A5FA, #0EA5E9); }
        .bar-label {
            font-size: 0.64rem;
            color: var(--muted);
            transform: rotate(-40deg);
            transform-origin: top left;
            width: 32px;
            white-space: nowrap;
        }
        .chart-meta {
            margin-top: 8px;
            display: flex;
            justify-content: space-between;
            color: var(--muted);
            font-size: 0.78rem;
        }
        .mode-panel {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 14px;
            padding: 14px;
            margin-bottom: 12px;
        }
        .mode-panel-head {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 8px;
            margin-bottom: 10px;
            flex-wrap: wrap;
        }
        .mode-menu { display: flex; gap: 8px; flex-wrap: wrap; }
        .btn.mode-view.active {
            border: 1px solid transparent;
            color: #fff;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
        }
        .mode-bars { display: grid; gap: 10px; }
        .mode-row {
            display: grid;
            grid-template-columns: 160px 1fr 64px;
            align-items: center;
            gap: 10px;
        }
        .mode-label { font-size: 0.86rem; color: var(--text); font-weight: 600; }
        .mode-track {
            height: 14px;
            border-radius: 999px;
            background: #E2E8F0;
            overflow: hidden;
        }
        .mode-fill {
            height: 100%;
            border-radius: 999px;
            background: linear-gradient(135deg, #60A5FA, #2563EB);
            min-width: 2px;
        }
        .mode-value { font-size: 0.82rem; color: var(--muted); text-align: right; }
        .funnel-panel { margin-bottom: 12px; }
        .funnel-meta { color: var(--muted); font-size: 0.8rem; margin-bottom: 10px; }
        .funnel-list { display: grid; gap: 10px; }
        .funnel-row {
            display: grid;
            grid-template-columns: 180px 1fr 66px 88px;
            gap: 10px;
            align-items: center;
        }
        .funnel-label { font-size: 0.84rem; color: var(--text); font-weight: 600; }
        .funnel-track {
            height: 12px;
            border-radius: 999px;
            background: #E2E8F0;
            overflow: hidden;
        }
        .funnel-fill {
            height: 100%;
            border-radius: 999px;
            background: linear-gradient(135deg, #818CF8, #4F46E5);
            min-width: 2px;
        }
        .funnel-count { font-size: 0.82rem; color: var(--text); text-align: right; font-weight: 700; }
        .funnel-conversion { font-size: 0.78rem; color: var(--muted); text-align: right; }
        .grid {
            display: grid;
            grid-template-columns: 2fr 1.4fr;
            gap: 12px;
        }
        .panel {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 14px;
            padding: 14px;
        }
        .panel h2 { font-size: 1rem; margin-bottom: 10px; }
        .table-wrap { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; font-size: 0.88rem; }
        th, td { text-align: left; padding: 8px 6px; border-bottom: 1px solid #F1F5F9; }
        th { color: var(--muted); font-weight: 600; font-size: 0.78rem; text-transform: uppercase; letter-spacing: 0.03em; }
        .status { font-weight: 700; font-size: 0.78rem; padding: 3px 8px; border-radius: 999px; display: inline-block; }
        .status.complete { color: #065F46; background: #D1FAE5; }
        .status.error { color: #991B1B; background: #FEE2E2; }
        .status.other { color: #1E40AF; background: #DBEAFE; }
        .empty { color: var(--muted); font-size: 0.9rem; padding: 6px 0; }
        .loading, .error, .blocked {
            background: #fff;
            border: 1px solid var(--border);
            border-radius: 14px;
            padding: 20px;
            text-align: center;
        }
        .error { color: #991B1B; border-color: #FECACA; background: #FEF2F2; }
        .blocked { color: #7C2D12; border-color: #FED7AA; background: #FFF7ED; }
        @media (max-width: 1100px) {
            .metrics { grid-template-columns: repeat(3, minmax(0, 1fr)); }
            .charts { grid-template-columns: 1fr; }
            .grid { grid-template-columns: 1fr; }
            .deploy-grid { grid-template-columns: repeat(2, minmax(0, 1fr)); }
        }
        @media (max-width: 720px) {
            .metrics { grid-template-columns: repeat(2, minmax(0, 1fr)); }
            .mode-row { grid-template-columns: 1fr; }
            .mode-value { text-align: left; }
            .funnel-row { grid-template-columns: 1fr; }
            .funnel-count, .funnel-conversion { text-align: left; }
            .deploy-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="topbar">
            <div>
                <h1>Lecture Processor Admin</h1>
                <div class="meta" id="signed-in-meta">Checking sign-in...</div>
            </div>
            <div class="actions">
                <button class="btn" id="back-btn" type="button">Back to app</button>
                <button class="btn" id="refresh-btn" type="button">Refresh</button>
                <button class="btn" id="export-jobs-btn" type="button">Export jobs CSV</button>
                <button class="btn" id="export-purchases-btn" type="button">Export purchases CSV</button>
                <button class="btn" id="export-funnel-btn" type="button">Export funnel CSV</button>
                <button class="btn" id="export-funnel-daily-btn" type="button">Export funnel daily CSV</button>
                <button class="btn primary" id="auth-btn" type="button">Sign in</button>
            </div>
        </div>

        <div class="filters">
            <button class="btn filter" data-window="24h" type="button">Last 24h</button>
            <button class="btn filter active" data-window="7d" type="button">Last 7d</button>
            <button class="btn filter" data-window="30d" type="button">Last 30d</button>
        </div>

        <div id="state-area" class="loading">Loading admin dashboard...</div>

        <div id="dashboard" style="display:none;">
            <section class="panel deploy-panel">
                <h2>Deployment Sanity</h2>
                <div class="deploy-grid">
                    <article class="deploy-item">
                        <span class="label">Runtime</span>
                        <div class="value" id="d-runtime">-</div>
                    </article>
                    <article class="deploy-item">
                        <span class="label">Service</span>
                        <div class="value" id="d-service">-</div>
                    </article>
                    <article class="deploy-item">
                        <span class="label">Git</span>
                        <div class="value" id="d-git">-</div>
                    </article>
                    <article class="deploy-item">
                        <span class="label">Host</span>
                        <div class="value" id="d-host">-</div>
                    </article>
                </div>
                <div class="deploy-badges">
                    <span class="status other" id="d-host-badge">Host check pending</span>
                    <span class="status other" id="d-stripe-badge">Stripe mode check pending</span>
                    <span class="status other" id="d-pptx-badge">PPTX check pending</span>
                    <span class="status other" id="d-video-badge">Video import check pending</span>
                </div>
            </section>

            <section class="metrics">
                <article class="metric"><div class="label">Total users</div><div class="value" id="m-users">0</div><div class="sub" id="m-users-sub">0 new in window</div></article>
                <article class="metric"><div class="label">Jobs in window</div><div class="value" id="m-jobs">0</div></article>
                <article class="metric"><div class="label">Success rate</div><div class="value" id="m-success-rate">0%</div></article>
                <article class="metric"><div class="label">Revenue in window</div><div class="value" id="m-revenue">€0.00</div></article>
                <article class="metric"><div class="label">Purchases in window</div><div class="value" id="m-purchases">0</div></article>
                <article class="metric"><div class="label">Credits processed</div><div class="value" id="m-processed">0</div><div class="sub">All-time</div></article>
                <article class="metric"><div class="label">Refunded jobs</div><div class="value" id="m-refunds">0</div></article>
                <article class="metric"><div class="label">Avg duration</div><div class="value" id="m-duration">0s</div></article>
                <article class="metric"><div class="label">Successful jobs</div><div class="value" id="m-success-jobs">0</div></article>
                <article class="metric"><div class="label">Failed jobs</div><div class="value" id="m-failed-jobs">0</div></article>
                <article class="metric"><div class="label">Rate-limit 429s</div><div class="value" id="m-rate-limit-total">0</div><div class="sub" id="m-rate-limit-sub">U: 0 · C: 0 · A: 0</div></article>
            </section>

            <section class="charts">
                <div class="chart-panel">
                    <h2>Success Rate Trend</h2>
                    <div class="chart-wrap" id="success-chart"></div>
                    <div class="chart-meta"><span id="success-granularity">Granularity: day</span><span id="success-latest">Latest: 0%</span></div>
                </div>
                <div class="chart-panel">
                    <h2>Revenue Trend (EUR)</h2>
                    <div class="chart-wrap" id="revenue-chart"></div>
                    <div class="chart-meta"><span id="revenue-granularity">Granularity: day</span><span id="revenue-total">Window total: €0.00</span></div>
                </div>
            </section>

            <section class="mode-panel">
                <div class="mode-panel-head">
                    <h2>Mode Breakdown</h2>
                    <div class="mode-menu">
                        <button class="btn mode-view active" data-mode-view="total" type="button">Total</button>
                        <button class="btn mode-view" data-mode-view="complete" type="button">Success</button>
                        <button class="btn mode-view" data-mode-view="error" type="button">Failed</button>
                    </div>
                </div>
                <div class="mode-bars" id="mode-breakdown-bars"></div>
            </section>

            <section class="panel funnel-panel">
                <h2>Conversion Funnel</h2>
                <div class="funnel-meta" id="funnel-meta">Counts are based on tracked user/session events.</div>
                <div class="funnel-list" id="funnel-list"></div>
            </section>

            <section class="grid">
                <div class="panel">
                    <h2>Recent Jobs</h2>
                    <div class="table-wrap">
                        <table>
                            <thead>
                                <tr>
                                    <th>Time</th>
                                    <th>User</th>
                                    <th>Mode</th>
                                    <th>Status</th>
                                    <th>Duration</th>
                                    <th>Refund</th>
                                </tr>
                            </thead>
                            <tbody id="jobs-body"></tbody>
                        </table>
                    </div>
                </div>
                <div class="panel">
                    <h2>Recent Purchases</h2>
                    <div class="table-wrap">
                        <table>
                            <thead>
                                <tr>
                                    <th>Time</th>
                                    <th>Bundle</th>
                                    <th>Amount</th>
                                </tr>
                            </thead>
                            <tbody id="purchases-body"></tbody>
                        </table>
                    </div>
                </div>
            </section>

            <section class="panel" style="margin-top:12px;">
                <h2>Recent Rate-limit Hits</h2>
                <div class="table-wrap">
                    <table>
                        <thead>
                            <tr>
                                <th>Time</th>
                                <th>Limiter</th>
                                <th>Retry-after</th>
                            </tr>
                        </thead>
                        <tbody id="rate-limit-body"></tbody>
                    </table>
                </div>
            </section>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth-compat.js"></script>
    <script src="{{ url_for('static', filename='js/auth-utils.js') }}"></script>
    <script src="{{ url_for('static', filename='js/download-utils.js') }}"></script>
    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyBAAeEUCPNvP5qnqpP3M6HnFZ6vaaijUvM",
            authDomain: "lecture-processor-cdff6.firebaseapp.com",
            projectId: "lecture-processor-cdff6",
            storageBucket: "lecture-processor-cdff6.firebasestorage.app",
            messagingSenderId: "374793454161",
            appId: "1:374793454161:web:c68b21590e9a1fafa32e70"
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const authUtils = window.LectureProcessorAuth || {};
        const authClient = authUtils.createAuthClient ? authUtils.createAuthClient(auth, { notSignedInMessage: 'Not signed in' }) : null;
        const downloadUtils = window.LectureProcessorDownload || {};

        const signedInMeta = document.getElementById('signed-in-meta');
        const stateArea = document.getElementById('state-area');
        const dashboard = document.getElementById('dashboard');
        const authBtn = document.getElementById('auth-btn');
        const refreshBtn = document.getElementById('refresh-btn');
        const backBtn = document.getElementById('back-btn');
        const exportJobsBtn = document.getElementById('export-jobs-btn');
        const exportPurchasesBtn = document.getElementById('export-purchases-btn');
        const exportFunnelBtn = document.getElementById('export-funnel-btn');
        const exportFunnelDailyBtn = document.getElementById('export-funnel-daily-btn');
        const deploymentRuntime = document.getElementById('d-runtime');
        const deploymentService = document.getElementById('d-service');
        const deploymentGit = document.getElementById('d-git');
        const deploymentHost = document.getElementById('d-host');
        const deploymentHostBadge = document.getElementById('d-host-badge');
        const deploymentStripeBadge = document.getElementById('d-stripe-badge');
        const deploymentPptxBadge = document.getElementById('d-pptx-badge');
        const deploymentVideoBadge = document.getElementById('d-video-badge');

        let currentWindow = '7d';
        let currentModeView = 'total';
        let latestModeBreakdown = {};

        function authFetch(path, options) {
            if (authClient && typeof authClient.authFetch === 'function') {
                return authClient.authFetch(path, options, { retryOn401: true });
            }
            if (!auth.currentUser) {
                return Promise.reject(new Error('Not signed in'));
            }
            return auth.currentUser.getIdToken().then((token) => {
                const opts = options || {};
                const headers = Object.assign({}, opts.headers || {}, { 'Authorization': `Bearer ${token}` });
                return fetch(path, Object.assign({}, opts, { headers }));
            });
        }

        function formatMoney(cents) {
            return `€${((cents || 0) / 100).toFixed(2)}`;
        }

        function formatDate(timestampSeconds) {
            if (!timestampSeconds) return '-';
            const dt = new Date(timestampSeconds * 1000);
            return dt.toLocaleString('en-GB', {
                day: '2-digit', month: 'short', year: 'numeric',
                hour: '2-digit', minute: '2-digit'
            });
        }

        function formatRateLimitLabel(limitName) {
            const key = String(limitName || '').trim().toLowerCase();
            if (key === 'upload') return 'Upload';
            if (key === 'checkout') return 'Checkout';
            if (key === 'analytics') return 'Analytics';
            return 'Other';
        }

        function setStatusBadge(el, label, ok) {
            if (!el) return;
            el.textContent = label;
            el.className = `status ${ok ? 'ok' : 'warn'}`;
        }

        function setState(message, type = 'loading') {
            stateArea.textContent = message;
            stateArea.className = type;
            stateArea.style.display = 'block';
            dashboard.style.display = 'none';
        }

        function clearChildren(node) {
            while (node.firstChild) node.removeChild(node.firstChild);
        }

        function renderRows(tbodyId, rows, emptyText, colspan = 8) {
            const tbody = document.getElementById(tbodyId);
            clearChildren(tbody);
            if (!rows.length) {
                const tr = document.createElement('tr');
                const td = document.createElement('td');
                td.colSpan = colspan;
                td.className = 'empty';
                td.textContent = emptyText;
                tr.appendChild(td);
                tbody.appendChild(tr);
                return;
            }
            rows.forEach((row) => tbody.appendChild(row));
        }

        function renderBars(containerId, labels, values, type) {
            const container = document.getElementById(containerId);
            clearChildren(container);
            if (!labels.length) {
                const empty = document.createElement('div');
                empty.className = 'empty';
                empty.textContent = 'No data for selected window.';
                container.appendChild(empty);
                return;
            }
            const maxValue = Math.max(...values, 1);
            labels.forEach((label, idx) => {
                const value = values[idx] || 0;
                const heightPercent = (value / maxValue) * 100;
                const col = document.createElement('div');
                col.className = 'bar-col';
                col.title = `${label}: ${type === 'success' ? value + '%' : formatMoney(value)}`;
                const bar = document.createElement('div');
                bar.className = `bar ${type}`;
                bar.style.height = `${Math.max(heightPercent, 1)}%`;
                const labelEl = document.createElement('div');
                labelEl.className = 'bar-label';
                labelEl.textContent = label;
                col.appendChild(bar);
                if (labels.length <= 12 || idx % Math.ceil(labels.length / 10) === 0 || idx === labels.length - 1) {
                    col.appendChild(labelEl);
                }
                container.appendChild(col);
            });
        }

        function renderModeBreakdown() {
            const container = document.getElementById('mode-breakdown-bars');
            clearChildren(container);
            const entries = Object.values(latestModeBreakdown || {}).filter((item) => item && item.label);
            if (!entries.length) {
                const empty = document.createElement('div');
                empty.className = 'empty';
                empty.textContent = 'No mode data for selected window.';
                container.appendChild(empty);
                return;
            }
            const maxValue = Math.max(...entries.map((entry) => entry[currentModeView] || 0), 1);
            entries.forEach((entry) => {
                const value = entry[currentModeView] || 0;
                const width = Math.max((value / maxValue) * 100, value > 0 ? 2 : 0);
                const row = document.createElement('div');
                row.className = 'mode-row';
                const label = document.createElement('div');
                label.className = 'mode-label';
                label.textContent = String(entry.label || '-');
                const track = document.createElement('div');
                track.className = 'mode-track';
                const fill = document.createElement('div');
                fill.className = 'mode-fill';
                fill.style.width = `${width}%`;
                track.appendChild(fill);
                const valueEl = document.createElement('div');
                valueEl.className = 'mode-value';
                valueEl.textContent = String(value);
                row.appendChild(label);
                row.appendChild(track);
                row.appendChild(valueEl);
                container.appendChild(row);
            });
        }

        function renderFunnel(funnel) {
            const list = document.getElementById('funnel-list');
            const meta = document.getElementById('funnel-meta');
            const steps = (funnel && Array.isArray(funnel.steps)) ? funnel.steps : [];
            clearChildren(list);
            if (!steps.length) {
                meta.textContent = 'No funnel events captured in the selected window.';
                const empty = document.createElement('div');
                empty.className = 'empty';
                empty.textContent = 'No conversion data yet.';
                list.appendChild(empty);
                return;
            }
            meta.textContent = 'Counts are unique users/sessions that reached each stage.';
            const maxCount = Math.max(...steps.map((step) => Number(step.count || 0)), 1);
            steps.forEach((step, idx) => {
                const count = Number(step.count || 0);
                const width = Math.max((count / maxCount) * 100, count > 0 ? 2 : 0);
                const conversion = Number(step.conversion_from_prev || 0);
                const conversionLabel = idx === 0 ? 'Start' : `${conversion}% from previous`;
                const row = document.createElement('div');
                row.className = 'funnel-row';
                const label = document.createElement('div');
                label.className = 'funnel-label';
                label.textContent = String(step.label || step.event || '-');
                const track = document.createElement('div');
                track.className = 'funnel-track';
                const fill = document.createElement('div');
                fill.className = 'funnel-fill';
                fill.style.width = `${width}%`;
                track.appendChild(fill);
                const countEl = document.createElement('div');
                countEl.className = 'funnel-count';
                countEl.textContent = String(count);
                const conversionEl = document.createElement('div');
                conversionEl.className = 'funnel-conversion';
                conversionEl.textContent = conversionLabel;
                row.appendChild(label);
                row.appendChild(track);
                row.appendChild(countEl);
                row.appendChild(conversionEl);
                list.appendChild(row);
            });
        }

        function renderDashboard(data) {
            const m = data.metrics || {};
            const t = data.trends || {};
            const successRate = m.job_count > 0 ? Math.round((m.success_jobs / m.job_count) * 100) : 0;
            const deployment = data.deployment || {};
            const runtimeChecks = data.runtime_checks || {};

            deploymentRuntime.textContent = deployment.runtime || '-';
            deploymentService.textContent = deployment.service_name || deployment.service_id || '-';
            deploymentGit.textContent = deployment.git_commit_short ? `${deployment.git_branch || '-'} · ${deployment.git_commit_short}` : (deployment.git_branch || '-');
            deploymentHost.textContent = deployment.request_host || '-';

            const hostMatchKnown = typeof deployment.host_matches_render === 'boolean';
            if (!hostMatchKnown) {
                setStatusBadge(deploymentHostBadge, 'Host check: no Render hostname configured', true);
            } else if (deployment.host_matches_render) {
                setStatusBadge(deploymentHostBadge, `Host check: matches ${deployment.render_external_hostname}`, true);
            } else {
                setStatusBadge(deploymentHostBadge, `Host check: mismatch (expected ${deployment.render_external_hostname})`, false);
            }

            const stripeSecretMode = runtimeChecks.stripe_secret_mode || 'missing';
            const stripePublishableMode = runtimeChecks.stripe_publishable_mode || 'missing';
            const stripeOk = Boolean(runtimeChecks.stripe_keys_match);
            setStatusBadge(
                deploymentStripeBadge,
                `Stripe keys: secret=${stripeSecretMode}, publishable=${stripePublishableMode}`,
                stripeOk
            );
            setStatusBadge(
                deploymentPptxBadge,
                runtimeChecks.pptx_conversion_available ? 'PPTX conversion: available' : 'PPTX conversion: unavailable',
                Boolean(runtimeChecks.pptx_conversion_available)
            );
            setStatusBadge(
                deploymentVideoBadge,
                runtimeChecks.video_import_available ? 'Video import toolchain: available' : 'Video import toolchain: unavailable',
                Boolean(runtimeChecks.video_import_available)
            );

            document.getElementById('m-users').textContent = m.total_users || 0;
            document.getElementById('m-users-sub').textContent = `${m.new_users || 0} new in window`;
            document.getElementById('m-jobs').textContent = m.job_count || 0;
            document.getElementById('m-success-rate').textContent = `${successRate}%`;
            document.getElementById('m-revenue').textContent = formatMoney(m.total_revenue_cents || 0);
            document.getElementById('m-purchases').textContent = m.purchase_count || 0;
            document.getElementById('m-processed').textContent = m.total_processed || 0;
            document.getElementById('m-refunds').textContent = m.refunded_jobs || 0;
            document.getElementById('m-duration').textContent = `${m.avg_duration_seconds || 0}s`;
            document.getElementById('m-success-jobs').textContent = m.success_jobs || 0;
            document.getElementById('m-failed-jobs').textContent = m.failed_jobs || 0;
            document.getElementById('m-rate-limit-total').textContent = m.rate_limit_429_total || 0;
            document.getElementById('m-rate-limit-sub').textContent = `U: ${m.rate_limit_upload_429 || 0} · C: ${m.rate_limit_checkout_429 || 0} · A: ${m.rate_limit_analytics_429 || 0}`;

            const labels = t.labels || [];
            const successTrend = t.success_rate || [];
            const revenueTrend = t.revenue_cents || [];
            latestModeBreakdown = data.mode_breakdown || {};

            renderBars('success-chart', labels, successTrend, 'success');
            renderBars('revenue-chart', labels, revenueTrend, 'revenue');
            renderModeBreakdown();
            renderFunnel(data.funnel || {});

            document.getElementById('success-granularity').textContent = `Granularity: ${t.granularity || 'day'}`;
            document.getElementById('revenue-granularity').textContent = `Granularity: ${t.granularity || 'day'}`;
            document.getElementById('success-latest').textContent = `Latest: ${successTrend.length ? successTrend[successTrend.length - 1] : 0}%`;
            const revenueTotal = revenueTrend.reduce((acc, value) => acc + (value || 0), 0);
            document.getElementById('revenue-total').textContent = `Window total: ${formatMoney(revenueTotal)}`;

            const jobRows = (data.recent_jobs || []).map((job) => {
                const status = job.status || 'unknown';
                const statusClass = status === 'complete' ? 'complete' : (status === 'error' ? 'error' : 'other');
                const tr = document.createElement('tr');
                const tdTime = document.createElement('td');
                tdTime.textContent = formatDate(job.finished_at);
                const tdEmail = document.createElement('td');
                tdEmail.textContent = (job.email || '').slice(0, 32) || '-';
                const tdMode = document.createElement('td');
                tdMode.textContent = job.mode || '-';
                const tdStatus = document.createElement('td');
                const statusBadge = document.createElement('span');
                statusBadge.className = `status ${statusClass}`;
                statusBadge.textContent = status;
                tdStatus.appendChild(statusBadge);
                const tdDuration = document.createElement('td');
                tdDuration.textContent = `${job.duration_seconds || 0}s`;
                const tdRefund = document.createElement('td');
                tdRefund.textContent = job.credit_refunded ? 'Yes' : 'No';
                tr.appendChild(tdTime);
                tr.appendChild(tdEmail);
                tr.appendChild(tdMode);
                tr.appendChild(tdStatus);
                tr.appendChild(tdDuration);
                tr.appendChild(tdRefund);
                return tr;
            });
            renderRows('jobs-body', jobRows, 'No jobs found in selected window.', 6);

            const purchaseRows = (data.recent_purchases || []).map((purchase) => {
                const tr = document.createElement('tr');
                const tdTime = document.createElement('td');
                tdTime.textContent = formatDate(purchase.created_at);
                const tdBundle = document.createElement('td');
                tdBundle.textContent = purchase.bundle_name || '-';
                const tdAmount = document.createElement('td');
                tdAmount.textContent = formatMoney(purchase.price_cents || 0);
                tr.appendChild(tdTime);
                tr.appendChild(tdBundle);
                tr.appendChild(tdAmount);
                return tr;
            });
            renderRows('purchases-body', purchaseRows, 'No purchases found in selected window.', 3);

            const rateLimitRows = (data.recent_rate_limits || []).map((entry) => {
                const tr = document.createElement('tr');
                const tdTime = document.createElement('td');
                tdTime.textContent = formatDate(entry.created_at);
                const tdLimiter = document.createElement('td');
                tdLimiter.textContent = formatRateLimitLabel(entry.limit_name);
                const tdRetry = document.createElement('td');
                tdRetry.textContent = `${entry.retry_after_seconds || 0}s`;
                tr.appendChild(tdTime);
                tr.appendChild(tdLimiter);
                tr.appendChild(tdRetry);
                return tr;
            });
            renderRows('rate-limit-body', rateLimitRows, 'No rate-limit hits found in selected window.', 3);

            stateArea.style.display = 'none';
            dashboard.style.display = 'block';
        }

        async function loadAdminOverview(user) {
            if (!user) {
                setState('Please sign in to continue.', 'blocked');
                return;
            }
            setState('Loading admin dashboard...', 'loading');
            try {
                const res = await authFetch(`/api/admin/overview?window=${encodeURIComponent(currentWindow)}`);

                if (res.status === 403) {
                    setState('Your account is signed in but not configured as admin. Set ADMIN_EMAILS or ADMIN_UIDS on the server.', 'blocked');
                    return;
                }
                if (!res.ok) {
                    setState('Could not load dashboard data. Please refresh.', 'error');
                    return;
                }

                const data = await res.json();
                renderDashboard(data);
            } catch (error) {
                console.error(error);
                setState('Network error while loading dashboard.', 'error');
            }
        }

        async function exportCsv(type) {
            if (!auth.currentUser) {
                setState('Please sign in to export CSV.', 'blocked');
                return;
            }
            try {
                const res = await authFetch(`/api/admin/export?type=${encodeURIComponent(type)}&window=${encodeURIComponent(currentWindow)}`);
                if (!res.ok) {
                    setState('Could not export CSV right now.', 'error');
                    return;
                }
                if (downloadUtils.downloadResponseBlob) {
                    await downloadUtils.downloadResponseBlob(res, `admin-${type}-${currentWindow}.csv`);
                    return;
                }
                const blob = await res.blob();
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `admin-${type}-${currentWindow}.csv`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            } catch (error) {
                console.error(error);
                setState('Network error while exporting CSV.', 'error');
            }
        }

        function setActiveFilterButton() {
            document.querySelectorAll('.filter').forEach((btn) => {
                btn.classList.toggle('active', btn.dataset.window === currentWindow);
            });
        }

        function setActiveModeViewButton() {
            document.querySelectorAll('.mode-view').forEach((btn) => {
                btn.classList.toggle('active', btn.dataset.modeView === currentModeView);
            });
        }

        auth.onAuthStateChanged(async (user) => {
            if (user) {
                if (authClient && typeof authClient.setToken === 'function') {
                    try { authClient.setToken(await user.getIdToken()); } catch (_) {}
                }
                signedInMeta.textContent = `Signed in as ${user.email}`;
                authBtn.textContent = 'Sign out';
                await loadAdminOverview(user);
            } else {
                if (authClient && typeof authClient.clearToken === 'function') authClient.clearToken();
                signedInMeta.textContent = 'Not signed in';
                authBtn.textContent = 'Sign in';
                setState('Please sign in with your admin account.', 'blocked');
            }
        });

        authBtn.addEventListener('click', async () => {
            if (auth.currentUser) {
                await auth.signOut();
                return;
            }
            window.location.href = '/';
        });

        refreshBtn.addEventListener('click', async () => {
            if (!auth.currentUser) {
                setState('Please sign in to refresh.', 'blocked');
                return;
            }
            await loadAdminOverview(auth.currentUser);
        });

        backBtn.addEventListener('click', () => {
            window.location.href = '/';
        });

        exportJobsBtn.addEventListener('click', async () => {
            await exportCsv('jobs');
        });

        exportPurchasesBtn.addEventListener('click', async () => {
            await exportCsv('purchases');
        });

        exportFunnelBtn.addEventListener('click', async () => {
            await exportCsv('funnel');
        });

        exportFunnelDailyBtn.addEventListener('click', async () => {
            await exportCsv('funnel-daily');
        });

        document.querySelectorAll('.filter').forEach((btn) => {
            btn.addEventListener('click', async () => {
                currentWindow = btn.dataset.window;
                setActiveFilterButton();
                if (auth.currentUser) {
                    await loadAdminOverview(auth.currentUser);
                }
            });
        });

        document.querySelectorAll('.mode-view').forEach((btn) => {
            btn.addEventListener('click', () => {
                currentModeView = btn.dataset.modeView;
                setActiveModeViewButton();
                renderModeBreakdown();
            });
        });

        setActiveFilterButton();
        setActiveModeViewButton();
    </script>
</body>
</html>
