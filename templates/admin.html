<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lecture Processor Admin</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/admin.css') }}">
</head>

<body>
    <div class="container">
        <div class="topbar">
            <div>
                <h1>Lecture Processor Admin</h1>
                <div class="meta" id="signed-in-meta">Checking sign-in...</div>
            </div>
            <div class="actions">
                <button class="btn" id="back-btn" type="button">Back to app</button>
                <button class="btn" id="refresh-btn" type="button">Refresh</button>
                <button class="btn" id="export-jobs-btn" type="button">Export jobs CSV</button>
                <button class="btn" id="export-purchases-btn" type="button">Export purchases CSV</button>
                <button class="btn" id="export-funnel-btn" type="button">Export funnel CSV</button>
                <button class="btn" id="export-funnel-daily-btn" type="button">Export funnel daily CSV</button>
                <button class="btn primary" id="auth-btn" type="button">Sign in</button>
            </div>
        </div>

        <div class="filters">
            <button class="btn filter" data-window="24h" type="button">Last 24h</button>
            <button class="btn filter active" data-window="7d" type="button">Last 7d</button>
            <button class="btn filter" data-window="30d" type="button">Last 30d</button>
        </div>

        <div id="state-area" class="loading">Loading admin dashboard...</div>

        <div id="dashboard" style="display:none;">
            <section class="metrics">
                <article class="metric">
                    <div class="label">Total users</div>
                    <div class="value" id="m-users">0</div>
                    <div class="sub" id="m-users-sub">0 new in window</div>
                </article>
                <article class="metric">
                    <div class="label">Jobs in window</div>
                    <div class="value" id="m-jobs">0</div>
                </article>
                <article class="metric">
                    <div class="label">Success rate</div>
                    <div class="value" id="m-success-rate">0%</div>
                </article>
                <article class="metric">
                    <div class="label">Revenue in window</div>
                    <div class="value" id="m-revenue">€0.00</div>
                </article>
                <article class="metric">
                    <div class="label">Purchases in window</div>
                    <div class="value" id="m-purchases">0</div>
                </article>
                <article class="metric">
                    <div class="label">Credits processed</div>
                    <div class="value" id="m-processed">0</div>
                    <div class="sub">All-time</div>
                </article>
                <article class="metric">
                    <div class="label">Refunded jobs</div>
                    <div class="value" id="m-refunds">0</div>
                </article>
                <article class="metric">
                    <div class="label">Avg duration</div>
                    <div class="value" id="m-duration">0s</div>
                </article>
                <article class="metric">
                    <div class="label">Successful jobs</div>
                    <div class="value" id="m-success-jobs">0</div>
                </article>
                <article class="metric">
                    <div class="label">Failed jobs</div>
                    <div class="value" id="m-failed-jobs">0</div>
                </article>
                <article class="metric">
                    <div class="label">Rate-limit 429s</div>
                    <div class="value" id="m-rate-limit-total">0</div>
                    <div class="sub" id="m-rate-limit-sub">U: 0 · C: 0 · A: 0</div>
                </article>
            </section>

            <section class="charts">
                <div class="chart-panel">
                    <h2>Success Rate Trend</h2>
                    <div class="chart-wrap" id="success-chart"></div>
                    <div class="chart-meta"><span id="success-granularity">Granularity: day</span><span
                            id="success-latest">Latest: 0%</span></div>
                </div>
                <div class="chart-panel">
                    <h2>Revenue Trend (EUR)</h2>
                    <div class="chart-wrap" id="revenue-chart"></div>
                    <div class="chart-meta"><span id="revenue-granularity">Granularity: day</span><span
                            id="revenue-total">Window total: €0.00</span></div>
                </div>
            </section>

            <section class="mode-panel">
                <div class="mode-panel-head">
                    <h2>Mode Breakdown</h2>
                    <div class="mode-menu">
                        <button class="btn mode-view active" data-mode-view="total" type="button">Total</button>
                        <button class="btn mode-view" data-mode-view="complete" type="button">Success</button>
                        <button class="btn mode-view" data-mode-view="error" type="button">Failed</button>
                    </div>
                </div>
                <div class="mode-bars" id="mode-breakdown-bars"></div>
            </section>

            <section class="panel funnel-panel">
                <h2>Conversion Funnel</h2>
                <div class="funnel-meta" id="funnel-meta">Counts are based on tracked user/session events.</div>
                <div class="funnel-list" id="funnel-list"></div>
            </section>

            <section class="grid">
                <div class="panel">
                    <h2>Recent Jobs</h2>
                    <div class="table-wrap">
                        <table>
                            <thead>
                                <tr>
                                    <th>Time</th>
                                    <th>User</th>
                                    <th>Mode</th>
                                    <th>Status</th>
                                    <th>Duration</th>
                                    <th>Refund</th>
                                    <th>In Tokens</th>
                                    <th>Out Tokens</th>
                                    <th>Total Tokens</th>
                                </tr>
                            </thead>
                            <tbody id="jobs-body"></tbody>
                        </table>
                    </div>
                </div>
                <div class="panel">
                    <h2>Recent Purchases</h2>
                    <div class="table-wrap">
                        <table>
                            <thead>
                                <tr>
                                    <th>Time</th>
                                    <th>Bundle</th>
                                    <th>Amount</th>
                                </tr>
                            </thead>
                            <tbody id="purchases-body"></tbody>
                        </table>
                    </div>
                </div>
            </section>

            <section class="panel" style="margin-top:12px;">
                <h2>Recent Rate-limit Hits</h2>
                <div class="table-wrap">
                    <table>
                        <thead>
                            <tr>
                                <th>Time</th>
                                <th>Limiter</th>
                                <th>Retry-after</th>
                            </tr>
                        </thead>
                        <tbody id="rate-limit-body"></tbody>
                    </table>
                </div>
            </section>

            <section class="panel" style="margin-top:12px;">
                <div style="display:flex;align-items:center;gap:8px;">
                    <h2>Prompt Inventory</h2>
                    <button class="btn" id="load-prompts-btn" type="button">Load prompts</button>
                </div>
                <pre id="prompts-output"
                    style="display:none;white-space:pre-wrap;max-height:600px;overflow:auto;background:#1a1a2e;color:#e0e0e0;padding:12px;border-radius:8px;font-size:13px;margin-top:8px;"></pre>
            </section>

            <section class="panel" style="margin-top:12px;">
                <h2>Cost Calculator</h2>
                <div style="display:flex;gap:12px;align-items:center;margin-bottom:10px;flex-wrap:wrap;">
                    <label for="calc-scenario" style="font-weight:600;">Scenario:</label>
                    <select id="calc-scenario"
                        style="padding:6px 10px;border-radius:6px;border:1px solid #444;background:#1a1a2e;color:#e0e0e0;font-size:14px;"></select>
                    <label for="calc-bundle-price" style="font-weight:600;margin-left:12px;">Bundle price (€):</label>
                    <input id="calc-bundle-price" type="number" value="2.49" step="0.01" min="0"
                        style="width:80px;padding:6px;border-radius:6px;border:1px solid #444;background:#1a1a2e;color:#e0e0e0;font-size:14px;">
                </div>
                <div class="table-wrap">
                    <table>
                        <thead>
                            <tr>
                                <th>Stage</th>
                                <th>Model</th>
                                <th>Input tokens</th>
                                <th>Output tokens</th>
                                <th>Input cost ($)</th>
                                <th>Output cost ($)</th>
                                <th>Stage cost ($)</th>
                            </tr>
                        </thead>
                        <tbody id="calc-body"></tbody>
                        <tfoot>
                            <tr style="font-weight:700;">
                                <td colspan="4" style="text-align:right;">Total API cost:</td>
                                <td id="calc-total-input">$0.000</td>
                                <td id="calc-total-output">$0.000</td>
                                <td id="calc-total">$0.000</td>
                            </tr>
                            <tr style="font-weight:700;">
                                <td colspan="6" style="text-align:right;">Margin (bundle − cost):</td>
                                <td id="calc-margin" style="color:#4ade80;">$0.000</td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </section>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth-compat.js"></script>
    <script src="{{ url_for('static', filename='js/auth-utils.js') }}"></script>
    <script src="{{ url_for('static', filename='js/download-utils.js') }}"></script>
    <script src="{{ url_for('static', filename=admin_js_asset or 'js/admin.js') }}"></script>
</body>

</html>