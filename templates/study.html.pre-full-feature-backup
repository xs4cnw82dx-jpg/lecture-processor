<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Study Library</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <style>
    :root {
      --primary: #4F46E5;
      --primary-dark: #4338CA;
      --primary-light: #818CF8;
      --secondary: #0EA5E9;
      --success: #10B981;
      --warning: #F59E0B;
      --error: #EF4444;
      --gray-50: #F9FAFB;
      --gray-100: #F3F4F6;
      --gray-200: #E5E7EB;
      --gray-300: #D1D5DB;
      --gray-400: #9CA3AF;
      --gray-500: #6B7280;
      --gray-600: #4B5563;
      --gray-700: #374151;
      --gray-800: #1F2937;
      --gray-900: #111827;
      --white: #FFFFFF;
      --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
      --shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1);
      --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
      --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
      --shadow-xl: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1);
      --radius-sm: 6px; --radius: 8px; --radius-md: 12px; --radius-lg: 16px; --radius-xl: 24px;
    }
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    html { scroll-behavior: smooth; }
    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, var(--gray-50) 0%, var(--gray-100) 100%);
      color: var(--gray-800); line-height: 1.6; min-height: 100vh;
      -webkit-font-smoothing: antialiased;
    }
    input, textarea, select, button { font-family: inherit; }
    .container { max-width: 1360px; margin: 0 auto; padding: 20px; }

    /* ── Topbar ── */
    .topbar {
      display: flex; justify-content: space-between; align-items: center; gap: 12px;
      padding: 14px 20px; background: rgba(255,255,255,0.95);
      backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);
      border: 1px solid var(--gray-200); border-radius: var(--radius-lg);
      box-shadow: var(--shadow-lg); margin-bottom: 16px;
      position: sticky; top: 12px; z-index: 100;
    }
    .topbar-logo { display: flex; align-items: center; gap: 12px; min-width: 0; }
    .topbar-logo-icon {
      width: 38px; height: 38px; flex-shrink: 0;
      background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
      border-radius: var(--radius-md); display: flex; align-items: center; justify-content: center; color: var(--white);
    }
    .topbar-logo-icon svg { width: 22px; height: 22px; }
    .topbar h1 { font-size: 1.15rem; font-weight: 700; letter-spacing: -0.025em; color: var(--gray-900); white-space: nowrap; }
    .topbar-sub { font-size: 0.8125rem; color: var(--gray-500); margin-top: 1px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; max-width: 220px; }
    .actions { display: flex; gap: 8px; flex-wrap: wrap; align-items: center; }

    /* ── Buttons ── */
    .btn {
      display: inline-flex; align-items: center; justify-content: center; gap: 7px;
      border: 1px solid var(--gray-300); background: var(--white); color: var(--gray-700);
      border-radius: var(--radius); padding: 9px 14px; font-size: 0.85rem; font-weight: 600;
      cursor: pointer; transition: all 0.2s ease; white-space: nowrap;
    }
    .btn:hover { border-color: var(--gray-400); color: var(--gray-900); background: var(--gray-50); }
    .btn:active { transform: scale(0.97); }
    .btn.primary {
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
      border: none; color: var(--white); box-shadow: 0 4px 14px 0 rgba(79,70,229,0.3);
    }
    .btn.primary:hover { opacity: 0.92; transform: translateY(-1px); box-shadow: 0 6px 20px 0 rgba(79,70,229,0.4); }
    .btn.danger { border-color: rgba(239,68,68,0.35); color: #991B1B; background: rgba(239,68,68,0.06); }
    .btn.danger:hover { background: rgba(239,68,68,0.12); border-color: rgba(239,68,68,0.5); }
    .btn.cta {
      background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
      border: none; color: var(--white); padding: 14px 32px; font-size: 1rem; font-weight: 700;
      border-radius: var(--radius-md); box-shadow: 0 4px 14px 0 rgba(79,70,229,0.35); width: 100%;
    }
    .btn.cta:hover { opacity: 0.92; transform: translateY(-1px); box-shadow: 0 6px 20px 0 rgba(79,70,229,0.45); }
    .btn svg { width: 16px; height: 16px; flex-shrink: 0; }

    /* ── Grid ── */
    .grid { display: grid; grid-template-columns: 300px 1fr; gap: 16px; }
    @media (max-width: 1020px) { .grid { grid-template-columns: 1fr; } }

    /* ── Panels ── */
    .panel {
      background: var(--white); border: 1px solid var(--gray-200);
      border-radius: var(--radius-xl); box-shadow: var(--shadow-lg); overflow: hidden;
    }
    .panel-head {
      display: flex; align-items: center; justify-content: space-between; gap: 8px;
      padding: 16px 20px; border-bottom: 1px solid var(--gray-200);
    }
    .panel-title { font-size: 0.95rem; font-weight: 700; color: var(--gray-900); }
    .panel-body { padding: 16px 20px; }

    /* ── Pack summary card ── */
    .pack-summary {
      display: none; padding: 16px; margin-bottom: 14px;
      background: linear-gradient(135deg, rgba(79,70,229,0.06) 0%, rgba(14,165,233,0.06) 100%);
      border: 1px solid rgba(79,70,229,0.15); border-radius: var(--radius-md);
      animation: fadeSlideIn 0.3s ease-out;
    }
    .pack-summary.visible { display: block; }
    .pack-summary-title { font-size: 1rem; font-weight: 700; color: var(--gray-900); margin-bottom: 4px; }
    .pack-summary-meta { font-size: 0.8rem; color: var(--gray-500); margin-bottom: 10px; }
    .pack-summary-stats { display: flex; gap: 16px; flex-wrap: wrap; }
    .pack-stat {
      display: flex; align-items: center; gap: 6px;
      font-size: 0.82rem; font-weight: 600; color: var(--gray-700);
    }
    .pack-stat-icon { width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
    .pack-stat-icon svg { width: 14px; height: 14px; }
    .pack-stat-icon.notes-icon { background: rgba(79,70,229,0.1); color: var(--primary); }
    .pack-stat-icon.cards-icon { background: rgba(14,165,233,0.1); color: var(--secondary); }
    .pack-stat-icon.test-icon { background: rgba(16,185,129,0.1); color: var(--success); }

    /* ── Fields ── */
    .field { display: flex; flex-direction: column; gap: 5px; }
    .field label { font-size: 0.75rem; color: var(--gray-500); font-weight: 700; text-transform: uppercase; letter-spacing: 0.05em; }
    .field input, .field textarea, .field select {
      border: 1px solid var(--gray-300); border-radius: var(--radius);
      padding: 10px 12px; font-size: 0.9rem; color: var(--gray-900); background: var(--white);
      transition: all 0.2s ease;
    }
    .field input:focus, .field textarea:focus, .field select:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px rgba(79,70,229,0.1); }
    .field textarea { min-height: 78px; resize: vertical; }

    /* ── Custom select ── */
    .app-select { position: relative; }
    .app-select-button {
      width: 100%; display: flex; align-items: center; justify-content: space-between; gap: 8px;
      border: 1px solid var(--gray-300); border-radius: var(--radius);
      padding: 10px 12px; font-size: 0.9rem; color: var(--gray-900);
      background: var(--white); cursor: pointer; transition: all 0.2s ease;
    }
    .app-select-button:hover { border-color: var(--primary-light); }
    .app-select-button.open { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(79,70,229,0.1); }
    .app-select-button svg { width: 15px; height: 15px; color: var(--gray-500); transition: transform 0.2s ease; }
    .app-select-button.open svg { transform: rotate(180deg); }
    .app-select-label { overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    .app-select-menu {
      display: none; position: absolute; left: 0; right: 0; top: calc(100% + 6px);
      background: var(--white); border: 1px solid var(--gray-200);
      border-radius: var(--radius-md); box-shadow: var(--shadow-lg);
      z-index: 80; max-height: 260px; overflow-y: auto;
    }
    .app-select-menu.visible { display: block; animation: dropdownOpen 0.2s ease-out; }
    .app-select-item {
      width: 100%; border: none; background: var(--white); text-align: left;
      padding: 10px 12px; font-size: 0.9rem; color: var(--gray-700);
      cursor: pointer; transition: background 0.15s ease;
    }
    .app-select-item:hover { background: var(--gray-50); }
    .app-select-item.active { background: rgba(79,70,229,0.1); color: var(--primary-dark); font-weight: 600; }
    .q-answer-picker { margin-top: 4px; }

    .search-box { margin-bottom: 12px; }
    .list { display: flex; flex-direction: column; gap: 8px; max-height: 68vh; overflow-y: auto; padding-right: 2px; }

    /* ── Items ── */
    .item {
      border: 1px solid var(--gray-200); border-radius: var(--radius-md);
      padding: 12px 14px; background: var(--white);
      cursor: pointer; transition: all 0.25s ease;
    }
    .item:hover { border-color: var(--gray-300); box-shadow: var(--shadow-sm); transform: translateY(-1px); }
    .item.active { border-color: var(--primary); background: rgba(79,70,229,0.04); box-shadow: 0 0 0 3px rgba(79,70,229,0.08); }
    .item.dragging { opacity: 0.35; transform: scale(0.985); border-style: dashed; border-color: var(--primary); background: rgba(79,70,229,0.08); }
    .item.drop-target { border-color: var(--success); background: linear-gradient(135deg, rgba(16,185,129,0.12) 0%, rgba(14,165,233,0.08) 100%); box-shadow: 0 0 0 3px rgba(16,185,129,0.15); transform: translateY(-2px); }
    .item-head { display: flex; justify-content: space-between; gap: 8px; align-items: center; }
    .item-title { font-size: 0.9rem; font-weight: 700; color: var(--gray-900); }
    .item-sub { margin-top: 4px; font-size: 0.78rem; color: var(--gray-500); }

    /* ── Split ── */
    .split { display: grid; grid-template-columns: 320px 1fr; gap: 16px; }
    @media (max-width: 1200px) { .split { grid-template-columns: 1fr; } }

    .meta-grid { display: grid; grid-template-columns: repeat(2, minmax(0, 1fr)); gap: 10px; margin-bottom: 14px; }
    @media (max-width: 700px) { .meta-grid { grid-template-columns: 1fr; } }

    /* ── Editor ── */
    .editor-wrap { display: none; }
    .editor-wrap.visible { display: block; animation: fadeSlideIn 0.3s ease-out; }
    .empty { color: var(--gray-500); font-size: 0.9rem; padding: 20px; border: 1px dashed var(--gray-300); border-radius: var(--radius-md); background: var(--gray-50); text-align: center; }
    .editor-tabs { display: flex; gap: 4px; margin-bottom: 14px; background: var(--gray-100); border-radius: var(--radius-md); padding: 4px; }
    .editor-tab {
      flex: 1; border: none; background: transparent; border-radius: var(--radius);
      padding: 10px 12px; font-size: 0.82rem; font-weight: 600;
      color: var(--gray-600); cursor: pointer; transition: all 0.2s ease; text-align: center;
      display: flex; align-items: center; justify-content: center; gap: 6px;
    }
    .editor-tab:hover { color: var(--gray-900); }
    .editor-tab.active { background: var(--white); color: var(--gray-900); box-shadow: var(--shadow-sm); }
    .editor-tab svg { width: 15px; height: 15px; }
    .editor-pane { display: none; }
    .editor-pane.active { display: block; animation: fadeIn 0.25s ease-out; }
    .notes-view { border: 1px solid var(--gray-200); border-radius: var(--radius-md); background: var(--gray-50); padding: 20px; max-height: 60vh; overflow-y: auto; font-size: 0.92rem; line-height: 1.7; }
    .notes-view h1,.notes-view h2,.notes-view h3 { margin-top: 20px; margin-bottom: 10px; color: var(--gray-900); }
    .notes-view h1 { font-size: 1.4rem; border-bottom: 2px solid var(--gray-200); padding-bottom: 8px; }
    .editor-toolbar { display: flex; justify-content: space-between; align-items: center; gap: 8px; flex-wrap: wrap; margin-bottom: 10px; }
    .editor-count { font-size: 0.82rem; color: var(--gray-500); font-weight: 600; }
    .editor-list { display: flex; flex-direction: column; gap: 10px; max-height: 58vh; overflow-y: auto; padding-right: 2px; }
    .editor-card { border: 1px solid var(--gray-200); border-radius: var(--radius-md); background: var(--white); padding: 14px; transition: all 0.25s ease; }
    .editor-card:hover { border-color: var(--gray-300); box-shadow: var(--shadow-sm); }
    .editor-card.newly-added { border-color: var(--success); box-shadow: 0 0 0 3px rgba(16,185,129,0.12); animation: highlightPulse 0.6s ease-out; }
    .editor-card-head { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
    .editor-card-title { font-size: 0.8rem; color: var(--gray-500); font-weight: 700; text-transform: uppercase; letter-spacing: 0.05em; }
    .q-options-grid { display: grid; grid-template-columns: repeat(2, minmax(0, 1fr)); gap: 8px; }
    @media (max-width: 700px) { .q-options-grid { grid-template-columns: 1fr; } }

    /* ── Session Setup ── */
    .setup-overlay {
      position: fixed; inset: 0; z-index: 280; background: rgba(0,0,0,0.5);
      display: none; align-items: center; justify-content: center; padding: 18px;
      opacity: 0; transition: opacity 0.25s ease;
    }
    .setup-overlay.visible { display: flex; opacity: 1; }
    .setup-overlay.entering { display: flex; opacity: 0; }
    .setup-modal {
      width: min(720px, 100%); max-height: 90vh; overflow-y: auto;
      background: var(--white); border: 1px solid var(--gray-200);
      border-radius: var(--radius-xl); box-shadow: var(--shadow-xl);
      padding: 28px; transform: scale(0.95); opacity: 0; transition: all 0.25s ease;
    }
    .setup-overlay.visible .setup-modal { transform: scale(1); opacity: 1; }
    .setup-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
    .setup-title { font-size: 1.2rem; font-weight: 700; color: var(--gray-900); }
    .setup-pack-name { font-size: 0.85rem; color: var(--gray-500); margin-top: 2px; }
    .setup-tabs { display: flex; gap: 4px; background: var(--gray-100); border-radius: var(--radius-md); padding: 4px; margin-bottom: 20px; }
    .setup-tab {
      flex: 1; border: none; background: transparent; border-radius: var(--radius);
      padding: 10px 6px; font-size: 0.78rem; font-weight: 600;
      color: var(--gray-600); cursor: pointer; transition: all 0.2s ease;
      text-align: center; display: flex; align-items: center; justify-content: center; gap: 5px;
    }
    .setup-tab:hover { color: var(--gray-900); }
    .setup-tab.active { background: var(--white); color: var(--gray-900); box-shadow: var(--shadow-sm); }
    .setup-tab svg { width: 14px; height: 14px; }
    .setup-pane { display: none; }
    .setup-pane.active { display: block; animation: fadeIn 0.2s ease-out; }

    /* Lessons */
    .lesson-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; }
    @media (max-width: 500px) { .lesson-grid { grid-template-columns: 1fr; } }
    .lesson-card {
      border: 2px solid var(--gray-200); border-radius: var(--radius-md);
      padding: 20px; cursor: pointer; transition: all 0.25s ease;
      display: flex; flex-direction: column; align-items: center; gap: 8px;
      text-align: center; position: relative;
    }
    .lesson-card:hover { border-color: var(--gray-300); box-shadow: var(--shadow-sm); }
    .lesson-card.selected { border-color: var(--primary); background: linear-gradient(135deg, rgba(79,70,229,0.08) 0%, rgba(14,165,233,0.06) 100%); box-shadow: 0 0 0 3px rgba(79,70,229,0.1); }
    .lesson-card.disabled { opacity: 0.45; cursor: not-allowed; pointer-events: none; }
    .lesson-card-check {
      position: absolute; top: 10px; left: 10px; width: 22px; height: 22px;
      border: 2px solid var(--gray-300); border-radius: 50%;
      display: flex; align-items: center; justify-content: center; transition: all 0.2s ease;
    }
    .lesson-card.selected .lesson-card-check { background: var(--primary); border-color: var(--primary); }
    .lesson-card-check svg { width: 13px; height: 13px; color: var(--white); opacity: 0; transition: opacity 0.2s ease; }
    .lesson-card.selected .lesson-card-check svg { opacity: 1; }
    .lesson-card-icon { width: 40px; height: 40px; color: var(--primary); }
    .lesson-card-icon svg { width: 100%; height: 100%; }
    .lesson-card-title { font-size: 1rem; font-weight: 700; color: var(--gray-900); }
    .lesson-card-desc { font-size: 0.82rem; color: var(--gray-500); }
    .lesson-card-badge { font-size: 0.7rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.05em; color: var(--gray-400); background: var(--gray-100); padding: 3px 8px; border-radius: 20px; }

    /* Algorithm */
    .algo-lane { display: flex; align-items: center; gap: 6px; justify-content: center; margin-bottom: 20px; flex-wrap: wrap; }
    .algo-slot {
      width: 100px; height: 110px; border-radius: var(--radius-md);
      display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 5px;
      font-size: 0.78rem; font-weight: 700; color: var(--white);
      cursor: pointer; transition: all 0.25s ease; box-shadow: var(--shadow-sm);
      user-select: none;
    }
    .algo-slot:hover { transform: translateY(-3px); box-shadow: var(--shadow-md); }
    .algo-slot:active { transform: scale(0.95); }
    .algo-slot svg { width: 26px; height: 26px; }
    .algo-slot[data-type="new"] { background: linear-gradient(135deg, #38BDF8, #0EA5E9); }
    .algo-slot[data-type="familiar"] { background: linear-gradient(135deg, #34D399, #10B981); }
    .algo-slot[data-type="retry"] { background: linear-gradient(135deg, #FB7185, #EF4444); }
    .algo-slot[data-type="remaster"] { background: linear-gradient(135deg, #FBBF24, #F59E0B); }
    .algo-slot[data-type="random"] { background: linear-gradient(135deg, #A78BFA, #7C3AED); }
    .algo-chevron { color: var(--gray-400); flex-shrink: 0; }
    .algo-chevron svg { width: 16px; height: 16px; }
    .algo-presets { display: flex; gap: 8px; justify-content: center; flex-wrap: wrap; margin-bottom: 20px; }
    .algo-preset { border: 1px solid var(--gray-300); background: var(--white); border-radius: var(--radius); padding: 8px 14px; font-size: 0.82rem; font-weight: 600; color: var(--gray-700); cursor: pointer; transition: all 0.2s ease; }
    .algo-preset:hover { border-color: var(--gray-400); color: var(--gray-900); }
    .algo-preset.active { background: var(--primary); color: var(--white); border-color: var(--primary); }

    /* Settings */
    .settings-list { display: flex; flex-direction: column; gap: 2px; }
    .setting-row { display: flex; align-items: center; justify-content: space-between; gap: 12px; padding: 14px 16px; border-radius: var(--radius); background: var(--gray-50); transition: background 0.15s ease; cursor: pointer; }
    .setting-row:hover { background: var(--gray-100); }
    .setting-row.active { background: rgba(79,70,229,0.06); }
    .setting-label { font-size: 0.9rem; color: var(--gray-800); font-weight: 500; }
    .setting-toggle { width: 42px; height: 24px; border-radius: 12px; background: var(--gray-300); position: relative; flex-shrink: 0; transition: background 0.2s ease; }
    .setting-toggle::after { content: ''; position: absolute; top: 2px; left: 2px; width: 20px; height: 20px; border-radius: 50%; background: var(--white); box-shadow: var(--shadow-sm); transition: transform 0.2s ease; }
    .setting-row.active .setting-toggle { background: var(--primary); }
    .setting-row.active .setting-toggle::after { transform: translateX(18px); }

    /* Mastery */
    .mastery-section { text-align: center; }
    .mastery-rings { display: flex; justify-content: center; gap: 24px; margin: 20px 0; flex-wrap: wrap; }
    .mastery-ring { display: flex; flex-direction: column; align-items: center; gap: 8px; }
    .mastery-ring-circle { width: 80px; height: 80px; border-radius: 50%; border: 4px solid var(--gray-200); display: flex; align-items: center; justify-content: center; font-size: 1.25rem; font-weight: 800; color: var(--gray-900); position: relative; transition: all 0.3s ease; }
    .mastery-ring-circle.new-ring { border-color: #38BDF8; color: #0EA5E9; }
    .mastery-ring-circle.familiar-ring { border-color: #34D399; color: #10B981; }
    .mastery-ring-circle.mastered-ring { border-color: #FBBF24; color: #F59E0B; }
    .mastery-ring-label { font-size: 0.75rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.05em; color: var(--gray-500); }
    .mastery-stat { display: flex; align-items: center; justify-content: center; gap: 8px; padding: 10px 16px; background: var(--gray-50); border-radius: var(--radius); font-size: 0.85rem; color: var(--gray-600); margin-bottom: 16px; }
    .mastery-stat strong { color: var(--gray-900); }

    /* ── Learn stage ── */
    .learn-stage {
      position: fixed; inset: 0; z-index: 300;
      background: linear-gradient(135deg, var(--gray-50) 0%, var(--gray-100) 100%);
      display: none; opacity: 0; transition: opacity 0.35s ease;
    }
    .learn-stage::before {
      content: ''; position: absolute; inset: 0; pointer-events: none;
      background: radial-gradient(circle at 15% 15%, rgba(79,70,229,0.12), transparent 50%), radial-gradient(circle at 85% 25%, rgba(14,165,233,0.10), transparent 50%), radial-gradient(circle at 50% 85%, rgba(79,70,229,0.06), transparent 50%);
    }
    .learn-stage.visible { display: block; opacity: 1; }
    .learn-stage.entering { display: block; opacity: 0; }
    .learn-shell { height: 100%; display: flex; flex-direction: column; padding: 20px; position: relative; z-index: 1; }
    .learn-top {
      display: flex; justify-content: space-between; align-items: center; gap: 12px;
      background: rgba(255,255,255,0.95); backdrop-filter: blur(12px);
      border: 1px solid var(--gray-200); border-radius: var(--radius-lg);
      box-shadow: var(--shadow-lg); padding: 14px 20px;
    }
    .learn-top-left { display: flex; align-items: center; gap: 12px; min-width: 0; }
    .learn-top-left > div { min-width: 0; }
    .learn-title { font-size: 1.05rem; font-weight: 700; color: var(--gray-900); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .learn-sub { font-size: 0.82rem; color: var(--gray-500); }
    .learn-progress-bar { height: 4px; background: var(--gray-200); border-radius: 2px; flex: 1; min-width: 60px; max-width: 200px; }
    .learn-progress-fill { height: 100%; background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%); border-radius: 2px; transition: width 0.3s ease; }
    .learn-progress-text { font-size: 0.78rem; font-weight: 600; color: var(--gray-500); white-space: nowrap; }
    .learn-progress-center { display: flex; align-items: center; gap: 10px; flex: 1; justify-content: center; min-width: 0; }
    .learn-body { flex: 1; min-height: 0; display: grid; place-items: center; padding: 16px 0; }
    .learn-card {
      width: min(1000px, 100%); max-height: 100%;
      background: rgba(255,255,255,0.96); border: 1px solid var(--gray-200);
      border-radius: var(--radius-xl); box-shadow: var(--shadow-xl);
      padding: 24px; display: flex; flex-direction: column; gap: 16px; overflow-y: auto;
    }
    .learn-tabs { display: flex; gap: 4px; background: var(--gray-100); border-radius: var(--radius-md); padding: 4px; }
    .learn-tabs.single-tab { display: none; }
    .learn-tab {
      flex: 1; border: none; background: transparent; border-radius: var(--radius);
      padding: 10px 12px; font-size: 0.82rem; font-weight: 600;
      color: var(--gray-600); cursor: pointer; transition: all 0.2s ease;
      text-align: center; display: flex; align-items: center; justify-content: center; gap: 6px;
    }
    .learn-tab:hover { color: var(--gray-900); }
    .learn-tab.active { background: var(--white); color: var(--gray-900); box-shadow: var(--shadow-sm); }
    .learn-tab svg { width: 15px; height: 15px; }
    .learn-pane { display: none; min-height: 0; }
    .learn-pane.active { display: block; animation: fadeIn 0.25s ease-out; }
    .learn-notes { border: 1px solid var(--gray-200); border-radius: var(--radius-md); background: var(--gray-50); padding: 20px; max-height: 60vh; overflow-y: auto; font-size: 0.95rem; line-height: 1.75; }
    .learn-notes h1,.learn-notes h2,.learn-notes h3 { margin-top: 20px; margin-bottom: 10px; color: var(--gray-900); }

    /* ── 3D Flashcard ── */
    .flashcard-stage { display: flex; flex-direction: column; align-items: center; gap: 14px; }
    .flashcard-3d { width: min(100%, 860px); height: 340px; perspective: 1200px; cursor: pointer; }
    .flashcard-inner { position: relative; width: 100%; height: 100%; transform-style: preserve-3d; transition: transform 0.55s ease; }
    .flashcard-inner.flipped { transform: rotateY(180deg); }
    .flashcard-face {
      position: absolute; inset: 0; backface-visibility: hidden;
      border-radius: var(--radius-lg); border: 1px solid var(--gray-200);
      background: linear-gradient(135deg, rgba(79,70,229,0.06) 0%, rgba(14,165,233,0.08) 100%);
      box-shadow: var(--shadow-md); display: flex; align-items: center; justify-content: center;
      padding: 30px; text-align: center;
    }
    .flashcard-face.back { transform: rotateY(180deg); background: linear-gradient(135deg, rgba(14,165,233,0.08) 0%, rgba(79,70,229,0.06) 100%); }
    .flashcard-label { position: absolute; top: 16px; left: 16px; font-size: 0.7rem; color: var(--gray-400); font-weight: 700; text-transform: uppercase; letter-spacing: 0.06em; }
    .flashcard-text { font-size: 1.15rem; color: var(--gray-900); line-height: 1.65; white-space: pre-wrap; max-height: 260px; overflow-y: auto; }
    .learn-controls { display: flex; justify-content: center; align-items: center; flex-wrap: wrap; gap: 10px; }
    .learn-progress { font-size: 0.85rem; color: var(--gray-500); min-width: 120px; text-align: center; font-weight: 500; }
    .keyboard-hints { display: flex; gap: 12px; justify-content: center; flex-wrap: wrap; font-size: 0.75rem; color: var(--gray-400); }
    .keyboard-hints span { display: inline-flex; align-items: center; gap: 4px; }
    .kbd { display: inline-flex; align-items: center; justify-content: center; min-width: 22px; height: 20px; padding: 0 5px; background: var(--gray-100); border: 1px solid var(--gray-300); border-radius: 4px; font-size: 0.68rem; font-weight: 700; color: var(--gray-600); }

    /* ── Quiz ── */
    .quiz-head { display: flex; justify-content: space-between; align-items: center; gap: 10px; margin-bottom: 10px; font-size: 0.9rem; font-weight: 600; color: var(--gray-700); }
    .quiz-question { font-size: 1.1rem; font-weight: 700; margin-bottom: 14px; color: var(--gray-900); line-height: 1.5; }
    .quiz-options { display: grid; gap: 10px; }
    .quiz-option {
      width: 100%; text-align: left; border: 1px solid var(--gray-300); background: var(--white);
      border-radius: var(--radius); padding: 14px 18px; font-size: 0.9375rem; color: var(--gray-800);
      cursor: pointer; transition: all 0.2s ease;
    }
    .quiz-option:hover:not(:disabled) { border-color: var(--primary-light); background: var(--gray-50); transform: translateY(-1px); }
    .quiz-option.correct { border-color: var(--success); background: rgba(16,185,129,0.12); color: #065F46; transform: none; }
    .quiz-option.wrong { border-color: var(--error); background: rgba(239,68,68,0.12); color: #991B1B; transform: none; }
    .quiz-option:disabled { cursor: default; transform: none; }
    .quiz-expl { margin-top: 10px; border: 1px solid rgba(14,165,233,0.2); border-radius: var(--radius); background: rgba(14,165,233,0.06); padding: 14px 18px; font-size: 0.9rem; color: var(--gray-700); line-height: 1.5; display: none; }
    .quiz-expl.visible { display: block; animation: fadeSlideIn 0.25s ease-out; }

    /* ── Modals ── */
    .modal-overlay {
      position: fixed; inset: 0; z-index: 260; background: rgba(0,0,0,0.5);
      display: none; align-items: center; justify-content: center; padding: 18px;
      opacity: 0; transition: opacity 0.25s ease;
    }
    .modal-overlay.visible { display: flex; opacity: 1; }
    .modal-overlay.entering { display: flex; opacity: 0; }
    .modal {
      width: min(560px, 100%); background: var(--white); border: 1px solid var(--gray-200);
      border-radius: var(--radius-xl); box-shadow: var(--shadow-xl); padding: 24px;
      transform: scale(0.95); opacity: 0; transition: all 0.25s ease;
    }
    .modal-overlay.visible .modal { transform: scale(1); opacity: 1; }
    .modal-head { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
    .modal-title { font-size: 1.1rem; font-weight: 700; color: var(--gray-900); }
    .modal-grid { display: grid; grid-template-columns: repeat(2, minmax(0, 1fr)); gap: 10px; }
    @media (max-width: 620px) { .modal-grid { grid-template-columns: 1fr; } }
    .modal-message { font-size: 0.92rem; color: var(--gray-700); margin-bottom: 16px; line-height: 1.5; }

    /* ── Toast ── */
    .toast {
      position: fixed; bottom: 24px; left: 50%; transform: translateX(-50%) translateY(100px);
      background: var(--gray-900); color: var(--white); border-radius: var(--radius-md);
      padding: 14px 24px; font-size: 0.9375rem; font-weight: 500; box-shadow: var(--shadow-xl);
      opacity: 0; transition: all 0.3s ease; z-index: 500;
      display: flex; align-items: center; gap: 10px; max-width: calc(100vw - 48px);
    }
    .toast.visible { transform: translateX(-50%) translateY(0); opacity: 1; }
    .toast.success { background: var(--success); }
    .toast.error { background: var(--error); }

    /* ── Animations ── */
    @keyframes dropdownOpen { from { opacity: 0; transform: translateY(-8px); } to { opacity: 1; transform: translateY(0); } }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    @keyframes fadeSlideIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }
    @keyframes highlightPulse { 0% { box-shadow: 0 0 0 0 rgba(16,185,129,0.35); } 100% { box-shadow: 0 0 0 3px rgba(16,185,129,0.12); } }

    /* ── Mobile ── */
    @media (max-width: 600px) {
      .container { padding: 10px; }
      .topbar { padding: 10px 14px; flex-direction: column; align-items: stretch; gap: 10px; position: static; border-radius: var(--radius-md); }
      .topbar .actions { justify-content: flex-end; }
      .topbar-sub { max-width: 100%; }
      .panel { border-radius: var(--radius-lg); }
      .panel-head { padding: 12px 14px; }
      .panel-body { padding: 12px 14px; }
      .split { grid-template-columns: 1fr; gap: 12px; }
      .meta-grid { grid-template-columns: 1fr; }
      .learn-shell { padding: 10px; }
      .learn-top { flex-direction: column; align-items: stretch; gap: 10px; padding: 12px 14px; border-radius: var(--radius-md); }
      .learn-top .actions { justify-content: flex-end; }
      .learn-progress-center { justify-content: flex-start; }
      .learn-card { padding: 14px; border-radius: var(--radius-lg); }
      .flashcard-3d { height: 260px; }
      .algo-slot { width: 68px; height: 82px; font-size: 0.68rem; }
      .algo-slot svg { width: 20px; height: 20px; }
      .algo-chevron svg { width: 12px; height: 12px; }
      .algo-lane { gap: 4px; }
      .lesson-grid { grid-template-columns: 1fr; }
      .lesson-card { padding: 14px; }
      .setup-modal { padding: 18px; }
      .setup-tabs { flex-wrap: wrap; }
      .setup-tab { padding: 8px 4px; font-size: 0.72rem; }
      .setup-tab svg { width: 12px; height: 12px; }
      .btn { padding: 8px 10px; font-size: 0.8rem; }
      .btn.cta { padding: 12px 20px; font-size: 0.92rem; }
      .keyboard-hints { display: none; }
      .editor-tab { font-size: 0.75rem; padding: 8px 6px; gap: 4px; }
      .editor-tab svg { width: 13px; height: 13px; }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="topbar">
      <div class="topbar-logo">
        <div class="topbar-logo-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"></path><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"></path></svg></div>
        <div><h1>Study Library</h1><div class="topbar-sub" id="user-meta">Checking sign-in...</div></div>
      </div>
      <div class="actions">
        <button class="btn" id="back-app-btn"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 5 12 12 5"></polyline></svg>Back to App</button>
        <button class="btn" id="fullscreen-btn"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 3 21 3 21 9"></polyline><polyline points="9 21 3 21 3 15"></polyline><line x1="21" y1="3" x2="14" y2="10"></line><line x1="3" y1="21" x2="10" y2="14"></line></svg>Fullscreen Learn</button>
        <button class="btn primary" id="auth-btn">Sign in</button>
      </div>
    </div>

    <div class="grid" id="library-grid">
      <aside class="panel">
        <div class="panel-head"><span class="panel-title">Folders</span><div class="actions"><button class="btn" id="new-folder-btn">+ Folder</button><button class="btn danger" id="delete-folder-btn">Delete</button></div></div>
        <div class="panel-body">
          <div class="field search-box"><label>Search</label><input id="search-input" placeholder="Filter packs by title, course or subject"></div>
          <div class="list" id="folder-list"></div>
        </div>
      </aside>
      <section class="panel">
        <div class="panel-head"><span class="panel-title">Study Packs</span><div class="actions"><button class="btn" id="save-pack-btn">Save Changes</button><button class="btn danger" id="delete-pack-btn">Delete Pack</button></div></div>
        <div class="panel-body">
          <div class="pack-summary" id="pack-summary">
            <div class="pack-summary-title" id="pack-summary-title"></div>
            <div class="pack-summary-meta" id="pack-summary-meta"></div>
            <div class="pack-summary-stats">
              <div class="pack-stat"><div class="pack-stat-icon notes-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline></svg></div><span id="pack-stat-notes">Notes</span></div>
              <div class="pack-stat"><div class="pack-stat-icon cards-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="4" width="20" height="16" rx="2"></rect><line x1="2" y1="12" x2="22" y2="12"></line></svg></div><span id="pack-stat-cards">0 flashcards</span></div>
              <div class="pack-stat"><div class="pack-stat-icon test-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"></path><rect x="8" y="2" width="8" height="4" rx="1" ry="1"></rect></svg></div><span id="pack-stat-test">0 questions</span></div>
            </div>
          </div>
          <div class="split">
            <div><div class="list" id="pack-list"></div></div>
            <div>
              <div class="empty" id="pack-empty">Select a study pack to edit and study.</div>
              <div class="editor-wrap" id="pack-editor-wrap">
                <div class="meta-grid">
                  <div class="field"><label>Title</label><input id="pack-title"></div>
                  <div class="field"><label>Folder</label><input type="hidden" id="pack-folder-select" value=""><div class="app-select" id="pack-folder-picker"><button type="button" class="app-select-button" id="pack-folder-button"><span class="app-select-label" id="pack-folder-label">No folder</span><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"></polyline></svg></button><div class="app-select-menu" id="pack-folder-menu"></div></div></div>
                  <div class="field"><label>Course</label><input id="pack-course"></div>
                  <div class="field"><label>Subject</label><input id="pack-subject"></div>
                  <div class="field"><label>Semester</label><input id="pack-semester"></div>
                  <div class="field"><label>Block</label><input id="pack-block"></div>
                </div>
                <div class="actions" style="margin-bottom:14px;">
                  <button class="btn" id="export-pack-csv-btn"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg><span id="export-csv-label">Export Flashcards CSV</span></button>
                  <button class="btn primary" id="open-learn-btn"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="5 3 19 12 5 21 5 3"></polygon></svg>Learn Mode</button>
                </div>
                <div class="editor-tabs">
                  <button class="editor-tab active" data-editor-pane="notes"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline></svg>Notes</button>
                  <button class="editor-tab" data-editor-pane="flashcards"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="4" width="20" height="16" rx="2"></rect><line x1="2" y1="12" x2="22" y2="12"></line></svg>Flashcards</button>
                  <button class="editor-tab" data-editor-pane="test"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"></path><rect x="8" y="2" width="8" height="4" rx="1" ry="1"></rect></svg>Practice Test</button>
                </div>
                <div class="editor-pane active" id="editor-pane-notes"><div class="notes-view" id="notes-view"></div></div>
                <div class="editor-pane" id="editor-pane-flashcards"><div class="editor-toolbar"><span class="editor-count" id="flashcard-count">0 flashcards</span><button class="btn" id="add-flashcard-btn">+ Add flashcard</button></div><div class="editor-list" id="flashcard-editor-list"></div></div>
                <div class="editor-pane" id="editor-pane-test"><div class="editor-toolbar"><span class="editor-count" id="question-count">0 practice questions</span><button class="btn" id="add-question-btn">+ Add question</button></div><div class="editor-list" id="question-editor-list"></div></div>
              </div>
            </div>
          </div>
        </div>
      </section>
    </div>
  </div>

  <!-- Session Setup -->
  <div class="setup-overlay" id="setup-overlay"><div class="setup-modal">
    <div class="setup-header"><div><div class="setup-title">Session Setup</div><div class="setup-pack-name" id="setup-pack-name"></div></div><button class="btn" id="setup-close-btn"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg></button></div>
    <div class="setup-tabs" id="setup-tabs">
      <button class="setup-tab active" data-setup-pane="mastery"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M6 9H4.5a2.5 2.5 0 0 1 0-5C5.7 4 7 4.8 8 6c1-1.2 2.3-2 3.5-2a2.5 2.5 0 0 1 0 5H10"></path><path d="M6 9l6 6 6-6"></path></svg>Mastery</button>
      <button class="setup-tab" data-setup-pane="lessons"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="4" width="20" height="16" rx="2"></rect><line x1="2" y1="12" x2="22" y2="12"></line></svg>Lessons</button>
      <button class="setup-tab" data-setup-pane="settings"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-4 0v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83-2.83l.06-.06A1.65 1.65 0 0 0 4.68 15a1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1 0-4h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 2.83-2.83l.06.06A1.65 1.65 0 0 0 9 4.68a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9c.26.6.77 1.05 1.37 1.22H21a2 2 0 0 1 0 4h-.09c-.6.17-1.11.62-1.37 1.22z"></path></svg>Settings</button>
      <button class="setup-tab" data-setup-pane="algorithm"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"></polyline></svg>Algorithm</button>
    </div>
    <div class="setup-pane active" id="setup-pane-mastery"><div class="mastery-section"><div class="mastery-stat"><span>Cards seen:</span> <strong id="mastery-seen">0</strong> / <strong id="mastery-total">0</strong></div><div class="mastery-rings"><div class="mastery-ring"><div class="mastery-ring-circle new-ring" id="mastery-new-pct">100%</div><span class="mastery-ring-label">New</span></div><div class="mastery-ring"><div class="mastery-ring-circle familiar-ring" id="mastery-familiar-pct">0%</div><span class="mastery-ring-label">Familiar</span></div><div class="mastery-ring"><div class="mastery-ring-circle mastered-ring" id="mastery-mastered-pct">0%</div><span class="mastery-ring-label">Mastered</span></div></div></div></div>
    <div class="setup-pane" id="setup-pane-lessons"><p style="text-align:center;color:var(--gray-600);font-size:0.9rem;margin-bottom:16px;">Choose which lesson types to include:</p><div class="lesson-grid" id="lesson-grid">
      <div class="lesson-card selected" data-lesson="flashcards" id="lesson-card-flashcards"><div class="lesson-card-check"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg></div><div class="lesson-card-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="4" width="20" height="16" rx="2"></rect><line x1="2" y1="12" x2="22" y2="12"></line></svg></div><div class="lesson-card-title">Zen Cards</div><div class="lesson-card-desc">Distraction-free flashcards</div></div>
      <div class="lesson-card selected" data-lesson="test" id="lesson-card-test"><div class="lesson-card-check"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg></div><div class="lesson-card-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M9 11l3 3L22 4"></path><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"></path></svg></div><div class="lesson-card-title">Multiple Choice</div><div class="lesson-card-desc">Choose your answer from options</div></div>
      <div class="lesson-card disabled" data-lesson="write"><div class="lesson-card-check"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg></div><div class="lesson-card-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M12 20h9"></path><path d="M16.5 3.5a2.12 2.12 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"></path></svg></div><div class="lesson-card-title">Write</div><div class="lesson-card-desc">Learn to spell terms</div><div class="lesson-card-badge">Coming soon</div></div>
      <div class="lesson-card disabled" data-lesson="match"><div class="lesson-card-check"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg></div><div class="lesson-card-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="7" height="7"></rect><rect x="14" y="3" width="7" height="7"></rect><rect x="3" y="14" width="7" height="7"></rect><rect x="14" y="14" width="7" height="7"></rect></svg></div><div class="lesson-card-title">Match</div><div class="lesson-card-desc">Recall terms using media</div><div class="lesson-card-badge">Coming soon</div></div>
    </div></div>
    <div class="setup-pane" id="setup-pane-settings"><div class="settings-list" id="settings-list">
      <div class="setting-row" data-setting="swapAnswerQuestion"><span class="setting-label">Swap answer and question</span><div class="setting-toggle"></div></div>
      <div class="setting-row" data-setting="randomSwap"><span class="setting-label">Randomly swap answer and question</span><div class="setting-toggle"></div></div>
      <div class="setting-row" data-setting="caseSensitive"><span class="setting-label">Case sensitive</span><div class="setting-toggle"></div></div>
      <div class="setting-row" data-setting="forceExactMatch"><span class="setting-label">Force exact matches</span><div class="setting-toggle"></div></div>
      <div class="setting-row active" data-setting="addMissedToReview"><span class="setting-label">Add missed terms to review list</span><div class="setting-toggle"></div></div>
      <div class="setting-row" data-setting="ignoreArticles"><span class="setting-label">Ignore articles (a, an, the)</span><div class="setting-toggle"></div></div>
      <div class="setting-row" data-setting="ignoreDeterminers"><span class="setting-label">Ignore determiners (; , /)</span><div class="setting-toggle"></div></div>
      <div class="setting-row" data-setting="ignoreBrackets"><span class="setting-label">Ignore () and []</span><div class="setting-toggle"></div></div>
    </div></div>
    <div class="setup-pane" id="setup-pane-algorithm"><p style="text-align:center;color:var(--gray-600);font-size:0.9rem;margin-bottom:16px;">Adjust how cards are selected for review:</p><div class="algo-lane" id="algo-lane"></div><div class="algo-presets" id="algo-presets"><button class="algo-preset active" data-preset="balanced">Balanced</button><button class="algo-preset" data-preset="random">All Random</button><button class="algo-preset" data-preset="lastminute">Last Minute Overview</button><button class="algo-preset" data-preset="fixmistakes">Fix Mistakes</button></div></div>
    <button class="btn cta" id="setup-start-btn" style="margin-top:8px;"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="5 3 19 12 5 21 5 3"></polygon></svg>Start Session</button>
  </div></div>

  <!-- Learn Stage -->
  <div class="learn-stage" id="learn-stage"><div class="learn-shell">
    <div class="learn-top">
      <div class="learn-top-left"><div><div class="learn-title" id="learn-title">Learn Mode</div><div class="learn-sub" id="learn-sub">Focused study session</div></div></div>
      <div class="learn-progress-center"><div class="learn-progress-bar"><div class="learn-progress-fill" id="learn-progress-fill" style="width:0%"></div></div><span class="learn-progress-text" id="learn-progress-text">0/0</span></div>
      <div class="actions">
        <button class="btn" id="learn-back-app-btn"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 5 12 12 5"></polyline></svg>App</button>
        <button class="btn" id="learn-back-library-btn"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 4h18v16H3z"></path><line x1="3" y1="10" x2="21" y2="10"></line><line x1="9" y1="4" x2="9" y2="20"></line></svg>Library</button>
        <button class="btn" id="learn-fullscreen-btn"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 3 21 3 21 9"></polyline><polyline points="9 21 3 21 3 15"></polyline><line x1="21" y1="3" x2="14" y2="10"></line><line x1="3" y1="21" x2="10" y2="14"></line></svg></button>
      </div>
    </div>
    <div class="learn-body"><div class="learn-card">
      <div class="learn-tabs" id="learn-tabs-container">
        <button class="learn-tab active" data-learn-pane="notes" id="learn-tab-notes"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline></svg>Notes</button>
        <button class="learn-tab" data-learn-pane="flashcards" id="learn-tab-flashcards"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="4" width="20" height="16" rx="2"></rect><line x1="2" y1="12" x2="22" y2="12"></line></svg>Flashcards</button>
        <button class="learn-tab" data-learn-pane="test" id="learn-tab-test"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"></path><rect x="8" y="2" width="8" height="4" rx="1" ry="1"></rect></svg>Practice Test</button>
      </div>
      <div class="learn-pane active" id="learn-pane-notes"><div class="learn-notes" id="learn-notes-content"></div></div>
      <div class="learn-pane" id="learn-pane-flashcards"><div class="flashcard-stage"><div class="flashcard-3d" id="learn-flashcard-3d"><div class="flashcard-inner" id="learn-flashcard-inner"><div class="flashcard-face front"><span class="flashcard-label">Front</span><div class="flashcard-text" id="learn-flashcard-front"></div></div><div class="flashcard-face back"><span class="flashcard-label">Back</span><div class="flashcard-text" id="learn-flashcard-back"></div></div></div></div><div class="learn-controls"><button class="btn" id="learn-f-prev">Previous</button><button class="btn" id="learn-f-flip">Flip</button><button class="btn" id="learn-f-next">Next</button><span class="learn-progress" id="learn-f-progress">Card 0 of 0</span></div><div class="keyboard-hints"><span><span class="kbd">&larr;</span> Previous</span><span><span class="kbd">Space</span> Flip</span><span><span class="kbd">&rarr;</span> Next</span></div></div></div>
      <div class="learn-pane" id="learn-pane-test"><div class="quiz-head"><span id="learn-q-progress">Question 0 of 0</span><span id="learn-q-score">Score: 0/0</span></div><div class="quiz-question" id="learn-q-text"></div><div class="quiz-options" id="learn-q-options"></div><div class="quiz-expl" id="learn-q-expl"></div><div class="actions" style="margin-top:12px;"><button class="btn primary" id="learn-q-next">Next question</button></div></div>
    </div></div>
  </div></div>

  <!-- Folder Modal -->
  <div class="modal-overlay" id="folder-modal-overlay"><div class="modal"><div class="modal-head"><span class="modal-title" id="folder-modal-title">New Folder</span><button class="btn" id="folder-modal-close"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg></button></div><div class="modal-grid" style="margin-bottom:14px;"><div class="field"><label>Folder Name *</label><input id="folder-name-input"></div><div class="field"><label>Course</label><input id="folder-course-input"></div><div class="field"><label>Subject</label><input id="folder-subject-input"></div><div class="field"><label>Semester</label><input id="folder-semester-input"></div><div class="field"><label>Block</label><input id="folder-block-input"></div></div><div class="actions" style="justify-content:flex-end;"><button class="btn" id="folder-modal-cancel">Cancel</button><button class="btn primary" id="folder-modal-save">Save Folder</button></div></div></div>

  <!-- Confirm Modal -->
  <div class="modal-overlay" id="confirm-modal-overlay"><div class="modal"><div class="modal-head"><span class="modal-title" id="confirm-modal-title">Confirm Action</span><button class="btn" id="confirm-modal-close"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg></button></div><p class="modal-message" id="confirm-modal-message"></p><div class="actions" style="justify-content:flex-end;"><button class="btn" id="confirm-modal-cancel">Cancel</button><button class="btn danger" id="confirm-modal-confirm">Delete</button></div></div></div>

  <div class="toast" id="toast"></div>


  <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth-compat.js"></script>
  <script>
    const firebaseConfig={apiKey:"AIzaSyBAAeEUCPNvP5qnqpP3M6HnFZ6vaaijUvM",authDomain:"lecture-processor-cdff6.firebaseapp.com",projectId:"lecture-processor-cdff6",storageBucket:"lecture-processor-cdff6.firebasestorage.app",messagingSenderId:"374793454161",appId:"1:374793454161:web:c68b21590e9a1fafa32e70"};
    let auth=null;
    try{
      if(!firebase.apps||!firebase.apps.length)firebase.initializeApp(firebaseConfig);
      auth=firebase.auth();
    }catch(e){
      console.error('Study auth bootstrap failed:',e);
    }

    let token=null,folders=[],packs=[],selectedFolderId='',selectedPackId='',selectedPack=null,activeEditorPane='notes',exportType='flashcards',draggedPackId='',folderModalMode='create',editingFolderId='',pendingOpenPackId='',confirmModalResolver=null;
    let learnFlashcardIndex=0,learnFlashcardFlipped=false,learnQuestionIndex=0,learnScore=0,learnAnswered=false,activeLearnPane='notes';
    const urlParams=new URLSearchParams(window.location.search);
    const learnPackFromUrl=urlParams.get('pack_id')||'',openLearnFromUrl=urlParams.get('mode')==='learn',fullscreenFromUrl=urlParams.get('fullscreen')==='1',focusFromUrl=urlParams.get('focus')||'';
    let autoLearnConsumed=false;

    /* ── Session state ── */
    const ALGO_PRESETS={balanced:['new','new','familiar','retry','remaster'],random:['random','random','random','random','random'],lastminute:['new','new','new','new','retry'],fixmistakes:['new','retry','new','retry','retry']};
    const ALGO_TYPES=['new','familiar','retry','remaster','random'];
    const ALGO_ICONS={new:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="5" y="2" width="14" height="20" rx="2" ry="2"></rect><line x1="12" y1="18" x2="12.01" y2="18"></line></svg>',familiar:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path></svg>',retry:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="23 4 23 10 17 10"></polyline><path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"></path></svg>',remaster:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 9H4.5a2.5 2.5 0 0 1 0-5C5.7 4 7 4.8 8 6c1-1.2 2.3-2 3.5-2a2.5 2.5 0 0 1 0 5H10"></path><path d="M6 9l6 6 6-6"></path></svg>',random:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="16 3 21 3 21 8"></polyline><line x1="4" y1="20" x2="21" y2="3"></line><polyline points="21 16 21 21 16 21"></polyline><line x1="15" y1="15" x2="21" y2="21"></line><line x1="4" y1="4" x2="9" y2="9"></line></svg>'};
    let sessionSettings={swapAnswerQuestion:false,randomSwap:false,caseSensitive:false,forceExactMatch:false,addMissedToReview:true,ignoreArticles:false,ignoreDeterminers:false,ignoreBrackets:false};
    let sessionAlgo=['new','new','familiar','retry','remaster'],sessionAlgoPreset='balanced',sessionLessons={flashcards:true,test:true},activeSetupPane='mastery';

    /* ── Card mastery state (localStorage) ── */
    function getCardStateKey(){return`card_state_${auth&&auth.currentUser?auth.currentUser.uid:'anon'}_${selectedPackId}`;}
    function loadCardState(){try{return JSON.parse(localStorage.getItem(getCardStateKey()))||{};}catch(e){return{};}}
    function saveCardState(state){try{localStorage.setItem(getCardStateKey(),JSON.stringify(state));}catch(e){}}
    function markCardSeen(cardId,correct){const s=loadCardState();if(!s[cardId])s[cardId]={seen:0,correct:0,wrong:0,level:'new'};s[cardId].seen++;if(correct)s[cardId].correct++;else s[cardId].wrong++;if(s[cardId].correct>=3)s[cardId].level='mastered';else if(s[cardId].seen>=1)s[cardId].level='familiar';saveCardState(s);}
    function getCardLevel(cardId){const s=loadCardState();return s[cardId]?s[cardId].level:'new';}

    function getSessionStorageKey(){return`study_session_${auth&&auth.currentUser?auth.currentUser.uid:'anon'}_${selectedPackId}`;}
    function loadSessionState(){try{const r=localStorage.getItem(getSessionStorageKey());if(!r)return;const d=JSON.parse(r);if(d.settings)sessionSettings={...sessionSettings,...d.settings};if(d.algo&&Array.isArray(d.algo)&&d.algo.length===5)sessionAlgo=d.algo;if(d.algoPreset)sessionAlgoPreset=d.algoPreset;if(d.lessons)sessionLessons={...sessionLessons,...d.lessons};}catch(e){}}
    function saveSessionState(){try{localStorage.setItem(getSessionStorageKey(),JSON.stringify({settings:sessionSettings,algo:sessionAlgo,algoPreset:sessionAlgoPreset,lessons:sessionLessons}));}catch(e){}}

    /* ── Ordering by algorithm ── */
    function orderCardsByAlgo(cards){
      if(!cards||!cards.length)return cards;
      const state=loadCardState();
      const buckets={new:[],familiar:[],retry:[],remaster:[],random:[]};
      cards.forEach((c,i)=>{
        const id=`fc_${i}`;const cs=state[id];
        if(!cs||cs.level==='new')buckets.new.push({card:c,idx:i});
        else if(cs.level==='familiar')buckets.familiar.push({card:c,idx:i});
        else if(cs.level==='mastered')buckets.remaster.push({card:c,idx:i});
        if(cs&&cs.wrong>0)buckets.retry.push({card:c,idx:i});
        buckets.random.push({card:c,idx:i});
      });
      Object.keys(buckets).forEach(k=>{buckets[k].sort(()=>Math.random()-0.5);});
      const result=[];const used=new Set();
      sessionAlgo.forEach(type=>{
        const pool=buckets[type]||buckets.random;
        for(const item of pool){if(!used.has(item.idx)){result.push(item);used.add(item.idx);break;}}
      });
      cards.forEach((c,i)=>{if(!used.has(i))result.push({card:c,idx:i});});
      return result.map(r=>r.card);
    }

    /* ── DOM refs ── */
    const userMeta=document.getElementById('user-meta'),authBtn=document.getElementById('auth-btn'),backAppBtn=document.getElementById('back-app-btn'),fullscreenBtn=document.getElementById('fullscreen-btn');
    const searchInput=document.getElementById('search-input'),folderList=document.getElementById('folder-list'),packList=document.getElementById('pack-list'),newFolderBtn=document.getElementById('new-folder-btn'),deleteFolderBtn=document.getElementById('delete-folder-btn');
    const packEmpty=document.getElementById('pack-empty'),packEditorWrap=document.getElementById('pack-editor-wrap'),packTitle=document.getElementById('pack-title'),packFolderSelect=document.getElementById('pack-folder-select'),packFolderPicker=document.getElementById('pack-folder-picker'),packFolderButton=document.getElementById('pack-folder-button'),packFolderLabel=document.getElementById('pack-folder-label'),packFolderMenu=document.getElementById('pack-folder-menu');
    const packCourse=document.getElementById('pack-course'),packSubject=document.getElementById('pack-subject'),packSemester=document.getElementById('pack-semester'),packBlock=document.getElementById('pack-block'),notesView=document.getElementById('notes-view');
    const packSummary=document.getElementById('pack-summary'),packSummaryTitle=document.getElementById('pack-summary-title'),packSummaryMeta=document.getElementById('pack-summary-meta'),packStatNotes=document.getElementById('pack-stat-notes'),packStatCards=document.getElementById('pack-stat-cards'),packStatTest=document.getElementById('pack-stat-test');
    const savePackBtn=document.getElementById('save-pack-btn'),deletePackBtn=document.getElementById('delete-pack-btn'),exportPackCsvBtn=document.getElementById('export-pack-csv-btn'),exportCsvLabel=document.getElementById('export-csv-label'),openLearnBtn=document.getElementById('open-learn-btn');
    const editorTabs=document.querySelectorAll('.editor-tab'),flashcardCount=document.getElementById('flashcard-count'),questionCount=document.getElementById('question-count'),addFlashcardBtn=document.getElementById('add-flashcard-btn'),addQuestionBtn=document.getElementById('add-question-btn'),flashcardEditorList=document.getElementById('flashcard-editor-list'),questionEditorList=document.getElementById('question-editor-list');
    const learnStage=document.getElementById('learn-stage'),learnTitle=document.getElementById('learn-title'),learnSub=document.getElementById('learn-sub'),learnBackAppBtn=document.getElementById('learn-back-app-btn'),learnBackLibraryBtn=document.getElementById('learn-back-library-btn'),learnFullscreenBtn=document.getElementById('learn-fullscreen-btn');
    const learnTabsContainer=document.getElementById('learn-tabs-container'),learnTabs=document.querySelectorAll('.learn-tab'),learnNotesContent=document.getElementById('learn-notes-content');
    const learnFlashcard3d=document.getElementById('learn-flashcard-3d'),learnFlashcardInner=document.getElementById('learn-flashcard-inner'),learnFlashcardFront=document.getElementById('learn-flashcard-front'),learnFlashcardBack=document.getElementById('learn-flashcard-back');
    const learnFPrev=document.getElementById('learn-f-prev'),learnFFlip=document.getElementById('learn-f-flip'),learnFNext=document.getElementById('learn-f-next'),learnFProgress=document.getElementById('learn-f-progress');
    const learnProgressFill=document.getElementById('learn-progress-fill'),learnProgressText=document.getElementById('learn-progress-text');
    const learnQProgress=document.getElementById('learn-q-progress'),learnQScore=document.getElementById('learn-q-score'),learnQText=document.getElementById('learn-q-text'),learnQOptions=document.getElementById('learn-q-options'),learnQExpl=document.getElementById('learn-q-expl'),learnQNext=document.getElementById('learn-q-next');
    const setupOverlay=document.getElementById('setup-overlay'),setupPackName=document.getElementById('setup-pack-name'),setupCloseBtn=document.getElementById('setup-close-btn'),setupStartBtn=document.getElementById('setup-start-btn'),setupTabs=document.querySelectorAll('.setup-tab'),algoLane=document.getElementById('algo-lane'),algoPresets=document.querySelectorAll('.algo-preset');
    const folderModalOverlay=document.getElementById('folder-modal-overlay'),folderModalTitle=document.getElementById('folder-modal-title'),folderModalClose=document.getElementById('folder-modal-close'),folderModalCancel=document.getElementById('folder-modal-cancel'),folderModalSave=document.getElementById('folder-modal-save'),folderNameInput=document.getElementById('folder-name-input'),folderCourseInput=document.getElementById('folder-course-input'),folderSubjectInput=document.getElementById('folder-subject-input'),folderSemesterInput=document.getElementById('folder-semester-input'),folderBlockInput=document.getElementById('folder-block-input');
    const confirmModalOverlay=document.getElementById('confirm-modal-overlay'),confirmModalTitle=document.getElementById('confirm-modal-title'),confirmModalMessage=document.getElementById('confirm-modal-message'),confirmModalClose=document.getElementById('confirm-modal-close'),confirmModalCancel=document.getElementById('confirm-modal-cancel'),confirmModalConfirm=document.getElementById('confirm-modal-confirm');
    const toastEl=document.getElementById('toast');

    /* ── Helpers ── */
    function showToast(msg,type='success'){toastEl.textContent=msg;toastEl.className=`toast visible ${type}`;setTimeout(()=>toastEl.classList.remove('visible'),2800);}
    function mdToHtml(md){if(!md)return'';let h=md.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/^### (.*$)/gm,'<h3>$1</h3>').replace(/^## (.*$)/gm,'<h2>$1</h2>').replace(/^# (.*$)/gm,'<h1>$1</h1>').replace(/\*\*\*(.*?)\*\*\*/g,'<strong><em>$1</em></strong>').replace(/\*\*(.*?)\*\*/g,'<strong>$1</strong>').replace(/\*(.*?)\*/g,'<em>$1</em>').replace(/^\s*[-*]\s+(.*$)/gm,'<li>$1</li>').replace(/\n\n/g,'</p><p>').replace(/\n/g,'<br>');h=`<p>${h}</p>`;h=h.replace(/(<li>.*?<\/li>)(?=\s*<li>|<br><li>)/g,'$1').replace(/(<li>.*?<\/li>)+/g,'<ul>$&</ul>').replace(/<br><li>/g,'<li>');h=h.replace(/<p><\/p>/g,'').replace(/<p>(<h[1-3]>)/g,'$1').replace(/(<\/h[1-3]>)<\/p>/g,'$1').replace(/<p>(<ul>)/g,'$1').replace(/(<\/ul>)<\/p>/g,'$1');return h;}
    async function api(path,options={}){const headers=options.headers||{};headers['Authorization']=`Bearer ${token}`;if(options.body&&!headers['Content-Type'])headers['Content-Type']='application/json';const res=await fetch(path,{...options,headers});const isJson=(res.headers.get('content-type')||'').includes('application/json');const data=isJson?await res.json():null;if(!res.ok)throw new Error((data&&data.error)||'Request failed');return data;}
    async function authenticatedFetch(path,options={},allowRefresh=true){if(!auth||!auth.currentUser)throw new Error('Please sign in');if(!token)token=await auth.currentUser.getIdToken();const headers={...(options.headers||{}),Authorization:`Bearer ${token}`};const response=await fetch(path,{...options,headers});if(response.status===401&&allowRefresh){token=await auth.currentUser.getIdToken(true);return fetch(path,{...options,headers:{...(options.headers||{}),Authorization:`Bearer ${token}`}});}return response;}
    function parseFilenameFromDisposition(d,f){if(!d)return f;const u=d.match(/filename\*=UTF-8''([^;]+)/i);if(u&&u[1])return decodeURIComponent(u[1].trim());const a=d.match(/filename="?([^";]+)"?/i);if(a&&a[1])return a[1].trim();return f;}
    async function downloadStudyPackCsv(packId,type){const f=type==='test'?`study-pack-${packId}-practice-test.csv`:`study-pack-${packId}-flashcards.csv`;const r=await authenticatedFetch(`/api/study-packs/${encodeURIComponent(packId)}/export-flashcards-csv?type=${encodeURIComponent(type)}`);if(!r.ok){let m='Could not export CSV';try{const d=await r.json();m=d.error||m;}catch(e){}throw new Error(m);}const blob=await r.blob();const fn=parseFilenameFromDisposition(r.headers.get('content-disposition')||'',f);const url=URL.createObjectURL(blob);const anchor=document.createElement('a');anchor.href=url;anchor.download=fn;document.body.appendChild(anchor);anchor.click();document.body.removeChild(anchor);URL.revokeObjectURL(url);}
    function openModal(ov){ov.classList.add('entering');requestAnimationFrame(()=>{requestAnimationFrame(()=>ov.classList.replace('entering','visible'));});}
    function closeModal(ov){ov.classList.remove('visible');}
    function openConfirmModal(title,message,confirmLabel='Delete'){confirmModalTitle.textContent=title;confirmModalMessage.textContent=message;confirmModalConfirm.textContent=confirmLabel;openModal(confirmModalOverlay);return new Promise(r=>{confirmModalResolver=r;});}
    function closeConfirmModal(c){closeModal(confirmModalOverlay);if(confirmModalResolver){confirmModalResolver(Boolean(c));confirmModalResolver=null;}}

    /* ── Session Setup ── */
    function renderAlgoLane(){algoLane.innerHTML='';sessionAlgo.forEach((type,i)=>{if(i>0){const ch=document.createElement('div');ch.className='algo-chevron';ch.innerHTML='<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="9 18 15 12 9 6"></polyline></svg>';algoLane.appendChild(ch);}const s=document.createElement('div');s.className='algo-slot';s.dataset.type=type;s.dataset.index=String(i);s.innerHTML=`${ALGO_ICONS[type]||''}<span>${type.charAt(0).toUpperCase()+type.slice(1)}</span>`;s.addEventListener('click',()=>{const ni=(ALGO_TYPES.indexOf(type)+1)%ALGO_TYPES.length;sessionAlgo[i]=ALGO_TYPES[ni];sessionAlgoPreset='';renderAlgoLane();renderAlgoPresets();saveSessionState();});algoLane.appendChild(s);});}
    function renderAlgoPresets(){algoPresets.forEach(b=>b.classList.toggle('active',b.dataset.preset===sessionAlgoPreset));}
    function applyAlgoPreset(p){if(ALGO_PRESETS[p]){sessionAlgo=[...ALGO_PRESETS[p]];sessionAlgoPreset=p;renderAlgoLane();renderAlgoPresets();saveSessionState();}}
    function renderSettingsRows(){document.querySelectorAll('.setting-row[data-setting]').forEach(r=>{r.classList.toggle('active',!!sessionSettings[r.dataset.setting]);});}
    function renderLessonCards(){
      const hf=selectedPack&&selectedPack.flashcards&&selectedPack.flashcards.length>0;
      const ht=selectedPack&&selectedPack.test_questions&&selectedPack.test_questions.length>0;
      const fc=document.getElementById('lesson-card-flashcards'),tc=document.getElementById('lesson-card-test');
      fc.style.display=hf?'':'none';tc.style.display=ht?'':'none';
      if(!hf)sessionLessons.flashcards=false;if(!ht)sessionLessons.test=false;
      fc.classList.toggle('selected',sessionLessons.flashcards);tc.classList.toggle('selected',sessionLessons.test);
    }
    function renderMasteryGauge(){
      const cards=selectedPack?(selectedPack.flashcards||[]):[];
      const total=cards.length;const state=loadCardState();
      let seen=0,famCount=0,mastCount=0;
      cards.forEach((c,i)=>{const cs=state[`fc_${i}`];if(cs){seen++;if(cs.level==='mastered')mastCount++;else if(cs.level==='familiar')famCount++;}});
      const newCount=total-seen;
      document.getElementById('mastery-total').textContent=String(total);
      document.getElementById('mastery-seen').textContent=String(seen);
      document.getElementById('mastery-new-pct').textContent=total?Math.round((newCount/total)*100)+'%':'0%';
      document.getElementById('mastery-familiar-pct').textContent=total?Math.round((famCount/total)*100)+'%':'0%';
      document.getElementById('mastery-mastered-pct').textContent=total?Math.round((mastCount/total)*100)+'%':'0%';
    }
    function setSetupPane(p){activeSetupPane=p;setupTabs.forEach(t=>t.classList.toggle('active',t.dataset.setupPane===p));['mastery','lessons','settings','algorithm'].forEach(x=>{const el=document.getElementById(`setup-pane-${x}`);if(el)el.classList.toggle('active',x===p);});}
    function openSessionSetup(){if(!selectedPack){showToast('Select a study pack first.','error');return;}loadSessionState();setupPackName.textContent=selectedPack.title||'Untitled pack';renderMasteryGauge();renderLessonCards();renderSettingsRows();renderAlgoLane();renderAlgoPresets();setSetupPane('mastery');openModal(setupOverlay);}
    function closeSessionSetup(){closeModal(setupOverlay);}
    setupTabs.forEach(t=>t.addEventListener('click',()=>setSetupPane(t.dataset.setupPane)));
    setupCloseBtn.addEventListener('click',closeSessionSetup);
    setupOverlay.addEventListener('click',e=>{if(e.target===setupOverlay)closeSessionSetup();});
    algoPresets.forEach(b=>b.addEventListener('click',()=>applyAlgoPreset(b.dataset.preset)));
    document.querySelectorAll('.setting-row[data-setting]').forEach(row=>{row.addEventListener('click',()=>{sessionSettings[row.dataset.setting]=!sessionSettings[row.dataset.setting];renderSettingsRows();saveSessionState();});});
    document.querySelectorAll('.lesson-card:not(.disabled)').forEach(card=>{card.addEventListener('click',()=>{const l=card.dataset.lesson;if(l==='flashcards')sessionLessons.flashcards=!sessionLessons.flashcards;if(l==='test')sessionLessons.test=!sessionLessons.test;renderLessonCards();saveSessionState();});});
    setupStartBtn.addEventListener('click',()=>{saveSessionState();closeSessionSetup();const pp=sessionLessons.flashcards?'flashcards':(sessionLessons.test?'test':'notes');openLearnStageDirectly(false,pp);});

    /* ── Editor pane ── */
    function setEditorPane(pane){
      activeEditorPane=pane;
      editorTabs.forEach(b=>b.classList.toggle('active',b.dataset.editorPane===pane));
      document.getElementById('editor-pane-notes').classList.toggle('active',pane==='notes');
      document.getElementById('editor-pane-flashcards').classList.toggle('active',pane==='flashcards');
      document.getElementById('editor-pane-test').classList.toggle('active',pane==='test');
      if(pane==='test'){exportType='test';exportCsvLabel.textContent='Export Practice Test CSV';}
      else{exportType='flashcards';exportCsvLabel.textContent='Export Flashcards CSV';}
    }

    function filteredPacks(){
      const q=searchInput.value.trim().toLowerCase();
      return packs.filter(p=>{
        if(selectedFolderId&&p.folder_id!==selectedFolderId)return false;
        if(!q)return true;
        return`${p.title||''} ${p.course||''} ${p.subject||''} ${p.semester||''} ${p.block||''}`.toLowerCase().includes(q);
      });
    }

    async function movePackToFolder(pid,fid){
      try{await api(`/api/study-packs/${encodeURIComponent(pid)}`,{method:'PATCH',body:JSON.stringify({folder_id:fid})});showToast('Study pack moved.');await loadData(pid);}
      catch(e){showToast(e.message||'Could not move pack.','error');}
    }

    function renderFolders(){
      const all=[{folder_id:'',name:'All Study Packs',course:'',subject:'',semester:'',block:''},...folders];
      folderList.innerHTML='';
      all.forEach(f=>{
        const div=document.createElement('div');
        div.className=`item ${selectedFolderId===f.folder_id?'active':''}`;
        div.dataset.folderId=f.folder_id;
        div.innerHTML=`<div class="item-head"><span class="item-title">${f.name}</span>${f.folder_id?'<button class="btn" data-edit-folder="1" style="padding:5px 8px;font-size:0.75rem;">Edit</button>':''}</div><div class="item-sub">${[f.course,f.subject,f.semester,f.block].filter(Boolean).join(' · ')||(f.folder_id?'No metadata':'All packs')}</div>`;
        div.addEventListener('click',e=>{if(e.target.closest('[data-edit-folder]'))return;selectedFolderId=f.folder_id;renderFolders();renderPacks();});
        if(f.folder_id){div.querySelector('[data-edit-folder]').addEventListener('click',e=>{e.stopPropagation();openFolderModal('edit',f);});}
        div.addEventListener('dragover',e=>{e.preventDefault();if(draggedPackId&&f.folder_id)div.classList.add('drop-target');});
        div.addEventListener('dragleave',()=>div.classList.remove('drop-target'));
        div.addEventListener('drop',async e=>{e.preventDefault();div.classList.remove('drop-target');if(!draggedPackId||!f.folder_id)return;await movePackToFolder(draggedPackId,f.folder_id);draggedPackId='';});
        folderList.appendChild(div);
      });
    }

    function getFolderNameById(id){if(!id)return'No folder';const f=folders.find(x=>x.folder_id===id);return f?f.name:'No folder';}
    function setPackFolderSelection(id){packFolderSelect.value=id||'';packFolderLabel.textContent=getFolderNameById(id||'');packFolderMenu.querySelectorAll('.app-select-item').forEach(i=>i.classList.toggle('active',i.dataset.value===(id||'')));}
    function renderFolderSelect(){
      const items=[{folder_id:'',name:'No folder'},...folders.map(f=>({folder_id:f.folder_id,name:f.name}))];
      packFolderMenu.innerHTML='';
      items.forEach(item=>{const b=document.createElement('button');b.type='button';b.className='app-select-item';b.dataset.value=item.folder_id;b.textContent=item.name;b.addEventListener('click',()=>{setPackFolderSelection(item.folder_id);packFolderMenu.classList.remove('visible');packFolderButton.classList.remove('open');});packFolderMenu.appendChild(b);});
      setPackFolderSelection(packFolderSelect.value||'');
    }

    function renderPacks(){
      const items=filteredPacks();packList.innerHTML='';
      if(!items.length){packList.innerHTML='<div class="empty">No study packs match this filter.</div>';return;}
      items.forEach(p=>{
        const div=document.createElement('div');
        div.className=`item ${selectedPackId===p.study_pack_id?'active':''}`;
        div.draggable=true;div.dataset.packId=p.study_pack_id;
        div.innerHTML=`<div class="item-head"><span class="item-title">${p.title||'Untitled pack'}</span></div><div class="item-sub">${p.mode} · ${p.flashcards_count} cards · ${p.test_questions_count} questions</div><div class="item-sub">${[p.course,p.subject,p.semester,p.block].filter(Boolean).join(' · ')||(p.folder_name?`Folder: ${p.folder_name}`:'No metadata')}</div>`;
        div.addEventListener('click',async()=>{selectedPackId=p.study_pack_id;renderPacks();await openPack(p.study_pack_id);});
        div.addEventListener('dragstart',e=>{draggedPackId=p.study_pack_id;div.classList.add('dragging');e.dataTransfer.effectAllowed='move';e.dataTransfer.setData('text/plain',p.study_pack_id);});
        div.addEventListener('dragend',()=>{div.classList.remove('dragging');draggedPackId='';});
        packList.appendChild(div);
      });
    }

    function showPackEditor(v){packEmpty.style.display=v?'none':'block';packEditorWrap.classList.toggle('visible',v);}

    function updatePackSummary(){
      if(!selectedPack){packSummary.classList.remove('visible');return;}
      packSummary.classList.add('visible');
      packSummaryTitle.textContent=selectedPack.title||'Untitled pack';
      packSummaryMeta.textContent=[selectedPack.course,selectedPack.subject,selectedPack.semester,selectedPack.block].filter(Boolean).join(' · ')||(selectedPack.mode||'');
      packStatNotes.textContent=selectedPack.notes_markdown?'Has notes':'No notes';
      packStatCards.textContent=`${(selectedPack.flashcards||[]).length} flashcards`;
      packStatTest.textContent=`${(selectedPack.test_questions||[]).length} questions`;
    }

    /* ── Flashcard editor ── */
    function renderFlashcardEditor(hi=-1){
      const cards=selectedPack&&Array.isArray(selectedPack.flashcards)?selectedPack.flashcards:[];
      flashcardCount.textContent=`${cards.length} flashcards`;
      flashcardEditorList.innerHTML='';
      if(!cards.length){flashcardEditorList.innerHTML='<div class="empty">No flashcards yet. Add one to start editing.</div>';return;}
      cards.forEach((card,idx)=>{
        const row=document.createElement('div');
        row.className=`editor-card ${idx===hi?'newly-added':''}`;
        row.dataset.rowIndex=String(idx);
        row.innerHTML=`<div class="editor-card-head"><span class="editor-card-title">Flashcard ${idx+1}</span><button class="btn danger" data-delete-card="${idx}" style="padding:5px 8px;font-size:0.75rem;">Delete</button></div><div class="field"><label>Front</label><input data-card-field="front" data-card-index="${idx}" value="${(card.front||'').replace(/"/g,'&quot;')}"></div><div class="field" style="margin-top:8px;"><label>Back</label><textarea data-card-field="back" data-card-index="${idx}">${card.back||''}</textarea></div>`;
        flashcardEditorList.appendChild(row);
      });
      flashcardEditorList.querySelectorAll('[data-card-field]').forEach(el=>{
        el.addEventListener('input',()=>{selectedPack.flashcards[parseInt(el.dataset.cardIndex,10)][el.dataset.cardField]=el.value;renderLearnFlashcard();});
      });
      flashcardEditorList.querySelectorAll('[data-delete-card]').forEach(btn=>{
        btn.addEventListener('click',()=>{
          selectedPack.flashcards.splice(parseInt(btn.dataset.deleteCard,10),1);
          if(learnFlashcardIndex>=selectedPack.flashcards.length)learnFlashcardIndex=Math.max(0,selectedPack.flashcards.length-1);
          renderFlashcardEditor();renderLearnFlashcard();showToast('Flashcard deleted.');
        });
      });
      if(hi>=0){const row=flashcardEditorList.querySelector(`[data-row-index="${hi}"]`);if(row){row.scrollIntoView({behavior:'smooth',block:'center'});const inp=row.querySelector('input[data-card-field="front"]');if(inp)inp.focus();}}
    }

    /* ── Question editor ── */
    function normalizeQuestion(q){
      const b={question:q.question||'',options:Array.isArray(q.options)?q.options.slice(0,4):[],answer:q.answer||'',explanation:q.explanation||''};
      while(b.options.length<4)b.options.push('');
      if(!b.options.includes(b.answer))b.answer=b.options[0]||'';
      return b;
    }
    function getAnswerDisplay(q){const o=Array.isArray(q.options)?q.options:[];const fi=o.findIndex(x=>x===q.answer);const i=fi>=0?fi:0;return`${['A','B','C','D'][i]||'A'}: ${o[i]||'(empty)'}`;}

    function renderQuestionEditor(hi=-1){
      selectedPack.test_questions=(selectedPack.test_questions||[]).map(normalizeQuestion);
      const questions=selectedPack.test_questions;
      questionCount.textContent=`${questions.length} practice questions`;
      questionEditorList.innerHTML='';
      if(!questions.length){questionEditorList.innerHTML='<div class="empty">No practice questions yet. Add one to start editing.</div>';return;}
      questions.forEach((q,idx)=>{
        const row=document.createElement('div');
        row.className=`editor-card ${idx===hi?'newly-added':''}`;
        row.dataset.rowIndex=String(idx);
        row.innerHTML=`<div class="editor-card-head"><span class="editor-card-title">Question ${idx+1}</span><button class="btn danger" data-delete-question="${idx}" style="padding:5px 8px;font-size:0.75rem;">Delete</button></div><div class="field"><label>Question</label><textarea data-question-field="question" data-question-index="${idx}">${q.question}</textarea></div><div class="q-options-grid" style="margin-top:8px;"><div class="field"><label>Option A</label><input data-option-index="0" data-question-index="${idx}" value="${(q.options[0]||'').replace(/"/g,'&quot;')}"></div><div class="field"><label>Option B</label><input data-option-index="1" data-question-index="${idx}" value="${(q.options[1]||'').replace(/"/g,'&quot;')}"></div><div class="field"><label>Option C</label><input data-option-index="2" data-question-index="${idx}" value="${(q.options[2]||'').replace(/"/g,'&quot;')}"></div><div class="field"><label>Option D</label><input data-option-index="3" data-question-index="${idx}" value="${(q.options[3]||'').replace(/"/g,'&quot;')}"></div></div><div class="field" style="margin-top:8px;"><label>Correct Answer</label><div class="app-select q-answer-picker" data-question-index="${idx}"><button type="button" class="app-select-button" data-answer-button data-question-index="${idx}"><span class="app-select-label">${getAnswerDisplay(q).replace(/</g,'&lt;').replace(/>/g,'&gt;')}</span><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"></polyline></svg></button><div class="app-select-menu" data-answer-menu data-question-index="${idx}">${q.options.map((o,oi)=>`<button type="button" class="app-select-item ${q.answer===o?'active':''}" data-answer-item data-question-index="${idx}" data-option-index="${oi}">${['A','B','C','D'][oi]}: ${(o||'(empty)').replace(/</g,'&lt;').replace(/>/g,'&gt;')}</button>`).join('')}</div></div></div><div class="field" style="margin-top:8px;"><label>Explanation</label><textarea data-question-field="explanation" data-question-index="${idx}">${q.explanation}</textarea></div>`;
        questionEditorList.appendChild(row);
      });
      questionEditorList.querySelectorAll('[data-question-field="question"],[data-question-field="explanation"]').forEach(el=>{
        el.addEventListener('input',()=>{selectedPack.test_questions[parseInt(el.dataset.questionIndex,10)][el.dataset.questionField]=el.value;renderLearnQuestion();});
      });
      questionEditorList.querySelectorAll('[data-option-index]').forEach(el=>{
        el.addEventListener('input',()=>{
          const qi=parseInt(el.dataset.questionIndex,10),oi=parseInt(el.dataset.optionIndex,10);
          const qn=selectedPack.test_questions[qi];qn.options[oi]=el.value;
          if(!qn.options.includes(qn.answer))qn.answer=qn.options[0]||'';
          renderQuestionEditor(qi);renderLearnQuestion();
        });
      });
      questionEditorList.querySelectorAll('[data-answer-button]').forEach(b=>{
        b.addEventListener('click',e=>{
          e.stopPropagation();const m=b.parentElement.querySelector('[data-answer-menu]');
          const w=!m.classList.contains('visible');
          questionEditorList.querySelectorAll('[data-answer-menu]').forEach(x=>x.classList.remove('visible'));
          questionEditorList.querySelectorAll('[data-answer-button]').forEach(x=>x.classList.remove('open'));
          if(w){m.classList.add('visible');b.classList.add('open');}
        });
      });
      questionEditorList.querySelectorAll('[data-answer-item]').forEach(item=>{
        item.addEventListener('click',()=>{
          const qi=parseInt(item.dataset.questionIndex,10),oi=parseInt(item.dataset.optionIndex,10);
          selectedPack.test_questions[qi].answer=selectedPack.test_questions[qi].options[oi]||'';
          renderQuestionEditor(qi);renderLearnQuestion();
        });
      });
      questionEditorList.querySelectorAll('[data-delete-question]').forEach(btn=>{
        btn.addEventListener('click',()=>{
          selectedPack.test_questions.splice(parseInt(btn.dataset.deleteQuestion,10),1);
          if(learnQuestionIndex>=selectedPack.test_questions.length)learnQuestionIndex=Math.max(0,selectedPack.test_questions.length-1);
          renderQuestionEditor();renderLearnQuestion();showToast('Practice question deleted.');
        });
      });
      if(hi>=0){const row=questionEditorList.querySelector(`[data-row-index="${hi}"]`);if(row){row.scrollIntoView({behavior:'smooth',block:'center'});const ta=row.querySelector('textarea[data-question-field="question"]');if(ta)ta.focus();}}
    }

    /* ── Learn progress ── */
    function updateLearnProgressBar(){
      const cards=orderedFlashcards.length?orderedFlashcards:(selectedPack?selectedPack.flashcards||[]:[]);
      const questions=selectedPack?selectedPack.test_questions||[]:[];
      let c=0,t=0;
      if(activeLearnPane==='flashcards'){c=learnFlashcardIndex+1;t=cards.length;}
      else if(activeLearnPane==='test'){c=learnQuestionIndex+1;t=questions.length;}
      else{c=1;t=1;}
      learnProgressFill.style.width=t>0?`${(c/t)*100}%`:'0%';
      learnProgressText.textContent=t>0?`${c}/${t}`:'';
    }

    /* ── Learn flashcard (3D, algo-ordered) ── */
    let orderedFlashcards=[];
    function renderLearnFlashcard(){
      const cards=orderedFlashcards.length?orderedFlashcards:(selectedPack&&Array.isArray(selectedPack.flashcards)?selectedPack.flashcards:[]);
      if(!cards.length){
        learnFlashcardFront.textContent='No flashcards available.';learnFlashcardBack.textContent='';
        learnFlashcardInner.classList.remove('flipped');learnFProgress.textContent='Card 0 of 0';
        learnFPrev.disabled=true;learnFNext.disabled=true;learnFFlip.disabled=true;
        updateLearnProgressBar();return;
      }
      const c=cards[learnFlashcardIndex];
      const swap=sessionSettings.swapAnswerQuestion||(sessionSettings.randomSwap&&Math.random()>0.5);
      learnFlashcardFront.textContent=swap?(c.back||''):(c.front||'');
      learnFlashcardBack.textContent=swap?(c.front||''):(c.back||'');
      learnFlashcardInner.classList.toggle('flipped',learnFlashcardFlipped);
      learnFProgress.textContent=`Card ${learnFlashcardIndex+1} of ${cards.length}`;
      learnFPrev.disabled=learnFlashcardIndex===0;
      learnFNext.disabled=learnFlashcardIndex===cards.length-1;
      learnFFlip.disabled=false;
      updateLearnProgressBar();
    }

    /* ── Learn quiz ── */
    function renderLearnQuestion(){
      const questions=selectedPack&&Array.isArray(selectedPack.test_questions)?selectedPack.test_questions:[];
      if(!questions.length){
        learnQProgress.textContent='Question 0 of 0';learnQScore.textContent='Score: 0/0';
        learnQText.textContent='No practice questions available.';learnQOptions.innerHTML='';
        learnQExpl.classList.remove('visible');learnQExpl.textContent='';
        updateLearnProgressBar();return;
      }
      const q=questions[learnQuestionIndex];learnAnswered=false;
      learnQProgress.textContent=`Question ${learnQuestionIndex+1} of ${questions.length}`;
      learnQScore.textContent=`Score: ${learnScore}/${questions.length}`;
      learnQText.textContent=q.question||'';learnQOptions.innerHTML='';
      learnQExpl.classList.remove('visible');learnQExpl.textContent='';
      (q.options||[]).forEach(option=>{
        const b=document.createElement('button');b.type='button';b.className='quiz-option';b.textContent=option;
        b.addEventListener('click',()=>{
          if(learnAnswered)return;learnAnswered=true;
          const correct=option===q.answer;
          [...learnQOptions.querySelectorAll('.quiz-option')].forEach(btn=>{
            btn.disabled=true;
            if(btn.textContent===q.answer)btn.classList.add('correct');
          });
          if(correct){b.classList.add('correct');learnScore+=1;}
          else{b.classList.add('wrong');}
          // Track card state for mastery
          markCardSeen(`q_${learnQuestionIndex}`,correct);
          learnQScore.textContent=`Score: ${learnScore}/${questions.length}`;
          learnQExpl.textContent=q.explanation||'';learnQExpl.classList.add('visible');
          updateLearnProgressBar();
        });
        learnQOptions.appendChild(b);
      });
      updateLearnProgressBar();
    }

    /* ── Learn pane switching ── */
    function setLearnPane(pane){
      activeLearnPane=pane;
      learnTabs.forEach(b=>b.classList.toggle('active',b.dataset.learnPane===pane));
      document.getElementById('learn-pane-notes').classList.toggle('active',pane==='notes');
      document.getElementById('learn-pane-flashcards').classList.toggle('active',pane==='flashcards');
      document.getElementById('learn-pane-test').classList.toggle('active',pane==='test');
      updateLearnProgressBar();
    }

    function configureLearnTabs(preferPane){
      if(!selectedPack)return;
      const hasNotes=!!(selectedPack.notes_markdown);
      const hasFC=selectedPack.flashcards&&selectedPack.flashcards.length>0;
      const hasTest=selectedPack.test_questions&&selectedPack.test_questions.length>0;
      const tN=document.getElementById('learn-tab-notes');
      const tF=document.getElementById('learn-tab-flashcards');
      const tT=document.getElementById('learn-tab-test');
      tN.style.display=hasNotes?'':'none';
      tF.style.display=hasFC?'':'none';
      tT.style.display=hasTest?'':'none';
      const vis=[hasNotes,hasFC,hasTest].filter(Boolean).length;
      learnTabsContainer.classList.toggle('single-tab',vis<=1);
      let target=preferPane;
      if(target==='flashcards'&&!hasFC)target=hasTest?'test':(hasNotes?'notes':'notes');
      if(target==='test'&&!hasTest)target=hasFC?'flashcards':(hasNotes?'notes':'notes');
      if(target==='notes'&&!hasNotes)target=hasFC?'flashcards':(hasTest?'test':'notes');
      setLearnPane(target);
    }

    function openLearnStageDirectly(requestFullscreen,preferPane){
      if(!selectedPack){showToast('Select a study pack first.','error');return;}
      learnTitle.textContent=selectedPack.title||'Learn Mode';
      learnSub.textContent=`${selectedPack.mode||'study-pack'} · Focused session`;
      learnNotesContent.innerHTML=mdToHtml(selectedPack.notes_markdown||'');
      learnFlashcardIndex=0;learnFlashcardFlipped=false;learnQuestionIndex=0;learnScore=0;
      // Apply algorithm ordering
      orderedFlashcards=orderCardsByAlgo(selectedPack.flashcards||[]);
      renderLearnFlashcard();renderLearnQuestion();
      configureLearnTabs(preferPane||activeEditorPane);
      learnStage.classList.add('entering');
      requestAnimationFrame(()=>{requestAnimationFrame(()=>learnStage.classList.replace('entering','visible'));});
      if(requestFullscreen)document.documentElement.requestFullscreen?.().catch(()=>{});
    }

    function closeLearnStage(){
      learnStage.classList.remove('visible');
      orderedFlashcards=[];
      if(document.fullscreenElement)document.exitFullscreen().catch(()=>{});
    }

    /* ── Folder modal ── */
    function openFolderModal(mode,folder){
      folderModalMode=mode;editingFolderId=folder&&folder.folder_id?folder.folder_id:'';
      folderModalTitle.textContent=mode==='edit'?'Edit Folder':'Create Folder';
      folderNameInput.value=folder?folder.name||'':'';folderCourseInput.value=folder?folder.course||'':'';
      folderSubjectInput.value=folder?folder.subject||'':'';folderSemesterInput.value=folder?folder.semester||'':'';
      folderBlockInput.value=folder?folder.block||'':'';
      openModal(folderModalOverlay);setTimeout(()=>folderNameInput.focus(),100);
    }
    function closeFolderModal(){
      closeModal(folderModalOverlay);folderModalMode='create';editingFolderId='';
      folderNameInput.value='';folderCourseInput.value='';folderSubjectInput.value='';
      folderSemesterInput.value='';folderBlockInput.value='';
    }
    async function saveFolderFromModal(){
      const payload={name:folderNameInput.value.trim(),course:folderCourseInput.value.trim(),subject:folderSubjectInput.value.trim(),semester:folderSemesterInput.value.trim(),block:folderBlockInput.value.trim()};
      if(!payload.name){showToast('Folder name is required.','error');folderNameInput.focus();return;}
      try{
        if(folderModalMode==='edit'&&editingFolderId){await api(`/api/study-folders/${encodeURIComponent(editingFolderId)}`,{method:'PATCH',body:JSON.stringify(payload)});showToast('Folder updated.');}
        else{await api('/api/study-folders',{method:'POST',body:JSON.stringify(payload)});showToast('Folder created.');}
        closeFolderModal();await loadData(selectedPackId||pendingOpenPackId);
      }catch(e){showToast(e.message||'Could not save folder.','error');}
    }

    /* ── Open pack ── */
    async function openPack(packId){
      selectedPack=await api(`/api/study-packs/${encodeURIComponent(packId)}`);
      selectedPack.flashcards=Array.isArray(selectedPack.flashcards)?selectedPack.flashcards:[];
      selectedPack.test_questions=Array.isArray(selectedPack.test_questions)?selectedPack.test_questions.map(normalizeQuestion):[];
      showPackEditor(true);updatePackSummary();
      packTitle.value=selectedPack.title||'';
      setPackFolderSelection(selectedPack.folder_id||'');
      packCourse.value=selectedPack.course||'';packSubject.value=selectedPack.subject||'';
      packSemester.value=selectedPack.semester||'';packBlock.value=selectedPack.block||'';
      notesView.innerHTML=mdToHtml(selectedPack.notes_markdown||'');
      renderFlashcardEditor();renderQuestionEditor();renderLearnFlashcard();renderLearnQuestion();
      setEditorPane(activeEditorPane);
      if(openLearnFromUrl&&!autoLearnConsumed&&selectedPack.study_pack_id===learnPackFromUrl){
        autoLearnConsumed=true;
        openLearnStageDirectly(fullscreenFromUrl,focusFromUrl||activeEditorPane);
      }
    }

    /* ── Load data ── */
    async function loadData(preferredPackId=''){
      const [folderData,packData]=await Promise.all([api('/api/study-folders'),api('/api/study-packs')]);
      folders=folderData.folders||[];packs=packData.study_packs||[];
      renderFolderSelect();renderFolders();renderPacks();
      const packToOpen=preferredPackId||selectedPackId||'';
      if(packToOpen&&packs.find(item=>item.study_pack_id===packToOpen)){
        selectedPackId=packToOpen;renderPacks();await openPack(packToOpen);
      }else if(learnPackFromUrl&&packs.find(item=>item.study_pack_id===learnPackFromUrl)){
        selectedPackId=learnPackFromUrl;renderPacks();await openPack(learnPackFromUrl);
      }else{selectedPack=null;showPackEditor(false);updatePackSummary();}
    }

    /* ── Auth ── */
    async function applyAuthState(user){
      if(!user){token=null;userMeta.textContent='Not signed in';authBtn.textContent='Sign in';return;}
      token=await user.getIdToken();
      userMeta.textContent=`Signed in as ${user.email}`;authBtn.textContent='Sign out';
      try{await loadData();}catch(e){showToast(e.message||'Could not load study library.','error');}
    }

    if(auth&&typeof auth.onAuthStateChanged==='function'){
      auth.onAuthStateChanged(async(user)=>{await applyAuthState(user);});
      // Fallback for edge cases where onAuthStateChanged does not fire promptly.
      setTimeout(async()=>{
        if(userMeta.textContent!=='Checking sign-in...')return;
        try{await applyAuthState(auth.currentUser||null);}
        catch(e){userMeta.textContent='Not signed in';authBtn.textContent='Sign in';}
      },1800);
    }else{
      userMeta.textContent='Auth unavailable';
      authBtn.textContent='Sign in';
    }

    /* ── All event listeners ── */
    authBtn.addEventListener('click',async()=>{if(!auth||!auth.currentUser){window.location.href='/';return;}await auth.signOut();});
    backAppBtn.addEventListener('click',()=>{window.location.href='/';});
    fullscreenBtn.addEventListener('click',()=>{if(!selectedPack){showToast('Select a study pack first.','error');return;}openLearnStageDirectly(true,activeEditorPane);});
    searchInput.addEventListener('input',renderPacks);
    packFolderButton.addEventListener('click',e=>{e.stopPropagation();packFolderMenu.classList.toggle('visible');packFolderButton.classList.toggle('open',packFolderMenu.classList.contains('visible'));});
    newFolderBtn.addEventListener('click',()=>openFolderModal('create'));

    deleteFolderBtn.addEventListener('click',async()=>{
      if(!selectedFolderId){showToast('Select a folder first.','error');return;}
      const confirmed=await openConfirmModal('Delete Folder','Delete this folder? Packs inside will move to no folder.','Delete Folder');
      if(!confirmed)return;
      try{await api(`/api/study-folders/${encodeURIComponent(selectedFolderId)}`,{method:'DELETE'});selectedFolderId='';await loadData(selectedPackId);showToast('Folder deleted.');}
      catch(e){showToast(e.message||'Could not delete folder.','error');}
    });

    savePackBtn.addEventListener('click',async()=>{
      if(!selectedPackId||!selectedPack){showToast('Select a study pack first.','error');return;}
      try{
        await api(`/api/study-packs/${encodeURIComponent(selectedPackId)}`,{
          method:'PATCH',
          body:JSON.stringify({title:packTitle.value.trim(),folder_id:packFolderSelect.value,course:packCourse.value.trim(),subject:packSubject.value.trim(),semester:packSemester.value.trim(),block:packBlock.value.trim(),flashcards:selectedPack.flashcards||[],test_questions:selectedPack.test_questions||[]})
        });
        pendingOpenPackId=selectedPackId;await loadData(selectedPackId);pendingOpenPackId='';showToast('Study pack saved.');
      }catch(e){showToast(e.message||'Could not save study pack.','error');}
    });

    deletePackBtn.addEventListener('click',async()=>{
      if(!selectedPackId){showToast('Select a study pack first.','error');return;}
      const confirmed=await openConfirmModal('Delete Study Pack','Delete this study pack permanently? This cannot be undone.','Delete Pack');
      if(!confirmed)return;
      try{await api(`/api/study-packs/${encodeURIComponent(selectedPackId)}`,{method:'DELETE'});selectedPackId='';selectedPack=null;showPackEditor(false);updatePackSummary();await loadData();showToast('Study pack deleted.');}
      catch(e){showToast(e.message||'Could not delete study pack.','error');}
    });

    exportPackCsvBtn.addEventListener('click',async()=>{
      if(!selectedPackId){showToast('Select a study pack first.','error');return;}
      try{await downloadStudyPackCsv(selectedPackId,exportType);showToast('CSV export started.');}
      catch(e){showToast(e.message||'Could not export CSV.','error');}
    });

    openLearnBtn.addEventListener('click',()=>openSessionSetup());
    editorTabs.forEach(btn=>btn.addEventListener('click',()=>setEditorPane(btn.dataset.editorPane)));

    addFlashcardBtn.addEventListener('click',()=>{
      if(!selectedPack)return;
      selectedPack.flashcards=selectedPack.flashcards||[];
      selectedPack.flashcards.push({front:'New concept',back:'New explanation'});
      const ni=selectedPack.flashcards.length-1;
      learnFlashcardIndex=ni;learnFlashcardFlipped=false;
      renderFlashcardEditor(ni);renderLearnFlashcard();setEditorPane('flashcards');
      showToast('New flashcard added.');
    });

    addQuestionBtn.addEventListener('click',()=>{
      if(!selectedPack)return;
      selectedPack.test_questions=selectedPack.test_questions||[];
      selectedPack.test_questions.push(normalizeQuestion({question:'New question',options:['Option A','Option B','Option C','Option D'],answer:'Option A',explanation:'Add explanation here.'}));
      const ni=selectedPack.test_questions.length-1;
      learnQuestionIndex=ni;
      renderQuestionEditor(ni);renderLearnQuestion();setEditorPane('test');
      showToast('New practice question added.');
    });

    learnBackAppBtn.addEventListener('click',()=>{window.location.href='/';});
    learnBackLibraryBtn.addEventListener('click',closeLearnStage);
    learnFullscreenBtn.addEventListener('click',async()=>{
      try{if(document.fullscreenElement)await document.exitFullscreen();else await document.documentElement.requestFullscreen();}
      catch(e){showToast('Fullscreen not available.','error');}
    });

    learnTabs.forEach(btn=>btn.addEventListener('click',()=>setLearnPane(btn.dataset.learnPane)));

    learnFlashcard3d.addEventListener('click',()=>{
      learnFlashcardFlipped=!learnFlashcardFlipped;
      // Track that user saw this card
      markCardSeen(`fc_${learnFlashcardIndex}`,true);
      renderLearnFlashcard();
    });
    learnFPrev.addEventListener('click',()=>{
      const cards=orderedFlashcards.length?orderedFlashcards:(selectedPack&&selectedPack.flashcards?selectedPack.flashcards:[]);
      if(!cards.length)return;
      learnFlashcardIndex=Math.max(0,learnFlashcardIndex-1);learnFlashcardFlipped=false;renderLearnFlashcard();
    });
    learnFNext.addEventListener('click',()=>{
      const cards=orderedFlashcards.length?orderedFlashcards:(selectedPack&&selectedPack.flashcards?selectedPack.flashcards:[]);
      if(!cards.length)return;
      learnFlashcardIndex=Math.min(cards.length-1,learnFlashcardIndex+1);learnFlashcardFlipped=false;renderLearnFlashcard();
    });
    learnFFlip.addEventListener('click',()=>{
      learnFlashcardFlipped=!learnFlashcardFlipped;
      markCardSeen(`fc_${learnFlashcardIndex}`,true);
      renderLearnFlashcard();
    });
    learnQNext.addEventListener('click',()=>{
      const questions=selectedPack&&selectedPack.test_questions?selectedPack.test_questions:[];
      if(!questions.length)return;
      learnQuestionIndex=Math.min(questions.length-1,learnQuestionIndex+1);renderLearnQuestion();
    });

    window.addEventListener('keydown',e=>{
      if(!learnStage.classList.contains('visible'))return;
      if(activeLearnPane!=='flashcards')return;
      if(e.key==='ArrowLeft'){e.preventDefault();learnFPrev.click();}
      if(e.key==='ArrowRight'){e.preventDefault();learnFNext.click();}
      if(e.code==='Space'){e.preventDefault();learnFFlip.click();}
    });

    folderModalClose.addEventListener('click',closeFolderModal);
    folderModalCancel.addEventListener('click',closeFolderModal);
    folderModalSave.addEventListener('click',saveFolderFromModal);
    folderModalOverlay.addEventListener('click',e=>{if(e.target===folderModalOverlay)closeFolderModal();});

    document.addEventListener('click',e=>{
      if(!packFolderPicker.contains(e.target)){packFolderMenu.classList.remove('visible');packFolderButton.classList.remove('open');}
      if(!e.target.closest('.q-answer-picker')){
        questionEditorList.querySelectorAll('[data-answer-menu]').forEach(m=>m.classList.remove('visible'));
        questionEditorList.querySelectorAll('[data-answer-button]').forEach(b=>b.classList.remove('open'));
      }
    });

    confirmModalClose.addEventListener('click',()=>closeConfirmModal(false));
    confirmModalCancel.addEventListener('click',()=>closeConfirmModal(false));
    confirmModalConfirm.addEventListener('click',()=>closeConfirmModal(true));
    confirmModalOverlay.addEventListener('click',e=>{if(e.target===confirmModalOverlay)closeConfirmModal(false);});
  </script>
</body>
</html>
