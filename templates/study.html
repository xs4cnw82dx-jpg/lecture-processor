<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Study Library</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <style>
    :root {
      --primary:#4F46E5;--primary-dark:#4338CA;--primary-light:#818CF8;--secondary:#0EA5E9;
      --success:#10B981;--warning:#F59E0B;--error:#EF4444;
      --gray-50:#F9FAFB;--gray-100:#F3F4F6;--gray-200:#E5E7EB;--gray-300:#D1D5DB;
      --gray-400:#9CA3AF;--gray-500:#6B7280;--gray-600:#4B5563;--gray-700:#374151;
      --gray-800:#1F2937;--gray-900:#111827;--white:#FFFFFF;
      --shadow-sm:0 1px 2px 0 rgb(0 0 0/.05);--shadow:0 1px 3px 0 rgb(0 0 0/.1),0 1px 2px -1px rgb(0 0 0/.1);
      --shadow-md:0 4px 6px -1px rgb(0 0 0/.1),0 2px 4px -2px rgb(0 0 0/.1);
      --shadow-lg:0 10px 15px -3px rgb(0 0 0/.1),0 4px 6px -4px rgb(0 0 0/.1);
      --shadow-xl:0 20px 25px -5px rgb(0 0 0/.1),0 8px 10px -6px rgb(0 0 0/.1);
      --radius-sm:6px;--radius:8px;--radius-md:12px;--radius-lg:16px;--radius-xl:24px;
    }
    *,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
    html{scroll-behavior:smooth}
    body{font-family:'Inter',-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:linear-gradient(135deg,var(--gray-50) 0%,var(--gray-100) 100%);color:var(--gray-800);line-height:1.6;min-height:100vh;-webkit-font-smoothing:antialiased}
    input,textarea,select,button{font-family:inherit}
    .container{max-width:1360px;margin:0 auto;padding:20px}

    .topbar{display:flex;justify-content:space-between;align-items:center;gap:12px;padding:14px 20px;background:rgba(255,255,255,0.95);backdrop-filter:blur(12px);-webkit-backdrop-filter:blur(12px);border:1px solid var(--gray-200);border-radius:var(--radius-lg);box-shadow:var(--shadow-lg);margin-bottom:16px;position:sticky;top:12px;z-index:100}
    .topbar-logo{display:flex;align-items:center;gap:12px;min-width:0}
    .topbar-logo-icon{width:38px;height:38px;flex-shrink:0;background:linear-gradient(135deg,var(--primary) 0%,var(--secondary) 100%);border-radius:var(--radius-md);display:flex;align-items:center;justify-content:center;color:var(--white)}
    .topbar-logo-icon svg{width:22px;height:22px}
    .topbar h1{font-size:1.15rem;font-weight:700;letter-spacing:-0.025em;color:var(--gray-900);white-space:nowrap}
    .topbar-sub{font-size:.8125rem;color:var(--gray-500);margin-top:1px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;max-width:220px}
    .actions{display:flex;gap:8px;flex-wrap:wrap;align-items:center}

    .btn{display:inline-flex;align-items:center;justify-content:center;gap:7px;border:1px solid var(--gray-300);background:var(--white);color:var(--gray-700);border-radius:var(--radius);padding:9px 14px;font-size:.85rem;font-weight:600;cursor:pointer;transition:all .2s ease;white-space:nowrap}
    .btn:hover{border-color:var(--gray-400);color:var(--gray-900);background:var(--gray-50)}
    .btn:active{transform:scale(.97)}
    .btn.primary{background:linear-gradient(135deg,var(--primary) 0%,var(--primary-dark) 100%);border:none;color:var(--white);box-shadow:0 4px 14px 0 rgba(79,70,229,.3)}
    .btn.primary:hover{opacity:.92;transform:translateY(-1px);box-shadow:0 6px 20px 0 rgba(79,70,229,.4)}
    .btn.danger{border-color:rgba(239,68,68,.35);color:#991B1B;background:rgba(239,68,68,.06)}
    .btn.danger:hover{background:rgba(239,68,68,.12);border-color:rgba(239,68,68,.5)}
    .btn.cta{background:linear-gradient(135deg,var(--primary) 0%,var(--secondary) 100%);border:none;color:var(--white);padding:14px 32px;font-size:1rem;font-weight:700;border-radius:var(--radius-md);box-shadow:0 4px 14px 0 rgba(79,70,229,.35);width:100%}
    .btn.cta:hover{opacity:.92;transform:translateY(-1px);box-shadow:0 6px 20px 0 rgba(79,70,229,.45)}
    .btn svg{width:16px;height:16px;flex-shrink:0}

    .grid{display:grid;grid-template-columns:300px 1fr;gap:16px}
    @media(max-width:1020px){.grid{grid-template-columns:1fr}}

    .panel{background:var(--white);border:1px solid var(--gray-200);border-radius:var(--radius-xl);box-shadow:var(--shadow-lg);overflow:hidden}
    .panel-head{display:flex;align-items:center;justify-content:space-between;gap:8px;padding:16px 20px;border-bottom:1px solid var(--gray-200)}
    .panel-title{font-size:.95rem;font-weight:700;color:var(--gray-900)}
    .panel-body{padding:16px 20px}

    .pack-summary{display:none;padding:16px;margin-bottom:14px;background:linear-gradient(135deg,rgba(79,70,229,.06) 0%,rgba(14,165,233,.06) 100%);border:1px solid rgba(79,70,229,.15);border-radius:var(--radius-md);animation:fadeSlideIn .3s ease-out}
    .pack-summary.visible{display:block}
    .pack-summary-title{font-size:1rem;font-weight:700;color:var(--gray-900);margin-bottom:4px}
    .pack-summary-meta{font-size:.8rem;color:var(--gray-500);margin-bottom:10px}
    .pack-summary-stats{display:flex;gap:16px;flex-wrap:wrap}
    .pack-stat{display:flex;align-items:center;gap:6px;font-size:.82rem;font-weight:600;color:var(--gray-700)}
    .pack-stat-icon{width:28px;height:28px;border-radius:50%;display:flex;align-items:center;justify-content:center;flex-shrink:0}
    .pack-stat-icon svg{width:14px;height:14px}
    .pack-stat-icon.notes-icon{background:rgba(79,70,229,.1);color:var(--primary)}
    .pack-stat-icon.cards-icon{background:rgba(14,165,233,.1);color:var(--secondary)}
    .pack-stat-icon.test-icon{background:rgba(16,185,129,.1);color:var(--success)}

    .field{display:flex;flex-direction:column;gap:5px}
    .field label{font-size:.75rem;color:var(--gray-500);font-weight:700;text-transform:uppercase;letter-spacing:.05em}
    .field input,.field textarea,.field select{border:1px solid var(--gray-300);border-radius:var(--radius);padding:10px 12px;font-size:.9rem;color:var(--gray-900);background:var(--white);transition:all .2s ease}
    .field input:focus,.field textarea:focus,.field select:focus{outline:none;border-color:var(--primary);box-shadow:0 0 0 3px rgba(79,70,229,.1)}
    .field textarea{min-height:78px;resize:vertical}

    .app-select{position:relative}
    .app-select-button{width:100%;display:flex;align-items:center;justify-content:space-between;gap:8px;border:1px solid var(--gray-300);border-radius:var(--radius);padding:10px 12px;font-size:.9rem;color:var(--gray-900);background:var(--white);cursor:pointer;transition:all .2s ease}
    .app-select-button:hover{border-color:var(--primary-light)}
    .app-select-button.open{border-color:var(--primary);box-shadow:0 0 0 3px rgba(79,70,229,.1)}
    .app-select-button svg{width:15px;height:15px;color:var(--gray-500);transition:transform .2s ease}
    .app-select-button.open svg{transform:rotate(180deg)}
    .app-select-label{overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
    .app-select-menu{display:none;position:absolute;left:0;right:0;top:calc(100% + 6px);background:var(--white);border:1px solid var(--gray-200);border-radius:var(--radius-md);box-shadow:var(--shadow-lg);z-index:80;max-height:260px;overflow-y:auto}
    .app-select-menu.visible{display:block;animation:dropdownOpen .2s ease-out}
    .app-select-item{width:100%;border:none;background:var(--white);text-align:left;padding:10px 12px;font-size:.9rem;color:var(--gray-700);cursor:pointer;transition:background .15s ease}
    .app-select-item:hover{background:var(--gray-50)}
    .app-select-item.active{background:rgba(79,70,229,.1);color:var(--primary-dark);font-weight:600}
    .q-answer-picker{margin-top:4px}

    .search-box{margin-bottom:12px}
    .list{display:flex;flex-direction:column;gap:8px;max-height:68vh;overflow-y:auto;padding-right:2px}

    .item{border:1px solid var(--gray-200);border-radius:var(--radius-md);padding:12px 14px;background:var(--white);cursor:pointer;transition:all .25s ease}
    .item:hover{border-color:var(--gray-300);box-shadow:var(--shadow-sm);transform:translateY(-1px)}
    .item.active{border-color:var(--primary);background:rgba(79,70,229,.04);box-shadow:0 0 0 3px rgba(79,70,229,.08)}
    .item.dragging{opacity:.35;transform:scale(.985);border-style:dashed;border-color:var(--primary);background:rgba(79,70,229,.08)}
    .item.drop-target{border-color:var(--success);background:linear-gradient(135deg,rgba(16,185,129,.12) 0%,rgba(14,165,233,.08) 100%);box-shadow:0 0 0 3px rgba(16,185,129,.15);transform:translateY(-2px)}
    .item-head{display:flex;justify-content:space-between;gap:8px;align-items:center}
    .item-title{font-size:.9rem;font-weight:700;color:var(--gray-900)}
    .item-sub{margin-top:4px;font-size:.78rem;color:var(--gray-500)}

    .split{display:grid;grid-template-columns:320px 1fr;gap:16px}
    @media(max-width:1200px){.split{grid-template-columns:1fr}}
    .meta-grid{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:10px;margin-bottom:14px}
    @media(max-width:700px){.meta-grid{grid-template-columns:1fr}}

    .editor-wrap{display:none}
    .editor-wrap.visible{display:block;animation:fadeSlideIn .3s ease-out}
    .empty{color:var(--gray-500);font-size:.9rem;padding:20px;border:1px dashed var(--gray-300);border-radius:var(--radius-md);background:var(--gray-50);text-align:center}
    .editor-tabs{display:flex;gap:4px;margin-bottom:14px;background:var(--gray-100);border-radius:var(--radius-md);padding:4px}
    .editor-tab{flex:1;border:none;background:transparent;border-radius:var(--radius);padding:10px 12px;font-size:.82rem;font-weight:600;color:var(--gray-600);cursor:pointer;transition:all .2s ease;text-align:center;display:flex;align-items:center;justify-content:center;gap:6px}
    .editor-tab:hover{color:var(--gray-900)}
    .editor-tab.active{background:var(--white);color:var(--gray-900);box-shadow:var(--shadow-sm)}
    .editor-tab svg{width:15px;height:15px}
    .editor-pane{display:none}
    .editor-pane.active{display:block;animation:fadeIn .25s ease-out}
    .notes-view{border:1px solid var(--gray-200);border-radius:var(--radius-md);background:var(--gray-50);padding:20px;max-height:60vh;overflow-y:auto;font-size:.92rem;line-height:1.7}
    .notes-view h1,.notes-view h2,.notes-view h3{margin-top:20px;margin-bottom:10px;color:var(--gray-900)}
    .notes-view h1{font-size:1.4rem;border-bottom:2px solid var(--gray-200);padding-bottom:8px}
    .editor-toolbar{display:flex;justify-content:space-between;align-items:center;gap:8px;flex-wrap:wrap;margin-bottom:10px}
    .editor-count{font-size:.82rem;color:var(--gray-500);font-weight:600}
    .editor-list{display:flex;flex-direction:column;gap:10px;max-height:58vh;overflow-y:auto;padding-right:2px}
    .editor-card{border:1px solid var(--gray-200);border-radius:var(--radius-md);background:var(--white);padding:14px;transition:all .25s ease}
    .editor-card:hover{border-color:var(--gray-300);box-shadow:var(--shadow-sm)}
    .editor-card.newly-added{border-color:var(--success);box-shadow:0 0 0 3px rgba(16,185,129,.12);animation:highlightPulse .6s ease-out}
    .editor-card-head{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px}
    .editor-card-title{font-size:.8rem;color:var(--gray-500);font-weight:700;text-transform:uppercase;letter-spacing:.05em}
    .q-options-grid{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:8px}
    @media(max-width:700px){.q-options-grid{grid-template-columns:1fr}}

    /* ── Setup overlay ── */
    .setup-overlay{position:fixed;inset:0;z-index:280;background:rgba(0,0,0,.5);display:none;align-items:center;justify-content:center;padding:18px;opacity:0;transition:opacity .25s ease}
    .setup-overlay.visible{display:flex;opacity:1}
    .setup-overlay.entering{display:flex;opacity:0}
    .setup-modal{width:min(720px,100%);max-height:90vh;overflow-y:auto;background:var(--white);border:1px solid var(--gray-200);border-radius:var(--radius-xl);box-shadow:var(--shadow-xl);padding:28px;transform:scale(.95);opacity:0;transition:all .25s ease}
    .setup-overlay.visible .setup-modal{transform:scale(1);opacity:1}
    .setup-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px}
    .setup-title{font-size:1.2rem;font-weight:700;color:var(--gray-900)}
    .setup-pack-name{font-size:.85rem;color:var(--gray-500);margin-top:2px}
    .setup-tabs{display:flex;gap:4px;background:var(--gray-100);border-radius:var(--radius-md);padding:4px;margin-bottom:20px}
    .setup-tab{flex:1;border:none;background:transparent;border-radius:var(--radius);padding:10px 6px;font-size:.78rem;font-weight:600;color:var(--gray-600);cursor:pointer;transition:all .2s ease;text-align:center;display:flex;align-items:center;justify-content:center;gap:5px}
    .setup-tab:hover{color:var(--gray-900)}
    .setup-tab.active{background:var(--white);color:var(--gray-900);box-shadow:var(--shadow-sm)}
    .setup-tab svg{width:14px;height:14px}
    .setup-pane{display:none}
    .setup-pane.active{display:block;animation:fadeIn .2s ease-out}

    /* Lessons */
    .lesson-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:12px}
    @media(max-width:500px){.lesson-grid{grid-template-columns:1fr}}
    .lesson-card{border:2px solid var(--gray-200);border-radius:var(--radius-md);padding:20px;cursor:pointer;transition:all .25s ease;display:flex;flex-direction:column;align-items:center;gap:8px;text-align:center;position:relative}
    .lesson-card:hover{border-color:var(--gray-300);box-shadow:var(--shadow-sm)}
    .lesson-card.selected{border-color:var(--primary);background:linear-gradient(135deg,rgba(79,70,229,.08) 0%,rgba(14,165,233,.06) 100%);box-shadow:0 0 0 3px rgba(79,70,229,.1)}
    .lesson-card.unavailable{opacity:.4;cursor:not-allowed;pointer-events:none}
    .lesson-card-check{position:absolute;top:10px;left:10px;width:22px;height:22px;border:2px solid var(--gray-300);border-radius:50%;display:flex;align-items:center;justify-content:center;transition:all .2s ease}
    .lesson-card.selected .lesson-card-check{background:var(--primary);border-color:var(--primary)}
    .lesson-card-check svg{width:13px;height:13px;color:var(--white);opacity:0;transition:opacity .2s ease}
    .lesson-card.selected .lesson-card-check svg{opacity:1}
    .lesson-card-icon{width:40px;height:40px;color:var(--primary)}
    .lesson-card-icon svg{width:100%;height:100%}
    .lesson-card-title{font-size:1rem;font-weight:700;color:var(--gray-900)}
    .lesson-card-desc{font-size:.82rem;color:var(--gray-500)}
    .lesson-card-badge{font-size:.7rem;font-weight:700;text-transform:uppercase;letter-spacing:.05em;color:var(--gray-400);background:var(--gray-100);padding:3px 8px;border-radius:20px}

    /* Mode picker (shown when multiple lessons enabled) */
    .mode-picker{display:none;animation:fadeIn .2s ease-out}
    .mode-picker.active{display:block}
    .mode-picker-title{text-align:center;font-size:1rem;font-weight:700;color:var(--gray-900);margin-bottom:16px}
    .mode-picker-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:12px}
    @media(max-width:500px){.mode-picker-grid{grid-template-columns:1fr}}
    .mode-picker-card{border:2px solid var(--gray-200);border-radius:var(--radius-md);padding:24px 16px;cursor:pointer;transition:all .25s ease;display:flex;flex-direction:column;align-items:center;gap:8px;text-align:center}
    .mode-picker-card:hover{border-color:var(--primary-light);box-shadow:var(--shadow-md);transform:translateY(-2px)}
    .mode-picker-card svg{width:36px;height:36px;color:var(--primary)}
    .mode-picker-card-title{font-size:.95rem;font-weight:700;color:var(--gray-900)}
    .mode-picker-card-desc{font-size:.8rem;color:var(--gray-500)}

    /* Algorithm */
    .algo-lane{display:flex;align-items:center;gap:6px;justify-content:center;margin-bottom:20px;flex-wrap:wrap}
    .algo-slot{width:100px;height:110px;border-radius:var(--radius-md);display:flex;flex-direction:column;align-items:center;justify-content:center;gap:5px;font-size:.78rem;font-weight:700;color:var(--white);cursor:pointer;transition:all .25s ease;box-shadow:var(--shadow-sm);user-select:none}
    .algo-slot:hover{transform:translateY(-3px);box-shadow:var(--shadow-md)}
    .algo-slot:active{transform:scale(.95)}
    .algo-slot svg{width:26px;height:26px}
    .algo-slot[data-type="new"]{background:linear-gradient(135deg,#38BDF8,#0EA5E9)}
    .algo-slot[data-type="familiar"]{background:linear-gradient(135deg,#34D399,#10B981)}
    .algo-slot[data-type="retry"]{background:linear-gradient(135deg,#FB7185,#EF4444)}
    .algo-slot[data-type="remaster"]{background:linear-gradient(135deg,#FBBF24,#F59E0B)}
    .algo-slot[data-type="random"]{background:linear-gradient(135deg,#A78BFA,#7C3AED)}
    .algo-chevron{color:var(--gray-400);flex-shrink:0}
    .algo-chevron svg{width:16px;height:16px}
    .algo-presets{display:flex;gap:8px;justify-content:center;flex-wrap:wrap;margin-bottom:20px}
    .algo-preset{border:1px solid var(--gray-300);background:var(--white);border-radius:var(--radius);padding:8px 14px;font-size:.82rem;font-weight:600;color:var(--gray-700);cursor:pointer;transition:all .2s ease}
    .algo-preset:hover{border-color:var(--gray-400);color:var(--gray-900)}
    .algo-preset.active{background:var(--primary);color:var(--white);border-color:var(--primary)}

    /* Settings */
    .settings-list{display:flex;flex-direction:column;gap:2px}
    .setting-row{display:flex;align-items:center;justify-content:space-between;gap:12px;padding:14px 16px;border-radius:var(--radius);background:var(--gray-50);transition:background .15s ease;cursor:pointer}
    .setting-row:hover{background:var(--gray-100)}
    .setting-row.active{background:rgba(79,70,229,.06)}
    .setting-label{font-size:.9rem;color:var(--gray-800);font-weight:500}
    .setting-toggle{width:42px;height:24px;border-radius:12px;background:var(--gray-300);position:relative;flex-shrink:0;transition:background .2s ease}
    .setting-toggle::after{content:'';position:absolute;top:2px;left:2px;width:20px;height:20px;border-radius:50%;background:var(--white);box-shadow:var(--shadow-sm);transition:transform .2s ease}
    .setting-row.active .setting-toggle{background:var(--primary)}
    .setting-row.active .setting-toggle::after{transform:translateX(18px)}

    /* Mastery */
    .mastery-section{text-align:center}
    .mastery-rings{display:flex;justify-content:center;gap:24px;margin:20px 0;flex-wrap:wrap}
    .mastery-ring{display:flex;flex-direction:column;align-items:center;gap:8px}
    .mastery-ring-circle{width:80px;height:80px;border-radius:50%;border:4px solid var(--gray-200);display:flex;align-items:center;justify-content:center;font-size:1.25rem;font-weight:800;color:var(--gray-900);transition:all .3s ease}
    .mastery-ring-circle.new-ring{border-color:#38BDF8;color:#0EA5E9}
    .mastery-ring-circle.familiar-ring{border-color:#34D399;color:#10B981}
    .mastery-ring-circle.mastered-ring{border-color:#FBBF24;color:#F59E0B}
    .mastery-ring-label{font-size:.75rem;font-weight:700;text-transform:uppercase;letter-spacing:.05em;color:var(--gray-500)}
    .mastery-stat{display:flex;align-items:center;justify-content:center;gap:8px;padding:10px 16px;background:var(--gray-50);border-radius:var(--radius);font-size:.85rem;color:var(--gray-600);margin-bottom:16px}
    .mastery-stat strong{color:var(--gray-900)}

    /* ── Learn stage ── */
    .learn-stage{position:fixed;inset:0;z-index:300;background:linear-gradient(135deg,var(--gray-50) 0%,var(--gray-100) 100%);display:none;opacity:0;transition:opacity .35s ease}
    .learn-stage::before{content:'';position:absolute;inset:0;pointer-events:none;background:radial-gradient(circle at 15% 15%,rgba(79,70,229,.12),transparent 50%),radial-gradient(circle at 85% 25%,rgba(14,165,233,.10),transparent 50%),radial-gradient(circle at 50% 85%,rgba(79,70,229,.06),transparent 50%)}
    .learn-stage.visible{display:block;opacity:1}
    .learn-stage.entering{display:block;opacity:0}
    .learn-shell{height:100%;display:flex;flex-direction:column;padding:20px;position:relative;z-index:1}
    .learn-top{display:flex;justify-content:space-between;align-items:center;gap:12px;background:rgba(255,255,255,.95);backdrop-filter:blur(12px);border:1px solid var(--gray-200);border-radius:var(--radius-lg);box-shadow:var(--shadow-lg);padding:14px 20px}
    .learn-top-left{display:flex;align-items:center;gap:12px;min-width:0}
    .learn-top-left>div{min-width:0}
    .learn-title{font-size:1.05rem;font-weight:700;color:var(--gray-900);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .learn-sub{font-size:.82rem;color:var(--gray-500)}
    .learn-progress-bar{height:4px;background:var(--gray-200);border-radius:2px;flex:1;min-width:60px;max-width:200px}
    .learn-progress-fill{height:100%;background:linear-gradient(135deg,var(--primary) 0%,var(--secondary) 100%);border-radius:2px;transition:width .3s ease}
    .learn-progress-text{font-size:.78rem;font-weight:600;color:var(--gray-500);white-space:nowrap}
    .learn-progress-center{display:flex;align-items:center;gap:10px;flex:1;justify-content:center;min-width:0}
    .learn-body{flex:1;min-height:0;display:grid;place-items:center;padding:16px 0}
    .learn-card{width:min(1000px,100%);max-height:100%;background:rgba(255,255,255,.96);border:1px solid var(--gray-200);border-radius:var(--radius-xl);box-shadow:var(--shadow-xl);padding:24px;display:flex;flex-direction:column;gap:16px;overflow-y:auto}

    /* No learn tabs in focused mode — they are hidden */
    .learn-mode-label{font-size:.82rem;font-weight:700;color:var(--gray-500);text-transform:uppercase;letter-spacing:.05em;text-align:center;margin-bottom:4px}

    .learn-pane{display:none;min-height:0}
    .learn-pane.active{display:block;animation:fadeIn .25s ease-out}
    .learn-notes{border:1px solid var(--gray-200);border-radius:var(--radius-md);background:var(--gray-50);padding:20px;max-height:60vh;overflow-y:auto;font-size:.95rem;line-height:1.75}
    .learn-notes h1,.learn-notes h2,.learn-notes h3{margin-top:20px;margin-bottom:10px;color:var(--gray-900)}

    /* ── 3D Flashcard with slide transitions ── */
    .flashcard-stage{display:flex;flex-direction:column;align-items:center;gap:14px}
    .flashcard-3d{width:min(100%,860px);height:340px;perspective:1200px;cursor:pointer;position:relative;overflow:hidden}
    .flashcard-inner{position:relative;width:100%;height:100%;transform-style:preserve-3d;transition:transform .55s ease}
    .flashcard-inner.flipped{transform:rotateY(180deg)}
    .flashcard-inner.slide-left{animation:slideLeft .3s ease-out}
    .flashcard-inner.slide-right{animation:slideRight .3s ease-out}
    .flashcard-face{position:absolute;inset:0;backface-visibility:hidden;border-radius:var(--radius-lg);border:1px solid var(--gray-200);background:linear-gradient(135deg,rgba(79,70,229,.06) 0%,rgba(14,165,233,.08) 100%);box-shadow:var(--shadow-md);display:flex;align-items:center;justify-content:center;padding:30px;text-align:center}
    .flashcard-face.back{transform:rotateY(180deg);background:linear-gradient(135deg,rgba(14,165,233,.08) 0%,rgba(79,70,229,.06) 100%)}
    .flashcard-label{position:absolute;top:16px;left:16px;font-size:.7rem;color:var(--gray-400);font-weight:700;text-transform:uppercase;letter-spacing:.06em}
    .flashcard-text{font-size:1.15rem;color:var(--gray-900);line-height:1.65;white-space:pre-wrap;max-height:260px;overflow-y:auto}
    .learn-controls{display:flex;justify-content:center;align-items:center;flex-wrap:wrap;gap:10px}
    .learn-progress-fc{font-size:.85rem;color:var(--gray-500);min-width:120px;text-align:center;font-weight:500}
    .keyboard-hints{display:flex;gap:12px;justify-content:center;flex-wrap:wrap;font-size:.75rem;color:var(--gray-400)}
    .keyboard-hints span{display:inline-flex;align-items:center;gap:4px}
    .kbd{display:inline-flex;align-items:center;justify-content:center;min-width:22px;height:20px;padding:0 5px;background:var(--gray-100);border:1px solid var(--gray-300);border-radius:4px;font-size:.68rem;font-weight:700;color:var(--gray-600)}

    @keyframes slideLeft{0%{opacity:1;transform:translateX(0)}40%{opacity:0;transform:translateX(-40px)}41%{opacity:0;transform:translateX(40px)}100%{opacity:1;transform:translateX(0)}}
    @keyframes slideRight{0%{opacity:1;transform:translateX(0)}40%{opacity:0;transform:translateX(40px)}41%{opacity:0;transform:translateX(-40px)}100%{opacity:1;transform:translateX(0)}}
    @media(prefers-reduced-motion:reduce){.flashcard-inner.slide-left,.flashcard-inner.slide-right{animation:none}.flashcard-inner{transition:none}}

    /* ── Quiz ── */
    .quiz-head{display:flex;justify-content:space-between;align-items:center;gap:10px;margin-bottom:10px;font-size:.9rem;font-weight:600;color:var(--gray-700)}
    .quiz-question{font-size:1.1rem;font-weight:700;margin-bottom:14px;color:var(--gray-900);line-height:1.5}
    .quiz-options{display:grid;gap:10px}
    .quiz-option{width:100%;text-align:left;border:1px solid var(--gray-300);background:var(--white);border-radius:var(--radius);padding:14px 18px;font-size:.9375rem;color:var(--gray-800);cursor:pointer;transition:all .2s ease}
    .quiz-option:hover:not(:disabled){border-color:var(--primary-light);background:var(--gray-50);transform:translateY(-1px)}
    .quiz-option.correct{border-color:var(--success);background:rgba(16,185,129,.12);color:#065F46;transform:none}
    .quiz-option.wrong{border-color:var(--error);background:rgba(239,68,68,.12);color:#991B1B;transform:none}
    .quiz-option:disabled{cursor:default;transform:none}
    .quiz-expl{margin-top:10px;border:1px solid rgba(14,165,233,.2);border-radius:var(--radius);background:rgba(14,165,233,.06);padding:14px 18px;font-size:.9rem;color:var(--gray-700);line-height:1.5;display:none}
    .quiz-expl.visible{display:block;animation:fadeSlideIn .25s ease-out}

    /* ── Write mode ── */
    .write-stage{display:flex;flex-direction:column;align-items:center;gap:16px;width:100%}
    .write-prompt{font-size:1.15rem;font-weight:700;color:var(--gray-900);text-align:center;padding:24px;border:1px solid var(--gray-200);border-radius:var(--radius-lg);background:linear-gradient(135deg,rgba(79,70,229,.06) 0%,rgba(14,165,233,.08) 100%);width:100%;min-height:100px;display:flex;align-items:center;justify-content:center}
    .write-input-row{display:flex;gap:8px;width:100%;max-width:600px}
    .write-input{flex:1;border:2px solid var(--gray-300);border-radius:var(--radius);padding:14px 16px;font-size:1rem;color:var(--gray-900);transition:border-color .2s ease}
    .write-input:focus{outline:none;border-color:var(--primary);box-shadow:0 0 0 3px rgba(79,70,229,.1)}
    .write-input.correct-input{border-color:var(--success);background:rgba(16,185,129,.06)}
    .write-input.wrong-input{border-color:var(--error);background:rgba(239,68,68,.06)}
    .write-feedback{text-align:center;font-size:.9rem;padding:12px 16px;border-radius:var(--radius);width:100%;max-width:600px;display:none}
    .write-feedback.visible{display:block;animation:fadeSlideIn .25s ease-out}
    .write-feedback.correct-fb{background:rgba(16,185,129,.1);border:1px solid rgba(16,185,129,.3);color:#065F46}
    .write-feedback.wrong-fb{background:rgba(239,68,68,.1);border:1px solid rgba(239,68,68,.3);color:#991B1B}

    /* ── Match mode ── */
    .match-stage{display:flex;flex-direction:column;align-items:center;gap:16px;width:100%}
    .match-timer{font-size:1.5rem;font-weight:800;color:var(--gray-900);font-variant-numeric:tabular-nums}
    .match-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;width:100%}
    @media(max-width:600px){.match-grid{grid-template-columns:repeat(3,1fr);gap:8px}}
    .match-cell{border:2px solid var(--gray-200);border-radius:var(--radius-md);padding:14px 8px;text-align:center;font-size:.85rem;font-weight:600;color:var(--gray-800);cursor:pointer;transition:all .2s ease;min-height:60px;display:flex;align-items:center;justify-content:center;word-break:break-word;background:var(--white)}
    .match-cell:hover:not(.matched):not(.selected){border-color:var(--gray-400);background:var(--gray-50);transform:translateY(-1px)}
    .match-cell.selected{border-color:var(--primary);background:rgba(79,70,229,.08);box-shadow:0 0 0 3px rgba(79,70,229,.12)}
    .match-cell.matched{border-color:var(--success);background:rgba(16,185,129,.1);color:#065F46;cursor:default;opacity:.7}
    .match-cell.wrong-flash{border-color:var(--error);background:rgba(239,68,68,.12);animation:shake .4s ease}
    .match-results{text-align:center;padding:20px;border:1px solid var(--gray-200);border-radius:var(--radius-md);background:var(--gray-50);width:100%}
    .match-results-time{font-size:2rem;font-weight:800;color:var(--gray-900)}
    .match-results-badge{font-size:1rem;font-weight:700;margin-top:8px}
    .match-results-badge.gold{color:#F59E0B}
    .match-results-badge.silver{color:var(--gray-500)}
    .match-results-badge.bronze{color:#B45309}
    .match-results-history{margin-top:12px;font-size:.82rem;color:var(--gray-500)}

    @keyframes shake{0%,100%{transform:translateX(0)}20%{transform:translateX(-6px)}40%{transform:translateX(6px)}60%{transform:translateX(-4px)}80%{transform:translateX(4px)}}

    /* ── Fullscreen Builder ── */
    .builder-overlay{position:fixed;inset:0;z-index:290;display:none;opacity:0;transition:opacity .28s ease;background:linear-gradient(135deg,rgba(17,24,39,.44),rgba(31,41,55,.42))}
    .builder-overlay.visible{display:block;opacity:1}
    .builder-overlay.entering{display:block;opacity:0}
    .builder-shell{height:100%;display:grid;grid-template-columns:320px 1fr;gap:0;background:linear-gradient(180deg,var(--gray-50),#eef3ff)}
    .builder-rail{border-right:1px solid var(--gray-200);background:linear-gradient(180deg,#ffffff,#f7f9ff);padding:22px 18px 18px;overflow-y:auto}
    .builder-brand{margin-bottom:14px}
    .builder-brand h2{font-size:1.48rem;line-height:1.15;letter-spacing:-.03em;color:var(--gray-900)}
    .builder-brand p{font-size:.8rem;color:var(--gray-500);margin-top:5px}
    .builder-top-actions{display:grid;grid-template-columns:1fr;gap:8px;margin-bottom:12px}
    .builder-duo{display:grid;grid-template-columns:1fr 1fr;gap:8px}
    .builder-nav{display:flex;flex-direction:column;gap:8px;margin:14px 0 16px}
    .builder-nav-btn{width:100%;display:flex;align-items:center;gap:8px;border:1px solid var(--gray-300);background:var(--white);border-radius:var(--radius-md);padding:10px 12px;font-size:.86rem;font-weight:700;color:var(--gray-700);cursor:pointer;transition:all .2s ease}
    .builder-nav-btn:hover{border-color:var(--primary-light);box-shadow:var(--shadow-sm)}
    .builder-nav-btn.active{background:linear-gradient(135deg,rgba(79,70,229,.08),rgba(14,165,233,.08));border-color:rgba(79,70,229,.4);color:var(--gray-900);box-shadow:0 0 0 2px rgba(79,70,229,.13)}
    .builder-nav-btn svg{width:16px;height:16px}
    .builder-mini-stats{display:grid;gap:8px;margin-top:10px}
    .builder-stat{padding:9px 10px;border-radius:var(--radius);background:var(--gray-100);font-size:.78rem;color:var(--gray-600)}
    .builder-stat strong{color:var(--gray-900)}
    .builder-main{padding:22px 26px;overflow-y:auto;position:relative}
    .builder-main::before{content:'';position:absolute;inset:0;pointer-events:none;background:radial-gradient(circle at 85% 18%,rgba(79,70,229,.08),transparent 42%),radial-gradient(circle at 20% 85%,rgba(14,165,233,.08),transparent 46%)}
    .builder-main-inner{position:relative;z-index:1}
    .builder-headline{display:flex;justify-content:space-between;align-items:center;gap:12px;margin-bottom:16px}
    .builder-title{font-size:1.2rem;font-weight:800;color:var(--gray-900)}
    .builder-sub{font-size:.85rem;color:var(--gray-500)}
    .builder-pane{display:none}
    .builder-pane.active{display:block;animation:fadeIn .2s ease-out}
    .builder-card{background:rgba(255,255,255,.95);border:1px solid var(--gray-200);border-radius:18px;padding:18px;box-shadow:var(--shadow-lg)}
    .builder-grid{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:12px}
    .builder-grid-3{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:12px}
    .builder-list{display:flex;flex-direction:column;gap:12px;max-height:64vh;overflow-y:auto;padding-right:3px}
    .builder-list-empty{padding:22px;border:1px dashed var(--gray-300);border-radius:var(--radius-md);background:var(--gray-50);text-align:center;color:var(--gray-500)}
    .builder-row{border:1px solid var(--gray-200);border-radius:14px;padding:14px;background:var(--white);box-shadow:var(--shadow-sm)}
    .builder-row-head{display:flex;justify-content:space-between;align-items:center;gap:8px;margin-bottom:9px}
    .builder-row-title{font-size:.78rem;letter-spacing:.05em;text-transform:uppercase;font-weight:700;color:var(--gray-500)}
    .builder-split{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .builder-cta-strip{display:flex;flex-wrap:wrap;gap:8px;margin-bottom:10px}
    .builder-info-banner{display:flex;justify-content:space-between;align-items:center;gap:10px;padding:12px 14px;border:1px solid rgba(79,70,229,.22);background:linear-gradient(135deg,rgba(79,70,229,.08),rgba(14,165,233,.08));border-radius:12px;margin-bottom:12px}
    .builder-info-banner span{font-size:.82rem;color:var(--gray-700);font-weight:600}
    .builder-drop{border:2px dashed rgba(55,65,81,.34);border-radius:16px;padding:28px 16px;text-align:center;background:rgba(255,255,255,.8);transition:all .2s ease;cursor:pointer}
    .builder-drop:hover{border-color:rgba(79,70,229,.6);background:rgba(79,70,229,.04)}
    .builder-drop.dragover{border-color:var(--primary);background:rgba(79,70,229,.08);box-shadow:0 0 0 3px rgba(79,70,229,.14)}
    .builder-import-tools{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin:12px 0}
    .builder-preview{margin-top:12px;border:1px solid var(--gray-200);border-radius:12px;background:#fff;overflow:hidden}
    .builder-preview-head{padding:10px 12px;font-size:.8rem;font-weight:700;color:var(--gray-600);background:var(--gray-50);border-bottom:1px solid var(--gray-200)}
    .builder-preview-table{width:100%;border-collapse:collapse;font-size:.82rem}
    .builder-preview-table th,.builder-preview-table td{padding:8px 10px;border-bottom:1px solid var(--gray-100);text-align:left;vertical-align:top}
    .builder-preview-table th{font-size:.74rem;text-transform:uppercase;letter-spacing:.04em;color:var(--gray-500)}
    .builder-errors{margin-top:10px;max-height:160px;overflow-y:auto;padding:10px;border-radius:10px;background:rgba(239,68,68,.08);border:1px solid rgba(239,68,68,.22);font-size:.78rem;color:#991B1B}
    .builder-helper{font-size:.8rem;color:var(--gray-500)}
    .builder-select{width:100%;border:1px solid var(--gray-300);border-radius:var(--radius);padding:10px 12px;background:#fff;font-size:.88rem;color:var(--gray-800)}
    .builder-select:focus{outline:none;border-color:var(--primary);box-shadow:0 0 0 3px rgba(79,70,229,.1)}
    .builder-exit-modal .modal{max-width:520px}
    .builder-exit-icon{width:72px;height:72px;border-radius:50%;margin:2px auto 10px;display:grid;place-items:center;color:var(--primary);background:linear-gradient(135deg,rgba(79,70,229,.12),rgba(14,165,233,.12));border:1px solid rgba(79,70,229,.2)}
    .builder-exit-icon svg{width:34px;height:34px}

    /* ── Modals ── */
    .modal-overlay{position:fixed;inset:0;z-index:260;background:rgba(0,0,0,.5);display:none;align-items:center;justify-content:center;padding:18px;opacity:0;transition:opacity .25s ease}
    .modal-overlay.visible{display:flex;opacity:1}
    .modal-overlay.entering{display:flex;opacity:0}
    .modal{width:min(560px,100%);background:var(--white);border:1px solid var(--gray-200);border-radius:var(--radius-xl);box-shadow:var(--shadow-xl);padding:24px;transform:scale(.95);opacity:0;transition:all .25s ease}
    .modal-overlay.visible .modal{transform:scale(1);opacity:1}
    .modal-head{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px}
    .modal-title{font-size:1.1rem;font-weight:700;color:var(--gray-900)}
    .modal-grid{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:10px}
    @media(max-width:620px){.modal-grid{grid-template-columns:1fr}}
    .modal-message{font-size:.92rem;color:var(--gray-700);margin-bottom:16px;line-height:1.5}

    .toast{position:fixed;bottom:24px;left:50%;transform:translateX(-50%) translateY(100px);background:var(--gray-900);color:var(--white);border-radius:var(--radius-md);padding:14px 24px;font-size:.9375rem;font-weight:500;box-shadow:var(--shadow-xl);opacity:0;transition:all .3s ease;z-index:500;display:flex;align-items:center;gap:10px;max-width:calc(100vw - 48px)}
    .toast.visible{transform:translateX(-50%) translateY(0);opacity:1}
    .toast.success{background:var(--success)}
    .toast.error{background:var(--error)}

    @keyframes dropdownOpen{from{opacity:0;transform:translateY(-8px)}to{opacity:1;transform:translateY(0)}}
    @keyframes fadeIn{from{opacity:0}to{opacity:1}}
    @keyframes fadeSlideIn{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}
    @keyframes highlightPulse{0%{box-shadow:0 0 0 0 rgba(16,185,129,.35)}100%{box-shadow:0 0 0 3px rgba(16,185,129,.12)}}

    @media(max-width:600px){
      .container{padding:10px}
      .topbar{padding:10px 14px;flex-direction:column;align-items:stretch;gap:10px;position:static;border-radius:var(--radius-md)}
      .topbar .actions{justify-content:flex-end}
      .topbar-sub{max-width:100%}
      .panel{border-radius:var(--radius-lg)}
      .panel-head{padding:12px 14px}
      .panel-body{padding:12px 14px}
      .split{grid-template-columns:1fr;gap:12px}
      .meta-grid{grid-template-columns:1fr}
      .learn-shell{padding:10px}
      .learn-top{flex-direction:column;align-items:stretch;gap:10px;padding:12px 14px;border-radius:var(--radius-md)}
      .learn-top .actions{justify-content:flex-end}
      .learn-progress-center{justify-content:flex-start}
      .learn-card{padding:14px;border-radius:var(--radius-lg)}
      .flashcard-3d{height:260px}
      .algo-slot{width:68px;height:82px;font-size:.68rem}
      .algo-slot svg{width:20px;height:20px}
      .algo-chevron svg{width:12px;height:12px}
      .algo-lane{gap:4px}
      .lesson-grid{grid-template-columns:1fr}
      .lesson-card{padding:14px}
      .setup-modal{padding:18px}
      .setup-tabs{flex-wrap:wrap}
      .setup-tab{padding:8px 4px;font-size:.72rem}
      .setup-tab svg{width:12px;height:12px}
      .btn{padding:8px 10px;font-size:.8rem}
      .btn.cta{padding:12px 20px;font-size:.92rem}
      .keyboard-hints{display:none}
      .editor-tab{font-size:.75rem;padding:8px 6px;gap:4px}
      .editor-tab svg{width:13px;height:13px}
      .match-grid{grid-template-columns:repeat(3,1fr)}
      .builder-shell{grid-template-columns:1fr}
      .builder-rail{border-right:none;border-bottom:1px solid var(--gray-200)}
      .builder-main{padding:14px}
      .builder-grid,.builder-grid-3,.builder-split,.builder-import-tools{grid-template-columns:1fr}
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="topbar">
      <div class="topbar-logo">
        <div class="topbar-logo-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"></path><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"></path></svg></div>
        <div><h1>Study Library</h1><div class="topbar-sub" id="user-meta">Checking sign-in...</div></div>
      </div>
      <div class="actions">
        <button class="btn" id="back-app-btn"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 5 12 12 5"></polyline></svg>Back to App</button>
        <button class="btn" id="fullscreen-btn"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 3 21 3 21 9"></polyline><polyline points="9 21 3 21 3 15"></polyline><line x1="21" y1="3" x2="14" y2="10"></line><line x1="3" y1="21" x2="10" y2="14"></line></svg>Fullscreen Learn</button>
        <button class="btn primary" id="auth-btn">Sign in</button>
      </div>
    </div>

    <div class="grid" id="library-grid">
      <aside class="panel">
        <div class="panel-head"><span class="panel-title">Folders</span><div class="actions"><button class="btn" id="new-folder-btn">+ Folder</button><button class="btn danger" id="delete-folder-btn">Delete</button></div></div>
        <div class="panel-body">
          <div class="field search-box"><label>Search</label><input id="search-input" placeholder="Filter packs by title, course or subject"></div>
          <div class="list" id="folder-list"></div>
        </div>
      </aside>
      <section class="panel">
        <div class="panel-head"><span class="panel-title">Study Packs</span><div class="actions"><button class="btn primary" id="create-pack-btn"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>Manually Create Study Pack</button><button class="btn" id="save-pack-btn">Save Changes</button><button class="btn danger" id="delete-pack-btn">Delete Pack</button></div></div>
        <div class="panel-body">
          <div class="pack-summary" id="pack-summary">
            <div class="pack-summary-title" id="pack-summary-title"></div>
            <div class="pack-summary-meta" id="pack-summary-meta"></div>
            <div class="pack-summary-stats">
              <div class="pack-stat"><div class="pack-stat-icon notes-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline></svg></div><span id="pack-stat-notes">Notes</span></div>
              <div class="pack-stat"><div class="pack-stat-icon cards-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="4" width="20" height="16" rx="2"></rect><line x1="2" y1="12" x2="22" y2="12"></line></svg></div><span id="pack-stat-cards">0 flashcards</span></div>
              <div class="pack-stat"><div class="pack-stat-icon test-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"></path><rect x="8" y="2" width="8" height="4" rx="1" ry="1"></rect></svg></div><span id="pack-stat-test">0 questions</span></div>
            </div>
          </div>
          <div class="split">
            <div><div class="list" id="pack-list"></div></div>
            <div>
              <div class="empty" id="pack-empty">Select a study pack to edit and study.</div>
              <div class="editor-wrap" id="pack-editor-wrap">
                <div class="meta-grid">
                  <div class="field"><label>Title</label><input id="pack-title"></div>
                  <div class="field"><label>Folder</label><input type="hidden" id="pack-folder-select" value=""><div class="app-select" id="pack-folder-picker"><button type="button" class="app-select-button" id="pack-folder-button"><span class="app-select-label" id="pack-folder-label">No folder</span><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"></polyline></svg></button><div class="app-select-menu" id="pack-folder-menu"></div></div></div>
                  <div class="field"><label>Course</label><input id="pack-course"></div>
                  <div class="field"><label>Subject</label><input id="pack-subject"></div>
                  <div class="field"><label>Semester</label><input id="pack-semester"></div>
                  <div class="field"><label>Block</label><input id="pack-block"></div>
                </div>
                <div class="actions" style="margin-bottom:14px;">
                  <button class="btn" id="open-builder-btn"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 3h7v7H3z"></path><path d="M14 3h7v7h-7z"></path><path d="M14 14h7v7h-7z"></path><path d="M3 14h7v7H3z"></path></svg>Open Full Editor</button>
                  <button class="btn" id="export-pack-csv-btn"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg><span id="export-csv-label">Export Flashcards CSV</span></button>
                  <button class="btn primary" id="open-learn-btn"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="5 3 19 12 5 21 5 3"></polygon></svg>Learn Mode</button>
                </div>
                <div class="editor-tabs">
                  <button class="editor-tab active" data-editor-pane="notes"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline></svg>Notes</button>
                  <button class="editor-tab" data-editor-pane="flashcards"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="4" width="20" height="16" rx="2"></rect><line x1="2" y1="12" x2="22" y2="12"></line></svg>Flashcards</button>
                  <button class="editor-tab" data-editor-pane="test"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"></path><rect x="8" y="2" width="8" height="4" rx="1" ry="1"></rect></svg>Practice Test</button>
                </div>
                <div class="editor-pane active" id="editor-pane-notes"><div class="notes-view" id="notes-view"></div></div>
                <div class="editor-pane" id="editor-pane-flashcards"><div class="editor-toolbar"><span class="editor-count" id="flashcard-count">0 flashcards</span><button class="btn" id="add-flashcard-btn">+ Add flashcard</button></div><div class="editor-list" id="flashcard-editor-list"></div></div>
                <div class="editor-pane" id="editor-pane-test"><div class="editor-toolbar"><span class="editor-count" id="question-count">0 practice questions</span><button class="btn" id="add-question-btn">+ Add question</button></div><div class="editor-list" id="question-editor-list"></div></div>
              </div>
            </div>
          </div>
        </div>
      </section>
    </div>
  </div>

  <!-- Session Setup -->
  <div class="setup-overlay" id="setup-overlay"><div class="setup-modal">
    <div class="setup-header"><div><div class="setup-title">Session Setup</div><div class="setup-pack-name" id="setup-pack-name"></div></div><button class="btn" id="setup-close-btn"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg></button></div>

    <!-- Setup tabs + panes (hidden when mode picker is shown) -->
    <div id="setup-main-content">
      <div class="setup-tabs" id="setup-tabs">
        <button class="setup-tab active" data-setup-pane="mastery"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M6 9H4.5a2.5 2.5 0 0 1 0-5C5.7 4 7 4.8 8 6c1-1.2 2.3-2 3.5-2a2.5 2.5 0 0 1 0 5H10"></path><path d="M6 9l6 6 6-6"></path></svg>Mastery</button>
        <button class="setup-tab" data-setup-pane="lessons"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="4" width="20" height="16" rx="2"></rect><line x1="2" y1="12" x2="22" y2="12"></line></svg>Lessons</button>
        <button class="setup-tab" data-setup-pane="settings"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-4 0v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83-2.83l.06-.06A1.65 1.65 0 0 0 4.68 15a1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1 0-4h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 2.83-2.83l.06.06A1.65 1.65 0 0 0 9 4.68a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9c.26.6.77 1.05 1.37 1.22H21a2 2 0 0 1 0 4h-.09c-.6.17-1.11.62-1.37 1.22z"></path></svg>Settings</button>
        <button class="setup-tab" data-setup-pane="algorithm"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"></polyline></svg>Algorithm</button>
      </div>
      <div class="setup-pane active" id="setup-pane-mastery"><div class="mastery-section"><div class="mastery-stat"><span>Cards seen:</span> <strong id="mastery-seen">0</strong> / <strong id="mastery-total">0</strong></div><div class="mastery-rings"><div class="mastery-ring"><div class="mastery-ring-circle new-ring" id="mastery-new-pct">100%</div><span class="mastery-ring-label">New</span></div><div class="mastery-ring"><div class="mastery-ring-circle familiar-ring" id="mastery-familiar-pct">0%</div><span class="mastery-ring-label">Familiar</span></div><div class="mastery-ring"><div class="mastery-ring-circle mastered-ring" id="mastery-mastered-pct">0%</div><span class="mastery-ring-label">Mastered</span></div></div></div></div>
      <div class="setup-pane" id="setup-pane-lessons"><p style="text-align:center;color:var(--gray-600);font-size:.9rem;margin-bottom:16px;">Choose which lesson types to include:</p><div class="lesson-grid" id="lesson-grid">
        <div class="lesson-card selected" data-lesson="flashcards" id="lesson-card-flashcards"><div class="lesson-card-check"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg></div><div class="lesson-card-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="4" width="20" height="16" rx="2"></rect><line x1="2" y1="12" x2="22" y2="12"></line></svg></div><div class="lesson-card-title">Zen Cards</div><div class="lesson-card-desc">Distraction-free flashcards</div></div>
        <div class="lesson-card selected" data-lesson="test" id="lesson-card-test"><div class="lesson-card-check"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg></div><div class="lesson-card-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M9 11l3 3L22 4"></path><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"></path></svg></div><div class="lesson-card-title">Multiple Choice</div><div class="lesson-card-desc">Choose your answer from options</div></div>
        <div class="lesson-card" data-lesson="write" id="lesson-card-write"><div class="lesson-card-check"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg></div><div class="lesson-card-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M12 20h9"></path><path d="M16.5 3.5a2.12 2.12 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"></path></svg></div><div class="lesson-card-title">Write</div><div class="lesson-card-desc">Type answers from memory</div></div>
        <div class="lesson-card" data-lesson="match" id="lesson-card-match"><div class="lesson-card-check"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg></div><div class="lesson-card-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="7" height="7"></rect><rect x="14" y="3" width="7" height="7"></rect><rect x="3" y="14" width="7" height="7"></rect><rect x="14" y="14" width="7" height="7"></rect></svg></div><div class="lesson-card-title">Match</div><div class="lesson-card-desc">Pair terms with definitions</div><div class="lesson-card-badge" id="match-min-badge" style="display:none">Needs 6+ cards</div></div>
      </div></div>
      <div class="setup-pane" id="setup-pane-settings"><div class="settings-list" id="settings-list">
        <div class="setting-row" data-setting="swapAnswerQuestion"><span class="setting-label">Swap answer and question</span><div class="setting-toggle"></div></div>
        <div class="setting-row" data-setting="randomSwap"><span class="setting-label">Randomly swap answer and question</span><div class="setting-toggle"></div></div>
        <div class="setting-row" data-setting="caseSensitive"><span class="setting-label">Case sensitive</span><div class="setting-toggle"></div></div>
        <div class="setting-row" data-setting="forceExactMatch"><span class="setting-label">Force exact matches</span><div class="setting-toggle"></div></div>
        <div class="setting-row active" data-setting="addMissedToReview"><span class="setting-label">Add missed terms to review list</span><div class="setting-toggle"></div></div>
        <div class="setting-row" data-setting="ignoreArticles"><span class="setting-label">Ignore articles (a, an, the)</span><div class="setting-toggle"></div></div>
        <div class="setting-row" data-setting="ignoreDeterminers"><span class="setting-label">Ignore determiners (; , /)</span><div class="setting-toggle"></div></div>
        <div class="setting-row" data-setting="ignoreBrackets"><span class="setting-label">Ignore () and []</span><div class="setting-toggle"></div></div>
      </div></div>
      <div class="setup-pane" id="setup-pane-algorithm"><p style="text-align:center;color:var(--gray-600);font-size:.9rem;margin-bottom:16px;">Adjust how cards are selected for review:</p><div class="algo-lane" id="algo-lane"></div><div class="algo-presets" id="algo-presets"><button class="algo-preset active" data-preset="balanced">Balanced</button><button class="algo-preset" data-preset="random">All Random</button><button class="algo-preset" data-preset="lastminute">Last Minute Overview</button><button class="algo-preset" data-preset="fixmistakes">Fix Mistakes</button></div></div>
      <button class="btn cta" id="setup-start-btn" style="margin-top:8px;"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="5 3 19 12 5 21 5 3"></polygon></svg>Start Session</button>
    </div>

    <!-- Mode picker (shown when multiple lessons enabled) -->
    <div class="mode-picker" id="mode-picker">
      <div class="mode-picker-title">Choose your study mode</div>
      <div class="mode-picker-grid" id="mode-picker-grid"></div>
      <div class="actions" style="justify-content:center;margin-top:16px;">
        <button class="btn" id="mode-picker-back"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 5 12 12 5"></polyline></svg>Back to Setup</button>
      </div>
    </div>
  </div></div>

  <!-- Learn Stage (focused single-mode) -->
  <div class="learn-stage" id="learn-stage"><div class="learn-shell">
    <div class="learn-top">
      <div class="learn-top-left"><div><div class="learn-title" id="learn-title">Learn Mode</div><div class="learn-sub" id="learn-sub">Focused study session</div></div></div>
      <div class="learn-progress-center"><div class="learn-progress-bar"><div class="learn-progress-fill" id="learn-progress-fill" style="width:0%"></div></div><span class="learn-progress-text" id="learn-progress-text">0/0</span></div>
      <div class="actions">
        <button class="btn" id="learn-back-app-btn"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 5 12 12 5"></polyline></svg>App</button>
        <button class="btn" id="learn-back-library-btn"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"></path><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"></path></svg>Library</button>
        <button class="btn" id="learn-fullscreen-btn"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 3 21 3 21 9"></polyline><polyline points="9 21 3 21 3 15"></polyline><line x1="21" y1="3" x2="14" y2="10"></line><line x1="3" y1="21" x2="10" y2="14"></line></svg></button>
      </div>
    </div>
    <div class="learn-body"><div class="learn-card">
      <div class="learn-mode-label" id="learn-mode-label"></div>

      <!-- Flashcards pane -->
      <div class="learn-pane" id="learn-pane-flashcards"><div class="flashcard-stage"><div class="flashcard-3d" id="learn-flashcard-3d"><div class="flashcard-inner" id="learn-flashcard-inner"><div class="flashcard-face front"><span class="flashcard-label">Front</span><div class="flashcard-text" id="learn-flashcard-front"></div></div><div class="flashcard-face back"><span class="flashcard-label">Back</span><div class="flashcard-text" id="learn-flashcard-back"></div></div></div></div><div class="learn-controls"><button class="btn" id="learn-f-prev">Previous</button><button class="btn" id="learn-f-flip">Flip</button><button class="btn" id="learn-f-next">Next</button><span class="learn-progress-fc" id="learn-f-progress">Card 0 of 0</span></div><div class="keyboard-hints"><span><span class="kbd">&larr;</span> Previous</span><span><span class="kbd">Space</span> Flip</span><span><span class="kbd">&rarr;</span> Next</span></div></div></div>

      <!-- Test pane -->
      <div class="learn-pane" id="learn-pane-test"><div class="quiz-head"><span id="learn-q-progress">Question 0 of 0</span><span id="learn-q-score">Score: 0/0</span></div><div class="quiz-question" id="learn-q-text"></div><div class="quiz-options" id="learn-q-options"></div><div class="quiz-expl" id="learn-q-expl"></div><div class="actions" style="margin-top:12px;"><button class="btn primary" id="learn-q-next">Next question</button></div></div>

      <!-- Write pane -->
      <div class="learn-pane" id="learn-pane-write"><div class="write-stage">
        <div class="write-prompt" id="write-prompt"></div>
        <div class="write-input-row"><input type="text" class="write-input" id="write-input" placeholder="Type your answer..." autocomplete="off"><button class="btn primary" id="write-check-btn">Check</button><button class="btn" id="write-reveal-btn">Reveal</button></div>
        <div class="write-feedback" id="write-feedback"></div>
        <div class="learn-controls"><button class="btn primary" id="write-next-btn">Next</button><span class="learn-progress-fc" id="write-progress">0 / 0</span></div>
      </div></div>

      <!-- Match pane -->
      <div class="learn-pane" id="learn-pane-match"><div class="match-stage">
        <div class="match-timer" id="match-timer">0.0s</div>
        <div class="match-grid" id="match-grid"></div>
        <div class="match-results" id="match-results" style="display:none">
          <div class="match-results-time" id="match-results-time"></div>
          <div class="match-results-badge" id="match-results-badge"></div>
          <div class="match-results-history" id="match-results-history"></div>
          <div class="actions" style="justify-content:center;margin-top:16px;"><button class="btn primary" id="match-play-again">Play Again</button></div>
        </div>
      </div></div>

      <!-- Notes pane (fallback) -->
      <div class="learn-pane" id="learn-pane-notes"><div class="learn-notes" id="learn-notes-content"></div></div>
    </div></div>
  </div></div>

  <!-- Fullscreen Pack Builder -->
  <div class="builder-overlay" id="builder-overlay">
    <div class="builder-shell">
      <aside class="builder-rail">
        <div class="builder-brand"><h2>Study Library<br>Pack Builder</h2><p id="builder-brand-sub">Create and refine your study pack</p></div>
        <div class="builder-top-actions">
          <button class="btn primary" id="builder-save-btn"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path><polyline points="17 21 17 13 7 13 7 21"></polyline><polyline points="7 3 7 8 15 8"></polyline></svg>Save Pack</button>
          <div class="builder-duo">
            <button class="btn" id="builder-exit-btn">Exit</button>
            <button class="btn" id="builder-share-btn" disabled>Share</button>
          </div>
        </div>
        <div class="builder-nav">
          <button class="builder-nav-btn active" data-builder-pane="info"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="16" x2="12" y2="12"></line><line x1="12" y1="8" x2="12.01" y2="8"></line></svg>Deck Info</button>
          <button class="builder-nav-btn" data-builder-pane="flashcards"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="4" width="20" height="16" rx="2"></rect><line x1="2" y1="12" x2="22" y2="12"></line></svg>Flashcards</button>
          <button class="builder-nav-btn" data-builder-pane="test"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 11l3 3L22 4"></path><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"></path></svg>Practice Test</button>
          <button class="builder-nav-btn" data-builder-pane="import"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" y1="3" x2="12" y2="15"></line></svg>Import CSV</button>
        </div>
        <div class="builder-mini-stats">
          <div class="builder-stat">Cards: <strong id="builder-stat-cards">0</strong></div>
          <div class="builder-stat">Questions: <strong id="builder-stat-questions">0</strong></div>
          <div class="builder-stat">Unsaved: <strong id="builder-stat-dirty">No</strong></div>
        </div>
      </aside>
      <main class="builder-main">
        <div class="builder-main-inner">
          <div class="builder-headline">
            <div><div class="builder-title" id="builder-title">Build Your Pack</div><div class="builder-sub" id="builder-sub">Fullscreen editing for fast manual creation</div></div>
            <div class="builder-helper" id="builder-summary">0 cards · 0 questions</div>
          </div>

          <section class="builder-pane active" id="builder-pane-info">
            <div class="builder-card">
              <div class="builder-info-banner"><span>Configure title, folder, metadata, and notes before learning.</span><button class="btn" id="builder-open-learn-shortcut">Open Learn Setup</button></div>
              <div class="builder-grid">
                <div class="field"><label>Title</label><input id="builder-title-input" placeholder="Untitled pack"></div>
                <div class="field"><label>Folder</label><select id="builder-folder-select" class="builder-select"></select></div>
                <div class="field"><label>Course</label><input id="builder-course-input"></div>
                <div class="field"><label>Subject</label><input id="builder-subject-input"></div>
                <div class="field"><label>Semester</label><input id="builder-semester-input"></div>
                <div class="field"><label>Block</label><input id="builder-block-input"></div>
              </div>
              <div class="field" style="margin-top:12px;"><label>Notes (Markdown)</label><textarea id="builder-notes-input" style="min-height:180px" placeholder="# Key Concepts&#10;&#10;- Add summary notes here"></textarea></div>
            </div>
          </section>

          <section class="builder-pane" id="builder-pane-flashcards">
            <div class="builder-card">
              <div class="builder-cta-strip"><button class="btn primary" id="builder-add-card-btn">+ Add Flashcard</button><button class="btn" id="builder-add-card-batch-btn">+ Add 5</button></div>
              <div class="builder-list" id="builder-flashcard-list"></div>
            </div>
          </section>

          <section class="builder-pane" id="builder-pane-test">
            <div class="builder-card">
              <div class="builder-cta-strip"><button class="btn primary" id="builder-add-question-btn">+ Add Question</button><button class="btn" id="builder-add-question-batch-btn">+ Add 3</button></div>
              <div class="builder-list" id="builder-question-list"></div>
            </div>
          </section>

          <section class="builder-pane" id="builder-pane-import">
            <div class="builder-card">
              <div class="builder-helper" style="margin-bottom:8px">Import data directly into this pack and preview before applying.</div>
              <div class="builder-import-tools">
                <div class="field"><label>Import Type</label><select class="builder-select" id="builder-import-type"><option value="flashcards">Flashcards CSV</option><option value="test">Practice Test CSV</option></select></div>
                <div class="field"><label>Import Mode</label><select class="builder-select" id="builder-import-mode"><option value="append">Append to existing</option><option value="replace">Replace existing</option></select></div>
              </div>
              <div class="builder-drop" id="builder-csv-drop"><strong>Drag a CSV file here</strong><div class="builder-helper">or click to browse</div><input type="file" id="builder-csv-input" accept=".csv,text/csv" style="display:none"></div>
              <div class="builder-cta-strip" style="margin-top:12px"><button class="btn" id="builder-template-btn">Download CSV Template</button><button class="btn primary" id="builder-apply-import-btn" disabled>Apply Import</button></div>
              <div class="builder-helper" id="builder-import-summary">No file loaded.</div>
              <div class="builder-preview" id="builder-preview" style="display:none">
                <div class="builder-preview-head">Preview (first 10 valid rows)</div>
                <div style="overflow:auto"><table class="builder-preview-table" id="builder-preview-table"></table></div>
              </div>
              <div class="builder-errors" id="builder-import-errors" style="display:none"></div>
            </div>
          </section>
        </div>
      </main>
    </div>
  </div>

  <!-- Builder unsaved exit modal -->
  <div class="modal-overlay builder-exit-modal" id="builder-exit-overlay">
    <div class="modal">
      <div class="builder-exit-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><path d="M9.09 9a3 3 0 0 1 5.82 1c0 2-3 3-3 3"></path><line x1="12" y1="17" x2="12.01" y2="17"></line></svg></div>
      <div class="modal-title" style="text-align:center;margin-bottom:6px">Save Changes?</div>
      <p class="modal-message" style="text-align:center">You have unsaved builder changes. Do you want to save before leaving?</p>
      <div class="actions" style="justify-content:center">
        <button class="btn primary" id="builder-exit-save">Save</button>
        <button class="btn danger" id="builder-exit-discard">Don't Save</button>
        <button class="btn" id="builder-exit-cancel">Cancel</button>
      </div>
    </div>
  </div>

  <!-- Folder Modal -->
  <div class="modal-overlay" id="folder-modal-overlay"><div class="modal"><div class="modal-head"><span class="modal-title" id="folder-modal-title">New Folder</span><button class="btn" id="folder-modal-close"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg></button></div><div class="modal-grid" style="margin-bottom:14px;"><div class="field"><label>Folder Name *</label><input id="folder-name-input"></div><div class="field"><label>Course</label><input id="folder-course-input"></div><div class="field"><label>Subject</label><input id="folder-subject-input"></div><div class="field"><label>Semester</label><input id="folder-semester-input"></div><div class="field"><label>Block</label><input id="folder-block-input"></div></div><div class="actions" style="justify-content:flex-end;"><button class="btn" id="folder-modal-cancel">Cancel</button><button class="btn primary" id="folder-modal-save">Save Folder</button></div></div></div>

  <!-- Confirm Modal -->
  <div class="modal-overlay" id="confirm-modal-overlay"><div class="modal"><div class="modal-head"><span class="modal-title" id="confirm-modal-title">Confirm Action</span><button class="btn" id="confirm-modal-close"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg></button></div><p class="modal-message" id="confirm-modal-message"></p><div class="actions" style="justify-content:flex-end;"><button class="btn" id="confirm-modal-cancel">Cancel</button><button class="btn danger" id="confirm-modal-confirm">Delete</button></div></div></div>

  <div class="toast" id="toast"></div>
<script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth-compat.js"></script>
  <script>
    const firebaseConfig={apiKey:"AIzaSyBAAeEUCPNvP5qnqpP3M6HnFZ6vaaijUvM",authDomain:"lecture-processor-cdff6.firebaseapp.com",projectId:"lecture-processor-cdff6",storageBucket:"lecture-processor-cdff6.firebasestorage.app",messagingSenderId:"374793454161",appId:"1:374793454161:web:c68b21590e9a1fafa32e70"};
    firebase.initializeApp(firebaseConfig);
    const auth=firebase.auth();

    /* ── State ── */
    let token=null,folders=[],packs=[],selectedFolderId='',selectedPackId='',selectedPack=null;
    let activeEditorPane='notes',exportType='flashcards',draggedPackId='';
    let folderModalMode='create',editingFolderId='',pendingOpenPackId='',confirmModalResolver=null;
    let builderDraft=null,builderMode='edit',builderPane='info',builderDirty=false,builderPackId='',builderExitResolver=null,builderImportParsed=null;
    let learnFlashcardIndex=0,learnFlashcardFlipped=false,learnQuestionIndex=0,learnScore=0,learnAnswered=false;
    let activeLearnMode=''; // 'flashcards','test','write','match','notes'
    let orderedFlashcards=[];
    const urlParams=new URLSearchParams(window.location.search);
    const learnPackFromUrl=urlParams.get('pack_id')||'';
    const openLearnFromUrl=urlParams.get('mode')==='learn';
    const fullscreenFromUrl=urlParams.get('fullscreen')==='1';
    const focusFromUrl=urlParams.get('focus')||'';
    let autoLearnConsumed=false;

    /* Write mode state */
    let writeIndex=0,writeRevealed=false,writeChecked=false,writePromptSwapped=false;

    /* Match mode state */
    let matchCards=[],matchSelected=null,matchMatched=0,matchTotal=0;
    let matchTimerInterval=null,matchStartTime=0,matchElapsed=0,matchRunning=false;
    const MATCH_MIN_CARDS=6;

    /* ── Session state ── */
    const ALGO_PRESETS={balanced:['new','new','familiar','retry','remaster'],random:['random','random','random','random','random'],lastminute:['new','new','new','new','retry'],fixmistakes:['new','retry','new','retry','retry']};
    const ALGO_TYPES=['new','familiar','retry','remaster','random'];
    const ALGO_ICONS={
      new:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="5" y="2" width="14" height="20" rx="2"></rect><line x1="12" y1="18" x2="12.01" y2="18"></line></svg>',
      familiar:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path></svg>',
      retry:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="23 4 23 10 17 10"></polyline><path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"></path></svg>',
      remaster:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 9H4.5a2.5 2.5 0 0 1 0-5C5.7 4 7 4.8 8 6c1-1.2 2.3-2 3.5-2a2.5 2.5 0 0 1 0 5H10"></path><path d="M6 9l6 6 6-6"></path></svg>',
      random:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="16 3 21 3 21 8"></polyline><line x1="4" y1="20" x2="21" y2="3"></line><polyline points="21 16 21 21 16 21"></polyline><line x1="15" y1="15" x2="21" y2="21"></line><line x1="4" y1="4" x2="9" y2="9"></line></svg>'
    };
    const MODE_ICONS={
      flashcards:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="4" width="20" height="16" rx="2"></rect><line x1="2" y1="12" x2="22" y2="12"></line></svg>',
      test:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M9 11l3 3L22 4"></path><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"></path></svg>',
      write:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M12 20h9"></path><path d="M16.5 3.5a2.12 2.12 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"></path></svg>',
      match:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="7" height="7"></rect><rect x="14" y="3" width="7" height="7"></rect><rect x="3" y="14" width="7" height="7"></rect><rect x="14" y="14" width="7" height="7"></rect></svg>'
    };
    const MODE_NAMES={flashcards:'Zen Cards',test:'Multiple Choice',write:'Write',match:'Match'};
    const MODE_DESCS={flashcards:'Flip through cards at your pace',test:'Answer multiple choice questions',write:'Type answers from memory',match:'Pair terms with definitions'};

    let sessionSettings={swapAnswerQuestion:false,randomSwap:false,caseSensitive:false,forceExactMatch:false,addMissedToReview:true,ignoreArticles:false,ignoreDeterminers:false,ignoreBrackets:false};
    let sessionAlgo=['new','new','familiar','retry','remaster'],sessionAlgoPreset='balanced';
    let sessionLessons={flashcards:true,test:true,write:false,match:false};
    let activeSetupPane='mastery';

    /* ── Card mastery (localStorage) ── */
    function getCardStateKey(){return'card_state_'+(auth.currentUser?auth.currentUser.uid:'anon')+'_'+selectedPackId;}
    function loadCardState(){try{return JSON.parse(localStorage.getItem(getCardStateKey()))||{};}catch(e){return{};}}
    function saveCardState(s){try{localStorage.setItem(getCardStateKey(),JSON.stringify(s));}catch(e){}}
    function markCardSeen(cardId,correct){
      var s=loadCardState();
      if(!s[cardId]){s[cardId]={seen:0,correct:0,wrong:0,level:'new'};}
      s[cardId].seen++;
      if(correct){s[cardId].correct++;}else{s[cardId].wrong++;}
      if(s[cardId].correct>=3){s[cardId].level='mastered';}
      else if(s[cardId].seen>=1){s[cardId].level='familiar';}
      saveCardState(s);
    }

    /* ── Match high scores (localStorage) ── */
    function getMatchScoreKey(){return'match_scores_'+(auth.currentUser?auth.currentUser.uid:'anon')+'_'+selectedPackId;}
    function loadMatchScores(){try{return JSON.parse(localStorage.getItem(getMatchScoreKey()))||[];}catch(e){return[];}}
    function saveMatchScore(timeMs){
      var scores=loadMatchScores();
      scores.push(timeMs);
      scores.sort(function(a,b){return a-b;});
      if(scores.length>10){scores=scores.slice(0,10);}
      try{localStorage.setItem(getMatchScoreKey(),JSON.stringify(scores));}catch(e){}
      return scores;
    }
    function getScoreRank(scores,timeMs){
      for(var i=0;i<scores.length;i++){
        if(scores[i]===timeMs){return i+1;}
      }
      return scores.length;
    }

    function getSessionStorageKey(){return'study_session_'+(auth.currentUser?auth.currentUser.uid:'anon')+'_'+selectedPackId;}
    function loadSessionState(){
      try{
        var r=localStorage.getItem(getSessionStorageKey());
        if(!r)return;
        var d=JSON.parse(r);
        if(d.settings){sessionSettings=Object.assign({},sessionSettings,d.settings);}
        if(d.algo&&Array.isArray(d.algo)&&d.algo.length===5){sessionAlgo=d.algo;}
        if(d.algoPreset){sessionAlgoPreset=d.algoPreset;}
        if(d.lessons){sessionLessons=Object.assign({},sessionLessons,d.lessons);}
      }catch(e){}
    }
    function saveSessionState(){
      try{localStorage.setItem(getSessionStorageKey(),JSON.stringify({settings:sessionSettings,algo:sessionAlgo,algoPreset:sessionAlgoPreset,lessons:sessionLessons}));}catch(e){}
    }

    /* ── Algorithm ordering ── */
    function orderCardsByAlgo(cards){
      if(!cards||!cards.length)return cards;
      var state=loadCardState();
      var buckets={new:[],familiar:[],retry:[],remaster:[],random:[]};
      cards.forEach(function(c,i){
        var id='fc_'+i;var cs=state[id];
        if(!cs||cs.level==='new'){buckets.new.push({card:c,idx:i});}
        else if(cs.level==='familiar'){buckets.familiar.push({card:c,idx:i});}
        else if(cs.level==='mastered'){buckets.remaster.push({card:c,idx:i});}
        if(cs&&cs.wrong>0){buckets.retry.push({card:c,idx:i});}
        buckets.random.push({card:c,idx:i});
      });
      Object.keys(buckets).forEach(function(k){buckets[k].sort(function(){return Math.random()-0.5;});});
      var result=[],used={};
      sessionAlgo.forEach(function(type){
        var pool=buckets[type]||buckets.random;
        for(var j=0;j<pool.length;j++){
          if(!used[pool[j].idx]){result.push(pool[j]);used[pool[j].idx]=true;break;}
        }
      });
      cards.forEach(function(c,i){if(!used[i])result.push({card:c,idx:i});});
      return result.map(function(r){return r.card;});
    }

    /* ── Answer grading (for write mode) ── */
    function normalizeAnswer(str){
      var s=str.trim();
      if(!sessionSettings.caseSensitive){s=s.toLowerCase();}
      if(sessionSettings.ignoreBrackets){s=s.replace(/\([^)]*\)/g,'').replace(/\[[^\]]*\]/g,'');}
      if(sessionSettings.ignoreArticles){s=s.replace(/\b(a|an|the)\b/gi,'');}
      if(sessionSettings.ignoreDeterminers){s=s.replace(/[;,\/]/g,'');}
      s=s.replace(/\s+/g,' ').trim();
      return s;
    }
    function gradeAnswer(userAnswer,correctAnswer){
      var ua=normalizeAnswer(userAnswer);
      var ca=normalizeAnswer(correctAnswer);
      if(sessionSettings.forceExactMatch){return ua===ca;}
      return ua===ca;
    }

    /* ── DOM refs ── */
    var userMeta=document.getElementById('user-meta'),authBtn=document.getElementById('auth-btn'),backAppBtn=document.getElementById('back-app-btn'),fullscreenBtn=document.getElementById('fullscreen-btn');
    var searchInput=document.getElementById('search-input'),folderList=document.getElementById('folder-list'),packList=document.getElementById('pack-list'),newFolderBtn=document.getElementById('new-folder-btn'),deleteFolderBtn=document.getElementById('delete-folder-btn');
    var packEmpty=document.getElementById('pack-empty'),packEditorWrap=document.getElementById('pack-editor-wrap'),packTitle=document.getElementById('pack-title'),packFolderSelect=document.getElementById('pack-folder-select'),packFolderPicker=document.getElementById('pack-folder-picker'),packFolderButton=document.getElementById('pack-folder-button'),packFolderLabel=document.getElementById('pack-folder-label'),packFolderMenu=document.getElementById('pack-folder-menu');
    var packCourse=document.getElementById('pack-course'),packSubject=document.getElementById('pack-subject'),packSemester=document.getElementById('pack-semester'),packBlock=document.getElementById('pack-block'),notesView=document.getElementById('notes-view');
    var packSummary=document.getElementById('pack-summary'),packSummaryTitle=document.getElementById('pack-summary-title'),packSummaryMeta=document.getElementById('pack-summary-meta'),packStatNotes=document.getElementById('pack-stat-notes'),packStatCards=document.getElementById('pack-stat-cards'),packStatTest=document.getElementById('pack-stat-test');
    var createPackBtn=document.getElementById('create-pack-btn'),openBuilderBtn=document.getElementById('open-builder-btn'),savePackBtn=document.getElementById('save-pack-btn'),deletePackBtn=document.getElementById('delete-pack-btn'),exportPackCsvBtn=document.getElementById('export-pack-csv-btn'),exportCsvLabel=document.getElementById('export-csv-label'),openLearnBtn=document.getElementById('open-learn-btn');
    var editorTabs=document.querySelectorAll('.editor-tab'),flashcardCount=document.getElementById('flashcard-count'),questionCount=document.getElementById('question-count'),addFlashcardBtn=document.getElementById('add-flashcard-btn'),addQuestionBtn=document.getElementById('add-question-btn'),flashcardEditorList=document.getElementById('flashcard-editor-list'),questionEditorList=document.getElementById('question-editor-list');
    var learnStage=document.getElementById('learn-stage'),learnTitle=document.getElementById('learn-title'),learnSub=document.getElementById('learn-sub'),learnBackAppBtn=document.getElementById('learn-back-app-btn'),learnBackLibraryBtn=document.getElementById('learn-back-library-btn'),learnFullscreenBtn=document.getElementById('learn-fullscreen-btn');
    var learnModeLabel=document.getElementById('learn-mode-label');
    var learnFlashcard3d=document.getElementById('learn-flashcard-3d'),learnFlashcardInner=document.getElementById('learn-flashcard-inner'),learnFlashcardFront=document.getElementById('learn-flashcard-front'),learnFlashcardBack=document.getElementById('learn-flashcard-back');
    var learnFPrev=document.getElementById('learn-f-prev'),learnFFlip=document.getElementById('learn-f-flip'),learnFNext=document.getElementById('learn-f-next'),learnFProgress=document.getElementById('learn-f-progress');
    var learnProgressFill=document.getElementById('learn-progress-fill'),learnProgressText=document.getElementById('learn-progress-text');
    var learnQProgress=document.getElementById('learn-q-progress'),learnQScore=document.getElementById('learn-q-score'),learnQText=document.getElementById('learn-q-text'),learnQOptions=document.getElementById('learn-q-options'),learnQExpl=document.getElementById('learn-q-expl'),learnQNext=document.getElementById('learn-q-next');
    var writePromptEl=document.getElementById('write-prompt'),writeInputEl=document.getElementById('write-input'),writeCheckBtn=document.getElementById('write-check-btn'),writeRevealBtn=document.getElementById('write-reveal-btn'),writeFeedbackEl=document.getElementById('write-feedback'),writeNextBtn=document.getElementById('write-next-btn'),writeProgressEl=document.getElementById('write-progress');
    var matchGridEl=document.getElementById('match-grid'),matchTimerEl=document.getElementById('match-timer'),matchResultsEl=document.getElementById('match-results'),matchResultsTime=document.getElementById('match-results-time'),matchResultsBadge=document.getElementById('match-results-badge'),matchResultsHistory=document.getElementById('match-results-history'),matchPlayAgainBtn=document.getElementById('match-play-again');
    var setupOverlay=document.getElementById('setup-overlay'),setupPackName=document.getElementById('setup-pack-name'),setupCloseBtn=document.getElementById('setup-close-btn'),setupStartBtn=document.getElementById('setup-start-btn'),setupMainContent=document.getElementById('setup-main-content'),setupTabs=document.querySelectorAll('.setup-tab'),algoLane=document.getElementById('algo-lane'),algoPresets=document.querySelectorAll('.algo-preset');
    var modePicker=document.getElementById('mode-picker'),modePickerGrid=document.getElementById('mode-picker-grid'),modePickerBack=document.getElementById('mode-picker-back');
    var builderOverlay=document.getElementById('builder-overlay'),builderBrandSub=document.getElementById('builder-brand-sub'),builderSaveBtn=document.getElementById('builder-save-btn'),builderExitBtn=document.getElementById('builder-exit-btn'),builderShareBtn=document.getElementById('builder-share-btn'),builderTitleEl=document.getElementById('builder-title'),builderSubEl=document.getElementById('builder-sub'),builderSummary=document.getElementById('builder-summary'),builderOpenLearnShortcut=document.getElementById('builder-open-learn-shortcut');
    var builderPaneButtons=document.querySelectorAll('.builder-nav-btn[data-builder-pane]'),builderStatCards=document.getElementById('builder-stat-cards'),builderStatQuestions=document.getElementById('builder-stat-questions'),builderStatDirty=document.getElementById('builder-stat-dirty');
    var builderTitleInput=document.getElementById('builder-title-input'),builderFolderSelect=document.getElementById('builder-folder-select'),builderCourseInput=document.getElementById('builder-course-input'),builderSubjectInput=document.getElementById('builder-subject-input'),builderSemesterInput=document.getElementById('builder-semester-input'),builderBlockInput=document.getElementById('builder-block-input'),builderNotesInput=document.getElementById('builder-notes-input');
    var builderFlashcardList=document.getElementById('builder-flashcard-list'),builderQuestionList=document.getElementById('builder-question-list'),builderAddCardBtn=document.getElementById('builder-add-card-btn'),builderAddCardBatchBtn=document.getElementById('builder-add-card-batch-btn'),builderAddQuestionBtn=document.getElementById('builder-add-question-btn'),builderAddQuestionBatchBtn=document.getElementById('builder-add-question-batch-btn');
    var builderImportType=document.getElementById('builder-import-type'),builderImportMode=document.getElementById('builder-import-mode'),builderCsvDrop=document.getElementById('builder-csv-drop'),builderCsvInput=document.getElementById('builder-csv-input'),builderTemplateBtn=document.getElementById('builder-template-btn'),builderApplyImportBtn=document.getElementById('builder-apply-import-btn'),builderImportSummary=document.getElementById('builder-import-summary'),builderPreview=document.getElementById('builder-preview'),builderPreviewTable=document.getElementById('builder-preview-table'),builderImportErrors=document.getElementById('builder-import-errors');
    var builderExitOverlay=document.getElementById('builder-exit-overlay'),builderExitSave=document.getElementById('builder-exit-save'),builderExitDiscard=document.getElementById('builder-exit-discard'),builderExitCancel=document.getElementById('builder-exit-cancel');
    var learnNotesContent=document.getElementById('learn-notes-content');
    var folderModalOverlay=document.getElementById('folder-modal-overlay'),folderModalTitle=document.getElementById('folder-modal-title'),folderModalClose=document.getElementById('folder-modal-close'),folderModalCancel=document.getElementById('folder-modal-cancel'),folderModalSave=document.getElementById('folder-modal-save'),folderNameInput=document.getElementById('folder-name-input'),folderCourseInput=document.getElementById('folder-course-input'),folderSubjectInput=document.getElementById('folder-subject-input'),folderSemesterInput=document.getElementById('folder-semester-input'),folderBlockInput=document.getElementById('folder-block-input');
    var confirmModalOverlay=document.getElementById('confirm-modal-overlay'),confirmModalTitle=document.getElementById('confirm-modal-title'),confirmModalMessage=document.getElementById('confirm-modal-message'),confirmModalClose=document.getElementById('confirm-modal-close'),confirmModalCancel=document.getElementById('confirm-modal-cancel'),confirmModalConfirm=document.getElementById('confirm-modal-confirm');
    var toastEl=document.getElementById('toast');

    /* ── Helpers ── */
    function showToast(msg,type){toastEl.textContent=msg;toastEl.className='toast visible '+(type||'success');setTimeout(function(){toastEl.classList.remove('visible');},2800);}
    function mdToHtml(md){if(!md)return'';var h=md.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/^### (.*$)/gm,'<h3>$1</h3>').replace(/^## (.*$)/gm,'<h2>$1</h2>').replace(/^# (.*$)/gm,'<h1>$1</h1>').replace(/\*\*\*(.*?)\*\*\*/g,'<strong><em>$1</em></strong>').replace(/\*\*(.*?)\*\*/g,'<strong>$1</strong>').replace(/\*(.*?)\*/g,'<em>$1</em>').replace(/^\s*[-*]\s+(.*$)/gm,'<li>$1</li>').replace(/\n\n/g,'</p><p>').replace(/\n/g,'<br>');h='<p>'+h+'</p>';h=h.replace(/(<li>.*?<\/li>)(?=\s*<li>|<br><li>)/g,'$1').replace(/(<li>.*?<\/li>)+/g,'<ul>$&</ul>').replace(/<br><li>/g,'<li>');h=h.replace(/<p><\/p>/g,'').replace(/<p>(<h[1-3]>)/g,'$1').replace(/(<\/h[1-3]>)<\/p>/g,'$1').replace(/<p>(<ul>)/g,'$1').replace(/(<\/ul>)<\/p>/g,'$1');return h;}

    function apiCall(path,options){
      var opts=options||{};
      var headers=opts.headers||{};
      headers['Authorization']='Bearer '+token;
      if(opts.body&&!headers['Content-Type']){headers['Content-Type']='application/json';}
      return fetch(path,Object.assign({},opts,{headers:headers})).then(function(res){
        var isJson=(res.headers.get('content-type')||'').indexOf('application/json')>=0;
        return(isJson?res.json():Promise.resolve(null)).then(function(data){
          if(!res.ok){throw new Error((data&&data.error)||'Request failed');}
          return data;
        });
      });
    }
    function authenticatedFetch(path,options,allowRefresh){
      if(!auth.currentUser){return Promise.reject(new Error('Please sign in'));}
      if(!token){return auth.currentUser.getIdToken().then(function(t){token=t;return authenticatedFetch(path,options,allowRefresh);});}
      var opts=options||{};
      var headers=Object.assign({},opts.headers||{},{Authorization:'Bearer '+token});
      return fetch(path,Object.assign({},opts,{headers:headers})).then(function(response){
        if(response.status===401&&allowRefresh!==false){
          return auth.currentUser.getIdToken(true).then(function(t){token=t;return authenticatedFetch(path,options,false);});
        }
        return response;
      });
    }
    function parseFilenameFromDisposition(d,f){if(!d)return f;var u=d.match(/filename\*=UTF-8''([^;]+)/i);if(u&&u[1])return decodeURIComponent(u[1].trim());var a=d.match(/filename="?([^";]+)"?/i);if(a&&a[1])return a[1].trim();return f;}
    function downloadStudyPackCsv(packId,type){
      var fallback=type==='test'?'study-pack-'+packId+'-practice-test.csv':'study-pack-'+packId+'-flashcards.csv';
      return authenticatedFetch('/api/study-packs/'+encodeURIComponent(packId)+'/export-flashcards-csv?type='+encodeURIComponent(type)).then(function(r){
        if(!r.ok){return r.json().catch(function(){return{};}).then(function(d){throw new Error(d.error||'Could not export CSV');});}
        return r.blob().then(function(blob){
          var fn=parseFilenameFromDisposition(r.headers.get('content-disposition')||'',fallback);
          var url=URL.createObjectURL(blob);var anchor=document.createElement('a');anchor.href=url;anchor.download=fn;document.body.appendChild(anchor);anchor.click();document.body.removeChild(anchor);URL.revokeObjectURL(url);
        });
      });
    }
    function openModal(ov){ov.classList.add('entering');requestAnimationFrame(function(){requestAnimationFrame(function(){ov.classList.replace('entering','visible');});});}
    function closeModal(ov){ov.classList.remove('visible');}
    function openConfirmModal(title,message,confirmLabel){confirmModalTitle.textContent=title;confirmModalMessage.textContent=message;confirmModalConfirm.textContent=confirmLabel||'Delete';openModal(confirmModalOverlay);return new Promise(function(r){confirmModalResolver=r;});}
    function closeConfirmModal(c){closeModal(confirmModalOverlay);if(confirmModalResolver){confirmModalResolver(Boolean(c));confirmModalResolver=null;}}

    /* ── Fullscreen Pack Builder ── */
    function escapeHtml(v){
      return String(v||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
    }
    function createDefaultQuestion(){
      return normalizeQuestion({
        question:'New question',
        options:['Option A','Option B','Option C','Option D'],
        answer:'Option A',
        explanation:''
      });
    }
    function buildDraftFromPack(pack){
      var source=pack||{};
      return {
        title:source.title||'',
        folder_id:source.folder_id||'',
        course:source.course||'',
        subject:source.subject||'',
        semester:source.semester||'',
        block:source.block||'',
        notes_markdown:source.notes_markdown||'',
        flashcards:(source.flashcards||[]).map(function(card){
          return {front:card.front||'',back:card.back||''};
        }),
        test_questions:(source.test_questions||[]).map(function(q){
          return normalizeQuestion(q);
        })
      };
    }
    function markBuilderDirty(value){
      builderDirty=(value!==false);
      builderStatDirty.textContent=builderDirty?'Yes':'No';
      builderStatDirty.style.color=builderDirty?'#991B1B':'var(--gray-900)';
    }
    function updateBuilderStats(){
      if(!builderDraft){return;}
      builderStatCards.textContent=String((builderDraft.flashcards||[]).length);
      builderStatQuestions.textContent=String((builderDraft.test_questions||[]).length);
      builderSummary.textContent=(builderDraft.flashcards||[]).length+' cards · '+(builderDraft.test_questions||[]).length+' questions';
    }
    function renderBuilderFolderSelect(){
      var options=[{folder_id:'',name:'No folder'}].concat(folders.map(function(folder){
        return {folder_id:folder.folder_id,name:folder.name};
      }));
      builderFolderSelect.innerHTML=options.map(function(item){
        return '<option value="'+escapeHtml(item.folder_id)+'">'+escapeHtml(item.name)+'</option>';
      }).join('');
      builderFolderSelect.value=builderDraft&&builderDraft.folder_id?builderDraft.folder_id:'';
    }
    function renderBuilderInfoPane(){
      if(!builderDraft){return;}
      builderTitleInput.value=builderDraft.title||'';
      builderCourseInput.value=builderDraft.course||'';
      builderSubjectInput.value=builderDraft.subject||'';
      builderSemesterInput.value=builderDraft.semester||'';
      builderBlockInput.value=builderDraft.block||'';
      builderNotesInput.value=builderDraft.notes_markdown||'';
      renderBuilderFolderSelect();
    }
    function renderBuilderFlashcards(){
      if(!builderDraft){return;}
      var cards=builderDraft.flashcards||[];
      if(!cards.length){
        builderFlashcardList.innerHTML='<div class="builder-list-empty">No flashcards yet. Add one to start building your deck.</div>';
        updateBuilderStats();
        return;
      }
      builderFlashcardList.innerHTML=cards.map(function(card,index){
        return '<div class="builder-row" data-fc-row="'+index+'">'
          +'<div class="builder-row-head"><span class="builder-row-title">Flashcard '+(index+1)+'</span><button class="btn danger" data-delete-fc="'+index+'" style="padding:5px 8px;font-size:.75rem">Delete</button></div>'
          +'<div class="builder-split"><div class="field"><label>Front</label><textarea data-fc-field="front" data-fc-index="'+index+'" style="min-height:92px">'+escapeHtml(card.front||'')+'</textarea></div>'
          +'<div class="field"><label>Back</label><textarea data-fc-field="back" data-fc-index="'+index+'" style="min-height:92px">'+escapeHtml(card.back||'')+'</textarea></div></div></div>';
      }).join('');
      updateBuilderStats();
    }
    function renderBuilderQuestions(){
      if(!builderDraft){return;}
      var questions=(builderDraft.test_questions||[]).map(normalizeQuestion);
      builderDraft.test_questions=questions;
      if(!questions.length){
        builderQuestionList.innerHTML='<div class="builder-list-empty">No practice questions yet. Add one to begin.</div>';
        updateBuilderStats();
        return;
      }
      builderQuestionList.innerHTML=questions.map(function(question,index){
        var answerOptions=(question.options||[]).map(function(option,optionIndex){
          var letter=['A','B','C','D'][optionIndex]||'';
          return '<option value="'+escapeHtml(option)+'" '+(question.answer===option?'selected':'')+'>'+letter+': '+escapeHtml(option||'(empty)')+'</option>';
        }).join('');
        return '<div class="builder-row" data-q-row="'+index+'">'
          +'<div class="builder-row-head"><span class="builder-row-title">Question '+(index+1)+'</span><button class="btn danger" data-delete-q="'+index+'" style="padding:5px 8px;font-size:.75rem">Delete</button></div>'
          +'<div class="field"><label>Question</label><textarea data-q-field="question" data-q-index="'+index+'" style="min-height:86px">'+escapeHtml(question.question||'')+'</textarea></div>'
          +'<div class="builder-grid-3" style="margin-top:8px">'
          +'<div class="field"><label>Option A</label><input data-q-option="0" data-q-index="'+index+'" value="'+escapeHtml(question.options[0]||'')+'"></div>'
          +'<div class="field"><label>Option B</label><input data-q-option="1" data-q-index="'+index+'" value="'+escapeHtml(question.options[1]||'')+'"></div>'
          +'<div class="field"><label>Option C</label><input data-q-option="2" data-q-index="'+index+'" value="'+escapeHtml(question.options[2]||'')+'"></div>'
          +'</div><div class="builder-grid" style="margin-top:8px">'
          +'<div class="field"><label>Option D</label><input data-q-option="3" data-q-index="'+index+'" value="'+escapeHtml(question.options[3]||'')+'"></div>'
          +'<div class="field"><label>Correct Answer</label><select class="builder-select" data-q-answer="'+index+'">'+answerOptions+'</select></div>'
          +'</div><div class="field" style="margin-top:8px"><label>Explanation (optional)</label><textarea data-q-field="explanation" data-q-index="'+index+'" style="min-height:72px">'+escapeHtml(question.explanation||'')+'</textarea></div></div>';
      }).join('');
      updateBuilderStats();
    }
    function setBuilderPane(nextPane){
      builderPane=nextPane;
      document.querySelectorAll('.builder-pane').forEach(function(pane){
        pane.classList.toggle('active',pane.id===('builder-pane-'+nextPane));
      });
      builderPaneButtons.forEach(function(button){
        button.classList.toggle('active',button.dataset.builderPane===nextPane);
      });
    }
    function clearBuilderImportState(){
      builderImportParsed=null;
      builderApplyImportBtn.disabled=true;
      builderPreview.style.display='none';
      builderImportErrors.style.display='none';
      builderImportErrors.innerHTML='';
      builderImportSummary.textContent='No file loaded.';
    }
    function openBuilderOverlay(mode,pack){
      var openingCreate=(mode==='create');
      builderMode=openingCreate?'create':'edit';
      builderPackId=openingCreate?'':(pack&&pack.study_pack_id?pack.study_pack_id:selectedPackId);
      builderDraft=openingCreate?buildDraftFromPack({
        title:'',
        notes_markdown:'',
        flashcards:[],
        test_questions:[]
      }):buildDraftFromPack(pack||selectedPack||{});
      builderTitleEl.textContent=openingCreate?'Create Study Pack':'Edit Study Pack';
      builderSubEl.textContent=openingCreate?'Start from scratch in a focused fullscreen workspace':'Refine cards, metadata, and imports in one place';
      builderBrandSub.textContent=openingCreate?'Manual creation flow':'Editing '+(builderDraft.title||'Untitled pack');
      renderBuilderInfoPane();
      renderBuilderFlashcards();
      renderBuilderQuestions();
      clearBuilderImportState();
      setBuilderPane('info');
      markBuilderDirty(false);
      updateBuilderStats();
      openModal(builderOverlay);
      document.body.style.overflow='hidden';
    }
    function closeBuilderOverlay(){
      closeModal(builderOverlay);
      document.body.style.overflow='';
      builderDraft=null;
      builderPackId='';
      builderImportParsed=null;
    }
    function openBuilderExitModal(){
      openModal(builderExitOverlay);
      return new Promise(function(resolve){builderExitResolver=resolve;});
    }
    function closeBuilderExitModal(choice){
      closeModal(builderExitOverlay);
      if(builderExitResolver){
        builderExitResolver(choice);
        builderExitResolver=null;
      }
    }
    function handleBuilderExitRequest(){
      if(!builderDirty){
        closeBuilderOverlay();
        return;
      }
      openBuilderExitModal().then(function(choice){
        if(choice==='save'){
          saveBuilderPack(true);
          return;
        }
        if(choice==='discard'){
          markBuilderDirty(false);
          closeBuilderOverlay();
        }
      });
    }
    function getBuilderPayload(){
      return {
        title:(builderDraft.title||'').trim(),
        folder_id:builderDraft.folder_id||'',
        course:(builderDraft.course||'').trim(),
        subject:(builderDraft.subject||'').trim(),
        semester:(builderDraft.semester||'').trim(),
        block:(builderDraft.block||'').trim(),
        notes_markdown:builderDraft.notes_markdown||'',
        flashcards:builderDraft.flashcards||[],
        test_questions:(builderDraft.test_questions||[]).map(normalizeQuestion)
      };
    }
    function saveBuilderPack(closeAfter){
      if(!builderDraft){return Promise.resolve();}
      var payload=getBuilderPayload();
      if(!payload.title){
        payload.title='Untitled pack';
      }
      var request;
      if(builderMode==='create'){
        request=apiCall('/api/study-packs',{method:'POST',body:JSON.stringify(payload)});
      }else{
        request=apiCall('/api/study-packs/'+encodeURIComponent(builderPackId||selectedPackId),{method:'PATCH',body:JSON.stringify(payload)});
      }
      return request.then(function(response){
        if(builderMode==='create'&&response&&response.study_pack_id){
          builderPackId=response.study_pack_id;
          selectedPackId=response.study_pack_id;
          builderMode='edit';
        }
        return loadData(builderPackId||selectedPackId);
      }).then(function(){
        markBuilderDirty(false);
        showToast('Study pack saved.');
        if(closeAfter){
          closeBuilderOverlay();
        }else{
          builderBrandSub.textContent='Editing '+((builderDraft&&builderDraft.title)||'Untitled pack');
        }
      }).catch(function(e){
        showToast(e.message||'Could not save builder changes.','error');
      });
    }
    function parseCsvRows(text){
      var rows=[];
      var row=[];
      var field='';
      var inQuotes=false;
      for(var i=0;i<text.length;i++){
        var ch=text[i];
        if(ch==='"'){
          if(inQuotes&&text[i+1]==='"'){
            field+='"';
            i++;
          }else{
            inQuotes=!inQuotes;
          }
          continue;
        }
        if(ch===','&&!inQuotes){
          row.push(field);
          field='';
          continue;
        }
        if((ch==='\n'||ch==='\r')&&!inQuotes){
          if(ch==='\r'&&text[i+1]==='\n'){i++;}
          row.push(field);
          rows.push(row);
          row=[];
          field='';
          continue;
        }
        field+=ch;
      }
      row.push(field);
      rows.push(row);
      return rows;
    }
    function normalizeHeader(name){
      return String(name||'').trim().toLowerCase().replace(/[\s\-]+/g,'_');
    }
    function parseBuilderCsvContent(rawText,type){
      var rows=parseCsvRows(rawText||'');
      if(!rows.length||rows.every(function(r){return !r.join('').trim();})){
        return {type:type,items:[],errors:['The file appears to be empty.'],preview:[]};
      }
      var headers=(rows[0]||[]).map(function(header){return normalizeHeader(header.replace(/^\uFEFF/,''));});
      var errors=[];
      var items=[];
      function idx(name){return headers.indexOf(name);}
      if(type==='flashcards'){
        var frontIndex=idx('front');
        var backIndex=idx('back');
        if(frontIndex<0||backIndex<0){
          // Backward compatibility
          frontIndex=idx('question');
          backIndex=idx('answer');
        }
        if(frontIndex<0||backIndex<0){
          return {type:type,items:[],errors:['Missing required headers. Use: front, back'],preview:[]};
        }
        for(var rowIndex=1;rowIndex<rows.length;rowIndex++){
          var row=rows[rowIndex]||[];
          if(!row.join('').trim()){continue;}
          var front=String(row[frontIndex]||'').trim();
          var back=String(row[backIndex]||'').trim();
          if(!front||!back){
            errors.push('Row '+(rowIndex+1)+': front and back are required.');
            continue;
          }
          items.push({front:front,back:back});
        }
      }else{
        var qIndex=idx('question'),aIndex=idx('option_a'),bIndex=idx('option_b'),cIndex=idx('option_c'),dIndex=idx('option_d'),answerIndex=idx('answer'),expIndex=idx('explanation');
        if(qIndex<0||aIndex<0||bIndex<0||cIndex<0||dIndex<0||answerIndex<0){
          return {type:type,items:[],errors:['Missing required headers. Use: question, option_a, option_b, option_c, option_d, answer (optional explanation)'],preview:[]};
        }
        for(var qRowIndex=1;qRowIndex<rows.length;qRowIndex++){
          var qRow=rows[qRowIndex]||[];
          if(!qRow.join('').trim()){continue;}
          var question=String(qRow[qIndex]||'').trim();
          var options=[String(qRow[aIndex]||'').trim(),String(qRow[bIndex]||'').trim(),String(qRow[cIndex]||'').trim(),String(qRow[dIndex]||'').trim()];
          var answerRaw=String(qRow[answerIndex]||'').trim();
          var explanation=expIndex>=0?String(qRow[expIndex]||'').trim():'';
          if(!question||options.some(function(opt){return !opt;})){
            errors.push('Row '+(qRowIndex+1)+': question and all options are required.');
            continue;
          }
          if(new Set(options).size!==4){
            errors.push('Row '+(qRowIndex+1)+': options must be unique.');
            continue;
          }
          var answer=answerRaw;
          if(/^[ABCD]$/i.test(answerRaw)){
            answer=options['ABCD'.indexOf(answerRaw.toUpperCase())];
          }
          if(options.indexOf(answer)<0){
            errors.push('Row '+(qRowIndex+1)+': answer must match one option or use A-D.');
            continue;
          }
          items.push({question:question,options:options,answer:answer,explanation:explanation});
        }
      }
      return {type:type,items:items,errors:errors,preview:items.slice(0,10)};
    }
    function renderBuilderImportPreview(){
      if(!builderImportParsed||!builderImportParsed.items.length){
        builderPreview.style.display='none';
        return;
      }
      var parsed=builderImportParsed;
      var headers=parsed.type==='flashcards'?['Front','Back']:['Question','Answer','Explanation'];
      var rowsHtml=parsed.preview.map(function(item){
        if(parsed.type==='flashcards'){
          return '<tr><td>'+escapeHtml(item.front)+'</td><td>'+escapeHtml(item.back)+'</td></tr>';
        }
        return '<tr><td>'+escapeHtml(item.question)+'</td><td>'+escapeHtml(item.answer)+'</td><td>'+escapeHtml(item.explanation||'')+'</td></tr>';
      }).join('');
      builderPreviewTable.innerHTML='<thead><tr>'+headers.map(function(header){return '<th>'+escapeHtml(header)+'</th>';}).join('')+'</tr></thead><tbody>'+rowsHtml+'</tbody>';
      builderPreview.style.display='';
    }
    function handleBuilderCsvFile(file){
      if(!file){return;}
      var reader=new FileReader();
      reader.onload=function(){
        var parsed=parseBuilderCsvContent(String(reader.result||''),builderImportType.value);
        builderImportParsed=parsed;
        builderApplyImportBtn.disabled=!parsed.items.length;
        builderImportSummary.textContent='Loaded '+parsed.items.length+' valid row(s).';
        if(parsed.errors.length){
          builderImportErrors.style.display='';
          builderImportErrors.innerHTML=parsed.errors.map(function(err){return '<div>'+escapeHtml(err)+'</div>';}).join('');
        }else{
          builderImportErrors.style.display='none';
          builderImportErrors.innerHTML='';
        }
        renderBuilderImportPreview();
      };
      reader.onerror=function(){
        showToast('Could not read CSV file.','error');
      };
      reader.readAsText(file);
    }
    function applyBuilderImport(){
      if(!builderDraft||!builderImportParsed||!builderImportParsed.items.length){
        return;
      }
      var replaceMode=builderImportMode.value==='replace';
      if(builderImportParsed.type==='flashcards'){
        builderDraft.flashcards=replaceMode?builderImportParsed.items.slice():(builderDraft.flashcards||[]).concat(builderImportParsed.items);
        renderBuilderFlashcards();
      }else{
        var incoming=builderImportParsed.items.map(normalizeQuestion);
        builderDraft.test_questions=replaceMode?incoming:(builderDraft.test_questions||[]).concat(incoming);
        renderBuilderQuestions();
      }
      markBuilderDirty(true);
      updateBuilderStats();
      showToast('Imported '+builderImportParsed.items.length+' row(s).');
    }
    function downloadBuilderTemplate(){
      var csvText='';
      var filename='';
      if(builderImportType.value==='flashcards'){
        csvText='front,back\nCell membrane,Selective barrier surrounding the cell\nMitochondria,Organelle that produces ATP';
        filename='flashcards-template.csv';
      }else{
        csvText='question,option_a,option_b,option_c,option_d,answer,explanation\nWhich organelle produces ATP?,Nucleus,Mitochondria,Golgi apparatus,Ribosome,B,Mitochondria are the powerhouse of the cell.';
        filename='practice-test-template.csv';
      }
      var blob=new Blob([csvText],{type:'text/csv;charset=utf-8;'});
      var link=document.createElement('a');
      link.href=URL.createObjectURL(blob);
      link.download=filename;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      URL.revokeObjectURL(link.href);
    }

    /* ── Session Setup ── */
    function renderAlgoLane(){
      algoLane.innerHTML='';
      sessionAlgo.forEach(function(type,i){
        if(i>0){var ch=document.createElement('div');ch.className='algo-chevron';ch.innerHTML='<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="9 18 15 12 9 6"></polyline></svg>';algoLane.appendChild(ch);}
        var s=document.createElement('div');s.className='algo-slot';s.dataset.type=type;s.dataset.index=String(i);
        s.innerHTML=(ALGO_ICONS[type]||'')+'<span>'+type.charAt(0).toUpperCase()+type.slice(1)+'</span>';
        s.addEventListener('click',function(){var ni=(ALGO_TYPES.indexOf(type)+1)%ALGO_TYPES.length;sessionAlgo[i]=ALGO_TYPES[ni];sessionAlgoPreset='';renderAlgoLane();renderAlgoPresets();saveSessionState();});
        algoLane.appendChild(s);
      });
    }
    function renderAlgoPresets(){algoPresets.forEach(function(b){b.classList.toggle('active',b.dataset.preset===sessionAlgoPreset);});}
    function applyAlgoPreset(p){if(ALGO_PRESETS[p]){sessionAlgo=ALGO_PRESETS[p].slice();sessionAlgoPreset=p;renderAlgoLane();renderAlgoPresets();saveSessionState();}}
    function renderSettingsRows(){document.querySelectorAll('.setting-row[data-setting]').forEach(function(r){r.classList.toggle('active',!!sessionSettings[r.dataset.setting]);});}

    function renderLessonCards(){
      var hf=selectedPack&&selectedPack.flashcards&&selectedPack.flashcards.length>0;
      var ht=selectedPack&&selectedPack.test_questions&&selectedPack.test_questions.length>0;
      var fcCount=selectedPack?(selectedPack.flashcards||[]).length:0;
      var hasEnoughForMatch=fcCount>=MATCH_MIN_CARDS;
      var fc=document.getElementById('lesson-card-flashcards');
      var tc=document.getElementById('lesson-card-test');
      var wc=document.getElementById('lesson-card-write');
      var mc=document.getElementById('lesson-card-match');
      var mb=document.getElementById('match-min-badge');
      // Show/hide based on data availability
      fc.style.display=hf?'':'none';
      tc.style.display=ht?'':'none';
      wc.style.display=hf?'':'none'; // write uses flashcards
      mc.style.display=hf?'':'none'; // match uses flashcards
      // Match needs minimum cards
      if(hf&&!hasEnoughForMatch){
        mc.classList.add('unavailable');mc.classList.remove('selected');
        sessionLessons.match=false;
        mb.style.display='';mb.textContent='Needs '+MATCH_MIN_CARDS+'+ cards';
      }else{
        mc.classList.remove('unavailable');mb.style.display='none';
      }
      if(!hf){sessionLessons.flashcards=false;sessionLessons.write=false;sessionLessons.match=false;}
      if(!ht){sessionLessons.test=false;}
      fc.classList.toggle('selected',sessionLessons.flashcards);
      tc.classList.toggle('selected',sessionLessons.test);
      wc.classList.toggle('selected',sessionLessons.write);
      mc.classList.toggle('selected',sessionLessons.match);
    }

    function renderMasteryGauge(){
      var cards=selectedPack?(selectedPack.flashcards||[]):[];
      var total=cards.length;var state=loadCardState();
      var seen=0,famCount=0,mastCount=0;
      cards.forEach(function(c,i){var cs=state['fc_'+i];if(cs){seen++;if(cs.level==='mastered'){mastCount++;}else if(cs.level==='familiar'){famCount++;}}});
      var newCount=total-seen;
      document.getElementById('mastery-total').textContent=String(total);
      document.getElementById('mastery-seen').textContent=String(seen);
      document.getElementById('mastery-new-pct').textContent=total?Math.round((newCount/total)*100)+'%':'0%';
      document.getElementById('mastery-familiar-pct').textContent=total?Math.round((famCount/total)*100)+'%':'0%';
      document.getElementById('mastery-mastered-pct').textContent=total?Math.round((mastCount/total)*100)+'%':'0%';
    }

    function setSetupPane(p){
      activeSetupPane=p;
      setupTabs.forEach(function(t){t.classList.toggle('active',t.dataset.setupPane===p);});
      ['mastery','lessons','settings','algorithm'].forEach(function(x){
        var el=document.getElementById('setup-pane-'+x);
        if(el){el.classList.toggle('active',x===p);}
      });
    }

    function getEnabledModes(){
      var modes=[];
      if(sessionLessons.flashcards){modes.push('flashcards');}
      if(sessionLessons.test){modes.push('test');}
      if(sessionLessons.write){modes.push('write');}
      if(sessionLessons.match){modes.push('match');}
      return modes;
    }

    function showModePicker(modes){
      setupMainContent.style.display='none';
      modePicker.classList.add('active');
      modePickerGrid.innerHTML='';
      modes.forEach(function(m){
        var card=document.createElement('div');
        card.className='mode-picker-card';
        card.innerHTML=(MODE_ICONS[m]||'')+'<div class="mode-picker-card-title">'+(MODE_NAMES[m]||m)+'</div><div class="mode-picker-card-desc">'+(MODE_DESCS[m]||'')+'</div>';
        card.addEventListener('click',function(){
          closeSessionSetup();
          openLearnStageWithMode(m,false);
        });
        modePickerGrid.appendChild(card);
      });
    }

    function hideModePicker(){
      modePicker.classList.remove('active');
      setupMainContent.style.display='';
    }

    function openSessionSetup(){
      if(!selectedPack){showToast('Select a study pack first.','error');return;}
      loadSessionState();
      setupPackName.textContent=selectedPack.title||'Untitled pack';
      hideModePicker();
      renderMasteryGauge();renderLessonCards();renderSettingsRows();renderAlgoLane();renderAlgoPresets();
      setSetupPane('mastery');
      openModal(setupOverlay);
    }
    function closeSessionSetup(){closeModal(setupOverlay);hideModePicker();}

    setupTabs.forEach(function(t){t.addEventListener('click',function(){setSetupPane(t.dataset.setupPane);});});
    setupCloseBtn.addEventListener('click',closeSessionSetup);
    setupOverlay.addEventListener('click',function(e){if(e.target===setupOverlay){closeSessionSetup();}});
    algoPresets.forEach(function(b){b.addEventListener('click',function(){applyAlgoPreset(b.dataset.preset);});});
    document.querySelectorAll('.setting-row[data-setting]').forEach(function(row){
      row.addEventListener('click',function(){
        sessionSettings[row.dataset.setting]=!sessionSettings[row.dataset.setting];
        renderSettingsRows();saveSessionState();
      });
    });
    document.querySelectorAll('.lesson-card:not(.unavailable)').forEach(function(card){
      card.addEventListener('click',function(){
        var l=card.dataset.lesson;
        if(card.classList.contains('unavailable'))return;
        if(l==='flashcards'){sessionLessons.flashcards=!sessionLessons.flashcards;}
        if(l==='test'){sessionLessons.test=!sessionLessons.test;}
        if(l==='write'){sessionLessons.write=!sessionLessons.write;}
        if(l==='match'){sessionLessons.match=!sessionLessons.match;}
        renderLessonCards();saveSessionState();
      });
    });
    modePickerBack.addEventListener('click',hideModePicker);

    setupStartBtn.addEventListener('click',function(){
      saveSessionState();
      var modes=getEnabledModes();
      if(modes.length===0){
        showToast('Select at least one lesson type.','error');
        setSetupPane('lessons');
        return;
      }
      if(modes.length===1){
        // Single mode: enter directly
        closeSessionSetup();
        openLearnStageWithMode(modes[0],false);
      }else{
        // Multiple modes: show picker
        showModePicker(modes);
      }
    });

    /* ── Write mode ── */
    function initWriteMode(){
      writeIndex=0;writeRevealed=false;writeChecked=false;writePromptSwapped=false;
      renderWriteCard();
    }
    function getWriteCards(){
      return orderedFlashcards.length?orderedFlashcards:(selectedPack&&selectedPack.flashcards?selectedPack.flashcards:[]);
    }
    function renderWriteCard(){
      var cards=getWriteCards();
      if(!cards.length){writePromptEl.textContent='No flashcards available.';writeInputEl.style.display='none';writeCheckBtn.style.display='none';writeRevealBtn.style.display='none';writeNextBtn.style.display='none';return;}
      var c=cards[writeIndex];
      writePromptSwapped=sessionSettings.swapAnswerQuestion||(sessionSettings.randomSwap&&Math.random()>0.5);
      writePromptEl.textContent=writePromptSwapped?(c.back||''):(c.front||'');
      writeInputEl.value='';writeInputEl.disabled=false;writeInputEl.className='write-input';
      writeInputEl.style.display='';writeCheckBtn.style.display='';writeRevealBtn.style.display='';
      writeFeedbackEl.className='write-feedback';writeFeedbackEl.style.display='';writeFeedbackEl.classList.remove('visible');
      writeChecked=false;writeRevealed=false;
      writeProgressEl.textContent=(writeIndex+1)+' / '+cards.length;
      writeNextBtn.style.display='';
      writeInputEl.focus();
      updateLearnProgressBar();
    }
    function checkWriteAnswer(){
      if(writeChecked||writeRevealed)return;
      writeChecked=true;
      var cards=getWriteCards();
      var c=cards[writeIndex];
      var correctAnswer=writePromptSwapped?(c.front||''):(c.back||'');
      var isCorrect=gradeAnswer(writeInputEl.value,correctAnswer);
      writeInputEl.disabled=true;
      markCardSeen('fc_'+writeIndex,isCorrect);
      if(isCorrect){
        writeInputEl.className='write-input correct-input';
        writeFeedbackEl.className='write-feedback visible correct-fb';
        writeFeedbackEl.textContent='Correct!';
      }else{
        writeInputEl.className='write-input wrong-input';
        writeFeedbackEl.className='write-feedback visible wrong-fb';
        writeFeedbackEl.textContent='Incorrect. Expected: '+correctAnswer;
      }
    }
    function revealWriteAnswer(){
      if(writeRevealed)return;
      writeRevealed=true;writeChecked=true;
      var cards=getWriteCards();
      var c=cards[writeIndex];
      var correctAnswer=writePromptSwapped?(c.front||''):(c.back||'');
      writeInputEl.disabled=true;writeInputEl.className='write-input wrong-input';
      writeFeedbackEl.className='write-feedback visible wrong-fb';
      writeFeedbackEl.textContent='Answer: '+correctAnswer;
      markCardSeen('fc_'+writeIndex,false);
    }
    writeCheckBtn.addEventListener('click',checkWriteAnswer);
    writeRevealBtn.addEventListener('click',revealWriteAnswer);
    writeNextBtn.addEventListener('click',function(){
      var cards=getWriteCards();
      if(writeIndex<cards.length-1){writeIndex++;renderWriteCard();}
      else{showToast('All cards completed!');}
    });
    writeInputEl.addEventListener('keydown',function(e){
      if(e.key==='Enter'){e.preventDefault();if(!writeChecked){checkWriteAnswer();}else{writeNextBtn.click();}}
    });

    /* ── Match mode ── */
    function initMatchMode(){
      stopMatchTimer();
      matchResultsEl.style.display='none';
      matchGridEl.style.display='';
      matchSelected=null;matchMatched=0;
      var cards=selectedPack&&selectedPack.flashcards?selectedPack.flashcards:[];
      // Pick 6 random cards for 4x3 grid (6 pairs = 12 cells)
      var poolSize=Math.min(6,Math.floor(cards.length));
      var shuffled=cards.slice().sort(function(){return Math.random()-0.5;});
      var picked=shuffled.slice(0,poolSize);
      matchTotal=poolSize;
      // Build cells: each card produces a front cell and a back cell
      var cells=[];
      picked.forEach(function(c,i){
        cells.push({id:'m_'+i,side:'front',text:c.front||'',pairId:i});
        cells.push({id:'m_'+i,side:'back',text:c.back||'',pairId:i});
      });
      // Shuffle cells
      cells.sort(function(){return Math.random()-0.5;});
      matchCards=cells;
      renderMatchGrid();
      startMatchTimer();
    }
    function renderMatchGrid(){
      matchGridEl.innerHTML='';
      matchCards.forEach(function(cell,idx){
        var div=document.createElement('div');
        div.className='match-cell';
        div.textContent=cell.text;
        div.dataset.idx=String(idx);
        div.dataset.pairId=String(cell.pairId);
        div.dataset.side=cell.side;
        if(cell.matched){div.classList.add('matched');}
        div.addEventListener('click',function(){handleMatchClick(idx);});
        matchGridEl.appendChild(div);
      });
    }
    function handleMatchClick(idx){
      var cell=matchCards[idx];
      if(cell.matched)return;
      var cellEl=matchGridEl.children[idx];
      if(matchSelected===null){
        // First selection
        matchSelected=idx;
        cellEl.classList.add('selected');
      }else if(matchSelected===idx){
        // Deselect
        cellEl.classList.remove('selected');
        matchSelected=null;
      }else{
        // Second selection — check match
        var firstCell=matchCards[matchSelected];
        var firstEl=matchGridEl.children[matchSelected];
        if(firstCell.pairId===cell.pairId&&firstCell.side!==cell.side){
          // Correct match
          firstCell.matched=true;cell.matched=true;
          firstEl.classList.remove('selected');firstEl.classList.add('matched');
          cellEl.classList.add('matched');
          matchMatched++;
          markCardSeen('fc_'+cell.pairId,true);
          if(matchMatched>=matchTotal){
            // All matched — stop timer and show results
            stopMatchTimer();
            showMatchResults();
          }
        }else{
          // Wrong match — flash red briefly
          cellEl.classList.add('wrong-flash');firstEl.classList.add('wrong-flash');
          var fi=matchSelected;
          setTimeout(function(){
            cellEl.classList.remove('wrong-flash');
            if(matchGridEl.children[fi]){matchGridEl.children[fi].classList.remove('wrong-flash','selected');}
          },500);
        }
        matchSelected=null;
      }
      updateLearnProgressBar();
    }
    function startMatchTimer(){
      matchStartTime=Date.now();matchRunning=true;matchElapsed=0;
      matchTimerEl.textContent='0.0s';
      matchTimerInterval=setInterval(function(){
        if(!matchRunning)return;
        matchElapsed=Date.now()-matchStartTime;
        matchTimerEl.textContent=(matchElapsed/1000).toFixed(1)+'s';
      },100);
    }
    function stopMatchTimer(){
      matchRunning=false;
      if(matchTimerInterval){clearInterval(matchTimerInterval);matchTimerInterval=null;}
    }
    function showMatchResults(){
      matchGridEl.style.display='none';
      matchResultsEl.style.display='';
      var timeMs=matchElapsed;
      var timeSec=(timeMs/1000).toFixed(2);
      matchResultsTime.textContent=timeSec+'s';
      // Save and get rank
      var scores=saveMatchScore(timeMs);
      var rank=getScoreRank(scores,timeMs);
      if(rank===1){
        matchResultsBadge.textContent='New High Score!';
        matchResultsBadge.className='match-results-badge gold';
      }else if(rank===2){
        matchResultsBadge.textContent='2nd Best Time!';
        matchResultsBadge.className='match-results-badge silver';
      }else if(rank===3){
        matchResultsBadge.textContent='3rd Best Time!';
        matchResultsBadge.className='match-results-badge bronze';
      }else{
        matchResultsBadge.textContent='';
        matchResultsBadge.className='match-results-badge';
      }
      // Show top 3 history
      var historyHtml='';
      var labels=['1st','2nd','3rd'];
      for(var i=0;i<Math.min(3,scores.length);i++){
        historyHtml+=labels[i]+': '+(scores[i]/1000).toFixed(2)+'s';
        if(i<Math.min(3,scores.length)-1){historyHtml+=' &middot; ';}
      }
      matchResultsHistory.innerHTML=historyHtml;
    }
    matchPlayAgainBtn.addEventListener('click',function(){initMatchMode();});
/* ── Editor pane ── */
    function setEditorPane(pane){
      activeEditorPane=pane;
      editorTabs.forEach(function(b){b.classList.toggle('active',b.dataset.editorPane===pane);});
      document.getElementById('editor-pane-notes').classList.toggle('active',pane==='notes');
      document.getElementById('editor-pane-flashcards').classList.toggle('active',pane==='flashcards');
      document.getElementById('editor-pane-test').classList.toggle('active',pane==='test');
      if(pane==='test'){exportType='test';exportCsvLabel.textContent='Export Practice Test CSV';}
      else{exportType='flashcards';exportCsvLabel.textContent='Export Flashcards CSV';}
    }

    function filteredPacks(){
      var q=searchInput.value.trim().toLowerCase();
      return packs.filter(function(p){
        if(selectedFolderId&&p.folder_id!==selectedFolderId)return false;
        if(!q)return true;
        var hay=((p.title||'')+' '+(p.course||'')+' '+(p.subject||'')+' '+(p.semester||'')+' '+(p.block||'')).toLowerCase();
        return hay.indexOf(q)>=0;
      });
    }

    function movePackToFolder(pid,fid){
      return apiCall('/api/study-packs/'+encodeURIComponent(pid),{method:'PATCH',body:JSON.stringify({folder_id:fid})}).then(function(){
        showToast('Study pack moved.');return loadData(pid);
      }).catch(function(e){showToast(e.message||'Could not move pack.','error');});
    }

    function renderFolders(){
      var all=[{folder_id:'',name:'All Study Packs',course:'',subject:'',semester:'',block:''}].concat(folders);
      folderList.innerHTML='';
      all.forEach(function(f){
        var div=document.createElement('div');
        div.className='item'+(selectedFolderId===f.folder_id?' active':'');
        div.dataset.folderId=f.folder_id;
        div.innerHTML='<div class="item-head"><span class="item-title">'+f.name+'</span>'+(f.folder_id?'<button class="btn" data-edit-folder="1" style="padding:5px 8px;font-size:0.75rem;">Edit</button>':'')+'</div><div class="item-sub">'+([f.course,f.subject,f.semester,f.block].filter(Boolean).join(' &middot; ')||(f.folder_id?'No metadata':'All packs'))+'</div>';
        div.addEventListener('click',function(e){if(e.target.closest('[data-edit-folder]'))return;selectedFolderId=f.folder_id;renderFolders();renderPacks();});
        if(f.folder_id){var eb=div.querySelector('[data-edit-folder]');if(eb){eb.addEventListener('click',function(e){e.stopPropagation();openFolderModal('edit',f);});}}
        div.addEventListener('dragover',function(e){e.preventDefault();if(draggedPackId&&f.folder_id)div.classList.add('drop-target');});
        div.addEventListener('dragleave',function(){div.classList.remove('drop-target');});
        div.addEventListener('drop',function(e){e.preventDefault();div.classList.remove('drop-target');if(!draggedPackId||!f.folder_id)return;movePackToFolder(draggedPackId,f.folder_id);draggedPackId='';});
        folderList.appendChild(div);
      });
    }

    function getFolderNameById(id){if(!id)return'No folder';var f=folders.find(function(x){return x.folder_id===id;});return f?f.name:'No folder';}
    function setPackFolderSelection(id){packFolderSelect.value=id||'';packFolderLabel.textContent=getFolderNameById(id||'');packFolderMenu.querySelectorAll('.app-select-item').forEach(function(i){i.classList.toggle('active',i.dataset.value===(id||''));});}
    function renderFolderSelect(){
      var items=[{folder_id:'',name:'No folder'}].concat(folders.map(function(f){return{folder_id:f.folder_id,name:f.name};}));
      packFolderMenu.innerHTML='';
      items.forEach(function(item){var b=document.createElement('button');b.type='button';b.className='app-select-item';b.dataset.value=item.folder_id;b.textContent=item.name;b.addEventListener('click',function(){setPackFolderSelection(item.folder_id);packFolderMenu.classList.remove('visible');packFolderButton.classList.remove('open');});packFolderMenu.appendChild(b);});
      setPackFolderSelection(packFolderSelect.value||'');
    }

    function renderPacks(){
      var items=filteredPacks();packList.innerHTML='';
      if(!items.length){packList.innerHTML='<div class="empty">No study packs match this filter.</div>';return;}
      items.forEach(function(p){
        var div=document.createElement('div');
        div.className='item'+(selectedPackId===p.study_pack_id?' active':'');
        div.draggable=true;div.dataset.packId=p.study_pack_id;
        div.innerHTML='<div class="item-head"><span class="item-title">'+(p.title||'Untitled pack')+'</span></div><div class="item-sub">'+p.mode+' &middot; '+p.flashcards_count+' cards &middot; '+p.test_questions_count+' questions</div><div class="item-sub">'+([p.course,p.subject,p.semester,p.block].filter(Boolean).join(' &middot; ')||(p.folder_name?'Folder: '+p.folder_name:'No metadata'))+'</div>';
        div.addEventListener('click',function(){selectedPackId=p.study_pack_id;renderPacks();openPack(p.study_pack_id);});
        div.addEventListener('dragstart',function(e){draggedPackId=p.study_pack_id;div.classList.add('dragging');e.dataTransfer.effectAllowed='move';e.dataTransfer.setData('text/plain',p.study_pack_id);});
        div.addEventListener('dragend',function(){div.classList.remove('dragging');draggedPackId='';});
        packList.appendChild(div);
      });
    }

    function showPackEditor(v){packEmpty.style.display=v?'none':'block';packEditorWrap.classList.toggle('visible',v);}
    function updatePackSummary(){
      if(!selectedPack){packSummary.classList.remove('visible');return;}
      packSummary.classList.add('visible');
      packSummaryTitle.textContent=selectedPack.title||'Untitled pack';
      packSummaryMeta.textContent=[selectedPack.course,selectedPack.subject,selectedPack.semester,selectedPack.block].filter(Boolean).join(' · ')||(selectedPack.mode||'');
      packStatNotes.textContent=selectedPack.notes_markdown?'Has notes':'No notes';
      packStatCards.textContent=(selectedPack.flashcards||[]).length+' flashcards';
      packStatTest.textContent=(selectedPack.test_questions||[]).length+' questions';
    }

    /* ── Flashcard editor ── */
    function renderFlashcardEditor(hi){
      var idx=typeof hi==='number'?hi:-1;
      var cards=selectedPack&&Array.isArray(selectedPack.flashcards)?selectedPack.flashcards:[];
      flashcardCount.textContent=cards.length+' flashcards';flashcardEditorList.innerHTML='';
      if(!cards.length){flashcardEditorList.innerHTML='<div class="empty">No flashcards yet. Add one to start editing.</div>';return;}
      cards.forEach(function(card,ci){
        var row=document.createElement('div');row.className='editor-card'+(ci===idx?' newly-added':'');row.dataset.rowIndex=String(ci);
        row.innerHTML='<div class="editor-card-head"><span class="editor-card-title">Flashcard '+(ci+1)+'</span><button class="btn danger" data-delete-card="'+ci+'" style="padding:5px 8px;font-size:0.75rem;">Delete</button></div><div class="field"><label>Front</label><input data-card-field="front" data-card-index="'+ci+'" value="'+(card.front||'').replace(/"/g,'&quot;')+'"></div><div class="field" style="margin-top:8px;"><label>Back</label><textarea data-card-field="back" data-card-index="'+ci+'">'+(card.back||'')+'</textarea></div>';
        flashcardEditorList.appendChild(row);
      });
      flashcardEditorList.querySelectorAll('[data-card-field]').forEach(function(el){
        el.addEventListener('input',function(){selectedPack.flashcards[parseInt(el.dataset.cardIndex,10)][el.dataset.cardField]=el.value;});
      });
      flashcardEditorList.querySelectorAll('[data-delete-card]').forEach(function(btn){
        btn.addEventListener('click',function(){selectedPack.flashcards.splice(parseInt(btn.dataset.deleteCard,10),1);if(learnFlashcardIndex>=selectedPack.flashcards.length){learnFlashcardIndex=Math.max(0,selectedPack.flashcards.length-1);}renderFlashcardEditor();showToast('Flashcard deleted.');});
      });
      if(idx>=0){var row=flashcardEditorList.querySelector('[data-row-index="'+idx+'"]');if(row){row.scrollIntoView({behavior:'smooth',block:'center'});var inp=row.querySelector('input[data-card-field="front"]');if(inp){inp.focus();}}}
    }

    /* ── Question editor ── */
    function normalizeQuestion(q){
      var b={question:q.question||'',options:Array.isArray(q.options)?q.options.slice(0,4):[],answer:q.answer||'',explanation:q.explanation||''};
      while(b.options.length<4){b.options.push('');}
      if(b.options.indexOf(b.answer)<0){b.answer=b.options[0]||'';}
      return b;
    }
    function getAnswerDisplay(q){var o=Array.isArray(q.options)?q.options:[];var fi=o.indexOf(q.answer);var i=fi>=0?fi:0;return(['A','B','C','D'][i]||'A')+': '+(o[i]||'(empty)');}

    function renderQuestionEditor(hi){
      var idx=typeof hi==='number'?hi:-1;
      selectedPack.test_questions=(selectedPack.test_questions||[]).map(normalizeQuestion);
      var questions=selectedPack.test_questions;
      questionCount.textContent=questions.length+' practice questions';questionEditorList.innerHTML='';
      if(!questions.length){questionEditorList.innerHTML='<div class="empty">No practice questions yet. Add one to start editing.</div>';return;}
      questions.forEach(function(q,qi){
        var row=document.createElement('div');row.className='editor-card'+(qi===idx?' newly-added':'');row.dataset.rowIndex=String(qi);
        var adStr=getAnswerDisplay(q).replace(/</g,'&lt;').replace(/>/g,'&gt;');
        row.innerHTML='<div class="editor-card-head"><span class="editor-card-title">Question '+(qi+1)+'</span><button class="btn danger" data-delete-question="'+qi+'" style="padding:5px 8px;font-size:0.75rem;">Delete</button></div>'
          +'<div class="field"><label>Question</label><textarea data-question-field="question" data-question-index="'+qi+'">'+q.question+'</textarea></div>'
          +'<div class="q-options-grid" style="margin-top:8px;">'
          +'<div class="field"><label>Option A</label><input data-option-index="0" data-question-index="'+qi+'" value="'+(q.options[0]||'').replace(/"/g,'&quot;')+'"></div>'
          +'<div class="field"><label>Option B</label><input data-option-index="1" data-question-index="'+qi+'" value="'+(q.options[1]||'').replace(/"/g,'&quot;')+'"></div>'
          +'<div class="field"><label>Option C</label><input data-option-index="2" data-question-index="'+qi+'" value="'+(q.options[2]||'').replace(/"/g,'&quot;')+'"></div>'
          +'<div class="field"><label>Option D</label><input data-option-index="3" data-question-index="'+qi+'" value="'+(q.options[3]||'').replace(/"/g,'&quot;')+'"></div></div>'
          +'<div class="field" style="margin-top:8px;"><label>Correct Answer</label>'
          +'<div class="app-select q-answer-picker" data-question-index="'+qi+'">'
          +'<button type="button" class="app-select-button" data-answer-button data-question-index="'+qi+'"><span class="app-select-label">'+adStr+'</span><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"></polyline></svg></button>'
          +'<div class="app-select-menu" data-answer-menu data-question-index="'+qi+'">'
          +q.options.map(function(o,oi){return'<button type="button" class="app-select-item'+(q.answer===o?' active':'')+'" data-answer-item data-question-index="'+qi+'" data-option-index="'+oi+'">'+(['A','B','C','D'][oi])+': '+(o||'(empty)').replace(/</g,'&lt;').replace(/>/g,'&gt;')+'</button>';}).join('')
          +'</div></div></div>'
          +'<div class="field" style="margin-top:8px;"><label>Explanation</label><textarea data-question-field="explanation" data-question-index="'+qi+'">'+q.explanation+'</textarea></div>';
        questionEditorList.appendChild(row);
      });
      questionEditorList.querySelectorAll('[data-question-field="question"],[data-question-field="explanation"]').forEach(function(el){
        el.addEventListener('input',function(){selectedPack.test_questions[parseInt(el.dataset.questionIndex,10)][el.dataset.questionField]=el.value;});
      });
      questionEditorList.querySelectorAll('input[data-option-index]').forEach(function(el){
        el.addEventListener('input',function(){
          var qi2=parseInt(el.dataset.questionIndex,10),oi2=parseInt(el.dataset.optionIndex,10);
          var qn=selectedPack.test_questions[qi2];qn.options[oi2]=el.value;
          if(qn.options.indexOf(qn.answer)<0){qn.answer=qn.options[0]||'';}
          renderQuestionEditor(qi2);
        });
      });
      questionEditorList.querySelectorAll('[data-answer-button]').forEach(function(b){
        b.addEventListener('click',function(e){
          e.stopPropagation();var m=b.parentElement.querySelector('[data-answer-menu]');
          var w=!m.classList.contains('visible');
          questionEditorList.querySelectorAll('[data-answer-menu]').forEach(function(x){x.classList.remove('visible');});
          questionEditorList.querySelectorAll('[data-answer-button]').forEach(function(x){x.classList.remove('open');});
          if(w){m.classList.add('visible');b.classList.add('open');}
        });
      });
      questionEditorList.querySelectorAll('[data-answer-item]').forEach(function(item){
        item.addEventListener('click',function(){
          var qi2=parseInt(item.dataset.questionIndex,10),oi2=parseInt(item.dataset.optionIndex,10);
          selectedPack.test_questions[qi2].answer=selectedPack.test_questions[qi2].options[oi2]||'';
          renderQuestionEditor(qi2);
        });
      });
      questionEditorList.querySelectorAll('[data-delete-question]').forEach(function(btn){
        btn.addEventListener('click',function(){
          selectedPack.test_questions.splice(parseInt(btn.dataset.deleteQuestion,10),1);
          if(learnQuestionIndex>=selectedPack.test_questions.length){learnQuestionIndex=Math.max(0,selectedPack.test_questions.length-1);}
          renderQuestionEditor();showToast('Practice question deleted.');
        });
      });
      if(idx>=0){var row2=questionEditorList.querySelector('[data-row-index="'+idx+'"]');if(row2){row2.scrollIntoView({behavior:'smooth',block:'center'});var ta=row2.querySelector('textarea[data-question-field="question"]');if(ta){ta.focus();}}}
    }

    /* ── Learn progress bar ── */
    function updateLearnProgressBar(){
      var c=0,t=0;
      if(activeLearnMode==='flashcards'){
        var fcCards=orderedFlashcards.length?orderedFlashcards:(selectedPack?(selectedPack.flashcards||[]):[]);
        c=learnFlashcardIndex+1;t=fcCards.length;
      }else if(activeLearnMode==='test'){
        var qs=selectedPack?(selectedPack.test_questions||[]):[];
        c=learnQuestionIndex+1;t=qs.length;
      }else if(activeLearnMode==='write'){
        var wCards=getWriteCards();c=writeIndex+1;t=wCards.length;
      }else if(activeLearnMode==='match'){
        c=matchMatched;t=matchTotal;
      }else{c=1;t=1;}
      learnProgressFill.style.width=t>0?((c/t)*100)+'%':'0%';
      learnProgressText.textContent=t>0?c+'/'+t:'';
    }

    /* ── Learn flashcard with slide animation ── */
    var fcSliding=false;
    function updateFlashcardContent(){
      var cards=orderedFlashcards.length?orderedFlashcards:(selectedPack&&Array.isArray(selectedPack.flashcards)?selectedPack.flashcards:[]);
      if(!cards.length){
        learnFlashcardFront.textContent='No flashcards available.';learnFlashcardBack.textContent='';
        learnFProgress.textContent='Card 0 of 0';learnFPrev.disabled=true;learnFNext.disabled=true;learnFFlip.disabled=true;
        updateLearnProgressBar();return;
      }
      var c=cards[learnFlashcardIndex];
      var swap=sessionSettings.swapAnswerQuestion||(sessionSettings.randomSwap&&Math.random()>0.5);
      learnFlashcardFront.textContent=swap?(c.back||''):(c.front||'');
      learnFlashcardBack.textContent=swap?(c.front||''):(c.back||'');
      learnFProgress.textContent='Card '+(learnFlashcardIndex+1)+' of '+cards.length;
      learnFPrev.disabled=(learnFlashcardIndex===0);
      learnFNext.disabled=(learnFlashcardIndex===cards.length-1);
      learnFFlip.disabled=false;
      updateLearnProgressBar();
    }
    function renderLearnFlashcard(){
      learnFlashcardInner.classList.toggle('flipped',learnFlashcardFlipped);
      updateFlashcardContent();
    }
    function doFlashcardSlide(direction){
      if(fcSliding)return;
      var cards=orderedFlashcards.length?orderedFlashcards:(selectedPack&&selectedPack.flashcards?selectedPack.flashcards:[]);
      if(!cards.length)return;
      var newIdx;
      if(direction==='next'){
        if(learnFlashcardIndex>=cards.length-1)return;
        newIdx=learnFlashcardIndex+1;
      }else{
        if(learnFlashcardIndex<=0)return;
        newIdx=learnFlashcardIndex-1;
      }
      fcSliding=true;
      // Unflip before sliding
      learnFlashcardFlipped=false;
      learnFlashcardInner.classList.remove('flipped');
      var cls=(direction==='next')?'slide-left':'slide-right';
      learnFlashcardInner.classList.add(cls);
      // Update content at animation midpoint (card is invisible)
      setTimeout(function(){
        learnFlashcardIndex=newIdx;
        updateFlashcardContent();
      },130);
      // Remove animation class after it finishes
      setTimeout(function(){
        learnFlashcardInner.classList.remove(cls);
        fcSliding=false;
      },320);
    }

    /* ── Learn quiz ── */
    function renderLearnQuestion(){
      var questions=selectedPack&&Array.isArray(selectedPack.test_questions)?selectedPack.test_questions:[];
      if(!questions.length){
        learnQProgress.textContent='Question 0 of 0';learnQScore.textContent='Score: 0/0';
        learnQText.textContent='No practice questions available.';learnQOptions.innerHTML='';
        learnQExpl.classList.remove('visible');learnQExpl.textContent='';updateLearnProgressBar();return;
      }
      var q=questions[learnQuestionIndex];learnAnswered=false;
      learnQProgress.textContent='Question '+(learnQuestionIndex+1)+' of '+questions.length;
      learnQScore.textContent='Score: '+learnScore+'/'+questions.length;
      learnQText.textContent=q.question||'';learnQOptions.innerHTML='';
      learnQExpl.classList.remove('visible');learnQExpl.textContent='';
      (q.options||[]).forEach(function(option){
        var b=document.createElement('button');b.type='button';b.className='quiz-option';b.textContent=option;
        b.addEventListener('click',function(){
          if(learnAnswered)return;learnAnswered=true;
          var correct=(option===q.answer);
          var allBtns=learnQOptions.querySelectorAll('.quiz-option');
          for(var j=0;j<allBtns.length;j++){allBtns[j].disabled=true;if(allBtns[j].textContent===q.answer){allBtns[j].classList.add('correct');}}
          if(correct){b.classList.add('correct');learnScore+=1;}else{b.classList.add('wrong');}
          markCardSeen('q_'+learnQuestionIndex,correct);
          learnQScore.textContent='Score: '+learnScore+'/'+questions.length;
          learnQExpl.textContent=q.explanation||'';learnQExpl.classList.add('visible');
          updateLearnProgressBar();
        });
        learnQOptions.appendChild(b);
      });
      updateLearnProgressBar();
    }

    /* ── Open learn stage in a specific focused mode ── */
    function openLearnStageWithMode(mode,requestFullscreen){
      if(!selectedPack){showToast('Select a study pack first.','error');return;}
      activeLearnMode=mode;
      learnTitle.textContent=selectedPack.title||'Learn Mode';
      learnSub.textContent=(MODE_NAMES[mode]||mode)+' · Focused session';
      learnModeLabel.textContent=MODE_NAMES[mode]||mode;

      // Hide all panes first
      var allPanes=document.querySelectorAll('#learn-stage .learn-pane');
      for(var i=0;i<allPanes.length;i++){allPanes[i].classList.remove('active');}

      // Reset states
      learnFlashcardIndex=0;learnFlashcardFlipped=false;learnQuestionIndex=0;learnScore=0;
      orderedFlashcards=orderCardsByAlgo(selectedPack.flashcards||[]);
      fcSliding=false;

      // Activate only the selected mode pane
      if(mode==='flashcards'){
        document.getElementById('learn-pane-flashcards').classList.add('active');
        renderLearnFlashcard();
      }else if(mode==='test'){
        document.getElementById('learn-pane-test').classList.add('active');
        renderLearnQuestion();
      }else if(mode==='write'){
        document.getElementById('learn-pane-write').classList.add('active');
        initWriteMode();
      }else if(mode==='match'){
        document.getElementById('learn-pane-match').classList.add('active');
        initMatchMode();
      }else{
        // Fallback: notes
        document.getElementById('learn-pane-notes').classList.add('active');
        learnNotesContent.innerHTML=mdToHtml(selectedPack.notes_markdown||'');
      }

      updateLearnProgressBar();
      learnStage.classList.add('entering');
      requestAnimationFrame(function(){requestAnimationFrame(function(){learnStage.classList.replace('entering','visible');});});
      if(requestFullscreen){
        try{document.documentElement.requestFullscreen();}catch(e){}
      }
    }

    function closeLearnStage(){
      learnStage.classList.remove('visible');
      orderedFlashcards=[];
      stopMatchTimer();
      activeLearnMode='';
      if(document.fullscreenElement){try{document.exitFullscreen();}catch(e){}}
    }

    /* ── Folder modal (careful with ternaries) ── */
    function openFolderModal(mode,folder){
      folderModalMode=mode;
      editingFolderId=(folder&&folder.folder_id)?(folder.folder_id):'';
      folderModalTitle.textContent=(mode==='edit')?'Edit Folder':'Create Folder';
      folderNameInput.value=folder?(folder.name||''):'';
      folderCourseInput.value=folder?(folder.course||''):'';
      folderSubjectInput.value=folder?(folder.subject||''):'';
      folderSemesterInput.value=folder?(folder.semester||''):'';
      folderBlockInput.value=folder?(folder.block||''):'';
      openModal(folderModalOverlay);
      setTimeout(function(){folderNameInput.focus();},100);
    }
    function closeFolderModal(){
      closeModal(folderModalOverlay);
      folderModalMode='create';editingFolderId='';
      folderNameInput.value='';folderCourseInput.value='';
      folderSubjectInput.value='';folderSemesterInput.value='';
      folderBlockInput.value='';
    }
    function saveFolderFromModal(){
      var payload={name:folderNameInput.value.trim(),course:folderCourseInput.value.trim(),subject:folderSubjectInput.value.trim(),semester:folderSemesterInput.value.trim(),block:folderBlockInput.value.trim()};
      if(!payload.name){showToast('Folder name is required.','error');folderNameInput.focus();return;}
      var promise;
      if(folderModalMode==='edit'&&editingFolderId){
        promise=apiCall('/api/study-folders/'+encodeURIComponent(editingFolderId),{method:'PATCH',body:JSON.stringify(payload)}).then(function(){showToast('Folder updated.');});
      }else{
        promise=apiCall('/api/study-folders',{method:'POST',body:JSON.stringify(payload)}).then(function(){showToast('Folder created.');});
      }
      promise.then(function(){closeFolderModal();return loadData(selectedPackId||pendingOpenPackId);}).catch(function(e){showToast(e.message||'Could not save folder.','error');});
    }

    /* ── Open pack ── */
    function openPack(packId){
      return apiCall('/api/study-packs/'+encodeURIComponent(packId)).then(function(data){
        selectedPack=data;
        selectedPack.flashcards=Array.isArray(selectedPack.flashcards)?selectedPack.flashcards:[];
        selectedPack.test_questions=Array.isArray(selectedPack.test_questions)?selectedPack.test_questions.map(normalizeQuestion):[];
        showPackEditor(true);updatePackSummary();
        packTitle.value=selectedPack.title||'';
        setPackFolderSelection(selectedPack.folder_id||'');
        packCourse.value=selectedPack.course||'';
        packSubject.value=selectedPack.subject||'';
        packSemester.value=selectedPack.semester||'';
        packBlock.value=selectedPack.block||'';
        notesView.innerHTML=mdToHtml(selectedPack.notes_markdown||'');
        renderFlashcardEditor();renderQuestionEditor();
        setEditorPane(activeEditorPane);
        // Deep link: auto-open learn mode if URL says so
        if(openLearnFromUrl&&!autoLearnConsumed&&selectedPack.study_pack_id===learnPackFromUrl){
          autoLearnConsumed=true;
          var preferMode=focusFromUrl||'';
          if(preferMode&&['flashcards','test','write','match'].indexOf(preferMode)>=0){
            openLearnStageWithMode(preferMode,fullscreenFromUrl);
          }else{
            openSessionSetup();
          }
        }
      });
    }

    /* ── Load data ── */
    function loadData(preferredPackId){
      var prefId=preferredPackId||'';
      return Promise.all([apiCall('/api/study-folders'),apiCall('/api/study-packs')]).then(function(results){
        folders=results[0].folders||[];packs=results[1].study_packs||[];
        renderFolderSelect();renderFolders();renderPacks();
        var packToOpen=prefId||selectedPackId||'';
        if(packToOpen&&packs.find(function(item){return item.study_pack_id===packToOpen;})){
          selectedPackId=packToOpen;renderPacks();return openPack(packToOpen);
        }else if(learnPackFromUrl&&packs.find(function(item){return item.study_pack_id===learnPackFromUrl;})){
          selectedPackId=learnPackFromUrl;renderPacks();return openPack(learnPackFromUrl);
        }else{
          selectedPack=null;showPackEditor(false);updatePackSummary();
        }
      });
    }

    /* ── Auth ── */
    auth.onAuthStateChanged(function(user){
      if(!user){
        token=null;
        if(builderOverlay.classList.contains('visible')){
          markBuilderDirty(false);
          closeBuilderOverlay();
        }
        userMeta.textContent='Not signed in';
        authBtn.textContent='Sign in';
        return;
      }
      user.getIdToken().then(function(t){
        token=t;
        userMeta.textContent='Signed in as '+user.email;
        authBtn.textContent='Sign out';
        return loadData();
      }).catch(function(e){
        showToast(e.message||'Could not load study library.','error');
      });
    });

    /* ── Event listeners ── */
    authBtn.addEventListener('click',function(){
      if(!auth.currentUser){window.location.href='/';return;}
      auth.signOut();
    });
    createPackBtn.addEventListener('click',function(){
      if(!auth.currentUser){
        showToast('Please sign in first.','error');
        return;
      }
      openBuilderOverlay('create',null);
    });
    openBuilderBtn.addEventListener('click',function(){
      if(!auth.currentUser){
        showToast('Please sign in first.','error');
        return;
      }
      if(!selectedPack){
        showToast('Select a study pack first.','error');
        return;
      }
      openBuilderOverlay('edit',selectedPack);
    });
    builderSaveBtn.addEventListener('click',function(){
      saveBuilderPack(false);
    });
    builderExitBtn.addEventListener('click',function(){
      handleBuilderExitRequest();
    });
    builderPaneButtons.forEach(function(button){
      button.addEventListener('click',function(){
        setBuilderPane(button.dataset.builderPane);
      });
    });
    builderOpenLearnShortcut.addEventListener('click',function(){
      if(builderDirty){
        showToast('Save changes before opening Learn mode.','error');
        return;
      }
      if(!builderPackId){
        showToast('Save this new pack first.','error');
        return;
      }
      openPack(builderPackId).then(function(){
        closeBuilderOverlay();
        openSessionSetup();
      });
    });
    builderTitleInput.addEventListener('input',function(){
      if(!builderDraft){return;}
      builderDraft.title=builderTitleInput.value;
      builderBrandSub.textContent='Editing '+(builderDraft.title||'Untitled pack');
      markBuilderDirty(true);
    });
    builderFolderSelect.addEventListener('change',function(){
      if(!builderDraft){return;}
      builderDraft.folder_id=builderFolderSelect.value||'';
      markBuilderDirty(true);
    });
    builderCourseInput.addEventListener('input',function(){if(builderDraft){builderDraft.course=builderCourseInput.value;markBuilderDirty(true);}});
    builderSubjectInput.addEventListener('input',function(){if(builderDraft){builderDraft.subject=builderSubjectInput.value;markBuilderDirty(true);}});
    builderSemesterInput.addEventListener('input',function(){if(builderDraft){builderDraft.semester=builderSemesterInput.value;markBuilderDirty(true);}});
    builderBlockInput.addEventListener('input',function(){if(builderDraft){builderDraft.block=builderBlockInput.value;markBuilderDirty(true);}});
    builderNotesInput.addEventListener('input',function(){if(builderDraft){builderDraft.notes_markdown=builderNotesInput.value;markBuilderDirty(true);}});
    builderAddCardBtn.addEventListener('click',function(){
      if(!builderDraft){return;}
      builderDraft.flashcards.push({front:'',back:''});
      renderBuilderFlashcards();
      markBuilderDirty(true);
    });
    builderAddCardBatchBtn.addEventListener('click',function(){
      if(!builderDraft){return;}
      for(var i=0;i<5;i++){builderDraft.flashcards.push({front:'',back:''});}
      renderBuilderFlashcards();
      markBuilderDirty(true);
    });
    builderAddQuestionBtn.addEventListener('click',function(){
      if(!builderDraft){return;}
      builderDraft.test_questions.push(createDefaultQuestion());
      renderBuilderQuestions();
      markBuilderDirty(true);
    });
    builderAddQuestionBatchBtn.addEventListener('click',function(){
      if(!builderDraft){return;}
      for(var i=0;i<3;i++){builderDraft.test_questions.push(createDefaultQuestion());}
      renderBuilderQuestions();
      markBuilderDirty(true);
    });
    builderFlashcardList.addEventListener('input',function(event){
      if(!builderDraft){return;}
      var target=event.target;
      if(target.matches('[data-fc-field]')){
        var index=parseInt(target.dataset.fcIndex,10);
        var field=target.dataset.fcField;
        if(builderDraft.flashcards[index]){
          builderDraft.flashcards[index][field]=target.value;
          markBuilderDirty(true);
        }
      }
    });
    builderFlashcardList.addEventListener('click',function(event){
      if(!builderDraft){return;}
      var button=event.target.closest('[data-delete-fc]');
      if(!button){return;}
      var index=parseInt(button.dataset.deleteFc,10);
      builderDraft.flashcards.splice(index,1);
      renderBuilderFlashcards();
      markBuilderDirty(true);
    });
    builderQuestionList.addEventListener('input',function(event){
      if(!builderDraft){return;}
      var target=event.target;
      if(target.matches('[data-q-field]')){
        var index=parseInt(target.dataset.qIndex,10);
        var field=target.dataset.qField;
        if(builderDraft.test_questions[index]){
          builderDraft.test_questions[index][field]=target.value;
          markBuilderDirty(true);
        }
      }else if(target.matches('[data-q-option]')){
        var qIndex=parseInt(target.dataset.qIndex,10);
        var optIndex=parseInt(target.dataset.qOption,10);
        var question=builderDraft.test_questions[qIndex];
        if(question){
          question.options[optIndex]=target.value;
          if(question.options.indexOf(question.answer)<0){
            question.answer=question.options[0]||'';
          }
          renderBuilderQuestions();
          markBuilderDirty(true);
        }
      }
    });
    builderQuestionList.addEventListener('change',function(event){
      if(!builderDraft){return;}
      var target=event.target;
      if(target.matches('[data-q-answer]')){
        var index=parseInt(target.dataset.qAnswer,10);
        if(builderDraft.test_questions[index]){
          builderDraft.test_questions[index].answer=target.value;
          markBuilderDirty(true);
        }
      }
    });
    builderQuestionList.addEventListener('click',function(event){
      if(!builderDraft){return;}
      var button=event.target.closest('[data-delete-q]');
      if(!button){return;}
      var index=parseInt(button.dataset.deleteQ,10);
      builderDraft.test_questions.splice(index,1);
      renderBuilderQuestions();
      markBuilderDirty(true);
    });
    builderImportType.addEventListener('change',clearBuilderImportState);
    builderCsvDrop.addEventListener('click',function(){builderCsvInput.click();});
    builderCsvDrop.addEventListener('dragover',function(event){
      event.preventDefault();
      builderCsvDrop.classList.add('dragover');
    });
    builderCsvDrop.addEventListener('dragleave',function(){
      builderCsvDrop.classList.remove('dragover');
    });
    builderCsvDrop.addEventListener('drop',function(event){
      event.preventDefault();
      builderCsvDrop.classList.remove('dragover');
      var files=event.dataTransfer&&event.dataTransfer.files;
      if(files&&files[0]){handleBuilderCsvFile(files[0]);}
    });
    builderCsvInput.addEventListener('change',function(){
      if(builderCsvInput.files&&builderCsvInput.files[0]){
        handleBuilderCsvFile(builderCsvInput.files[0]);
      }
    });
    builderApplyImportBtn.addEventListener('click',applyBuilderImport);
    builderTemplateBtn.addEventListener('click',downloadBuilderTemplate);
    builderExitSave.addEventListener('click',function(){closeBuilderExitModal('save');});
    builderExitDiscard.addEventListener('click',function(){closeBuilderExitModal('discard');});
    builderExitCancel.addEventListener('click',function(){closeBuilderExitModal('cancel');});
    builderExitOverlay.addEventListener('click',function(event){
      if(event.target===builderExitOverlay){closeBuilderExitModal('cancel');}
    });
    window.addEventListener('beforeunload',function(event){
      if(builderDirty&&builderOverlay.classList.contains('visible')){
        event.preventDefault();
        event.returnValue='';
      }
    });
    backAppBtn.addEventListener('click',function(){window.location.href='/';});
    fullscreenBtn.addEventListener('click',function(){
      if(!selectedPack){showToast('Select a study pack first.','error');return;}
      openSessionSetup();
    });
    searchInput.addEventListener('input',renderPacks);
    packFolderButton.addEventListener('click',function(e){
      e.stopPropagation();
      packFolderMenu.classList.toggle('visible');
      packFolderButton.classList.toggle('open',packFolderMenu.classList.contains('visible'));
    });
    newFolderBtn.addEventListener('click',function(){openFolderModal('create',null);});

    deleteFolderBtn.addEventListener('click',function(){
      if(!selectedFolderId){showToast('Select a folder first.','error');return;}
      openConfirmModal('Delete Folder','Delete this folder? Packs inside will move to no folder.','Delete Folder').then(function(confirmed){
        if(!confirmed)return;
        apiCall('/api/study-folders/'+encodeURIComponent(selectedFolderId),{method:'DELETE'}).then(function(){
          selectedFolderId='';showToast('Folder deleted.');return loadData(selectedPackId);
        }).catch(function(e){showToast(e.message||'Could not delete folder.','error');});
      });
    });

    savePackBtn.addEventListener('click',function(){
      if(!selectedPackId||!selectedPack){showToast('Select a study pack first.','error');return;}
      apiCall('/api/study-packs/'+encodeURIComponent(selectedPackId),{
        method:'PATCH',
        body:JSON.stringify({title:packTitle.value.trim(),folder_id:packFolderSelect.value,course:packCourse.value.trim(),subject:packSubject.value.trim(),semester:packSemester.value.trim(),block:packBlock.value.trim(),flashcards:selectedPack.flashcards||[],test_questions:selectedPack.test_questions||[]})
      }).then(function(){
        pendingOpenPackId=selectedPackId;
        return loadData(selectedPackId);
      }).then(function(){
        pendingOpenPackId='';showToast('Study pack saved.');
      }).catch(function(e){showToast(e.message||'Could not save study pack.','error');});
    });

    deletePackBtn.addEventListener('click',function(){
      if(!selectedPackId){showToast('Select a study pack first.','error');return;}
      openConfirmModal('Delete Study Pack','Delete this study pack permanently? This cannot be undone.','Delete Pack').then(function(confirmed){
        if(!confirmed)return;
        apiCall('/api/study-packs/'+encodeURIComponent(selectedPackId),{method:'DELETE'}).then(function(){
          selectedPackId='';selectedPack=null;showPackEditor(false);updatePackSummary();
          return loadData();
        }).then(function(){showToast('Study pack deleted.');}).catch(function(e){showToast(e.message||'Could not delete study pack.','error');});
      });
    });

    exportPackCsvBtn.addEventListener('click',function(){
      if(!selectedPackId){showToast('Select a study pack first.','error');return;}
      downloadStudyPackCsv(selectedPackId,exportType).then(function(){showToast('CSV export started.');}).catch(function(e){showToast(e.message||'Could not export CSV.','error');});
    });

    openLearnBtn.addEventListener('click',function(){openSessionSetup();});
    editorTabs.forEach(function(btn){btn.addEventListener('click',function(){setEditorPane(btn.dataset.editorPane);});});

    addFlashcardBtn.addEventListener('click',function(){
      if(!selectedPack)return;
      selectedPack.flashcards=selectedPack.flashcards||[];
      selectedPack.flashcards.push({front:'New concept',back:'New explanation'});
      var ni=selectedPack.flashcards.length-1;
      learnFlashcardIndex=ni;learnFlashcardFlipped=false;
      renderFlashcardEditor(ni);setEditorPane('flashcards');
      showToast('New flashcard added.');
    });

    addQuestionBtn.addEventListener('click',function(){
      if(!selectedPack)return;
      selectedPack.test_questions=selectedPack.test_questions||[];
      selectedPack.test_questions.push(normalizeQuestion({question:'New question',options:['Option A','Option B','Option C','Option D'],answer:'Option A',explanation:'Add explanation here.'}));
      var ni=selectedPack.test_questions.length-1;
      learnQuestionIndex=ni;
      renderQuestionEditor(ni);setEditorPane('test');
      showToast('New practice question added.');
    });

    learnBackAppBtn.addEventListener('click',function(){window.location.href='/';});
    learnBackLibraryBtn.addEventListener('click',closeLearnStage);
    learnFullscreenBtn.addEventListener('click',function(){
      try{
        if(document.fullscreenElement){document.exitFullscreen();}
        else{document.documentElement.requestFullscreen();}
      }catch(e){showToast('Fullscreen not available.','error');}
    });

    /* Flashcard controls */
    learnFlashcard3d.addEventListener('click',function(){
      if(fcSliding)return;
      learnFlashcardFlipped=!learnFlashcardFlipped;
      markCardSeen('fc_'+learnFlashcardIndex,true);
      renderLearnFlashcard();
    });
    learnFPrev.addEventListener('click',function(){doFlashcardSlide('prev');});
    learnFNext.addEventListener('click',function(){doFlashcardSlide('next');});
    learnFFlip.addEventListener('click',function(){
      if(fcSliding)return;
      learnFlashcardFlipped=!learnFlashcardFlipped;
      markCardSeen('fc_'+learnFlashcardIndex,true);
      renderLearnFlashcard();
    });

    /* Quiz next */
    learnQNext.addEventListener('click',function(){
      var questions=selectedPack&&selectedPack.test_questions?selectedPack.test_questions:[];
      if(!questions.length)return;
      if(learnQuestionIndex<questions.length-1){learnQuestionIndex++;renderLearnQuestion();}
      else{showToast('All questions completed!');}
    });

    /* Keyboard shortcuts */
    window.addEventListener('keydown',function(e){
      if(builderOverlay.classList.contains('visible')&&e.key==='Escape'){
        e.preventDefault();
        handleBuilderExitRequest();
        return;
      }
      if(!learnStage.classList.contains('visible'))return;
      if(activeLearnMode==='flashcards'){
        if(e.key==='ArrowLeft'){e.preventDefault();doFlashcardSlide('prev');}
        if(e.key==='ArrowRight'){e.preventDefault();doFlashcardSlide('next');}
        if(e.code==='Space'){e.preventDefault();learnFFlip.click();}
      }
    });

    /* Folder modal events */
    folderModalClose.addEventListener('click',closeFolderModal);
    folderModalCancel.addEventListener('click',closeFolderModal);
    folderModalSave.addEventListener('click',saveFolderFromModal);
    folderModalOverlay.addEventListener('click',function(e){if(e.target===folderModalOverlay){closeFolderModal();}});

    /* Close dropdowns on outside click */
    document.addEventListener('click',function(e){
      if(!packFolderPicker.contains(e.target)){packFolderMenu.classList.remove('visible');packFolderButton.classList.remove('open');}
      if(!e.target.closest('.q-answer-picker')){
        questionEditorList.querySelectorAll('[data-answer-menu]').forEach(function(m){m.classList.remove('visible');});
        questionEditorList.querySelectorAll('[data-answer-button]').forEach(function(b){b.classList.remove('open');});
      }
    });

    /* Confirm modal events */
    confirmModalClose.addEventListener('click',function(){closeConfirmModal(false);});
    confirmModalCancel.addEventListener('click',function(){closeConfirmModal(false);});
    confirmModalConfirm.addEventListener('click',function(){closeConfirmModal(true);});
    confirmModalOverlay.addEventListener('click',function(e){if(e.target===confirmModalOverlay){closeConfirmModal(false);}});
  </script>
</body>
</html>
