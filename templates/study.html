<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Study Library</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <style>
    :root {
      --primary: #4F46E5;
      --primary-dark: #4338CA;
      --primary-light: #818CF8;
      --secondary: #0EA5E9;
      --success: #10B981;
      --warning: #F59E0B;
      --error: #EF4444;
      --gray-50: #F9FAFB;
      --gray-100: #F3F4F6;
      --gray-200: #E5E7EB;
      --gray-300: #D1D5DB;
      --gray-400: #9CA3AF;
      --gray-500: #6B7280;
      --gray-600: #4B5563;
      --gray-700: #374151;
      --gray-800: #1F2937;
      --gray-900: #111827;
      --white: #FFFFFF;
      --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
      --shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1);
      --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
      --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
      --shadow-xl: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1);
      --radius-sm: 6px;
      --radius: 8px;
      --radius-md: 12px;
      --radius-lg: 16px;
      --radius-xl: 24px;
    }
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    html { scroll-behavior: smooth; }
    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, var(--gray-50) 0%, var(--gray-100) 100%);
      color: var(--gray-800);
      line-height: 1.6;
      min-height: 100vh;
      -webkit-font-smoothing: antialiased;
    }
    input, textarea, select, button { font-family: inherit; }

    /* ‚îÄ‚îÄ Container ‚îÄ‚îÄ */
    .container { max-width: 1360px; margin: 0 auto; padding: 20px; }

    /* ‚îÄ‚îÄ Topbar (frosted, matching index header) ‚îÄ‚îÄ */
    .topbar {
      display: flex; justify-content: space-between; align-items: center; gap: 12px;
      padding: 14px 20px;
      background: rgba(255,255,255,0.95);
      backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);
      border: 1px solid var(--gray-200);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-lg);
      margin-bottom: 16px;
      position: sticky; top: 12px; z-index: 100;
    }
    .topbar-logo { display: flex; align-items: center; gap: 12px; }
    .topbar-logo-icon {
      width: 38px; height: 38px;
      background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
      border-radius: var(--radius-md); display: flex; align-items: center; justify-content: center; color: var(--white); flex-shrink: 0;
    }
    .topbar-logo-icon svg { width: 22px; height: 22px; }
    .topbar h1 { font-size: 1.15rem; font-weight: 700; letter-spacing: -0.025em; color: var(--gray-900); }
    .topbar-sub { font-size: 0.8125rem; color: var(--gray-500); margin-top: 1px; }
    .actions { display: flex; gap: 8px; flex-wrap: wrap; align-items: center; }

    /* ‚îÄ‚îÄ Buttons (matching index) ‚îÄ‚îÄ */
    .btn {
      display: inline-flex; align-items: center; justify-content: center; gap: 8px;
      border: 1px solid var(--gray-300); background: var(--white); color: var(--gray-700);
      border-radius: var(--radius); padding: 9px 16px;
      font-size: 0.85rem; font-weight: 600; cursor: pointer;
      transition: all 0.2s ease;
    }
    .btn:hover { border-color: var(--gray-400); color: var(--gray-900); background: var(--gray-50); }
    .btn.primary {
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
      border: none; color: var(--white);
      box-shadow: 0 4px 14px 0 rgba(79,70,229,0.3);
    }
    .btn.primary:hover { opacity: 0.92; transform: translateY(-1px); box-shadow: 0 6px 20px 0 rgba(79,70,229,0.4); }
    .btn.danger { border-color: rgba(239,68,68,0.35); color: #991B1B; background: rgba(239,68,68,0.06); }
    .btn.danger:hover { background: rgba(239,68,68,0.12); border-color: rgba(239,68,68,0.5); }
    .btn svg { width: 16px; height: 16px; }

    /* ‚îÄ‚îÄ Grid layout ‚îÄ‚îÄ */
    .grid { display: grid; grid-template-columns: 320px 1fr; gap: 16px; }
    @media (max-width: 1020px) { .grid { grid-template-columns: 1fr; } }

    /* ‚îÄ‚îÄ Panels ‚îÄ‚îÄ */
    .panel {
      background: var(--white); border: 1px solid var(--gray-200);
      border-radius: var(--radius-xl); box-shadow: var(--shadow-lg);
      min-height: 70vh; overflow: hidden;
    }
    .panel-head {
      display: flex; align-items: center; justify-content: space-between; gap: 8px;
      padding: 16px 20px; border-bottom: 1px solid var(--gray-200);
    }
    .panel-title { font-size: 0.95rem; font-weight: 700; color: var(--gray-900); }
    .panel-body { padding: 16px 20px; }

    /* ‚îÄ‚îÄ Form fields ‚îÄ‚îÄ */
    .field { display: flex; flex-direction: column; gap: 5px; }
    .field label {
      font-size: 0.75rem; color: var(--gray-500); font-weight: 700;
      text-transform: uppercase; letter-spacing: 0.05em;
    }
    .field input, .field textarea, .field select {
      border: 1px solid var(--gray-300); border-radius: var(--radius);
      padding: 10px 12px; font-size: 0.9rem; color: var(--gray-900); background: var(--white);
      transition: all 0.2s ease;
    }
    .field input:focus, .field textarea:focus, .field select:focus {
      outline: none; border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(79,70,229,0.1);
    }
    .field textarea { min-height: 78px; resize: vertical; }
    .field select {
      padding-right: 38px; appearance: none; -webkit-appearance: none; -moz-appearance: none;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%236B7280' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
      background-repeat: no-repeat; background-position: right 11px center; background-size: 15px 15px;
    }

    /* ‚îÄ‚îÄ Custom select ‚îÄ‚îÄ */
    .app-select { position: relative; }
    .app-select-button {
      width: 100%; display: flex; align-items: center; justify-content: space-between; gap: 8px;
      border: 1px solid var(--gray-300); border-radius: var(--radius);
      padding: 10px 12px; font-size: 0.9rem; color: var(--gray-900);
      background: var(--white); cursor: pointer; transition: all 0.2s ease;
    }
    .app-select-button:hover { border-color: var(--primary-light); }
    .app-select-button.open { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(79,70,229,0.1); }
    .app-select-button svg { width: 15px; height: 15px; color: var(--gray-500); transition: transform 0.2s ease; }
    .app-select-button.open svg { transform: rotate(180deg); }
    .app-select-label { overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    .app-select-menu {
      display: none; position: absolute; left: 0; right: 0; top: calc(100% + 6px);
      background: var(--white); border: 1px solid var(--gray-200);
      border-radius: var(--radius-md); box-shadow: var(--shadow-lg);
      z-index: 80; overflow: hidden; max-height: 260px; overflow-y: auto;
    }
    .app-select-menu.visible { display: block; animation: dropdownOpen 0.2s ease-out; }
    .app-select-item {
      width: 100%; border: none; background: var(--white); text-align: left;
      padding: 10px 12px; font-size: 0.9rem; color: var(--gray-700);
      cursor: pointer; transition: background 0.15s ease;
    }
    .app-select-item:hover { background: var(--gray-50); }
    .app-select-item.active { background: rgba(79,70,229,0.1); color: var(--primary-dark); font-weight: 600; }
    .q-answer-picker { margin-top: 4px; }

    /* ‚îÄ‚îÄ Search ‚îÄ‚îÄ */
    .search-box { margin-bottom: 12px; }

    /* ‚îÄ‚îÄ Lists ‚îÄ‚îÄ */
    .list { display: flex; flex-direction: column; gap: 8px; max-height: 68vh; overflow-y: auto; padding-right: 2px; }

    /* ‚îÄ‚îÄ Items (folder / pack) ‚îÄ‚îÄ */
    .item {
      border: 1px solid var(--gray-200); border-radius: var(--radius-md);
      padding: 12px 14px; background: var(--white);
      cursor: pointer; transition: all 0.25s ease;
    }
    .item:hover { border-color: var(--gray-300); box-shadow: var(--shadow-sm); transform: translateY(-1px); }
    .item.active { border-color: var(--primary); background: rgba(79,70,229,0.04); box-shadow: 0 0 0 3px rgba(79,70,229,0.08); }
    .item.dragging { opacity: 0.35; transform: scale(0.985); border-style: dashed; border-color: var(--primary); background: rgba(79,70,229,0.08); box-shadow: none; }
    .item.drop-target {
      border-color: var(--success);
      background: linear-gradient(135deg, rgba(16,185,129,0.12) 0%, rgba(14,165,233,0.08) 100%);
      box-shadow: 0 0 0 3px rgba(16,185,129,0.15);
      transform: translateY(-2px);
    }
    .item-head { display: flex; justify-content: space-between; gap: 8px; align-items: center; }
    .item-title { font-size: 0.9rem; font-weight: 700; color: var(--gray-900); }
    .item-sub { margin-top: 4px; font-size: 0.78rem; color: var(--gray-500); }

    /* ‚îÄ‚îÄ Split layout (pack editor) ‚îÄ‚îÄ */
    .split { display: grid; grid-template-columns: 340px 1fr; gap: 16px; }
    @media (max-width: 1200px) { .split { grid-template-columns: 1fr; } }

    /* ‚îÄ‚îÄ Meta grid ‚îÄ‚îÄ */
    .meta-grid { display: grid; grid-template-columns: repeat(2, minmax(0, 1fr)); gap: 10px; margin-bottom: 14px; }
    @media (max-width: 700px) { .meta-grid { grid-template-columns: 1fr; } }

    /* ‚îÄ‚îÄ Editor ‚îÄ‚îÄ */
    .editor-wrap { display: none; }
    .editor-wrap.visible { display: block; animation: fadeSlideIn 0.3s ease-out; }
    .empty {
      color: var(--gray-500); font-size: 0.9rem; padding: 20px;
      border: 1px dashed var(--gray-300); border-radius: var(--radius-md);
      background: var(--gray-50); text-align: center;
    }

    /* ‚îÄ‚îÄ Editor tabs ‚îÄ‚îÄ */
    .editor-tabs {
      display: flex; gap: 4px; margin-bottom: 14px;
      background: var(--gray-100); border-radius: var(--radius-md); padding: 4px;
    }
    .editor-tab {
      flex: 1; border: none; background: transparent; border-radius: var(--radius);
      padding: 10px 12px; font-size: 0.82rem; font-weight: 600;
      color: var(--gray-600); cursor: pointer; transition: all 0.2s ease; text-align: center;
    }
    .editor-tab:hover { color: var(--gray-900); }
    .editor-tab.active { background: var(--white); color: var(--gray-900); box-shadow: var(--shadow-sm); }

    .editor-pane { display: none; }
    .editor-pane.active { display: block; animation: fadeIn 0.25s ease-out; }

    /* ‚îÄ‚îÄ Notes view ‚îÄ‚îÄ */
    .notes-view {
      border: 1px solid var(--gray-200); border-radius: var(--radius-md);
      background: var(--gray-50); padding: 20px; max-height: 60vh; overflow-y: auto;
      font-size: 0.92rem; line-height: 1.7;
    }
    .notes-view h1, .notes-view h2, .notes-view h3 { margin-top: 20px; margin-bottom: 10px; color: var(--gray-900); }
    .notes-view h1 { font-size: 1.4rem; border-bottom: 2px solid var(--gray-200); padding-bottom: 8px; }
    .notes-view h2 { font-size: 1.15rem; }
    .notes-view h3 { font-size: 1rem; }

    /* ‚îÄ‚îÄ Editor toolbar & cards ‚îÄ‚îÄ */
    .editor-toolbar {
      display: flex; justify-content: space-between; align-items: center; gap: 8px;
      flex-wrap: wrap; margin-bottom: 10px;
    }
    .editor-count { font-size: 0.82rem; color: var(--gray-500); font-weight: 600; }
    .editor-list { display: flex; flex-direction: column; gap: 10px; max-height: 58vh; overflow-y: auto; padding-right: 2px; }
    .editor-card {
      border: 1px solid var(--gray-200); border-radius: var(--radius-md);
      background: var(--white); padding: 14px;
      transition: all 0.25s ease;
    }
    .editor-card:hover { border-color: var(--gray-300); box-shadow: var(--shadow-sm); }
    .editor-card.newly-added {
      border-color: var(--success); box-shadow: 0 0 0 3px rgba(16,185,129,0.12);
      animation: highlightPulse 0.6s ease-out;
    }
    .editor-card-head { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
    .editor-card-title { font-size: 0.8rem; color: var(--gray-500); font-weight: 700; text-transform: uppercase; letter-spacing: 0.05em; }

    .q-options-grid { display: grid; grid-template-columns: repeat(2, minmax(0, 1fr)); gap: 8px; }
    @media (max-width: 700px) { .q-options-grid { grid-template-columns: 1fr; } }

    /* ‚îÄ‚îÄ Learn stage (fullscreen overlay) ‚îÄ‚îÄ */
    .learn-stage {
      position: fixed; inset: 0; z-index: 300;
      background: linear-gradient(135deg, var(--gray-50) 0%, var(--gray-100) 100%);
      display: none; opacity: 0;
      transition: opacity 0.35s ease;
    }
    .learn-stage::before {
      content: ''; position: absolute; inset: 0; pointer-events: none;
      background:
        radial-gradient(circle at 15% 15%, rgba(79,70,229,0.12), transparent 50%),
        radial-gradient(circle at 85% 25%, rgba(14,165,233,0.10), transparent 50%),
        radial-gradient(circle at 50% 85%, rgba(79,70,229,0.06), transparent 50%);
    }
    .learn-stage.visible { display: block; opacity: 1; }
    .learn-stage.entering { display: block; opacity: 0; }

    .learn-shell { height: 100%; display: flex; flex-direction: column; padding: 20px; position: relative; z-index: 1; }
    .learn-top {
      display: flex; justify-content: space-between; align-items: center; gap: 12px;
      background: rgba(255,255,255,0.95); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);
      border: 1px solid var(--gray-200);
      border-radius: var(--radius-lg); box-shadow: var(--shadow-lg); padding: 14px 20px;
    }
    .learn-title { font-size: 1.05rem; font-weight: 700; color: var(--gray-900); }
    .learn-sub { font-size: 0.82rem; color: var(--gray-500); }
    .learn-body { flex: 1; min-height: 0; display: grid; place-items: center; padding: 16px 0; }
    .learn-card {
      width: min(1000px, 100%); max-height: 100%;
      background: rgba(255,255,255,0.96);
      border: 1px solid var(--gray-200);
      border-radius: var(--radius-xl); box-shadow: var(--shadow-xl);
      padding: 24px; display: flex; flex-direction: column; gap: 16px;
      overflow-y: auto;
    }

    /* ‚îÄ‚îÄ Learn tabs (pill style matching index) ‚îÄ‚îÄ */
    .learn-tabs {
      display: flex; gap: 4px;
      background: var(--gray-100); border-radius: var(--radius-md); padding: 4px;
    }
    .learn-tab {
      flex: 1; border: none; background: transparent; border-radius: var(--radius);
      padding: 10px 12px; font-size: 0.82rem; font-weight: 600;
      color: var(--gray-600); cursor: pointer; transition: all 0.2s ease; text-align: center;
    }
    .learn-tab:hover { color: var(--gray-900); }
    .learn-tab.active { background: var(--white); color: var(--gray-900); box-shadow: var(--shadow-sm); }

    .learn-pane { display: none; min-height: 0; }
    .learn-pane.active { display: block; animation: fadeIn 0.25s ease-out; }

    /* ‚îÄ‚îÄ Learn notes ‚îÄ‚îÄ */
    .learn-notes {
      border: 1px solid var(--gray-200); border-radius: var(--radius-md);
      background: var(--gray-50); padding: 20px; max-height: 60vh; overflow-y: auto;
      font-size: 0.95rem; line-height: 1.75;
    }
    .learn-notes h1, .learn-notes h2, .learn-notes h3 { margin-top: 20px; margin-bottom: 10px; color: var(--gray-900); }

    /* ‚îÄ‚îÄ 3D Flashcard (matching index.html) ‚îÄ‚îÄ */
    .flashcard-stage { display: flex; flex-direction: column; align-items: center; gap: 14px; }
    .flashcard-3d { width: min(100%, 860px); height: 340px; perspective: 1200px; cursor: pointer; }
    .flashcard-inner {
      position: relative; width: 100%; height: 100%;
      transform-style: preserve-3d;
      transition: transform 0.55s ease;
    }
    .flashcard-inner.flipped { transform: rotateY(180deg); }
    .flashcard-face {
      position: absolute; inset: 0; backface-visibility: hidden;
      border-radius: var(--radius-lg); border: 1px solid var(--gray-200);
      background: linear-gradient(135deg, rgba(79,70,229,0.06) 0%, rgba(14,165,233,0.08) 100%);
      box-shadow: var(--shadow-md);
      display: flex; align-items: center; justify-content: center;
      padding: 30px; text-align: center;
    }
    .flashcard-face.back {
      transform: rotateY(180deg);
      background: linear-gradient(135deg, rgba(14,165,233,0.08) 0%, rgba(79,70,229,0.06) 100%);
    }
    .flashcard-label {
      position: absolute; top: 16px; left: 16px;
      font-size: 0.7rem; color: var(--gray-400); font-weight: 700;
      text-transform: uppercase; letter-spacing: 0.06em;
    }
    .flashcard-text { font-size: 1.15rem; color: var(--gray-900); line-height: 1.65; white-space: pre-wrap; max-height: 260px; overflow-y: auto; }
    .learn-controls { display: flex; justify-content: center; align-items: center; flex-wrap: wrap; gap: 10px; }
    .learn-progress { font-size: 0.85rem; color: var(--gray-500); min-width: 120px; text-align: center; font-weight: 500; }

    /* ‚îÄ‚îÄ Quiz (learn mode) ‚îÄ‚îÄ */
    .quiz-head { display: flex; justify-content: space-between; align-items: center; gap: 10px; margin-bottom: 10px; font-size: 0.9rem; font-weight: 600; color: var(--gray-700); }
    .quiz-question { font-size: 1.1rem; font-weight: 700; margin-bottom: 14px; color: var(--gray-900); line-height: 1.5; }
    .quiz-options { display: grid; gap: 10px; }
    .quiz-option {
      width: 100%; text-align: left;
      border: 1px solid var(--gray-300); background: var(--white);
      border-radius: var(--radius); padding: 12px 16px;
      font-size: 0.9375rem; color: var(--gray-800);
      cursor: pointer; transition: all 0.2s ease;
    }
    .quiz-option:hover:not(:disabled) { border-color: var(--primary-light); background: var(--gray-50); }
    .quiz-option.correct { border-color: var(--success); background: rgba(16,185,129,0.12); color: #065F46; }
    .quiz-option.wrong { border-color: var(--error); background: rgba(239,68,68,0.12); color: #991B1B; }
    .quiz-option:disabled { cursor: default; }
    .quiz-expl {
      margin-top: 10px; border: 1px solid rgba(14,165,233,0.2);
      border-radius: var(--radius); background: rgba(14,165,233,0.06);
      padding: 12px 16px; font-size: 0.9rem; color: var(--gray-700); line-height: 1.5;
      display: none;
    }
    .quiz-expl.visible { display: block; animation: fadeSlideIn 0.25s ease-out; }

    /* ‚îÄ‚îÄ Modals ‚îÄ‚îÄ */
    .modal-overlay {
      position: fixed; inset: 0; z-index: 260;
      background: rgba(0, 0, 0, 0.5);
      display: none; align-items: center; justify-content: center; padding: 18px;
      opacity: 0; transition: opacity 0.25s ease;
    }
    .modal-overlay.visible { display: flex; opacity: 1; }
    .modal-overlay.entering { display: flex; opacity: 0; }
    .modal {
      width: min(560px, 100%);
      background: var(--white); border: 1px solid var(--gray-200);
      border-radius: var(--radius-xl); box-shadow: var(--shadow-xl);
      padding: 24px;
      transform: scale(0.95); opacity: 0;
      transition: all 0.25s ease;
    }
    .modal-overlay.visible .modal { transform: scale(1); opacity: 1; }
    .modal-head { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
    .modal-title { font-size: 1.1rem; font-weight: 700; color: var(--gray-900); }
    .modal-grid { display: grid; grid-template-columns: repeat(2, minmax(0, 1fr)); gap: 10px; }
    @media (max-width: 620px) { .modal-grid { grid-template-columns: 1fr; } }
    .modal-message { font-size: 0.92rem; color: var(--gray-700); margin-bottom: 16px; line-height: 1.5; }

    /* ‚îÄ‚îÄ Toast (matching index) ‚îÄ‚îÄ */
    .toast {
      position: fixed; bottom: 24px; left: 50%;
      transform: translateX(-50%) translateY(100px);
      background: var(--gray-900); color: var(--white);
      border-radius: var(--radius-md); padding: 14px 24px;
      font-size: 0.9375rem; font-weight: 500;
      box-shadow: var(--shadow-xl);
      opacity: 0; transition: all 0.3s ease; z-index: 500;
      display: flex; align-items: center; gap: 10px;
    }
    .toast.visible { transform: translateX(-50%) translateY(0); opacity: 1; }
    .toast.success { background: var(--success); }
    .toast.error { background: var(--error); }

    /* ‚îÄ‚îÄ Animations ‚îÄ‚îÄ */
    @keyframes dropdownOpen {
      from { opacity: 0; transform: translateY(-8px); }
      to { opacity: 1; transform: translateY(0); }
    }
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    @keyframes fadeSlideIn {
      from { opacity: 0; transform: translateY(8px); }
      to { opacity: 1; transform: translateY(0); }
    }
    @keyframes highlightPulse {
      0% { box-shadow: 0 0 0 0 rgba(16,185,129,0.35); }
      100% { box-shadow: 0 0 0 3px rgba(16,185,129,0.12); }
    }
    @keyframes modalOpen {
      from { opacity: 0; transform: scale(0.95); }
      to { opacity: 1; transform: scale(1); }
    }

    /* ‚îÄ‚îÄ Mobile tweaks ‚îÄ‚îÄ */
    @media (max-width: 600px) {
      .container { padding: 12px; }
      .topbar { padding: 12px 14px; flex-direction: column; align-items: stretch; gap: 10px; position: static; }
      .topbar .actions { justify-content: flex-end; }
      .learn-top { flex-direction: column; align-items: stretch; gap: 10px; }
      .learn-top .actions { justify-content: flex-end; }
      .learn-card { padding: 16px; }
      .flashcard-3d { height: 280px; }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="topbar">
      <div class="topbar-logo">
        <div class="topbar-logo-icon">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"></path><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"></path></svg>
        </div>
        <div>
          <h1>Study Library</h1>
          <div class="topbar-sub" id="user-meta">Checking sign-in...</div>
        </div>
      </div>
      <div class="actions">
        <button class="btn" id="back-app-btn"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 5 12 12 5"></polyline></svg>Back to App</button>
        <button class="btn" id="fullscreen-btn"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 3 21 3 21 9"></polyline><polyline points="9 21 3 21 3 15"></polyline><line x1="21" y1="3" x2="14" y2="10"></line><line x1="3" y1="21" x2="10" y2="14"></line></svg>Fullscreen Learn</button>
        <button class="btn primary" id="auth-btn">Sign in</button>
      </div>
    </div>

    <div class="grid" id="library-grid">
      <aside class="panel">
        <div class="panel-head">
          <span class="panel-title">Folders</span>
          <div class="actions">
            <button class="btn" id="new-folder-btn">+ Folder</button>
            <button class="btn danger" id="delete-folder-btn">Delete</button>
          </div>
        </div>
        <div class="panel-body">
          <div class="field search-box">
            <label>Search</label>
            <input id="search-input" placeholder="Filter packs by title, course or subject">
          </div>
          <div class="list" id="folder-list"></div>
        </div>
      </aside>

      <section class="panel">
        <div class="panel-head">
          <span class="panel-title">Study Packs</span>
          <div class="actions">
            <button class="btn" id="save-pack-btn">Save Changes</button>
            <button class="btn danger" id="delete-pack-btn">Delete Pack</button>
          </div>
        </div>
        <div class="panel-body">
          <div class="split">
            <div>
              <div class="list" id="pack-list"></div>
            </div>
            <div>
              <div class="empty" id="pack-empty">Select a study pack to edit and study.</div>
              <div class="editor-wrap" id="pack-editor-wrap">
                <div class="meta-grid">
                  <div class="field"><label>Title</label><input id="pack-title"></div>
                  <div class="field">
                    <label>Folder</label>
                    <input type="hidden" id="pack-folder-select" value="">
                    <div class="app-select" id="pack-folder-picker">
                      <button type="button" class="app-select-button" id="pack-folder-button">
                        <span class="app-select-label" id="pack-folder-label">No folder</span>
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"></polyline></svg>
                      </button>
                      <div class="app-select-menu" id="pack-folder-menu"></div>
                    </div>
                  </div>
                  <div class="field"><label>Course</label><input id="pack-course"></div>
                  <div class="field"><label>Subject</label><input id="pack-subject"></div>
                  <div class="field"><label>Semester</label><input id="pack-semester"></div>
                  <div class="field"><label>Block</label><input id="pack-block"></div>
                </div>
                <div class="actions" style="margin-bottom:14px;">
                  <button class="btn" id="export-pack-csv-btn"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>Export Flashcards CSV</button>
                  <button class="btn primary" id="open-learn-btn"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="5 3 19 12 5 21 5 3"></polygon></svg>Learn Mode</button>
                </div>

                <div class="editor-tabs">
                  <button class="editor-tab active" data-editor-pane="notes">üìÑ Notes</button>
                  <button class="editor-tab" data-editor-pane="flashcards">üóÇÔ∏è Flashcards</button>
                  <button class="editor-tab" data-editor-pane="test">üìù Practice Test</button>
                </div>

                <div class="editor-pane active" id="editor-pane-notes">
                  <div class="notes-view" id="notes-view"></div>
                </div>

                <div class="editor-pane" id="editor-pane-flashcards">
                  <div class="editor-toolbar">
                    <span class="editor-count" id="flashcard-count">0 flashcards</span>
                    <button class="btn" id="add-flashcard-btn">+ Add flashcard</button>
                  </div>
                  <div class="editor-list" id="flashcard-editor-list"></div>
                </div>

                <div class="editor-pane" id="editor-pane-test">
                  <div class="editor-toolbar">
                    <span class="editor-count" id="question-count">0 practice questions</span>
                    <button class="btn" id="add-question-btn">+ Add question</button>
                  </div>
                  <div class="editor-list" id="question-editor-list"></div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </section>
    </div>
  </div>

  <!-- Learn Stage -->
  <div class="learn-stage" id="learn-stage">
    <div class="learn-shell">
      <div class="learn-top">
        <div>
          <div class="learn-title" id="learn-title">Learn Mode</div>
          <div class="learn-sub" id="learn-sub">Focused study session</div>
        </div>
        <div class="actions">
          <button class="btn" id="learn-back-app-btn"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 5 12 12 5"></polyline></svg>Back to App</button>
          <button class="btn" id="learn-back-library-btn"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 4h18v16H3z"></path><line x1="3" y1="10" x2="21" y2="10"></line><line x1="9" y1="4" x2="9" y2="20"></line></svg>Study Library</button>
          <button class="btn" id="learn-fullscreen-btn"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 3 21 3 21 9"></polyline><polyline points="9 21 3 21 3 15"></polyline><line x1="21" y1="3" x2="14" y2="10"></line><line x1="3" y1="21" x2="10" y2="14"></line></svg>Fullscreen</button>
        </div>
      </div>
      <div class="learn-body">
        <div class="learn-card">
          <div class="learn-tabs">
            <button class="learn-tab active" data-learn-pane="notes">üìÑ Notes</button>
            <button class="learn-tab" data-learn-pane="flashcards">üóÇÔ∏è Flashcards</button>
            <button class="learn-tab" data-learn-pane="test">üìù Practice Test</button>
          </div>

          <div class="learn-pane active" id="learn-pane-notes">
            <div class="learn-notes" id="learn-notes-content"></div>
          </div>

          <div class="learn-pane" id="learn-pane-flashcards">
            <div class="flashcard-stage">
              <div class="flashcard-3d" id="learn-flashcard-3d">
                <div class="flashcard-inner" id="learn-flashcard-inner">
                  <div class="flashcard-face front">
                    <span class="flashcard-label">Front</span>
                    <div class="flashcard-text" id="learn-flashcard-front"></div>
                  </div>
                  <div class="flashcard-face back">
                    <span class="flashcard-label">Back</span>
                    <div class="flashcard-text" id="learn-flashcard-back"></div>
                  </div>
                </div>
              </div>
              <div class="learn-controls">
                <button class="btn" id="learn-f-prev">Previous</button>
                <button class="btn" id="learn-f-flip">Flip</button>
                <button class="btn" id="learn-f-next">Next</button>
                <span class="learn-progress" id="learn-f-progress">Card 0 of 0</span>
              </div>
            </div>
          </div>

          <div class="learn-pane" id="learn-pane-test">
            <div class="quiz-head">
              <span id="learn-q-progress">Question 0 of 0</span>
              <span id="learn-q-score">Score: 0/0</span>
            </div>
            <div class="quiz-question" id="learn-q-text"></div>
            <div class="quiz-options" id="learn-q-options"></div>
            <div class="quiz-expl" id="learn-q-expl"></div>
            <div class="actions" style="margin-top:12px;">
              <button class="btn" id="learn-q-next">Next question</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Folder Modal -->
  <div class="modal-overlay" id="folder-modal-overlay">
    <div class="modal">
      <div class="modal-head">
        <span class="modal-title" id="folder-modal-title">New Folder</span>
        <button class="btn" id="folder-modal-close">‚úï</button>
      </div>
      <div class="modal-grid" style="margin-bottom:14px;">
        <div class="field"><label>Folder Name *</label><input id="folder-name-input"></div>
        <div class="field"><label>Course</label><input id="folder-course-input"></div>
        <div class="field"><label>Subject</label><input id="folder-subject-input"></div>
        <div class="field"><label>Semester</label><input id="folder-semester-input"></div>
        <div class="field"><label>Block</label><input id="folder-block-input"></div>
      </div>
      <div class="actions" style="justify-content:flex-end;">
        <button class="btn" id="folder-modal-cancel">Cancel</button>
        <button class="btn primary" id="folder-modal-save">Save Folder</button>
      </div>
    </div>
  </div>

  <!-- Confirm Modal -->
  <div class="modal-overlay" id="confirm-modal-overlay">
    <div class="modal">
      <div class="modal-head">
        <span class="modal-title" id="confirm-modal-title">Confirm Action</span>
        <button class="btn" id="confirm-modal-close">‚úï</button>
      </div>
      <p class="modal-message" id="confirm-modal-message"></p>
      <div class="actions" style="justify-content:flex-end;">
        <button class="btn" id="confirm-modal-cancel">Cancel</button>
        <button class="btn danger" id="confirm-modal-confirm">Delete</button>
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>
<script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth-compat.js"></script>
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyBAAeEUCPNvP5qnqpP3M6HnFZ6vaaijUvM",
      authDomain: "lecture-processor-cdff6.firebaseapp.com",
      projectId: "lecture-processor-cdff6",
      storageBucket: "lecture-processor-cdff6.firebasestorage.app",
      messagingSenderId: "374793454161",
      appId: "1:374793454161:web:c68b21590e9a1fafa32e70"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();

    let token = null;
    let folders = [];
    let packs = [];
    let selectedFolderId = '';
    let selectedPackId = '';
    let selectedPack = null;
    let activeEditorPane = 'notes';
    let exportType = 'flashcards';
    let draggedPackId = '';
    let folderModalMode = 'create';
    let editingFolderId = '';
    let pendingOpenPackId = '';
    let confirmModalResolver = null;

    let learnFlashcardIndex = 0;
    let learnFlashcardFlipped = false;
    let learnQuestionIndex = 0;
    let learnScore = 0;
    let learnAnswered = false;
    let activeLearnPane = 'notes';

    const urlParams = new URLSearchParams(window.location.search);
    const learnPackFromUrl = urlParams.get('pack_id') || '';
    const openLearnFromUrl = urlParams.get('mode') === 'learn';
    const fullscreenFromUrl = urlParams.get('fullscreen') === '1';
    let autoLearnConsumed = false;

    /* ‚îÄ‚îÄ DOM refs ‚îÄ‚îÄ */
    const userMeta = document.getElementById('user-meta');
    const authBtn = document.getElementById('auth-btn');
    const backAppBtn = document.getElementById('back-app-btn');
    const fullscreenBtn = document.getElementById('fullscreen-btn');
    const searchInput = document.getElementById('search-input');
    const folderList = document.getElementById('folder-list');
    const packList = document.getElementById('pack-list');
    const newFolderBtn = document.getElementById('new-folder-btn');
    const deleteFolderBtn = document.getElementById('delete-folder-btn');
    const packEmpty = document.getElementById('pack-empty');
    const packEditorWrap = document.getElementById('pack-editor-wrap');
    const packTitle = document.getElementById('pack-title');
    const packFolderSelect = document.getElementById('pack-folder-select');
    const packFolderPicker = document.getElementById('pack-folder-picker');
    const packFolderButton = document.getElementById('pack-folder-button');
    const packFolderLabel = document.getElementById('pack-folder-label');
    const packFolderMenu = document.getElementById('pack-folder-menu');
    const packCourse = document.getElementById('pack-course');
    const packSubject = document.getElementById('pack-subject');
    const packSemester = document.getElementById('pack-semester');
    const packBlock = document.getElementById('pack-block');
    const notesView = document.getElementById('notes-view');
    const savePackBtn = document.getElementById('save-pack-btn');
    const deletePackBtn = document.getElementById('delete-pack-btn');
    const exportPackCsvBtn = document.getElementById('export-pack-csv-btn');
    const openLearnBtn = document.getElementById('open-learn-btn');
    const editorTabs = document.querySelectorAll('.editor-tab');
    const flashcardCount = document.getElementById('flashcard-count');
    const questionCount = document.getElementById('question-count');
    const addFlashcardBtn = document.getElementById('add-flashcard-btn');
    const addQuestionBtn = document.getElementById('add-question-btn');
    const flashcardEditorList = document.getElementById('flashcard-editor-list');
    const questionEditorList = document.getElementById('question-editor-list');
    const learnStage = document.getElementById('learn-stage');
    const learnTitle = document.getElementById('learn-title');
    const learnSub = document.getElementById('learn-sub');
    const learnBackAppBtn = document.getElementById('learn-back-app-btn');
    const learnBackLibraryBtn = document.getElementById('learn-back-library-btn');
    const learnFullscreenBtn = document.getElementById('learn-fullscreen-btn');
    const learnTabs = document.querySelectorAll('.learn-tab');
    const learnNotesContent = document.getElementById('learn-notes-content');
    const learnFlashcard3d = document.getElementById('learn-flashcard-3d');
    const learnFlashcardInner = document.getElementById('learn-flashcard-inner');
    const learnFlashcardFront = document.getElementById('learn-flashcard-front');
    const learnFlashcardBack = document.getElementById('learn-flashcard-back');
    const learnFPrev = document.getElementById('learn-f-prev');
    const learnFFlip = document.getElementById('learn-f-flip');
    const learnFNext = document.getElementById('learn-f-next');
    const learnFProgress = document.getElementById('learn-f-progress');
    const learnQProgress = document.getElementById('learn-q-progress');
    const learnQScore = document.getElementById('learn-q-score');
    const learnQText = document.getElementById('learn-q-text');
    const learnQOptions = document.getElementById('learn-q-options');
    const learnQExpl = document.getElementById('learn-q-expl');
    const learnQNext = document.getElementById('learn-q-next');
    const folderModalOverlay = document.getElementById('folder-modal-overlay');
    const folderModalTitle = document.getElementById('folder-modal-title');
    const folderModalClose = document.getElementById('folder-modal-close');
    const folderModalCancel = document.getElementById('folder-modal-cancel');
    const folderModalSave = document.getElementById('folder-modal-save');
    const folderNameInput = document.getElementById('folder-name-input');
    const folderCourseInput = document.getElementById('folder-course-input');
    const folderSubjectInput = document.getElementById('folder-subject-input');
    const folderSemesterInput = document.getElementById('folder-semester-input');
    const folderBlockInput = document.getElementById('folder-block-input');
    const confirmModalOverlay = document.getElementById('confirm-modal-overlay');
    const confirmModalTitle = document.getElementById('confirm-modal-title');
    const confirmModalMessage = document.getElementById('confirm-modal-message');
    const confirmModalClose = document.getElementById('confirm-modal-close');
    const confirmModalCancel = document.getElementById('confirm-modal-cancel');
    const confirmModalConfirm = document.getElementById('confirm-modal-confirm');
    const toastEl = document.getElementById('toast');

    /* ‚îÄ‚îÄ Toast ‚îÄ‚îÄ */
    function showToast(message, type = 'success') {
      toastEl.textContent = message;
      toastEl.className = `toast visible ${type}`;
      setTimeout(() => toastEl.classList.remove('visible'), 2800);
    }

    /* ‚îÄ‚îÄ Markdown ‚îÄ‚îÄ */
    function mdToHtml(md) {
      if (!md) return '';
      let h = md.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;')
        .replace(/^### (.*$)/gm, '<h3>$1</h3>')
        .replace(/^## (.*$)/gm, '<h2>$1</h2>')
        .replace(/^# (.*$)/gm, '<h1>$1</h1>')
        .replace(/\*\*\*(.*?)\*\*\*/g, '<strong><em>$1</em></strong>')
        .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
        .replace(/\*(.*?)\*/g, '<em>$1</em>')
        .replace(/^\s*[-*]\s+(.*$)/gm, '<li>$1</li>')
        .replace(/\n\n/g, '</p><p>')
        .replace(/\n/g, '<br>');
      h = `<p>${h}</p>`;
      h = h.replace(/(<li>.*?<\/li>)(?=\s*<li>|<br><li>)/g, '$1')
        .replace(/(<li>.*?<\/li>)+/g, '<ul>$&</ul>')
        .replace(/<br><li>/g, '<li>');
      h = h.replace(/<p><\/p>/g, '').replace(/<p>(<h[1-3]>)/g, '$1').replace(/(<\/h[1-3]>)<\/p>/g, '$1')
        .replace(/<p>(<ul>)/g, '$1').replace(/(<\/ul>)<\/p>/g, '$1');
      return h;
    }

    /* ‚îÄ‚îÄ API helpers ‚îÄ‚îÄ */
    async function api(path, options = {}) {
      const headers = options.headers || {};
      headers['Authorization'] = `Bearer ${token}`;
      if (options.body && !headers['Content-Type']) headers['Content-Type'] = 'application/json';
      const res = await fetch(path, { ...options, headers });
      const isJson = (res.headers.get('content-type') || '').includes('application/json');
      const data = isJson ? await res.json() : null;
      if (!res.ok) throw new Error((data && data.error) || 'Request failed');
      return data;
    }

    async function authenticatedFetch(path, options = {}, allowRefresh = true) {
      if (!auth.currentUser) throw new Error('Please sign in to continue');
      if (!token) token = await auth.currentUser.getIdToken();
      const headers = { ...(options.headers || {}), Authorization: `Bearer ${token}` };
      const response = await fetch(path, { ...options, headers });
      if (response.status === 401 && allowRefresh) {
        token = await auth.currentUser.getIdToken(true);
        const retryHeaders = { ...(options.headers || {}), Authorization: `Bearer ${token}` };
        return fetch(path, { ...options, headers: retryHeaders });
      }
      return response;
    }

    function parseFilenameFromDisposition(disposition, fallbackName) {
      if (!disposition) return fallbackName;
      const utfMatch = disposition.match(/filename\*=UTF-8''([^;]+)/i);
      if (utfMatch && utfMatch[1]) return decodeURIComponent(utfMatch[1].trim());
      const asciiMatch = disposition.match(/filename="?([^";]+)"?/i);
      if (asciiMatch && asciiMatch[1]) return asciiMatch[1].trim();
      return fallbackName;
    }

    async function downloadStudyPackCsv(packId, type) {
      const fallbackName = type === 'test' ? `study-pack-${packId}-practice-test.csv` : `study-pack-${packId}-flashcards.csv`;
      const response = await authenticatedFetch(`/api/study-packs/${encodeURIComponent(packId)}/export-flashcards-csv?type=${encodeURIComponent(type)}`, { method: 'GET' });
      if (!response.ok) {
        let message = 'Could not export CSV';
        try { const data = await response.json(); message = data.error || message; } catch (e) {}
        throw new Error(message);
      }
      const blob = await response.blob();
      const filename = parseFilenameFromDisposition(response.headers.get('content-disposition') || '', fallbackName);
      const url = URL.createObjectURL(blob);
      const anchor = document.createElement('a');
      anchor.href = url; anchor.download = filename;
      document.body.appendChild(anchor); anchor.click();
      document.body.removeChild(anchor); URL.revokeObjectURL(url);
    }

    /* ‚îÄ‚îÄ Modal helpers ‚îÄ‚îÄ */
    function openModal(overlay) {
      overlay.classList.add('entering');
      requestAnimationFrame(() => {
        requestAnimationFrame(() => overlay.classList.replace('entering', 'visible'));
      });
    }
    function closeModal(overlay) {
      overlay.classList.remove('visible');
    }

    function openConfirmModal(title, message, confirmLabel = 'Delete') {
      confirmModalTitle.textContent = title;
      confirmModalMessage.textContent = message;
      confirmModalConfirm.textContent = confirmLabel;
      openModal(confirmModalOverlay);
      return new Promise(resolve => { confirmModalResolver = resolve; });
    }
    function closeConfirmModal(confirmed) {
      closeModal(confirmModalOverlay);
      if (confirmModalResolver) { confirmModalResolver(Boolean(confirmed)); confirmModalResolver = null; }
    }

    /* ‚îÄ‚îÄ Editor pane switching ‚îÄ‚îÄ */
    function setEditorPane(pane) {
      activeEditorPane = pane;
      editorTabs.forEach(btn => btn.classList.toggle('active', btn.dataset.editorPane === pane));
      document.getElementById('editor-pane-notes').classList.toggle('active', pane === 'notes');
      document.getElementById('editor-pane-flashcards').classList.toggle('active', pane === 'flashcards');
      document.getElementById('editor-pane-test').classList.toggle('active', pane === 'test');
      if (pane === 'test') { exportType = 'test'; exportPackCsvBtn.querySelector('svg + *') || (exportPackCsvBtn.childNodes[exportPackCsvBtn.childNodes.length - 1].textContent = 'Export Practice Test CSV'); }
      else { exportType = 'flashcards'; exportPackCsvBtn.childNodes[exportPackCsvBtn.childNodes.length - 1].textContent = 'Export Flashcards CSV'; }
    }

    /* ‚îÄ‚îÄ Data helpers ‚îÄ‚îÄ */
    function filteredPacks() {
      const query = searchInput.value.trim().toLowerCase();
      return packs.filter(pack => {
        if (selectedFolderId && pack.folder_id !== selectedFolderId) return false;
        if (!query) return true;
        const text = `${pack.title || ''} ${pack.course || ''} ${pack.subject || ''} ${pack.semester || ''} ${pack.block || ''}`.toLowerCase();
        return text.includes(query);
      });
    }

    async function movePackToFolder(packId, folderId) {
      try {
        await api(`/api/study-packs/${encodeURIComponent(packId)}`, { method: 'PATCH', body: JSON.stringify({ folder_id: folderId }) });
        showToast('Study pack moved.');
        await loadData(packId);
      } catch (e) { showToast(e.message || 'Could not move pack.', 'error'); }
    }

    /* ‚îÄ‚îÄ Render folders ‚îÄ‚îÄ */
    function renderFolders() {
      const allFolders = [{ folder_id: '', name: 'All Study Packs', course: '', subject: '', semester: '', block: '' }, ...folders];
      folderList.innerHTML = '';
      allFolders.forEach(folder => {
        const div = document.createElement('div');
        div.className = `item ${selectedFolderId === folder.folder_id ? 'active' : ''}`;
        div.dataset.folderId = folder.folder_id;
        div.innerHTML = `
          <div class="item-head">
            <span class="item-title">${folder.name}</span>
            ${folder.folder_id ? '<button class="btn" data-edit-folder="1" style="padding:5px 8px;font-size:0.75rem;">Edit</button>' : ''}
          </div>
          <div class="item-sub">${[folder.course, folder.subject, folder.semester, folder.block].filter(Boolean).join(' ¬∑ ') || (folder.folder_id ? 'No metadata' : 'All packs')}</div>
        `;
        div.addEventListener('click', (e) => {
          if (e.target.closest('[data-edit-folder]')) return;
          selectedFolderId = folder.folder_id;
          renderFolders(); renderPacks();
        });
        if (folder.folder_id) {
          div.querySelector('[data-edit-folder]').addEventListener('click', (e) => { e.stopPropagation(); openFolderModal('edit', folder); });
        }
        div.addEventListener('dragover', (e) => { e.preventDefault(); if (draggedPackId && folder.folder_id) div.classList.add('drop-target'); });
        div.addEventListener('dragleave', () => div.classList.remove('drop-target'));
        div.addEventListener('drop', async (e) => {
          e.preventDefault(); div.classList.remove('drop-target');
          if (!draggedPackId || !folder.folder_id) return;
          await movePackToFolder(draggedPackId, folder.folder_id); draggedPackId = '';
        });
        folderList.appendChild(div);
      });
    }

    function getFolderNameById(folderId) {
      if (!folderId) return 'No folder';
      const folder = folders.find(item => item.folder_id === folderId);
      return folder ? folder.name : 'No folder';
    }

    function setPackFolderSelection(folderId) {
      const normalized = folderId || '';
      packFolderSelect.value = normalized;
      packFolderLabel.textContent = getFolderNameById(normalized);
      packFolderMenu.querySelectorAll('.app-select-item').forEach(item => item.classList.toggle('active', item.dataset.value === normalized));
    }

    function renderFolderSelect() {
      const items = [{ folder_id: '', name: 'No folder' }, ...folders.map(f => ({ folder_id: f.folder_id, name: f.name }))];
      packFolderMenu.innerHTML = '';
      items.forEach(item => {
        const button = document.createElement('button');
        button.type = 'button'; button.className = 'app-select-item'; button.dataset.value = item.folder_id; button.textContent = item.name;
        button.addEventListener('click', () => {
          setPackFolderSelection(item.folder_id);
          packFolderMenu.classList.remove('visible'); packFolderButton.classList.remove('open');
        });
        packFolderMenu.appendChild(button);
      });
      setPackFolderSelection(packFolderSelect.value || '');
    }

    /* ‚îÄ‚îÄ Render packs ‚îÄ‚îÄ */
    function renderPacks() {
      const items = filteredPacks();
      packList.innerHTML = '';
      if (!items.length) { packList.innerHTML = '<div class="empty">No study packs match this filter.</div>'; return; }
      items.forEach(pack => {
        const div = document.createElement('div');
        div.className = `item ${selectedPackId === pack.study_pack_id ? 'active' : ''}`;
        div.draggable = true; div.dataset.packId = pack.study_pack_id;
        div.innerHTML = `
          <div class="item-head"><span class="item-title">${pack.title || 'Untitled pack'}</span></div>
          <div class="item-sub">${pack.mode} ¬∑ ${pack.flashcards_count} cards ¬∑ ${pack.test_questions_count} questions</div>
          <div class="item-sub">${[pack.course, pack.subject, pack.semester, pack.block].filter(Boolean).join(' ¬∑ ') || (pack.folder_name ? `Folder: ${pack.folder_name}` : 'No metadata')}</div>
        `;
        div.addEventListener('click', async () => { selectedPackId = pack.study_pack_id; renderPacks(); await openPack(pack.study_pack_id); });
        div.addEventListener('dragstart', (e) => { draggedPackId = pack.study_pack_id; div.classList.add('dragging'); e.dataTransfer.effectAllowed = 'move'; e.dataTransfer.setData('text/plain', pack.study_pack_id); });
        div.addEventListener('dragend', () => { div.classList.remove('dragging'); draggedPackId = ''; });
        packList.appendChild(div);
      });
    }

    function showPackEditor(visible) {
      packEmpty.style.display = visible ? 'none' : 'block';
      packEditorWrap.classList.toggle('visible', visible);
    }

    /* ‚îÄ‚îÄ Flashcard editor ‚îÄ‚îÄ */
    function renderFlashcardEditor(highlightIndex = -1) {
      const cards = selectedPack && Array.isArray(selectedPack.flashcards) ? selectedPack.flashcards : [];
      flashcardCount.textContent = `${cards.length} flashcards`;
      flashcardEditorList.innerHTML = '';
      if (!cards.length) { flashcardEditorList.innerHTML = '<div class="empty">No flashcards yet. Add one to start editing.</div>'; return; }
      cards.forEach((card, idx) => {
        const row = document.createElement('div');
        row.className = `editor-card ${idx === highlightIndex ? 'newly-added' : ''}`;
        row.dataset.rowIndex = String(idx);
        row.innerHTML = `
          <div class="editor-card-head">
            <span class="editor-card-title">Flashcard ${idx + 1}</span>
            <button class="btn danger" data-delete-card="${idx}" style="padding:5px 8px;font-size:0.75rem;">Delete</button>
          </div>
          <div class="field"><label>Front (Question / Concept)</label><input data-card-field="front" data-card-index="${idx}" value="${(card.front || '').replace(/"/g, '&quot;')}"></div>
          <div class="field" style="margin-top:8px;"><label>Back (Answer / Explanation)</label><textarea data-card-field="back" data-card-index="${idx}">${card.back || ''}</textarea></div>
        `;
        flashcardEditorList.appendChild(row);
      });
      flashcardEditorList.querySelectorAll('[data-card-field]').forEach(el => {
        el.addEventListener('input', () => {
          const index = parseInt(el.dataset.cardIndex, 10);
          selectedPack.flashcards[index][el.dataset.cardField] = el.value;
          renderLearnFlashcard();
        });
      });
      flashcardEditorList.querySelectorAll('[data-delete-card]').forEach(btn => {
        btn.addEventListener('click', () => {
          selectedPack.flashcards.splice(parseInt(btn.dataset.deleteCard, 10), 1);
          if (learnFlashcardIndex >= selectedPack.flashcards.length) learnFlashcardIndex = Math.max(0, selectedPack.flashcards.length - 1);
          renderFlashcardEditor(); renderLearnFlashcard(); showToast('Flashcard deleted.');
        });
      });
      if (highlightIndex >= 0) {
        const row = flashcardEditorList.querySelector(`[data-row-index="${highlightIndex}"]`);
        if (row) { row.scrollIntoView({ behavior: 'smooth', block: 'center' }); const inp = row.querySelector('input[data-card-field="front"]'); if (inp) inp.focus(); }
      }
    }

    /* ‚îÄ‚îÄ Question editor ‚îÄ‚îÄ */
    function normalizeQuestion(question) {
      const base = { question: question.question || '', options: Array.isArray(question.options) ? question.options.slice(0, 4) : [], answer: question.answer || '', explanation: question.explanation || '' };
      while (base.options.length < 4) base.options.push('');
      if (!base.options.includes(base.answer)) base.answer = base.options[0] || '';
      return base;
    }

    function getAnswerDisplay(question) {
      const options = Array.isArray(question.options) ? question.options : [];
      const foundIndex = options.findIndex(o => o === question.answer);
      const index = foundIndex >= 0 ? foundIndex : 0;
      return `${['A','B','C','D'][index] || 'A'}: ${options[index] || '(empty)'}`;
    }

    function renderQuestionEditor(highlightIndex = -1) {
      selectedPack.test_questions = (selectedPack.test_questions || []).map(normalizeQuestion);
      const questions = selectedPack.test_questions;
      questionCount.textContent = `${questions.length} practice questions`;
      questionEditorList.innerHTML = '';
      if (!questions.length) { questionEditorList.innerHTML = '<div class="empty">No practice questions yet. Add one to start editing.</div>'; return; }
      questions.forEach((question, idx) => {
        const row = document.createElement('div');
        row.className = `editor-card ${idx === highlightIndex ? 'newly-added' : ''}`;
        row.dataset.rowIndex = String(idx);
        row.innerHTML = `
          <div class="editor-card-head">
            <span class="editor-card-title">Question ${idx + 1}</span>
            <button class="btn danger" data-delete-question="${idx}" style="padding:5px 8px;font-size:0.75rem;">Delete</button>
          </div>
          <div class="field"><label>Question</label><textarea data-question-field="question" data-question-index="${idx}">${question.question}</textarea></div>
          <div class="q-options-grid" style="margin-top:8px;">
            <div class="field"><label>Option A</label><input data-option-index="0" data-question-index="${idx}" value="${(question.options[0] || '').replace(/"/g, '&quot;')}"></div>
            <div class="field"><label>Option B</label><input data-option-index="1" data-question-index="${idx}" value="${(question.options[1] || '').replace(/"/g, '&quot;')}"></div>
            <div class="field"><label>Option C</label><input data-option-index="2" data-question-index="${idx}" value="${(question.options[2] || '').replace(/"/g, '&quot;')}"></div>
            <div class="field"><label>Option D</label><input data-option-index="3" data-question-index="${idx}" value="${(question.options[3] || '').replace(/"/g, '&quot;')}"></div>
          </div>
          <div class="field" style="margin-top:8px;"><label>Correct Answer</label>
            <div class="app-select q-answer-picker" data-question-index="${idx}">
              <button type="button" class="app-select-button" data-answer-button data-question-index="${idx}">
                <span class="app-select-label" data-answer-label data-question-index="${idx}">${getAnswerDisplay(question).replace(/</g, '&lt;').replace(/>/g, '&gt;')}</span>
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"></polyline></svg>
              </button>
              <div class="app-select-menu" data-answer-menu data-question-index="${idx}">
                ${question.options.map((option, oi) => `<button type="button" class="app-select-item ${question.answer === option ? 'active' : ''}" data-answer-item data-question-index="${idx}" data-option-index="${oi}">${['A','B','C','D'][oi]}: ${(option || '(empty)').replace(/</g, '&lt;').replace(/>/g, '&gt;')}</button>`).join('')}
              </div>
            </div>
          </div>
          <div class="field" style="margin-top:8px;"><label>Explanation</label><textarea data-question-field="explanation" data-question-index="${idx}">${question.explanation}</textarea></div>
        `;
        questionEditorList.appendChild(row);
      });
      questionEditorList.querySelectorAll('[data-question-field="question"], [data-question-field="explanation"]').forEach(el => {
        el.addEventListener('input', () => { selectedPack.test_questions[parseInt(el.dataset.questionIndex, 10)][el.dataset.questionField] = el.value; renderLearnQuestion(); });
      });
      questionEditorList.querySelectorAll('[data-option-index]').forEach(el => {
        el.addEventListener('input', () => {
          const qi = parseInt(el.dataset.questionIndex, 10);
          const oi = parseInt(el.dataset.optionIndex, 10);
          const q = selectedPack.test_questions[qi];
          q.options[oi] = el.value;
          if (!q.options.includes(q.answer)) q.answer = q.options[0] || '';
          renderQuestionEditor(qi); renderLearnQuestion();
        });
      });
      questionEditorList.querySelectorAll('[data-answer-button]').forEach(button => {
        button.addEventListener('click', (e) => {
          e.stopPropagation();
          const menu = button.parentElement.querySelector('[data-answer-menu]');
          const willOpen = !menu.classList.contains('visible');
          questionEditorList.querySelectorAll('[data-answer-menu]').forEach(m => m.classList.remove('visible'));
          questionEditorList.querySelectorAll('[data-answer-button]').forEach(b => b.classList.remove('open'));
          if (willOpen) { menu.classList.add('visible'); button.classList.add('open'); }
        });
      });
      questionEditorList.querySelectorAll('[data-answer-item]').forEach(item => {
        item.addEventListener('click', () => {
          const qi = parseInt(item.dataset.questionIndex, 10);
          const oi = parseInt(item.dataset.optionIndex, 10);
          selectedPack.test_questions[qi].answer = selectedPack.test_questions[qi].options[oi] || '';
          renderQuestionEditor(qi); renderLearnQuestion();
        });
      });
      questionEditorList.querySelectorAll('[data-delete-question]').forEach(btn => {
        btn.addEventListener('click', () => {
          selectedPack.test_questions.splice(parseInt(btn.dataset.deleteQuestion, 10), 1);
          if (learnQuestionIndex >= selectedPack.test_questions.length) learnQuestionIndex = Math.max(0, selectedPack.test_questions.length - 1);
          renderQuestionEditor(); renderLearnQuestion(); showToast('Practice question deleted.');
        });
      });
      if (highlightIndex >= 0) {
        const row = questionEditorList.querySelector(`[data-row-index="${highlightIndex}"]`);
        if (row) { row.scrollIntoView({ behavior: 'smooth', block: 'center' }); const ta = row.querySelector('textarea[data-question-field="question"]'); if (ta) ta.focus(); }
      }
    }

    /* ‚îÄ‚îÄ Learn flashcard (3D) ‚îÄ‚îÄ */
    function renderLearnFlashcard() {
      const cards = selectedPack && Array.isArray(selectedPack.flashcards) ? selectedPack.flashcards : [];
      if (!cards.length) {
        learnFlashcardFront.textContent = 'No flashcards available for this pack.';
        learnFlashcardBack.textContent = '';
        learnFlashcardInner.classList.remove('flipped');
        learnFProgress.textContent = 'Card 0 of 0';
        learnFPrev.disabled = true; learnFNext.disabled = true; learnFFlip.disabled = true;
        return;
      }
      const card = cards[learnFlashcardIndex];
      learnFlashcardFront.textContent = card.front || '';
      learnFlashcardBack.textContent = card.back || '';
      learnFlashcardInner.classList.toggle('flipped', learnFlashcardFlipped);
      learnFProgress.textContent = `Card ${learnFlashcardIndex + 1} of ${cards.length}`;
      learnFPrev.disabled = learnFlashcardIndex === 0;
      learnFNext.disabled = learnFlashcardIndex === cards.length - 1;
      learnFFlip.disabled = false;
    }

    /* ‚îÄ‚îÄ Learn quiz ‚îÄ‚îÄ */
    function renderLearnQuestion() {
      const questions = selectedPack && Array.isArray(selectedPack.test_questions) ? selectedPack.test_questions : [];
      if (!questions.length) {
        learnQProgress.textContent = 'Question 0 of 0'; learnQScore.textContent = 'Score: 0/0';
        learnQText.textContent = 'No practice questions available for this pack.';
        learnQOptions.innerHTML = ''; learnQExpl.classList.remove('visible'); learnQExpl.textContent = '';
        return;
      }
      const question = questions[learnQuestionIndex];
      learnAnswered = false;
      learnQProgress.textContent = `Question ${learnQuestionIndex + 1} of ${questions.length}`;
      learnQScore.textContent = `Score: ${learnScore}/${questions.length}`;
      learnQText.textContent = question.question || '';
      learnQOptions.innerHTML = ''; learnQExpl.classList.remove('visible'); learnQExpl.textContent = '';
      (question.options || []).forEach(option => {
        const button = document.createElement('button');
        button.type = 'button'; button.className = 'quiz-option'; button.textContent = option;
        button.addEventListener('click', () => {
          if (learnAnswered) return;
          learnAnswered = true;
          [...learnQOptions.querySelectorAll('.quiz-option')].forEach(btn => { btn.disabled = true; if (btn.textContent === question.answer) btn.classList.add('correct'); });
          if (option === question.answer) { button.classList.add('correct'); learnScore += 1; }
          else { button.classList.add('wrong'); }
          learnQScore.textContent = `Score: ${learnScore}/${questions.length}`;
          learnQExpl.textContent = question.explanation || ''; learnQExpl.classList.add('visible');
        });
        learnQOptions.appendChild(button);
      });
    }

    /* ‚îÄ‚îÄ Learn pane switching ‚îÄ‚îÄ */
    function setLearnPane(pane) {
      activeLearnPane = pane;
      learnTabs.forEach(btn => btn.classList.toggle('active', btn.dataset.learnPane === pane));
      document.getElementById('learn-pane-notes').classList.toggle('active', pane === 'notes');
      document.getElementById('learn-pane-flashcards').classList.toggle('active', pane === 'flashcards');
      document.getElementById('learn-pane-test').classList.toggle('active', pane === 'test');
    }

    /* ‚îÄ‚îÄ Learn stage open/close ‚îÄ‚îÄ */
    function openLearnStage(requestFullscreen) {
      if (!selectedPack) { showToast('Select a study pack first.', 'error'); return; }
      learnTitle.textContent = selectedPack.title || 'Learn Mode';
      learnSub.textContent = `${selectedPack.mode || 'study-pack'} ¬∑ Focused session`;
      learnNotesContent.innerHTML = mdToHtml(selectedPack.notes_markdown || '');
      learnFlashcardIndex = 0; learnFlashcardFlipped = false; learnQuestionIndex = 0; learnScore = 0;
      const hasFlashcards = selectedPack.flashcards && selectedPack.flashcards.length;
      const hasQuestions = selectedPack.test_questions && selectedPack.test_questions.length;
      if (activeEditorPane === 'test' && hasQuestions) setLearnPane('test');
      else if (activeEditorPane === 'flashcards' && hasFlashcards) setLearnPane('flashcards');
      else if (activeEditorPane === 'notes') setLearnPane('notes');
      else if (hasFlashcards) setLearnPane('flashcards');
      else if (hasQuestions) setLearnPane('test');
      else setLearnPane('notes');
      renderLearnFlashcard(); renderLearnQuestion();
      learnStage.classList.add('entering');
      requestAnimationFrame(() => { requestAnimationFrame(() => learnStage.classList.replace('entering', 'visible')); });
      if (requestFullscreen) document.documentElement.requestFullscreen?.().catch(() => {});
    }

    function closeLearnStage() {
      learnStage.classList.remove('visible');
      if (document.fullscreenElement) document.exitFullscreen().catch(() => {});
    }

    /* ‚îÄ‚îÄ Folder modal ‚îÄ‚îÄ */
    function openFolderModal(mode, folder) {
      folderModalMode = mode;
      editingFolderId = folder && folder.folder_id ? folder.folder_id : '';
      folderModalTitle.textContent = mode === 'edit' ? 'Edit Folder' : 'Create Folder';
      folderNameInput.value = folder ? folder.name || '' : '';
      folderCourseInput.value = folder ? folder.course || '' : '';
      folderSubjectInput.value = folder ? folder.subject || '' : '';
      folderSemesterInput.value = folder ? folder.semester || '' : '';
      folderBlockInput.value = folder ? folder.block || '' : '';
      openModal(folderModalOverlay);
      setTimeout(() => folderNameInput.focus(), 100);
    }

    function closeFolderModal() {
      closeModal(folderModalOverlay);
      folderModalMode = 'create'; editingFolderId = '';
      folderNameInput.value = ''; folderCourseInput.value = ''; folderSubjectInput.value = ''; folderSemesterInput.value = ''; folderBlockInput.value = '';
    }

    async function saveFolderFromModal() {
      const payload = { name: folderNameInput.value.trim(), course: folderCourseInput.value.trim(), subject: folderSubjectInput.value.trim(), semester: folderSemesterInput.value.trim(), block: folderBlockInput.value.trim() };
      if (!payload.name) { showToast('Folder name is required.', 'error'); folderNameInput.focus(); return; }
      try {
        if (folderModalMode === 'edit' && editingFolderId) {
          await api(`/api/study-folders/${encodeURIComponent(editingFolderId)}`, { method: 'PATCH', body: JSON.stringify(payload) });
          showToast('Folder updated.');
        } else {
          await api('/api/study-folders', { method: 'POST', body: JSON.stringify(payload) });
          showToast('Folder created.');
        }
        closeFolderModal(); await loadData(selectedPackId || pendingOpenPackId);
      } catch (e) { showToast(e.message || 'Could not save folder.', 'error'); }
    }

    /* ‚îÄ‚îÄ Open pack ‚îÄ‚îÄ */
    async function openPack(packId) {
      selectedPack = await api(`/api/study-packs/${encodeURIComponent(packId)}`);
      selectedPack.flashcards = Array.isArray(selectedPack.flashcards) ? selectedPack.flashcards : [];
      selectedPack.test_questions = Array.isArray(selectedPack.test_questions) ? selectedPack.test_questions.map(normalizeQuestion) : [];
      showPackEditor(true);
      packTitle.value = selectedPack.title || '';
      setPackFolderSelection(selectedPack.folder_id || '');
      packCourse.value = selectedPack.course || ''; packSubject.value = selectedPack.subject || '';
      packSemester.value = selectedPack.semester || ''; packBlock.value = selectedPack.block || '';
      notesView.innerHTML = mdToHtml(selectedPack.notes_markdown || '');
      renderFlashcardEditor(); renderQuestionEditor(); renderLearnFlashcard(); renderLearnQuestion();
      setEditorPane(activeEditorPane);
      if (openLearnFromUrl && !autoLearnConsumed && selectedPack.study_pack_id === learnPackFromUrl) {
        autoLearnConsumed = true; openLearnStage(fullscreenFromUrl);
      }
    }

    /* ‚îÄ‚îÄ Load data ‚îÄ‚îÄ */
    async function loadData(preferredPackId = '') {
      const [folderData, packData] = await Promise.all([api('/api/study-folders'), api('/api/study-packs')]);
      folders = folderData.folders || []; packs = packData.study_packs || [];
      renderFolderSelect(); renderFolders(); renderPacks();
      const packToOpen = preferredPackId || selectedPackId || '';
      if (packToOpen && packs.find(item => item.study_pack_id === packToOpen)) {
        selectedPackId = packToOpen; renderPacks(); await openPack(packToOpen);
      } else if (learnPackFromUrl && packs.find(item => item.study_pack_id === learnPackFromUrl)) {
        selectedPackId = learnPackFromUrl; renderPacks(); await openPack(learnPackFromUrl);
      } else { selectedPack = null; showPackEditor(false); }
    }

    /* ‚îÄ‚îÄ Auth state ‚îÄ‚îÄ */
    auth.onAuthStateChanged(async (user) => {
      if (!user) { token = null; userMeta.textContent = 'Not signed in'; authBtn.textContent = 'Sign in'; return; }
      token = await user.getIdToken();
      userMeta.textContent = `Signed in as ${user.email}`;
      authBtn.textContent = 'Sign out';
      try { await loadData(); } catch (e) { showToast(e.message || 'Could not load study library.', 'error'); }
    });

    /* ‚îÄ‚îÄ Event listeners ‚îÄ‚îÄ */
    authBtn.addEventListener('click', async () => { if (!auth.currentUser) { window.location.href = '/'; return; } await auth.signOut(); });
    backAppBtn.addEventListener('click', () => { window.location.href = '/'; });
    fullscreenBtn.addEventListener('click', () => { if (!selectedPack) { showToast('Select a study pack first.', 'error'); return; } openLearnStage(true); });
    searchInput.addEventListener('input', renderPacks);

    packFolderButton.addEventListener('click', (e) => {
      e.stopPropagation();
      packFolderMenu.classList.toggle('visible');
      packFolderButton.classList.toggle('open', packFolderMenu.classList.contains('visible'));
    });

    newFolderBtn.addEventListener('click', () => openFolderModal('create'));
    deleteFolderBtn.addEventListener('click', async () => {
      if (!selectedFolderId) { showToast('Select a folder first.', 'error'); return; }
      const confirmed = await openConfirmModal('Delete Folder', 'Delete this folder? Study packs inside this folder will be moved to no folder.', 'Delete Folder');
      if (!confirmed) return;
      try { await api(`/api/study-folders/${encodeURIComponent(selectedFolderId)}`, { method: 'DELETE' }); selectedFolderId = ''; await loadData(selectedPackId); showToast('Folder deleted.'); }
      catch (e) { showToast(e.message || 'Could not delete folder.', 'error'); }
    });

    savePackBtn.addEventListener('click', async () => {
      if (!selectedPackId || !selectedPack) { showToast('Select a study pack first.', 'error'); return; }
      try {
        await api(`/api/study-packs/${encodeURIComponent(selectedPackId)}`, {
          method: 'PATCH',
          body: JSON.stringify({ title: packTitle.value.trim(), folder_id: packFolderSelect.value, course: packCourse.value.trim(), subject: packSubject.value.trim(), semester: packSemester.value.trim(), block: packBlock.value.trim(), flashcards: selectedPack.flashcards || [], test_questions: selectedPack.test_questions || [] })
        });
        pendingOpenPackId = selectedPackId; await loadData(selectedPackId); pendingOpenPackId = ''; showToast('Study pack saved.');
      } catch (e) { showToast(e.message || 'Could not save study pack.', 'error'); }
    });

    deletePackBtn.addEventListener('click', async () => {
      if (!selectedPackId) { showToast('Select a study pack first.', 'error'); return; }
      const confirmed = await openConfirmModal('Delete Study Pack', 'Delete this study pack permanently? This cannot be undone.', 'Delete Pack');
      if (!confirmed) return;
      try { await api(`/api/study-packs/${encodeURIComponent(selectedPackId)}`, { method: 'DELETE' }); selectedPackId = ''; selectedPack = null; showPackEditor(false); await loadData(); showToast('Study pack deleted.'); }
      catch (e) { showToast(e.message || 'Could not delete study pack.', 'error'); }
    });

    exportPackCsvBtn.addEventListener('click', async () => {
      if (!selectedPackId) { showToast('Select a study pack first.', 'error'); return; }
      try { await downloadStudyPackCsv(selectedPackId, exportType); showToast('CSV export started.'); }
      catch (e) { showToast(e.message || 'Could not export CSV.', 'error'); }
    });

    openLearnBtn.addEventListener('click', () => openLearnStage(false));
    editorTabs.forEach(btn => btn.addEventListener('click', () => setEditorPane(btn.dataset.editorPane)));

    addFlashcardBtn.addEventListener('click', () => {
      if (!selectedPack) return;
      selectedPack.flashcards = selectedPack.flashcards || [];
      selectedPack.flashcards.push({ front: 'New concept', back: 'New explanation' });
      const newIndex = selectedPack.flashcards.length - 1;
      learnFlashcardIndex = newIndex; learnFlashcardFlipped = false;
      renderFlashcardEditor(newIndex); renderLearnFlashcard(); setEditorPane('flashcards');
      showToast('New flashcard added.');
    });

    addQuestionBtn.addEventListener('click', () => {
      if (!selectedPack) return;
      selectedPack.test_questions = selectedPack.test_questions || [];
      selectedPack.test_questions.push(normalizeQuestion({ question: 'New question', options: ['Option A', 'Option B', 'Option C', 'Option D'], answer: 'Option A', explanation: 'Add explanation here.' }));
      const newIndex = selectedPack.test_questions.length - 1;
      learnQuestionIndex = newIndex;
      renderQuestionEditor(newIndex); renderLearnQuestion(); setEditorPane('test');
      showToast('New practice question added.');
    });

    learnBackAppBtn.addEventListener('click', () => { window.location.href = '/'; });
    learnBackLibraryBtn.addEventListener('click', closeLearnStage);
    learnFullscreenBtn.addEventListener('click', async () => {
      try { if (document.fullscreenElement) await document.exitFullscreen(); else await document.documentElement.requestFullscreen(); }
      catch (e) { showToast('Fullscreen not available.', 'error'); }
    });

    learnTabs.forEach(btn => btn.addEventListener('click', () => setLearnPane(btn.dataset.learnPane)));

    learnFlashcard3d.addEventListener('click', () => { learnFlashcardFlipped = !learnFlashcardFlipped; renderLearnFlashcard(); });
    learnFPrev.addEventListener('click', () => {
      const cards = selectedPack && selectedPack.flashcards ? selectedPack.flashcards : [];
      if (!cards.length) return;
      learnFlashcardIndex = Math.max(0, learnFlashcardIndex - 1); learnFlashcardFlipped = false; renderLearnFlashcard();
    });
    learnFNext.addEventListener('click', () => {
      const cards = selectedPack && selectedPack.flashcards ? selectedPack.flashcards : [];
      if (!cards.length) return;
      learnFlashcardIndex = Math.min(cards.length - 1, learnFlashcardIndex + 1); learnFlashcardFlipped = false; renderLearnFlashcard();
    });
    learnFFlip.addEventListener('click', () => { learnFlashcardFlipped = !learnFlashcardFlipped; renderLearnFlashcard(); });
    learnQNext.addEventListener('click', () => {
      const questions = selectedPack && selectedPack.test_questions ? selectedPack.test_questions : [];
      if (!questions.length) return;
      learnQuestionIndex = Math.min(questions.length - 1, learnQuestionIndex + 1); renderLearnQuestion();
    });

    window.addEventListener('keydown', (e) => {
      if (!learnStage.classList.contains('visible')) return;
      if (activeLearnPane !== 'flashcards') return;
      if (e.key === 'ArrowLeft') { e.preventDefault(); learnFPrev.click(); }
      if (e.key === 'ArrowRight') { e.preventDefault(); learnFNext.click(); }
      if (e.code === 'Space') { e.preventDefault(); learnFFlip.click(); }
    });

    folderModalClose.addEventListener('click', closeFolderModal);
    folderModalCancel.addEventListener('click', closeFolderModal);
    folderModalSave.addEventListener('click', saveFolderFromModal);
    folderModalOverlay.addEventListener('click', (e) => { if (e.target === folderModalOverlay) closeFolderModal(); });

    document.addEventListener('click', (e) => {
      if (!packFolderPicker.contains(e.target)) { packFolderMenu.classList.remove('visible'); packFolderButton.classList.remove('open'); }
      if (!e.target.closest('.q-answer-picker')) {
        questionEditorList.querySelectorAll('[data-answer-menu]').forEach(m => m.classList.remove('visible'));
        questionEditorList.querySelectorAll('[data-answer-button]').forEach(b => b.classList.remove('open'));
      }
    });

    confirmModalClose.addEventListener('click', () => closeConfirmModal(false));
    confirmModalCancel.addEventListener('click', () => closeConfirmModal(false));
    confirmModalConfirm.addEventListener('click', () => closeConfirmModal(true));
    confirmModalOverlay.addEventListener('click', (e) => { if (e.target === confirmModalOverlay) closeConfirmModal(false); });
  </script>
</body>
</html>
