<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Study Planner - Lecture Processor</title>
  <style>
    :root{
      --primary:#4F46E5;
      --primary-dark:#4338CA;
      --primary-light:#818CF8;
      --secondary:#0EA5E9;
      --gray-50:#F9FAFB;
      --gray-100:#F3F4F6;
      --gray-200:#E5E7EB;
      --gray-300:#D1D5DB;
      --gray-400:#9CA3AF;
      --gray-500:#6B7280;
      --gray-600:#4B5563;
      --gray-700:#374151;
      --gray-800:#1F2937;
      --gray-900:#111827;
      --white:#fff;
      --success:#10B981;
      --warning:#F59E0B;
      --danger:#EF4444;
      --shadow-sm:0 1px 2px 0 rgb(0 0 0 / .05);
      --shadow:0 1px 3px 0 rgb(0 0 0 / .1),0 1px 2px -1px rgb(0 0 0 / .1);
      --shadow-md:0 4px 6px -1px rgb(0 0 0 / .1),0 2px 4px -2px rgb(0 0 0 / .1);
      --shadow-lg:0 10px 15px -3px rgb(0 0 0 / .1),0 4px 6px -4px rgb(0 0 0 / .1);
      --radius-sm:6px;
      --radius:8px;
      --radius-md:12px;
      --radius-lg:16px;
      --radius-xl:24px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:'Inter',-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;
      background:linear-gradient(135deg,var(--gray-50),var(--gray-100));
      color:var(--gray-800);
      line-height:1.6;
      min-height:100vh;
      -webkit-font-smoothing:antialiased;
    }
    input,textarea,select,button{font-family:inherit}
    .container{max-width:1240px;margin:0 auto;padding:0 24px}

    .topbar{position:sticky;top:0;z-index:40;padding:12px 0;background:linear-gradient(135deg,var(--gray-50),var(--gray-100))}
    .topbar-inner{
      display:flex;align-items:center;gap:10px;padding:14px 18px;flex-wrap:wrap;
      background:rgba(255,255,255,.95);backdrop-filter:blur(12px);-webkit-backdrop-filter:blur(12px);
      border:1px solid var(--gray-200);border-radius:var(--radius-lg);box-shadow:var(--shadow-lg);
    }
    .logo{display:flex;align-items:center;gap:10px;text-decoration:none;color:var(--gray-900);font-weight:800;font-size:1.2rem;margin-right:auto;letter-spacing:-.01em}
    .logo-icon{width:38px;height:38px;border-radius:var(--radius-md);background:linear-gradient(135deg,var(--primary),var(--secondary));display:flex;align-items:center;justify-content:center;color:#fff}
    .logo-icon svg{width:22px;height:22px}
    .btn{
      height:46px;padding:0 14px;border-radius:var(--radius);border:1px solid var(--gray-300);
      background:var(--white);color:var(--gray-700);font-weight:600;cursor:pointer;display:inline-flex;align-items:center;gap:8px;
      text-decoration:none;font-size:.875rem;transition:all .2s ease;
    }
    .btn:hover{border-color:var(--gray-400);background:var(--gray-50);color:var(--gray-900)}
    .btn.primary{border-color:rgba(79,70,229,.35);background:rgba(79,70,229,.08);color:var(--primary-dark)}
    .btn.danger{border-color:rgba(239,68,68,.35);background:rgba(239,68,68,.07);color:#991B1B}
    .user-email{font-size:.82rem;color:var(--gray-500);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:240px}

    .page{padding:16px 0 36px}
    .headline{margin-bottom:2px}
    .headline h1{margin:0 0 6px;font-size:2rem;letter-spacing:-.02em;line-height:1.15}
    .headline p{margin:0;color:var(--gray-500);font-size:1rem}

    .grid{margin-top:20px;display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:16px}
    .card{background:var(--white);border:1px solid var(--gray-200);border-radius:var(--radius-lg);padding:20px;box-shadow:var(--shadow)}
    .metric-label{font-size:.78rem;color:var(--gray-500);font-weight:800;text-transform:uppercase;letter-spacing:.06em}
    .metric-value{margin-top:8px;font-size:2.2rem;font-weight:800;letter-spacing:-.02em;line-height:1.12;padding-bottom:2px}
    .metric-note{margin-top:8px;font-size:.92rem;color:var(--gray-500)}
    .streak,.due,.goal{background:linear-gradient(152deg,#fff 0%,#eef2ff 100%)}
    .streak .metric-value,.due .metric-value,.goal .metric-value{background:linear-gradient(135deg,#4F46E5,#2563EB);-webkit-background-clip:text;background-clip:text;color:transparent}
    .progress-track{margin-top:12px;height:10px;border-radius:999px;background:var(--gray-100);overflow:hidden;border:1px solid var(--gray-200)}
    .progress-fill{height:100%;width:0;background:linear-gradient(90deg,var(--primary),var(--secondary));transition:width .2s ease}

    .section{margin-top:16px;background:var(--white);border:1px solid var(--gray-200);border-radius:var(--radius-lg);padding:20px;box-shadow:var(--shadow)}
    .section h2{margin:0 0 8px;font-size:1.45rem;letter-spacing:-.015em;line-height:1.2}
    .section p{margin:0 0 14px;color:var(--gray-500);font-size:.97rem}

    .goal-row{display:flex;gap:10px;align-items:end;flex-wrap:wrap}
    .field{display:flex;flex-direction:column;gap:6px}
    .field label{font-size:.76rem;font-weight:700;color:var(--gray-700);text-transform:uppercase;letter-spacing:.06em}
    .input{height:46px;border:1px solid var(--gray-300);border-radius:var(--radius-md);padding:0 12px;font-size:1rem;min-width:170px;background:var(--white);color:var(--gray-900)}
    .input:focus{outline:none;border-color:rgba(79,70,229,.6);box-shadow:0 0 0 3px rgba(79,70,229,.12)}

    .folders-wrap{overflow:auto}
    .folders{width:100%;border-collapse:separate;border-spacing:0;overflow:hidden;border:1px solid var(--gray-200);border-radius:var(--radius-md);min-width:860px;background:var(--white)}
    .folders th,.folders td{padding:11px 12px;text-align:left;font-size:.9rem;border-bottom:1px solid var(--gray-100);vertical-align:middle}
    .folders th{font-size:.75rem;text-transform:uppercase;letter-spacing:.045em;color:var(--gray-500);background:var(--gray-50);font-weight:800}
    .folders .input{height:38px;min-width:160px;font-size:.9rem;border-radius:var(--radius)}
    .date-input-wrap{position:relative;display:inline-block;width:180px}
    .date-input-wrap .input{width:100%;padding-right:36px}
    .date-input-icon{position:absolute;right:10px;top:50%;transform:translateY(-50%);width:16px;height:16px;color:var(--gray-500);pointer-events:none}
    .folders .btn{height:38px;padding:0 12px;font-size:.8125rem;border-radius:var(--radius-sm)}
    .folders tr:last-child td{border-bottom:none}
    .folder-meta{font-size:.78rem;color:var(--gray-500);margin-top:2px}
    .recommendation{font-size:.84rem;color:var(--gray-700)}
    .recommendation strong{color:var(--gray-900)}

    .chip{display:inline-flex;align-items:center;gap:6px;padding:5px 9px;border-radius:999px;font-size:.74rem;font-weight:700;border:1px solid var(--gray-200);background:var(--gray-50);color:var(--gray-700)}
    .chip.warn{border-color:rgba(245,158,11,.42);background:rgba(245,158,11,.12);color:#92400E}
    .chip.danger{border-color:rgba(239,68,68,.35);background:rgba(239,68,68,.1);color:#991B1B}

    .auth-required,.empty{margin-top:12px;padding:16px;border:1px dashed var(--gray-300);border-radius:var(--radius-md);background:var(--gray-50);color:var(--gray-500)}
    .toast{position:fixed;left:50%;bottom:18px;transform:translateX(-50%);padding:10px 14px;border-radius:var(--radius-md);background:var(--gray-900);color:var(--white);font-size:.86rem;opacity:0;pointer-events:none;transition:opacity .2s ease;z-index:200;box-shadow:var(--shadow-lg)}
    .toast.visible{opacity:1}
    .toast.success{background:var(--success)}
    .toast.error{background:var(--danger)}

    .flatpickr-calendar{
      border:1px solid rgba(79,70,229,.2)!important;
      border-radius:16px!important;
      box-shadow:0 22px 40px rgba(15,23,42,.2)!important;
      font-family:'Inter',-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif!important;
      overflow:hidden!important;
    }
    .flatpickr-months{background:linear-gradient(135deg,rgba(79,70,229,.1),rgba(14,165,233,.09));padding:6px 6px 2px}
    .flatpickr-current-month{font-size:1rem!important;font-weight:700!important;padding-top:6px!important}
    .flatpickr-weekdays{background:var(--gray-50)}
    .flatpickr-weekday{font-weight:700!important;color:var(--gray-500)!important}
    .flatpickr-day{border-radius:10px!important;font-weight:500!important}
    .flatpickr-day.selected,.flatpickr-day.startRange,.flatpickr-day.endRange,.flatpickr-day.selected:hover,.flatpickr-day.startRange:hover,.flatpickr-day.endRange:hover{
      background:linear-gradient(135deg,var(--primary),var(--secondary))!important;
      border-color:transparent!important;
    }
    .flatpickr-day.today{border-color:var(--primary-light)!important;background:rgba(79,70,229,.06)!important}
    .flatpickr-day:hover{background:rgba(79,70,229,.11)!important}
    .flatpickr-input,.flatpickr-input[readonly]{font-family:'Inter',-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif!important;letter-spacing:0}

    @media (max-width:940px){
      .grid{grid-template-columns:1fr}
      .topbar-inner{flex-wrap:wrap}
      .user-email{max-width:none;width:100%}
      .container{padding:0 12px}
    }
  </style>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
</head>
<body>
  <header class="topbar">
    <div class="container">
      <div class="topbar-inner">
        <a href="/dashboard" class="logo">
          <span class="logo-icon">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"></path><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"></path></svg>
          </span>
          <span>Study Planner</span>
        </a>
        <a class="btn" href="/dashboard">Dashboard</a>
        <a class="btn" href="/study">Study Library</a>
        <a class="btn primary" href="/calendar">Calendar View</a>
        <button class="btn danger" id="signout-btn" style="display:none;">Sign out</button>
        <div class="user-email" id="user-email">Checking sign-in...</div>
      </div>
    </div>
  </header>

  <main class="page">
    <div class="container">
      <div class="headline">
        <h1>Planning & Progress</h1>
        <p>One place to manage your daily goal, review load, and exam dates.</p>
      </div>

      <div class="auth-required" id="auth-required" style="display:none;">
        You need to sign in to use the planner. <a href="/dashboard">Go to dashboard</a>.
      </div>

      <div id="planner-content" style="display:none;">
        <section class="grid">
          <article class="card streak">
            <div class="metric-label">Current Streak</div>
            <div class="metric-value" id="streak-value">0 days</div>
            <div class="metric-note">Updated after each completed learn session.</div>
          </article>
          <article class="card due">
            <div class="metric-label">Cards Due Today</div>
            <div class="metric-value" id="due-value">0</div>
            <div class="metric-note">Based on spaced repetition review dates.</div>
          </article>
          <article class="card goal">
            <div class="metric-label">Daily Goal</div>
            <div class="metric-value" id="goal-value">0 / 20</div>
            <div class="metric-note">Progress today</div>
            <div class="progress-track"><div class="progress-fill" id="goal-fill"></div></div>
          </article>
        </section>

        <section class="section">
          <h2>Goal Settings</h2>
          <p>Set how many cards you want to review each day. This appears in your dashboard progress menu.</p>
          <div class="goal-row">
            <div class="field">
              <label for="goal-input">Daily Card Goal</label>
              <input class="input" type="number" min="1" max="500" id="goal-input">
            </div>
            <button class="btn primary" id="save-goal-btn">Save goal</button>
          </div>
        </section>

        <section class="section">
          <h2>Exam Date Planning</h2>
          <p>Set exam dates per folder here. Recommendation is based on unmastered cards and days remaining.</p>
          <div class="folders-wrap">
            <table class="folders" id="folders-table">
              <thead>
                <tr>
                  <th>Folder</th>
                  <th>Exam date</th>
                  <th>Workload</th>
                  <th>Recommendation</th>
                  <th>Action</th>
                </tr>
              </thead>
              <tbody id="folders-body"></tbody>
            </table>
          </div>
          <div class="empty" id="folders-empty" style="display:none;">No folders found yet. Create one in Study Library first.</div>
        </section>
      </div>
    </div>
  </main>

  <div class="toast" id="toast"></div>

  <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth-compat.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyBAAeEUCPNvP5qnqpP3M6HnFZ6vaaijUvM",
      authDomain: "lecture-processor-cdff6.firebaseapp.com",
      projectId: "lecture-processor-cdff6",
      storageBucket: "lecture-processor-cdff6.firebasestorage.app",
      messagingSenderId: "374793454161",
      appId: "1:374793454161:web:c68b21590e9a1fafa32e70"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();

    const userEmailEl = document.getElementById('user-email');
    const authRequiredEl = document.getElementById('auth-required');
    const plannerContentEl = document.getElementById('planner-content');
    const streakValueEl = document.getElementById('streak-value');
    const dueValueEl = document.getElementById('due-value');
    const goalValueEl = document.getElementById('goal-value');
    const goalFillEl = document.getElementById('goal-fill');
    const goalInputEl = document.getElementById('goal-input');
    const saveGoalBtn = document.getElementById('save-goal-btn');
    const foldersBodyEl = document.getElementById('folders-body');
    const foldersEmptyEl = document.getElementById('folders-empty');
    const signoutBtn = document.getElementById('signout-btn');
    const toastEl = document.getElementById('toast');

    let currentUser = null;
    let idToken = null;
    let folderStatsById = {};
    let examDatePickers = [];

    function showToast(message, type) {
      toastEl.textContent = message;
      toastEl.className = 'toast visible' + (type ? ' ' + type : '');
      setTimeout(function(){ toastEl.className = 'toast'; }, 2200);
    }

    function localDateString(ts) {
      const d = ts ? new Date(ts) : new Date();
      const y = d.getFullYear();
      const m = String(d.getMonth() + 1).padStart(2, '0');
      const day = String(d.getDate()).padStart(2, '0');
      return y + '-' + m + '-' + day;
    }
    function addDaysLocal(dateString, days) {
      const parts = String(dateString || localDateString()).split('-').map(function(v){ return parseInt(v, 10); });
      const base = new Date(parts[0], (parts[1] || 1) - 1, parts[2] || 1);
      base.setDate(base.getDate() + (parseInt(days, 10) || 0));
      return localDateString(base.getTime());
    }
    function safeReadJson(raw, fallback) {
      try { return JSON.parse(raw); } catch (_) { return fallback; }
    }
    function getStreakStorage(uid) {
      return safeReadJson(localStorage.getItem('study_streak_' + uid) || '{}', {});
    }
    function getDailyGoal(uid) {
      const parsed = parseInt(localStorage.getItem('daily_goal_' + uid) || '20', 10);
      return Number.isFinite(parsed) && parsed > 0 ? Math.min(parsed, 500) : 20;
    }
    function setDailyGoal(uid, value) {
      localStorage.setItem('daily_goal_' + uid, String(value));
    }
    function getCurrentStreak(uid) {
      const data = getStreakStorage(uid);
      const today = localDateString();
      const yesterday = addDaysLocal(today, -1);
      if (data.last_study_date === today) return Math.max(0, parseInt(data.current_streak, 10) || 0);
      if (data.last_study_date === yesterday) return Math.max(0, parseInt(data.current_streak, 10) || 0);
      return 0;
    }
    function getTodayProgress(uid) {
      const data = getStreakStorage(uid);
      if (data.daily_progress_date !== localDateString()) return 0;
      return Math.max(0, parseInt(data.daily_progress_count, 10) || 0);
    }
    function isDueDate(dateString) {
      const value = String(dateString || '').trim();
      if (!value) return true;
      return value <= localDateString();
    }
    function getDueCardsCount(uid) {
      const prefix = 'card_state_' + uid + '_';
      let due = 0;
      for (let i = 0; i < localStorage.length; i++) {
        const key = localStorage.key(i);
        if (!key || key.indexOf(prefix) !== 0) continue;
        const state = safeReadJson(localStorage.getItem(key) || '{}', {});
        Object.keys(state).forEach(function(cardId){
          if (cardId.indexOf('fc_') !== 0) return;
          const entry = state[cardId] || {};
          if (!(parseInt(entry.seen, 10) > 0)) return;
          if (isDueDate(entry.next_review_date)) due += 1;
        });
      }
      return due;
    }

    function getPackState(uid, packId) {
      return safeReadJson(localStorage.getItem('card_state_' + uid + '_' + String(packId || '')) || '{}', {});
    }

    function computeFolderStats(uid, packs) {
      const byFolder = {};
      (packs || []).forEach(function(pack){
        const folderId = String(pack.folder_id || '');
        if (!folderId) return;
        if (!byFolder[folderId]) byFolder[folderId] = { total: 0, due: 0, unmastered: 0 };
        const total = Math.max(0, parseInt(pack.flashcards_count, 10) || 0);
        byFolder[folderId].total += total;
        const state = getPackState(uid, pack.study_pack_id);
        for (let i = 0; i < total; i++) {
          const card = state['fc_' + i] || null;
          if (!card || !(parseInt(card.seen, 10) > 0)) {
            byFolder[folderId].unmastered += 1;
            continue;
          }
          if (String(card.level || '').toLowerCase() !== 'mastered') byFolder[folderId].unmastered += 1;
          if (isDueDate(card.next_review_date)) byFolder[folderId].due += 1;
        }
      });
      return byFolder;
    }

    function daysUntil(dateString) {
      if (!dateString) return null;
      const parts = String(dateString).split('-');
      if (parts.length !== 3) return null;
      const exam = new Date(parseInt(parts[0], 10), parseInt(parts[1], 10) - 1, parseInt(parts[2], 10));
      const now = new Date();
      const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
      return Math.ceil((exam.getTime() - today.getTime()) / 86400000);
    }

    function formatDisplayDate(isoDate) {
      const val = String(isoDate || '').trim();
      const m = val.match(/^(\d{4})-(\d{2})-(\d{2})$/);
      if (!m) return '';
      return m[3] + '-' + m[2] + '-' + m[1];
    }

    function parseDateInput(value) {
      const raw = String(value || '').trim();
      if (!raw) return '';
      let m = raw.match(/^(\d{4})-(\d{2})-(\d{2})$/);
      if (m) {
        const d = new Date(parseInt(m[1], 10), parseInt(m[2], 10) - 1, parseInt(m[3], 10));
        if (d.getFullYear() !== parseInt(m[1], 10) || (d.getMonth() + 1) !== parseInt(m[2], 10) || d.getDate() !== parseInt(m[3], 10)) {
          return null;
        }
        return raw;
      }
      m = raw.match(/^(\d{2})-(\d{2})-(\d{4})$/);
      if (m) {
        const y = parseInt(m[3], 10);
        const mo = parseInt(m[2], 10);
        const d = parseInt(m[1], 10);
        const date = new Date(y, mo - 1, d);
        if (date.getFullYear() !== y || (date.getMonth() + 1) !== mo || date.getDate() !== d) {
          return null;
        }
        return y + '-' + String(mo).padStart(2, '0') + '-' + String(d).padStart(2, '0');
      }
      return null;
    }

    function renderOverview(uid) {
      const streak = getCurrentStreak(uid);
      const due = getDueCardsCount(uid);
      const goal = getDailyGoal(uid);
      const progress = getTodayProgress(uid);
      const pct = Math.max(0, Math.min(100, Math.round((Math.min(progress, goal) / Math.max(goal, 1)) * 100)));
      streakValueEl.textContent = streak + ' day' + (streak === 1 ? '' : 's');
      dueValueEl.textContent = String(due);
      goalValueEl.textContent = Math.min(progress, goal) + ' / ' + goal;
      goalFillEl.style.width = pct + '%';
      goalInputEl.value = String(goal);
    }

    function renderFolders(folders) {
      foldersBodyEl.innerHTML = '';
      if (!folders || !folders.length) {
        foldersEmptyEl.style.display = 'block';
        return;
      }
      foldersEmptyEl.style.display = 'none';

      folders.forEach(function(folder){
        const stats = folderStatsById[folder.folder_id] || { total: 0, due: 0, unmastered: 0 };
        const days = daysUntil(folder.exam_date || '');
        let countdown = '<span class="chip">No exam date</span>';
        let recommendation = '<span class="recommendation">Set an exam date to get a daily recommendation.</span>';
        if (days !== null) {
          if (days > 0) {
            countdown = '<span class="chip warn">' + days + ' day' + (days === 1 ? '' : 's') + ' left</span>';
            const rec = Math.ceil((stats.unmastered || 0) / Math.max(days, 1));
            recommendation = '<span class="recommendation">Recommended: <strong>' + rec + '</strong> unmastered cards/day.</span>';
          } else if (days === 0) {
            countdown = '<span class="chip danger">Exam today</span>';
            recommendation = '<span class="recommendation"><strong>' + (stats.unmastered || 0) + '</strong> cards should be reviewed today.</span>';
          } else {
            countdown = '<span class="chip danger">Exam passed</span>';
            recommendation = '<span class="recommendation">Update the exam date to restore recommendations.</span>';
          }
        }
        const tr = document.createElement('tr');
        tr.innerHTML =
          '<td><div><strong>' + escapeHtml(folder.name || 'Untitled folder') + '</strong></div>'
          + '<div class="folder-meta">' + escapeHtml([folder.course, folder.subject, folder.semester, folder.block].filter(Boolean).join(' · ') || 'No metadata') + '</div></td>'
          + '<td><div class="date-input-wrap"><input class="input js-folder-date" type="text" data-folder-date="' + escapeHtml(folder.folder_id) + '" value="' + escapeHtml(formatDisplayDate(folder.exam_date || '')) + '" placeholder="dd-mm-yyyy" inputmode="numeric"><svg class="date-input-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg></div></td>'
          + '<td><div class="recommendation"><strong>' + stats.total + '</strong> total · <strong>' + stats.unmastered + '</strong> unmastered · <strong>' + stats.due + '</strong> due</div><div style="margin-top:6px;">' + countdown + '</div></td>'
          + '<td>' + recommendation + '</td>'
          + '<td><button class="btn primary" data-save-folder="' + escapeHtml(folder.folder_id) + '">Save</button></td>';
        foldersBodyEl.appendChild(tr);
      });
      initFolderDatePickers();
    }

    function initFolderDatePickers() {
      if (typeof flatpickr === 'undefined') return;
      examDatePickers.forEach(function(instance){
        try { instance.destroy(); } catch (_) {}
      });
      examDatePickers = [];
      const inputs = foldersBodyEl.querySelectorAll('.js-folder-date');
      inputs.forEach(function(input){
        const instance = flatpickr(input, {
          dateFormat: 'd-m-Y',
          allowInput: true,
          disableMobile: true,
          locale: { firstDayOfWeek: 1 },
          defaultDate: input.value || null
        });
        examDatePickers.push(instance);
      });
    }

    function escapeHtml(value) {
      return String(value || '')
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#39;');
    }

    async function authFetch(url, options) {
      const opts = options || {};
      const headers = Object.assign({}, opts.headers || {}, { 'Authorization': 'Bearer ' + idToken });
      return fetch(url, Object.assign({}, opts, { headers }));
    }

    async function loadPlannerData() {
      if (!currentUser || !idToken) return;
      renderOverview(currentUser.uid);
      try {
        const [foldersRes, packsRes] = await Promise.all([
          authFetch('/api/study-folders'),
          authFetch('/api/study-packs')
        ]);
        if (foldersRes.status === 401 || packsRes.status === 401) {
          authRequiredEl.style.display = 'block';
          plannerContentEl.style.display = 'none';
          return;
        }
        const foldersData = await foldersRes.json();
        const packsData = await packsRes.json();
        folderStatsById = computeFolderStats(currentUser.uid, packsData.study_packs || []);
        renderFolders(foldersData.folders || []);
      } catch (_) {
        foldersBodyEl.innerHTML = '';
        foldersEmptyEl.style.display = 'block';
        foldersEmptyEl.textContent = 'Could not load folders right now. Please try again.';
      }
    }

    saveGoalBtn.addEventListener('click', function(){
      if (!currentUser) return;
      const val = parseInt(goalInputEl.value || '0', 10);
      if (!Number.isFinite(val) || val < 1 || val > 500) {
        showToast('Use a goal between 1 and 500.', 'error');
        return;
      }
      setDailyGoal(currentUser.uid, val);
      renderOverview(currentUser.uid);
      showToast('Daily goal saved.', 'success');
    });

    foldersBodyEl.addEventListener('click', async function(event){
      const btn = event.target.closest('[data-save-folder]');
      if (!btn || !currentUser || !idToken) return;
      const folderId = btn.getAttribute('data-save-folder');
      const dateInput = document.querySelector('[data-folder-date="' + folderId + '"]');
      if (!dateInput) return;
      const normalizedDate = parseDateInput(dateInput.value);
      if (normalizedDate === null) {
        showToast('Use a valid date: dd-mm-yyyy or yyyy-mm-dd.', 'error');
        dateInput.focus();
        return;
      }
      btn.disabled = true;
      btn.textContent = 'Saving...';
      try {
        const resp = await authFetch('/api/study-folders/' + encodeURIComponent(folderId), {
          method: 'PATCH',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ exam_date: normalizedDate || '' })
        });
        const data = await resp.json();
        if (!resp.ok) throw new Error(data.error || 'Could not save exam date');
        showToast('Exam date saved.', 'success');
        await loadPlannerData();
      } catch (err) {
        showToast(err.message || 'Could not save exam date.', 'error');
      } finally {
        btn.disabled = false;
        btn.textContent = 'Save';
      }
    });

    signoutBtn.addEventListener('click', async function(){
      try {
        await auth.signOut();
        window.location.href = '/dashboard';
      } catch (_) {
        window.location.href = '/dashboard';
      }
    });

    window.addEventListener('focus', function(){
      if (currentUser) renderOverview(currentUser.uid);
    });
    document.addEventListener('visibilitychange', function(){
      if (!document.hidden && currentUser) renderOverview(currentUser.uid);
    });

    auth.onAuthStateChanged(async function(user){
      currentUser = user;
      if (!user) {
        idToken = null;
        userEmailEl.textContent = 'Not signed in';
        signoutBtn.style.display = 'none';
        authRequiredEl.style.display = 'block';
        plannerContentEl.style.display = 'none';
        return;
      }
      idToken = await user.getIdToken();
      userEmailEl.textContent = user.email || 'Signed in';
      signoutBtn.style.display = 'inline-flex';
      authRequiredEl.style.display = 'none';
      plannerContentEl.style.display = 'block';
      await loadPlannerData();
    });
  </script>
</body>
</html>
