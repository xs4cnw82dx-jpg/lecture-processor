===== app.py =====
import os
import uuid
import threading
import time
import io
import json
import csv
import shutil
import subprocess
from datetime import datetime, timedelta
import stripe
from flask import Flask, request, jsonify, render_template, send_file
from google import genai
from google.genai import types
from dotenv import load_dotenv
from werkzeug.utils import secure_filename
from docx import Document
from docx.shared import Pt, Inches
from docx.enum.text import WD_ALIGN_PARAGRAPH
import firebase_admin
from firebase_admin import credentials, auth, firestore

load_dotenv()
app = Flask(__name__)

UPLOAD_FOLDER = 'uploads'
ALLOWED_PDF_EXTENSIONS = {'pdf'}
ALLOWED_AUDIO_EXTENSIONS = {'mp3', 'm4a', 'wav', 'aac', 'ogg', 'flac'}
MAX_CONTENT_LENGTH = 500 * 1024 * 1024

os.makedirs(UPLOAD_FOLDER, exist_ok=True)
client = genai.Client(api_key=os.getenv('GEMINI_API_KEY'))

# --- Firebase Setup ---
if os.path.exists('firebase-credentials.json'):
    cred = credentials.Certificate('firebase-credentials.json')
else:
    firebase_creds = json.loads(os.getenv('FIREBASE_CREDENTIALS', '{}'))
    cred = credentials.Certificate(firebase_creds)

firebase_admin.initialize_app(cred)
db = firestore.client()

# --- Stripe Setup ---
stripe.api_key = os.getenv('STRIPE_SECRET_KEY')
STRIPE_PUBLISHABLE_KEY = os.getenv('STRIPE_PUBLISHABLE_KEY', '')
STRIPE_WEBHOOK_SECRET = os.getenv('STRIPE_WEBHOOK_SECRET', '')
ADMIN_EMAILS = {email.strip().lower() for email in os.getenv('ADMIN_EMAILS', '').split(',') if email.strip()}
ADMIN_UIDS = {uid.strip() for uid in os.getenv('ADMIN_UIDS', '').split(',') if uid.strip()}

# --- In-Memory Storage (jobs only ‚Äî credits are in Firestore now) ---
jobs = {}

# --- Credit Bundles (what users can buy) ---
CREDIT_BUNDLES = {
    'lecture_5': {
        'name': 'Lecture Notes ‚Äî 5 Pack',
        'description': '5 standard lecture credits',
        'credits': {'lecture_credits_standard': 5},
        'price_cents': 999,
        'currency': 'eur',
    },
    'lecture_10': {
        'name': 'Lecture Notes ‚Äî 10 Pack',
        'description': '10 standard lecture credits (best value)',
        'credits': {'lecture_credits_standard': 10},
        'price_cents': 1699,
        'currency': 'eur',
    },
    'slides_10': {
        'name': 'Slides Extraction ‚Äî 10 Pack',
        'description': '10 slides extraction credits',
        'credits': {'slides_credits': 10},
        'price_cents': 499,
        'currency': 'eur',
    },
    'slides_25': {
        'name': 'Slides Extraction ‚Äî 25 Pack',
        'description': '25 slides extraction credits (best value)',
        'credits': {'slides_credits': 25},
        'price_cents': 999,
        'currency': 'eur',
    },
    'interview_3': {
        'name': 'Interview Transcription ‚Äî 3 Pack',
        'description': '3 interview transcription credits',
        'credits': {'interview_credits_short': 3},
        'price_cents': 799,
        'currency': 'eur',
    },
    'interview_8': {
        'name': 'Interview Transcription ‚Äî 8 Pack',
        'description': '8 interview transcription credits (best value)',
        'credits': {'interview_credits_short': 8},
        'price_cents': 1799,
        'currency': 'eur',
    },
}

# --- Email Allowlist ---
ALLOWED_EMAIL_DOMAINS = {
    'gmail.com', 'googlemail.com', 'outlook.com', 'hotmail.com', 'live.com', 'icloud.com', 'yahoo.com', 'yahoo.nl',
    'student.tudelft.nl', 'tudelft.nl', 'uva.nl', 'student.uva.nl', 'vu.nl', 'student.vu.nl', 'eur.nl', 'student.eur.nl',
    'uu.nl', 'students.uu.nl', 'ru.nl', 'student.ru.nl', 'utwente.nl', 'student.utwente.nl', 'tue.nl', 'student.tue.nl',
    'maastrichtuniversity.nl', 'student.maastrichtuniversity.nl', 'leidenuniv.nl', 'student.leidenuniv.nl', 'rug.nl',
    'student.rug.nl', 'tilburguniversity.edu', 'uvt.nl', 'han.nl', 'student.han.nl', 'hva.nl', 'student.hva.nl', 'hr.nl',
    'student.hr.nl', 'fontys.nl', 'student.fontys.nl', 'saxion.nl', 'student.saxion.nl', 'avans.nl', 'student.avans.nl',
    'inholland.nl', 'student.inholland.nl', 'hanze.nl', 'student.hanze.nl', 'zuyd.nl', 'student.zuyd.nl', 'hu.nl',
    'student.hu.nl', 'windesheim.nl', 'student.windesheim.nl', 'nhlstenden.com', 'student.nhlstenden.com',
}

ALLOWED_EMAIL_PATTERNS = ['.edu', '.ac.uk', '.edu.nl']

def is_email_allowed(email):
    if not email: return False
    email = email.lower()
    domain = email.split('@')[-1] if '@' in email else ''
    if domain in ALLOWED_EMAIL_DOMAINS: return True
    for pattern in ALLOWED_EMAIL_PATTERNS:
        if domain.endswith(pattern): return True
    return False

# --- AI Model Config ---
MODEL_SLIDES = 'gemini-2.5-flash-lite'
MODEL_AUDIO = 'gemini-3-flash-preview'
MODEL_INTEGRATION = 'gemini-2.5-pro'
MODEL_INTERVIEW = 'gemini-2.5-pro'
MODEL_STUDY = 'gemini-2.5-flash-lite'

FREE_LECTURE_CREDITS = 1
FREE_SLIDES_CREDITS = 2
FREE_INTERVIEW_CREDITS = 0

OUTPUT_LANGUAGE_MAP = {
    'dutch': 'Dutch',
    'english': 'English',
    'spanish': 'Spanish',
    'french': 'French',
    'german': 'German',
    'chinese': 'Chinese',
}

# --- Prompts ---
PROMPT_SLIDE_EXTRACTION = """Extraheer alle tekst van de slides uit het bijgevoegde PDF-bestand en identificeer de functie van visuele elementen.
Instructies:
1. Geef per slide duidelijk aan welk slide-nummer het betreft (bv. "Slide 1:").
2. Neem de titel van de slide over.
3. Neem alle tekstuele inhoud (bullet points, paragrafen) van de slide over.
4. Identificeer waar afbeeldingen of tabellen staan. Gebruik strikte criteria:
   - Informatief: Gebruik de placeholder ALLEEN als de afbeelding tekst, data, grafieken, diagrammen, flowcharts, of een specifiek wetenschappelijk/technisch diagram bevat dat cruciaal is voor begrip van de slide. Formaat: [Informatieve Afbeelding/Tabel: Geef een neutrale beschrijving van wat zichtbaar is of het onderwerp]
   - Decoratief: Gebruik de placeholder voor ALLE foto's van mensen, landschappen, bedrijfslogo's, universiteitslogo's, achtergrondillustraties, stockfoto's, of sfeerbeelden. Bij twijfel, classificeer het als decoratief! Formaat: [Decoratieve Afbeelding]
5. Laat de zin "Share Your talent move the world" weg, indien aanwezig.
6. Lever de output als platte tekst, zonder specifieke Word-opmaak anders dan de slide-indicatie en de placeholders."""

PROMPT_AUDIO_TRANSCRIPTION = """Maak een nauwkeurig en 'schoon' transcript van het bijgevoegde audiobestand.
Instructies:
1. Transcribeer de gesproken tekst zo letterlijk mogelijk.
2. Verwijder stopwoorden en aarzelingen (zoals "eh," "uhm," "nou ja," "weet je wel") om de leesbaarheid te verhogen, maar behoud de volledige inhoudelijke boodschap. Verander geen zinsconstructies.
3. Gebruik geen tijdcodes.
4. Gebruik alinea's om langere spreekbeurten op te delen.
5. Schrijf de uiteindelijke output volledig in deze taal: {output_language}."""

PROMPT_INTERVIEW_TRANSCRIPTION = """Transcribe this interview in the format: timecode (mm:ss) - speaker - caption.
Rules:
- Use speaker A, speaker B, etc. to identify speakers.
- Keep timestamps in each line.
- Write the output fully in this language: {output_language}."""

PROMPT_INTERVIEW_SUMMARY = """You are an expert interviewer analyst.
Create a concise summary of this interview.
Rules:
- Maximum one page equivalent (about 400-600 words).
- Focus only on the most important points, commitments, and conclusions.
- Use short headings and bullet points where useful.
- Do not invent information outside the transcript.
- Write the output fully in this language: {output_language}.
Transcript:
{transcript}
"""

PROMPT_INTERVIEW_SECTIONED = """You are an expert transcript editor.
Rewrite this interview transcript into a structured version with clear headings.
Rules:
- Keep timestamps and speaker labels from the source where possible.
- Split content into relevant sections (for example: Introduction, Background, Key Discussion, Decisions, Next Steps).
- Use meaningful heading titles based on actual content.
- Do not invent information outside the transcript.
- Write the output fully in this language: {output_language}.
Transcript:
{transcript}
"""

PROMPT_MERGE_TEMPLATE = """Cre√´er een volledige, integrale en goed leesbare uitwerking van een college door de slide-tekst en het audio-transcript naadloos te combineren. Het eindresultaat moet een compleet naslagwerk zijn.
Kernprincipe:
Jouw taak is niet om samen te vatten, maar om te completeren. Het doel is volledigheid, niet beknoptheid. Combineer alle relevante informatie van de slides en de audio tot √©√©n compleet, doorlopend en goed gestructureerd document. Wees niet terughoudend met de lengte; de output moet zo lang zijn als nodig is om alle inhoud te dekken. Beschouw het als het uitschrijven van een college voor iemand die er niet bij kon zijn en geen detail mag missen.
Instructies voor Verwerking:
1. Integreer in plaats van te synthetiseren:
   - Gebruik de slide-tekst als de ruggengraat en de structuur van het document.
   - Verweef de gesproken tekst uit het audio-transcript op de juiste logische plek in de slide-tekst.
   - Voeg alle aanvullende uitleg, context, voorbeelden, nuanceringen en zijsporen uit de audio toe. Als de spreker een concept van de slide verder uitlegt, moet die volledige uitleg in de tekst komen.
   - Behoud details: Verwijder geen informatie omdat het een 'detail' lijkt. Alle inhoudelijke informatie uit de audio is relevant.
2. Redigeer voor Leesbaarheid (niet voor beknoptheid):
   - Verwijder alleen letterlijke herhalingen waarbij de audio exact hetzelfde zegt als de slide-tekst. Als de audio het anders verwoordt, behoud dan de audio-versie omdat deze vaak natuurlijker is.
   - Zorg ervoor dat alle overbodige conversationele zinnen (bv. "Ok√©, dan gaan we nu naar de volgende slide," "Hebben jullie hier vragen over?") en directe instructies aan studenten ("Noteer dit goed," "Dit komt op het tentamen") worden verwijderd, tenzij ze cruciaal zijn voor de context.
   - Herschrijf zinnen waar nodig om een vloeiende overgang te cre√´ren tussen de slide-informatie en de toegevoegde audio-uitleg. De tekst moet lezen als √©√©n coherent geheel.
3. Structuur en Opmaak:
   - Gebruik de slide-titels als koppen. Cre√´er waar nodig subkoppen voor subonderwerpen die in de audio worden besproken.
   - Gebruik alinea's en bullet points om de tekst overzichtelijk en leesbaar te maken.
   - Gebruik absoluut geen labels zoals "Audio:", "Spreker:" of "Slide:".
   - Zorg voor een professionele, informatieve en neutrale toon.
   - Schrijf de uiteindelijke output volledig in deze taal: {output_language}.
4. Omgaan met Visuele Elementen:
   - Neem de placeholders voor [Informatieve Afbeelding/Tabel: ...] op de juiste plek in de tekst op.
   - Laat placeholders voor [Decoratieve Afbeelding] volledig weg uit de uiteindelijke output.
Input:
1. Slide-tekst:
{slide_text}
2. Audio-transcript:
{transcript}"""

PROMPT_STUDY_TEMPLATE = """You are an expert university professor creating study materials. I will provide you with the complete text of a lecture or slide deck.

Your task is to generate {flashcard_amount} flashcards and {question_amount} multiple-choice test questions based strictly on the provided text. Do not invent outside information.
Write all generated output fully in this language: {output_language}.

RULES FOR FLASHCARDS:
- The 'front' should be a clear term or concept.
- The 'back' should be a concise, accurate definition/explanation.

RULES FOR TEST QUESTIONS:
- Create challenging, university-level multiple-choice questions.
- Provide exactly 4 options (A, B, C, D) as an array of strings.
- Provide the correct answer (must match one option exactly).
- Provide a brief 'explanation' of WHY the answer is correct.

REQUIRED OUTPUT FORMAT:
You must respond with strictly valid JSON matching this structure:
{{
  "flashcards": [{{"front": "string", "back": "string"}}],
  "test_questions": [{{"question": "string", "options": ["string", "string", "string", "string"], "answer": "string", "explanation": "string"}}]
}}

LECTURE TEXT:
{source_text}
"""

# =============================================
# FIRESTORE USER FUNCTIONS
# =============================================

def get_or_create_user(uid, email):
    """Get a user from Firestore, or create them with free credits if they don't exist."""
    user_ref = db.collection('users').document(uid)
    user_doc = user_ref.get()

    if user_doc.exists:
        user_data = user_doc.to_dict()
        # Update email if it changed
        if user_data.get('email') != email and email:
            user_ref.update({'email': email})
            user_data['email'] = email
        return user_data
    else:
        # New user ‚Äî create with free credits
        user_data = {
            'uid': uid,
            'email': email,
            'lecture_credits_standard': FREE_LECTURE_CREDITS,
            'lecture_credits_extended': 0,
            'slides_credits': FREE_SLIDES_CREDITS,
            'interview_credits_short': FREE_INTERVIEW_CREDITS,
            'interview_credits_medium': 0,
            'interview_credits_long': 0,
            'total_processed': 0,
            'created_at': time.time(),
        }
        user_ref.set(user_data)
        print(f"New user created: {uid} ({email})")
        return user_data

def grant_credits_to_user(uid, bundle_id):
    """Grant credits from a purchased bundle to a user in Firestore."""
    bundle = CREDIT_BUNDLES.get(bundle_id)
    if not bundle:
        print(f"Warning: Unknown bundle_id '{bundle_id}' in grant_credits_to_user")
        return False

    user_ref = db.collection('users').document(uid)
    user_doc = user_ref.get()

    if not user_doc.exists:
        # User not in Firestore yet ‚Äî create with defaults first
        user_data = {
            'uid': uid,
            'email': '',
            'lecture_credits_standard': FREE_LECTURE_CREDITS,
            'lecture_credits_extended': 0,
            'slides_credits': FREE_SLIDES_CREDITS,
            'interview_credits_short': FREE_INTERVIEW_CREDITS,
            'interview_credits_medium': 0,
            'interview_credits_long': 0,
            'total_processed': 0,
            'created_at': time.time(),
        }
        user_ref.set(user_data)

    # Add the purchased credits
    for credit_key, credit_amount in bundle['credits'].items():
        user_ref.update({credit_key: firestore.Increment(credit_amount)})
        print(f"Granted {credit_amount} '{credit_key}' credits to user {uid}.")

    return True

def deduct_credit(uid, credit_type_primary, credit_type_fallback=None):
    """Deduct one credit from the user. Returns the credit type that was deducted, or None if no credits."""
    user_ref = db.collection('users').document(uid)
    user_doc = user_ref.get()

    if not user_doc.exists:
        return None

    user_data = user_doc.to_dict()

    if user_data.get(credit_type_primary, 0) > 0:
        user_ref.update({
            credit_type_primary: firestore.Increment(-1),
            'total_processed': firestore.Increment(1),
        })
        return credit_type_primary
    elif credit_type_fallback and user_data.get(credit_type_fallback, 0) > 0:
        user_ref.update({
            credit_type_fallback: firestore.Increment(-1),
            'total_processed': firestore.Increment(1),
        })
        return credit_type_fallback
    else:
        return None

def deduct_interview_credit(uid):
    """Deduct one interview credit, checking short -> medium -> long. Returns the credit type deducted, or None."""
    user_ref = db.collection('users').document(uid)
    user_doc = user_ref.get()

    if not user_doc.exists:
        return None

    user_data = user_doc.to_dict()

    if user_data.get('interview_credits_short', 0) > 0:
        user_ref.update({
            'interview_credits_short': firestore.Increment(-1),
            'total_processed': firestore.Increment(1),
        })
        return 'interview_credits_short'
    elif user_data.get('interview_credits_medium', 0) > 0:
        user_ref.update({
            'interview_credits_medium': firestore.Increment(-1),
            'total_processed': firestore.Increment(1),
        })
        return 'interview_credits_medium'
    elif user_data.get('interview_credits_long', 0) > 0:
        user_ref.update({
            'interview_credits_long': firestore.Increment(-1),
            'total_processed': firestore.Increment(1),
        })
        return 'interview_credits_long'
    else:
        return None

def refund_credit(uid, credit_type):
    """Refund one credit back to the user after a failed processing job."""
    if not uid or not credit_type:
        return
    try:
        user_ref = db.collection('users').document(uid)
        user_ref.update({
            credit_type: firestore.Increment(1),
            'total_processed': firestore.Increment(-1),
        })
        print(f"‚úÖ Refunded 1 '{credit_type}' credit to user {uid} due to processing failure.")
    except Exception as e:
        print(f"‚ùå Failed to refund credit '{credit_type}' to user {uid}: {e}")

def save_purchase_record(uid, bundle_id, stripe_session_id):
    """Save a purchase record to Firestore for purchase history."""
    bundle = CREDIT_BUNDLES.get(bundle_id)
    if not bundle:
        return
    try:
        db.collection('purchases').add({
            'uid': uid,
            'bundle_id': bundle_id,
            'bundle_name': bundle['name'],
            'price_cents': bundle['price_cents'],
            'currency': bundle['currency'],
            'credits': bundle['credits'],
            'stripe_session_id': stripe_session_id,
            'created_at': time.time(),
        })
        print(f"üìù Saved purchase record for user {uid}: {bundle['name']}")
    except Exception as e:
        print(f"‚ùå Failed to save purchase record for user {uid}: {e}")

def save_job_log(job_id, job_data, finished_at):
    """Save a processing job log to Firestore for analytics."""
    try:
        started_at = job_data.get('started_at', 0)
        duration = round(finished_at - started_at, 1) if started_at else 0
        db.collection('job_logs').document(job_id).set({
            'job_id': job_id,
            'uid': job_data.get('user_id', ''),
            'email': job_data.get('user_email', ''),
            'mode': job_data.get('mode', ''),
            'status': job_data.get('status', ''),
            'credit_deducted': job_data.get('credit_deducted', ''),
            'credit_refunded': job_data.get('credit_refunded', False),
            'error_message': job_data.get('error', ''),
            'started_at': started_at,
            'finished_at': finished_at,
            'duration_seconds': duration,
        })
        print(f"üìä Logged job {job_id}: mode={job_data.get('mode')}, status={job_data.get('status')}, duration={duration}s")
    except Exception as e:
        print(f"‚ùå Failed to log job {job_id}: {e}")

# =============================================
# HELPER FUNCTIONS
# =============================================

def verify_firebase_token(request):
    auth_header = request.headers.get('Authorization', '')
    if not auth_header.startswith('Bearer '): return None
    token = auth_header.split('Bearer ')[1]
    try:
        return auth.verify_id_token(token)
    except Exception as e:
        print(f"Token verification failed: {e}")
        return None

def is_admin_user(decoded_token):
    if not decoded_token:
        return False
    uid = decoded_token.get('uid', '')
    email = decoded_token.get('email', '').lower()
    return uid in ADMIN_UIDS or email in ADMIN_EMAILS

def get_admin_window(window_key):
    windows = {
        '24h': 24 * 60 * 60,
        '7d': 7 * 24 * 60 * 60,
        '30d': 30 * 24 * 60 * 60,
    }
    safe_key = window_key if window_key in windows else '7d'
    return safe_key, windows[safe_key]

def get_timestamp(value):
    return value if isinstance(value, (int, float)) else 0

def build_time_buckets(window_key, now_ts):
    labels = []
    keys = []
    if window_key == '24h':
        now_dt = datetime.utcfromtimestamp(now_ts).replace(minute=0, second=0, microsecond=0)
        start_dt = now_dt - timedelta(hours=23)
        for i in range(24):
            current = start_dt + timedelta(hours=i)
            labels.append(current.strftime('%H:%M'))
            keys.append(current.strftime('%Y-%m-%d %H:00'))
        granularity = 'hour'
    else:
        days = 7 if window_key == '7d' else 30
        now_dt = datetime.utcfromtimestamp(now_ts).replace(hour=0, minute=0, second=0, microsecond=0)
        start_dt = now_dt - timedelta(days=days - 1)
        for i in range(days):
            current = start_dt + timedelta(days=i)
            labels.append(current.strftime('%d %b'))
            keys.append(current.strftime('%Y-%m-%d'))
        granularity = 'day'
    return labels, keys, granularity

def get_bucket_key(timestamp, window_key):
    dt = datetime.utcfromtimestamp(timestamp)
    if window_key == '24h':
        return dt.replace(minute=0, second=0, microsecond=0).strftime('%Y-%m-%d %H:00')
    return dt.replace(hour=0, minute=0, second=0, microsecond=0).strftime('%Y-%m-%d')

def parse_requested_amount(raw_value, allowed, default):
    value = str(raw_value or default).strip().lower()
    return value if value in allowed else default

def parse_study_features(raw_value):
    value = str(raw_value or 'none').strip().lower()
    return value if value in {'none', 'flashcards', 'test', 'both'} else 'none'

def parse_output_language(raw_value, custom_value=''):
    key = str(raw_value or 'english').strip().lower()
    if key in OUTPUT_LANGUAGE_MAP:
        return OUTPUT_LANGUAGE_MAP[key]
    if key == 'other':
        custom = str(custom_value or '').strip()
        if custom:
            return custom[:40]
    return 'English'

def parse_interview_features(raw_value):
    value = str(raw_value or 'none').strip().lower()
    if value in {'none', ''}:
        return []
    if value == 'both':
        return ['summary', 'sections']
    parts = [part.strip() for part in value.split(',') if part.strip()]
    features = []
    for part in parts:
        if part in {'summary', 'sections'} and part not in features:
            features.append(part)
    return features

def deduct_slides_credits(uid, amount):
    if amount <= 0:
        return True
    user_ref = db.collection('users').document(uid)
    user_doc = user_ref.get()
    if not user_doc.exists:
        return False
    user_data = user_doc.to_dict()
    current = user_data.get('slides_credits', 0)
    if current < amount:
        return False
    user_ref.update({'slides_credits': firestore.Increment(-amount)})
    return True

def refund_slides_credits(uid, amount):
    if not uid or amount <= 0:
        return
    try:
        db.collection('users').document(uid).update({'slides_credits': firestore.Increment(amount)})
        print(f"‚úÖ Refunded {amount} slides credits to user {uid}.")
    except Exception as e:
        print(f"‚ùå Failed to refund {amount} slides credits to user {uid}: {e}")

def generate_with_optional_thinking(model, prompt_text, max_output_tokens=65536, thinking_budget=256):
    base_config = {'max_output_tokens': max_output_tokens}
    try:
        if hasattr(types, 'ThinkingConfig'):
            base_config['thinking_config'] = types.ThinkingConfig(thinking_budget=thinking_budget)
    except Exception:
        pass
    try:
        config = types.GenerateContentConfig(**base_config)
    except Exception:
        config = types.GenerateContentConfig(max_output_tokens=max_output_tokens)
    return client.models.generate_content(
        model=model,
        contents=[types.Content(role='user', parts=[types.Part.from_text(text=prompt_text)])],
        config=config
    )

def convert_audio_to_mp3_with_ytdlp(local_audio_path):
    if not local_audio_path or local_audio_path.lower().endswith('.mp3'):
        return local_audio_path, False
    ytdlp_bin = shutil.which('yt-dlp')
    base_no_ext = os.path.splitext(local_audio_path)[0]
    output_path = f"{base_no_ext}_converted.mp3"

    if ytdlp_bin:
        try:
            source = f"file://{os.path.abspath(local_audio_path)}"
            command = [
                ytdlp_bin,
                '--no-playlist',
                '--extract-audio',
                '--audio-format', 'mp3',
                '--audio-quality', '5',
                '--output', f"{base_no_ext}_converted.%(ext)s",
                source
            ]
            result = subprocess.run(command, check=False, capture_output=True, text=True)
            if result.returncode == 0 and os.path.exists(output_path):
                return output_path, True
            print(f"‚ö†Ô∏è yt-dlp conversion failed: {(result.stderr or '').strip()[:300]}")
        except Exception as e:
            print(f"‚ö†Ô∏è yt-dlp conversion exception: {e}")
    else:
        print("‚ö†Ô∏è yt-dlp not found, skipping yt-dlp conversion.")

    # Fallback conversion for local files when yt-dlp is unavailable or fails.
    ffmpeg_bin = shutil.which('ffmpeg')
    if not ffmpeg_bin:
        return local_audio_path, False
    try:
        command = [
            ffmpeg_bin,
            '-y',
            '-i', local_audio_path,
            '-vn',
            '-codec:a', 'libmp3lame',
            '-q:a', '5',
            output_path
        ]
        result = subprocess.run(command, check=False, capture_output=True, text=True)
        if result.returncode == 0 and os.path.exists(output_path):
            return output_path, True
        print(f"‚ö†Ô∏è ffmpeg conversion failed: {(result.stderr or '').strip()[:300]}")
    except Exception as e:
        print(f"‚ö†Ô∏è ffmpeg conversion exception: {e}")
    return local_audio_path, False

def resolve_auto_amount(kind, source_text):
    word_count = len((source_text or '').split())
    if kind == 'flashcards':
        if word_count < 1200:
            return 10
        if word_count < 2600:
            return 20
        return 30
    if word_count < 1200:
        return 5
    if word_count < 2600:
        return 10
    return 15

def resolve_study_amounts(flashcard_selection, question_selection, source_text):
    flashcard_amount = resolve_auto_amount('flashcards', source_text) if flashcard_selection == 'auto' else int(flashcard_selection)
    question_amount = resolve_auto_amount('questions', source_text) if question_selection == 'auto' else int(question_selection)
    return flashcard_amount, question_amount

def extract_json_payload(raw_text):
    if not raw_text:
        return None
    text = raw_text.strip()
    if text.startswith('```'):
        lines = text.splitlines()
        if len(lines) >= 3 and lines[0].startswith('```') and lines[-1].strip() == '```':
            text = '\n'.join(lines[1:-1]).strip()
    start = text.find('{')
    if start == -1:
        return None
    decoder = json.JSONDecoder()
    try:
        parsed, _ = decoder.raw_decode(text[start:])
        return parsed
    except json.JSONDecodeError:
        end = text.rfind('}')
        if end == -1 or end <= start:
            return None
        try:
            return json.loads(text[start:end + 1])
        except json.JSONDecodeError:
            return None

def sanitize_flashcards(items, max_items):
    if not isinstance(items, list):
        return []
    cleaned = []
    seen = set()
    for item in items:
        if not isinstance(item, dict):
            continue
        front = str(item.get('front', '')).strip()
        back = str(item.get('back', '')).strip()
        if not front or not back:
            continue
        key = (front.lower(), back.lower())
        if key in seen:
            continue
        seen.add(key)
        cleaned.append({'front': front, 'back': back})
        if len(cleaned) >= max_items:
            break
    return cleaned

def sanitize_questions(items, max_items):
    if not isinstance(items, list):
        return []
    cleaned = []
    seen = set()
    for item in items:
        if not isinstance(item, dict):
            continue
        question = str(item.get('question', '')).strip()
        options = item.get('options', [])
        answer = str(item.get('answer', '')).strip()
        explanation = str(item.get('explanation', '')).strip()
        if not question or not isinstance(options, list) or len(options) != 4 or not answer:
            continue
        option_strings = [str(option).strip() for option in options]
        if any(not option for option in option_strings):
            continue
        if len(set(option_strings)) != 4:
            continue
        if answer not in option_strings:
            continue
        dedupe_key = question.lower()
        if dedupe_key in seen:
            continue
        seen.add(dedupe_key)
        cleaned.append({
            'question': question,
            'options': option_strings,
            'answer': answer,
            'explanation': explanation,
        })
        if len(cleaned) >= max_items:
            break
    return cleaned

def generate_study_materials(source_text, flashcard_selection, question_selection, study_features='both', output_language='English'):
    if study_features == 'none':
        return [], [], None
    flashcard_amount, question_amount = resolve_study_amounts(flashcard_selection, question_selection, source_text)
    if study_features == 'flashcards':
        question_amount = 0
    elif study_features == 'test':
        flashcard_amount = 0
    prompt = PROMPT_STUDY_TEMPLATE.format(
        flashcard_amount=flashcard_amount,
        question_amount=question_amount,
        output_language=output_language,
        source_text=source_text[:120000],
    )
    try:
        response = client.models.generate_content(
            model=MODEL_STUDY,
            contents=[types.Content(role='user', parts=[types.Part.from_text(text=prompt)])],
            config=types.GenerateContentConfig(max_output_tokens=32768)
        )
        parsed = extract_json_payload(response.text)
        if not isinstance(parsed, dict):
            return [], [], 'Study materials JSON parsing failed.'
        flashcards = sanitize_flashcards(parsed.get('flashcards', []), flashcard_amount)
        test_questions = sanitize_questions(parsed.get('test_questions', []), question_amount)
        if not flashcards and not test_questions and study_features != 'none':
            return [], [], 'Study materials were empty after validation.'
        return flashcards, test_questions, None
    except Exception as e:
        return [], [], f'Study materials generation failed: {e}'

def generate_interview_enhancements(transcript_text, selected_features, output_language='English'):
    summary_text = None
    sectioned_text = None
    errors = []
    for feature in selected_features:
        try:
            if feature == 'summary':
                prompt = PROMPT_INTERVIEW_SUMMARY.format(transcript=transcript_text[:120000], output_language=output_language)
                response = generate_with_optional_thinking(MODEL_STUDY, prompt, max_output_tokens=8192, thinking_budget=384)
                summary_text = (response.text or '').strip()
                if not summary_text:
                    errors.append('Summary generation returned empty output.')
            elif feature == 'sections':
                prompt = PROMPT_INTERVIEW_SECTIONED.format(transcript=transcript_text[:120000], output_language=output_language)
                response = generate_with_optional_thinking(MODEL_STUDY, prompt, max_output_tokens=32768, thinking_budget=384)
                sectioned_text = (response.text or '').strip()
                if not sectioned_text:
                    errors.append('Sectioned transcript generation returned empty output.')
        except Exception as e:
            errors.append(f"{feature} generation failed: {e}")

    successful = []
    if summary_text:
        successful.append('summary')
    if sectioned_text:
        successful.append('sections')

    combined_text = None
    if summary_text and sectioned_text:
        combined_text = f"# Interview Summary\n\n{summary_text}\n\n# Structured Interview Transcript\n\n{sectioned_text}"

    failed_count = max(0, len(selected_features) - len(successful))
    return {
        'summary': summary_text,
        'sections': sectioned_text,
        'combined': combined_text,
        'successful_features': successful,
        'failed_count': failed_count,
        'error': '; '.join(errors) if errors else None,
    }

def allowed_file(filename, allowed_extensions):
    return '.' in filename and filename.rsplit('.', 1)[1].lower() in allowed_extensions

def get_mime_type(filename):
    ext = filename.rsplit('.', 1)[1].lower()
    mime_types = {'pdf': 'application/pdf', 'mp3': 'audio/mpeg', 'm4a': 'audio/mp4', 'wav': 'audio/wav', 'aac': 'audio/aac', 'ogg': 'audio/ogg', 'flac': 'audio/flac'}
    return mime_types.get(ext, 'application/octet-stream')

def wait_for_file_processing(uploaded_file):
    max_wait_time = 300
    wait_interval = 5
    total_waited = 0
    while total_waited < max_wait_time:
        file_info = client.files.get(name=uploaded_file.name)
        if file_info.state.name == 'ACTIVE': return True
        elif file_info.state.name == 'FAILED': raise Exception(f"File processing failed: {uploaded_file.name}")
        time.sleep(wait_interval)
        total_waited += wait_interval
    raise Exception(f"File processing timed out after {max_wait_time} seconds")

def cleanup_files(local_paths, gemini_files):
    for path in local_paths:
        try:
            if os.path.exists(path): os.remove(path)
        except Exception as e: print(f"Warning: Could not delete local file {path}: {e}")
    for gemini_file in gemini_files:
        try:
            client.files.delete(name=gemini_file.name)
        except Exception as e: print(f"Warning: Could not delete Gemini file {gemini_file.name}: {e}")

def markdown_to_docx(markdown_text, title="Document"):
    doc = Document()
    style = doc.styles['Normal']
    style.font.name = 'Calibri'
    style.font.size = Pt(11)
    lines = markdown_text.split('\n')
    i = 0
    is_transcript = any(len(line.strip()) > 3 and line.strip()[0].isdigit() and ':' in line.strip()[:6] and ' - ' in line for line in lines[:20])
    
    while i < len(lines):
        line = lines[i].strip()
        if not line:
            i += 1
            continue
        if line.startswith('### '): doc.add_heading(line[4:], level=3)
        elif line.startswith('## '): doc.add_heading(line[3:], level=2)
        elif line.startswith('# '): doc.add_heading(line[2:], level=1)
        elif line.startswith('- ') or line.startswith('* '): doc.add_paragraph(line[2:], style='List Bullet')
        elif len(line) > 2 and line[0].isdigit() and line[1] == '.' and line[2] == ' ': doc.add_paragraph(line[3:], style='List Number')
        elif is_transcript and len(line) > 3 and line[0].isdigit() and ':' in line[:6]: doc.add_paragraph(line)
        else:
            if is_transcript:
                p = doc.add_paragraph()
                parts = line.split('**')
                for j, part in enumerate(parts):
                    if j % 2 == 1:
                        run = p.add_run(part)
                        run.bold = True
                    else:
                        italic_parts = part.split('*')
                        for k, italic_part in enumerate(italic_parts):
                            run = p.add_run(italic_part)
                            if k % 2 == 1: run.italic = True
            else:
                paragraph_lines = [line]
                while i + 1 < len(lines):
                    next_line = lines[i + 1].strip()
                    if (next_line and not next_line.startswith('#') and not next_line.startswith('- ') and not next_line.startswith('* ') and not (len(next_line) > 2 and next_line[0].isdigit() and next_line[1] == '.')):
                        paragraph_lines.append(next_line)
                        i += 1
                    else: break
                paragraph_text = ' '.join(paragraph_lines)
                p = doc.add_paragraph()
                parts = paragraph_text.split('**')
                for j, part in enumerate(parts):
                    if j % 2 == 1:
                        run = p.add_run(part)
                        run.bold = True
                    else:
                        italic_parts = part.split('*')
                        for k, italic_part in enumerate(italic_parts):
                            run = p.add_run(italic_part)
                            if k % 2 == 1: run.italic = True
        i += 1
    return doc

def save_study_pack(job_id, job_data):
    try:
        notes_markdown = str(job_data.get('result', '') or '')
        max_notes_chars = 180000
        notes_truncated = len(notes_markdown) > max_notes_chars
        if notes_truncated:
            notes_markdown = notes_markdown[:max_notes_chars]

        doc_ref = db.collection('study_packs').document()
        now_ts = time.time()
        doc_ref.set({
            'study_pack_id': doc_ref.id,
            'source_job_id': job_id,
            'uid': job_data.get('user_id', ''),
            'email': job_data.get('user_email', ''),
            'mode': job_data.get('mode', ''),
            'title': f"{job_data.get('mode', 'study-pack')} {datetime.utcfromtimestamp(now_ts).strftime('%Y-%m-%d %H:%M')}",
            'output_language': job_data.get('output_language', 'English'),
            'notes_markdown': notes_markdown,
            'notes_truncated': notes_truncated,
            'flashcards': job_data.get('flashcards', []),
            'test_questions': job_data.get('test_questions', []),
            'flashcard_selection': job_data.get('flashcard_selection', '20'),
            'question_selection': job_data.get('question_selection', '10'),
            'study_features': job_data.get('study_features', 'none'),
            'interview_features': job_data.get('interview_features', []),
            'interview_summary': job_data.get('interview_summary'),
            'interview_sections': job_data.get('interview_sections'),
            'interview_combined': job_data.get('interview_combined'),
            'study_generation_error': job_data.get('study_generation_error'),
            'course': '',
            'subject': '',
            'semester': '',
            'block': '',
            'folder_id': '',
            'folder_name': '',
            'created_at': now_ts,
            'updated_at': now_ts,
        })
        job_data['study_pack_id'] = doc_ref.id
    except Exception as e:
        print(f"‚ùå Failed to save study pack for job {job_id}: {e}")

# =============================================
# AI PROCESSING FUNCTIONS
# =============================================

def process_lecture_notes(job_id, pdf_path, audio_path):
    gemini_files = []
    local_paths = [pdf_path, audio_path]
    try:
        jobs[job_id]['status'] = 'processing'
        jobs[job_id]['step'] = 1
        jobs[job_id]['step_description'] = 'Extracting text from slides...'
        pdf_file = client.files.upload(file=pdf_path, config={'mime_type': 'application/pdf'})
        gemini_files.append(pdf_file)
        wait_for_file_processing(pdf_file)
        response = client.models.generate_content(model=MODEL_SLIDES, contents=[types.Content(role='user', parts=[types.Part.from_uri(file_uri=pdf_file.uri, mime_type='application/pdf'), types.Part.from_text(text=PROMPT_SLIDE_EXTRACTION)])], config=types.GenerateContentConfig(max_output_tokens=65536))
        slide_text = response.text
        jobs[job_id]['slide_text'] = slide_text
        
        jobs[job_id]['step'] = 2
        jobs[job_id]['step_description'] = 'Transcribing audio...'
        output_language = jobs[job_id].get('output_language', 'English')
        converted_audio_path, converted = convert_audio_to_mp3_with_ytdlp(audio_path)
        if converted and converted_audio_path not in local_paths:
            local_paths.append(converted_audio_path)
        jobs[job_id]['step_description'] = 'Optimizing audio for faster processing...'
        audio_mime_type = get_mime_type(converted_audio_path)
        audio_file = client.files.upload(file=converted_audio_path, config={'mime_type': audio_mime_type})
        gemini_files.append(audio_file)
        jobs[job_id]['step_description'] = 'Processing audio file (this may take a few minutes)...'
        wait_for_file_processing(audio_file)
        jobs[job_id]['step_description'] = 'Generating transcript...'
        audio_prompt = PROMPT_AUDIO_TRANSCRIPTION.format(output_language=output_language)
        response = client.models.generate_content(model=MODEL_AUDIO, contents=[types.Content(role='user', parts=[types.Part.from_uri(file_uri=audio_file.uri, mime_type=audio_mime_type), types.Part.from_text(text=audio_prompt)])], config=types.GenerateContentConfig(max_output_tokens=65536))
        transcript = response.text
        jobs[job_id]['transcript'] = transcript
        
        jobs[job_id]['step'] = 3
        jobs[job_id]['step_description'] = 'Creating complete lecture notes...'
        merge_prompt = PROMPT_MERGE_TEMPLATE.format(slide_text=slide_text, transcript=transcript, output_language=output_language)
        response = client.models.generate_content(model=MODEL_INTEGRATION, contents=[types.Content(role='user', parts=[types.Part.from_text(text=merge_prompt)])], config=types.GenerateContentConfig(max_output_tokens=65536))
        merged_notes = response.text
        jobs[job_id]['result'] = merged_notes

        if jobs[job_id].get('study_features', 'none') != 'none':
            jobs[job_id]['step'] = 4
            jobs[job_id]['step_description'] = 'Generating flashcards and practice test...'
            flashcards, test_questions, study_error = generate_study_materials(
                merged_notes,
                jobs[job_id].get('flashcard_selection', '20'),
                jobs[job_id].get('question_selection', '10'),
                jobs[job_id].get('study_features', 'none'),
                output_language
            )
            jobs[job_id]['flashcards'] = flashcards
            jobs[job_id]['test_questions'] = test_questions
            jobs[job_id]['study_generation_error'] = study_error
        else:
            jobs[job_id]['flashcards'] = []
            jobs[job_id]['test_questions'] = []
            jobs[job_id]['study_generation_error'] = None
        save_study_pack(job_id, jobs[job_id])

        jobs[job_id]['status'] = 'complete'
        jobs[job_id]['step'] = jobs[job_id].get('total_steps', 3)
        jobs[job_id]['step_description'] = 'Complete!'
    except Exception as e:
        jobs[job_id]['status'] = 'error'
        jobs[job_id]['error'] = str(e)
        # Refund the credit since processing failed
        uid = jobs[job_id].get('user_id')
        credit_type = jobs[job_id].get('credit_deducted')
        refund_credit(uid, credit_type)
        jobs[job_id]['credit_refunded'] = True
    finally:
        cleanup_files(local_paths, gemini_files)
        # Log the job to Firestore
        save_job_log(job_id, jobs[job_id], time.time())

def process_slides_only(job_id, pdf_path):
    gemini_files = []
    local_paths = [pdf_path]
    try:
        jobs[job_id]['status'] = 'processing'
        jobs[job_id]['step'] = 1
        jobs[job_id]['step_description'] = 'Extracting text from slides...'
        pdf_file = client.files.upload(file=pdf_path, config={'mime_type': 'application/pdf'})
        gemini_files.append(pdf_file)
        wait_for_file_processing(pdf_file)
        response = client.models.generate_content(model=MODEL_SLIDES, contents=[types.Content(role='user', parts=[types.Part.from_uri(file_uri=pdf_file.uri, mime_type='application/pdf'), types.Part.from_text(text=PROMPT_SLIDE_EXTRACTION)])], config=types.GenerateContentConfig(max_output_tokens=65536))
        extracted_text = response.text
        jobs[job_id]['result'] = extracted_text
        if jobs[job_id].get('study_features', 'none') != 'none':
            jobs[job_id]['step'] = 2
            jobs[job_id]['step_description'] = 'Generating flashcards and practice test...'
            flashcards, test_questions, study_error = generate_study_materials(
                extracted_text,
                jobs[job_id].get('flashcard_selection', '20'),
                jobs[job_id].get('question_selection', '10'),
                jobs[job_id].get('study_features', 'none'),
                jobs[job_id].get('output_language', 'English')
            )
            jobs[job_id]['flashcards'] = flashcards
            jobs[job_id]['test_questions'] = test_questions
            jobs[job_id]['study_generation_error'] = study_error
        else:
            jobs[job_id]['flashcards'] = []
            jobs[job_id]['test_questions'] = []
            jobs[job_id]['study_generation_error'] = None
        save_study_pack(job_id, jobs[job_id])
        jobs[job_id]['status'] = 'complete'
        jobs[job_id]['step'] = jobs[job_id].get('total_steps', 1)
        jobs[job_id]['step_description'] = 'Complete!'
    except Exception as e:
        jobs[job_id]['status'] = 'error'
        jobs[job_id]['error'] = str(e)
        # Refund the credit since processing failed
        uid = jobs[job_id].get('user_id')
        credit_type = jobs[job_id].get('credit_deducted')
        refund_credit(uid, credit_type)
        jobs[job_id]['credit_refunded'] = True
    finally:
        cleanup_files(local_paths, gemini_files)
        # Log the job to Firestore
        save_job_log(job_id, jobs[job_id], time.time())

def process_interview_transcription(job_id, audio_path):
    gemini_files = []
    local_paths = [audio_path]
    try:
        jobs[job_id]['status'] = 'processing'
        jobs[job_id]['step'] = 1
        jobs[job_id]['step_description'] = 'Optimizing audio for faster processing...'
        output_language = jobs[job_id].get('output_language', 'English')
        converted_audio_path, converted = convert_audio_to_mp3_with_ytdlp(audio_path)
        if converted and converted_audio_path not in local_paths:
            local_paths.append(converted_audio_path)
        audio_mime_type = get_mime_type(converted_audio_path)
        audio_file = client.files.upload(file=converted_audio_path, config={'mime_type': audio_mime_type})
        gemini_files.append(audio_file)
        jobs[job_id]['step_description'] = 'Processing audio file (this may take a few minutes)...'
        wait_for_file_processing(audio_file)
        jobs[job_id]['step_description'] = 'Generating transcript with timestamps...'
        interview_prompt = PROMPT_INTERVIEW_TRANSCRIPTION.format(output_language=output_language)
        response = client.models.generate_content(model=MODEL_INTERVIEW, contents=[types.Content(role='user', parts=[types.Part.from_uri(file_uri=audio_file.uri, mime_type=audio_mime_type), types.Part.from_text(text=interview_prompt)])], config=types.GenerateContentConfig(max_output_tokens=65536))
        transcript_text = response.text or ''
        jobs[job_id]['transcript'] = transcript_text
        jobs[job_id]['result'] = transcript_text

        selected_features = jobs[job_id].get('interview_features', [])
        if selected_features:
            jobs[job_id]['step'] = 2
            jobs[job_id]['step_description'] = 'Creating interview summary and sections...'
            enhancement = generate_interview_enhancements(transcript_text, selected_features, output_language)
            jobs[job_id]['interview_summary'] = enhancement.get('summary')
            jobs[job_id]['interview_sections'] = enhancement.get('sections')
            jobs[job_id]['interview_combined'] = enhancement.get('combined')
            jobs[job_id]['interview_features_successful'] = enhancement.get('successful_features', [])
            jobs[job_id]['study_generation_error'] = enhancement.get('error')

            failed_count = enhancement.get('failed_count', 0)
            if failed_count > 0:
                uid = jobs[job_id].get('user_id')
                refund_slides_credits(uid, failed_count)
                jobs[job_id]['extra_slides_refunded'] = jobs[job_id].get('extra_slides_refunded', 0) + failed_count

            if enhancement.get('summary') and enhancement.get('sections'):
                jobs[job_id]['result'] = enhancement.get('combined', transcript_text)
            elif enhancement.get('summary'):
                jobs[job_id]['result'] = enhancement.get('summary')
            elif enhancement.get('sections'):
                jobs[job_id]['result'] = enhancement.get('sections')

        jobs[job_id]['status'] = 'complete'
        jobs[job_id]['step'] = jobs[job_id].get('total_steps', 1)
        jobs[job_id]['step_description'] = 'Complete!'
    except Exception as e:
        jobs[job_id]['status'] = 'error'
        jobs[job_id]['error'] = str(e)
        # Refund the credit since processing failed
        uid = jobs[job_id].get('user_id')
        credit_type = jobs[job_id].get('credit_deducted')
        refund_credit(uid, credit_type)
        extra_spent = jobs[job_id].get('interview_features_cost', 0)
        already_refunded = jobs[job_id].get('extra_slides_refunded', 0)
        to_refund = max(0, extra_spent - already_refunded)
        if to_refund > 0:
            refund_slides_credits(uid, to_refund)
            jobs[job_id]['extra_slides_refunded'] = already_refunded + to_refund
        jobs[job_id]['credit_refunded'] = True
    finally:
        cleanup_files(local_paths, gemini_files)
        # Log the job to Firestore
        save_job_log(job_id, jobs[job_id], time.time())

# =============================================
# ROUTES
# =============================================

@app.route('/')
def index():
    return render_template('landing.html')

@app.route('/dashboard')
def dashboard():
    return render_template('index.html')

@app.route('/features')
def features_page():
    return render_template('features.html')

@app.route('/admin')
def admin_dashboard():
    return render_template('admin.html')

@app.route('/study')
def study_dashboard():
    return render_template('study.html')

@app.route('/api/verify-email', methods=['POST'])
def verify_email():
    email = request.get_json().get('email', '')
    if is_email_allowed(email):
        return jsonify({'allowed': True})
    return jsonify({'allowed': False, 'message': 'Please use your university email or a major email provider (Gmail, Outlook, iCloud, Yahoo).'})

@app.route('/api/auth/user', methods=['GET'])
def get_user():
    decoded_token = verify_firebase_token(request)
    if not decoded_token: return jsonify({'error': 'Unauthorized'}), 401
    uid = decoded_token['uid']
    email = decoded_token.get('email', '')
    if not is_email_allowed(email): return jsonify({'error': 'Email not allowed', 'message': 'Please use your university email.'}), 403
    user = get_or_create_user(uid, email)
    return jsonify({
        'uid': user['uid'], 'email': user['email'],
        'credits': {
            'lecture_standard': user.get('lecture_credits_standard', 0),
            'lecture_extended': user.get('lecture_credits_extended', 0),
            'slides': user.get('slides_credits', 0),
            'interview_short': user.get('interview_credits_short', 0),
            'interview_medium': user.get('interview_credits_medium', 0),
            'interview_long': user.get('interview_credits_long', 0),
        },
        'total_processed': user.get('total_processed', 0)
    })

# --- Stripe Routes ---

@app.route('/api/config', methods=['GET'])
def get_config():
    return jsonify({
        'stripe_publishable_key': STRIPE_PUBLISHABLE_KEY,
        'bundles': {
            bundle_id: {
                'name': bundle['name'],
                'description': bundle['description'],
                'price_cents': bundle['price_cents'],
                'currency': bundle['currency'],
                'credits': bundle['credits'],
            }
            for bundle_id, bundle in CREDIT_BUNDLES.items()
        }
    })

@app.route('/api/create-checkout-session', methods=['POST'])
def create_checkout_session():
    decoded_token = verify_firebase_token(request)
    if not decoded_token:
        return jsonify({'error': 'Please sign in to continue'}), 401

    uid = decoded_token['uid']
    email = decoded_token.get('email', '')

    data = request.get_json()
    bundle_id = data.get('bundle_id', '')

    if bundle_id not in CREDIT_BUNDLES:
        return jsonify({'error': 'Invalid bundle selected'}), 400

    bundle = CREDIT_BUNDLES[bundle_id]

    try:
        checkout_session = stripe.checkout.Session.create(
            payment_method_types=['card', 'ideal'],
            line_items=[{
                'price_data': {
                    'currency': bundle['currency'],
                    'product_data': {
                        'name': bundle['name'],
                        'description': bundle['description'],
                    },
                    'unit_amount': bundle['price_cents'],
                },
                'quantity': 1,
            }],
            mode='payment',
            success_url=request.host_url.rstrip('/') + '?payment=success',
            cancel_url=request.host_url.rstrip('/') + '?payment=cancelled',
            customer_email=email,
            metadata={
                'uid': uid,
                'bundle_id': bundle_id,
            },
        )
        return jsonify({'checkout_url': checkout_session.url})
    except Exception as e:
        print(f"Stripe checkout error: {e}")
        return jsonify({'error': 'Could not create checkout session. Please try again.'}), 500

@app.route('/api/stripe-webhook', methods=['POST'])
def stripe_webhook():
    payload = request.data
    sig_header = request.headers.get('Stripe-Signature', '')

    if STRIPE_WEBHOOK_SECRET:
        try:
            event = stripe.Webhook.construct_event(
                payload, sig_header, STRIPE_WEBHOOK_SECRET
            )
        except ValueError:
            print("Stripe webhook: Invalid payload")
            return 'Invalid payload', 400
        except Exception as e:
            print(f"Stripe webhook signature verification failed: {e}")
            return 'Invalid signature', 400
    else:
        try:
            event = json.loads(payload)
        except json.JSONDecodeError:
            return 'Invalid payload', 400

    if event.get('type') == 'checkout.session.completed':
        session = event['data']['object']
        metadata = session.get('metadata', {})
        uid = metadata.get('uid', '')
        bundle_id = metadata.get('bundle_id', '')
        stripe_session_id = session.get('id', '')

        if uid and bundle_id:
            success = grant_credits_to_user(uid, bundle_id)
            if success:
                print(f"‚úÖ Payment successful! Granted bundle '{bundle_id}' to user '{uid}'")
                # Save purchase record for history
                save_purchase_record(uid, bundle_id, stripe_session_id)
            else:
                print(f"‚ùå Failed to grant bundle '{bundle_id}' to user '{uid}'")
        else:
            print(f"‚ö†Ô∏è Webhook received but missing metadata. uid='{uid}', bundle_id='{bundle_id}'")

    return '', 200

# --- Purchase History Route ---

@app.route('/api/purchase-history', methods=['GET'])
def get_purchase_history():
    decoded_token = verify_firebase_token(request)
    if not decoded_token:
        return jsonify({'error': 'Unauthorized'}), 401

    uid = decoded_token['uid']

    try:
        purchases_ref = db.collection('purchases').where('uid', '==', uid).order_by('created_at', direction=firestore.Query.DESCENDING).limit(50)
        purchases = []
        for doc in purchases_ref.stream():
            p = doc.to_dict()
            purchases.append({
                'id': doc.id,
                'bundle_name': p.get('bundle_name', 'Unknown'),
                'price_cents': p.get('price_cents', 0),
                'currency': p.get('currency', 'eur'),
                'credits': p.get('credits', {}),
                'created_at': p.get('created_at', 0),
            })
        return jsonify({'purchases': purchases})
    except Exception as e:
        print(f"Error fetching purchase history: {e}")
        return jsonify({'purchases': []})

@app.route('/api/study-packs', methods=['GET'])
def get_study_packs():
    decoded_token = verify_firebase_token(request)
    if not decoded_token:
        return jsonify({'error': 'Unauthorized'}), 401

    uid = decoded_token['uid']
    try:
        study_docs = list(db.collection('study_packs').where('uid', '==', uid).limit(200).stream())
        packs = []
        for doc in study_docs:
            pack = doc.to_dict()
            packs.append({
                'study_pack_id': doc.id,
                'title': pack.get('title', ''),
                'mode': pack.get('mode', ''),
                'flashcards_count': len(pack.get('flashcards', [])),
                'test_questions_count': len(pack.get('test_questions', [])),
                'course': pack.get('course', ''),
                'subject': pack.get('subject', ''),
                'semester': pack.get('semester', ''),
                'block': pack.get('block', ''),
                'folder_id': pack.get('folder_id', ''),
                'folder_name': pack.get('folder_name', ''),
                'created_at': pack.get('created_at', 0),
            })
        packs.sort(key=lambda p: p.get('created_at', 0), reverse=True)
        return jsonify({'study_packs': packs[:50]})
    except Exception as e:
        print(f"Error fetching study packs: {e}")
        return jsonify({'study_packs': []})

@app.route('/api/study-packs', methods=['POST'])
def create_study_pack():
    decoded_token = verify_firebase_token(request)
    if not decoded_token:
        return jsonify({'error': 'Unauthorized'}), 401

    uid = decoded_token['uid']
    payload = request.get_json() or {}

    title = str(payload.get('title', '')).strip()[:120]
    if not title:
        title = f"Untitled pack {datetime.utcnow().strftime('%Y-%m-%d %H:%M')}"

    try:
        now_ts = time.time()
        folder_id = str(payload.get('folder_id', '')).strip()
        folder_name = ''
        if folder_id:
            folder_doc = db.collection('study_folders').document(folder_id).get()
            if not folder_doc.exists:
                return jsonify({'error': 'Folder not found'}), 404
            folder_data = folder_doc.to_dict()
            if folder_data.get('uid', '') != uid:
                return jsonify({'error': 'Forbidden'}), 403
            folder_name = folder_data.get('name', '')
        else:
            folder_id = ''

        flashcards = sanitize_flashcards(payload.get('flashcards', []), 500)
        test_questions = sanitize_questions(payload.get('test_questions', []), 500)

        doc_ref = db.collection('study_packs').document()
        doc_ref.set({
            'study_pack_id': doc_ref.id,
            'source_job_id': '',
            'uid': uid,
            'email': decoded_token.get('email', ''),
            'mode': 'manual',
            'title': title,
            'output_language': str(payload.get('output_language', 'English')).strip()[:64] or 'English',
            'notes_markdown': str(payload.get('notes_markdown', '')).strip(),
            'notes_truncated': False,
            'flashcards': flashcards,
            'test_questions': test_questions,
            'flashcard_selection': 'manual',
            'question_selection': 'manual',
            'study_features': 'both',
            'interview_features': [],
            'interview_summary': None,
            'interview_sections': None,
            'interview_combined': None,
            'study_generation_error': None,
            'course': str(payload.get('course', '')).strip()[:120],
            'subject': str(payload.get('subject', '')).strip()[:120],
            'semester': str(payload.get('semester', '')).strip()[:120],
            'block': str(payload.get('block', '')).strip()[:120],
            'folder_id': folder_id,
            'folder_name': folder_name,
            'created_at': now_ts,
            'updated_at': now_ts,
        })

        return jsonify({'ok': True, 'study_pack_id': doc_ref.id})
    except Exception as e:
        print(f"Error creating study pack: {e}")
        return jsonify({'error': 'Could not create study pack'}), 500

@app.route('/api/study-packs/<pack_id>', methods=['GET'])
def get_study_pack(pack_id):
    decoded_token = verify_firebase_token(request)
    if not decoded_token:
        return jsonify({'error': 'Unauthorized'}), 401

    uid = decoded_token['uid']
    try:
        doc = db.collection('study_packs').document(pack_id).get()
        if not doc.exists:
            return jsonify({'error': 'Study pack not found'}), 404
        pack = doc.to_dict()
        if pack.get('uid', '') != uid:
            return jsonify({'error': 'Forbidden'}), 403
        return jsonify({
            'study_pack_id': pack_id,
            'title': pack.get('title', ''),
            'mode': pack.get('mode', ''),
            'output_language': pack.get('output_language', 'English'),
            'notes_markdown': pack.get('notes_markdown', ''),
            'flashcards': pack.get('flashcards', []),
            'test_questions': pack.get('test_questions', []),
            'interview_summary': pack.get('interview_summary'),
            'interview_sections': pack.get('interview_sections'),
            'interview_combined': pack.get('interview_combined'),
            'study_features': pack.get('study_features', 'none'),
            'interview_features': pack.get('interview_features', []),
            'course': pack.get('course', ''),
            'subject': pack.get('subject', ''),
            'semester': pack.get('semester', ''),
            'block': pack.get('block', ''),
            'folder_id': pack.get('folder_id', ''),
            'folder_name': pack.get('folder_name', ''),
            'created_at': pack.get('created_at', 0),
        })
    except Exception as e:
        print(f"Error fetching study pack {pack_id}: {e}")
        return jsonify({'error': 'Could not fetch study pack'}), 500

@app.route('/api/study-packs/<pack_id>', methods=['PATCH'])
def update_study_pack(pack_id):
    decoded_token = verify_firebase_token(request)
    if not decoded_token:
        return jsonify({'error': 'Unauthorized'}), 401
    uid = decoded_token['uid']
    payload = request.get_json() or {}

    try:
        pack_ref = db.collection('study_packs').document(pack_id)
        doc = pack_ref.get()
        if not doc.exists:
            return jsonify({'error': 'Study pack not found'}), 404
        pack = doc.to_dict()
        if pack.get('uid', '') != uid:
            return jsonify({'error': 'Forbidden'}), 403

        updates = {'updated_at': time.time()}
        if 'title' in payload:
            updates['title'] = str(payload.get('title', '')).strip()[:120]
        if 'course' in payload:
            updates['course'] = str(payload.get('course', '')).strip()[:120]
        if 'subject' in payload:
            updates['subject'] = str(payload.get('subject', '')).strip()[:120]
        if 'semester' in payload:
            updates['semester'] = str(payload.get('semester', '')).strip()[:120]
        if 'block' in payload:
            updates['block'] = str(payload.get('block', '')).strip()[:120]
        if 'folder_id' in payload:
            folder_id = str(payload.get('folder_id', '')).strip()
            updates['folder_id'] = ''
            updates['folder_name'] = ''
            if folder_id:
                folder_doc = db.collection('study_folders').document(folder_id).get()
                if not folder_doc.exists:
                    return jsonify({'error': 'Folder not found'}), 404
                folder_data = folder_doc.to_dict()
                if folder_data.get('uid', '') != uid:
                    return jsonify({'error': 'Forbidden'}), 403
                updates['folder_id'] = folder_id
                updates['folder_name'] = folder_data.get('name', '')

        if 'flashcards' in payload:
            updates['flashcards'] = sanitize_flashcards(payload.get('flashcards', []), 500)
        if 'test_questions' in payload:
            updates['test_questions'] = sanitize_questions(payload.get('test_questions', []), 500)

        pack_ref.update(updates)
        return jsonify({'ok': True})
    except Exception as e:
        print(f"Error updating study pack {pack_id}: {e}")
        return jsonify({'error': 'Could not update study pack'}), 500

@app.route('/api/study-packs/<pack_id>', methods=['DELETE'])
def delete_study_pack(pack_id):
    decoded_token = verify_firebase_token(request)
    if not decoded_token:
        return jsonify({'error': 'Unauthorized'}), 401
    uid = decoded_token['uid']
    try:
        pack_ref = db.collection('study_packs').document(pack_id)
        doc = pack_ref.get()
        if not doc.exists:
            return jsonify({'error': 'Study pack not found'}), 404
        pack = doc.to_dict()
        if pack.get('uid', '') != uid:
            return jsonify({'error': 'Forbidden'}), 403
        pack_ref.delete()
        return jsonify({'ok': True})
    except Exception as e:
        print(f"Error deleting study pack {pack_id}: {e}")
        return jsonify({'error': 'Could not delete study pack'}), 500

@app.route('/api/study-folders', methods=['GET'])
def get_study_folders():
    decoded_token = verify_firebase_token(request)
    if not decoded_token:
        return jsonify({'error': 'Unauthorized'}), 401
    uid = decoded_token['uid']
    try:
        docs = list(db.collection('study_folders').where('uid', '==', uid).stream())
        folders = []
        for doc in docs:
            folder = doc.to_dict()
            folders.append({
                'folder_id': doc.id,
                'name': folder.get('name', ''),
                'course': folder.get('course', ''),
                'subject': folder.get('subject', ''),
                'semester': folder.get('semester', ''),
                'block': folder.get('block', ''),
                'created_at': folder.get('created_at', 0),
            })
        folders.sort(key=lambda f: f.get('created_at', 0), reverse=True)
        return jsonify({'folders': folders})
    except Exception as e:
        print(f"Error fetching study folders: {e}")
        return jsonify({'folders': []})

@app.route('/api/study-folders', methods=['POST'])
def create_study_folder():
    decoded_token = verify_firebase_token(request)
    if not decoded_token:
        return jsonify({'error': 'Unauthorized'}), 401
    uid = decoded_token['uid']
    payload = request.get_json() or {}
    name = str(payload.get('name', '')).strip()[:120]
    if not name:
        return jsonify({'error': 'Folder name is required'}), 400
    try:
        now_ts = time.time()
        doc_ref = db.collection('study_folders').document()
        doc_ref.set({
            'folder_id': doc_ref.id,
            'uid': uid,
            'name': name,
            'course': str(payload.get('course', '')).strip()[:120],
            'subject': str(payload.get('subject', '')).strip()[:120],
            'semester': str(payload.get('semester', '')).strip()[:120],
            'block': str(payload.get('block', '')).strip()[:120],
            'created_at': now_ts,
            'updated_at': now_ts,
        })
        return jsonify({'ok': True, 'folder_id': doc_ref.id})
    except Exception as e:
        print(f"Error creating study folder: {e}")
        return jsonify({'error': 'Could not create folder'}), 500

@app.route('/api/study-folders/<folder_id>', methods=['PATCH'])
def update_study_folder(folder_id):
    decoded_token = verify_firebase_token(request)
    if not decoded_token:
        return jsonify({'error': 'Unauthorized'}), 401
    uid = decoded_token['uid']
    payload = request.get_json() or {}
    try:
        folder_ref = db.collection('study_folders').document(folder_id)
        doc = folder_ref.get()
        if not doc.exists:
            return jsonify({'error': 'Folder not found'}), 404
        folder = doc.to_dict()
        if folder.get('uid', '') != uid:
            return jsonify({'error': 'Forbidden'}), 403
        updates = {'updated_at': time.time()}
        if 'name' in payload:
            name = str(payload.get('name', '')).strip()[:120]
            if not name:
                return jsonify({'error': 'Folder name is required'}), 400
            updates['name'] = name
        for field in ['course', 'subject', 'semester', 'block']:
            if field in payload:
                updates[field] = str(payload.get(field, '')).strip()[:120]
        folder_ref.update(updates)
        if 'name' in updates:
            packs = list(db.collection('study_packs').where('uid', '==', uid).where('folder_id', '==', folder_id).stream())
            for pack_doc in packs:
                pack_doc.reference.update({'folder_name': updates['name'], 'updated_at': time.time()})
        return jsonify({'ok': True})
    except Exception as e:
        print(f"Error updating folder {folder_id}: {e}")
        return jsonify({'error': 'Could not update folder'}), 500

@app.route('/api/study-folders/<folder_id>', methods=['DELETE'])
def delete_study_folder(folder_id):
    decoded_token = verify_firebase_token(request)
    if not decoded_token:
        return jsonify({'error': 'Unauthorized'}), 401
    uid = decoded_token['uid']
    try:
        folder_ref = db.collection('study_folders').document(folder_id)
        doc = folder_ref.get()
        if not doc.exists:
            return jsonify({'error': 'Folder not found'}), 404
        folder = doc.to_dict()
        if folder.get('uid', '') != uid:
            return jsonify({'error': 'Forbidden'}), 403
        folder_ref.delete()
        packs = list(db.collection('study_packs').where('uid', '==', uid).where('folder_id', '==', folder_id).stream())
        for pack_doc in packs:
            pack_doc.reference.update({'folder_id': '', 'folder_name': '', 'updated_at': time.time()})
        return jsonify({'ok': True})
    except Exception as e:
        print(f"Error deleting folder {folder_id}: {e}")
        return jsonify({'error': 'Could not delete folder'}), 500

@app.route('/api/admin/overview', methods=['GET'])
def get_admin_overview():
    decoded_token = verify_firebase_token(request)
    if not decoded_token:
        return jsonify({'error': 'Unauthorized'}), 401
    if not is_admin_user(decoded_token):
        return jsonify({'error': 'Forbidden'}), 403

    try:
        window_key, window_seconds = get_admin_window(request.args.get('window', '7d'))
        now_ts = time.time()
        window_start = now_ts - window_seconds

        users_docs = list(db.collection('users').stream())
        purchases_docs = list(db.collection('purchases').stream())
        jobs_docs = list(db.collection('job_logs').stream())

        total_users = len(users_docs)
        new_users = 0
        for doc in users_docs:
            created_at = get_timestamp(doc.to_dict().get('created_at'))
            if created_at >= window_start:
                new_users += 1
        total_processed = sum((doc.to_dict().get('total_processed', 0) or 0) for doc in users_docs)

        total_revenue_cents = 0
        purchase_count = 0
        filtered_purchases = []
        for doc in purchases_docs:
            purchase = doc.to_dict()
            created_at = get_timestamp(purchase.get('created_at'))
            if created_at < window_start:
                continue
            filtered_purchases.append(purchase)
            purchase_count += 1
            total_revenue_cents += purchase.get('price_cents', 0) or 0

        job_count = 0
        success_jobs = 0
        failed_jobs = 0
        refunded_jobs = 0
        durations = []
        filtered_jobs = []
        for doc in jobs_docs:
            job = doc.to_dict()
            finished_at = get_timestamp(job.get('finished_at'))
            if finished_at < window_start:
                continue
            filtered_jobs.append(job)
            job_count += 1
            status = job.get('status', '')
            if status == 'complete':
                success_jobs += 1
            elif status == 'error':
                failed_jobs += 1
            if job.get('credit_refunded'):
                refunded_jobs += 1
            duration = job.get('duration_seconds')
            if isinstance(duration, (int, float)):
                durations.append(duration)

        avg_duration_seconds = round(sum(durations) / len(durations), 1) if durations else 0

        mode_breakdown = {
            'lecture-notes': {'label': 'Lecture Notes', 'total': 0, 'complete': 0, 'error': 0},
            'slides-only': {'label': 'Slides Only', 'total': 0, 'complete': 0, 'error': 0},
            'interview': {'label': 'Interview Transcript', 'total': 0, 'complete': 0, 'error': 0},
            'other': {'label': 'Other', 'total': 0, 'complete': 0, 'error': 0},
        }
        for job in filtered_jobs:
            mode = job.get('mode', '')
            key = mode if mode in mode_breakdown else 'other'
            status = job.get('status', '')
            mode_breakdown[key]['total'] += 1
            if status == 'complete':
                mode_breakdown[key]['complete'] += 1
            elif status == 'error':
                mode_breakdown[key]['error'] += 1

        recent_jobs_sorted = sorted(
            filtered_jobs,
            key=lambda j: get_timestamp(j.get('finished_at')),
            reverse=True
        )[:20]
        recent_jobs = []
        for job in recent_jobs_sorted:
            recent_jobs.append({
                'job_id': job.get('job_id', ''),
                'email': job.get('email', ''),
                'mode': job.get('mode', ''),
                'status': job.get('status', ''),
                'duration_seconds': job.get('duration_seconds', 0),
                'credit_refunded': job.get('credit_refunded', False),
                'finished_at': job.get('finished_at', 0),
            })

        recent_purchases_sorted = sorted(
            filtered_purchases,
            key=lambda p: get_timestamp(p.get('created_at')),
            reverse=True
        )[:20]
        recent_purchases = []
        for purchase in recent_purchases_sorted:
            recent_purchases.append({
                'uid': purchase.get('uid', ''),
                'bundle_name': purchase.get('bundle_name', 'Unknown'),
                'price_cents': purchase.get('price_cents', 0),
                'currency': purchase.get('currency', 'eur'),
                'created_at': purchase.get('created_at', 0),
            })

        trend_labels, trend_keys, trend_granularity = build_time_buckets(window_key, now_ts)
        success_by_bucket = {key: {'complete': 0, 'error': 0} for key in trend_keys}
        revenue_by_bucket = {key: 0 for key in trend_keys}

        for job in filtered_jobs:
            timestamp = get_timestamp(job.get('finished_at'))
            bucket_key = get_bucket_key(timestamp, window_key)
            if bucket_key not in success_by_bucket:
                continue
            status = job.get('status', '')
            if status == 'complete':
                success_by_bucket[bucket_key]['complete'] += 1
            elif status == 'error':
                success_by_bucket[bucket_key]['error'] += 1

        for purchase in filtered_purchases:
            timestamp = get_timestamp(purchase.get('created_at'))
            bucket_key = get_bucket_key(timestamp, window_key)
            if bucket_key not in revenue_by_bucket:
                continue
            revenue_by_bucket[bucket_key] += purchase.get('price_cents', 0) or 0

        success_trend = []
        revenue_trend = []
        for key in trend_keys:
            complete_count = success_by_bucket[key]['complete']
            error_count = success_by_bucket[key]['error']
            total_count = complete_count + error_count
            success_rate = round((complete_count / total_count) * 100, 1) if total_count > 0 else 0
            success_trend.append(success_rate)
            revenue_trend.append(revenue_by_bucket[key])

        return jsonify({
            'window': {
                'key': window_key,
                'start': window_start,
                'end': now_ts,
            },
            'metrics': {
                'total_users': total_users,
                'new_users': new_users,
                'total_processed': total_processed,
                'total_revenue_cents': total_revenue_cents,
                'purchase_count': purchase_count,
                'job_count': job_count,
                'success_jobs': success_jobs,
                'failed_jobs': failed_jobs,
                'refunded_jobs': refunded_jobs,
                'avg_duration_seconds': avg_duration_seconds,
            },
            'trends': {
                'labels': trend_labels,
                'success_rate': success_trend,
                'revenue_cents': revenue_trend,
                'granularity': trend_granularity,
            },
            'mode_breakdown': mode_breakdown,
            'recent_jobs': recent_jobs,
            'recent_purchases': recent_purchases,
        })
    except Exception as e:
        print(f"Error fetching admin overview: {e}")
        return jsonify({'error': 'Could not fetch admin dashboard data'}), 500

@app.route('/api/admin/export', methods=['GET'])
def export_admin_csv():
    decoded_token = verify_firebase_token(request)
    if not decoded_token:
        return jsonify({'error': 'Unauthorized'}), 401
    if not is_admin_user(decoded_token):
        return jsonify({'error': 'Forbidden'}), 403

    export_type = request.args.get('type', 'jobs')
    if export_type not in {'jobs', 'purchases'}:
        return jsonify({'error': 'Invalid export type'}), 400

    window_key, window_seconds = get_admin_window(request.args.get('window', '7d'))
    now_ts = time.time()
    window_start = now_ts - window_seconds

    output = io.StringIO()
    writer = csv.writer(output)

    try:
        if export_type == 'jobs':
            writer.writerow([
                'job_id', 'uid', 'email', 'mode', 'status', 'credit_deducted',
                'credit_refunded', 'error_message', 'started_at', 'finished_at', 'duration_seconds'
            ])
            for doc in db.collection('job_logs').stream():
                job = doc.to_dict()
                finished_at = get_timestamp(job.get('finished_at'))
                if finished_at < window_start:
                    continue
                writer.writerow([
                    job.get('job_id', doc.id),
                    job.get('uid', ''),
                    job.get('email', ''),
                    job.get('mode', ''),
                    job.get('status', ''),
                    job.get('credit_deducted', ''),
                    job.get('credit_refunded', False),
                    job.get('error_message', ''),
                    job.get('started_at', 0),
                    job.get('finished_at', 0),
                    job.get('duration_seconds', 0),
                ])
        else:
            writer.writerow([
                'uid', 'bundle_id', 'bundle_name', 'price_cents', 'currency',
                'credits', 'stripe_session_id', 'created_at'
            ])
            for doc in db.collection('purchases').stream():
                purchase = doc.to_dict()
                created_at = get_timestamp(purchase.get('created_at'))
                if created_at < window_start:
                    continue
                writer.writerow([
                    purchase.get('uid', ''),
                    purchase.get('bundle_id', ''),
                    purchase.get('bundle_name', ''),
                    purchase.get('price_cents', 0),
                    purchase.get('currency', 'eur'),
                    json.dumps(purchase.get('credits', {}), ensure_ascii=True),
                    purchase.get('stripe_session_id', ''),
                    purchase.get('created_at', 0),
                ])

        filename = f"admin-{export_type}-{window_key}.csv"
        response = app.response_class(output.getvalue(), mimetype='text/csv')
        response.headers['Content-Disposition'] = f'attachment; filename={filename}'
        return response
    except Exception as e:
        print(f"Error exporting admin CSV ({export_type}): {e}")
        return jsonify({'error': 'Could not export CSV'}), 500

# --- Upload & Processing Routes ---

@app.route('/upload', methods=['POST'])
def upload_files():
    decoded_token = verify_firebase_token(request)
    if not decoded_token: return jsonify({'error': 'Please sign in to continue'}), 401
    uid = decoded_token['uid']
    email = decoded_token.get('email', '')
    if not is_email_allowed(email): return jsonify({'error': 'Email not allowed'}), 403
    user = get_or_create_user(uid, email)
    mode = request.form.get('mode', 'lecture-notes')
    flashcard_selection = parse_requested_amount(request.form.get('flashcard_amount', '20'), {'10', '20', '30', 'auto'}, '20')
    question_selection = parse_requested_amount(request.form.get('question_amount', '10'), {'5', '10', '15', 'auto'}, '10')
    output_language = parse_output_language(request.form.get('output_language', 'english'), request.form.get('output_language_custom', ''))
    study_features = parse_study_features(request.form.get('study_features', 'none'))
    interview_features = parse_interview_features(request.form.get('interview_features', 'none'))
    
    if mode == 'lecture-notes':
        total_lecture = user.get('lecture_credits_standard', 0) + user.get('lecture_credits_extended', 0)
        if total_lecture <= 0:
            return jsonify({'error': 'No lecture credits remaining. Please purchase more credits.'}), 402
        if 'pdf' not in request.files or 'audio' not in request.files: return jsonify({'error': 'Both PDF and audio files are required'}), 400
        pdf_file = request.files['pdf']
        audio_file = request.files['audio']
        if pdf_file.filename == '' or audio_file.filename == '': return jsonify({'error': 'Both files must be selected'}), 400
        if not allowed_file(pdf_file.filename, ALLOWED_PDF_EXTENSIONS): return jsonify({'error': 'Invalid PDF file'}), 400
        if not allowed_file(audio_file.filename, ALLOWED_AUDIO_EXTENSIONS): return jsonify({'error': 'Invalid audio file'}), 400
        job_id = str(uuid.uuid4())
        pdf_path = os.path.join(UPLOAD_FOLDER, f"{job_id}_{secure_filename(pdf_file.filename)}")
        audio_path = os.path.join(UPLOAD_FOLDER, f"{job_id}_{secure_filename(audio_file.filename)}")
        pdf_file.save(pdf_path)
        audio_file.save(audio_path)
        deducted = deduct_credit(uid, 'lecture_credits_standard', 'lecture_credits_extended')
        if not deducted:
            return jsonify({'error': 'No lecture credits remaining.'}), 402
        total_steps = 4 if study_features != 'none' else 3
        jobs[job_id] = {'status': 'starting', 'step': 0, 'step_description': 'Starting...', 'total_steps': total_steps, 'mode': 'lecture-notes', 'user_id': uid, 'user_email': email, 'credit_deducted': deducted, 'credit_refunded': False, 'started_at': time.time(), 'result': None, 'slide_text': None, 'transcript': None, 'flashcard_selection': flashcard_selection, 'question_selection': question_selection, 'study_features': study_features, 'output_language': output_language, 'flashcards': [], 'test_questions': [], 'study_generation_error': None, 'study_pack_id': None, 'error': None}
        thread = threading.Thread(target=process_lecture_notes, args=(job_id, pdf_path, audio_path))
        thread.start()
        
    elif mode == 'slides-only':
        if user.get('slides_credits', 0) <= 0:
            return jsonify({'error': 'No slides credits remaining. Please purchase more credits.'}), 402
        if 'pdf' not in request.files: return jsonify({'error': 'PDF file is required'}), 400
        pdf_file = request.files['pdf']
        if pdf_file.filename == '': return jsonify({'error': 'PDF file must be selected'}), 400
        if not allowed_file(pdf_file.filename, ALLOWED_PDF_EXTENSIONS): return jsonify({'error': 'Invalid PDF file'}), 400
        job_id = str(uuid.uuid4())
        pdf_path = os.path.join(UPLOAD_FOLDER, f"{job_id}_{secure_filename(pdf_file.filename)}")
        pdf_file.save(pdf_path)
        deducted = deduct_credit(uid, 'slides_credits')
        if not deducted:
            return jsonify({'error': 'No slides credits remaining.'}), 402
        total_steps = 2 if study_features != 'none' else 1
        jobs[job_id] = {'status': 'starting', 'step': 0, 'step_description': 'Starting...', 'total_steps': total_steps, 'mode': 'slides-only', 'user_id': uid, 'user_email': email, 'credit_deducted': deducted, 'credit_refunded': False, 'started_at': time.time(), 'result': None, 'flashcard_selection': flashcard_selection, 'question_selection': question_selection, 'study_features': study_features, 'output_language': output_language, 'flashcards': [], 'test_questions': [], 'study_generation_error': None, 'study_pack_id': None, 'error': None}
        thread = threading.Thread(target=process_slides_only, args=(job_id, pdf_path))
        thread.start()
        
    elif mode == 'interview':
        total_interview = user.get('interview_credits_short', 0) + user.get('interview_credits_medium', 0) + user.get('interview_credits_long', 0)
        if total_interview <= 0:
            return jsonify({'error': 'No interview credits remaining. Please purchase more credits.'}), 402
        if 'audio' not in request.files: return jsonify({'error': 'Audio file is required'}), 400
        audio_file = request.files['audio']
        if audio_file.filename == '': return jsonify({'error': 'Audio file must be selected'}), 400
        if not allowed_file(audio_file.filename, ALLOWED_AUDIO_EXTENSIONS): return jsonify({'error': 'Invalid audio file'}), 400
        job_id = str(uuid.uuid4())
        audio_path = os.path.join(UPLOAD_FOLDER, f"{job_id}_{secure_filename(audio_file.filename)}")
        audio_file.save(audio_path)
        deducted = deduct_interview_credit(uid)
        if not deducted:
            return jsonify({'error': 'No interview credits remaining.'}), 402
        interview_features_cost = len(interview_features)
        if interview_features_cost > 0:
            if user.get('slides_credits', 0) < interview_features_cost:
                refund_credit(uid, deducted)
                return jsonify({'error': f'Not enough slides credits for interview extras. You selected {interview_features_cost} option(s) and need {interview_features_cost} slides credits.'}), 402
            if not deduct_slides_credits(uid, interview_features_cost):
                refund_credit(uid, deducted)
                return jsonify({'error': 'Could not reserve slides credits for interview extras. Please try again.'}), 402
        total_steps = 2 if interview_features_cost > 0 else 1
        jobs[job_id] = {
            'status': 'starting',
            'step': 0,
            'step_description': 'Starting...',
            'total_steps': total_steps,
            'mode': 'interview',
            'user_id': uid,
            'user_email': email,
            'credit_deducted': deducted,
            'credit_refunded': False,
            'started_at': time.time(),
            'result': None,
            'transcript': None,
            'flashcards': [],
            'test_questions': [],
            'study_features': 'none',
            'output_language': output_language,
            'interview_features': interview_features,
            'interview_features_cost': interview_features_cost,
            'interview_features_successful': [],
            'interview_summary': None,
            'interview_sections': None,
            'interview_combined': None,
            'extra_slides_refunded': 0,
            'study_generation_error': None,
            'error': None
        }
        thread = threading.Thread(target=process_interview_transcription, args=(job_id, audio_path))
        thread.start()
        
    return jsonify({'job_id': job_id})

@app.route('/status/<job_id>')
def get_status(job_id):
    if job_id not in jobs: return jsonify({'error': 'Job not found'}), 404
    job = jobs[job_id]
    response = {'status': job['status'], 'step': job['step'], 'step_description': job['step_description'], 'total_steps': job.get('total_steps', 3), 'mode': job.get('mode', 'lecture-notes')}
    if job['status'] == 'complete':
        response['result'] = job['result']
        response['flashcards'] = job.get('flashcards', [])
        response['test_questions'] = job.get('test_questions', [])
        response['study_generation_error'] = job.get('study_generation_error')
        response['study_pack_id'] = job.get('study_pack_id')
        response['study_features'] = job.get('study_features', 'none')
        response['output_language'] = job.get('output_language', 'English')
        response['interview_features'] = job.get('interview_features', [])
        response['interview_features_successful'] = job.get('interview_features_successful', [])
        response['interview_summary'] = job.get('interview_summary')
        response['interview_sections'] = job.get('interview_sections')
        response['interview_combined'] = job.get('interview_combined')
        if job.get('mode') == 'lecture-notes':
            response['slide_text'] = job.get('slide_text')
            response['transcript'] = job.get('transcript')
        if job.get('mode') == 'interview':
            response['transcript'] = job.get('transcript')
    elif job['status'] == 'error':
        response['error'] = job['error']
        response['credit_refunded'] = job.get('credit_refunded', False)
    return jsonify(response)

@app.route('/download-docx/<job_id>')
def download_docx(job_id):
    if job_id not in jobs: return jsonify({'error': 'Job not found'}), 404
    job = jobs[job_id]
    if job['status'] != 'complete': return jsonify({'error': 'Job not complete'}), 400
    content_type = request.args.get('type', 'result')
    
    if content_type == 'slides' and job.get('slide_text'):
        content, filename, title = job['slide_text'], 'extracted-slides.docx', 'Extracted Slides'
    elif content_type == 'transcript' and job.get('transcript'):
        content, filename, title = job['transcript'], 'transcript.docx', 'Lecture Transcript'
    elif content_type == 'summary' and job.get('interview_summary'):
        content, filename, title = job['interview_summary'], 'interview-summary.docx', 'Interview Summary'
    elif content_type == 'sections' and job.get('interview_sections'):
        content, filename, title = job['interview_sections'], 'interview-structured.docx', 'Structured Interview Transcript'
    elif content_type == 'combined' and job.get('interview_combined'):
        content, filename, title = job['interview_combined'], 'interview-summary-structured.docx', 'Interview Summary + Structured Transcript'
    else:
        content = job['result']
        mode = job.get('mode', 'lecture-notes')
        if mode == 'lecture-notes': filename, title = 'lecture-notes.docx', 'Lecture Notes'
        elif mode == 'slides-only': filename, title = 'extracted-slides.docx', 'Extracted Slides'
        else: filename, title = 'interview-transcript.docx', 'Interview Transcript'
        
    doc = markdown_to_docx(content, title)
    docx_io = io.BytesIO()
    doc.save(docx_io)
    docx_io.seek(0)
    return send_file(docx_io, mimetype='application/vnd.openxmlformats-officedocument.wordprocessingml.document', as_attachment=True, download_name=filename)

@app.route('/download-flashcards-csv/<job_id>')
def download_flashcards_csv(job_id):
    if job_id not in jobs:
        return jsonify({'error': 'Job not found'}), 404
    job = jobs[job_id]
    if job.get('status') != 'complete':
        return jsonify({'error': 'Job not complete'}), 400
    export_type = request.args.get('type', 'flashcards').strip().lower()

    output = io.StringIO()
    writer = csv.writer(output)
    if export_type == 'test':
        test_questions = job.get('test_questions', [])
        if not test_questions:
            return jsonify({'error': 'No practice questions available for this job'}), 400
        writer.writerow(['question', 'option_a', 'option_b', 'option_c', 'option_d', 'answer', 'explanation'])
        for q in test_questions:
            options = q.get('options', [])
            padded = (options + ['', '', '', ''])[:4]
            writer.writerow([
                q.get('question', ''),
                padded[0],
                padded[1],
                padded[2],
                padded[3],
                q.get('answer', ''),
                q.get('explanation', ''),
            ])
        filename = f'practice-test-{job_id}.csv'
    else:
        flashcards = job.get('flashcards', [])
        if not flashcards:
            return jsonify({'error': 'No flashcards available for this job'}), 400
        writer.writerow(['question', 'answer'])
        for card in flashcards:
            writer.writerow([card.get('front', ''), card.get('back', '')])
        filename = f'flashcards-{job_id}.csv'

    csv_bytes = io.BytesIO(output.getvalue().encode('utf-8'))
    csv_bytes.seek(0)
    return send_file(csv_bytes, mimetype='text/csv', as_attachment=True, download_name=filename)

@app.route('/api/study-packs/<pack_id>/export-flashcards-csv', methods=['GET'])
def export_study_pack_flashcards_csv(pack_id):
    decoded_token = verify_firebase_token(request)
    if not decoded_token:
        return jsonify({'error': 'Unauthorized'}), 401
    uid = decoded_token['uid']
    try:
        doc = db.collection('study_packs').document(pack_id).get()
        if not doc.exists:
            return jsonify({'error': 'Study pack not found'}), 404
        pack = doc.to_dict()
        if pack.get('uid', '') != uid:
            return jsonify({'error': 'Forbidden'}), 403
        export_type = request.args.get('type', 'flashcards').strip().lower()
        output = io.StringIO()
        writer = csv.writer(output)
        if export_type == 'test':
            test_questions = pack.get('test_questions', [])
            if not test_questions:
                return jsonify({'error': 'No practice questions available'}), 400
            writer.writerow(['question', 'option_a', 'option_b', 'option_c', 'option_d', 'answer', 'explanation'])
            for q in test_questions:
                options = q.get('options', [])
                padded = (options + ['', '', '', ''])[:4]
                writer.writerow([
                    q.get('question', ''),
                    padded[0],
                    padded[1],
                    padded[2],
                    padded[3],
                    q.get('answer', ''),
                    q.get('explanation', ''),
                ])
            filename = f'study-pack-{pack_id}-practice-test.csv'
        else:
            flashcards = pack.get('flashcards', [])
            if not flashcards:
                return jsonify({'error': 'No flashcards available'}), 400
            writer.writerow(['question', 'answer'])
            for card in flashcards:
                writer.writerow([card.get('front', ''), card.get('back', '')])
            filename = f'study-pack-{pack_id}-flashcards.csv'
        csv_bytes = io.BytesIO(output.getvalue().encode('utf-8'))
        csv_bytes.seek(0)
        return send_file(csv_bytes, mimetype='text/csv', as_attachment=True, download_name=filename)
    except Exception as e:
        print(f"Error exporting study pack flashcards CSV {pack_id}: {e}")
        return jsonify({'error': 'Could not export CSV'}), 500

if __name__ == '__main__':
    app.run(debug=True, port=5000)


===== templates/index.html =====
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lecture Processor ‚Äî AI-Powered Study Notes</title>
    <style>
        :root {
            --primary: #4F46E5;
            --primary-dark: #4338CA;
            --primary-light: #818CF8;
            --secondary: #0EA5E9;
            --success: #10B981;
            --warning: #F59E0B;
            --error: #EF4444;
            --gray-50: #F9FAFB;
            --gray-100: #F3F4F6;
            --gray-200: #E5E7EB;
            --gray-300: #D1D5DB;
            --gray-400: #9CA3AF;
            --gray-500: #6B7280;
            --gray-600: #4B5563;
            --gray-700: #374151;
            --gray-800: #1F2937;
            --gray-900: #111827;
            --white: #FFFFFF;
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
            --shadow-xl: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1);
            --radius-sm: 6px; --radius: 8px; --radius-md: 12px; --radius-lg: 16px; --radius-xl: 24px;
        }
        *, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }
        html { scroll-behavior: smooth; }
        body { font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: linear-gradient(135deg, var(--gray-50) 0%, var(--gray-100) 100%); color: var(--gray-800); line-height: 1.6; min-height: 100vh; -webkit-font-smoothing: antialiased; }
        .container { max-width: 1000px; margin: 0 auto; padding: 0 24px; }
        .header { padding: 16px 0; border-bottom: 1px solid var(--gray-200); position: sticky; top: 0; z-index: 100; backdrop-filter: blur(10px); background: rgba(255,255,255,0.95); }
        .header-content { display: flex; align-items: center; justify-content: space-between; gap: 16px; }
        .logo { display: flex; align-items: center; gap: 12px; text-decoration: none; color: var(--gray-900); }
        .logo-icon { width: 40px; height: 40px; background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%); border-radius: var(--radius-md); display: flex; align-items: center; justify-content: center; color: var(--white); }
        .logo-icon svg { width: 24px; height: 24px; }
        .logo-text { font-size: 1.25rem; font-weight: 700; letter-spacing: -0.025em; }
        @media (max-width: 600px) { .logo-text { display: none; } }
        .header-right { display: flex; align-items: center; gap: 16px; }
        .header-nav-link { display: inline-flex; align-items: center; gap: 8px; padding: 10px 14px; background: var(--white); border: 1px solid var(--gray-300); border-radius: var(--radius); font-size: 0.875rem; font-weight: 600; color: var(--gray-700); text-decoration: none; transition: all 0.2s ease; }
        .header-nav-link:hover { background: var(--gray-50); border-color: var(--gray-400); color: var(--gray-900); }
        .header-nav-link.active { background: rgba(79,70,229,0.08); border-color: rgba(79,70,229,0.35); color: var(--primary-dark); }
        .header-nav-link svg { width: 16px; height: 16px; }
        @media (max-width: 600px) { .header-nav-link span { display: none; } .header-nav-link { padding: 10px; } }
        .credits-display { display: flex; align-items: center; gap: 8px; padding: 8px 14px; background: var(--gray-100); border-radius: var(--radius); font-size: 0.875rem; color: var(--gray-700); }
        .credits-display svg { width: 18px; height: 18px; color: var(--primary); }
        .credits-count { font-weight: 600; color: var(--gray-900); }
        .user-menu { position: relative; }
        .user-button { display: flex; align-items: center; gap: 10px; padding: 6px 12px 6px 6px; background: var(--white); border: 1px solid var(--gray-200); border-radius: var(--radius-lg); cursor: pointer; transition: all 0.2s; }
        .user-button:hover { border-color: var(--gray-300); background: var(--gray-50); }
        .user-avatar { width: 32px; height: 32px; border-radius: 50%; background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%); display: flex; align-items: center; justify-content: center; color: var(--white); font-size: 0.875rem; font-weight: 600; }
        .user-avatar img { width: 100%; height: 100%; border-radius: 50%; object-fit: cover; }
        .user-name { font-size: 0.875rem; font-weight: 500; color: var(--gray-700); max-width: 120px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        @media (max-width: 600px) { .user-name { display: none; } }
        .user-dropdown { position: absolute; top: calc(100% + 8px); right: 0; background: var(--white); border: 1px solid var(--gray-200); border-radius: var(--radius-md); box-shadow: var(--shadow-lg); min-width: 220px; display: none; z-index: 50; overflow: hidden; }
        .user-dropdown.visible { display: block; animation: dropdownOpen 0.2s ease-out; }
        .user-dropdown-header { padding: 16px; border-bottom: 1px solid var(--gray-100); }
        .user-dropdown-email { font-size: 0.8125rem; color: var(--gray-500); word-break: break-all; }
        .user-dropdown-credits { margin-top: 12px; display: flex; flex-direction: column; gap: 6px; }
        .credit-row { display: flex; justify-content: space-between; font-size: 0.8125rem; }
        .credit-label { color: var(--gray-600); }
        .credit-value { font-weight: 600; color: var(--gray-900); }
        .user-dropdown-item { display: flex; align-items: center; gap: 10px; width: 100%; padding: 12px 16px; border: none; background: none; font-size: 0.875rem; color: var(--gray-700); cursor: pointer; transition: background 0.15s; text-align: left; }
        .user-dropdown-item:hover { background: var(--gray-50); }
        .user-dropdown-item svg { width: 18px; height: 18px; color: var(--gray-500); }
        .user-dropdown-item.danger { color: var(--error); }
        .user-dropdown-item.danger svg { color: var(--error); }
        .sign-in-button { display: flex; align-items: center; gap: 10px; padding: 10px 20px; background: var(--white); border: 1px solid var(--gray-300); border-radius: var(--radius); font-size: 0.9375rem; font-weight: 500; color: var(--gray-700); cursor: pointer; transition: all 0.2s; }
        .sign-in-button:hover { background: var(--gray-50); border-color: var(--gray-400); }
        .sign-in-button svg { width: 20px; height: 20px; }
        .header-link-button { display: none; align-items: center; gap: 8px; padding: 10px 16px; background: var(--white); border: 1px solid var(--gray-300); border-radius: var(--radius); font-size: 0.875rem; font-weight: 600; color: var(--gray-700); cursor: pointer; transition: all 0.2s ease; }
        .header-link-button:hover { background: var(--gray-50); border-color: var(--gray-400); color: var(--gray-900); }
        .header-link-button svg { width: 18px; height: 18px; }
        .auth-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 200; align-items: center; justify-content: center; padding: 24px; }
        .auth-overlay.visible { display: flex; }
        .auth-modal { background: var(--white); border-radius: var(--radius-xl); padding: 40px; max-width: 420px; width: 100%; text-align: center; box-shadow: var(--shadow-xl); animation: modalOpen 0.3s ease-out; position: relative; }
        .auth-modal-close { position: absolute; top: 16px; right: 16px; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; background: none; border: none; color: var(--gray-400); cursor: pointer; border-radius: 50%; transition: all 0.2s; }
        .auth-modal-close:hover { background: var(--gray-100); color: var(--gray-600); }
        .auth-modal-close svg { width: 20px; height: 20px; }
        .auth-modal-icon { width: 64px; height: 64px; background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%); border-radius: var(--radius-lg); display: flex; align-items: center; justify-content: center; margin: 0 auto 24px; color: var(--white); }
        .auth-modal-icon svg { width: 32px; height: 32px; }
        .auth-modal h2 { font-size: 1.5rem; font-weight: 700; color: var(--gray-900); margin-bottom: 8px; }
        .auth-modal-subtitle { font-size: 0.9375rem; color: var(--gray-600); margin-bottom: 24px; }
        .auth-form { text-align: left; }
        .form-group { margin-bottom: 16px; }
        .form-label { display: block; font-size: 0.875rem; font-weight: 500; color: var(--gray-700); margin-bottom: 6px; }
        .form-input { width: 100%; padding: 12px 16px; font-size: 1rem; border: 1px solid var(--gray-300); border-radius: var(--radius); transition: all 0.2s; background: var(--white); color: var(--gray-900); }
        .form-input:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px rgba(79,70,229,0.1); }
        .form-input::placeholder { color: var(--gray-400); }
        .password-input-wrapper { position: relative; }
        .password-toggle { position: absolute; right: 12px; top: 50%; transform: translateY(-50%); background: none; border: none; color: var(--gray-400); cursor: pointer; padding: 4px; }
        .password-toggle:hover { color: var(--gray-600); }
        .password-toggle svg { width: 20px; height: 20px; }
        .form-footer { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; font-size: 0.875rem; }
        .form-footer a { color: var(--primary); text-decoration: none; }
        .form-footer a:hover { text-decoration: underline; }
        .auth-submit-btn { width: 100%; padding: 14px 24px; background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%); color: var(--white); border: none; border-radius: var(--radius); font-size: 1rem; font-weight: 600; cursor: pointer; transition: all 0.2s; }
        .auth-submit-btn:hover:not(:disabled) { opacity: 0.9; transform: translateY(-1px); }
        .auth-submit-btn:disabled { opacity: 0.6; cursor: not-allowed; }
        .auth-divider { display: flex; align-items: center; margin: 24px 0; color: var(--gray-400); font-size: 0.875rem; }
        .auth-divider::before, .auth-divider::after { content: ''; flex: 1; height: 1px; background: var(--gray-200); }
        .auth-divider span { padding: 0 16px; }
        .google-sign-in-button { display: flex; align-items: center; justify-content: center; gap: 12px; width: 100%; padding: 14px 24px; background: var(--white); border: 1px solid var(--gray-300); border-radius: var(--radius); font-size: 1rem; font-weight: 500; color: var(--gray-700); cursor: pointer; transition: all 0.2s; }
        .google-sign-in-button:hover { background: var(--gray-50); border-color: var(--gray-400); }
        .google-sign-in-button img { width: 20px; height: 20px; }
        .auth-switch { margin-top: 24px; font-size: 0.875rem; color: var(--gray-600); }
        .auth-switch a { color: var(--primary); text-decoration: none; font-weight: 500; }
        .auth-switch a:hover { text-decoration: underline; }
        .auth-error { margin-top: 16px; padding: 12px 16px; background: rgba(239,68,68,0.1); border-radius: var(--radius); font-size: 0.875rem; color: var(--error); text-align: center; display: none; }
        .auth-error.visible { display: block; }
        .auth-success { margin-top: 16px; padding: 12px 16px; background: rgba(16,185,129,0.1); border-radius: var(--radius); font-size: 0.875rem; color: var(--success); text-align: center; display: none; }
        .auth-success.visible { display: block; }
        .auth-view { display: none; }
        .auth-view.active { display: block; }
        .back-to-login { display: inline-flex; align-items: center; gap: 6px; color: var(--gray-600); font-size: 0.875rem; text-decoration: none; margin-bottom: 20px; }
        .back-to-login:hover { color: var(--gray-900); }
        .back-to-login svg { width: 16px; height: 16px; }
        .sign-in-required { display: none; text-align: center; padding: 48px 24px; background: var(--gray-50); border-radius: var(--radius-lg); margin-top: 32px; }
        .sign-in-required.visible { display: block; }
        .sign-in-required p { font-size: 1rem; color: var(--gray-600); margin-bottom: 20px; }
        .hero { padding: 60px 0 40px; text-align: center; }
        .hero-badge { display: inline-flex; align-items: center; gap: 8px; padding: 8px 16px; background: linear-gradient(135deg, rgba(79,70,229,0.1) 0%, rgba(14,165,233,0.1) 100%); border: 1px solid rgba(79,70,229,0.2); border-radius: 20px; font-size: 0.875rem; font-weight: 500; color: var(--primary); margin-bottom: 24px; }
        .hero-badge svg { width: 16px; height: 16px; }
        .hero-title { font-size: clamp(2rem, 5vw, 3rem); font-weight: 800; color: var(--gray-900); line-height: 1.2; letter-spacing: -0.025em; margin-bottom: 16px; }
        .hero-title span { background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
        .hero-description { font-size: 1.125rem; color: var(--gray-600); max-width: 600px; margin: 0 auto 40px; }
        .features { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-bottom: 50px; }
        @media (max-width: 768px) { .features { grid-template-columns: 1fr; } }
        .feature-card { background: var(--white); border: 1px solid var(--gray-200); border-radius: var(--radius-lg); padding: 24px; text-align: center; transition: all 0.3s ease; }
        .feature-card:hover { border-color: var(--primary-light); box-shadow: var(--shadow-md); transform: translateY(-2px); }
        .feature-icon { width: 48px; height: 48px; background: var(--gray-100); border-radius: var(--radius-md); display: flex; align-items: center; justify-content: center; margin: 0 auto 16px; color: var(--primary); transition: all 0.3s ease; }
        .feature-card:hover .feature-icon { background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%); color: var(--white); }
        .feature-icon svg { width: 24px; height: 24px; }
        .feature-title { font-size: 1rem; font-weight: 600; color: var(--gray-900); margin-bottom: 8px; }
        .feature-description { font-size: 0.875rem; color: var(--gray-500); }
        .app-card { background: var(--white); border: 1px solid var(--gray-200); border-radius: var(--radius-xl); padding: 32px; box-shadow: var(--shadow-lg); margin-bottom: 40px; }
        .mode-section { margin-bottom: 32px; }
        .mode-label { display: block; font-size: 0.75rem; font-weight: 600; color: var(--gray-500); text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 12px; }
        .mode-tabs { display: flex; gap: 8px; background: var(--gray-100); border-radius: var(--radius-md); padding: 4px; }
        @media (max-width: 500px) { .mode-tabs { flex-direction: column; } }
        .mode-tab { flex: 1; padding: 12px 16px; border: none; background: transparent; font-size: 0.875rem; font-weight: 500; color: var(--gray-600); cursor: pointer; border-radius: var(--radius); transition: all 0.2s ease; }
        .mode-tab:hover { color: var(--gray-900); }
        .mode-tab.active { background: var(--white); color: var(--gray-900); box-shadow: var(--shadow-sm); }
        .mode-description { margin-top: 16px; padding: 16px; background: var(--gray-50); border-radius: var(--radius); font-size: 0.875rem; color: var(--gray-600); display: flex; align-items: flex-start; gap: 12px; }
        .mode-description svg { width: 20px; height: 20px; color: var(--primary); flex-shrink: 0; margin-top: 1px; }
        .mode-credit-cost { margin-top: 8px; font-size: 0.8125rem; color: var(--gray-500); }
        .mode-credit-cost strong { color: var(--primary); }
        .upload-section { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 32px; }
        .upload-section.single-upload { grid-template-columns: 1fr; max-width: 400px; margin-left: auto; margin-right: auto; }
        @media (max-width: 640px) { .upload-section { grid-template-columns: 1fr; } }
        .upload-zone { position: relative; background: var(--gray-50); border: 2px dashed var(--gray-300); border-radius: var(--radius-lg); padding: 32px 24px; text-align: center; cursor: pointer; transition: all 0.3s ease; }
        .upload-zone:hover { border-color: var(--primary); background: var(--white); }
        .upload-zone.drag-over { border-color: var(--primary); background: linear-gradient(135deg, rgba(79,70,229,0.08) 0%, rgba(14,165,233,0.08) 100%); transform: translateY(-2px) scale(1.01); box-shadow: 0 0 0 4px rgba(79,70,229,0.12); }
        .upload-zone.has-file { border-color: var(--success); border-style: solid; background: rgba(16,185,129,0.05); }
        .upload-zone.hidden { display: none; }
        .upload-zone input[type="file"] { display: none; }
        .upload-icon { width: 48px; height: 48px; margin: 0 auto 16px; color: var(--gray-400); transition: all 0.3s ease; }
        .upload-zone:hover .upload-icon { color: var(--primary); }
        .upload-zone.has-file .upload-icon { color: var(--success); }
        .upload-title { font-size: 0.9375rem; font-weight: 600; color: var(--gray-800); margin-bottom: 4px; }
        .upload-subtitle { font-size: 0.8125rem; color: var(--gray-500); }
        .upload-formats { margin-top: 12px; font-size: 0.75rem; color: var(--gray-400); }
        .file-info { margin-top: 16px; padding: 12px 16px; background: var(--white); border: 1px solid var(--gray-200); border-radius: var(--radius); text-align: left; display: flex; align-items: center; justify-content: space-between; gap: 12px; }
        .file-details { flex: 1; min-width: 0; }
        .file-name { font-size: 0.8125rem; font-weight: 600; color: var(--gray-800); word-break: break-all; display: flex; align-items: center; gap: 8px; }
        .file-name svg { width: 16px; height: 16px; color: var(--success); flex-shrink: 0; }
        .file-size { font-size: 0.75rem; color: var(--gray-500); margin-top: 2px; margin-left: 24px; }
        .file-remove { width: 28px; height: 28px; display: flex; align-items: center; justify-content: center; background: var(--gray-100); border: none; border-radius: 50%; color: var(--gray-500); cursor: pointer; transition: all 0.2s; flex-shrink: 0; }
        .file-remove:hover { background: var(--error); color: var(--white); }
        .file-remove svg { width: 16px; height: 16px; }
        .button-section { text-align: center; }
        .process-button { display: inline-flex; align-items: center; justify-content: center; gap: 10px; background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%); color: var(--white); border: none; padding: 16px 32px; font-size: 1rem; font-weight: 600; border-radius: var(--radius-md); cursor: pointer; transition: all 0.3s ease; min-width: 200px; box-shadow: 0 4px 14px 0 rgba(79,70,229,0.4); }
        .process-button:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 6px 20px 0 rgba(79,70,229,0.5); }
        .process-button:disabled { background: var(--gray-300); cursor: not-allowed; box-shadow: none; }
        .process-button svg { width: 20px; height: 20px; }
        .no-credits-warning { margin-top: 14px; font-size: 0.875rem; color: #991B1B; display: none; background: linear-gradient(135deg, rgba(239,68,68,0.10) 0%, rgba(245,158,11,0.10) 100%); border: 1px solid rgba(239,68,68,0.30); border-radius: var(--radius); padding: 10px 12px; text-align: center; }
        .no-credits-warning.visible { display: block; animation: dropdownOpen 0.2s ease-out; }
        .no-credits-warning a { display: inline-flex; align-items: center; justify-content: center; margin-left: 8px; padding: 6px 10px; border-radius: var(--radius-sm); background: var(--white); border: 1px solid rgba(239,68,68,0.35); color: #991B1B; text-decoration: none; font-weight: 600; cursor: pointer; transition: all 0.2s ease; }
        .no-credits-warning a:hover { background: rgba(239,68,68,0.08); border-color: rgba(239,68,68,0.5); }
        .progress-section { display: none; margin-top: 32px; padding-top: 32px; border-top: 1px solid var(--gray-200); }
        .progress-section.visible { display: block; }
        .progress-header { text-align: center; margin-bottom: 32px; }
        .progress-title { font-size: 1.25rem; font-weight: 700; color: var(--gray-900); margin-bottom: 8px; }
        .progress-subtitle { font-size: 0.875rem; color: var(--gray-500); }
        .progress-steps { display: flex; justify-content: center; gap: 16px; margin-bottom: 32px; }
        .progress-steps.single-step { justify-content: center; }
        .progress-step { display: flex; flex-direction: column; align-items: center; gap: 12px; flex: 1; max-width: 160px; }
        .step-indicator { width: 56px; height: 56px; border-radius: 50%; background: var(--gray-100); border: 3px solid var(--gray-200); display: flex; align-items: center; justify-content: center; font-size: 1.125rem; font-weight: 700; color: var(--gray-400); transition: all 0.4s ease; }
        .progress-step.active .step-indicator { background: rgba(79,70,229,0.1); border-color: var(--primary); color: var(--primary); animation: pulse 2s ease-in-out infinite; }
        .progress-step.complete .step-indicator { background: var(--success); border-color: var(--success); color: var(--white); }
        .step-label { font-size: 0.8125rem; font-weight: 500; color: var(--gray-500); text-align: center; }
        .progress-step.active .step-label { color: var(--primary); font-weight: 600; }
        .progress-step.complete .step-label { color: var(--success); }
        .progress-status { text-align: center; padding: 20px; background: var(--gray-50); border-radius: var(--radius-md); color: var(--gray-600); font-size: 0.9375rem; display: flex; align-items: center; justify-content: center; gap: 12px; }
        .progress-status.error { background: rgba(239,68,68,0.1); color: var(--error); }
        .spinner { width: 24px; height: 24px; border: 3px solid var(--gray-200); border-top-color: var(--primary); border-radius: 50%; animation: spin 1s linear infinite; }
        .results-section { display: none; margin-top: 32px; padding-top: 32px; border-top: 1px solid var(--gray-200); }
        .results-section.visible { display: block; }
        .results-header { display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 16px; margin-bottom: 24px; }
        .results-title { display: flex; align-items: center; gap: 12px; font-size: 1.25rem; font-weight: 700; color: var(--gray-900); }
        .results-title-icon { width: 32px; height: 32px; background: rgba(16,185,129,0.1); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: var(--success); }
        .results-title-icon svg { width: 18px; height: 18px; }
        .results-actions { display: flex; gap: 12px; flex-wrap: wrap; }
        .action-button { display: inline-flex; align-items: center; gap: 8px; padding: 10px 18px; font-size: 0.875rem; font-weight: 500; border-radius: var(--radius); cursor: pointer; transition: all 0.2s ease; border: 1px solid var(--gray-300); background: var(--white); color: var(--gray-700); }
        .action-button:hover { border-color: var(--gray-400); background: var(--gray-50); }
        .action-button svg { width: 18px; height: 18px; }
        .action-button.primary { background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%); color: var(--white); border: none; }
        .action-button.primary:hover { opacity: 0.9; }
        .dropdown { position: relative; }
        .dropdown-content { display: none; position: absolute; right: 0; top: calc(100% + 8px); background: var(--white); border: 1px solid var(--gray-200); border-radius: var(--radius-md); box-shadow: var(--shadow-lg); min-width: 240px; z-index: 50; overflow: hidden; animation: dropdownOpen 0.2s ease-out; }
        .dropdown-content.visible { display: block; }
        .dropdown-item { display: block; width: 100%; padding: 12px 16px; border: none; background: none; text-align: left; font-size: 0.875rem; color: var(--gray-700); cursor: pointer; transition: background 0.15s ease; }
        .dropdown-item:hover { background: var(--gray-50); }
        .dropdown-item span { display: block; font-size: 0.75rem; color: var(--gray-500); margin-top: 2px; }
        .dropdown-divider { height: 1px; background: var(--gray-100); margin: 4px 0; }
        .results-content { background: var(--gray-50); border: 1px solid var(--gray-200); border-radius: var(--radius-md); padding: 28px; max-height: 500px; overflow-y: auto; font-size: 0.9375rem; line-height: 1.75; }
        .results-content h1 { font-size: 1.5rem; font-weight: 700; color: var(--gray-900); margin: 32px 0 16px 0; padding-bottom: 12px; border-bottom: 2px solid var(--gray-200); }
        .results-content h1:first-child { margin-top: 0; }
        .results-content h2 { font-size: 1.25rem; font-weight: 600; color: var(--gray-800); margin: 28px 0 12px 0; }
        .results-content h3 { font-size: 1.0625rem; font-weight: 600; color: var(--gray-700); margin: 24px 0 10px 0; }
        .results-content p { margin: 14px 0; color: var(--gray-700); }
        .results-content ul, .results-content ol { margin: 14px 0; padding-left: 24px; }
        .results-content li { margin: 8px 0; color: var(--gray-700); }
        .results-content strong { font-weight: 600; color: var(--gray-800); }
        .new-process-section { margin-top: 24px; text-align: center; }
        .new-process-button { display: inline-flex; align-items: center; gap: 8px; padding: 12px 24px; font-size: 0.875rem; font-weight: 500; color: var(--gray-600); background: var(--white); border: 1px solid var(--gray-300); border-radius: var(--radius); cursor: pointer; transition: all 0.2s ease; }
        .new-process-button:hover { color: var(--gray-900); border-color: var(--gray-400); }
        .new-process-button svg { width: 18px; height: 18px; }
        .generation-controls { margin: 4px 0 20px; display: grid; grid-template-columns: repeat(2, minmax(0, 1fr)); gap: 14px; }
        @media (max-width: 640px) { .generation-controls { grid-template-columns: 1fr; } }
        .generation-controls.hidden { display: none !important; }
        .generation-control { display: flex; flex-direction: column; gap: 8px; background: var(--gray-50); border: 1px solid var(--gray-200); border-radius: var(--radius-md); padding: 12px; }
        .generation-control.wide { grid-column: 1 / -1; }
        .control-label { font-size: 0.8125rem; color: var(--gray-600); font-weight: 700; text-transform: uppercase; letter-spacing: 0.04em; }
        .control-note { font-size: 0.8125rem; color: var(--gray-500); }
        .study-tools-header { display: flex; align-items: center; justify-content: space-between; gap: 8px; }
        .study-tools-toggle { width: 100%; border: 1px solid var(--gray-300); border-radius: var(--radius); padding: 10px 12px; font-size: 0.9rem; background: var(--white); color: var(--gray-800); cursor: pointer; text-align: left; display: flex; align-items: center; justify-content: space-between; gap: 10px; transition: all 0.2s ease; }
        .study-tools-toggle:hover { border-color: var(--primary-light); }
        .study-tools-toggle svg { width: 16px; height: 16px; color: var(--gray-500); transition: transform 0.2s ease; }
        .study-tools-toggle.open svg { transform: rotate(180deg); }
        .study-tools-panel { display: none; grid-template-columns: repeat(2, minmax(0, 1fr)); gap: 8px; margin-top: 8px; }
        .study-tools-panel.visible { display: grid; animation: dropdownOpen 0.2s ease-out; }
        .tool-chip { border: 1px solid var(--gray-300); border-radius: var(--radius); padding: 10px 12px; background: var(--white); color: var(--gray-700); font-size: 0.875rem; font-weight: 600; cursor: pointer; transition: all 0.2s ease; }
        .tool-chip:hover { border-color: var(--success); color: var(--gray-900); }
        .tool-chip.active { border-color: var(--success); background: rgba(16,185,129,0.12); color: #065F46; }
        .amount-chips { display: grid; grid-template-columns: repeat(4, minmax(0, 1fr)); gap: 8px; }
        .amount-chip { border: 1px solid var(--gray-300); border-radius: var(--radius); padding: 8px 10px; background: var(--white); color: var(--gray-700); font-size: 0.8125rem; font-weight: 600; cursor: pointer; transition: all 0.2s ease; text-align: center; }
        .amount-chip.active { border-color: var(--primary); background: rgba(79,70,229,0.1); color: var(--primary-dark); }
        .amount-chip:disabled { opacity: 0.45; cursor: not-allowed; }
        .interview-options { display: grid; grid-template-columns: repeat(2, minmax(0, 1fr)); gap: 8px; }
        .interview-option { border: 1px solid var(--gray-300); border-radius: var(--radius); padding: 10px 12px; background: var(--white); color: var(--gray-700); font-size: 0.875rem; font-weight: 600; cursor: pointer; transition: all 0.2s ease; text-align: left; }
        .interview-option.active { border-color: var(--success); background: rgba(16,185,129,0.12); color: #065F46; }
        .app-select { position: relative; }
        .app-select-button { width: 100%; display: flex; align-items: center; justify-content: space-between; gap: 10px; border: 1px solid var(--gray-300); border-radius: var(--radius); padding: 10px 12px; font-size: 0.9375rem; color: var(--gray-800); background: var(--white); cursor: pointer; transition: all 0.2s ease; }
        .app-select-button:hover { border-color: var(--primary-light); }
        .app-select-button.open { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(79,70,229,0.1); }
        .app-select-button svg { width: 16px; height: 16px; color: var(--gray-500); transition: transform 0.2s ease; }
        .app-select-button.open svg { transform: rotate(180deg); }
        .app-select-menu { display: none; position: absolute; left: 0; right: 0; top: calc(100% + 8px); background: var(--white); border: 1px solid var(--gray-200); border-radius: var(--radius-md); box-shadow: var(--shadow-lg); z-index: 60; overflow: hidden; max-height: 320px; overflow-y: auto; }
        .app-select-menu.visible { display: block; animation: dropdownOpen 0.2s ease-out; }
        .app-select-item { width: 100%; border: none; background: var(--white); text-align: left; padding: 10px 12px; font-size: 0.9rem; color: var(--gray-700); cursor: pointer; transition: background 0.15s ease; }
        .app-select-item:hover { background: var(--gray-50); }
        .app-select-item.active { background: rgba(79,70,229,0.1); color: var(--primary-dark); font-weight: 600; }
        .language-custom-input { width: 100%; border: 1px solid var(--gray-300); border-radius: var(--radius); padding: 10px 12px; font-size: 0.9375rem; color: var(--gray-800); background: var(--white); margin-top: 8px; }
        .language-custom-input:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px rgba(79,70,229,0.1); }
        .focus-dashboard { display: grid; grid-template-columns: 260px 1fr; gap: 20px; }
        @media (max-width: 900px) { .focus-dashboard { grid-template-columns: 1fr; } }
        .focus-sidebar { background: var(--gray-50); border: 1px solid var(--gray-200); border-radius: var(--radius-md); padding: 14px; }
        .focus-tabs { display: flex; flex-direction: column; gap: 8px; margin-bottom: 16px; }
        .focus-tab { display: flex; align-items: center; justify-content: space-between; gap: 10px; border: 1px solid var(--gray-200); background: var(--white); border-radius: var(--radius); padding: 10px 12px; font-size: 0.875rem; color: var(--gray-700); cursor: pointer; }
        .focus-tab.active { border-color: var(--primary-light); color: var(--gray-900); box-shadow: var(--shadow-sm); }
        .focus-tab .badge { background: var(--gray-100); color: var(--gray-700); border-radius: 999px; font-size: 0.75rem; padding: 2px 8px; font-weight: 600; }
        .focus-tab.active .badge { background: rgba(79,70,229,0.12); color: var(--primary-dark); }
        .sidebar-actions { display: flex; flex-direction: column; gap: 10px; }
        .sidebar-actions .action-button, .sidebar-actions .new-process-button { width: 100%; justify-content: center; }
        .focus-main { min-width: 0; }
        .focus-pane { display: none; }
        .focus-pane.active { display: block; }
        .study-warning { background: rgba(245,158,11,0.12); color: #92400E; border: 1px solid rgba(245,158,11,0.35); border-radius: var(--radius); padding: 10px 12px; font-size: 0.875rem; margin-bottom: 12px; }
        .flashcard-wrap { display: flex; flex-direction: column; align-items: center; gap: 14px; }
        .flashcard-3d { width: min(100%, 720px); height: 360px; perspective: 1200px; cursor: pointer; }
        .flashcard-inner { position: relative; width: 100%; height: 100%; transform-style: preserve-3d; transition: transform 0.55s ease; }
        .flashcard-inner.flipped { transform: rotateY(180deg); }
        .flashcard-face { position: absolute; inset: 0; backface-visibility: hidden; border-radius: var(--radius-lg); border: 1px solid var(--gray-200); background: linear-gradient(135deg, rgba(79,70,229,0.06) 0%, rgba(14,165,233,0.08) 100%); box-shadow: var(--shadow-md); display: flex; align-items: center; justify-content: center; padding: 30px; text-align: center; }
        .flashcard-face.back { transform: rotateY(180deg); background: linear-gradient(135deg, rgba(14,165,233,0.08) 0%, rgba(79,70,229,0.06) 100%); }
        .flashcard-label { position: absolute; top: 16px; left: 16px; font-size: 0.75rem; color: var(--gray-500); font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em; }
        .flashcard-text { font-size: 1.15rem; color: var(--gray-900); line-height: 1.6; white-space: pre-wrap; }
        .flashcard-controls { display: flex; align-items: center; justify-content: center; gap: 12px; flex-wrap: wrap; }
        .flashcard-progress { font-size: 0.875rem; color: var(--gray-600); min-width: 120px; text-align: center; }
        .quiz-head { display: flex; justify-content: space-between; align-items: center; gap: 8px; margin-bottom: 12px; }
        .quiz-score { font-size: 0.875rem; color: var(--gray-700); font-weight: 600; }
        .quiz-question { font-size: 1.1rem; color: var(--gray-900); margin-bottom: 16px; }
        .quiz-options { display: grid; grid-template-columns: 1fr; gap: 10px; }
        .quiz-option { border: 1px solid var(--gray-300); background: var(--white); border-radius: var(--radius); padding: 12px 14px; text-align: left; font-size: 0.9375rem; color: var(--gray-800); cursor: pointer; transition: all 0.2s ease; }
        .quiz-option:hover:not(:disabled) { border-color: var(--primary-light); background: var(--gray-50); }
        .quiz-option.correct { border-color: var(--success); background: rgba(16,185,129,0.12); color: #065F46; }
        .quiz-option.wrong { border-color: var(--error); background: rgba(239,68,68,0.12); color: #991B1B; }
        .quiz-option:disabled { cursor: default; }
        .quiz-explanation { margin-top: 12px; background: rgba(14,165,233,0.08); border: 1px solid rgba(14,165,233,0.2); border-radius: var(--radius); padding: 12px 14px; font-size: 0.9rem; color: var(--gray-700); display: none; }
        .quiz-explanation.visible { display: block; animation: dropdownOpen 0.2s ease-out; }
        .quiz-next { margin-top: 12px; }
        .pane-empty { font-size: 0.9rem; color: var(--gray-500); padding: 16px; border: 1px dashed var(--gray-300); border-radius: var(--radius); background: var(--gray-50); }
        .pricing-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 200; align-items: center; justify-content: center; padding: 24px; overflow-y: auto; }
        .pricing-overlay.visible { display: flex; }
        .pricing-modal { background: var(--white); border-radius: var(--radius-xl); padding: 40px; max-width: 780px; width: 100%; box-shadow: var(--shadow-xl); animation: modalOpen 0.3s ease-out; position: relative; margin: auto; }
        .pricing-modal-close { position: absolute; top: 16px; right: 16px; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; background: none; border: none; color: var(--gray-400); cursor: pointer; border-radius: 50%; transition: all 0.2s; }
        .pricing-modal-close:hover { background: var(--gray-100); color: var(--gray-600); }
        .pricing-modal-close svg { width: 20px; height: 20px; }
        .pricing-modal-icon { width: 64px; height: 64px; background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%); border-radius: var(--radius-lg); display: flex; align-items: center; justify-content: center; margin: 0 auto 24px; color: var(--white); }
        .pricing-modal-icon svg { width: 32px; height: 32px; }
        .pricing-modal h2 { font-size: 1.5rem; font-weight: 700; color: var(--gray-900); margin-bottom: 8px; text-align: center; }
        .pricing-modal-subtitle { font-size: 0.9375rem; color: var(--gray-600); margin-bottom: 32px; text-align: center; }
        .pricing-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; }
        @media (max-width: 700px) { .pricing-grid { grid-template-columns: 1fr; } .pricing-modal { padding: 28px 20px; } }
        .pricing-category { display: flex; flex-direction: column; gap: 12px; }
        .pricing-category-header { display: flex; align-items: center; gap: 10px; padding-bottom: 12px; border-bottom: 2px solid var(--gray-100); }
        .pricing-category-icon { width: 36px; height: 36px; background: var(--gray-100); border-radius: var(--radius); display: flex; align-items: center; justify-content: center; color: var(--primary); }
        .pricing-category-icon svg { width: 20px; height: 20px; }
        .pricing-category-name { font-size: 0.9375rem; font-weight: 600; color: var(--gray-900); }
        .bundle-card { background: var(--gray-50); border: 1px solid var(--gray-200); border-radius: var(--radius-md); padding: 20px; transition: all 0.2s ease; position: relative; }
        .bundle-card:hover { border-color: var(--primary-light); box-shadow: var(--shadow-md); }
        .bundle-card.best-value { border-color: var(--primary); background: rgba(79,70,229,0.03); }
        .best-value-badge { position: absolute; top: -10px; right: 12px; background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%); color: var(--white); font-size: 0.6875rem; font-weight: 700; padding: 3px 10px; border-radius: 20px; text-transform: uppercase; letter-spacing: 0.05em; }
        .bundle-credits { font-size: 1.25rem; font-weight: 700; color: var(--gray-900); margin-bottom: 4px; }
        .bundle-description { font-size: 0.8125rem; color: var(--gray-500); margin-bottom: 12px; }
        .bundle-price { font-size: 1.5rem; font-weight: 800; color: var(--gray-900); margin-bottom: 4px; }
        .bundle-price-per { font-size: 0.75rem; color: var(--gray-400); margin-bottom: 16px; }
        .bundle-buy-btn { width: 100%; padding: 10px 16px; font-size: 0.875rem; font-weight: 600; border: 1px solid var(--gray-300); border-radius: var(--radius); cursor: pointer; transition: all 0.2s ease; background: var(--white); color: var(--primary); }
        .bundle-buy-btn:hover:not(:disabled) { background: var(--gray-50); border-color: var(--primary); }
        .bundle-card.best-value .bundle-buy-btn { background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%); color: var(--white); border: none; }
        .bundle-card.best-value .bundle-buy-btn:hover:not(:disabled) { opacity: 0.9; }
        .bundle-buy-btn:disabled { opacity: 0.6; cursor: not-allowed; }
        .pricing-footer { margin-top: 24px; text-align: center; font-size: 0.8125rem; color: var(--gray-400); display: flex; align-items: center; justify-content: center; gap: 6px; }
        .pricing-footer svg { width: 14px; height: 14px; }
        /* History Modal */
        .history-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 200; align-items: center; justify-content: center; padding: 24px; overflow-y: auto; }
        .history-overlay.visible { display: flex; }
        .history-modal { background: var(--white); border-radius: var(--radius-xl); padding: 40px; max-width: 520px; width: 100%; box-shadow: var(--shadow-xl); animation: modalOpen 0.3s ease-out; position: relative; margin: auto; }
        .history-modal-close { position: absolute; top: 16px; right: 16px; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; background: none; border: none; color: var(--gray-400); cursor: pointer; border-radius: 50%; transition: all 0.2s; }
        .history-modal-close:hover { background: var(--gray-100); color: var(--gray-600); }
        .history-modal-close svg { width: 20px; height: 20px; }
        .history-modal-icon { width: 64px; height: 64px; background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%); border-radius: var(--radius-lg); display: flex; align-items: center; justify-content: center; margin: 0 auto 24px; color: var(--white); }
        .history-modal-icon svg { width: 32px; height: 32px; }
        .history-modal h2 { font-size: 1.5rem; font-weight: 700; color: var(--gray-900); margin-bottom: 8px; text-align: center; }
        .history-modal-subtitle { font-size: 0.9375rem; color: var(--gray-600); margin-bottom: 24px; text-align: center; }
        .history-list { display: flex; flex-direction: column; gap: 12px; max-height: 400px; overflow-y: auto; }
        .history-item { display: flex; align-items: center; justify-content: space-between; padding: 16px; background: var(--gray-50); border: 1px solid var(--gray-200); border-radius: var(--radius-md); }
        .history-item-left { flex: 1; min-width: 0; }
        .history-item-name { font-size: 0.9375rem; font-weight: 600; color: var(--gray-900); margin-bottom: 4px; }
        .history-item-date { font-size: 0.8125rem; color: var(--gray-500); }
        .history-item-credits { font-size: 0.75rem; color: var(--gray-400); margin-top: 2px; }
        .history-item-price { font-size: 1rem; font-weight: 700; color: var(--gray-900); white-space: nowrap; margin-left: 16px; }
        .history-empty { text-align: center; padding: 40px 20px; color: var(--gray-500); font-size: 0.9375rem; }
        .history-empty svg { width: 48px; height: 48px; color: var(--gray-300); margin-bottom: 16px; }
        .history-loading { text-align: center; padding: 40px 20px; color: var(--gray-500); font-size: 0.9375rem; display: flex; flex-direction: column; align-items: center; gap: 12px; }
        .footer { padding: 32px 0; text-align: center; }
        .footer-text { font-size: 0.8125rem; color: var(--gray-500); }
        .toast { position: fixed; bottom: 24px; left: 50%; transform: translateX(-50%) translateY(100px); background: var(--gray-900); color: var(--white); padding: 14px 24px; border-radius: var(--radius-md); font-size: 0.9375rem; font-weight: 500; box-shadow: var(--shadow-xl); opacity: 0; transition: all 0.3s ease; z-index: 1000; display: flex; align-items: center; gap: 10px; }
        .toast.visible { transform: translateX(-50%) translateY(0); opacity: 1; }
        .toast.success { background: var(--success); }
        .toast.error { background: var(--error); }
        .toast.info { background: var(--primary); }
        .toast svg { width: 20px; height: 20px; }
        @keyframes spin { to { transform: rotate(360deg); } }
        @keyframes pulse { 0%, 100% { box-shadow: 0 0 0 0 rgba(79,70,229,0.4); } 50% { box-shadow: 0 0 0 8px rgba(79,70,229,0); } }
        @keyframes dropdownOpen { from { opacity: 0; transform: translateY(-8px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes modalOpen { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
    </style>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
</head>
<body>
    <header class="header"><div class="container"><div class="header-content">
        <a href="/dashboard" class="logo"><div class="logo-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"></path><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"></path></svg></div><span class="logo-text">Lecture Processor</span></a>
        <div class="header-right">
            <a class="header-nav-link" href="/"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 9.5L12 3l9 6.5"></path><path d="M5 10.5V20h14v-9.5"></path></svg><span>Home</span></a>
            <a class="header-nav-link" href="/features"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"></polygon></svg><span>Features</span></a>
            <button class="sign-in-button" id="header-sign-in-btn"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4"></path><polyline points="10 17 15 12 10 7"></polyline><line x1="15" y1="12" x2="3" y2="12"></line></svg>Sign in</button>
            <div class="credits-display" id="credits-display" style="display:none;"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><polygon points="16.24 7.76 14.12 14.12 7.76 16.24 9.88 9.88 16.24 7.76"></polygon></svg><span><span class="credits-count" id="credits-count">0</span> credits</span></div>
            <button class="header-link-button" id="header-study-library-btn"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 4h18v16H3z"></path><line x1="3" y1="10" x2="21" y2="10"></line><line x1="9" y1="4" x2="9" y2="20"></line></svg>Study Library</button>
            <div class="user-menu" id="user-menu" style="display:none;">
                <button class="user-button" id="user-button"><div class="user-avatar" id="user-avatar"><span id="user-initial">?</span></div><span class="user-name" id="user-name">User</span><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width:16px;height:16px;color:var(--gray-400);"><polyline points="6 9 12 15 18 9"></polyline></svg></button>
                <div class="user-dropdown" id="user-dropdown">
                    <div class="user-dropdown-header"><div class="user-dropdown-email" id="user-email">email@example.com</div><div class="user-dropdown-credits"><div class="credit-row"><span class="credit-label">Lecture credits</span><span class="credit-value" id="dropdown-lecture-credits">0</span></div><div class="credit-row"><span class="credit-label">Slides credits</span><span class="credit-value" id="dropdown-slides-credits">0</span></div><div class="credit-row"><span class="credit-label">Interview credits</span><span class="credit-value" id="dropdown-interview-credits">0</span></div></div></div>
                    <button class="user-dropdown-item" id="buy-credits-btn"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="16"></line><line x1="8" y1="12" x2="16" y2="12"></line></svg>Buy credits</button>
                    <button class="user-dropdown-item" id="purchase-history-btn"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>Purchase history</button>
                    <button class="user-dropdown-item" id="admin-dashboard-btn"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="7" height="9"></rect><rect x="14" y="3" width="7" height="5"></rect><rect x="14" y="12" width="7" height="9"></rect><rect x="3" y="16" width="7" height="5"></rect></svg>Admin dashboard</button>
                    <button class="user-dropdown-item danger" id="sign-out-btn"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path><polyline points="16 17 21 12 16 7"></polyline><line x1="21" y1="12" x2="9" y2="12"></line></svg>Sign out</button>
                </div>
            </div>
        </div>
    </div></div></header>

    <div class="auth-overlay" id="auth-overlay"><div class="auth-modal">
        <button class="auth-modal-close" id="auth-modal-close"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg></button>
        <div class="auth-view active" id="signin-view">
            <div class="auth-modal-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"></path><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"></path></svg></div>
            <h2>Welcome back</h2><p class="auth-modal-subtitle">Sign in to your account to continue</p>
            <form class="auth-form" id="signin-form"><div class="form-group"><label class="form-label" for="signin-email">Email address</label><input type="email" class="form-input" id="signin-email" placeholder="you@example.com" required autocomplete="email"></div><div class="form-group"><label class="form-label" for="signin-password">Password</label><div class="password-input-wrapper"><input type="password" class="form-input" id="signin-password" placeholder="Enter your password" required autocomplete="current-password"><button type="button" class="password-toggle" data-target="signin-password"><svg class="eye-open" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle></svg><svg class="eye-closed" style="display:none" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"></path><line x1="1" y1="1" x2="23" y2="23"></line></svg></button></div></div><div class="form-footer"><div></div><a href="#" id="forgot-password-link">Forgot password?</a></div><button type="submit" class="auth-submit-btn" id="signin-submit">Sign in</button></form>
            <div class="auth-divider"><span>or</span></div>
            <button class="google-sign-in-button" id="google-sign-in-btn"><img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" alt="Google">Continue with Google</button>
            <p class="auth-switch">Don't have an account? <a href="#" id="switch-to-signup">Create one</a></p>
            <div class="auth-error" id="signin-error"></div>
        </div>
        <div class="auth-view" id="signup-view">
            <div class="auth-modal-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="8.5" cy="7" r="4"></circle><line x1="20" y1="8" x2="20" y2="14"></line><line x1="23" y1="11" x2="17" y2="11"></line></svg></div>
            <h2>Create your account</h2><p class="auth-modal-subtitle">Get started with 1 free lecture credit</p>
            <form class="auth-form" id="signup-form"><div class="form-group"><label class="form-label" for="signup-email">Email address</label><input type="email" class="form-input" id="signup-email" placeholder="you@example.com" required autocomplete="email"></div><div class="form-group"><label class="form-label" for="signup-password">Password</label><div class="password-input-wrapper"><input type="password" class="form-input" id="signup-password" placeholder="Create a password (min 6 characters)" required minlength="6" autocomplete="new-password"><button type="button" class="password-toggle" data-target="signup-password"><svg class="eye-open" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle></svg><svg class="eye-closed" style="display:none" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"></path><line x1="1" y1="1" x2="23" y2="23"></line></svg></button></div></div><div class="form-group"><label class="form-label" for="signup-password-confirm">Confirm password</label><div class="password-input-wrapper"><input type="password" class="form-input" id="signup-password-confirm" placeholder="Confirm your password" required minlength="6" autocomplete="new-password"><button type="button" class="password-toggle" data-target="signup-password-confirm"><svg class="eye-open" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle></svg><svg class="eye-closed" style="display:none" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"></path><line x1="1" y1="1" x2="23" y2="23"></line></svg></button></div></div><button type="submit" class="auth-submit-btn" id="signup-submit" style="margin-top:8px;">Create account</button></form>
            <div class="auth-divider"><span>or</span></div>
            <button class="google-sign-in-button" id="google-sign-up-btn"><img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" alt="Google">Continue with Google</button>
            <p class="auth-switch">Already have an account? <a href="#" id="switch-to-signin">Sign in</a></p>
            <div class="auth-error" id="signup-error"></div>
        </div>
        <div class="auth-view" id="reset-view">
            <a href="#" class="back-to-login" id="back-to-signin"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 5 12 12 5"></polyline></svg>Back to sign in</a>
            <div class="auth-modal-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 10 0v4"></path></svg></div>
            <h2>Reset your password</h2><p class="auth-modal-subtitle">Enter your email and we'll send you a link to reset your password</p>
            <form class="auth-form" id="reset-form"><div class="form-group"><label class="form-label" for="reset-email">Email address</label><input type="email" class="form-input" id="reset-email" placeholder="you@example.com" required autocomplete="email"></div><button type="submit" class="auth-submit-btn" id="reset-submit" style="margin-top:8px;">Send reset link</button></form>
            <div class="auth-error" id="reset-error"></div><div class="auth-success" id="reset-success"></div>
        </div>
    </div></div>

    <div class="pricing-overlay" id="pricing-overlay"><div class="pricing-modal">
        <button class="pricing-modal-close" id="pricing-modal-close"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg></button>
        <div class="pricing-modal-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="1" y="4" width="22" height="16" rx="2" ry="2"></rect><line x1="1" y1="10" x2="23" y2="10"></line></svg></div>
        <h2>Buy Credits</h2><p class="pricing-modal-subtitle">Choose a credit pack to continue processing your lectures</p>
        <div class="pricing-grid">
            <div class="pricing-category"><div class="pricing-category-header"><div class="pricing-category-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline></svg></div><span class="pricing-category-name">Lecture Notes</span></div><div class="bundle-card"><div class="bundle-credits">5 credits</div><div class="bundle-description">Standard lecture processing</div><div class="bundle-price">&euro;9.99</div><div class="bundle-price-per">&euro;2.00 per credit</div><button class="bundle-buy-btn" data-bundle-id="lecture_5">Buy now</button></div><div class="bundle-card best-value"><div class="best-value-badge">Best Value</div><div class="bundle-credits">10 credits</div><div class="bundle-description">Standard lecture processing</div><div class="bundle-price">&euro;16.99</div><div class="bundle-price-per">&euro;1.70 per credit</div><button class="bundle-buy-btn" data-bundle-id="lecture_10">Buy now</button></div></div>
            <div class="pricing-category"><div class="pricing-category-header"><div class="pricing-category-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="3" width="20" height="14" rx="2" ry="2"></rect><line x1="8" y1="21" x2="16" y2="21"></line><line x1="12" y1="17" x2="12" y2="21"></line></svg></div><span class="pricing-category-name">Slides Extraction</span></div><div class="bundle-card"><div class="bundle-credits">10 credits</div><div class="bundle-description">PDF text extraction</div><div class="bundle-price">&euro;4.99</div><div class="bundle-price-per">&euro;0.50 per credit</div><button class="bundle-buy-btn" data-bundle-id="slides_10">Buy now</button></div><div class="bundle-card best-value"><div class="best-value-badge">Best Value</div><div class="bundle-credits">25 credits</div><div class="bundle-description">PDF text extraction</div><div class="bundle-price">&euro;9.99</div><div class="bundle-price-per">&euro;0.40 per credit</div><button class="bundle-buy-btn" data-bundle-id="slides_25">Buy now</button></div></div>
            <div class="pricing-category"><div class="pricing-category-header"><div class="pricing-category-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"></path><path d="M19 10v2a7 7 0 0 1-14 0v-2"></path><line x1="12" y1="19" x2="12" y2="23"></line><line x1="8" y1="23" x2="16" y2="23"></line></svg></div><span class="pricing-category-name">Interview</span></div><div class="bundle-card"><div class="bundle-credits">3 credits</div><div class="bundle-description">Timestamped transcription</div><div class="bundle-price">&euro;7.99</div><div class="bundle-price-per">&euro;2.66 per credit</div><button class="bundle-buy-btn" data-bundle-id="interview_3">Buy now</button></div><div class="bundle-card best-value"><div class="best-value-badge">Best Value</div><div class="bundle-credits">8 credits</div><div class="bundle-description">Timestamped transcription</div><div class="bundle-price">&euro;17.99</div><div class="bundle-price-per">&euro;2.25 per credit</div><button class="bundle-buy-btn" data-bundle-id="interview_8">Buy now</button></div></div>
        </div>
        <div class="pricing-footer"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 10 0v4"></path></svg>Secure payment via Stripe &middot; Cards &amp; iDEAL accepted</div>
    </div></div>

    <div class="history-overlay" id="history-overlay"><div class="history-modal">
        <button class="history-modal-close" id="history-modal-close"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg></button>
        <div class="history-modal-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg></div>
        <h2>Purchase History</h2>
        <p class="history-modal-subtitle">Your past credit purchases</p>
        <div class="history-list" id="history-list">
            <div class="history-loading" id="history-loading"><div class="spinner"></div><span>Loading purchases...</span></div>
        </div>
    </div></div>

    <main>
        <section class="hero"><div class="container"><div class="hero-badge"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"></polygon></svg>AI-Powered Processing</div><h1 class="hero-title">Transform Lectures into<br><span>Study-Ready Notes</span></h1><p class="hero-description">Upload your lecture slides and audio recordings. Get complete, structured notes ready for exam preparation in minutes.</p></div></section>
        <section class="container"><div class="features"><div class="feature-card"><div class="feature-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline></svg></div><h3 class="feature-title">Smart Slide Extraction</h3><p class="feature-description">Extracts all text and identifies important visuals automatically</p></div><div class="feature-card"><div class="feature-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"></path><path d="M19 10v2a7 7 0 0 1-14 0v-2"></path><line x1="12" y1="19" x2="12" y2="23"></line><line x1="8" y1="23" x2="16" y2="23"></line></svg></div><h3 class="feature-title">Audio Transcription</h3><p class="feature-description">Converts spoken explanations into clean, readable text</p></div><div class="feature-card"><div class="feature-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><path d="M8 14s1.5 2 4 2 4-2 4-2"></path><line x1="9" y1="9" x2="9.01" y2="9"></line><line x1="15" y1="9" x2="15.01" y2="9"></line></svg></div><h3 class="feature-title">Intelligent Merging</h3><p class="feature-description">Combines slides and audio into comprehensive study notes</p></div></div></section>
        <section class="container"><div class="app-card">
            <div class="mode-section"><span class="mode-label">Processing Mode</span><div class="mode-tabs"><button class="mode-tab active" data-mode="lecture-notes">Lecture Notes</button><button class="mode-tab" data-mode="slides-only">Slides Only</button><button class="mode-tab" data-mode="interview">Interview Transcript</button></div><div class="mode-description" id="mode-description"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="16" x2="12" y2="12"></line><line x1="12" y1="8" x2="12.01" y2="8"></line></svg><div><span id="mode-description-text">Upload lecture slides (PDF) and audio recording to generate complete, integrated study notes.</span><div class="mode-credit-cost" id="mode-credit-cost">Uses <strong>1 lecture credit</strong></div></div></div></div>
            <div class="sign-in-required" id="sign-in-required"><p>Please sign in to start processing your lectures</p><button class="process-button" id="sign-in-to-process-btn"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4"></path><polyline points="10 17 15 12 10 7"></polyline><line x1="15" y1="12" x2="3" y2="12"></line></svg><span>Sign in to continue</span></button></div>
            <div class="upload-section" id="upload-section" style="display:none;">
                <div class="upload-zone" id="pdf-zone"><svg class="upload-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="12" y1="18" x2="12" y2="12"></line><line x1="9" y1="15" x2="15" y2="15"></line></svg><div class="upload-title">Lecture Slides</div><div class="upload-subtitle">Drag &amp; drop or click to browse</div><div class="upload-formats">PDF format ¬∑ Max 50 MB</div><input type="file" id="pdf-input" accept=".pdf"><div class="file-info" id="pdf-info" style="display:none;"><div class="file-details"><div class="file-name"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg><span id="pdf-name"></span></div><div class="file-size" id="pdf-size"></div></div><button class="file-remove" id="pdf-remove" type="button"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg></button></div></div>
                <div class="upload-zone" id="audio-zone"><svg class="upload-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"></path><path d="M19 10v2a7 7 0 0 1-14 0v-2"></path><line x1="12" y1="19" x2="12" y2="23"></line><line x1="8" y1="23" x2="16" y2="23"></line></svg><div class="upload-title" id="audio-zone-title">Lecture Recording</div><div class="upload-subtitle">Drag &amp; drop or click to browse</div><div class="upload-formats">MP3, M4A, WAV ¬∑ Max 500 MB</div><input type="file" id="audio-input" accept=".mp3,.m4a,.wav,.aac,.ogg,.flac"><div class="file-info" id="audio-info" style="display:none;"><div class="file-details"><div class="file-name"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg><span id="audio-name"></span></div><div class="file-size" id="audio-size"></div></div><button class="file-remove" id="audio-remove" type="button"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg></button></div></div>
            </div>
            <div class="generation-controls" id="generation-controls">
                <div class="generation-control wide">
                    <span class="control-label">Study Tools</span>
                    <button type="button" class="study-tools-toggle" id="study-tools-toggle">
                        <span id="study-tools-toggle-text">No study tools</span>
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"></polyline></svg>
                    </button>
                    <div class="study-tools-panel" id="study-tools-panel">
                        <button type="button" class="tool-chip active" data-study-features="none">No study tools</button>
                        <button type="button" class="tool-chip" data-study-features="flashcards">Flashcards only</button>
                        <button type="button" class="tool-chip" data-study-features="test">Practice test only</button>
                        <button type="button" class="tool-chip" data-study-features="both">Flashcards + test</button>
                    </div>
                    <div class="control-note" id="study-tools-note">Disabled by default to avoid unnecessary processing.</div>
                </div>
                <div class="generation-control">
                    <span class="control-label">Flashcard Amount</span>
                    <div class="amount-chips" id="flashcard-amount-chips">
                        <button type="button" class="amount-chip" data-value="10">10</button>
                        <button type="button" class="amount-chip active" data-value="20">20</button>
                        <button type="button" class="amount-chip" data-value="30">30</button>
                        <button type="button" class="amount-chip" data-value="auto">Auto</button>
                    </div>
                </div>
                <div class="generation-control">
                    <span class="control-label">Practice Questions</span>
                    <div class="amount-chips" id="question-amount-chips">
                        <button type="button" class="amount-chip" data-value="5">5</button>
                        <button type="button" class="amount-chip active" data-value="10">10</button>
                        <button type="button" class="amount-chip" data-value="15">15</button>
                        <button type="button" class="amount-chip" data-value="auto">Auto</button>
                    </div>
                </div>
            </div>
            <div class="generation-controls hidden" id="interview-controls">
                <div class="generation-control wide">
                    <span class="control-label">Interview Extras</span>
                    <div class="interview-options">
                        <button type="button" class="interview-option" data-feature="summary">Summary (max 1 page)</button>
                        <button type="button" class="interview-option" data-feature="sections">Structured transcript with headings</button>
                    </div>
                    <div class="control-note" id="interview-extra-note">No extras selected. Select one or both options (1 slides credit per option).</div>
                </div>
            </div>
            <div class="generation-controls" id="language-controls">
                <div class="generation-control wide">
                    <span class="control-label">Output Language</span>
                    <input type="hidden" id="output-language-select" value="english">
                    <div class="app-select" id="output-language-picker">
                        <button type="button" class="app-select-button" id="output-language-button">
                            <span id="output-language-label">üá¨üáß English</span>
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"></polyline></svg>
                        </button>
                        <div class="app-select-menu" id="output-language-menu">
                            <button type="button" class="app-select-item" data-value="dutch">üá≥üá± Dutch</button>
                            <button type="button" class="app-select-item active" data-value="english">üá¨üáß English</button>
                            <button type="button" class="app-select-item" data-value="spanish">üá™üá∏ Spanish</button>
                            <button type="button" class="app-select-item" data-value="french">üá´üá∑ French</button>
                            <button type="button" class="app-select-item" data-value="german">üá©üá™ German</button>
                            <button type="button" class="app-select-item" data-value="chinese">üá®üá≥ Chinese</button>
                            <button type="button" class="app-select-item" data-value="other">üåê Other</button>
                        </div>
                    </div>
                    <input class="language-custom-input" id="output-language-custom" placeholder="Type your preferred language (for example: Italian)" style="display:none;">
                </div>
            </div>
            <div class="button-section" id="button-section" style="display:none;"><button class="process-button" id="process-button" disabled><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"></polygon></svg><span>Process Lecture</span></button><div class="no-credits-warning" id="no-credits-warning">You don't have enough credits. <a href="#" id="buy-credits-link">Buy more credits</a></div></div>
            <div class="progress-section" id="progress-section"><div class="progress-header"><h3 class="progress-title">Processing Your Files</h3><p class="progress-subtitle">This may take a few minutes depending on file size</p></div><div class="progress-steps" id="progress-steps"></div><div class="progress-status" id="progress-status"><div class="spinner"></div><span id="status-text">Starting...</span></div></div>
            <div class="results-section" id="results-section">
                <div class="focus-dashboard">
                    <aside class="focus-sidebar">
                        <div class="results-title" style="margin-bottom:14px;"><div class="results-title-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg></div><span id="results-title-text">Study Dashboard</span></div>
                        <div class="focus-tabs">
                            <button class="focus-tab active" id="tab-notes" data-tab="notes"><span>üìÑ Notes</span></button>
                            <button class="focus-tab" id="tab-flashcards" data-tab="flashcards"><span>üóÇÔ∏è Flashcards</span><span class="badge" id="flashcard-count-badge">0</span></button>
                            <button class="focus-tab" id="tab-test" data-tab="test"><span>üìù Practice Test</span><span class="badge" id="test-count-badge">0</span></button>
                        </div>
                        <div class="sidebar-actions">
                            <button class="action-button" id="copy-button"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg><span id="copy-button-text">Copy Notes</span></button>
                            <div class="dropdown" id="download-dropdown"><button class="action-button primary" id="download-button"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>Download<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width:14px;height:14px;margin-left:2px;"><polyline points="6 9 12 15 18 9"></polyline></svg></button><div class="dropdown-content" id="download-dropdown-content"></div></div>
                            <button class="action-button" id="export-study-csv-btn" style="display:none;"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg><span id="export-study-csv-text">Export Flashcards CSV</span></button>
                            <button class="action-button" id="fullscreen-study-btn"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 3 21 3 21 9"></polyline><polyline points="9 21 3 21 3 15"></polyline><line x1="21" y1="3" x2="14" y2="10"></line><line x1="3" y1="21" x2="10" y2="14"></line></svg>Fullscreen Study</button>
                            <button class="action-button" id="study-now-btn"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="5 3 19 12 5 21 5 3"></polygon></svg>Study Immediately</button>
                            <button class="action-button" id="study-library-btn"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 4h18v16H3z"></path><line x1="3" y1="10" x2="21" y2="10"></line><line x1="9" y1="4" x2="9" y2="20"></line></svg>Open Study Library</button>
                            <button class="new-process-button" id="new-lecture-button"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="23 4 23 10 17 10"></polyline><path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"></path></svg>Process Another File</button>
                        </div>
                    </aside>
                    <main class="focus-main">
                        <div class="study-warning" id="study-warning" style="display:none;"></div>
                        <div class="focus-pane active" id="pane-notes"><div class="results-content" id="results-content"></div></div>
                        <div class="focus-pane" id="pane-flashcards">
                            <div class="flashcard-wrap">
                                <div class="flashcard-3d" id="flashcard-card">
                                    <div class="flashcard-inner" id="flashcard-inner">
                                        <div class="flashcard-face front"><span class="flashcard-label">Front</span><div class="flashcard-text" id="flashcard-front-text"></div></div>
                                        <div class="flashcard-face back"><span class="flashcard-label">Back</span><div class="flashcard-text" id="flashcard-back-text"></div></div>
                                    </div>
                                </div>
                                <div class="flashcard-controls">
                                    <button class="action-button" id="flashcard-prev-btn">Previous</button>
                                    <button class="action-button" id="flashcard-flip-btn">Flip</button>
                                    <button class="action-button" id="flashcard-next-btn">Next</button>
                                    <span class="flashcard-progress" id="flashcard-progress">Card 0 of 0</span>
                                </div>
                                <div class="pane-empty" id="flashcard-empty" style="display:none;">No flashcards available for this result.</div>
                            </div>
                        </div>
                        <div class="focus-pane" id="pane-test">
                            <div class="quiz-head">
                                <div class="quiz-progress" id="quiz-progress">Question 0 of 0</div>
                                <div class="quiz-score" id="quiz-score">Score: 0/0</div>
                            </div>
                            <div class="quiz-question" id="quiz-question-text"></div>
                            <div class="quiz-options" id="quiz-options"></div>
                            <div class="quiz-explanation" id="quiz-explanation"></div>
                            <div class="quiz-next"><button class="action-button primary" id="quiz-next-btn">Next Question</button></div>
                            <div class="pane-empty" id="quiz-empty" style="display:none;">No practice questions available for this result.</div>
                        </div>
                    </main>
                </div>
            </div>
        </div></section>
    </main>
    <footer class="footer"><div class="container"><p class="footer-text">Powered by Gemini AI ¬∑ Made for students</p></div></footer>
    <div class="toast" id="toast"><svg id="toast-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg><span id="toast-text"></span></div>

    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth-compat.js"></script>
    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyBAAeEUCPNvP5qnqpP3M6HnFZ6vaaijUvM",
            authDomain: "lecture-processor-cdff6.firebaseapp.com",
            projectId: "lecture-processor-cdff6",
            storageBucket: "lecture-processor-cdff6.firebasestorage.app",
            messagingSenderId: "374793454161",
            appId: "1:374793454161:web:c68b21590e9a1fafa32e70"
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();

        let currentUser = null;
        let userCredits = null;
        let idToken = null;
        let pdfFile = null;
        let audioFile = null;
        let currentJobId = null;
        let pollInterval = null;
        let currentMode = 'lecture-notes';
        let resultMarkdown = '';
        let slideText = '';
        let transcript = '';
        let flashcards = [];
        let testQuestions = [];
        let activeResultsTab = 'notes';
        let flashcardIndex = 0;
        let flashcardFlipped = false;
        let quizIndex = 0;
        let quizScore = 0;
        let quizAnswered = false;
        let studyGenerationError = null;
        let currentStudyPackId = null;
        let resultsLocked = false;
        let selectedStudyFeatures = 'none';
        let selectedFlashcardAmount = '20';
        let selectedQuestionAmount = '10';
        let selectedInterviewFeatures = [];
        let interviewSummaryText = '';
        let interviewSectionsText = '';
        let interviewCombinedText = '';
        let exportCsvType = 'flashcards';

        const modeConfig = {
            'lecture-notes': {
                description: 'Upload lecture slides (PDF) and audio recording to generate complete, integrated study notes.',
                creditCost: 'Uses <strong>1 lecture credit</strong>',
                creditType: 'lecture',
                needsPdf: true,
                needsAudio: true,
                audioTitle: 'Lecture Recording',
                buttonText: 'Process Lecture',
                resultTitle: 'Study Dashboard',
                steps: [{ num: 1, label: 'Extract Slides' }, { num: 2, label: 'Transcribe Audio' }, { num: 3, label: 'Merge Notes' }, { num: 4, label: 'Build Study Tools' }]
            },
            'slides-only': {
                description: 'Upload lecture slides (PDF) to extract text for clean notes output.',
                creditCost: 'Uses <strong>1 slides credit</strong>',
                creditType: 'slides',
                needsPdf: true,
                needsAudio: false,
                audioTitle: 'Lecture Recording',
                buttonText: 'Extract Slides',
                resultTitle: 'Study Dashboard',
                steps: [{ num: 1, label: 'Extract Text' }, { num: 2, label: 'Build Study Tools' }]
            },
            'interview': {
                description: 'Upload an interview recording to generate a timestamped transcript with speaker identification.',
                creditCost: 'Uses <strong>1 interview credit</strong> (+ <strong>1 slides credit</strong> for each selected extra)',
                creditType: 'interview',
                needsPdf: false,
                needsAudio: true,
                audioTitle: 'Interview Recording',
                buttonText: 'Transcribe Interview',
                resultTitle: 'Interview Transcript',
                steps: [{ num: 1, label: 'Transcribe' }]
            }
        };

        const headerSignInBtn = document.getElementById('header-sign-in-btn');
        const headerStudyLibraryBtn = document.getElementById('header-study-library-btn');
        const creditsDisplay = document.getElementById('credits-display');
        const creditsCount = document.getElementById('credits-count');
        const userMenu = document.getElementById('user-menu');
        const userButton = document.getElementById('user-button');
        const userDropdown = document.getElementById('user-dropdown');
        const userAvatar = document.getElementById('user-avatar');
        const userName = document.getElementById('user-name');
        const userEmail = document.getElementById('user-email');
        const dropdownLectureCredits = document.getElementById('dropdown-lecture-credits');
        const dropdownSlidesCredits = document.getElementById('dropdown-slides-credits');
        const dropdownInterviewCredits = document.getElementById('dropdown-interview-credits');
        const buyCreditsBtn = document.getElementById('buy-credits-btn');
        const purchaseHistoryBtn = document.getElementById('purchase-history-btn');
        const adminDashboardBtn = document.getElementById('admin-dashboard-btn');
        const signOutBtn = document.getElementById('sign-out-btn');

        const authOverlay = document.getElementById('auth-overlay');
        const authModalClose = document.getElementById('auth-modal-close');
        const signinView = document.getElementById('signin-view');
        const signupView = document.getElementById('signup-view');
        const resetView = document.getElementById('reset-view');
        const signinForm = document.getElementById('signin-form');
        const signupForm = document.getElementById('signup-form');
        const resetForm = document.getElementById('reset-form');
        const signinEmail = document.getElementById('signin-email');
        const signinPassword = document.getElementById('signin-password');
        const signupEmail = document.getElementById('signup-email');
        const signupPassword = document.getElementById('signup-password');
        const signupPasswordConfirm = document.getElementById('signup-password-confirm');
        const resetEmail = document.getElementById('reset-email');
        const signinError = document.getElementById('signin-error');
        const signupError = document.getElementById('signup-error');
        const resetError = document.getElementById('reset-error');
        const resetSuccess = document.getElementById('reset-success');
        const googleSignInBtn = document.getElementById('google-sign-in-btn');
        const googleSignUpBtn = document.getElementById('google-sign-up-btn');
        const switchToSignup = document.getElementById('switch-to-signup');
        const switchToSignin = document.getElementById('switch-to-signin');
        const forgotPasswordLink = document.getElementById('forgot-password-link');
        const backToSignin = document.getElementById('back-to-signin');

        const signInRequired = document.getElementById('sign-in-required');
        const signInToProcessBtn = document.getElementById('sign-in-to-process-btn');
        const modeTabs = document.querySelectorAll('.mode-tab');
        const modeDescriptionText = document.getElementById('mode-description-text');
        const modeCreditCost = document.getElementById('mode-credit-cost');
        const uploadSection = document.getElementById('upload-section');
        const buttonSection = document.getElementById('button-section');
        const generationControls = document.getElementById('generation-controls');
        const interviewControls = document.getElementById('interview-controls');
        const languageControls = document.getElementById('language-controls');
        const studyToolsToggle = document.getElementById('study-tools-toggle');
        const studyToolsToggleText = document.getElementById('study-tools-toggle-text');
        const studyToolsPanel = document.getElementById('study-tools-panel');
        const studyToolsNote = document.getElementById('study-tools-note');
        const studyToolChips = document.querySelectorAll('.tool-chip[data-study-features]');
        const flashcardAmountChips = document.querySelectorAll('#flashcard-amount-chips .amount-chip');
        const questionAmountChips = document.querySelectorAll('#question-amount-chips .amount-chip');
        const interviewOptionButtons = document.querySelectorAll('.interview-option[data-feature]');
        const interviewExtraNote = document.getElementById('interview-extra-note');
        const outputLanguageSelect = document.getElementById('output-language-select');
        const outputLanguagePicker = document.getElementById('output-language-picker');
        const outputLanguageButton = document.getElementById('output-language-button');
        const outputLanguageLabel = document.getElementById('output-language-label');
        const outputLanguageMenu = document.getElementById('output-language-menu');
        const outputLanguageItems = document.querySelectorAll('#output-language-menu .app-select-item');
        const outputLanguageCustom = document.getElementById('output-language-custom');

        const pdfZone = document.getElementById('pdf-zone');
        const audioZone = document.getElementById('audio-zone');
        const audioZoneTitle = document.getElementById('audio-zone-title');
        const pdfInput = document.getElementById('pdf-input');
        const audioInput = document.getElementById('audio-input');
        const pdfInfo = document.getElementById('pdf-info');
        const audioInfo = document.getElementById('audio-info');
        const pdfName = document.getElementById('pdf-name');
        const pdfSize = document.getElementById('pdf-size');
        const audioName = document.getElementById('audio-name');
        const audioSize = document.getElementById('audio-size');
        const pdfRemove = document.getElementById('pdf-remove');
        const audioRemove = document.getElementById('audio-remove');

        const processButton = document.getElementById('process-button');
        const noCreditsWarning = document.getElementById('no-credits-warning');
        const buyCreditsLink = document.getElementById('buy-credits-link');
        const progressSection = document.getElementById('progress-section');
        const progressSteps = document.getElementById('progress-steps');
        const progressStatus = document.getElementById('progress-status');
        const statusText = document.getElementById('status-text');
        const resultsSection = document.getElementById('results-section');
        const resultsTitleText = document.getElementById('results-title-text');
        const resultsContent = document.getElementById('results-content');
        const studyWarning = document.getElementById('study-warning');
        const copyButton = document.getElementById('copy-button');
        const copyButtonText = document.getElementById('copy-button-text');
        const downloadButton = document.getElementById('download-button');
        const downloadDropdown = document.getElementById('download-dropdown');
        const downloadDropdownContent = document.getElementById('download-dropdown-content');
        const exportStudyCsvBtn = document.getElementById('export-study-csv-btn');
        const exportStudyCsvText = document.getElementById('export-study-csv-text');
        const fullscreenStudyBtn = document.getElementById('fullscreen-study-btn');
        const studyNowBtn = document.getElementById('study-now-btn');
        const studyLibraryBtn = document.getElementById('study-library-btn');
        const newLectureButton = document.getElementById('new-lecture-button');

        const tabButtons = document.querySelectorAll('.focus-tab');
        const paneNotes = document.getElementById('pane-notes');
        const paneFlashcards = document.getElementById('pane-flashcards');
        const paneTest = document.getElementById('pane-test');
        const flashcardCountBadge = document.getElementById('flashcard-count-badge');
        const testCountBadge = document.getElementById('test-count-badge');
        const flashcardCard = document.getElementById('flashcard-card');
        const flashcardInner = document.getElementById('flashcard-inner');
        const flashcardFrontText = document.getElementById('flashcard-front-text');
        const flashcardBackText = document.getElementById('flashcard-back-text');
        const flashcardPrevBtn = document.getElementById('flashcard-prev-btn');
        const flashcardFlipBtn = document.getElementById('flashcard-flip-btn');
        const flashcardNextBtn = document.getElementById('flashcard-next-btn');
        const flashcardProgress = document.getElementById('flashcard-progress');
        const flashcardEmpty = document.getElementById('flashcard-empty');
        const quizProgress = document.getElementById('quiz-progress');
        const quizScoreEl = document.getElementById('quiz-score');
        const quizQuestionText = document.getElementById('quiz-question-text');
        const quizOptions = document.getElementById('quiz-options');
        const quizExplanation = document.getElementById('quiz-explanation');
        const quizNextBtn = document.getElementById('quiz-next-btn');
        const quizEmpty = document.getElementById('quiz-empty');

        const pricingOverlay = document.getElementById('pricing-overlay');
        const pricingModalClose = document.getElementById('pricing-modal-close');
        const historyOverlay = document.getElementById('history-overlay');
        const historyModalClose = document.getElementById('history-modal-close');
        const historyList = document.getElementById('history-list');
        const toast = document.getElementById('toast');
        const toastIcon = document.getElementById('toast-icon');
        const toastText = document.getElementById('toast-text');

        function showAuthModal(view = 'signin') {
            authOverlay.classList.add('visible');
            showAuthView(view);
            clearAuthErrors();
        }
        function hideAuthModal() {
            authOverlay.classList.remove('visible');
            clearAuthErrors();
            signinForm.reset();
            signupForm.reset();
            resetForm.reset();
        }
        function showAuthView(view) {
            signinView.classList.remove('active');
            signupView.classList.remove('active');
            resetView.classList.remove('active');
            clearAuthErrors();
            if (view === 'signin') signinView.classList.add('active');
            if (view === 'signup') signupView.classList.add('active');
            if (view === 'reset') resetView.classList.add('active');
        }
        function clearAuthErrors() {
            [signinError, signupError, resetError, resetSuccess].forEach(el => {
                el.classList.remove('visible');
                el.textContent = '';
            });
        }
        function showAuthError(el, msg) {
            el.textContent = msg;
            el.classList.add('visible');
        }
        function getFirebaseErrorMessage(e) {
            const m = {
                'auth/email-already-in-use': 'This email is already registered. Please sign in instead.',
                'auth/invalid-email': 'Please enter a valid email address.',
                'auth/weak-password': 'Password should be at least 6 characters.',
                'auth/user-not-found': 'No account found with this email.',
                'auth/wrong-password': 'Incorrect password. Please try again.',
                'auth/invalid-credential': 'Invalid email or password. Please try again.',
                'auth/too-many-requests': 'Too many failed attempts. Please try again later.',
                'auth/network-request-failed': 'Network error. Please check your connection.'
            };
            return m[e.code] || e.message || 'An error occurred. Please try again.';
        }
        async function checkEmailAllowed(email) {
            try {
                const r = await fetch('/api/verify-email', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ email }) });
                return await r.json();
            } catch (e) {
                return { allowed: false, message: 'Could not verify email. Please try again.' };
            }
        }
        async function signInWithEmail(email, password) {
            try {
                const check = await checkEmailAllowed(email);
                if (!check.allowed) {
                    showAuthError(signinError, check.message);
                    return;
                }
                await auth.signInWithEmailAndPassword(email, password);
                hideAuthModal();
                showToast('Signed in successfully!', 'success');
            } catch (e) {
                showAuthError(signinError, getFirebaseErrorMessage(e));
            }
        }
        async function signUpWithEmail(email, password) {
            try {
                const check = await checkEmailAllowed(email);
                if (!check.allowed) {
                    showAuthError(signupError, check.message);
                    return;
                }
                await auth.createUserWithEmailAndPassword(email, password);
                hideAuthModal();
                showToast('Account created successfully!', 'success');
            } catch (e) {
                showAuthError(signupError, getFirebaseErrorMessage(e));
            }
        }
        async function signInWithGoogle() {
            const provider = new firebase.auth.GoogleAuthProvider();
            try {
                const result = await auth.signInWithPopup(provider);
                const email = result.user.email || '';
                const check = await checkEmailAllowed(email);
                if (!check.allowed) {
                    await auth.signOut();
                    showAuthError(signinView.classList.contains('active') ? signinError : signupError, check.message);
                    return;
                }
                hideAuthModal();
                showToast('Signed in successfully!', 'success');
            } catch (e) {
                showAuthError(signinView.classList.contains('active') ? signinError : signupError, getFirebaseErrorMessage(e));
            }
        }
        async function sendPasswordReset(email) {
            try {
                await auth.sendPasswordResetEmail(email);
                resetSuccess.textContent = 'Password reset email sent! Check your inbox.';
                resetSuccess.classList.add('visible');
            } catch (e) {
                showAuthError(resetError, getFirebaseErrorMessage(e));
            }
        }
        async function signOut() {
            try {
                await auth.signOut();
                showToast('Signed out', 'success');
            } catch (e) {
                console.error(e);
            }
        }
        async function fetchUserData() {
            if (!idToken) return;
            try {
                const r = await fetch('/api/auth/user', { headers: { 'Authorization': `Bearer ${idToken}` } });
                if (!r.ok) return;
                const d = await r.json();
                userCredits = d.credits;
                updateCreditsDisplay();
            } catch (e) {
                console.error(e);
            }
        }
        function updateCreditsDisplay() {
            if (!userCredits) return;
            const lecture = userCredits.lecture_standard + userCredits.lecture_extended;
            const interview = userCredits.interview_short + userCredits.interview_medium + userCredits.interview_long;
            creditsCount.textContent = lecture + userCredits.slides + interview;
            dropdownLectureCredits.textContent = lecture;
            dropdownSlidesCredits.textContent = userCredits.slides;
            dropdownInterviewCredits.textContent = interview;
            updateProcessButton();
        }
        function getTotalInterviewCredits() {
            if (!userCredits) return 0;
            return userCredits.interview_short + userCredits.interview_medium + userCredits.interview_long;
        }
        function getInterviewExtraCost() {
            return currentMode === 'interview' ? selectedInterviewFeatures.length : 0;
        }
        function getInterviewFeaturesValue() {
            if (!selectedInterviewFeatures.length) return 'none';
            if (selectedInterviewFeatures.length === 2) return 'both';
            return selectedInterviewFeatures[0];
        }
        function updateModeCreditDisplay() {
            if (currentMode !== 'interview') {
                modeCreditCost.innerHTML = modeConfig[currentMode].creditCost;
                return;
            }
            const extraCost = getInterviewExtraCost();
            if (!extraCost) {
                modeCreditCost.innerHTML = 'Uses <strong>1 interview credit</strong>. Optional extras cost <strong>1 slides credit</strong> each.';
            } else {
                modeCreditCost.innerHTML = `Uses <strong>1 interview credit</strong> + <strong>${extraCost} slides credits</strong> for selected extras.`;
            }
        }
        function setStudyFeature(value) {
            selectedStudyFeatures = ['none', 'flashcards', 'test', 'both'].includes(value) ? value : 'none';
            const labels = {
                none: 'No study tools',
                flashcards: 'Flashcards only',
                test: 'Practice test only',
                both: 'Flashcards + test',
            };
            studyToolsToggleText.textContent = labels[selectedStudyFeatures];
            studyToolChips.forEach(chip => {
                chip.classList.toggle('active', chip.dataset.studyFeatures === selectedStudyFeatures);
            });
            if (selectedStudyFeatures === 'none') {
                studyToolsNote.textContent = 'Disabled by default to avoid unnecessary processing.';
            } else if (selectedStudyFeatures === 'flashcards') {
                studyToolsNote.textContent = 'Only flashcards will be generated.';
            } else if (selectedStudyFeatures === 'test') {
                studyToolsNote.textContent = 'Only practice test questions will be generated.';
            } else {
                studyToolsNote.textContent = 'Both flashcards and practice test questions will be generated.';
            }
            const disableFlashcards = currentMode === 'interview' || selectedStudyFeatures === 'none' || selectedStudyFeatures === 'test';
            const disableQuestions = currentMode === 'interview' || selectedStudyFeatures === 'none' || selectedStudyFeatures === 'flashcards';
            flashcardAmountChips.forEach(chip => { chip.disabled = disableFlashcards; });
            questionAmountChips.forEach(chip => { chip.disabled = disableQuestions; });
            updateProcessButton();
        }
        function setAmountSelection(kind, value) {
            if (kind === 'flashcards') {
                selectedFlashcardAmount = value;
                flashcardAmountChips.forEach(chip => chip.classList.toggle('active', chip.dataset.value === value));
            } else {
                selectedQuestionAmount = value;
                questionAmountChips.forEach(chip => chip.classList.toggle('active', chip.dataset.value === value));
            }
        }
        function updateInterviewOptionsUI() {
            interviewOptionButtons.forEach(btn => {
                btn.classList.toggle('active', selectedInterviewFeatures.includes(btn.dataset.feature));
            });
            if (!selectedInterviewFeatures.length) {
                interviewExtraNote.textContent = 'No extras selected. Select one or both options (1 slides credit per option).';
            } else if (selectedInterviewFeatures.length === 1) {
                interviewExtraNote.textContent = 'Selected 1 extra option. This adds 1 slides credit.';
            } else {
                interviewExtraNote.textContent = 'Selected both extra options. This adds 2 slides credits.';
            }
            updateModeCreditDisplay();
            updateProcessButton();
        }
        function updateOutputLanguageInput() {
            const isOther = outputLanguageSelect.value === 'other';
            outputLanguageCustom.style.display = isOther ? 'block' : 'none';
            if (!isOther) outputLanguageCustom.value = '';
        }
        function setOutputLanguage(value, label) {
            outputLanguageSelect.value = value;
            outputLanguageLabel.textContent = label;
            outputLanguageItems.forEach(item => item.classList.toggle('active', item.dataset.value === value));
            updateOutputLanguageInput();
        }
        function updateUIForAuthState(user) {
            if (user) {
                headerSignInBtn.style.display = 'none';
                creditsDisplay.style.display = 'flex';
                headerStudyLibraryBtn.style.display = 'inline-flex';
                userMenu.style.display = 'block';
                signInRequired.classList.remove('visible');
                uploadSection.style.display = 'grid';
                buttonSection.style.display = 'block';
                languageControls.style.display = 'grid';
                const displayName = user.displayName || user.email.split('@')[0];
                const initial = displayName.charAt(0).toUpperCase();
                userAvatar.innerHTML = user.photoURL ? `<img src="${user.photoURL}" alt="${displayName}">` : `<span>${initial}</span>`;
                userName.textContent = displayName;
                userEmail.textContent = user.email;
                switchMode(currentMode);
            } else {
                headerSignInBtn.style.display = 'flex';
                creditsDisplay.style.display = 'none';
                headerStudyLibraryBtn.style.display = 'none';
                userMenu.style.display = 'none';
                signInRequired.classList.add('visible');
                uploadSection.style.display = 'none';
                buttonSection.style.display = 'none';
                generationControls.classList.add('hidden');
                generationControls.style.display = 'none';
                interviewControls.classList.add('hidden');
                languageControls.style.display = 'none';
                currentUser = null;
                userCredits = null;
                idToken = null;
            }
        }
        auth.onAuthStateChanged(async (user) => {
            currentUser = user;
            if (user) {
                idToken = await user.getIdToken();
                updateUIForAuthState(user);
                await fetchUserData();
            } else {
                updateUIForAuthState(null);
            }
        });
        setInterval(async () => { if (currentUser) idToken = await currentUser.getIdToken(true); }, 10 * 60 * 1000);

        function formatFileSize(bytes) {
            if (!bytes) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return `${parseFloat((bytes / Math.pow(k, i)).toFixed(2))} ${sizes[i]}`;
        }
        function showToast(message, type = 'success', duration = 3000) {
            toastText.textContent = message;
            toast.className = `toast visible ${type}`;
            if (type === 'success') toastIcon.innerHTML = '<polyline points="20 6 9 17 4 12"></polyline>';
            else if (type === 'error') toastIcon.innerHTML = '<circle cx="12" cy="12" r="10"></circle><line x1="15" y1="9" x2="9" y2="15"></line><line x1="9" y1="9" x2="15" y2="15"></line>';
            else toastIcon.innerHTML = '<circle cx="12" cy="12" r="10"></circle><line x1="12" y1="16" x2="12" y2="12"></line><line x1="12" y1="8" x2="12.01" y2="8"></line>';
            setTimeout(() => toast.classList.remove('visible'), duration);
        }
        function hasEnoughCredits() {
            if (!userCredits) return false;
            const config = modeConfig[currentMode];
            if (config.creditType === 'lecture') return (userCredits.lecture_standard + userCredits.lecture_extended) > 0;
            if (config.creditType === 'slides') return userCredits.slides > 0;
            if (config.creditType === 'interview') {
                const extraCost = getInterviewExtraCost();
                return getTotalInterviewCredits() > 0 && userCredits.slides >= extraCost;
            }
            return false;
        }
        function updateProcessButton() {
            const config = modeConfig[currentMode];
            const pdfReady = !config.needsPdf || pdfFile;
            const audioReady = !config.needsAudio || audioFile;
            const hasCredits = hasEnoughCredits();
            processButton.disabled = !(pdfReady && audioReady && hasCredits) || resultsLocked;
            processButton.querySelector('span').textContent = config.buttonText;
            if (currentUser && !hasCredits && !resultsLocked) {
                if (currentMode === 'interview' && getTotalInterviewCredits() > 0 && userCredits.slides < getInterviewExtraCost()) {
                    noCreditsWarning.innerHTML = "You don't have enough slides credits for the selected interview extras. <a href=\"#\" id=\"buy-credits-link-inline\">Buy more credits</a>";
                } else {
                    noCreditsWarning.innerHTML = "You don't have enough credits. <a href=\"#\" id=\"buy-credits-link-inline\">Buy more credits</a>";
                }
                noCreditsWarning.classList.add('visible');
                const inlineLink = document.getElementById('buy-credits-link-inline');
                if (inlineLink) {
                    inlineLink.addEventListener('click', (e) => {
                        e.preventDefault();
                        showPricingModal();
                    });
                }
            } else {
                noCreditsWarning.classList.remove('visible');
            }
        }
        function switchMode(mode) {
            currentMode = mode;
            const config = modeConfig[mode];
            modeTabs.forEach(tab => tab.classList.toggle('active', tab.dataset.mode === mode));
            modeDescriptionText.textContent = config.description;
            audioZoneTitle.textContent = config.audioTitle;
            generationControls.classList.toggle('hidden', mode === 'interview');
            generationControls.style.display = mode === 'interview' ? 'none' : 'grid';
            interviewControls.classList.toggle('hidden', mode !== 'interview');
            if (mode === 'interview') {
                studyToolsPanel.classList.remove('visible');
                studyToolsToggle.classList.remove('open');
            }
            updateModeCreditDisplay();
            if (config.needsPdf && config.needsAudio) {
                uploadSection.classList.remove('single-upload');
                pdfZone.classList.remove('hidden');
                audioZone.classList.remove('hidden');
            } else if (config.needsPdf) {
                uploadSection.classList.add('single-upload');
                pdfZone.classList.remove('hidden');
                audioZone.classList.add('hidden');
            } else {
                uploadSection.classList.add('single-upload');
                pdfZone.classList.add('hidden');
                audioZone.classList.remove('hidden');
            }
            if (!config.needsPdf) {
                pdfFile = null;
                pdfInput.value = '';
                pdfInfo.style.display = 'none';
                pdfZone.classList.remove('has-file');
            }
            if (!config.needsAudio) {
                audioFile = null;
                audioInput.value = '';
                audioInfo.style.display = 'none';
                audioZone.classList.remove('has-file');
            }
            setStudyFeature(selectedStudyFeatures);
            updateInterviewOptionsUI();
            updateProcessButton();
        }
        modeTabs.forEach(tab => tab.addEventListener('click', () => switchMode(tab.dataset.mode)));

        function handlePdfFile(file) {
            if (!file) return;
            if (file.type !== 'application/pdf') { showToast('Please select a valid PDF file', 'error'); return; }
            if (file.size > 50 * 1024 * 1024) { showToast('PDF file must be under 50 MB', 'error'); return; }
            pdfFile = file;
            pdfName.textContent = file.name;
            pdfSize.textContent = formatFileSize(file.size);
            pdfInfo.style.display = 'flex';
            pdfZone.classList.add('has-file');
            updateProcessButton();
        }
        function handleAudioFile(file) {
            if (!file) return;
            const valid = ['.mp3', '.m4a', '.wav', '.aac', '.ogg', '.flac'];
            if (!valid.some(ext => file.name.toLowerCase().endsWith(ext))) { showToast('Please select a valid audio file', 'error'); return; }
            if (file.size > 500 * 1024 * 1024) { showToast('Audio file must be under 500 MB', 'error'); return; }
            audioFile = file;
            audioName.textContent = file.name;
            audioSize.textContent = formatFileSize(file.size);
            audioInfo.style.display = 'flex';
            audioZone.classList.add('has-file');
            updateProcessButton();
        }
        function setupDropZone(zone, input, handler) {
            zone.addEventListener('click', (e) => { if (!e.target.closest('.file-remove')) input.click(); });
            input.addEventListener('change', (e) => { if (e.target.files.length) handler(e.target.files[0]); });
            zone.addEventListener('dragover', (e) => { e.preventDefault(); zone.classList.add('drag-over'); });
            zone.addEventListener('dragleave', (e) => { e.preventDefault(); zone.classList.remove('drag-over'); });
            zone.addEventListener('drop', (e) => { e.preventDefault(); zone.classList.remove('drag-over'); if (e.dataTransfer.files.length) handler(e.dataTransfer.files[0]); });
        }
        setupDropZone(pdfZone, pdfInput, handlePdfFile);
        setupDropZone(audioZone, audioInput, handleAudioFile);
        pdfRemove.addEventListener('click', (e) => { e.stopPropagation(); pdfFile = null; pdfInput.value = ''; pdfInfo.style.display = 'none'; pdfZone.classList.remove('has-file'); updateProcessButton(); });
        audioRemove.addEventListener('click', (e) => { e.stopPropagation(); audioFile = null; audioInput.value = ''; audioInfo.style.display = 'none'; audioZone.classList.remove('has-file'); updateProcessButton(); });

        function buildProgressSteps(steps) {
            progressSteps.innerHTML = '';
            progressSteps.classList.toggle('single-step', steps.length === 1);
            steps.forEach(s => {
                const el = document.createElement('div');
                el.className = 'progress-step';
                el.id = `step-${s.num}`;
                el.innerHTML = `<div class="step-indicator">${s.num}</div><div class="step-label">${s.label}</div>`;
                progressSteps.appendChild(el);
            });
        }
        function updateProgressUI(step, desc, total) {
            for (let i = 1; i <= total; i++) {
                const el = document.getElementById(`step-${i}`);
                if (!el) continue;
                el.classList.remove('active', 'complete');
                if (i < step) el.classList.add('complete');
                else if (i === step) el.classList.add('active');
            }
            statusText.textContent = desc || 'Processing...';
        }
        function getCurrentModeSteps() {
            if (currentMode === 'lecture-notes') {
                if (selectedStudyFeatures === 'none') return modeConfig['lecture-notes'].steps.slice(0, 3);
                return modeConfig['lecture-notes'].steps;
            }
            if (currentMode === 'slides-only') {
                if (selectedStudyFeatures === 'none') return modeConfig['slides-only'].steps.slice(0, 1);
                return modeConfig['slides-only'].steps;
            }
            if (selectedInterviewFeatures.length > 0) {
                return [{ num: 1, label: 'Transcribe' }, { num: 2, label: 'Create Extras' }];
            }
            return modeConfig['interview'].steps;
        }
        function startPolling() {
            pollInterval = setInterval(pollStatus, 2000);
            pollStatus();
        }
        function stopPolling() {
            if (pollInterval) clearInterval(pollInterval);
            pollInterval = null;
        }
        function pollStatus() {
            if (!currentJobId) return;
            fetch(`/status/${currentJobId}`).then(r => r.json()).then(d => {
                if (d.error && d.status !== 'error') {
                    stopPolling();
                    showToast('Error: Job not found', 'error');
                    return;
                }
                updateProgressUI(d.step, d.step_description, d.total_steps);
                if (d.status === 'complete') {
                    stopPolling();
                    showResults(
                        d.result,
                        d.slide_text,
                        d.transcript,
                        d.flashcards || [],
                        d.test_questions || [],
                        d.study_generation_error || null,
                        d.study_pack_id || null,
                        d.study_features || 'none',
                        d.interview_summary || '',
                        d.interview_sections || '',
                        d.interview_combined || '',
                        d.interview_features_successful || []
                    );
                    fetchUserData();
                } else if (d.status === 'error') {
                    stopPolling();
                    showError(d.error, d.credit_refunded);
                }
            }).catch((e) => console.error(e));
        }
        async function processFiles() {
            if (!idToken) { showAuthModal('signin'); return; }
            if (resultsLocked) {
                showToast('Click "Process Another File" to start a new generation.', 'info');
                return;
            }
            const config = modeConfig[currentMode];
            const fd = new FormData();
            fd.append('mode', currentMode);
            if (config.needsPdf && pdfFile) fd.append('pdf', pdfFile);
            if (config.needsAudio && audioFile) fd.append('audio', audioFile);
            const selectedLanguage = outputLanguageSelect.value || 'english';
            fd.append('output_language', selectedLanguage);
            if (selectedLanguage === 'other') {
                const customLanguage = outputLanguageCustom.value.trim();
                if (!customLanguage) {
                    showToast('Please enter a custom output language.', 'error');
                    return;
                }
                fd.append('output_language_custom', customLanguage);
            }
            if (currentMode !== 'interview') {
                fd.append('flashcard_amount', selectedFlashcardAmount);
                fd.append('question_amount', selectedQuestionAmount);
                fd.append('study_features', selectedStudyFeatures);
            } else {
                fd.append('interview_features', getInterviewFeaturesValue());
            }
            const steps = getCurrentModeSteps();
            buildProgressSteps(steps);
            processButton.disabled = true;
            progressSection.classList.add('visible');
            resultsSection.classList.remove('visible');
            progressStatus.classList.remove('error');
            progressStatus.querySelector('.spinner').style.display = 'block';
            updateProgressUI(0, 'Uploading files...', steps.length);
            try {
                const r = await fetch('/upload', { method: 'POST', headers: { 'Authorization': `Bearer ${idToken}` }, body: fd });
                const d = await r.json();
                if (d.error) {
                    if (r.status === 401) showAuthModal();
                    else if (r.status === 402) { showError('No credits remaining. Please purchase more credits.'); noCreditsWarning.classList.add('visible'); }
                    else showError(d.error);
                    return;
                }
                currentJobId = d.job_id;
                startPolling();
            } catch (e) {
                showError('Failed to upload files. Please try again.');
            }
        }
        processButton.addEventListener('click', processFiles);

        function simpleMarkdownToHtml(md) {
            let h = md.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;')
                .replace(/^### (.*$)/gm, '<h3>$1</h3>').replace(/^## (.*$)/gm, '<h2>$1</h2>').replace(/^# (.*$)/gm, '<h1>$1</h1>')
                .replace(/\*\*\*(.*?)\*\*\*/g, '<strong><em>$1</em></strong>').replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/\*(.*?)\*/g, '<em>$1</em>')
                .replace(/^\s*[-*]\s+(.*$)/gm, '<li>$1</li>').replace(/\n\n/g, '</p><p>').replace(/\n/g, '<br>');
            h = `<p>${h}</p>`;
            h = h.replace(/(<li>.*?<\/li>)(?=\s*<li>|<br><li>)/g, '$1').replace(/(<li>.*?<\/li>)+/g, '<ul>$&</ul>').replace(/<br><li>/g, '<li>');
            h = h.replace(/<p><\/p>/g, '').replace(/<p>(<h[1-3]>)/g, '$1').replace(/(<\/h[1-3]>)<\/p>/g, '$1').replace(/<p>(<ul>)/g, '$1').replace(/(<\/ul>)<\/p>/g, '$1');
            return h;
        }
        function buildDownloadDropdown() {
            if (currentMode === 'lecture-notes') {
                downloadDropdownContent.innerHTML = '<button class="dropdown-item" data-type="result" data-format="md">Complete Lecture Notes<span>Markdown (.md)</span></button><button class="dropdown-item" data-type="result" data-format="docx">Complete Lecture Notes<span>Word Document (.docx)</span></button><div class="dropdown-divider"></div><button class="dropdown-item" data-type="slides" data-format="md">Extracted Slides Only<span>Markdown (.md)</span></button><button class="dropdown-item" data-type="slides" data-format="docx">Extracted Slides Only<span>Word Document (.docx)</span></button><div class="dropdown-divider"></div><button class="dropdown-item" data-type="transcript" data-format="md">Transcript Only<span>Markdown (.md)</span></button><button class="dropdown-item" data-type="transcript" data-format="docx">Transcript Only<span>Word Document (.docx)</span></button>';
            } else if (currentMode === 'slides-only') {
                downloadDropdownContent.innerHTML = '<button class="dropdown-item" data-type="result" data-format="md">Extracted Slides<span>Markdown (.md)</span></button><button class="dropdown-item" data-type="result" data-format="docx">Extracted Slides<span>Word Document (.docx)</span></button>';
            } else {
                const parts = [];
                parts.push('<button class="dropdown-item" data-type="result" data-format="md">Current Interview Output<span>Markdown (.md)</span></button>');
                parts.push('<button class="dropdown-item" data-type="result" data-format="docx">Current Interview Output<span>Word Document (.docx)</span></button>');
                if (interviewSummaryText && interviewSectionsText && interviewCombinedText) {
                    parts.push('<div class="dropdown-divider"></div>');
                    parts.push('<button class="dropdown-item" data-type="combined" data-format="md">Summary + Structured Transcript<span>Markdown (.md)</span></button>');
                    parts.push('<button class="dropdown-item" data-type="combined" data-format="docx">Summary + Structured Transcript<span>Word Document (.docx)</span></button>');
                } else {
                    if (interviewSummaryText) {
                        parts.push('<div class="dropdown-divider"></div>');
                        parts.push('<button class="dropdown-item" data-type="summary" data-format="md">Interview Summary<span>Markdown (.md)</span></button>');
                        parts.push('<button class="dropdown-item" data-type="summary" data-format="docx">Interview Summary<span>Word Document (.docx)</span></button>');
                    }
                    if (interviewSectionsText) {
                        parts.push('<div class="dropdown-divider"></div>');
                        parts.push('<button class="dropdown-item" data-type="sections" data-format="md">Structured Transcript<span>Markdown (.md)</span></button>');
                        parts.push('<button class="dropdown-item" data-type="sections" data-format="docx">Structured Transcript<span>Word Document (.docx)</span></button>');
                    }
                }
                if (transcript) {
                    parts.push('<div class="dropdown-divider"></div>');
                    parts.push('<button class="dropdown-item" data-type="transcript" data-format="md">Raw Transcript<span>Markdown (.md)</span></button>');
                    parts.push('<button class="dropdown-item" data-type="transcript" data-format="docx">Raw Transcript<span>Word Document (.docx)</span></button>');
                }
                downloadDropdownContent.innerHTML = parts.join('');
            }
            downloadDropdownContent.querySelectorAll('.dropdown-item').forEach(item => {
                item.addEventListener('click', () => {
                    downloadFile(item.dataset.type, item.dataset.format);
                    downloadDropdownContent.classList.remove('visible');
                });
            });
        }
        function downloadFile(type, format) {
            let content = resultMarkdown;
            let filename = 'output.md';
            if (type === 'slides') { content = slideText; filename = format === 'md' ? 'extracted-slides.md' : 'extracted-slides.docx'; }
            else if (type === 'transcript') { content = transcript; filename = format === 'md' ? 'transcript.md' : 'transcript.docx'; }
            else if (type === 'summary') { content = interviewSummaryText || resultMarkdown; filename = format === 'md' ? 'interview-summary.md' : 'interview-summary.docx'; }
            else if (type === 'sections') { content = interviewSectionsText || resultMarkdown; filename = format === 'md' ? 'interview-structured.md' : 'interview-structured.docx'; }
            else if (type === 'combined') { content = interviewCombinedText || resultMarkdown; filename = format === 'md' ? 'interview-summary-structured.md' : 'interview-summary-structured.docx'; }
            else if (currentMode === 'lecture-notes') filename = format === 'md' ? 'lecture-notes.md' : 'lecture-notes.docx';
            else if (currentMode === 'slides-only') filename = format === 'md' ? 'extracted-slides.md' : 'extracted-slides.docx';
            else filename = format === 'md' ? 'interview-transcript.md' : 'interview-transcript.docx';
            if (format === 'md') {
                const blob = new Blob([content], { type: 'text/markdown' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            } else {
                window.location.href = `/download-docx/${currentJobId}?type=${type}`;
            }
            showToast('Download started', 'success');
        }

        function updateExportCsvButton() {
            if (currentMode === 'interview') {
                exportStudyCsvBtn.style.display = 'none';
                return;
            }
            if (activeResultsTab === 'test' && testQuestions.length) {
                exportCsvType = 'test';
                exportStudyCsvText.textContent = 'Export Practice Test CSV';
                exportStudyCsvBtn.style.display = 'inline-flex';
                return;
            }
            if (flashcards.length) {
                exportCsvType = 'flashcards';
                exportStudyCsvText.textContent = 'Export Flashcards CSV';
                exportStudyCsvBtn.style.display = 'inline-flex';
                return;
            }
            if (testQuestions.length) {
                exportCsvType = 'test';
                exportStudyCsvText.textContent = 'Export Practice Test CSV';
                exportStudyCsvBtn.style.display = 'inline-flex';
                return;
            }
            exportStudyCsvBtn.style.display = 'none';
        }
        function setActiveResultsTab(tab) {
            activeResultsTab = tab;
            tabButtons.forEach(btn => btn.classList.toggle('active', btn.dataset.tab === tab));
            paneNotes.classList.toggle('active', tab === 'notes');
            paneFlashcards.classList.toggle('active', tab === 'flashcards');
            paneTest.classList.toggle('active', tab === 'test');
            updateExportCsvButton();
        }
        tabButtons.forEach(btn => btn.addEventListener('click', () => setActiveResultsTab(btn.dataset.tab)));

        function renderFlashcard() {
            if (!flashcards.length) {
                flashcardEmpty.style.display = 'block';
                flashcardCard.style.display = 'none';
                flashcardProgress.textContent = 'Card 0 of 0';
                flashcardPrevBtn.disabled = true;
                flashcardNextBtn.disabled = true;
                flashcardFlipBtn.disabled = true;
                return;
            }
            flashcardEmpty.style.display = 'none';
            flashcardCard.style.display = 'block';
            const card = flashcards[flashcardIndex];
            flashcardFrontText.textContent = card.front;
            flashcardBackText.textContent = card.back;
            flashcardInner.classList.toggle('flipped', flashcardFlipped);
            flashcardProgress.textContent = `Card ${flashcardIndex + 1} of ${flashcards.length}`;
            flashcardPrevBtn.disabled = flashcardIndex === 0;
            flashcardNextBtn.disabled = flashcardIndex === flashcards.length - 1;
            flashcardFlipBtn.disabled = false;
        }
        function goFlashcard(offset) {
            if (!flashcards.length) return;
            flashcardIndex = Math.max(0, Math.min(flashcards.length - 1, flashcardIndex + offset));
            flashcardFlipped = false;
            renderFlashcard();
        }
        function flipFlashcard() {
            if (!flashcards.length) return;
            flashcardFlipped = !flashcardFlipped;
            renderFlashcard();
        }
        flashcardCard.addEventListener('click', flipFlashcard);
        flashcardPrevBtn.addEventListener('click', () => goFlashcard(-1));
        flashcardNextBtn.addEventListener('click', () => goFlashcard(1));
        flashcardFlipBtn.addEventListener('click', flipFlashcard);

        function renderQuizQuestion() {
            if (!testQuestions.length) {
                quizEmpty.style.display = 'block';
                quizQuestionText.textContent = '';
                quizOptions.innerHTML = '';
                quizExplanation.classList.remove('visible');
                quizNextBtn.style.display = 'none';
                quizProgress.textContent = 'Question 0 of 0';
                quizScoreEl.textContent = 'Score: 0/0';
                return;
            }
            quizEmpty.style.display = 'none';
            const q = testQuestions[quizIndex];
            quizAnswered = false;
            quizProgress.textContent = `Question ${quizIndex + 1} of ${testQuestions.length}`;
            quizScoreEl.textContent = `Score: ${quizScore}/${testQuestions.length}`;
            quizQuestionText.textContent = q.question;
            quizOptions.innerHTML = '';
            quizExplanation.classList.remove('visible');
            quizExplanation.textContent = '';
            q.options.forEach(option => {
                const btn = document.createElement('button');
                btn.type = 'button';
                btn.className = 'quiz-option';
                btn.textContent = option;
                btn.addEventListener('click', () => answerQuizOption(btn, option));
                quizOptions.appendChild(btn);
            });
            quizNextBtn.style.display = 'none';
        }
        function answerQuizOption(clickedBtn, selectedOption) {
            if (quizAnswered) return;
            quizAnswered = true;
            const q = testQuestions[quizIndex];
            const optionButtons = [...quizOptions.querySelectorAll('.quiz-option')];
            optionButtons.forEach(btn => {
                btn.disabled = true;
                if (btn.textContent === q.answer) btn.classList.add('correct');
            });
            if (selectedOption === q.answer) {
                clickedBtn.classList.add('correct');
                quizScore += 1;
            } else {
                clickedBtn.classList.add('wrong');
            }
            quizScoreEl.textContent = `Score: ${quizScore}/${testQuestions.length}`;
            quizExplanation.textContent = q.explanation;
            quizExplanation.classList.add('visible');
            quizNextBtn.style.display = (quizIndex < testQuestions.length - 1) ? 'inline-flex' : 'none';
        }
        quizNextBtn.addEventListener('click', () => {
            if (quizIndex < testQuestions.length - 1) {
                quizIndex += 1;
                renderQuizQuestion();
            }
        });

        function showResults(md, slides, trans, generatedFlashcards, generatedQuestions, generationError, studyPackId, studyFeatures, summaryText, sectionsText, combinedText, successfulInterviewFeatures) {
            const config = modeConfig[currentMode];
            resultMarkdown = md || '';
            slideText = slides || '';
            transcript = trans || '';
            flashcards = Array.isArray(generatedFlashcards) ? generatedFlashcards : [];
            testQuestions = Array.isArray(generatedQuestions) ? generatedQuestions : [];
            interviewSummaryText = summaryText || '';
            interviewSectionsText = sectionsText || '';
            interviewCombinedText = combinedText || '';
            studyGenerationError = generationError;
            currentStudyPackId = studyPackId;
            resultsLocked = true;
            resultsTitleText.textContent = config.resultTitle;
            resultsContent.innerHTML = simpleMarkdownToHtml(resultMarkdown);
            flashcardCountBadge.textContent = String(flashcards.length);
            testCountBadge.textContent = String(testQuestions.length);
            const successfulSet = new Set(Array.isArray(successfulInterviewFeatures) ? successfulInterviewFeatures : []);
            if (currentMode === 'interview') {
                if (studyGenerationError) {
                    studyWarning.style.display = 'block';
                    studyWarning.textContent = studyGenerationError;
                } else if (!selectedInterviewFeatures.length) {
                    studyWarning.style.display = 'block';
                    studyWarning.textContent = 'No interview extras selected. Showing the transcript only.';
                } else if (successfulSet.size < selectedInterviewFeatures.length) {
                    const failed = selectedInterviewFeatures.length - successfulSet.size;
                    studyWarning.style.display = 'block';
                    studyWarning.textContent = `Some interview extras could not be generated (${failed} failed). Failed extras were refunded as slides credits.`;
                } else {
                    studyWarning.style.display = 'none';
                    studyWarning.textContent = '';
                }
            } else if (studyGenerationError) {
                studyWarning.style.display = 'block';
                studyWarning.textContent = studyGenerationError;
            } else if (studyFeatures === 'none') {
                studyWarning.style.display = 'block';
                studyWarning.textContent = 'Study tools were disabled for this generation (Notes-only mode).';
            } else {
                studyWarning.style.display = 'none';
                studyWarning.textContent = '';
            }

            flashcardIndex = 0;
            flashcardFlipped = false;
            quizIndex = 0;
            quizScore = 0;
            renderFlashcard();
            renderQuizQuestion();
            document.getElementById('tab-flashcards').style.display = currentMode === 'interview' ? 'none' : 'flex';
            document.getElementById('tab-test').style.display = currentMode === 'interview' ? 'none' : 'flex';
            setActiveResultsTab('notes');
            document.getElementById('tab-flashcards').disabled = currentMode === 'interview' || !flashcards.length;
            document.getElementById('tab-test').disabled = currentMode === 'interview' || !testQuestions.length;

            progressSection.classList.remove('visible');
            resultsSection.classList.add('visible');
            buildDownloadDropdown();
            updateExportCsvButton();
            updateProcessButton();
            showToast('Processing complete!', 'success');
        }
        function showError(msg, creditRefunded) {
            progressStatus.classList.add('error');
            progressStatus.querySelector('.spinner').style.display = 'none';
            if (creditRefunded) {
                statusText.textContent = `Error: ${msg} ‚Äî Your credit has been refunded.`;
                showToast('Processing failed. Your credit has been refunded.', 'info', 5000);
                fetchUserData();
            } else {
                statusText.textContent = `Error: ${msg}`;
            }
            updateProcessButton();
        }
        function resetResultsState() {
            resultMarkdown = '';
            slideText = '';
            transcript = '';
            flashcards = [];
            testQuestions = [];
            interviewSummaryText = '';
            interviewSectionsText = '';
            interviewCombinedText = '';
            currentStudyPackId = null;
            resultsLocked = false;
            flashcardCountBadge.textContent = '0';
            testCountBadge.textContent = '0';
            studyWarning.style.display = 'none';
            exportStudyCsvBtn.style.display = 'none';
            document.getElementById('tab-flashcards').style.display = 'flex';
            document.getElementById('tab-test').style.display = 'flex';
            document.getElementById('tab-flashcards').disabled = false;
            document.getElementById('tab-test').disabled = false;
            setActiveResultsTab('notes');
        }

        function showPricingModal() { pricingOverlay.classList.add('visible'); }
        function hidePricingModal() { pricingOverlay.classList.remove('visible'); }
        function showHistoryModal() { historyOverlay.classList.add('visible'); loadPurchaseHistory(); }
        function hideHistoryModal() { historyOverlay.classList.remove('visible'); }
        function formatPrice(cents, currency) { const amount = (cents / 100).toFixed(2); return currency === 'eur' ? `‚Ç¨${amount}` : `${amount} ${currency.toUpperCase()}`; }
        function formatCreditsText(credits) { return Object.entries(credits).map(([k, v]) => `${v} ${k.replace(/_/g, ' ').replace('credits ', '').replace('credits', '').trim()}`).join(', '); }
        async function loadPurchaseHistory() {
            historyList.innerHTML = '<div class="history-loading"><div class="spinner"></div><span>Loading purchases...</span></div>';
            if (!idToken) return;
            try {
                const r = await fetch('/api/purchase-history', { headers: { 'Authorization': `Bearer ${idToken}` } });
                const d = await r.json();
                if (!d.purchases || !d.purchases.length) {
                    historyList.innerHTML = '<div class="history-empty"><p>No purchases yet</p></div>';
                    return;
                }
                historyList.innerHTML = '';
                d.purchases.forEach(p => {
                    const date = new Date(p.created_at * 1000);
                    const row = document.createElement('div');
                    row.className = 'history-item';
                    row.innerHTML = `<div class="history-item-left"><div class="history-item-name">${p.bundle_name}</div><div class="history-item-date">${date.toLocaleDateString('en-GB')} at ${date.toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit' })}</div><div class="history-item-credits">${formatCreditsText(p.credits)}</div></div><div class="history-item-price">${formatPrice(p.price_cents, p.currency)}</div>`;
                    historyList.appendChild(row);
                });
            } catch (e) {
                historyList.innerHTML = '<div class="history-empty"><p>Could not load purchase history. Please try again.</p></div>';
            }
        }
        async function purchaseBundle(bundleId) {
            if (!idToken) { hidePricingModal(); showAuthModal(); return; }
            const allBtns = document.querySelectorAll('.bundle-buy-btn');
            allBtns.forEach(btn => { btn.disabled = true; if (btn.dataset.bundleId === bundleId) btn.textContent = 'Redirecting...'; });
            try {
                const r = await fetch('/api/create-checkout-session', { method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${idToken}` }, body: JSON.stringify({ bundle_id: bundleId }) });
                const d = await r.json();
                if (d.error) {
                    showToast(d.error, 'error');
                    allBtns.forEach(btn => { btn.disabled = false; btn.textContent = 'Buy now'; });
                    return;
                }
                if (d.checkout_url) window.location.href = d.checkout_url;
            } catch (e) {
                showToast('Something went wrong. Please try again.', 'error');
                allBtns.forEach(btn => { btn.disabled = false; btn.textContent = 'Buy now'; });
            }
        }
        function checkPaymentResult() {
            const params = new URLSearchParams(window.location.search);
            const status = params.get('payment');
            if (status === 'success') {
                showToast('Payment successful! Your credits have been added.', 'success', 5000);
                window.history.replaceState({}, '', '/');
                setTimeout(() => { if (idToken) fetchUserData(); }, 2000);
                setTimeout(() => { if (idToken) fetchUserData(); }, 5000);
            } else if (status === 'cancelled') {
                showToast('Payment cancelled. No charges were made.', 'info', 4000);
                window.history.replaceState({}, '', '/');
            }
        }

        headerSignInBtn.addEventListener('click', () => showAuthModal('signin'));
        signInToProcessBtn.addEventListener('click', () => showAuthModal('signin'));
        authModalClose.addEventListener('click', hideAuthModal);
        authOverlay.addEventListener('click', (e) => { if (e.target === authOverlay) hideAuthModal(); });
        switchToSignup.addEventListener('click', (e) => { e.preventDefault(); showAuthView('signup'); });
        switchToSignin.addEventListener('click', (e) => { e.preventDefault(); showAuthView('signin'); });
        forgotPasswordLink.addEventListener('click', (e) => { e.preventDefault(); showAuthView('reset'); });
        backToSignin.addEventListener('click', (e) => { e.preventDefault(); showAuthView('signin'); });
        signinForm.addEventListener('submit', async (e) => { e.preventDefault(); await signInWithEmail(signinEmail.value.trim(), signinPassword.value); });
        signupForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (signupPassword.value !== signupPasswordConfirm.value) { showAuthError(signupError, 'Passwords do not match.'); return; }
            await signUpWithEmail(signupEmail.value.trim(), signupPassword.value);
        });
        resetForm.addEventListener('submit', async (e) => { e.preventDefault(); await sendPasswordReset(resetEmail.value.trim()); });
        googleSignInBtn.addEventListener('click', signInWithGoogle);
        googleSignUpBtn.addEventListener('click', signInWithGoogle);
        document.querySelectorAll('.password-toggle').forEach(btn => {
            btn.addEventListener('click', () => {
                const input = document.getElementById(btn.dataset.target);
                const open = btn.querySelector('.eye-open');
                const closed = btn.querySelector('.eye-closed');
                if (input.type === 'password') { input.type = 'text'; open.style.display = 'none'; closed.style.display = 'block'; }
                else { input.type = 'password'; open.style.display = 'block'; closed.style.display = 'none'; }
            });
        });
        signOutBtn.addEventListener('click', signOut);
        userButton.addEventListener('click', (e) => { e.stopPropagation(); userDropdown.classList.toggle('visible'); });
        document.addEventListener('click', (e) => { if (!userMenu.contains(e.target)) userDropdown.classList.remove('visible'); });
        buyCreditsBtn.addEventListener('click', () => { userDropdown.classList.remove('visible'); showPricingModal(); });
        purchaseHistoryBtn.addEventListener('click', () => { userDropdown.classList.remove('visible'); showHistoryModal(); });
        headerStudyLibraryBtn.addEventListener('click', () => { window.location.href = '/study'; });
        adminDashboardBtn.addEventListener('click', () => { userDropdown.classList.remove('visible'); window.location.href = '/admin'; });
        buyCreditsLink.addEventListener('click', (e) => { e.preventDefault(); showPricingModal(); });
        pricingModalClose.addEventListener('click', hidePricingModal);
        pricingOverlay.addEventListener('click', (e) => { if (e.target === pricingOverlay) hidePricingModal(); });
        historyModalClose.addEventListener('click', hideHistoryModal);
        historyOverlay.addEventListener('click', (e) => { if (e.target === historyOverlay) hideHistoryModal(); });
        document.querySelectorAll('.bundle-buy-btn').forEach(btn => btn.addEventListener('click', () => purchaseBundle(btn.dataset.bundleId)));
        downloadButton.addEventListener('click', (e) => { e.stopPropagation(); downloadDropdownContent.classList.toggle('visible'); });
        document.addEventListener('click', (e) => { if (!downloadDropdown.contains(e.target)) downloadDropdownContent.classList.remove('visible'); });
        copyButton.addEventListener('click', async () => {
            try {
                await navigator.clipboard.writeText(resultMarkdown);
                copyButtonText.textContent = 'Copied!';
                showToast('Notes copied to clipboard', 'success');
                setTimeout(() => { copyButtonText.textContent = 'Copy Notes'; }, 1800);
            } catch (e) {
                showToast('Failed to copy notes', 'error');
            }
        });
        exportStudyCsvBtn.addEventListener('click', () => {
            if (!currentJobId) return;
            window.location.href = `/download-flashcards-csv/${currentJobId}?type=${exportCsvType}`;
        });
        fullscreenStudyBtn.addEventListener('click', () => {
            if (!currentStudyPackId) {
                showToast('No saved study pack available yet for this result.', 'info');
                return;
            }
            window.open(`/study?pack_id=${encodeURIComponent(currentStudyPackId)}&mode=learn&fullscreen=1`, '_blank');
        });
        studyLibraryBtn.addEventListener('click', () => {
            window.location.href = '/study';
        });
        studyNowBtn.addEventListener('click', () => {
            if (!currentStudyPackId) {
                showToast('No saved study pack available yet for this result.', 'info');
                return;
            }
            window.open(`/study?pack_id=${encodeURIComponent(currentStudyPackId)}&mode=learn`, '_blank');
        });
        newLectureButton.addEventListener('click', () => {
            pdfFile = null;
            audioFile = null;
            currentJobId = null;
            pdfInput.value = '';
            audioInput.value = '';
            pdfInfo.style.display = 'none';
            audioInfo.style.display = 'none';
            pdfZone.classList.remove('has-file');
            audioZone.classList.remove('has-file');
            progressSection.classList.remove('visible');
            resultsSection.classList.remove('visible');
            progressStatus.classList.remove('error');
            progressStatus.querySelector('.spinner').style.display = 'block';
            resetResultsState();
            switchMode(currentMode);
            updateProcessButton();
            window.scrollTo({ top: 0, behavior: 'smooth' });
        });
        studyToolsToggle.addEventListener('click', (e) => {
            e.stopPropagation();
            studyToolsPanel.classList.toggle('visible');
            studyToolsToggle.classList.toggle('open', studyToolsPanel.classList.contains('visible'));
        });
        studyToolChips.forEach(chip => {
            chip.addEventListener('click', () => {
                setStudyFeature(chip.dataset.studyFeatures || 'none');
            });
        });
        flashcardAmountChips.forEach(chip => {
            chip.addEventListener('click', () => {
                if (chip.disabled) return;
                setAmountSelection('flashcards', chip.dataset.value);
            });
        });
        questionAmountChips.forEach(chip => {
            chip.addEventListener('click', () => {
                if (chip.disabled) return;
                setAmountSelection('questions', chip.dataset.value);
            });
        });
        interviewOptionButtons.forEach(btn => {
            btn.addEventListener('click', () => {
                const feature = btn.dataset.feature;
                if (!feature) return;
                if (selectedInterviewFeatures.includes(feature)) {
                    selectedInterviewFeatures = selectedInterviewFeatures.filter(item => item !== feature);
                } else {
                    selectedInterviewFeatures.push(feature);
                }
                selectedInterviewFeatures = selectedInterviewFeatures.slice(0, 2);
                updateInterviewOptionsUI();
            });
        });
        outputLanguageButton.addEventListener('click', (e) => {
            e.stopPropagation();
            outputLanguageMenu.classList.toggle('visible');
            outputLanguageButton.classList.toggle('open', outputLanguageMenu.classList.contains('visible'));
        });
        outputLanguageItems.forEach(item => {
            item.addEventListener('click', () => {
                setOutputLanguage(item.dataset.value || 'english', item.textContent.trim());
                outputLanguageMenu.classList.remove('visible');
                outputLanguageButton.classList.remove('open');
            });
        });
        document.addEventListener('click', (e) => {
            if (!studyToolsPanel.contains(e.target) && !studyToolsToggle.contains(e.target)) {
                studyToolsPanel.classList.remove('visible');
                studyToolsToggle.classList.remove('open');
            }
            if (!outputLanguagePicker.contains(e.target)) {
                outputLanguageMenu.classList.remove('visible');
                outputLanguageButton.classList.remove('open');
            }
        });
        window.addEventListener('keydown', (e) => {
            if (!resultsSection.classList.contains('visible')) return;
            if (activeResultsTab !== 'flashcards') return;
            if (e.key === 'ArrowLeft') { e.preventDefault(); goFlashcard(-1); }
            if (e.key === 'ArrowRight') { e.preventDefault(); goFlashcard(1); }
            if (e.code === 'Space') { e.preventDefault(); flipFlashcard(); }
        });
        window.addEventListener('beforeunload', (e) => { if (currentJobId && pollInterval) { e.preventDefault(); e.returnValue = ''; } });

        function updateHeaderNavActiveState() {
            const currentPath = window.location.pathname.replace(/\/+$/, '') || '/';
            document.querySelectorAll('.header-nav-link').forEach((link) => {
                const href = (link.getAttribute('href') || '').replace(/\/+$/, '') || '/';
                const isDashboardHome = currentPath === '/dashboard' && href === '/';
                link.classList.toggle('active', href === currentPath || isDashboardHome);
            });
        }

        setAmountSelection('flashcards', selectedFlashcardAmount);
        setAmountSelection('questions', selectedQuestionAmount);
        setStudyFeature('none');
        updateInterviewOptionsUI();
        setOutputLanguage('english', 'üá¨üáß English');
        switchMode('lecture-notes');
        resetResultsState();
        updateHeaderNavActiveState();
        checkPaymentResult();
    </script>
</body>
</html>


===== templates/study.html =====
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Study Library</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <style>
    :root {
      --primary:#4F46E5;--primary-dark:#4338CA;--primary-light:#818CF8;--secondary:#0EA5E9;
      --success:#10B981;--warning:#F59E0B;--error:#EF4444;
      --gray-50:#F9FAFB;--gray-100:#F3F4F6;--gray-200:#E5E7EB;--gray-300:#D1D5DB;
      --gray-400:#9CA3AF;--gray-500:#6B7280;--gray-600:#4B5563;--gray-700:#374151;
      --gray-800:#1F2937;--gray-900:#111827;--white:#FFFFFF;
      --shadow-sm:0 1px 2px 0 rgb(0 0 0/.05);--shadow:0 1px 3px 0 rgb(0 0 0/.1),0 1px 2px -1px rgb(0 0 0/.1);
      --shadow-md:0 4px 6px -1px rgb(0 0 0/.1),0 2px 4px -2px rgb(0 0 0/.1);
      --shadow-lg:0 10px 15px -3px rgb(0 0 0/.1),0 4px 6px -4px rgb(0 0 0/.1);
      --shadow-xl:0 20px 25px -5px rgb(0 0 0/.1),0 8px 10px -6px rgb(0 0 0/.1);
      --radius-sm:6px;--radius:8px;--radius-md:12px;--radius-lg:16px;--radius-xl:24px;
    }
    *,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
    html{scroll-behavior:smooth}
    body{font-family:'Inter',-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:linear-gradient(135deg,var(--gray-50) 0%,var(--gray-100) 100%);color:var(--gray-800);line-height:1.6;min-height:100vh;-webkit-font-smoothing:antialiased}
    input,textarea,select,button{font-family:inherit}
    .container{max-width:1360px;margin:0 auto;padding:20px}

    .topbar{display:flex;justify-content:space-between;align-items:center;gap:12px;padding:14px 20px;background:rgba(255,255,255,0.95);backdrop-filter:blur(12px);-webkit-backdrop-filter:blur(12px);border:1px solid var(--gray-200);border-radius:var(--radius-lg);box-shadow:var(--shadow-lg);margin-bottom:16px;position:sticky;top:12px;z-index:100}
    .topbar-logo{display:flex;align-items:center;gap:12px;min-width:0}
    .topbar-logo-icon{width:38px;height:38px;flex-shrink:0;background:linear-gradient(135deg,var(--primary) 0%,var(--secondary) 100%);border-radius:var(--radius-md);display:flex;align-items:center;justify-content:center;color:var(--white)}
    .topbar-logo-icon svg{width:22px;height:22px}
    .topbar h1{font-size:1.15rem;font-weight:700;letter-spacing:-0.025em;color:var(--gray-900);white-space:nowrap}
    .topbar-sub{font-size:.8125rem;color:var(--gray-500);margin-top:1px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;max-width:220px}
    .actions{display:flex;gap:8px;flex-wrap:wrap;align-items:center}

    .btn{display:inline-flex;align-items:center;justify-content:center;gap:7px;border:1px solid var(--gray-300);background:var(--white);color:var(--gray-700);border-radius:var(--radius);padding:9px 14px;font-size:.85rem;font-weight:600;cursor:pointer;transition:all .2s ease;white-space:nowrap}
    .btn:hover{border-color:var(--gray-400);color:var(--gray-900);background:var(--gray-50)}
    .btn:active{transform:scale(.97)}
    .btn.primary{background:linear-gradient(135deg,var(--primary) 0%,var(--primary-dark) 100%);border:none;color:var(--white);box-shadow:0 4px 14px 0 rgba(79,70,229,.3)}
    .btn.primary:hover{opacity:.92;transform:translateY(-1px);box-shadow:0 6px 20px 0 rgba(79,70,229,.4)}
    .btn.danger{border-color:rgba(239,68,68,.35);color:#991B1B;background:rgba(239,68,68,.06)}
    .btn.danger:hover{background:rgba(239,68,68,.12);border-color:rgba(239,68,68,.5)}
    .btn.cta{background:linear-gradient(135deg,var(--primary) 0%,var(--secondary) 100%);border:none;color:var(--white);padding:14px 32px;font-size:1rem;font-weight:700;border-radius:var(--radius-md);box-shadow:0 4px 14px 0 rgba(79,70,229,.35);width:100%}
    .btn.cta:hover{opacity:.92;transform:translateY(-1px);box-shadow:0 6px 20px 0 rgba(79,70,229,.45)}
    .btn svg{width:16px;height:16px;flex-shrink:0}

    .grid{display:grid;grid-template-columns:300px 1fr;gap:16px}
    @media(max-width:1020px){.grid{grid-template-columns:1fr}}

    .panel{background:var(--white);border:1px solid var(--gray-200);border-radius:var(--radius-xl);box-shadow:var(--shadow-lg);overflow:hidden}
    .panel-head{display:flex;align-items:center;justify-content:space-between;gap:8px;padding:16px 20px;border-bottom:1px solid var(--gray-200)}
    .panel-title{font-size:.95rem;font-weight:700;color:var(--gray-900)}
    .panel-body{padding:16px 20px}

    .pack-summary{display:none;padding:16px;margin-bottom:14px;background:linear-gradient(135deg,rgba(79,70,229,.06) 0%,rgba(14,165,233,.06) 100%);border:1px solid rgba(79,70,229,.15);border-radius:var(--radius-md);animation:fadeSlideIn .3s ease-out}
    .pack-summary.visible{display:block}
    .pack-summary-title{font-size:1rem;font-weight:700;color:var(--gray-900);margin-bottom:4px}
    .pack-summary-meta{font-size:.8rem;color:var(--gray-500);margin-bottom:10px}
    .pack-summary-stats{display:flex;gap:16px;flex-wrap:wrap}
    .pack-stat{display:flex;align-items:center;gap:6px;font-size:.82rem;font-weight:600;color:var(--gray-700)}
    .pack-stat-icon{width:28px;height:28px;border-radius:50%;display:flex;align-items:center;justify-content:center;flex-shrink:0}
    .pack-stat-icon svg{width:14px;height:14px}
    .pack-stat-icon.notes-icon{background:rgba(79,70,229,.1);color:var(--primary)}
    .pack-stat-icon.cards-icon{background:rgba(14,165,233,.1);color:var(--secondary)}
    .pack-stat-icon.test-icon{background:rgba(16,185,129,.1);color:var(--success)}

    .field{display:flex;flex-direction:column;gap:5px}
    .field label{font-size:.75rem;color:var(--gray-500);font-weight:700;text-transform:uppercase;letter-spacing:.05em}
    .field input,.field textarea,.field select{border:1px solid var(--gray-300);border-radius:var(--radius);padding:10px 12px;font-size:.9rem;color:var(--gray-900);background:var(--white);transition:all .2s ease}
    .field input:focus,.field textarea:focus,.field select:focus{outline:none;border-color:var(--primary);box-shadow:0 0 0 3px rgba(79,70,229,.1)}
    .field textarea{min-height:78px;resize:vertical}

    .app-select{position:relative}
    .app-select-button{width:100%;display:flex;align-items:center;justify-content:space-between;gap:8px;border:1px solid var(--gray-300);border-radius:var(--radius);padding:10px 12px;font-size:.9rem;color:var(--gray-900);background:var(--white);cursor:pointer;transition:all .2s ease}
    .app-select-button:hover{border-color:var(--primary-light)}
    .app-select-button.open{border-color:var(--primary);box-shadow:0 0 0 3px rgba(79,70,229,.1)}
    .app-select-button svg{width:15px;height:15px;color:var(--gray-500);transition:transform .2s ease}
    .app-select-button.open svg{transform:rotate(180deg)}
    .app-select-label{overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
    .app-select-menu{display:none;position:absolute;left:0;right:0;top:calc(100% + 6px);background:var(--white);border:1px solid var(--gray-200);border-radius:var(--radius-md);box-shadow:var(--shadow-lg);z-index:80;max-height:260px;overflow-y:auto}
    .app-select-menu.visible{display:block;animation:dropdownOpen .2s ease-out}
    .app-select-item{width:100%;border:none;background:var(--white);text-align:left;padding:10px 12px;font-size:.9rem;color:var(--gray-700);cursor:pointer;transition:background .15s ease}
    .app-select-item:hover{background:var(--gray-50)}
    .app-select-item.active{background:rgba(79,70,229,.1);color:var(--primary-dark);font-weight:600}
    .q-answer-picker{margin-top:4px}

    .search-box{margin-bottom:12px}
    .list{display:flex;flex-direction:column;gap:8px;max-height:68vh;overflow-y:auto;padding-right:2px}

    .item{border:1px solid var(--gray-200);border-radius:var(--radius-md);padding:12px 14px;background:var(--white);cursor:pointer;transition:all .25s ease}
    .item:hover{border-color:var(--gray-300);box-shadow:var(--shadow-sm);transform:translateY(-1px)}
    .item.active{border-color:var(--primary);background:rgba(79,70,229,.04);box-shadow:0 0 0 3px rgba(79,70,229,.08)}
    .item.dragging{opacity:.35;transform:scale(.985);border-style:dashed;border-color:var(--primary);background:rgba(79,70,229,.08)}
    .item.drop-target{border-color:var(--success);background:linear-gradient(135deg,rgba(16,185,129,.12) 0%,rgba(14,165,233,.08) 100%);box-shadow:0 0 0 3px rgba(16,185,129,.15);transform:translateY(-2px)}
    .item-head{display:flex;justify-content:space-between;gap:8px;align-items:center}
    .item-title{font-size:.9rem;font-weight:700;color:var(--gray-900)}
    .item-sub{margin-top:4px;font-size:.78rem;color:var(--gray-500)}

    .split{display:grid;grid-template-columns:320px 1fr;gap:16px}
    @media(max-width:1200px){.split{grid-template-columns:1fr}}
    .meta-grid{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:10px;margin-bottom:14px}
    @media(max-width:700px){.meta-grid{grid-template-columns:1fr}}

    .editor-wrap{display:none}
    .editor-wrap.visible{display:block;animation:fadeSlideIn .3s ease-out}
    .empty{color:var(--gray-500);font-size:.9rem;padding:20px;border:1px dashed var(--gray-300);border-radius:var(--radius-md);background:var(--gray-50);text-align:center}
    .editor-tabs{display:flex;gap:4px;margin-bottom:14px;background:var(--gray-100);border-radius:var(--radius-md);padding:4px}
    .editor-tab{flex:1;border:none;background:transparent;border-radius:var(--radius);padding:10px 12px;font-size:.82rem;font-weight:600;color:var(--gray-600);cursor:pointer;transition:all .2s ease;text-align:center;display:flex;align-items:center;justify-content:center;gap:6px}
    .editor-tab:hover{color:var(--gray-900)}
    .editor-tab.active{background:var(--white);color:var(--gray-900);box-shadow:var(--shadow-sm)}
    .editor-tab svg{width:15px;height:15px}
    .editor-pane{display:none}
    .editor-pane.active{display:block;animation:fadeIn .25s ease-out}
    .notes-view{border:1px solid var(--gray-200);border-radius:var(--radius-md);background:var(--gray-50);padding:20px;max-height:60vh;overflow-y:auto;font-size:.92rem;line-height:1.7}
    .notes-view h1,.notes-view h2,.notes-view h3{margin-top:20px;margin-bottom:10px;color:var(--gray-900)}
    .notes-view h1{font-size:1.4rem;border-bottom:2px solid var(--gray-200);padding-bottom:8px}
    .editor-toolbar{display:flex;justify-content:space-between;align-items:center;gap:8px;flex-wrap:wrap;margin-bottom:10px}
    .editor-count{font-size:.82rem;color:var(--gray-500);font-weight:600}
    .editor-list{display:flex;flex-direction:column;gap:10px;max-height:58vh;overflow-y:auto;padding-right:2px}
    .editor-card{border:1px solid var(--gray-200);border-radius:var(--radius-md);background:var(--white);padding:14px;transition:all .25s ease}
    .editor-card:hover{border-color:var(--gray-300);box-shadow:var(--shadow-sm)}
    .editor-card.newly-added{border-color:var(--success);box-shadow:0 0 0 3px rgba(16,185,129,.12);animation:highlightPulse .6s ease-out}
    .editor-card-head{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px}
    .editor-card-title{font-size:.8rem;color:var(--gray-500);font-weight:700;text-transform:uppercase;letter-spacing:.05em}
    .q-options-grid{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:8px}
    @media(max-width:700px){.q-options-grid{grid-template-columns:1fr}}

    /* ‚îÄ‚îÄ Setup overlay ‚îÄ‚îÄ */
    .setup-overlay{position:fixed;inset:0;z-index:280;background:rgba(0,0,0,.5);display:none;align-items:center;justify-content:center;padding:18px;opacity:0;transition:opacity .25s ease}
    .setup-overlay.visible{display:flex;opacity:1}
    .setup-overlay.entering{display:flex;opacity:0}
    .setup-modal{width:min(720px,100%);max-height:90vh;overflow-y:auto;background:var(--white);border:1px solid var(--gray-200);border-radius:var(--radius-xl);box-shadow:var(--shadow-xl);padding:28px;transform:scale(.95);opacity:0;transition:all .25s ease}
    .setup-overlay.visible .setup-modal{transform:scale(1);opacity:1}
    .setup-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px}
    .setup-title{font-size:1.2rem;font-weight:700;color:var(--gray-900)}
    .setup-pack-name{font-size:.85rem;color:var(--gray-500);margin-top:2px}
    .setup-tabs{display:flex;gap:4px;background:var(--gray-100);border-radius:var(--radius-md);padding:4px;margin-bottom:20px}
    .setup-tab{flex:1;border:none;background:transparent;border-radius:var(--radius);padding:10px 6px;font-size:.78rem;font-weight:600;color:var(--gray-600);cursor:pointer;transition:all .2s ease;text-align:center;display:flex;align-items:center;justify-content:center;gap:5px}
    .setup-tab:hover{color:var(--gray-900)}
    .setup-tab.active{background:var(--white);color:var(--gray-900);box-shadow:var(--shadow-sm)}
    .setup-tab svg{width:14px;height:14px}
    .setup-pane{display:none}
    .setup-pane.active{display:block;animation:fadeIn .2s ease-out}

    /* Lessons */
    .lesson-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:12px}
    @media(max-width:500px){.lesson-grid{grid-template-columns:1fr}}
    .lesson-card{border:2px solid var(--gray-200);border-radius:var(--radius-md);padding:20px;cursor:pointer;transition:all .25s ease;display:flex;flex-direction:column;align-items:center;gap:8px;text-align:center;position:relative}
    .lesson-card:hover{border-color:var(--gray-300);box-shadow:var(--shadow-sm)}
    .lesson-card.selected{border-color:var(--primary);background:linear-gradient(135deg,rgba(79,70,229,.08) 0%,rgba(14,165,233,.06) 100%);box-shadow:0 0 0 3px rgba(79,70,229,.1)}
    .lesson-card.unavailable{opacity:.4;cursor:not-allowed;pointer-events:none}
    .lesson-card-check{position:absolute;top:10px;left:10px;width:22px;height:22px;border:2px solid var(--gray-300);border-radius:50%;display:flex;align-items:center;justify-content:center;transition:all .2s ease}
    .lesson-card.selected .lesson-card-check{background:var(--primary);border-color:var(--primary)}
    .lesson-card-check svg{width:13px;height:13px;color:var(--white);opacity:0;transition:opacity .2s ease}
    .lesson-card.selected .lesson-card-check svg{opacity:1}
    .lesson-card-icon{width:40px;height:40px;color:var(--primary)}
    .lesson-card-icon svg{width:100%;height:100%}
    .lesson-card-title{font-size:1rem;font-weight:700;color:var(--gray-900)}
    .lesson-card-desc{font-size:.82rem;color:var(--gray-500)}
    .lesson-card-badge{font-size:.7rem;font-weight:700;text-transform:uppercase;letter-spacing:.05em;color:var(--gray-400);background:var(--gray-100);padding:3px 8px;border-radius:20px}

    /* Mode picker (shown when multiple lessons enabled) */
    .mode-picker{display:none;animation:fadeIn .2s ease-out}
    .mode-picker.active{display:block}
    .mode-picker-title{text-align:center;font-size:1rem;font-weight:700;color:var(--gray-900);margin-bottom:16px}
    .mode-picker-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:12px}
    @media(max-width:500px){.mode-picker-grid{grid-template-columns:1fr}}
    .mode-picker-card{border:2px solid var(--gray-200);border-radius:var(--radius-md);padding:24px 16px;cursor:pointer;transition:all .25s ease;display:flex;flex-direction:column;align-items:center;gap:8px;text-align:center}
    .mode-picker-card:hover{border-color:var(--primary-light);box-shadow:var(--shadow-md);transform:translateY(-2px)}
    .mode-picker-card svg{width:36px;height:36px;color:var(--primary)}
    .mode-picker-card-title{font-size:.95rem;font-weight:700;color:var(--gray-900)}
    .mode-picker-card-desc{font-size:.8rem;color:var(--gray-500)}

    /* Algorithm */
    .algo-lane{display:flex;align-items:center;gap:6px;justify-content:center;margin-bottom:20px;flex-wrap:wrap}
    .algo-slot{width:100px;height:110px;border-radius:var(--radius-md);display:flex;flex-direction:column;align-items:center;justify-content:center;gap:5px;font-size:.78rem;font-weight:700;color:var(--white);cursor:pointer;transition:all .25s ease;box-shadow:var(--shadow-sm);user-select:none}
    .algo-slot:hover{transform:translateY(-3px);box-shadow:var(--shadow-md)}
    .algo-slot:active{transform:scale(.95)}
    .algo-slot svg{width:26px;height:26px}
    .algo-slot[data-type="new"]{background:linear-gradient(135deg,#38BDF8,#0EA5E9)}
    .algo-slot[data-type="familiar"]{background:linear-gradient(135deg,#34D399,#10B981)}
    .algo-slot[data-type="retry"]{background:linear-gradient(135deg,#FB7185,#EF4444)}
    .algo-slot[data-type="remaster"]{background:linear-gradient(135deg,#FBBF24,#F59E0B)}
    .algo-slot[data-type="random"]{background:linear-gradient(135deg,#A78BFA,#7C3AED)}
    .algo-chevron{color:var(--gray-400);flex-shrink:0}
    .algo-chevron svg{width:16px;height:16px}
    .algo-presets{display:flex;gap:8px;justify-content:center;flex-wrap:wrap;margin-bottom:20px}
    .algo-preset{border:1px solid var(--gray-300);background:var(--white);border-radius:var(--radius);padding:8px 14px;font-size:.82rem;font-weight:600;color:var(--gray-700);cursor:pointer;transition:all .2s ease}
    .algo-preset:hover{border-color:var(--gray-400);color:var(--gray-900)}
    .algo-preset.active{background:var(--primary);color:var(--white);border-color:var(--primary)}

    /* Settings */
    .settings-list{display:flex;flex-direction:column;gap:2px}
    .setting-row{display:flex;align-items:center;justify-content:space-between;gap:12px;padding:14px 16px;border-radius:var(--radius);background:var(--gray-50);transition:background .15s ease;cursor:pointer}
    .setting-row:hover{background:var(--gray-100)}
    .setting-row.active{background:rgba(79,70,229,.06)}
    .setting-label{font-size:.9rem;color:var(--gray-800);font-weight:500}
    .setting-toggle{width:42px;height:24px;border-radius:12px;background:var(--gray-300);position:relative;flex-shrink:0;transition:background .2s ease}
    .setting-toggle::after{content:'';position:absolute;top:2px;left:2px;width:20px;height:20px;border-radius:50%;background:var(--white);box-shadow:var(--shadow-sm);transition:transform .2s ease}
    .setting-row.active .setting-toggle{background:var(--primary)}
    .setting-row.active .setting-toggle::after{transform:translateX(18px)}

    /* Mastery */
    .mastery-section{text-align:center}
    .mastery-rings{display:flex;justify-content:center;gap:24px;margin:20px 0;flex-wrap:wrap}
    .mastery-ring{display:flex;flex-direction:column;align-items:center;gap:8px}
    .mastery-ring-circle{width:80px;height:80px;border-radius:50%;border:4px solid var(--gray-200);display:flex;align-items:center;justify-content:center;font-size:1.25rem;font-weight:800;color:var(--gray-900);transition:all .3s ease}
    .mastery-ring-circle.new-ring{border-color:#38BDF8;color:#0EA5E9}
    .mastery-ring-circle.familiar-ring{border-color:#34D399;color:#10B981}
    .mastery-ring-circle.mastered-ring{border-color:#FBBF24;color:#F59E0B}
    .mastery-ring-label{font-size:.75rem;font-weight:700;text-transform:uppercase;letter-spacing:.05em;color:var(--gray-500)}
    .mastery-stat{display:flex;align-items:center;justify-content:center;gap:8px;padding:10px 16px;background:var(--gray-50);border-radius:var(--radius);font-size:.85rem;color:var(--gray-600);margin-bottom:16px}
    .mastery-stat strong{color:var(--gray-900)}

    /* ‚îÄ‚îÄ Learn stage ‚îÄ‚îÄ */
    .learn-stage{position:fixed;inset:0;z-index:300;background:linear-gradient(135deg,var(--gray-50) 0%,var(--gray-100) 100%);display:none;opacity:0;transition:opacity .35s ease}
    .learn-stage::before{content:'';position:absolute;inset:0;pointer-events:none;background:radial-gradient(circle at 15% 15%,rgba(79,70,229,.12),transparent 50%),radial-gradient(circle at 85% 25%,rgba(14,165,233,.10),transparent 50%),radial-gradient(circle at 50% 85%,rgba(79,70,229,.06),transparent 50%)}
    .learn-stage.visible{display:block;opacity:1}
    .learn-stage.entering{display:block;opacity:0}
    .learn-shell{height:100%;display:flex;flex-direction:column;padding:20px;position:relative;z-index:1}
    .learn-top{display:flex;justify-content:space-between;align-items:center;gap:12px;background:rgba(255,255,255,.95);backdrop-filter:blur(12px);border:1px solid var(--gray-200);border-radius:var(--radius-lg);box-shadow:var(--shadow-lg);padding:14px 20px}
    .learn-top-left{display:flex;align-items:center;gap:12px;min-width:0}
    .learn-top-left>div{min-width:0}
    .learn-title{font-size:1.05rem;font-weight:700;color:var(--gray-900);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .learn-sub{font-size:.82rem;color:var(--gray-500)}
    .learn-progress-bar{height:4px;background:var(--gray-200);border-radius:2px;flex:1;min-width:60px;max-width:200px}
    .learn-progress-fill{height:100%;background:linear-gradient(135deg,var(--primary) 0%,var(--secondary) 100%);border-radius:2px;transition:width .3s ease}
    .learn-progress-text{font-size:.78rem;font-weight:600;color:var(--gray-500);white-space:nowrap}
    .learn-progress-center{display:flex;align-items:center;gap:10px;flex:1;justify-content:center;min-width:0}
    .learn-body{flex:1;min-height:0;display:grid;place-items:center;padding:16px 0}
    .learn-card{width:min(1000px,100%);max-height:100%;background:rgba(255,255,255,.96);border:1px solid var(--gray-200);border-radius:var(--radius-xl);box-shadow:var(--shadow-xl);padding:24px;display:flex;flex-direction:column;gap:16px;overflow-y:auto}

    /* No learn tabs in focused mode ‚Äî they are hidden */
    .learn-mode-label{font-size:.82rem;font-weight:700;color:var(--gray-500);text-transform:uppercase;letter-spacing:.05em;text-align:center;margin-bottom:4px}

    .learn-pane{display:none;min-height:0}
    .learn-pane.active{display:block;animation:fadeIn .25s ease-out}
    .learn-notes{border:1px solid var(--gray-200);border-radius:var(--radius-md);background:var(--gray-50);padding:20px;max-height:60vh;overflow-y:auto;font-size:.95rem;line-height:1.75}
    .learn-notes h1,.learn-notes h2,.learn-notes h3{margin-top:20px;margin-bottom:10px;color:var(--gray-900)}

    /* ‚îÄ‚îÄ 3D Flashcard with slide transitions ‚îÄ‚îÄ */
    .flashcard-stage{display:flex;flex-direction:column;align-items:center;gap:14px}
    .flashcard-3d{width:min(100%,860px);height:340px;perspective:1200px;cursor:pointer;position:relative;overflow:hidden}
    .flashcard-inner{position:relative;width:100%;height:100%;transform-style:preserve-3d;transition:transform .55s ease}
    .flashcard-inner.flipped{transform:rotateY(180deg)}
    .flashcard-inner.slide-left{animation:slideLeft .3s ease-out}
    .flashcard-inner.slide-right{animation:slideRight .3s ease-out}
    .flashcard-face{position:absolute;inset:0;backface-visibility:hidden;border-radius:var(--radius-lg);border:1px solid var(--gray-200);background:linear-gradient(135deg,rgba(79,70,229,.06) 0%,rgba(14,165,233,.08) 100%);box-shadow:var(--shadow-md);display:flex;align-items:center;justify-content:center;padding:30px;text-align:center}
    .flashcard-face.back{transform:rotateY(180deg);background:linear-gradient(135deg,rgba(14,165,233,.08) 0%,rgba(79,70,229,.06) 100%)}
    .flashcard-label{position:absolute;top:16px;left:16px;font-size:.7rem;color:var(--gray-400);font-weight:700;text-transform:uppercase;letter-spacing:.06em}
    .flashcard-text{font-size:1.15rem;color:var(--gray-900);line-height:1.65;white-space:pre-wrap;max-height:260px;overflow-y:auto}
    .learn-controls{display:flex;justify-content:center;align-items:center;flex-wrap:wrap;gap:10px}
    .learn-progress-fc{font-size:.85rem;color:var(--gray-500);min-width:120px;text-align:center;font-weight:500}
    .keyboard-hints{display:flex;gap:12px;justify-content:center;flex-wrap:wrap;font-size:.75rem;color:var(--gray-400)}
    .keyboard-hints span{display:inline-flex;align-items:center;gap:4px}
    .kbd{display:inline-flex;align-items:center;justify-content:center;min-width:22px;height:20px;padding:0 5px;background:var(--gray-100);border:1px solid var(--gray-300);border-radius:4px;font-size:.68rem;font-weight:700;color:var(--gray-600)}

    @keyframes slideLeft{0%{opacity:1;transform:translateX(0)}40%{opacity:0;transform:translateX(-40px)}41%{opacity:0;transform:translateX(40px)}100%{opacity:1;transform:translateX(0)}}
    @keyframes slideRight{0%{opacity:1;transform:translateX(0)}40%{opacity:0;transform:translateX(40px)}41%{opacity:0;transform:translateX(-40px)}100%{opacity:1;transform:translateX(0)}}
    @media(prefers-reduced-motion:reduce){.flashcard-inner.slide-left,.flashcard-inner.slide-right{animation:none}.flashcard-inner{transition:none}}

    /* ‚îÄ‚îÄ Quiz ‚îÄ‚îÄ */
    .quiz-head{display:flex;justify-content:space-between;align-items:center;gap:10px;margin-bottom:10px;font-size:.9rem;font-weight:600;color:var(--gray-700)}
    .quiz-question{font-size:1.1rem;font-weight:700;margin-bottom:14px;color:var(--gray-900);line-height:1.5}
    .quiz-options{display:grid;gap:10px}
    .quiz-option{width:100%;text-align:left;border:1px solid var(--gray-300);background:var(--white);border-radius:var(--radius);padding:14px 18px;font-size:.9375rem;color:var(--gray-800);cursor:pointer;transition:all .2s ease}
    .quiz-option:hover:not(:disabled){border-color:var(--primary-light);background:var(--gray-50);transform:translateY(-1px)}
    .quiz-option.correct{border-color:var(--success);background:rgba(16,185,129,.12);color:#065F46;transform:none}
    .quiz-option.wrong{border-color:var(--error);background:rgba(239,68,68,.12);color:#991B1B;transform:none}
    .quiz-option:disabled{cursor:default;transform:none}
    .quiz-expl{margin-top:10px;border:1px solid rgba(14,165,233,.2);border-radius:var(--radius);background:rgba(14,165,233,.06);padding:14px 18px;font-size:.9rem;color:var(--gray-700);line-height:1.5;display:none}
    .quiz-expl.visible{display:block;animation:fadeSlideIn .25s ease-out}

    /* ‚îÄ‚îÄ Write mode ‚îÄ‚îÄ */
    .write-stage{display:flex;flex-direction:column;align-items:center;gap:16px;width:100%}
    .write-prompt{font-size:1.15rem;font-weight:700;color:var(--gray-900);text-align:center;padding:24px;border:1px solid var(--gray-200);border-radius:var(--radius-lg);background:linear-gradient(135deg,rgba(79,70,229,.06) 0%,rgba(14,165,233,.08) 100%);width:100%;min-height:100px;display:flex;align-items:center;justify-content:center}
    .write-input-row{display:flex;gap:8px;width:100%;max-width:600px}
    .write-input{flex:1;border:2px solid var(--gray-300);border-radius:var(--radius);padding:14px 16px;font-size:1rem;color:var(--gray-900);transition:border-color .2s ease}
    .write-input:focus{outline:none;border-color:var(--primary);box-shadow:0 0 0 3px rgba(79,70,229,.1)}
    .write-input.correct-input{border-color:var(--success);background:rgba(16,185,129,.06)}
    .write-input.wrong-input{border-color:var(--error);background:rgba(239,68,68,.06)}
    .write-feedback{text-align:center;font-size:.9rem;padding:12px 16px;border-radius:var(--radius);width:100%;max-width:600px;display:none}
    .write-feedback.visible{display:block;animation:fadeSlideIn .25s ease-out}
    .write-feedback.correct-fb{background:rgba(16,185,129,.1);border:1px solid rgba(16,185,129,.3);color:#065F46}
    .write-feedback.wrong-fb{background:rgba(239,68,68,.1);border:1px solid rgba(239,68,68,.3);color:#991B1B}

    /* ‚îÄ‚îÄ Match mode ‚îÄ‚îÄ */
    .match-stage{display:flex;flex-direction:column;align-items:center;gap:16px;width:100%}
    .match-timer{font-size:1.5rem;font-weight:800;color:var(--gray-900);font-variant-numeric:tabular-nums}
    .match-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;width:100%}
    @media(max-width:600px){.match-grid{grid-template-columns:repeat(3,1fr);gap:8px}}
    .match-cell{border:2px solid var(--gray-200);border-radius:var(--radius-md);padding:14px 8px;text-align:center;font-size:.85rem;font-weight:600;color:var(--gray-800);cursor:pointer;transition:all .2s ease;min-height:60px;display:flex;align-items:center;justify-content:center;word-break:break-word;background:var(--white)}
    .match-cell:hover:not(.matched):not(.selected){border-color:var(--gray-400);background:var(--gray-50);transform:translateY(-1px)}
    .match-cell.selected{border-color:var(--primary);background:rgba(79,70,229,.08);box-shadow:0 0 0 3px rgba(79,70,229,.12)}
    .match-cell.matched{border-color:var(--success);background:rgba(16,185,129,.1);color:#065F46;cursor:default;opacity:.7}
    .match-cell.wrong-flash{border-color:var(--error);background:rgba(239,68,68,.12);animation:shake .4s ease}
    .match-results{text-align:center;padding:20px;border:1px solid var(--gray-200);border-radius:var(--radius-md);background:var(--gray-50);width:100%}
    .match-results-time{font-size:2rem;font-weight:800;color:var(--gray-900)}
    .match-results-badge{font-size:1rem;font-weight:700;margin-top:8px}
    .match-results-badge.gold{color:#F59E0B}
    .match-results-badge.silver{color:var(--gray-500)}
    .match-results-badge.bronze{color:#B45309}
    .match-results-history{margin-top:12px;font-size:.82rem;color:var(--gray-500)}

    @keyframes shake{0%,100%{transform:translateX(0)}20%{transform:translateX(-6px)}40%{transform:translateX(6px)}60%{transform:translateX(-4px)}80%{transform:translateX(4px)}}

    /* ‚îÄ‚îÄ Fullscreen Builder ‚îÄ‚îÄ */
    .builder-overlay{position:fixed;inset:0;z-index:290;display:none;opacity:0;transition:opacity .28s ease;background:linear-gradient(135deg,rgba(17,24,39,.44),rgba(31,41,55,.42))}
    .builder-overlay.visible{display:block;opacity:1}
    .builder-overlay.entering{display:block;opacity:0}
    .builder-shell{height:100%;display:grid;grid-template-columns:320px 1fr;gap:0;background:linear-gradient(180deg,var(--gray-50),#eef3ff)}
    .builder-rail{border-right:1px solid var(--gray-200);background:linear-gradient(180deg,#ffffff,#f7f9ff);padding:22px 18px 18px;overflow-y:auto}
    .builder-brand{margin-bottom:14px}
    .builder-brand h2{font-size:1.48rem;line-height:1.15;letter-spacing:-.03em;color:var(--gray-900)}
    .builder-brand p{font-size:.8rem;color:var(--gray-500);margin-top:5px}
    .builder-top-actions{display:grid;grid-template-columns:1fr;gap:8px;margin-bottom:12px}
    .builder-duo{display:grid;grid-template-columns:1fr 1fr;gap:8px}
    .builder-nav{display:flex;flex-direction:column;gap:8px;margin:14px 0 16px}
    .builder-nav-btn{width:100%;display:flex;align-items:center;gap:8px;border:1px solid var(--gray-300);background:var(--white);border-radius:var(--radius-md);padding:10px 12px;font-size:.86rem;font-weight:700;color:var(--gray-700);cursor:pointer;transition:all .2s ease}
    .builder-nav-btn:hover{border-color:var(--primary-light);box-shadow:var(--shadow-sm)}
    .builder-nav-btn.active{background:linear-gradient(135deg,rgba(79,70,229,.08),rgba(14,165,233,.08));border-color:rgba(79,70,229,.4);color:var(--gray-900);box-shadow:0 0 0 2px rgba(79,70,229,.13)}
    .builder-nav-btn svg{width:16px;height:16px}
    .builder-mini-stats{display:grid;gap:8px;margin-top:10px}
    .builder-stat{padding:9px 10px;border-radius:var(--radius);background:var(--gray-100);font-size:.78rem;color:var(--gray-600)}
    .builder-stat strong{color:var(--gray-900)}
    .builder-main{padding:22px 26px;overflow-y:auto;position:relative}
    .builder-main::before{content:'';position:absolute;inset:0;pointer-events:none;background:radial-gradient(circle at 85% 18%,rgba(79,70,229,.08),transparent 42%),radial-gradient(circle at 20% 85%,rgba(14,165,233,.08),transparent 46%)}
    .builder-main-inner{position:relative;z-index:1}
    .builder-headline{display:flex;justify-content:space-between;align-items:center;gap:12px;margin-bottom:16px}
    .builder-title{font-size:1.2rem;font-weight:800;color:var(--gray-900)}
    .builder-sub{font-size:.85rem;color:var(--gray-500)}
    .builder-pane{display:none}
    .builder-pane.active{display:block;animation:fadeIn .2s ease-out}
    .builder-card{background:rgba(255,255,255,.95);border:1px solid var(--gray-200);border-radius:18px;padding:18px;box-shadow:var(--shadow-lg)}
    .builder-grid{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:12px}
    .builder-grid-3{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:12px}
    .builder-list{display:flex;flex-direction:column;gap:12px;max-height:64vh;overflow-y:auto;padding-right:3px}
    .builder-list-empty{padding:22px;border:1px dashed var(--gray-300);border-radius:var(--radius-md);background:var(--gray-50);text-align:center;color:var(--gray-500)}
    .builder-row{border:1px solid var(--gray-200);border-radius:14px;padding:14px;background:var(--white);box-shadow:var(--shadow-sm)}
    .builder-row-head{display:flex;justify-content:space-between;align-items:center;gap:8px;margin-bottom:9px}
    .builder-row-title{font-size:.78rem;letter-spacing:.05em;text-transform:uppercase;font-weight:700;color:var(--gray-500)}
    .builder-split{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .builder-cta-strip{display:flex;flex-wrap:wrap;gap:8px;margin-bottom:10px}
    .builder-info-banner{display:flex;justify-content:space-between;align-items:center;gap:10px;padding:12px 14px;border:1px solid rgba(79,70,229,.22);background:linear-gradient(135deg,rgba(79,70,229,.08),rgba(14,165,233,.08));border-radius:12px;margin-bottom:12px}
    .builder-info-banner span{font-size:.82rem;color:var(--gray-700);font-weight:600}
    .builder-drop{border:2px dashed rgba(55,65,81,.34);border-radius:16px;padding:28px 16px;text-align:center;background:rgba(255,255,255,.8);transition:all .2s ease;cursor:pointer}
    .builder-drop:hover{border-color:rgba(79,70,229,.6);background:rgba(79,70,229,.04)}
    .builder-drop.dragover{border-color:var(--primary);background:rgba(79,70,229,.08);box-shadow:0 0 0 3px rgba(79,70,229,.14)}
    .builder-import-tools{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin:12px 0}
    .builder-preview{margin-top:12px;border:1px solid var(--gray-200);border-radius:12px;background:#fff;overflow:hidden}
    .builder-preview-head{padding:10px 12px;font-size:.8rem;font-weight:700;color:var(--gray-600);background:var(--gray-50);border-bottom:1px solid var(--gray-200)}
    .builder-preview-table{width:100%;border-collapse:collapse;font-size:.82rem}
    .builder-preview-table th,.builder-preview-table td{padding:8px 10px;border-bottom:1px solid var(--gray-100);text-align:left;vertical-align:top}
    .builder-preview-table th{font-size:.74rem;text-transform:uppercase;letter-spacing:.04em;color:var(--gray-500)}
    .builder-errors{margin-top:10px;max-height:160px;overflow-y:auto;padding:10px;border-radius:10px;background:rgba(239,68,68,.08);border:1px solid rgba(239,68,68,.22);font-size:.78rem;color:#991B1B}
    .builder-helper{font-size:.8rem;color:var(--gray-500)}
    .builder-select{width:100%;border:1px solid var(--gray-300);border-radius:var(--radius);padding:10px 12px;background:#fff;font-size:.88rem;color:var(--gray-800)}
    .builder-select:focus{outline:none;border-color:var(--primary);box-shadow:0 0 0 3px rgba(79,70,229,.1)}
    .builder-exit-modal .modal{max-width:520px}
    .builder-exit-icon{width:72px;height:72px;border-radius:50%;margin:2px auto 10px;display:grid;place-items:center;color:var(--primary);background:linear-gradient(135deg,rgba(79,70,229,.12),rgba(14,165,233,.12));border:1px solid rgba(79,70,229,.2)}
    .builder-exit-icon svg{width:34px;height:34px}

    /* ‚îÄ‚îÄ Modals ‚îÄ‚îÄ */
    .modal-overlay{position:fixed;inset:0;z-index:260;background:rgba(0,0,0,.5);display:none;align-items:center;justify-content:center;padding:18px;opacity:0;transition:opacity .25s ease}
    .modal-overlay.visible{display:flex;opacity:1}
    .modal-overlay.entering{display:flex;opacity:0}
    .modal{width:min(560px,100%);background:var(--white);border:1px solid var(--gray-200);border-radius:var(--radius-xl);box-shadow:var(--shadow-xl);padding:24px;transform:scale(.95);opacity:0;transition:all .25s ease}
    .modal-overlay.visible .modal{transform:scale(1);opacity:1}
    .modal-head{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px}
    .modal-title{font-size:1.1rem;font-weight:700;color:var(--gray-900)}
    .modal-grid{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:10px}
    @media(max-width:620px){.modal-grid{grid-template-columns:1fr}}
    .modal-message{font-size:.92rem;color:var(--gray-700);margin-bottom:16px;line-height:1.5}

    .toast{position:fixed;bottom:24px;left:50%;transform:translateX(-50%) translateY(100px);background:var(--gray-900);color:var(--white);border-radius:var(--radius-md);padding:14px 24px;font-size:.9375rem;font-weight:500;box-shadow:var(--shadow-xl);opacity:0;transition:all .3s ease;z-index:500;display:flex;align-items:center;gap:10px;max-width:calc(100vw - 48px)}
    .toast.visible{transform:translateX(-50%) translateY(0);opacity:1}
    .toast.success{background:var(--success)}
    .toast.error{background:var(--error)}

    @keyframes dropdownOpen{from{opacity:0;transform:translateY(-8px)}to{opacity:1;transform:translateY(0)}}
    @keyframes fadeIn{from{opacity:0}to{opacity:1}}
    @keyframes fadeSlideIn{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}
    @keyframes highlightPulse{0%{box-shadow:0 0 0 0 rgba(16,185,129,.35)}100%{box-shadow:0 0 0 3px rgba(16,185,129,.12)}}

    @media(max-width:600px){
      .container{padding:10px}
      .topbar{padding:10px 14px;flex-direction:column;align-items:stretch;gap:10px;position:static;border-radius:var(--radius-md)}
      .topbar .actions{justify-content:flex-end}
      .topbar-sub{max-width:100%}
      .panel{border-radius:var(--radius-lg)}
      .panel-head{padding:12px 14px}
      .panel-body{padding:12px 14px}
      .split{grid-template-columns:1fr;gap:12px}
      .meta-grid{grid-template-columns:1fr}
      .learn-shell{padding:10px}
      .learn-top{flex-direction:column;align-items:stretch;gap:10px;padding:12px 14px;border-radius:var(--radius-md)}
      .learn-top .actions{justify-content:flex-end}
      .learn-progress-center{justify-content:flex-start}
      .learn-card{padding:14px;border-radius:var(--radius-lg)}
      .flashcard-3d{height:260px}
      .algo-slot{width:68px;height:82px;font-size:.68rem}
      .algo-slot svg{width:20px;height:20px}
      .algo-chevron svg{width:12px;height:12px}
      .algo-lane{gap:4px}
      .lesson-grid{grid-template-columns:1fr}
      .lesson-card{padding:14px}
      .setup-modal{padding:18px}
      .setup-tabs{flex-wrap:wrap}
      .setup-tab{padding:8px 4px;font-size:.72rem}
      .setup-tab svg{width:12px;height:12px}
      .btn{padding:8px 10px;font-size:.8rem}
      .btn.cta{padding:12px 20px;font-size:.92rem}
      .keyboard-hints{display:none}
      .editor-tab{font-size:.75rem;padding:8px 6px;gap:4px}
      .editor-tab svg{width:13px;height:13px}
      .match-grid{grid-template-columns:repeat(3,1fr)}
      .builder-shell{grid-template-columns:1fr}
      .builder-rail{border-right:none;border-bottom:1px solid var(--gray-200)}
      .builder-main{padding:14px}
      .builder-grid,.builder-grid-3,.builder-split,.builder-import-tools{grid-template-columns:1fr}
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="topbar">
      <div class="topbar-logo">
        <div class="topbar-logo-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"></path><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"></path></svg></div>
        <div><h1>Study Library</h1><div class="topbar-sub" id="user-meta">Checking sign-in...</div></div>
      </div>
      <div class="actions">
        <button class="btn" id="back-app-btn"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 5 12 12 5"></polyline></svg>Back to App</button>
        <button class="btn" id="fullscreen-btn"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 3 21 3 21 9"></polyline><polyline points="9 21 3 21 3 15"></polyline><line x1="21" y1="3" x2="14" y2="10"></line><line x1="3" y1="21" x2="10" y2="14"></line></svg>Fullscreen Learn</button>
        <button class="btn primary" id="auth-btn">Sign in</button>
      </div>
    </div>

    <div class="grid" id="library-grid">
      <aside class="panel">
        <div class="panel-head"><span class="panel-title">Folders</span><div class="actions"><button class="btn" id="new-folder-btn">+ Folder</button><button class="btn danger" id="delete-folder-btn">Delete</button></div></div>
        <div class="panel-body">
          <div class="field search-box"><label>Search</label><input id="search-input" placeholder="Filter packs by title, course or subject"></div>
          <div class="list" id="folder-list"></div>
        </div>
      </aside>
      <section class="panel">
        <div class="panel-head"><span class="panel-title">Study Packs</span><div class="actions"><button class="btn primary" id="create-pack-btn"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>Manually Create Study Pack</button><button class="btn" id="save-pack-btn">Save Changes</button><button class="btn danger" id="delete-pack-btn">Delete Pack</button></div></div>
        <div class="panel-body">
          <div class="pack-summary" id="pack-summary">
            <div class="pack-summary-title" id="pack-summary-title"></div>
            <div class="pack-summary-meta" id="pack-summary-meta"></div>
            <div class="pack-summary-stats">
              <div class="pack-stat"><div class="pack-stat-icon notes-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline></svg></div><span id="pack-stat-notes">Notes</span></div>
              <div class="pack-stat"><div class="pack-stat-icon cards-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="4" width="20" height="16" rx="2"></rect><line x1="2" y1="12" x2="22" y2="12"></line></svg></div><span id="pack-stat-cards">0 flashcards</span></div>
              <div class="pack-stat"><div class="pack-stat-icon test-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"></path><rect x="8" y="2" width="8" height="4" rx="1" ry="1"></rect></svg></div><span id="pack-stat-test">0 questions</span></div>
            </div>
          </div>
          <div class="split">
            <div><div class="list" id="pack-list"></div></div>
            <div>
              <div class="empty" id="pack-empty">Select a study pack to edit and study.</div>
              <div class="editor-wrap" id="pack-editor-wrap">
                <div class="meta-grid">
                  <div class="field"><label>Title</label><input id="pack-title"></div>
                  <div class="field"><label>Folder</label><input type="hidden" id="pack-folder-select" value=""><div class="app-select" id="pack-folder-picker"><button type="button" class="app-select-button" id="pack-folder-button"><span class="app-select-label" id="pack-folder-label">No folder</span><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"></polyline></svg></button><div class="app-select-menu" id="pack-folder-menu"></div></div></div>
                  <div class="field"><label>Course</label><input id="pack-course"></div>
                  <div class="field"><label>Subject</label><input id="pack-subject"></div>
                  <div class="field"><label>Semester</label><input id="pack-semester"></div>
                  <div class="field"><label>Block</label><input id="pack-block"></div>
                </div>
                <div class="actions" style="margin-bottom:14px;">
                  <button class="btn" id="open-builder-btn"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 3h7v7H3z"></path><path d="M14 3h7v7h-7z"></path><path d="M14 14h7v7h-7z"></path><path d="M3 14h7v7H3z"></path></svg>Open Full Editor</button>
                  <button class="btn" id="export-pack-csv-btn"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg><span id="export-csv-label">Export Flashcards CSV</span></button>
                  <button class="btn primary" id="open-learn-btn"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="5 3 19 12 5 21 5 3"></polygon></svg>Learn Mode</button>
                </div>
                <div class="editor-tabs">
                  <button class="editor-tab active" data-editor-pane="notes"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline></svg>Notes</button>
                  <button class="editor-tab" data-editor-pane="flashcards"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="4" width="20" height="16" rx="2"></rect><line x1="2" y1="12" x2="22" y2="12"></line></svg>Flashcards</button>
                  <button class="editor-tab" data-editor-pane="test"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"></path><rect x="8" y="2" width="8" height="4" rx="1" ry="1"></rect></svg>Practice Test</button>
                </div>
                <div class="editor-pane active" id="editor-pane-notes"><div class="notes-view" id="notes-view"></div></div>
                <div class="editor-pane" id="editor-pane-flashcards"><div class="editor-toolbar"><span class="editor-count" id="flashcard-count">0 flashcards</span><button class="btn" id="add-flashcard-btn">+ Add flashcard</button></div><div class="editor-list" id="flashcard-editor-list"></div></div>
                <div class="editor-pane" id="editor-pane-test"><div class="editor-toolbar"><span class="editor-count" id="question-count">0 practice questions</span><button class="btn" id="add-question-btn">+ Add question</button></div><div class="editor-list" id="question-editor-list"></div></div>
              </div>
            </div>
          </div>
        </div>
      </section>
    </div>
  </div>

  <!-- Session Setup -->
  <div class="setup-overlay" id="setup-overlay"><div class="setup-modal">
    <div class="setup-header"><div><div class="setup-title">Session Setup</div><div class="setup-pack-name" id="setup-pack-name"></div></div><button class="btn" id="setup-close-btn"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg></button></div>

    <!-- Setup tabs + panes (hidden when mode picker is shown) -->
    <div id="setup-main-content">
      <div class="setup-tabs" id="setup-tabs">
        <button class="setup-tab active" data-setup-pane="mastery"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M6 9H4.5a2.5 2.5 0 0 1 0-5C5.7 4 7 4.8 8 6c1-1.2 2.3-2 3.5-2a2.5 2.5 0 0 1 0 5H10"></path><path d="M6 9l6 6 6-6"></path></svg>Mastery</button>
        <button class="setup-tab" data-setup-pane="lessons"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="4" width="20" height="16" rx="2"></rect><line x1="2" y1="12" x2="22" y2="12"></line></svg>Lessons</button>
        <button class="setup-tab" data-setup-pane="settings"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-4 0v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83-2.83l.06-.06A1.65 1.65 0 0 0 4.68 15a1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1 0-4h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 2.83-2.83l.06.06A1.65 1.65 0 0 0 9 4.68a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9c.26.6.77 1.05 1.37 1.22H21a2 2 0 0 1 0 4h-.09c-.6.17-1.11.62-1.37 1.22z"></path></svg>Settings</button>
        <button class="setup-tab" data-setup-pane="algorithm"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"></polyline></svg>Algorithm</button>
      </div>
      <div class="setup-pane active" id="setup-pane-mastery"><div class="mastery-section"><div class="mastery-stat"><span>Cards seen:</span> <strong id="mastery-seen">0</strong> / <strong id="mastery-total">0</strong></div><div class="mastery-rings"><div class="mastery-ring"><div class="mastery-ring-circle new-ring" id="mastery-new-pct">100%</div><span class="mastery-ring-label">New</span></div><div class="mastery-ring"><div class="mastery-ring-circle familiar-ring" id="mastery-familiar-pct">0%</div><span class="mastery-ring-label">Familiar</span></div><div class="mastery-ring"><div class="mastery-ring-circle mastered-ring" id="mastery-mastered-pct">0%</div><span class="mastery-ring-label">Mastered</span></div></div></div></div>
      <div class="setup-pane" id="setup-pane-lessons"><p style="text-align:center;color:var(--gray-600);font-size:.9rem;margin-bottom:16px;">Choose which lesson types to include:</p><div class="lesson-grid" id="lesson-grid">
        <div class="lesson-card selected" data-lesson="flashcards" id="lesson-card-flashcards"><div class="lesson-card-check"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg></div><div class="lesson-card-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="4" width="20" height="16" rx="2"></rect><line x1="2" y1="12" x2="22" y2="12"></line></svg></div><div class="lesson-card-title">Zen Cards</div><div class="lesson-card-desc">Distraction-free flashcards</div></div>
        <div class="lesson-card selected" data-lesson="test" id="lesson-card-test"><div class="lesson-card-check"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg></div><div class="lesson-card-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M9 11l3 3L22 4"></path><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"></path></svg></div><div class="lesson-card-title">Multiple Choice</div><div class="lesson-card-desc">Choose your answer from options</div></div>
        <div class="lesson-card" data-lesson="write" id="lesson-card-write"><div class="lesson-card-check"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg></div><div class="lesson-card-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M12 20h9"></path><path d="M16.5 3.5a2.12 2.12 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"></path></svg></div><div class="lesson-card-title">Write</div><div class="lesson-card-desc">Type answers from memory</div></div>
        <div class="lesson-card" data-lesson="match" id="lesson-card-match"><div class="lesson-card-check"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg></div><div class="lesson-card-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="7" height="7"></rect><rect x="14" y="3" width="7" height="7"></rect><rect x="3" y="14" width="7" height="7"></rect><rect x="14" y="14" width="7" height="7"></rect></svg></div><div class="lesson-card-title">Match</div><div class="lesson-card-desc">Pair terms with definitions</div><div class="lesson-card-badge" id="match-min-badge" style="display:none">Needs 6+ cards</div></div>
      </div></div>
      <div class="setup-pane" id="setup-pane-settings"><div class="settings-list" id="settings-list">
        <div class="setting-row" data-setting="swapAnswerQuestion"><span class="setting-label">Swap answer and question</span><div class="setting-toggle"></div></div>
        <div class="setting-row" data-setting="randomSwap"><span class="setting-label">Randomly swap answer and question</span><div class="setting-toggle"></div></div>
        <div class="setting-row" data-setting="caseSensitive"><span class="setting-label">Case sensitive</span><div class="setting-toggle"></div></div>
        <div class="setting-row" data-setting="forceExactMatch"><span class="setting-label">Force exact matches</span><div class="setting-toggle"></div></div>
        <div class="setting-row active" data-setting="addMissedToReview"><span class="setting-label">Add missed terms to review list</span><div class="setting-toggle"></div></div>
        <div class="setting-row" data-setting="ignoreArticles"><span class="setting-label">Ignore articles (a, an, the)</span><div class="setting-toggle"></div></div>
        <div class="setting-row" data-setting="ignoreDeterminers"><span class="setting-label">Ignore determiners (; , /)</span><div class="setting-toggle"></div></div>
        <div class="setting-row" data-setting="ignoreBrackets"><span class="setting-label">Ignore () and []</span><div class="setting-toggle"></div></div>
      </div></div>
      <div class="setup-pane" id="setup-pane-algorithm"><p style="text-align:center;color:var(--gray-600);font-size:.9rem;margin-bottom:16px;">Adjust how cards are selected for review:</p><div class="algo-lane" id="algo-lane"></div><div class="algo-presets" id="algo-presets"><button class="algo-preset active" data-preset="balanced">Balanced</button><button class="algo-preset" data-preset="random">All Random</button><button class="algo-preset" data-preset="lastminute">Last Minute Overview</button><button class="algo-preset" data-preset="fixmistakes">Fix Mistakes</button></div></div>
      <button class="btn cta" id="setup-start-btn" style="margin-top:8px;"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="5 3 19 12 5 21 5 3"></polygon></svg>Start Session</button>
    </div>

    <!-- Mode picker (shown when multiple lessons enabled) -->
    <div class="mode-picker" id="mode-picker">
      <div class="mode-picker-title">Choose your study mode</div>
      <div class="mode-picker-grid" id="mode-picker-grid"></div>
      <div class="actions" style="justify-content:center;margin-top:16px;">
        <button class="btn" id="mode-picker-back"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 5 12 12 5"></polyline></svg>Back to Setup</button>
      </div>
    </div>
  </div></div>

  <!-- Learn Stage (focused single-mode) -->
  <div class="learn-stage" id="learn-stage"><div class="learn-shell">
    <div class="learn-top">
      <div class="learn-top-left"><div><div class="learn-title" id="learn-title">Learn Mode</div><div class="learn-sub" id="learn-sub">Focused study session</div></div></div>
      <div class="learn-progress-center"><div class="learn-progress-bar"><div class="learn-progress-fill" id="learn-progress-fill" style="width:0%"></div></div><span class="learn-progress-text" id="learn-progress-text">0/0</span></div>
      <div class="actions">
        <button class="btn" id="learn-back-app-btn"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 5 12 12 5"></polyline></svg>App</button>
        <button class="btn" id="learn-back-library-btn"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"></path><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"></path></svg>Library</button>
        <button class="btn" id="learn-fullscreen-btn"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 3 21 3 21 9"></polyline><polyline points="9 21 3 21 3 15"></polyline><line x1="21" y1="3" x2="14" y2="10"></line><line x1="3" y1="21" x2="10" y2="14"></line></svg></button>
      </div>
    </div>
    <div class="learn-body"><div class="learn-card">
      <div class="learn-mode-label" id="learn-mode-label"></div>

      <!-- Flashcards pane -->
      <div class="learn-pane" id="learn-pane-flashcards"><div class="flashcard-stage"><div class="flashcard-3d" id="learn-flashcard-3d"><div class="flashcard-inner" id="learn-flashcard-inner"><div class="flashcard-face front"><span class="flashcard-label">Front</span><div class="flashcard-text" id="learn-flashcard-front"></div></div><div class="flashcard-face back"><span class="flashcard-label">Back</span><div class="flashcard-text" id="learn-flashcard-back"></div></div></div></div><div class="learn-controls"><button class="btn" id="learn-f-prev">Previous</button><button class="btn" id="learn-f-flip">Flip</button><button class="btn" id="learn-f-next">Next</button><span class="learn-progress-fc" id="learn-f-progress">Card 0 of 0</span></div><div class="keyboard-hints"><span><span class="kbd">&larr;</span> Previous</span><span><span class="kbd">Space</span> Flip</span><span><span class="kbd">&rarr;</span> Next</span></div></div></div>

      <!-- Test pane -->
      <div class="learn-pane" id="learn-pane-test"><div class="quiz-head"><span id="learn-q-progress">Question 0 of 0</span><span id="learn-q-score">Score: 0/0</span></div><div class="quiz-question" id="learn-q-text"></div><div class="quiz-options" id="learn-q-options"></div><div class="quiz-expl" id="learn-q-expl"></div><div class="actions" style="margin-top:12px;"><button class="btn primary" id="learn-q-next">Next question</button></div></div>

      <!-- Write pane -->
      <div class="learn-pane" id="learn-pane-write"><div class="write-stage">
        <div class="write-prompt" id="write-prompt"></div>
        <div class="write-input-row"><input type="text" class="write-input" id="write-input" placeholder="Type your answer..." autocomplete="off"><button class="btn primary" id="write-check-btn">Check</button><button class="btn" id="write-reveal-btn">Reveal</button></div>
        <div class="write-feedback" id="write-feedback"></div>
        <div class="learn-controls"><button class="btn primary" id="write-next-btn">Next</button><span class="learn-progress-fc" id="write-progress">0 / 0</span></div>
      </div></div>

      <!-- Match pane -->
      <div class="learn-pane" id="learn-pane-match"><div class="match-stage">
        <div class="match-timer" id="match-timer">0.0s</div>
        <div class="match-grid" id="match-grid"></div>
        <div class="match-results" id="match-results" style="display:none">
          <div class="match-results-time" id="match-results-time"></div>
          <div class="match-results-badge" id="match-results-badge"></div>
          <div class="match-results-history" id="match-results-history"></div>
          <div class="actions" style="justify-content:center;margin-top:16px;"><button class="btn primary" id="match-play-again">Play Again</button></div>
        </div>
      </div></div>

      <!-- Notes pane (fallback) -->
      <div class="learn-pane" id="learn-pane-notes"><div class="learn-notes" id="learn-notes-content"></div></div>
    </div></div>
  </div></div>

  <!-- Fullscreen Pack Builder -->
  <div class="builder-overlay" id="builder-overlay">
    <div class="builder-shell">
      <aside class="builder-rail">
        <div class="builder-brand"><h2>Study Library<br>Pack Builder</h2><p id="builder-brand-sub">Create and refine your study pack</p></div>
        <div class="builder-top-actions">
          <button class="btn primary" id="builder-save-btn"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path><polyline points="17 21 17 13 7 13 7 21"></polyline><polyline points="7 3 7 8 15 8"></polyline></svg>Save Pack</button>
          <div class="builder-duo">
            <button class="btn" id="builder-exit-btn">Exit</button>
            <button class="btn" id="builder-share-btn" disabled>Share</button>
          </div>
        </div>
        <div class="builder-nav">
          <button class="builder-nav-btn active" data-builder-pane="info"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="16" x2="12" y2="12"></line><line x1="12" y1="8" x2="12.01" y2="8"></line></svg>Deck Info</button>
          <button class="builder-nav-btn" data-builder-pane="flashcards"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="4" width="20" height="16" rx="2"></rect><line x1="2" y1="12" x2="22" y2="12"></line></svg>Flashcards</button>
          <button class="builder-nav-btn" data-builder-pane="test"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 11l3 3L22 4"></path><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"></path></svg>Practice Test</button>
          <button class="builder-nav-btn" data-builder-pane="import"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" y1="3" x2="12" y2="15"></line></svg>Import CSV</button>
        </div>
        <div class="builder-mini-stats">
          <div class="builder-stat">Cards: <strong id="builder-stat-cards">0</strong></div>
          <div class="builder-stat">Questions: <strong id="builder-stat-questions">0</strong></div>
          <div class="builder-stat">Unsaved: <strong id="builder-stat-dirty">No</strong></div>
        </div>
      </aside>
      <main class="builder-main">
        <div class="builder-main-inner">
          <div class="builder-headline">
            <div><div class="builder-title" id="builder-title">Build Your Pack</div><div class="builder-sub" id="builder-sub">Fullscreen editing for fast manual creation</div></div>
            <div class="builder-helper" id="builder-summary">0 cards ¬∑ 0 questions</div>
          </div>

          <section class="builder-pane active" id="builder-pane-info">
            <div class="builder-card">
              <div class="builder-info-banner"><span>Configure title, folder, metadata, and notes before learning.</span><button class="btn" id="builder-open-learn-shortcut">Open Learn Setup</button></div>
              <div class="builder-grid">
                <div class="field"><label>Title</label><input id="builder-title-input" placeholder="Untitled pack"></div>
                <div class="field"><label>Folder</label><select id="builder-folder-select" class="builder-select"></select></div>
                <div class="field"><label>Course</label><input id="builder-course-input"></div>
                <div class="field"><label>Subject</label><input id="builder-subject-input"></div>
                <div class="field"><label>Semester</label><input id="builder-semester-input"></div>
                <div class="field"><label>Block</label><input id="builder-block-input"></div>
              </div>
              <div class="field" style="margin-top:12px;"><label>Notes (Markdown)</label><textarea id="builder-notes-input" style="min-height:180px" placeholder="# Key Concepts&#10;&#10;- Add summary notes here"></textarea></div>
            </div>
          </section>

          <section class="builder-pane" id="builder-pane-flashcards">
            <div class="builder-card">
              <div class="builder-cta-strip"><button class="btn primary" id="builder-add-card-btn">+ Add Flashcard</button><button class="btn" id="builder-add-card-batch-btn">+ Add 5</button></div>
              <div class="builder-list" id="builder-flashcard-list"></div>
            </div>
          </section>

          <section class="builder-pane" id="builder-pane-test">
            <div class="builder-card">
              <div class="builder-cta-strip"><button class="btn primary" id="builder-add-question-btn">+ Add Question</button><button class="btn" id="builder-add-question-batch-btn">+ Add 3</button></div>
              <div class="builder-list" id="builder-question-list"></div>
            </div>
          </section>

          <section class="builder-pane" id="builder-pane-import">
            <div class="builder-card">
              <div class="builder-helper" style="margin-bottom:8px">Import data directly into this pack and preview before applying.</div>
              <div class="builder-import-tools">
                <div class="field"><label>Import Type</label><select class="builder-select" id="builder-import-type"><option value="flashcards">Flashcards CSV</option><option value="test">Practice Test CSV</option></select></div>
                <div class="field"><label>Import Mode</label><select class="builder-select" id="builder-import-mode"><option value="append">Append to existing</option><option value="replace">Replace existing</option></select></div>
              </div>
              <div class="builder-drop" id="builder-csv-drop"><strong>Drag a CSV file here</strong><div class="builder-helper">or click to browse</div><input type="file" id="builder-csv-input" accept=".csv,text/csv" style="display:none"></div>
              <div class="builder-cta-strip" style="margin-top:12px"><button class="btn" id="builder-template-btn">Download CSV Template</button><button class="btn primary" id="builder-apply-import-btn" disabled>Apply Import</button></div>
              <div class="builder-helper" id="builder-import-summary">No file loaded.</div>
              <div class="builder-preview" id="builder-preview" style="display:none">
                <div class="builder-preview-head">Preview (first 10 valid rows)</div>
                <div style="overflow:auto"><table class="builder-preview-table" id="builder-preview-table"></table></div>
              </div>
              <div class="builder-errors" id="builder-import-errors" style="display:none"></div>
            </div>
          </section>
        </div>
      </main>
    </div>
  </div>

  <!-- Builder unsaved exit modal -->
  <div class="modal-overlay builder-exit-modal" id="builder-exit-overlay">
    <div class="modal">
      <div class="builder-exit-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><path d="M9.09 9a3 3 0 0 1 5.82 1c0 2-3 3-3 3"></path><line x1="12" y1="17" x2="12.01" y2="17"></line></svg></div>
      <div class="modal-title" style="text-align:center;margin-bottom:6px">Save Changes?</div>
      <p class="modal-message" style="text-align:center">You have unsaved builder changes. Do you want to save before leaving?</p>
      <div class="actions" style="justify-content:center">
        <button class="btn primary" id="builder-exit-save">Save</button>
        <button class="btn danger" id="builder-exit-discard">Don't Save</button>
        <button class="btn" id="builder-exit-cancel">Cancel</button>
      </div>
    </div>
  </div>

  <!-- Folder Modal -->
  <div class="modal-overlay" id="folder-modal-overlay"><div class="modal"><div class="modal-head"><span class="modal-title" id="folder-modal-title">New Folder</span><button class="btn" id="folder-modal-close"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg></button></div><div class="modal-grid" style="margin-bottom:14px;"><div class="field"><label>Folder Name *</label><input id="folder-name-input"></div><div class="field"><label>Course</label><input id="folder-course-input"></div><div class="field"><label>Subject</label><input id="folder-subject-input"></div><div class="field"><label>Semester</label><input id="folder-semester-input"></div><div class="field"><label>Block</label><input id="folder-block-input"></div></div><div class="actions" style="justify-content:flex-end;"><button class="btn" id="folder-modal-cancel">Cancel</button><button class="btn primary" id="folder-modal-save">Save Folder</button></div></div></div>

  <!-- Confirm Modal -->
  <div class="modal-overlay" id="confirm-modal-overlay"><div class="modal"><div class="modal-head"><span class="modal-title" id="confirm-modal-title">Confirm Action</span><button class="btn" id="confirm-modal-close"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg></button></div><p class="modal-message" id="confirm-modal-message"></p><div class="actions" style="justify-content:flex-end;"><button class="btn" id="confirm-modal-cancel">Cancel</button><button class="btn danger" id="confirm-modal-confirm">Delete</button></div></div></div>

  <div class="toast" id="toast"></div>
<script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth-compat.js"></script>
  <script>
    const firebaseConfig={apiKey:"AIzaSyBAAeEUCPNvP5qnqpP3M6HnFZ6vaaijUvM",authDomain:"lecture-processor-cdff6.firebaseapp.com",projectId:"lecture-processor-cdff6",storageBucket:"lecture-processor-cdff6.firebasestorage.app",messagingSenderId:"374793454161",appId:"1:374793454161:web:c68b21590e9a1fafa32e70"};
    firebase.initializeApp(firebaseConfig);
    const auth=firebase.auth();

    /* ‚îÄ‚îÄ State ‚îÄ‚îÄ */
    let token=null,folders=[],packs=[],selectedFolderId='',selectedPackId='',selectedPack=null;
    let activeEditorPane='notes',exportType='flashcards',draggedPackId='';
    let folderModalMode='create',editingFolderId='',pendingOpenPackId='',confirmModalResolver=null;
    let builderDraft=null,builderMode='edit',builderPane='info',builderDirty=false,builderPackId='',builderExitResolver=null,builderImportParsed=null;
    let learnFlashcardIndex=0,learnFlashcardFlipped=false,learnQuestionIndex=0,learnScore=0,learnAnswered=false;
    let activeLearnMode=''; // 'flashcards','test','write','match','notes'
    let orderedFlashcards=[];
    const urlParams=new URLSearchParams(window.location.search);
    const learnPackFromUrl=urlParams.get('pack_id')||'';
    const openLearnFromUrl=urlParams.get('mode')==='learn';
    const fullscreenFromUrl=urlParams.get('fullscreen')==='1';
    const focusFromUrl=urlParams.get('focus')||'';
    let autoLearnConsumed=false;

    /* Write mode state */
    let writeIndex=0,writeRevealed=false,writeChecked=false,writePromptSwapped=false;

    /* Match mode state */
    let matchCards=[],matchSelected=null,matchMatched=0,matchTotal=0;
    let matchTimerInterval=null,matchStartTime=0,matchElapsed=0,matchRunning=false;
    const MATCH_MIN_CARDS=6;

    /* ‚îÄ‚îÄ Session state ‚îÄ‚îÄ */
    const ALGO_PRESETS={balanced:['new','new','familiar','retry','remaster'],random:['random','random','random','random','random'],lastminute:['new','new','new','new','retry'],fixmistakes:['new','retry','new','retry','retry']};
    const ALGO_TYPES=['new','familiar','retry','remaster','random'];
    const ALGO_ICONS={
      new:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="5" y="2" width="14" height="20" rx="2"></rect><line x1="12" y1="18" x2="12.01" y2="18"></line></svg>',
      familiar:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path></svg>',
      retry:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="23 4 23 10 17 10"></polyline><path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"></path></svg>',
      remaster:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 9H4.5a2.5 2.5 0 0 1 0-5C5.7 4 7 4.8 8 6c1-1.2 2.3-2 3.5-2a2.5 2.5 0 0 1 0 5H10"></path><path d="M6 9l6 6 6-6"></path></svg>',
      random:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="16 3 21 3 21 8"></polyline><line x1="4" y1="20" x2="21" y2="3"></line><polyline points="21 16 21 21 16 21"></polyline><line x1="15" y1="15" x2="21" y2="21"></line><line x1="4" y1="4" x2="9" y2="9"></line></svg>'
    };
    const MODE_ICONS={
      flashcards:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="4" width="20" height="16" rx="2"></rect><line x1="2" y1="12" x2="22" y2="12"></line></svg>',
      test:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M9 11l3 3L22 4"></path><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"></path></svg>',
      write:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M12 20h9"></path><path d="M16.5 3.5a2.12 2.12 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"></path></svg>',
      match:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="7" height="7"></rect><rect x="14" y="3" width="7" height="7"></rect><rect x="3" y="14" width="7" height="7"></rect><rect x="14" y="14" width="7" height="7"></rect></svg>'
    };
    const MODE_NAMES={flashcards:'Zen Cards',test:'Multiple Choice',write:'Write',match:'Match'};
    const MODE_DESCS={flashcards:'Flip through cards at your pace',test:'Answer multiple choice questions',write:'Type answers from memory',match:'Pair terms with definitions'};

    let sessionSettings={swapAnswerQuestion:false,randomSwap:false,caseSensitive:false,forceExactMatch:false,addMissedToReview:true,ignoreArticles:false,ignoreDeterminers:false,ignoreBrackets:false};
    let sessionAlgo=['new','new','familiar','retry','remaster'],sessionAlgoPreset='balanced';
    let sessionLessons={flashcards:true,test:true,write:false,match:false};
    let activeSetupPane='mastery';

    /* ‚îÄ‚îÄ Card mastery (localStorage) ‚îÄ‚îÄ */
    function getCardStateKey(){return'card_state_'+(auth.currentUser?auth.currentUser.uid:'anon')+'_'+selectedPackId;}
    function loadCardState(){try{return JSON.parse(localStorage.getItem(getCardStateKey()))||{};}catch(e){return{};}}
    function saveCardState(s){try{localStorage.setItem(getCardStateKey(),JSON.stringify(s));}catch(e){}}
    function markCardSeen(cardId,correct){
      var s=loadCardState();
      if(!s[cardId]){s[cardId]={seen:0,correct:0,wrong:0,level:'new'};}
      s[cardId].seen++;
      if(correct){s[cardId].correct++;}else{s[cardId].wrong++;}
      if(s[cardId].correct>=3){s[cardId].level='mastered';}
      else if(s[cardId].seen>=1){s[cardId].level='familiar';}
      saveCardState(s);
    }

    /* ‚îÄ‚îÄ Match high scores (localStorage) ‚îÄ‚îÄ */
    function getMatchScoreKey(){return'match_scores_'+(auth.currentUser?auth.currentUser.uid:'anon')+'_'+selectedPackId;}
    function loadMatchScores(){try{return JSON.parse(localStorage.getItem(getMatchScoreKey()))||[];}catch(e){return[];}}
    function saveMatchScore(timeMs){
      var scores=loadMatchScores();
      scores.push(timeMs);
      scores.sort(function(a,b){return a-b;});
      if(scores.length>10){scores=scores.slice(0,10);}
      try{localStorage.setItem(getMatchScoreKey(),JSON.stringify(scores));}catch(e){}
      return scores;
    }
    function getScoreRank(scores,timeMs){
      for(var i=0;i<scores.length;i++){
        if(scores[i]===timeMs){return i+1;}
      }
      return scores.length;
    }

    function getSessionStorageKey(){return'study_session_'+(auth.currentUser?auth.currentUser.uid:'anon')+'_'+selectedPackId;}
    function loadSessionState(){
      try{
        var r=localStorage.getItem(getSessionStorageKey());
        if(!r)return;
        var d=JSON.parse(r);
        if(d.settings){sessionSettings=Object.assign({},sessionSettings,d.settings);}
        if(d.algo&&Array.isArray(d.algo)&&d.algo.length===5){sessionAlgo=d.algo;}
        if(d.algoPreset){sessionAlgoPreset=d.algoPreset;}
        if(d.lessons){sessionLessons=Object.assign({},sessionLessons,d.lessons);}
      }catch(e){}
    }
    function saveSessionState(){
      try{localStorage.setItem(getSessionStorageKey(),JSON.stringify({settings:sessionSettings,algo:sessionAlgo,algoPreset:sessionAlgoPreset,lessons:sessionLessons}));}catch(e){}
    }

    /* ‚îÄ‚îÄ Algorithm ordering ‚îÄ‚îÄ */
    function orderCardsByAlgo(cards){
      if(!cards||!cards.length)return cards;
      var state=loadCardState();
      var buckets={new:[],familiar:[],retry:[],remaster:[],random:[]};
      cards.forEach(function(c,i){
        var id='fc_'+i;var cs=state[id];
        if(!cs||cs.level==='new'){buckets.new.push({card:c,idx:i});}
        else if(cs.level==='familiar'){buckets.familiar.push({card:c,idx:i});}
        else if(cs.level==='mastered'){buckets.remaster.push({card:c,idx:i});}
        if(cs&&cs.wrong>0){buckets.retry.push({card:c,idx:i});}
        buckets.random.push({card:c,idx:i});
      });
      Object.keys(buckets).forEach(function(k){buckets[k].sort(function(){return Math.random()-0.5;});});
      var result=[],used={};
      sessionAlgo.forEach(function(type){
        var pool=buckets[type]||buckets.random;
        for(var j=0;j<pool.length;j++){
          if(!used[pool[j].idx]){result.push(pool[j]);used[pool[j].idx]=true;break;}
        }
      });
      cards.forEach(function(c,i){if(!used[i])result.push({card:c,idx:i});});
      return result.map(function(r){return r.card;});
    }

    /* ‚îÄ‚îÄ Answer grading (for write mode) ‚îÄ‚îÄ */
    function normalizeAnswer(str){
      var s=str.trim();
      if(!sessionSettings.caseSensitive){s=s.toLowerCase();}
      if(sessionSettings.ignoreBrackets){s=s.replace(/\([^)]*\)/g,'').replace(/\[[^\]]*\]/g,'');}
      if(sessionSettings.ignoreArticles){s=s.replace(/\b(a|an|the)\b/gi,'');}
      if(sessionSettings.ignoreDeterminers){s=s.replace(/[;,\/]/g,'');}
      s=s.replace(/\s+/g,' ').trim();
      return s;
    }
    function gradeAnswer(userAnswer,correctAnswer){
      var ua=normalizeAnswer(userAnswer);
      var ca=normalizeAnswer(correctAnswer);
      if(sessionSettings.forceExactMatch){return ua===ca;}
      return ua===ca;
    }

    /* ‚îÄ‚îÄ DOM refs ‚îÄ‚îÄ */
    var userMeta=document.getElementById('user-meta'),authBtn=document.getElementById('auth-btn'),backAppBtn=document.getElementById('back-app-btn'),fullscreenBtn=document.getElementById('fullscreen-btn');
    var searchInput=document.getElementById('search-input'),folderList=document.getElementById('folder-list'),packList=document.getElementById('pack-list'),newFolderBtn=document.getElementById('new-folder-btn'),deleteFolderBtn=document.getElementById('delete-folder-btn');
    var packEmpty=document.getElementById('pack-empty'),packEditorWrap=document.getElementById('pack-editor-wrap'),packTitle=document.getElementById('pack-title'),packFolderSelect=document.getElementById('pack-folder-select'),packFolderPicker=document.getElementById('pack-folder-picker'),packFolderButton=document.getElementById('pack-folder-button'),packFolderLabel=document.getElementById('pack-folder-label'),packFolderMenu=document.getElementById('pack-folder-menu');
    var packCourse=document.getElementById('pack-course'),packSubject=document.getElementById('pack-subject'),packSemester=document.getElementById('pack-semester'),packBlock=document.getElementById('pack-block'),notesView=document.getElementById('notes-view');
    var packSummary=document.getElementById('pack-summary'),packSummaryTitle=document.getElementById('pack-summary-title'),packSummaryMeta=document.getElementById('pack-summary-meta'),packStatNotes=document.getElementById('pack-stat-notes'),packStatCards=document.getElementById('pack-stat-cards'),packStatTest=document.getElementById('pack-stat-test');
    var createPackBtn=document.getElementById('create-pack-btn'),openBuilderBtn=document.getElementById('open-builder-btn'),savePackBtn=document.getElementById('save-pack-btn'),deletePackBtn=document.getElementById('delete-pack-btn'),exportPackCsvBtn=document.getElementById('export-pack-csv-btn'),exportCsvLabel=document.getElementById('export-csv-label'),openLearnBtn=document.getElementById('open-learn-btn');
    var editorTabs=document.querySelectorAll('.editor-tab'),flashcardCount=document.getElementById('flashcard-count'),questionCount=document.getElementById('question-count'),addFlashcardBtn=document.getElementById('add-flashcard-btn'),addQuestionBtn=document.getElementById('add-question-btn'),flashcardEditorList=document.getElementById('flashcard-editor-list'),questionEditorList=document.getElementById('question-editor-list');
    var learnStage=document.getElementById('learn-stage'),learnTitle=document.getElementById('learn-title'),learnSub=document.getElementById('learn-sub'),learnBackAppBtn=document.getElementById('learn-back-app-btn'),learnBackLibraryBtn=document.getElementById('learn-back-library-btn'),learnFullscreenBtn=document.getElementById('learn-fullscreen-btn');
    var learnModeLabel=document.getElementById('learn-mode-label');
    var learnFlashcard3d=document.getElementById('learn-flashcard-3d'),learnFlashcardInner=document.getElementById('learn-flashcard-inner'),learnFlashcardFront=document.getElementById('learn-flashcard-front'),learnFlashcardBack=document.getElementById('learn-flashcard-back');
    var learnFPrev=document.getElementById('learn-f-prev'),learnFFlip=document.getElementById('learn-f-flip'),learnFNext=document.getElementById('learn-f-next'),learnFProgress=document.getElementById('learn-f-progress');
    var learnProgressFill=document.getElementById('learn-progress-fill'),learnProgressText=document.getElementById('learn-progress-text');
    var learnQProgress=document.getElementById('learn-q-progress'),learnQScore=document.getElementById('learn-q-score'),learnQText=document.getElementById('learn-q-text'),learnQOptions=document.getElementById('learn-q-options'),learnQExpl=document.getElementById('learn-q-expl'),learnQNext=document.getElementById('learn-q-next');
    var writePromptEl=document.getElementById('write-prompt'),writeInputEl=document.getElementById('write-input'),writeCheckBtn=document.getElementById('write-check-btn'),writeRevealBtn=document.getElementById('write-reveal-btn'),writeFeedbackEl=document.getElementById('write-feedback'),writeNextBtn=document.getElementById('write-next-btn'),writeProgressEl=document.getElementById('write-progress');
    var matchGridEl=document.getElementById('match-grid'),matchTimerEl=document.getElementById('match-timer'),matchResultsEl=document.getElementById('match-results'),matchResultsTime=document.getElementById('match-results-time'),matchResultsBadge=document.getElementById('match-results-badge'),matchResultsHistory=document.getElementById('match-results-history'),matchPlayAgainBtn=document.getElementById('match-play-again');
    var setupOverlay=document.getElementById('setup-overlay'),setupPackName=document.getElementById('setup-pack-name'),setupCloseBtn=document.getElementById('setup-close-btn'),setupStartBtn=document.getElementById('setup-start-btn'),setupMainContent=document.getElementById('setup-main-content'),setupTabs=document.querySelectorAll('.setup-tab'),algoLane=document.getElementById('algo-lane'),algoPresets=document.querySelectorAll('.algo-preset');
    var modePicker=document.getElementById('mode-picker'),modePickerGrid=document.getElementById('mode-picker-grid'),modePickerBack=document.getElementById('mode-picker-back');
    var builderOverlay=document.getElementById('builder-overlay'),builderBrandSub=document.getElementById('builder-brand-sub'),builderSaveBtn=document.getElementById('builder-save-btn'),builderExitBtn=document.getElementById('builder-exit-btn'),builderShareBtn=document.getElementById('builder-share-btn'),builderTitleEl=document.getElementById('builder-title'),builderSubEl=document.getElementById('builder-sub'),builderSummary=document.getElementById('builder-summary'),builderOpenLearnShortcut=document.getElementById('builder-open-learn-shortcut');
    var builderPaneButtons=document.querySelectorAll('.builder-nav-btn[data-builder-pane]'),builderStatCards=document.getElementById('builder-stat-cards'),builderStatQuestions=document.getElementById('builder-stat-questions'),builderStatDirty=document.getElementById('builder-stat-dirty');
    var builderTitleInput=document.getElementById('builder-title-input'),builderFolderSelect=document.getElementById('builder-folder-select'),builderCourseInput=document.getElementById('builder-course-input'),builderSubjectInput=document.getElementById('builder-subject-input'),builderSemesterInput=document.getElementById('builder-semester-input'),builderBlockInput=document.getElementById('builder-block-input'),builderNotesInput=document.getElementById('builder-notes-input');
    var builderFlashcardList=document.getElementById('builder-flashcard-list'),builderQuestionList=document.getElementById('builder-question-list'),builderAddCardBtn=document.getElementById('builder-add-card-btn'),builderAddCardBatchBtn=document.getElementById('builder-add-card-batch-btn'),builderAddQuestionBtn=document.getElementById('builder-add-question-btn'),builderAddQuestionBatchBtn=document.getElementById('builder-add-question-batch-btn');
    var builderImportType=document.getElementById('builder-import-type'),builderImportMode=document.getElementById('builder-import-mode'),builderCsvDrop=document.getElementById('builder-csv-drop'),builderCsvInput=document.getElementById('builder-csv-input'),builderTemplateBtn=document.getElementById('builder-template-btn'),builderApplyImportBtn=document.getElementById('builder-apply-import-btn'),builderImportSummary=document.getElementById('builder-import-summary'),builderPreview=document.getElementById('builder-preview'),builderPreviewTable=document.getElementById('builder-preview-table'),builderImportErrors=document.getElementById('builder-import-errors');
    var builderExitOverlay=document.getElementById('builder-exit-overlay'),builderExitSave=document.getElementById('builder-exit-save'),builderExitDiscard=document.getElementById('builder-exit-discard'),builderExitCancel=document.getElementById('builder-exit-cancel');
    var learnNotesContent=document.getElementById('learn-notes-content');
    var folderModalOverlay=document.getElementById('folder-modal-overlay'),folderModalTitle=document.getElementById('folder-modal-title'),folderModalClose=document.getElementById('folder-modal-close'),folderModalCancel=document.getElementById('folder-modal-cancel'),folderModalSave=document.getElementById('folder-modal-save'),folderNameInput=document.getElementById('folder-name-input'),folderCourseInput=document.getElementById('folder-course-input'),folderSubjectInput=document.getElementById('folder-subject-input'),folderSemesterInput=document.getElementById('folder-semester-input'),folderBlockInput=document.getElementById('folder-block-input');
    var confirmModalOverlay=document.getElementById('confirm-modal-overlay'),confirmModalTitle=document.getElementById('confirm-modal-title'),confirmModalMessage=document.getElementById('confirm-modal-message'),confirmModalClose=document.getElementById('confirm-modal-close'),confirmModalCancel=document.getElementById('confirm-modal-cancel'),confirmModalConfirm=document.getElementById('confirm-modal-confirm');
    var toastEl=document.getElementById('toast');

    /* ‚îÄ‚îÄ Helpers ‚îÄ‚îÄ */
    function showToast(msg,type){toastEl.textContent=msg;toastEl.className='toast visible '+(type||'success');setTimeout(function(){toastEl.classList.remove('visible');},2800);}
    function mdToHtml(md){if(!md)return'';var h=md.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/^### (.*$)/gm,'<h3>$1</h3>').replace(/^## (.*$)/gm,'<h2>$1</h2>').replace(/^# (.*$)/gm,'<h1>$1</h1>').replace(/\*\*\*(.*?)\*\*\*/g,'<strong><em>$1</em></strong>').replace(/\*\*(.*?)\*\*/g,'<strong>$1</strong>').replace(/\*(.*?)\*/g,'<em>$1</em>').replace(/^\s*[-*]\s+(.*$)/gm,'<li>$1</li>').replace(/\n\n/g,'</p><p>').replace(/\n/g,'<br>');h='<p>'+h+'</p>';h=h.replace(/(<li>.*?<\/li>)(?=\s*<li>|<br><li>)/g,'$1').replace(/(<li>.*?<\/li>)+/g,'<ul>$&</ul>').replace(/<br><li>/g,'<li>');h=h.replace(/<p><\/p>/g,'').replace(/<p>(<h[1-3]>)/g,'$1').replace(/(<\/h[1-3]>)<\/p>/g,'$1').replace(/<p>(<ul>)/g,'$1').replace(/(<\/ul>)<\/p>/g,'$1');return h;}

    function apiCall(path,options){
      var opts=options||{};
      var headers=opts.headers||{};
      headers['Authorization']='Bearer '+token;
      if(opts.body&&!headers['Content-Type']){headers['Content-Type']='application/json';}
      return fetch(path,Object.assign({},opts,{headers:headers})).then(function(res){
        var isJson=(res.headers.get('content-type')||'').indexOf('application/json')>=0;
        return(isJson?res.json():Promise.resolve(null)).then(function(data){
          if(!res.ok){throw new Error((data&&data.error)||'Request failed');}
          return data;
        });
      });
    }
    function authenticatedFetch(path,options,allowRefresh){
      if(!auth.currentUser){return Promise.reject(new Error('Please sign in'));}
      if(!token){return auth.currentUser.getIdToken().then(function(t){token=t;return authenticatedFetch(path,options,allowRefresh);});}
      var opts=options||{};
      var headers=Object.assign({},opts.headers||{},{Authorization:'Bearer '+token});
      return fetch(path,Object.assign({},opts,{headers:headers})).then(function(response){
        if(response.status===401&&allowRefresh!==false){
          return auth.currentUser.getIdToken(true).then(function(t){token=t;return authenticatedFetch(path,options,false);});
        }
        return response;
      });
    }
    function parseFilenameFromDisposition(d,f){if(!d)return f;var u=d.match(/filename\*=UTF-8''([^;]+)/i);if(u&&u[1])return decodeURIComponent(u[1].trim());var a=d.match(/filename="?([^";]+)"?/i);if(a&&a[1])return a[1].trim();return f;}
    function downloadStudyPackCsv(packId,type){
      var fallback=type==='test'?'study-pack-'+packId+'-practice-test.csv':'study-pack-'+packId+'-flashcards.csv';
      return authenticatedFetch('/api/study-packs/'+encodeURIComponent(packId)+'/export-flashcards-csv?type='+encodeURIComponent(type)).then(function(r){
        if(!r.ok){return r.json().catch(function(){return{};}).then(function(d){throw new Error(d.error||'Could not export CSV');});}
        return r.blob().then(function(blob){
          var fn=parseFilenameFromDisposition(r.headers.get('content-disposition')||'',fallback);
          var url=URL.createObjectURL(blob);var anchor=document.createElement('a');anchor.href=url;anchor.download=fn;document.body.appendChild(anchor);anchor.click();document.body.removeChild(anchor);URL.revokeObjectURL(url);
        });
      });
    }
    function openModal(ov){ov.classList.add('entering');requestAnimationFrame(function(){requestAnimationFrame(function(){ov.classList.replace('entering','visible');});});}
    function closeModal(ov){ov.classList.remove('visible');}
    function openConfirmModal(title,message,confirmLabel){confirmModalTitle.textContent=title;confirmModalMessage.textContent=message;confirmModalConfirm.textContent=confirmLabel||'Delete';openModal(confirmModalOverlay);return new Promise(function(r){confirmModalResolver=r;});}
    function closeConfirmModal(c){closeModal(confirmModalOverlay);if(confirmModalResolver){confirmModalResolver(Boolean(c));confirmModalResolver=null;}}

    /* ‚îÄ‚îÄ Fullscreen Pack Builder ‚îÄ‚îÄ */
    function escapeHtml(v){
      return String(v||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
    }
    function createDefaultQuestion(){
      return normalizeQuestion({
        question:'New question',
        options:['Option A','Option B','Option C','Option D'],
        answer:'Option A',
        explanation:''
      });
    }
    function buildDraftFromPack(pack){
      var source=pack||{};
      return {
        title:source.title||'',
        folder_id:source.folder_id||'',
        course:source.course||'',
        subject:source.subject||'',
        semester:source.semester||'',
        block:source.block||'',
        notes_markdown:source.notes_markdown||'',
        flashcards:(source.flashcards||[]).map(function(card){
          return {front:card.front||'',back:card.back||''};
        }),
        test_questions:(source.test_questions||[]).map(function(q){
          return normalizeQuestion(q);
        })
      };
    }
    function markBuilderDirty(value){
      builderDirty=(value!==false);
      builderStatDirty.textContent=builderDirty?'Yes':'No';
      builderStatDirty.style.color=builderDirty?'#991B1B':'var(--gray-900)';
    }
    function updateBuilderStats(){
      if(!builderDraft){return;}
      builderStatCards.textContent=String((builderDraft.flashcards||[]).length);
      builderStatQuestions.textContent=String((builderDraft.test_questions||[]).length);
      builderSummary.textContent=(builderDraft.flashcards||[]).length+' cards ¬∑ '+(builderDraft.test_questions||[]).length+' questions';
    }
    function renderBuilderFolderSelect(){
      var options=[{folder_id:'',name:'No folder'}].concat(folders.map(function(folder){
        return {folder_id:folder.folder_id,name:folder.name};
      }));
      builderFolderSelect.innerHTML=options.map(function(item){
        return '<option value="'+escapeHtml(item.folder_id)+'">'+escapeHtml(item.name)+'</option>';
      }).join('');
      builderFolderSelect.value=builderDraft&&builderDraft.folder_id?builderDraft.folder_id:'';
    }
    function renderBuilderInfoPane(){
      if(!builderDraft){return;}
      builderTitleInput.value=builderDraft.title||'';
      builderCourseInput.value=builderDraft.course||'';
      builderSubjectInput.value=builderDraft.subject||'';
      builderSemesterInput.value=builderDraft.semester||'';
      builderBlockInput.value=builderDraft.block||'';
      builderNotesInput.value=builderDraft.notes_markdown||'';
      renderBuilderFolderSelect();
    }
    function renderBuilderFlashcards(){
      if(!builderDraft){return;}
      var cards=builderDraft.flashcards||[];
      if(!cards.length){
        builderFlashcardList.innerHTML='<div class="builder-list-empty">No flashcards yet. Add one to start building your deck.</div>';
        updateBuilderStats();
        return;
      }
      builderFlashcardList.innerHTML=cards.map(function(card,index){
        return '<div class="builder-row" data-fc-row="'+index+'">'
          +'<div class="builder-row-head"><span class="builder-row-title">Flashcard '+(index+1)+'</span><button class="btn danger" data-delete-fc="'+index+'" style="padding:5px 8px;font-size:.75rem">Delete</button></div>'
          +'<div class="builder-split"><div class="field"><label>Front</label><textarea data-fc-field="front" data-fc-index="'+index+'" style="min-height:92px">'+escapeHtml(card.front||'')+'</textarea></div>'
          +'<div class="field"><label>Back</label><textarea data-fc-field="back" data-fc-index="'+index+'" style="min-height:92px">'+escapeHtml(card.back||'')+'</textarea></div></div></div>';
      }).join('');
      updateBuilderStats();
    }
    function renderBuilderQuestions(){
      if(!builderDraft){return;}
      var questions=(builderDraft.test_questions||[]).map(normalizeQuestion);
      builderDraft.test_questions=questions;
      if(!questions.length){
        builderQuestionList.innerHTML='<div class="builder-list-empty">No practice questions yet. Add one to begin.</div>';
        updateBuilderStats();
        return;
      }
      builderQuestionList.innerHTML=questions.map(function(question,index){
        var answerOptions=(question.options||[]).map(function(option,optionIndex){
          var letter=['A','B','C','D'][optionIndex]||'';
          return '<option value="'+escapeHtml(option)+'" '+(question.answer===option?'selected':'')+'>'+letter+': '+escapeHtml(option||'(empty)')+'</option>';
        }).join('');
        return '<div class="builder-row" data-q-row="'+index+'">'
          +'<div class="builder-row-head"><span class="builder-row-title">Question '+(index+1)+'</span><button class="btn danger" data-delete-q="'+index+'" style="padding:5px 8px;font-size:.75rem">Delete</button></div>'
          +'<div class="field"><label>Question</label><textarea data-q-field="question" data-q-index="'+index+'" style="min-height:86px">'+escapeHtml(question.question||'')+'</textarea></div>'
          +'<div class="builder-grid-3" style="margin-top:8px">'
          +'<div class="field"><label>Option A</label><input data-q-option="0" data-q-index="'+index+'" value="'+escapeHtml(question.options[0]||'')+'"></div>'
          +'<div class="field"><label>Option B</label><input data-q-option="1" data-q-index="'+index+'" value="'+escapeHtml(question.options[1]||'')+'"></div>'
          +'<div class="field"><label>Option C</label><input data-q-option="2" data-q-index="'+index+'" value="'+escapeHtml(question.options[2]||'')+'"></div>'
          +'</div><div class="builder-grid" style="margin-top:8px">'
          +'<div class="field"><label>Option D</label><input data-q-option="3" data-q-index="'+index+'" value="'+escapeHtml(question.options[3]||'')+'"></div>'
          +'<div class="field"><label>Correct Answer</label><select class="builder-select" data-q-answer="'+index+'">'+answerOptions+'</select></div>'
          +'</div><div class="field" style="margin-top:8px"><label>Explanation (optional)</label><textarea data-q-field="explanation" data-q-index="'+index+'" style="min-height:72px">'+escapeHtml(question.explanation||'')+'</textarea></div></div>';
      }).join('');
      updateBuilderStats();
    }
    function setBuilderPane(nextPane){
      builderPane=nextPane;
      document.querySelectorAll('.builder-pane').forEach(function(pane){
        pane.classList.toggle('active',pane.id===('builder-pane-'+nextPane));
      });
      builderPaneButtons.forEach(function(button){
        button.classList.toggle('active',button.dataset.builderPane===nextPane);
      });
    }
    function clearBuilderImportState(){
      builderImportParsed=null;
      builderApplyImportBtn.disabled=true;
      builderPreview.style.display='none';
      builderImportErrors.style.display='none';
      builderImportErrors.innerHTML='';
      builderImportSummary.textContent='No file loaded.';
    }
    function openBuilderOverlay(mode,pack){
      var openingCreate=(mode==='create');
      builderMode=openingCreate?'create':'edit';
      builderPackId=openingCreate?'':(pack&&pack.study_pack_id?pack.study_pack_id:selectedPackId);
      builderDraft=openingCreate?buildDraftFromPack({
        title:'',
        notes_markdown:'',
        flashcards:[],
        test_questions:[]
      }):buildDraftFromPack(pack||selectedPack||{});
      builderTitleEl.textContent=openingCreate?'Create Study Pack':'Edit Study Pack';
      builderSubEl.textContent=openingCreate?'Start from scratch in a focused fullscreen workspace':'Refine cards, metadata, and imports in one place';
      builderBrandSub.textContent=openingCreate?'Manual creation flow':'Editing '+(builderDraft.title||'Untitled pack');
      renderBuilderInfoPane();
      renderBuilderFlashcards();
      renderBuilderQuestions();
      clearBuilderImportState();
      setBuilderPane('info');
      markBuilderDirty(false);
      updateBuilderStats();
      openModal(builderOverlay);
      document.body.style.overflow='hidden';
    }
    function closeBuilderOverlay(){
      closeModal(builderOverlay);
      document.body.style.overflow='';
      builderDraft=null;
      builderPackId='';
      builderImportParsed=null;
    }
    function openBuilderExitModal(){
      openModal(builderExitOverlay);
      return new Promise(function(resolve){builderExitResolver=resolve;});
    }
    function closeBuilderExitModal(choice){
      closeModal(builderExitOverlay);
      if(builderExitResolver){
        builderExitResolver(choice);
        builderExitResolver=null;
      }
    }
    function handleBuilderExitRequest(){
      if(!builderDirty){
        closeBuilderOverlay();
        return;
      }
      openBuilderExitModal().then(function(choice){
        if(choice==='save'){
          saveBuilderPack(true);
          return;
        }
        if(choice==='discard'){
          markBuilderDirty(false);
          closeBuilderOverlay();
        }
      });
    }
    function getBuilderPayload(){
      return {
        title:(builderDraft.title||'').trim(),
        folder_id:builderDraft.folder_id||'',
        course:(builderDraft.course||'').trim(),
        subject:(builderDraft.subject||'').trim(),
        semester:(builderDraft.semester||'').trim(),
        block:(builderDraft.block||'').trim(),
        notes_markdown:builderDraft.notes_markdown||'',
        flashcards:builderDraft.flashcards||[],
        test_questions:(builderDraft.test_questions||[]).map(normalizeQuestion)
      };
    }
    function saveBuilderPack(closeAfter){
      if(!builderDraft){return Promise.resolve();}
      var payload=getBuilderPayload();
      if(!payload.title){
        payload.title='Untitled pack';
      }
      var request;
      if(builderMode==='create'){
        request=apiCall('/api/study-packs',{method:'POST',body:JSON.stringify(payload)});
      }else{
        request=apiCall('/api/study-packs/'+encodeURIComponent(builderPackId||selectedPackId),{method:'PATCH',body:JSON.stringify(payload)});
      }
      return request.then(function(response){
        if(builderMode==='create'&&response&&response.study_pack_id){
          builderPackId=response.study_pack_id;
          selectedPackId=response.study_pack_id;
          builderMode='edit';
        }
        return loadData(builderPackId||selectedPackId);
      }).then(function(){
        markBuilderDirty(false);
        showToast('Study pack saved.');
        if(closeAfter){
          closeBuilderOverlay();
        }else{
          builderBrandSub.textContent='Editing '+((builderDraft&&builderDraft.title)||'Untitled pack');
        }
      }).catch(function(e){
        showToast(e.message||'Could not save builder changes.','error');
      });
    }
    function parseCsvRows(text){
      var rows=[];
      var row=[];
      var field='';
      var inQuotes=false;
      for(var i=0;i<text.length;i++){
        var ch=text[i];
        if(ch==='"'){
          if(inQuotes&&text[i+1]==='"'){
            field+='"';
            i++;
          }else{
            inQuotes=!inQuotes;
          }
          continue;
        }
        if(ch===','&&!inQuotes){
          row.push(field);
          field='';
          continue;
        }
        if((ch==='\n'||ch==='\r')&&!inQuotes){
          if(ch==='\r'&&text[i+1]==='\n'){i++;}
          row.push(field);
          rows.push(row);
          row=[];
          field='';
          continue;
        }
        field+=ch;
      }
      row.push(field);
      rows.push(row);
      return rows;
    }
    function normalizeHeader(name){
      return String(name||'').trim().toLowerCase().replace(/[\s\-]+/g,'_');
    }
    function parseBuilderCsvContent(rawText,type){
      var rows=parseCsvRows(rawText||'');
      if(!rows.length||rows.every(function(r){return !r.join('').trim();})){
        return {type:type,items:[],errors:['The file appears to be empty.'],preview:[]};
      }
      var headers=(rows[0]||[]).map(function(header){return normalizeHeader(header.replace(/^\uFEFF/,''));});
      var errors=[];
      var items=[];
      function idx(name){return headers.indexOf(name);}
      if(type==='flashcards'){
        var frontIndex=idx('front');
        var backIndex=idx('back');
        if(frontIndex<0||backIndex<0){
          // Backward compatibility
          frontIndex=idx('question');
          backIndex=idx('answer');
        }
        if(frontIndex<0||backIndex<0){
          return {type:type,items:[],errors:['Missing required headers. Use: front, back'],preview:[]};
        }
        for(var rowIndex=1;rowIndex<rows.length;rowIndex++){
          var row=rows[rowIndex]||[];
          if(!row.join('').trim()){continue;}
          var front=String(row[frontIndex]||'').trim();
          var back=String(row[backIndex]||'').trim();
          if(!front||!back){
            errors.push('Row '+(rowIndex+1)+': front and back are required.');
            continue;
          }
          items.push({front:front,back:back});
        }
      }else{
        var qIndex=idx('question'),aIndex=idx('option_a'),bIndex=idx('option_b'),cIndex=idx('option_c'),dIndex=idx('option_d'),answerIndex=idx('answer'),expIndex=idx('explanation');
        if(qIndex<0||aIndex<0||bIndex<0||cIndex<0||dIndex<0||answerIndex<0){
          return {type:type,items:[],errors:['Missing required headers. Use: question, option_a, option_b, option_c, option_d, answer (optional explanation)'],preview:[]};
        }
        for(var qRowIndex=1;qRowIndex<rows.length;qRowIndex++){
          var qRow=rows[qRowIndex]||[];
          if(!qRow.join('').trim()){continue;}
          var question=String(qRow[qIndex]||'').trim();
          var options=[String(qRow[aIndex]||'').trim(),String(qRow[bIndex]||'').trim(),String(qRow[cIndex]||'').trim(),String(qRow[dIndex]||'').trim()];
          var answerRaw=String(qRow[answerIndex]||'').trim();
          var explanation=expIndex>=0?String(qRow[expIndex]||'').trim():'';
          if(!question||options.some(function(opt){return !opt;})){
            errors.push('Row '+(qRowIndex+1)+': question and all options are required.');
            continue;
          }
          if(new Set(options).size!==4){
            errors.push('Row '+(qRowIndex+1)+': options must be unique.');
            continue;
          }
          var answer=answerRaw;
          if(/^[ABCD]$/i.test(answerRaw)){
            answer=options['ABCD'.indexOf(answerRaw.toUpperCase())];
          }
          if(options.indexOf(answer)<0){
            errors.push('Row '+(qRowIndex+1)+': answer must match one option or use A-D.');
            continue;
          }
          items.push({question:question,options:options,answer:answer,explanation:explanation});
        }
      }
      return {type:type,items:items,errors:errors,preview:items.slice(0,10)};
    }
    function renderBuilderImportPreview(){
      if(!builderImportParsed||!builderImportParsed.items.length){
        builderPreview.style.display='none';
        return;
      }
      var parsed=builderImportParsed;
      var headers=parsed.type==='flashcards'?['Front','Back']:['Question','Answer','Explanation'];
      var rowsHtml=parsed.preview.map(function(item){
        if(parsed.type==='flashcards'){
          return '<tr><td>'+escapeHtml(item.front)+'</td><td>'+escapeHtml(item.back)+'</td></tr>';
        }
        return '<tr><td>'+escapeHtml(item.question)+'</td><td>'+escapeHtml(item.answer)+'</td><td>'+escapeHtml(item.explanation||'')+'</td></tr>';
      }).join('');
      builderPreviewTable.innerHTML='<thead><tr>'+headers.map(function(header){return '<th>'+escapeHtml(header)+'</th>';}).join('')+'</tr></thead><tbody>'+rowsHtml+'</tbody>';
      builderPreview.style.display='';
    }
    function handleBuilderCsvFile(file){
      if(!file){return;}
      var reader=new FileReader();
      reader.onload=function(){
        var parsed=parseBuilderCsvContent(String(reader.result||''),builderImportType.value);
        builderImportParsed=parsed;
        builderApplyImportBtn.disabled=!parsed.items.length;
        builderImportSummary.textContent='Loaded '+parsed.items.length+' valid row(s).';
        if(parsed.errors.length){
          builderImportErrors.style.display='';
          builderImportErrors.innerHTML=parsed.errors.map(function(err){return '<div>'+escapeHtml(err)+'</div>';}).join('');
        }else{
          builderImportErrors.style.display='none';
          builderImportErrors.innerHTML='';
        }
        renderBuilderImportPreview();
      };
      reader.onerror=function(){
        showToast('Could not read CSV file.','error');
      };
      reader.readAsText(file);
    }
    function applyBuilderImport(){
      if(!builderDraft||!builderImportParsed||!builderImportParsed.items.length){
        return;
      }
      var replaceMode=builderImportMode.value==='replace';
      if(builderImportParsed.type==='flashcards'){
        builderDraft.flashcards=replaceMode?builderImportParsed.items.slice():(builderDraft.flashcards||[]).concat(builderImportParsed.items);
        renderBuilderFlashcards();
      }else{
        var incoming=builderImportParsed.items.map(normalizeQuestion);
        builderDraft.test_questions=replaceMode?incoming:(builderDraft.test_questions||[]).concat(incoming);
        renderBuilderQuestions();
      }
      markBuilderDirty(true);
      updateBuilderStats();
      showToast('Imported '+builderImportParsed.items.length+' row(s).');
    }
    function downloadBuilderTemplate(){
      var csvText='';
      var filename='';
      if(builderImportType.value==='flashcards'){
        csvText='front,back\nCell membrane,Selective barrier surrounding the cell\nMitochondria,Organelle that produces ATP';
        filename='flashcards-template.csv';
      }else{
        csvText='question,option_a,option_b,option_c,option_d,answer,explanation\nWhich organelle produces ATP?,Nucleus,Mitochondria,Golgi apparatus,Ribosome,B,Mitochondria are the powerhouse of the cell.';
        filename='practice-test-template.csv';
      }
      var blob=new Blob([csvText],{type:'text/csv;charset=utf-8;'});
      var link=document.createElement('a');
      link.href=URL.createObjectURL(blob);
      link.download=filename;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      URL.revokeObjectURL(link.href);
    }

    /* ‚îÄ‚îÄ Session Setup ‚îÄ‚îÄ */
    function renderAlgoLane(){
      algoLane.innerHTML='';
      sessionAlgo.forEach(function(type,i){
        if(i>0){var ch=document.createElement('div');ch.className='algo-chevron';ch.innerHTML='<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="9 18 15 12 9 6"></polyline></svg>';algoLane.appendChild(ch);}
        var s=document.createElement('div');s.className='algo-slot';s.dataset.type=type;s.dataset.index=String(i);
        s.innerHTML=(ALGO_ICONS[type]||'')+'<span>'+type.charAt(0).toUpperCase()+type.slice(1)+'</span>';
        s.addEventListener('click',function(){var ni=(ALGO_TYPES.indexOf(type)+1)%ALGO_TYPES.length;sessionAlgo[i]=ALGO_TYPES[ni];sessionAlgoPreset='';renderAlgoLane();renderAlgoPresets();saveSessionState();});
        algoLane.appendChild(s);
      });
    }
    function renderAlgoPresets(){algoPresets.forEach(function(b){b.classList.toggle('active',b.dataset.preset===sessionAlgoPreset);});}
    function applyAlgoPreset(p){if(ALGO_PRESETS[p]){sessionAlgo=ALGO_PRESETS[p].slice();sessionAlgoPreset=p;renderAlgoLane();renderAlgoPresets();saveSessionState();}}
    function renderSettingsRows(){document.querySelectorAll('.setting-row[data-setting]').forEach(function(r){r.classList.toggle('active',!!sessionSettings[r.dataset.setting]);});}

    function renderLessonCards(){
      var hf=selectedPack&&selectedPack.flashcards&&selectedPack.flashcards.length>0;
      var ht=selectedPack&&selectedPack.test_questions&&selectedPack.test_questions.length>0;
      var fcCount=selectedPack?(selectedPack.flashcards||[]).length:0;
      var hasEnoughForMatch=fcCount>=MATCH_MIN_CARDS;
      var fc=document.getElementById('lesson-card-flashcards');
      var tc=document.getElementById('lesson-card-test');
      var wc=document.getElementById('lesson-card-write');
      var mc=document.getElementById('lesson-card-match');
      var mb=document.getElementById('match-min-badge');
      // Show/hide based on data availability
      fc.style.display=hf?'':'none';
      tc.style.display=ht?'':'none';
      wc.style.display=hf?'':'none'; // write uses flashcards
      mc.style.display=hf?'':'none'; // match uses flashcards
      // Match needs minimum cards
      if(hf&&!hasEnoughForMatch){
        mc.classList.add('unavailable');mc.classList.remove('selected');
        sessionLessons.match=false;
        mb.style.display='';mb.textContent='Needs '+MATCH_MIN_CARDS+'+ cards';
      }else{
        mc.classList.remove('unavailable');mb.style.display='none';
      }
      if(!hf){sessionLessons.flashcards=false;sessionLessons.write=false;sessionLessons.match=false;}
      if(!ht){sessionLessons.test=false;}
      fc.classList.toggle('selected',sessionLessons.flashcards);
      tc.classList.toggle('selected',sessionLessons.test);
      wc.classList.toggle('selected',sessionLessons.write);
      mc.classList.toggle('selected',sessionLessons.match);
    }

    function renderMasteryGauge(){
      var cards=selectedPack?(selectedPack.flashcards||[]):[];
      var total=cards.length;var state=loadCardState();
      var seen=0,famCount=0,mastCount=0;
      cards.forEach(function(c,i){var cs=state['fc_'+i];if(cs){seen++;if(cs.level==='mastered'){mastCount++;}else if(cs.level==='familiar'){famCount++;}}});
      var newCount=total-seen;
      document.getElementById('mastery-total').textContent=String(total);
      document.getElementById('mastery-seen').textContent=String(seen);
      document.getElementById('mastery-new-pct').textContent=total?Math.round((newCount/total)*100)+'%':'0%';
      document.getElementById('mastery-familiar-pct').textContent=total?Math.round((famCount/total)*100)+'%':'0%';
      document.getElementById('mastery-mastered-pct').textContent=total?Math.round((mastCount/total)*100)+'%':'0%';
    }

    function setSetupPane(p){
      activeSetupPane=p;
      setupTabs.forEach(function(t){t.classList.toggle('active',t.dataset.setupPane===p);});
      ['mastery','lessons','settings','algorithm'].forEach(function(x){
        var el=document.getElementById('setup-pane-'+x);
        if(el){el.classList.toggle('active',x===p);}
      });
    }

    function getEnabledModes(){
      var modes=[];
      if(sessionLessons.flashcards){modes.push('flashcards');}
      if(sessionLessons.test){modes.push('test');}
      if(sessionLessons.write){modes.push('write');}
      if(sessionLessons.match){modes.push('match');}
      return modes;
    }

    function showModePicker(modes){
      setupMainContent.style.display='none';
      modePicker.classList.add('active');
      modePickerGrid.innerHTML='';
      modes.forEach(function(m){
        var card=document.createElement('div');
        card.className='mode-picker-card';
        card.innerHTML=(MODE_ICONS[m]||'')+'<div class="mode-picker-card-title">'+(MODE_NAMES[m]||m)+'</div><div class="mode-picker-card-desc">'+(MODE_DESCS[m]||'')+'</div>';
        card.addEventListener('click',function(){
          closeSessionSetup();
          openLearnStageWithMode(m,false);
        });
        modePickerGrid.appendChild(card);
      });
    }

    function hideModePicker(){
      modePicker.classList.remove('active');
      setupMainContent.style.display='';
    }

    function openSessionSetup(){
      if(!selectedPack){showToast('Select a study pack first.','error');return;}
      loadSessionState();
      setupPackName.textContent=selectedPack.title||'Untitled pack';
      hideModePicker();
      renderMasteryGauge();renderLessonCards();renderSettingsRows();renderAlgoLane();renderAlgoPresets();
      setSetupPane('mastery');
      openModal(setupOverlay);
    }
    function closeSessionSetup(){closeModal(setupOverlay);hideModePicker();}

    setupTabs.forEach(function(t){t.addEventListener('click',function(){setSetupPane(t.dataset.setupPane);});});
    setupCloseBtn.addEventListener('click',closeSessionSetup);
    setupOverlay.addEventListener('click',function(e){if(e.target===setupOverlay){closeSessionSetup();}});
    algoPresets.forEach(function(b){b.addEventListener('click',function(){applyAlgoPreset(b.dataset.preset);});});
    document.querySelectorAll('.setting-row[data-setting]').forEach(function(row){
      row.addEventListener('click',function(){
        sessionSettings[row.dataset.setting]=!sessionSettings[row.dataset.setting];
        renderSettingsRows();saveSessionState();
      });
    });
    document.querySelectorAll('.lesson-card:not(.unavailable)').forEach(function(card){
      card.addEventListener('click',function(){
        var l=card.dataset.lesson;
        if(card.classList.contains('unavailable'))return;
        if(l==='flashcards'){sessionLessons.flashcards=!sessionLessons.flashcards;}
        if(l==='test'){sessionLessons.test=!sessionLessons.test;}
        if(l==='write'){sessionLessons.write=!sessionLessons.write;}
        if(l==='match'){sessionLessons.match=!sessionLessons.match;}
        renderLessonCards();saveSessionState();
      });
    });
    modePickerBack.addEventListener('click',hideModePicker);

    setupStartBtn.addEventListener('click',function(){
      saveSessionState();
      var modes=getEnabledModes();
      if(modes.length===0){
        showToast('Select at least one lesson type.','error');
        setSetupPane('lessons');
        return;
      }
      if(modes.length===1){
        // Single mode: enter directly
        closeSessionSetup();
        openLearnStageWithMode(modes[0],false);
      }else{
        // Multiple modes: show picker
        showModePicker(modes);
      }
    });

    /* ‚îÄ‚îÄ Write mode ‚îÄ‚îÄ */
    function initWriteMode(){
      writeIndex=0;writeRevealed=false;writeChecked=false;writePromptSwapped=false;
      renderWriteCard();
    }
    function getWriteCards(){
      return orderedFlashcards.length?orderedFlashcards:(selectedPack&&selectedPack.flashcards?selectedPack.flashcards:[]);
    }
    function renderWriteCard(){
      var cards=getWriteCards();
      if(!cards.length){writePromptEl.textContent='No flashcards available.';writeInputEl.style.display='none';writeCheckBtn.style.display='none';writeRevealBtn.style.display='none';writeNextBtn.style.display='none';return;}
      var c=cards[writeIndex];
      writePromptSwapped=sessionSettings.swapAnswerQuestion||(sessionSettings.randomSwap&&Math.random()>0.5);
      writePromptEl.textContent=writePromptSwapped?(c.back||''):(c.front||'');
      writeInputEl.value='';writeInputEl.disabled=false;writeInputEl.className='write-input';
      writeInputEl.style.display='';writeCheckBtn.style.display='';writeRevealBtn.style.display='';
      writeFeedbackEl.className='write-feedback';writeFeedbackEl.style.display='';writeFeedbackEl.classList.remove('visible');
      writeChecked=false;writeRevealed=false;
      writeProgressEl.textContent=(writeIndex+1)+' / '+cards.length;
      writeNextBtn.style.display='';
      writeInputEl.focus();
      updateLearnProgressBar();
    }
    function checkWriteAnswer(){
      if(writeChecked||writeRevealed)return;
      writeChecked=true;
      var cards=getWriteCards();
      var c=cards[writeIndex];
      var correctAnswer=writePromptSwapped?(c.front||''):(c.back||'');
      var isCorrect=gradeAnswer(writeInputEl.value,correctAnswer);
      writeInputEl.disabled=true;
      markCardSeen('fc_'+writeIndex,isCorrect);
      if(isCorrect){
        writeInputEl.className='write-input correct-input';
        writeFeedbackEl.className='write-feedback visible correct-fb';
        writeFeedbackEl.textContent='Correct!';
      }else{
        writeInputEl.className='write-input wrong-input';
        writeFeedbackEl.className='write-feedback visible wrong-fb';
        writeFeedbackEl.textContent='Incorrect. Expected: '+correctAnswer;
      }
    }
    function revealWriteAnswer(){
      if(writeRevealed)return;
      writeRevealed=true;writeChecked=true;
      var cards=getWriteCards();
      var c=cards[writeIndex];
      var correctAnswer=writePromptSwapped?(c.front||''):(c.back||'');
      writeInputEl.disabled=true;writeInputEl.className='write-input wrong-input';
      writeFeedbackEl.className='write-feedback visible wrong-fb';
      writeFeedbackEl.textContent='Answer: '+correctAnswer;
      markCardSeen('fc_'+writeIndex,false);
    }
    writeCheckBtn.addEventListener('click',checkWriteAnswer);
    writeRevealBtn.addEventListener('click',revealWriteAnswer);
    writeNextBtn.addEventListener('click',function(){
      var cards=getWriteCards();
      if(writeIndex<cards.length-1){writeIndex++;renderWriteCard();}
      else{showToast('All cards completed!');}
    });
    writeInputEl.addEventListener('keydown',function(e){
      if(e.key==='Enter'){e.preventDefault();if(!writeChecked){checkWriteAnswer();}else{writeNextBtn.click();}}
    });

    /* ‚îÄ‚îÄ Match mode ‚îÄ‚îÄ */
    function initMatchMode(){
      stopMatchTimer();
      matchResultsEl.style.display='none';
      matchGridEl.style.display='';
      matchSelected=null;matchMatched=0;
      var cards=selectedPack&&selectedPack.flashcards?selectedPack.flashcards:[];
      // Pick 6 random cards for 4x3 grid (6 pairs = 12 cells)
      var poolSize=Math.min(6,Math.floor(cards.length));
      var shuffled=cards.slice().sort(function(){return Math.random()-0.5;});
      var picked=shuffled.slice(0,poolSize);
      matchTotal=poolSize;
      // Build cells: each card produces a front cell and a back cell
      var cells=[];
      picked.forEach(function(c,i){
        cells.push({id:'m_'+i,side:'front',text:c.front||'',pairId:i});
        cells.push({id:'m_'+i,side:'back',text:c.back||'',pairId:i});
      });
      // Shuffle cells
      cells.sort(function(){return Math.random()-0.5;});
      matchCards=cells;
      renderMatchGrid();
      startMatchTimer();
    }
    function renderMatchGrid(){
      matchGridEl.innerHTML='';
      matchCards.forEach(function(cell,idx){
        var div=document.createElement('div');
        div.className='match-cell';
        div.textContent=cell.text;
        div.dataset.idx=String(idx);
        div.dataset.pairId=String(cell.pairId);
        div.dataset.side=cell.side;
        if(cell.matched){div.classList.add('matched');}
        div.addEventListener('click',function(){handleMatchClick(idx);});
        matchGridEl.appendChild(div);
      });
    }
    function handleMatchClick(idx){
      var cell=matchCards[idx];
      if(cell.matched)return;
      var cellEl=matchGridEl.children[idx];
      if(matchSelected===null){
        // First selection
        matchSelected=idx;
        cellEl.classList.add('selected');
      }else if(matchSelected===idx){
        // Deselect
        cellEl.classList.remove('selected');
        matchSelected=null;
      }else{
        // Second selection ‚Äî check match
        var firstCell=matchCards[matchSelected];
        var firstEl=matchGridEl.children[matchSelected];
        if(firstCell.pairId===cell.pairId&&firstCell.side!==cell.side){
          // Correct match
          firstCell.matched=true;cell.matched=true;
          firstEl.classList.remove('selected');firstEl.classList.add('matched');
          cellEl.classList.add('matched');
          matchMatched++;
          markCardSeen('fc_'+cell.pairId,true);
          if(matchMatched>=matchTotal){
            // All matched ‚Äî stop timer and show results
            stopMatchTimer();
            showMatchResults();
          }
        }else{
          // Wrong match ‚Äî flash red briefly
          cellEl.classList.add('wrong-flash');firstEl.classList.add('wrong-flash');
          var fi=matchSelected;
          setTimeout(function(){
            cellEl.classList.remove('wrong-flash');
            if(matchGridEl.children[fi]){matchGridEl.children[fi].classList.remove('wrong-flash','selected');}
          },500);
        }
        matchSelected=null;
      }
      updateLearnProgressBar();
    }
    function startMatchTimer(){
      matchStartTime=Date.now();matchRunning=true;matchElapsed=0;
      matchTimerEl.textContent='0.0s';
      matchTimerInterval=setInterval(function(){
        if(!matchRunning)return;
        matchElapsed=Date.now()-matchStartTime;
        matchTimerEl.textContent=(matchElapsed/1000).toFixed(1)+'s';
      },100);
    }
    function stopMatchTimer(){
      matchRunning=false;
      if(matchTimerInterval){clearInterval(matchTimerInterval);matchTimerInterval=null;}
    }
    function showMatchResults(){
      matchGridEl.style.display='none';
      matchResultsEl.style.display='';
      var timeMs=matchElapsed;
      var timeSec=(timeMs/1000).toFixed(2);
      matchResultsTime.textContent=timeSec+'s';
      // Save and get rank
      var scores=saveMatchScore(timeMs);
      var rank=getScoreRank(scores,timeMs);
      if(rank===1){
        matchResultsBadge.textContent='New High Score!';
        matchResultsBadge.className='match-results-badge gold';
      }else if(rank===2){
        matchResultsBadge.textContent='2nd Best Time!';
        matchResultsBadge.className='match-results-badge silver';
      }else if(rank===3){
        matchResultsBadge.textContent='3rd Best Time!';
        matchResultsBadge.className='match-results-badge bronze';
      }else{
        matchResultsBadge.textContent='';
        matchResultsBadge.className='match-results-badge';
      }
      // Show top 3 history
      var historyHtml='';
      var labels=['1st','2nd','3rd'];
      for(var i=0;i<Math.min(3,scores.length);i++){
        historyHtml+=labels[i]+': '+(scores[i]/1000).toFixed(2)+'s';
        if(i<Math.min(3,scores.length)-1){historyHtml+=' &middot; ';}
      }
      matchResultsHistory.innerHTML=historyHtml;
    }
    matchPlayAgainBtn.addEventListener('click',function(){initMatchMode();});
/* ‚îÄ‚îÄ Editor pane ‚îÄ‚îÄ */
    function setEditorPane(pane){
      activeEditorPane=pane;
      editorTabs.forEach(function(b){b.classList.toggle('active',b.dataset.editorPane===pane);});
      document.getElementById('editor-pane-notes').classList.toggle('active',pane==='notes');
      document.getElementById('editor-pane-flashcards').classList.toggle('active',pane==='flashcards');
      document.getElementById('editor-pane-test').classList.toggle('active',pane==='test');
      if(pane==='test'){exportType='test';exportCsvLabel.textContent='Export Practice Test CSV';}
      else{exportType='flashcards';exportCsvLabel.textContent='Export Flashcards CSV';}
    }

    function filteredPacks(){
      var q=searchInput.value.trim().toLowerCase();
      return packs.filter(function(p){
        if(selectedFolderId&&p.folder_id!==selectedFolderId)return false;
        if(!q)return true;
        var hay=((p.title||'')+' '+(p.course||'')+' '+(p.subject||'')+' '+(p.semester||'')+' '+(p.block||'')).toLowerCase();
        return hay.indexOf(q)>=0;
      });
    }

    function movePackToFolder(pid,fid){
      return apiCall('/api/study-packs/'+encodeURIComponent(pid),{method:'PATCH',body:JSON.stringify({folder_id:fid})}).then(function(){
        showToast('Study pack moved.');return loadData(pid);
      }).catch(function(e){showToast(e.message||'Could not move pack.','error');});
    }

    function renderFolders(){
      var all=[{folder_id:'',name:'All Study Packs',course:'',subject:'',semester:'',block:''}].concat(folders);
      folderList.innerHTML='';
      all.forEach(function(f){
        var div=document.createElement('div');
        div.className='item'+(selectedFolderId===f.folder_id?' active':'');
        div.dataset.folderId=f.folder_id;
        div.innerHTML='<div class="item-head"><span class="item-title">'+f.name+'</span>'+(f.folder_id?'<button class="btn" data-edit-folder="1" style="padding:5px 8px;font-size:0.75rem;">Edit</button>':'')+'</div><div class="item-sub">'+([f.course,f.subject,f.semester,f.block].filter(Boolean).join(' &middot; ')||(f.folder_id?'No metadata':'All packs'))+'</div>';
        div.addEventListener('click',function(e){if(e.target.closest('[data-edit-folder]'))return;selectedFolderId=f.folder_id;renderFolders();renderPacks();});
        if(f.folder_id){var eb=div.querySelector('[data-edit-folder]');if(eb){eb.addEventListener('click',function(e){e.stopPropagation();openFolderModal('edit',f);});}}
        div.addEventListener('dragover',function(e){e.preventDefault();if(draggedPackId&&f.folder_id)div.classList.add('drop-target');});
        div.addEventListener('dragleave',function(){div.classList.remove('drop-target');});
        div.addEventListener('drop',function(e){e.preventDefault();div.classList.remove('drop-target');if(!draggedPackId||!f.folder_id)return;movePackToFolder(draggedPackId,f.folder_id);draggedPackId='';});
        folderList.appendChild(div);
      });
    }

    function getFolderNameById(id){if(!id)return'No folder';var f=folders.find(function(x){return x.folder_id===id;});return f?f.name:'No folder';}
    function setPackFolderSelection(id){packFolderSelect.value=id||'';packFolderLabel.textContent=getFolderNameById(id||'');packFolderMenu.querySelectorAll('.app-select-item').forEach(function(i){i.classList.toggle('active',i.dataset.value===(id||''));});}
    function renderFolderSelect(){
      var items=[{folder_id:'',name:'No folder'}].concat(folders.map(function(f){return{folder_id:f.folder_id,name:f.name};}));
      packFolderMenu.innerHTML='';
      items.forEach(function(item){var b=document.createElement('button');b.type='button';b.className='app-select-item';b.dataset.value=item.folder_id;b.textContent=item.name;b.addEventListener('click',function(){setPackFolderSelection(item.folder_id);packFolderMenu.classList.remove('visible');packFolderButton.classList.remove('open');});packFolderMenu.appendChild(b);});
      setPackFolderSelection(packFolderSelect.value||'');
    }

    function renderPacks(){
      var items=filteredPacks();packList.innerHTML='';
      if(!items.length){packList.innerHTML='<div class="empty">No study packs match this filter.</div>';return;}
      items.forEach(function(p){
        var div=document.createElement('div');
        div.className='item'+(selectedPackId===p.study_pack_id?' active':'');
        div.draggable=true;div.dataset.packId=p.study_pack_id;
        div.innerHTML='<div class="item-head"><span class="item-title">'+(p.title||'Untitled pack')+'</span></div><div class="item-sub">'+p.mode+' &middot; '+p.flashcards_count+' cards &middot; '+p.test_questions_count+' questions</div><div class="item-sub">'+([p.course,p.subject,p.semester,p.block].filter(Boolean).join(' &middot; ')||(p.folder_name?'Folder: '+p.folder_name:'No metadata'))+'</div>';
        div.addEventListener('click',function(){selectedPackId=p.study_pack_id;renderPacks();openPack(p.study_pack_id);});
        div.addEventListener('dragstart',function(e){draggedPackId=p.study_pack_id;div.classList.add('dragging');e.dataTransfer.effectAllowed='move';e.dataTransfer.setData('text/plain',p.study_pack_id);});
        div.addEventListener('dragend',function(){div.classList.remove('dragging');draggedPackId='';});
        packList.appendChild(div);
      });
    }

    function showPackEditor(v){packEmpty.style.display=v?'none':'block';packEditorWrap.classList.toggle('visible',v);}
    function updatePackSummary(){
      if(!selectedPack){packSummary.classList.remove('visible');return;}
      packSummary.classList.add('visible');
      packSummaryTitle.textContent=selectedPack.title||'Untitled pack';
      packSummaryMeta.textContent=[selectedPack.course,selectedPack.subject,selectedPack.semester,selectedPack.block].filter(Boolean).join(' ¬∑ ')||(selectedPack.mode||'');
      packStatNotes.textContent=selectedPack.notes_markdown?'Has notes':'No notes';
      packStatCards.textContent=(selectedPack.flashcards||[]).length+' flashcards';
      packStatTest.textContent=(selectedPack.test_questions||[]).length+' questions';
    }

    /* ‚îÄ‚îÄ Flashcard editor ‚îÄ‚îÄ */
    function renderFlashcardEditor(hi){
      var idx=typeof hi==='number'?hi:-1;
      var cards=selectedPack&&Array.isArray(selectedPack.flashcards)?selectedPack.flashcards:[];
      flashcardCount.textContent=cards.length+' flashcards';flashcardEditorList.innerHTML='';
      if(!cards.length){flashcardEditorList.innerHTML='<div class="empty">No flashcards yet. Add one to start editing.</div>';return;}
      cards.forEach(function(card,ci){
        var row=document.createElement('div');row.className='editor-card'+(ci===idx?' newly-added':'');row.dataset.rowIndex=String(ci);
        row.innerHTML='<div class="editor-card-head"><span class="editor-card-title">Flashcard '+(ci+1)+'</span><button class="btn danger" data-delete-card="'+ci+'" style="padding:5px 8px;font-size:0.75rem;">Delete</button></div><div class="field"><label>Front</label><input data-card-field="front" data-card-index="'+ci+'" value="'+(card.front||'').replace(/"/g,'&quot;')+'"></div><div class="field" style="margin-top:8px;"><label>Back</label><textarea data-card-field="back" data-card-index="'+ci+'">'+(card.back||'')+'</textarea></div>';
        flashcardEditorList.appendChild(row);
      });
      flashcardEditorList.querySelectorAll('[data-card-field]').forEach(function(el){
        el.addEventListener('input',function(){selectedPack.flashcards[parseInt(el.dataset.cardIndex,10)][el.dataset.cardField]=el.value;});
      });
      flashcardEditorList.querySelectorAll('[data-delete-card]').forEach(function(btn){
        btn.addEventListener('click',function(){selectedPack.flashcards.splice(parseInt(btn.dataset.deleteCard,10),1);if(learnFlashcardIndex>=selectedPack.flashcards.length){learnFlashcardIndex=Math.max(0,selectedPack.flashcards.length-1);}renderFlashcardEditor();showToast('Flashcard deleted.');});
      });
      if(idx>=0){var row=flashcardEditorList.querySelector('[data-row-index="'+idx+'"]');if(row){row.scrollIntoView({behavior:'smooth',block:'center'});var inp=row.querySelector('input[data-card-field="front"]');if(inp){inp.focus();}}}
    }

    /* ‚îÄ‚îÄ Question editor ‚îÄ‚îÄ */
    function normalizeQuestion(q){
      var b={question:q.question||'',options:Array.isArray(q.options)?q.options.slice(0,4):[],answer:q.answer||'',explanation:q.explanation||''};
      while(b.options.length<4){b.options.push('');}
      if(b.options.indexOf(b.answer)<0){b.answer=b.options[0]||'';}
      return b;
    }
    function getAnswerDisplay(q){var o=Array.isArray(q.options)?q.options:[];var fi=o.indexOf(q.answer);var i=fi>=0?fi:0;return(['A','B','C','D'][i]||'A')+': '+(o[i]||'(empty)');}

    function renderQuestionEditor(hi){
      var idx=typeof hi==='number'?hi:-1;
      selectedPack.test_questions=(selectedPack.test_questions||[]).map(normalizeQuestion);
      var questions=selectedPack.test_questions;
      questionCount.textContent=questions.length+' practice questions';questionEditorList.innerHTML='';
      if(!questions.length){questionEditorList.innerHTML='<div class="empty">No practice questions yet. Add one to start editing.</div>';return;}
      questions.forEach(function(q,qi){
        var row=document.createElement('div');row.className='editor-card'+(qi===idx?' newly-added':'');row.dataset.rowIndex=String(qi);
        var adStr=getAnswerDisplay(q).replace(/</g,'&lt;').replace(/>/g,'&gt;');
        row.innerHTML='<div class="editor-card-head"><span class="editor-card-title">Question '+(qi+1)+'</span><button class="btn danger" data-delete-question="'+qi+'" style="padding:5px 8px;font-size:0.75rem;">Delete</button></div>'
          +'<div class="field"><label>Question</label><textarea data-question-field="question" data-question-index="'+qi+'">'+q.question+'</textarea></div>'
          +'<div class="q-options-grid" style="margin-top:8px;">'
          +'<div class="field"><label>Option A</label><input data-option-index="0" data-question-index="'+qi+'" value="'+(q.options[0]||'').replace(/"/g,'&quot;')+'"></div>'
          +'<div class="field"><label>Option B</label><input data-option-index="1" data-question-index="'+qi+'" value="'+(q.options[1]||'').replace(/"/g,'&quot;')+'"></div>'
          +'<div class="field"><label>Option C</label><input data-option-index="2" data-question-index="'+qi+'" value="'+(q.options[2]||'').replace(/"/g,'&quot;')+'"></div>'
          +'<div class="field"><label>Option D</label><input data-option-index="3" data-question-index="'+qi+'" value="'+(q.options[3]||'').replace(/"/g,'&quot;')+'"></div></div>'
          +'<div class="field" style="margin-top:8px;"><label>Correct Answer</label>'
          +'<div class="app-select q-answer-picker" data-question-index="'+qi+'">'
          +'<button type="button" class="app-select-button" data-answer-button data-question-index="'+qi+'"><span class="app-select-label">'+adStr+'</span><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"></polyline></svg></button>'
          +'<div class="app-select-menu" data-answer-menu data-question-index="'+qi+'">'
          +q.options.map(function(o,oi){return'<button type="button" class="app-select-item'+(q.answer===o?' active':'')+'" data-answer-item data-question-index="'+qi+'" data-option-index="'+oi+'">'+(['A','B','C','D'][oi])+': '+(o||'(empty)').replace(/</g,'&lt;').replace(/>/g,'&gt;')+'</button>';}).join('')
          +'</div></div></div>'
          +'<div class="field" style="margin-top:8px;"><label>Explanation</label><textarea data-question-field="explanation" data-question-index="'+qi+'">'+q.explanation+'</textarea></div>';
        questionEditorList.appendChild(row);
      });
      questionEditorList.querySelectorAll('[data-question-field="question"],[data-question-field="explanation"]').forEach(function(el){
        el.addEventListener('input',function(){selectedPack.test_questions[parseInt(el.dataset.questionIndex,10)][el.dataset.questionField]=el.value;});
      });
      questionEditorList.querySelectorAll('input[data-option-index]').forEach(function(el){
        el.addEventListener('input',function(){
          var qi2=parseInt(el.dataset.questionIndex,10),oi2=parseInt(el.dataset.optionIndex,10);
          var qn=selectedPack.test_questions[qi2];qn.options[oi2]=el.value;
          if(qn.options.indexOf(qn.answer)<0){qn.answer=qn.options[0]||'';}
          renderQuestionEditor(qi2);
        });
      });
      questionEditorList.querySelectorAll('[data-answer-button]').forEach(function(b){
        b.addEventListener('click',function(e){
          e.stopPropagation();var m=b.parentElement.querySelector('[data-answer-menu]');
          var w=!m.classList.contains('visible');
          questionEditorList.querySelectorAll('[data-answer-menu]').forEach(function(x){x.classList.remove('visible');});
          questionEditorList.querySelectorAll('[data-answer-button]').forEach(function(x){x.classList.remove('open');});
          if(w){m.classList.add('visible');b.classList.add('open');}
        });
      });
      questionEditorList.querySelectorAll('[data-answer-item]').forEach(function(item){
        item.addEventListener('click',function(){
          var qi2=parseInt(item.dataset.questionIndex,10),oi2=parseInt(item.dataset.optionIndex,10);
          selectedPack.test_questions[qi2].answer=selectedPack.test_questions[qi2].options[oi2]||'';
          renderQuestionEditor(qi2);
        });
      });
      questionEditorList.querySelectorAll('[data-delete-question]').forEach(function(btn){
        btn.addEventListener('click',function(){
          selectedPack.test_questions.splice(parseInt(btn.dataset.deleteQuestion,10),1);
          if(learnQuestionIndex>=selectedPack.test_questions.length){learnQuestionIndex=Math.max(0,selectedPack.test_questions.length-1);}
          renderQuestionEditor();showToast('Practice question deleted.');
        });
      });
      if(idx>=0){var row2=questionEditorList.querySelector('[data-row-index="'+idx+'"]');if(row2){row2.scrollIntoView({behavior:'smooth',block:'center'});var ta=row2.querySelector('textarea[data-question-field="question"]');if(ta){ta.focus();}}}
    }

    /* ‚îÄ‚îÄ Learn progress bar ‚îÄ‚îÄ */
    function updateLearnProgressBar(){
      var c=0,t=0;
      if(activeLearnMode==='flashcards'){
        var fcCards=orderedFlashcards.length?orderedFlashcards:(selectedPack?(selectedPack.flashcards||[]):[]);
        c=learnFlashcardIndex+1;t=fcCards.length;
      }else if(activeLearnMode==='test'){
        var qs=selectedPack?(selectedPack.test_questions||[]):[];
        c=learnQuestionIndex+1;t=qs.length;
      }else if(activeLearnMode==='write'){
        var wCards=getWriteCards();c=writeIndex+1;t=wCards.length;
      }else if(activeLearnMode==='match'){
        c=matchMatched;t=matchTotal;
      }else{c=1;t=1;}
      learnProgressFill.style.width=t>0?((c/t)*100)+'%':'0%';
      learnProgressText.textContent=t>0?c+'/'+t:'';
    }

    /* ‚îÄ‚îÄ Learn flashcard with slide animation ‚îÄ‚îÄ */
    var fcSliding=false;
    function updateFlashcardContent(){
      var cards=orderedFlashcards.length?orderedFlashcards:(selectedPack&&Array.isArray(selectedPack.flashcards)?selectedPack.flashcards:[]);
      if(!cards.length){
        learnFlashcardFront.textContent='No flashcards available.';learnFlashcardBack.textContent='';
        learnFProgress.textContent='Card 0 of 0';learnFPrev.disabled=true;learnFNext.disabled=true;learnFFlip.disabled=true;
        updateLearnProgressBar();return;
      }
      var c=cards[learnFlashcardIndex];
      var swap=sessionSettings.swapAnswerQuestion||(sessionSettings.randomSwap&&Math.random()>0.5);
      learnFlashcardFront.textContent=swap?(c.back||''):(c.front||'');
      learnFlashcardBack.textContent=swap?(c.front||''):(c.back||'');
      learnFProgress.textContent='Card '+(learnFlashcardIndex+1)+' of '+cards.length;
      learnFPrev.disabled=(learnFlashcardIndex===0);
      learnFNext.disabled=(learnFlashcardIndex===cards.length-1);
      learnFFlip.disabled=false;
      updateLearnProgressBar();
    }
    function renderLearnFlashcard(){
      learnFlashcardInner.classList.toggle('flipped',learnFlashcardFlipped);
      updateFlashcardContent();
    }
    function doFlashcardSlide(direction){
      if(fcSliding)return;
      var cards=orderedFlashcards.length?orderedFlashcards:(selectedPack&&selectedPack.flashcards?selectedPack.flashcards:[]);
      if(!cards.length)return;
      var newIdx;
      if(direction==='next'){
        if(learnFlashcardIndex>=cards.length-1)return;
        newIdx=learnFlashcardIndex+1;
      }else{
        if(learnFlashcardIndex<=0)return;
        newIdx=learnFlashcardIndex-1;
      }
      fcSliding=true;
      // Unflip before sliding
      learnFlashcardFlipped=false;
      learnFlashcardInner.classList.remove('flipped');
      var cls=(direction==='next')?'slide-left':'slide-right';
      learnFlashcardInner.classList.add(cls);
      // Update content at animation midpoint (card is invisible)
      setTimeout(function(){
        learnFlashcardIndex=newIdx;
        updateFlashcardContent();
      },130);
      // Remove animation class after it finishes
      setTimeout(function(){
        learnFlashcardInner.classList.remove(cls);
        fcSliding=false;
      },320);
    }

    /* ‚îÄ‚îÄ Learn quiz ‚îÄ‚îÄ */
    function renderLearnQuestion(){
      var questions=selectedPack&&Array.isArray(selectedPack.test_questions)?selectedPack.test_questions:[];
      if(!questions.length){
        learnQProgress.textContent='Question 0 of 0';learnQScore.textContent='Score: 0/0';
        learnQText.textContent='No practice questions available.';learnQOptions.innerHTML='';
        learnQExpl.classList.remove('visible');learnQExpl.textContent='';updateLearnProgressBar();return;
      }
      var q=questions[learnQuestionIndex];learnAnswered=false;
      learnQProgress.textContent='Question '+(learnQuestionIndex+1)+' of '+questions.length;
      learnQScore.textContent='Score: '+learnScore+'/'+questions.length;
      learnQText.textContent=q.question||'';learnQOptions.innerHTML='';
      learnQExpl.classList.remove('visible');learnQExpl.textContent='';
      (q.options||[]).forEach(function(option){
        var b=document.createElement('button');b.type='button';b.className='quiz-option';b.textContent=option;
        b.addEventListener('click',function(){
          if(learnAnswered)return;learnAnswered=true;
          var correct=(option===q.answer);
          var allBtns=learnQOptions.querySelectorAll('.quiz-option');
          for(var j=0;j<allBtns.length;j++){allBtns[j].disabled=true;if(allBtns[j].textContent===q.answer){allBtns[j].classList.add('correct');}}
          if(correct){b.classList.add('correct');learnScore+=1;}else{b.classList.add('wrong');}
          markCardSeen('q_'+learnQuestionIndex,correct);
          learnQScore.textContent='Score: '+learnScore+'/'+questions.length;
          learnQExpl.textContent=q.explanation||'';learnQExpl.classList.add('visible');
          updateLearnProgressBar();
        });
        learnQOptions.appendChild(b);
      });
      updateLearnProgressBar();
    }

    /* ‚îÄ‚îÄ Open learn stage in a specific focused mode ‚îÄ‚îÄ */
    function openLearnStageWithMode(mode,requestFullscreen){
      if(!selectedPack){showToast('Select a study pack first.','error');return;}
      activeLearnMode=mode;
      learnTitle.textContent=selectedPack.title||'Learn Mode';
      learnSub.textContent=(MODE_NAMES[mode]||mode)+' ¬∑ Focused session';
      learnModeLabel.textContent=MODE_NAMES[mode]||mode;

      // Hide all panes first
      var allPanes=document.querySelectorAll('#learn-stage .learn-pane');
      for(var i=0;i<allPanes.length;i++){allPanes[i].classList.remove('active');}

      // Reset states
      learnFlashcardIndex=0;learnFlashcardFlipped=false;learnQuestionIndex=0;learnScore=0;
      orderedFlashcards=orderCardsByAlgo(selectedPack.flashcards||[]);
      fcSliding=false;

      // Activate only the selected mode pane
      if(mode==='flashcards'){
        document.getElementById('learn-pane-flashcards').classList.add('active');
        renderLearnFlashcard();
      }else if(mode==='test'){
        document.getElementById('learn-pane-test').classList.add('active');
        renderLearnQuestion();
      }else if(mode==='write'){
        document.getElementById('learn-pane-write').classList.add('active');
        initWriteMode();
      }else if(mode==='match'){
        document.getElementById('learn-pane-match').classList.add('active');
        initMatchMode();
      }else{
        // Fallback: notes
        document.getElementById('learn-pane-notes').classList.add('active');
        learnNotesContent.innerHTML=mdToHtml(selectedPack.notes_markdown||'');
      }

      updateLearnProgressBar();
      learnStage.classList.add('entering');
      requestAnimationFrame(function(){requestAnimationFrame(function(){learnStage.classList.replace('entering','visible');});});
      if(requestFullscreen){
        try{document.documentElement.requestFullscreen();}catch(e){}
      }
    }

    function closeLearnStage(){
      learnStage.classList.remove('visible');
      orderedFlashcards=[];
      stopMatchTimer();
      activeLearnMode='';
      if(document.fullscreenElement){try{document.exitFullscreen();}catch(e){}}
    }

    /* ‚îÄ‚îÄ Folder modal (careful with ternaries) ‚îÄ‚îÄ */
    function openFolderModal(mode,folder){
      folderModalMode=mode;
      editingFolderId=(folder&&folder.folder_id)?(folder.folder_id):'';
      folderModalTitle.textContent=(mode==='edit')?'Edit Folder':'Create Folder';
      folderNameInput.value=folder?(folder.name||''):'';
      folderCourseInput.value=folder?(folder.course||''):'';
      folderSubjectInput.value=folder?(folder.subject||''):'';
      folderSemesterInput.value=folder?(folder.semester||''):'';
      folderBlockInput.value=folder?(folder.block||''):'';
      openModal(folderModalOverlay);
      setTimeout(function(){folderNameInput.focus();},100);
    }
    function closeFolderModal(){
      closeModal(folderModalOverlay);
      folderModalMode='create';editingFolderId='';
      folderNameInput.value='';folderCourseInput.value='';
      folderSubjectInput.value='';folderSemesterInput.value='';
      folderBlockInput.value='';
    }
    function saveFolderFromModal(){
      var payload={name:folderNameInput.value.trim(),course:folderCourseInput.value.trim(),subject:folderSubjectInput.value.trim(),semester:folderSemesterInput.value.trim(),block:folderBlockInput.value.trim()};
      if(!payload.name){showToast('Folder name is required.','error');folderNameInput.focus();return;}
      var promise;
      if(folderModalMode==='edit'&&editingFolderId){
        promise=apiCall('/api/study-folders/'+encodeURIComponent(editingFolderId),{method:'PATCH',body:JSON.stringify(payload)}).then(function(){showToast('Folder updated.');});
      }else{
        promise=apiCall('/api/study-folders',{method:'POST',body:JSON.stringify(payload)}).then(function(){showToast('Folder created.');});
      }
      promise.then(function(){closeFolderModal();return loadData(selectedPackId||pendingOpenPackId);}).catch(function(e){showToast(e.message||'Could not save folder.','error');});
    }

    /* ‚îÄ‚îÄ Open pack ‚îÄ‚îÄ */
    function openPack(packId){
      return apiCall('/api/study-packs/'+encodeURIComponent(packId)).then(function(data){
        selectedPack=data;
        selectedPack.flashcards=Array.isArray(selectedPack.flashcards)?selectedPack.flashcards:[];
        selectedPack.test_questions=Array.isArray(selectedPack.test_questions)?selectedPack.test_questions.map(normalizeQuestion):[];
        showPackEditor(true);updatePackSummary();
        packTitle.value=selectedPack.title||'';
        setPackFolderSelection(selectedPack.folder_id||'');
        packCourse.value=selectedPack.course||'';
        packSubject.value=selectedPack.subject||'';
        packSemester.value=selectedPack.semester||'';
        packBlock.value=selectedPack.block||'';
        notesView.innerHTML=mdToHtml(selectedPack.notes_markdown||'');
        renderFlashcardEditor();renderQuestionEditor();
        setEditorPane(activeEditorPane);
        // Deep link: auto-open learn mode if URL says so
        if(openLearnFromUrl&&!autoLearnConsumed&&selectedPack.study_pack_id===learnPackFromUrl){
          autoLearnConsumed=true;
          var preferMode=focusFromUrl||'';
          if(preferMode&&['flashcards','test','write','match'].indexOf(preferMode)>=0){
            openLearnStageWithMode(preferMode,fullscreenFromUrl);
          }else{
            openSessionSetup();
          }
        }
      });
    }

    /* ‚îÄ‚îÄ Load data ‚îÄ‚îÄ */
    function loadData(preferredPackId){
      var prefId=preferredPackId||'';
      return Promise.all([apiCall('/api/study-folders'),apiCall('/api/study-packs')]).then(function(results){
        folders=results[0].folders||[];packs=results[1].study_packs||[];
        renderFolderSelect();renderFolders();renderPacks();
        var packToOpen=prefId||selectedPackId||'';
        if(packToOpen&&packs.find(function(item){return item.study_pack_id===packToOpen;})){
          selectedPackId=packToOpen;renderPacks();return openPack(packToOpen);
        }else if(learnPackFromUrl&&packs.find(function(item){return item.study_pack_id===learnPackFromUrl;})){
          selectedPackId=learnPackFromUrl;renderPacks();return openPack(learnPackFromUrl);
        }else{
          selectedPack=null;showPackEditor(false);updatePackSummary();
        }
      });
    }

    /* ‚îÄ‚îÄ Auth ‚îÄ‚îÄ */
    auth.onAuthStateChanged(function(user){
      if(!user){
        token=null;
        if(builderOverlay.classList.contains('visible')){
          markBuilderDirty(false);
          closeBuilderOverlay();
        }
        userMeta.textContent='Not signed in';
        authBtn.textContent='Sign in';
        return;
      }
      user.getIdToken().then(function(t){
        token=t;
        userMeta.textContent='Signed in as '+user.email;
        authBtn.textContent='Sign out';
        return loadData();
      }).catch(function(e){
        showToast(e.message||'Could not load study library.','error');
      });
    });

    /* ‚îÄ‚îÄ Event listeners ‚îÄ‚îÄ */
    authBtn.addEventListener('click',function(){
      if(!auth.currentUser){window.location.href='/dashboard';return;}
      auth.signOut();
    });
    createPackBtn.addEventListener('click',function(){
      if(!auth.currentUser){
        showToast('Please sign in first.','error');
        return;
      }
      openBuilderOverlay('create',null);
    });
    openBuilderBtn.addEventListener('click',function(){
      if(!auth.currentUser){
        showToast('Please sign in first.','error');
        return;
      }
      if(!selectedPack){
        showToast('Select a study pack first.','error');
        return;
      }
      openBuilderOverlay('edit',selectedPack);
    });
    builderSaveBtn.addEventListener('click',function(){
      saveBuilderPack(false);
    });
    builderExitBtn.addEventListener('click',function(){
      handleBuilderExitRequest();
    });
    builderPaneButtons.forEach(function(button){
      button.addEventListener('click',function(){
        setBuilderPane(button.dataset.builderPane);
      });
    });
    builderOpenLearnShortcut.addEventListener('click',function(){
      if(builderDirty){
        showToast('Save changes before opening Learn mode.','error');
        return;
      }
      if(!builderPackId){
        showToast('Save this new pack first.','error');
        return;
      }
      openPack(builderPackId).then(function(){
        closeBuilderOverlay();
        openSessionSetup();
      });
    });
    builderTitleInput.addEventListener('input',function(){
      if(!builderDraft){return;}
      builderDraft.title=builderTitleInput.value;
      builderBrandSub.textContent='Editing '+(builderDraft.title||'Untitled pack');
      markBuilderDirty(true);
    });
    builderFolderSelect.addEventListener('change',function(){
      if(!builderDraft){return;}
      builderDraft.folder_id=builderFolderSelect.value||'';
      markBuilderDirty(true);
    });
    builderCourseInput.addEventListener('input',function(){if(builderDraft){builderDraft.course=builderCourseInput.value;markBuilderDirty(true);}});
    builderSubjectInput.addEventListener('input',function(){if(builderDraft){builderDraft.subject=builderSubjectInput.value;markBuilderDirty(true);}});
    builderSemesterInput.addEventListener('input',function(){if(builderDraft){builderDraft.semester=builderSemesterInput.value;markBuilderDirty(true);}});
    builderBlockInput.addEventListener('input',function(){if(builderDraft){builderDraft.block=builderBlockInput.value;markBuilderDirty(true);}});
    builderNotesInput.addEventListener('input',function(){if(builderDraft){builderDraft.notes_markdown=builderNotesInput.value;markBuilderDirty(true);}});
    builderAddCardBtn.addEventListener('click',function(){
      if(!builderDraft){return;}
      builderDraft.flashcards.push({front:'',back:''});
      renderBuilderFlashcards();
      markBuilderDirty(true);
    });
    builderAddCardBatchBtn.addEventListener('click',function(){
      if(!builderDraft){return;}
      for(var i=0;i<5;i++){builderDraft.flashcards.push({front:'',back:''});}
      renderBuilderFlashcards();
      markBuilderDirty(true);
    });
    builderAddQuestionBtn.addEventListener('click',function(){
      if(!builderDraft){return;}
      builderDraft.test_questions.push(createDefaultQuestion());
      renderBuilderQuestions();
      markBuilderDirty(true);
    });
    builderAddQuestionBatchBtn.addEventListener('click',function(){
      if(!builderDraft){return;}
      for(var i=0;i<3;i++){builderDraft.test_questions.push(createDefaultQuestion());}
      renderBuilderQuestions();
      markBuilderDirty(true);
    });
    builderFlashcardList.addEventListener('input',function(event){
      if(!builderDraft){return;}
      var target=event.target;
      if(target.matches('[data-fc-field]')){
        var index=parseInt(target.dataset.fcIndex,10);
        var field=target.dataset.fcField;
        if(builderDraft.flashcards[index]){
          builderDraft.flashcards[index][field]=target.value;
          markBuilderDirty(true);
        }
      }
    });
    builderFlashcardList.addEventListener('click',function(event){
      if(!builderDraft){return;}
      var button=event.target.closest('[data-delete-fc]');
      if(!button){return;}
      var index=parseInt(button.dataset.deleteFc,10);
      builderDraft.flashcards.splice(index,1);
      renderBuilderFlashcards();
      markBuilderDirty(true);
    });
    builderQuestionList.addEventListener('input',function(event){
      if(!builderDraft){return;}
      var target=event.target;
      if(target.matches('[data-q-field]')){
        var index=parseInt(target.dataset.qIndex,10);
        var field=target.dataset.qField;
        if(builderDraft.test_questions[index]){
          builderDraft.test_questions[index][field]=target.value;
          markBuilderDirty(true);
        }
      }else if(target.matches('[data-q-option]')){
        var qIndex=parseInt(target.dataset.qIndex,10);
        var optIndex=parseInt(target.dataset.qOption,10);
        var question=builderDraft.test_questions[qIndex];
        if(question){
          question.options[optIndex]=target.value;
          if(question.options.indexOf(question.answer)<0){
            question.answer=question.options[0]||'';
          }
          renderBuilderQuestions();
          markBuilderDirty(true);
        }
      }
    });
    builderQuestionList.addEventListener('change',function(event){
      if(!builderDraft){return;}
      var target=event.target;
      if(target.matches('[data-q-answer]')){
        var index=parseInt(target.dataset.qAnswer,10);
        if(builderDraft.test_questions[index]){
          builderDraft.test_questions[index].answer=target.value;
          markBuilderDirty(true);
        }
      }
    });
    builderQuestionList.addEventListener('click',function(event){
      if(!builderDraft){return;}
      var button=event.target.closest('[data-delete-q]');
      if(!button){return;}
      var index=parseInt(button.dataset.deleteQ,10);
      builderDraft.test_questions.splice(index,1);
      renderBuilderQuestions();
      markBuilderDirty(true);
    });
    builderImportType.addEventListener('change',clearBuilderImportState);
    builderCsvDrop.addEventListener('click',function(){builderCsvInput.click();});
    builderCsvDrop.addEventListener('dragover',function(event){
      event.preventDefault();
      builderCsvDrop.classList.add('dragover');
    });
    builderCsvDrop.addEventListener('dragleave',function(){
      builderCsvDrop.classList.remove('dragover');
    });
    builderCsvDrop.addEventListener('drop',function(event){
      event.preventDefault();
      builderCsvDrop.classList.remove('dragover');
      var files=event.dataTransfer&&event.dataTransfer.files;
      if(files&&files[0]){handleBuilderCsvFile(files[0]);}
    });
    builderCsvInput.addEventListener('change',function(){
      if(builderCsvInput.files&&builderCsvInput.files[0]){
        handleBuilderCsvFile(builderCsvInput.files[0]);
      }
    });
    builderApplyImportBtn.addEventListener('click',applyBuilderImport);
    builderTemplateBtn.addEventListener('click',downloadBuilderTemplate);
    builderExitSave.addEventListener('click',function(){closeBuilderExitModal('save');});
    builderExitDiscard.addEventListener('click',function(){closeBuilderExitModal('discard');});
    builderExitCancel.addEventListener('click',function(){closeBuilderExitModal('cancel');});
    builderExitOverlay.addEventListener('click',function(event){
      if(event.target===builderExitOverlay){closeBuilderExitModal('cancel');}
    });
    window.addEventListener('beforeunload',function(event){
      if(builderDirty&&builderOverlay.classList.contains('visible')){
        event.preventDefault();
        event.returnValue='';
      }
    });
    backAppBtn.addEventListener('click',function(){window.location.href='/dashboard';});
    fullscreenBtn.addEventListener('click',function(){
      if(!selectedPack){showToast('Select a study pack first.','error');return;}
      openSessionSetup();
    });
    searchInput.addEventListener('input',renderPacks);
    packFolderButton.addEventListener('click',function(e){
      e.stopPropagation();
      packFolderMenu.classList.toggle('visible');
      packFolderButton.classList.toggle('open',packFolderMenu.classList.contains('visible'));
    });
    newFolderBtn.addEventListener('click',function(){openFolderModal('create',null);});

    deleteFolderBtn.addEventListener('click',function(){
      if(!selectedFolderId){showToast('Select a folder first.','error');return;}
      openConfirmModal('Delete Folder','Delete this folder? Packs inside will move to no folder.','Delete Folder').then(function(confirmed){
        if(!confirmed)return;
        apiCall('/api/study-folders/'+encodeURIComponent(selectedFolderId),{method:'DELETE'}).then(function(){
          selectedFolderId='';showToast('Folder deleted.');return loadData(selectedPackId);
        }).catch(function(e){showToast(e.message||'Could not delete folder.','error');});
      });
    });

    savePackBtn.addEventListener('click',function(){
      if(!selectedPackId||!selectedPack){showToast('Select a study pack first.','error');return;}
      apiCall('/api/study-packs/'+encodeURIComponent(selectedPackId),{
        method:'PATCH',
        body:JSON.stringify({title:packTitle.value.trim(),folder_id:packFolderSelect.value,course:packCourse.value.trim(),subject:packSubject.value.trim(),semester:packSemester.value.trim(),block:packBlock.value.trim(),flashcards:selectedPack.flashcards||[],test_questions:selectedPack.test_questions||[]})
      }).then(function(){
        pendingOpenPackId=selectedPackId;
        return loadData(selectedPackId);
      }).then(function(){
        pendingOpenPackId='';showToast('Study pack saved.');
      }).catch(function(e){showToast(e.message||'Could not save study pack.','error');});
    });

    deletePackBtn.addEventListener('click',function(){
      if(!selectedPackId){showToast('Select a study pack first.','error');return;}
      openConfirmModal('Delete Study Pack','Delete this study pack permanently? This cannot be undone.','Delete Pack').then(function(confirmed){
        if(!confirmed)return;
        apiCall('/api/study-packs/'+encodeURIComponent(selectedPackId),{method:'DELETE'}).then(function(){
          selectedPackId='';selectedPack=null;showPackEditor(false);updatePackSummary();
          return loadData();
        }).then(function(){showToast('Study pack deleted.');}).catch(function(e){showToast(e.message||'Could not delete study pack.','error');});
      });
    });

    exportPackCsvBtn.addEventListener('click',function(){
      if(!selectedPackId){showToast('Select a study pack first.','error');return;}
      downloadStudyPackCsv(selectedPackId,exportType).then(function(){showToast('CSV export started.');}).catch(function(e){showToast(e.message||'Could not export CSV.','error');});
    });

    openLearnBtn.addEventListener('click',function(){openSessionSetup();});
    editorTabs.forEach(function(btn){btn.addEventListener('click',function(){setEditorPane(btn.dataset.editorPane);});});

    addFlashcardBtn.addEventListener('click',function(){
      if(!selectedPack)return;
      selectedPack.flashcards=selectedPack.flashcards||[];
      selectedPack.flashcards.push({front:'New concept',back:'New explanation'});
      var ni=selectedPack.flashcards.length-1;
      learnFlashcardIndex=ni;learnFlashcardFlipped=false;
      renderFlashcardEditor(ni);setEditorPane('flashcards');
      showToast('New flashcard added.');
    });

    addQuestionBtn.addEventListener('click',function(){
      if(!selectedPack)return;
      selectedPack.test_questions=selectedPack.test_questions||[];
      selectedPack.test_questions.push(normalizeQuestion({question:'New question',options:['Option A','Option B','Option C','Option D'],answer:'Option A',explanation:'Add explanation here.'}));
      var ni=selectedPack.test_questions.length-1;
      learnQuestionIndex=ni;
      renderQuestionEditor(ni);setEditorPane('test');
      showToast('New practice question added.');
    });

    learnBackAppBtn.addEventListener('click',function(){window.location.href='/dashboard';});
    learnBackLibraryBtn.addEventListener('click',closeLearnStage);
    learnFullscreenBtn.addEventListener('click',function(){
      try{
        if(document.fullscreenElement){document.exitFullscreen();}
        else{document.documentElement.requestFullscreen();}
      }catch(e){showToast('Fullscreen not available.','error');}
    });

    /* Flashcard controls */
    learnFlashcard3d.addEventListener('click',function(){
      if(fcSliding)return;
      learnFlashcardFlipped=!learnFlashcardFlipped;
      markCardSeen('fc_'+learnFlashcardIndex,true);
      renderLearnFlashcard();
    });
    learnFPrev.addEventListener('click',function(){doFlashcardSlide('prev');});
    learnFNext.addEventListener('click',function(){doFlashcardSlide('next');});
    learnFFlip.addEventListener('click',function(){
      if(fcSliding)return;
      learnFlashcardFlipped=!learnFlashcardFlipped;
      markCardSeen('fc_'+learnFlashcardIndex,true);
      renderLearnFlashcard();
    });

    /* Quiz next */
    learnQNext.addEventListener('click',function(){
      var questions=selectedPack&&selectedPack.test_questions?selectedPack.test_questions:[];
      if(!questions.length)return;
      if(learnQuestionIndex<questions.length-1){learnQuestionIndex++;renderLearnQuestion();}
      else{showToast('All questions completed!');}
    });

    /* Keyboard shortcuts */
    window.addEventListener('keydown',function(e){
      if(builderOverlay.classList.contains('visible')&&e.key==='Escape'){
        e.preventDefault();
        handleBuilderExitRequest();
        return;
      }
      if(!learnStage.classList.contains('visible'))return;
      if(activeLearnMode==='flashcards'){
        if(e.key==='ArrowLeft'){e.preventDefault();doFlashcardSlide('prev');}
        if(e.key==='ArrowRight'){e.preventDefault();doFlashcardSlide('next');}
        if(e.code==='Space'){e.preventDefault();learnFFlip.click();}
      }
    });

    /* Folder modal events */
    folderModalClose.addEventListener('click',closeFolderModal);
    folderModalCancel.addEventListener('click',closeFolderModal);
    folderModalSave.addEventListener('click',saveFolderFromModal);
    folderModalOverlay.addEventListener('click',function(e){if(e.target===folderModalOverlay){closeFolderModal();}});

    /* Close dropdowns on outside click */
    document.addEventListener('click',function(e){
      if(!packFolderPicker.contains(e.target)){packFolderMenu.classList.remove('visible');packFolderButton.classList.remove('open');}
      if(!e.target.closest('.q-answer-picker')){
        questionEditorList.querySelectorAll('[data-answer-menu]').forEach(function(m){m.classList.remove('visible');});
        questionEditorList.querySelectorAll('[data-answer-button]').forEach(function(b){b.classList.remove('open');});
      }
    });

    /* Confirm modal events */
    confirmModalClose.addEventListener('click',function(){closeConfirmModal(false);});
    confirmModalCancel.addEventListener('click',function(){closeConfirmModal(false);});
    confirmModalConfirm.addEventListener('click',function(){closeConfirmModal(true);});
    confirmModalOverlay.addEventListener('click',function(e){if(e.target===confirmModalOverlay){closeConfirmModal(false);}});
  </script>
</body>
</html>


===== templates/features.html =====
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Features - LectureProcessor</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
  <style>
    :root {
      --primary:#4F46E5;--primary-dark:#4338CA;--primary-light:#818CF8;--secondary:#0EA5E9;
      --success:#10B981;--warning:#F59E0B;--error:#EF4444;
      --gray-50:#F9FAFB;--gray-100:#F3F4F6;--gray-200:#E5E7EB;--gray-300:#D1D5DB;
      --gray-400:#9CA3AF;--gray-500:#6B7280;--gray-600:#4B5563;--gray-700:#374151;
      --gray-800:#1F2937;--gray-900:#111827;--white:#FFFFFF;
      --shadow-sm:0 1px 2px 0 rgb(0 0 0/.05);
      --shadow:0 1px 3px 0 rgb(0 0 0/.1),0 1px 2px -1px rgb(0 0 0/.1);
      --shadow-md:0 4px 6px -1px rgb(0 0 0/.1),0 2px 4px -2px rgb(0 0 0/.1);
      --shadow-lg:0 10px 15px -3px rgb(0 0 0/.1),0 4px 6px -4px rgb(0 0 0/.1);
      --shadow-xl:0 20px 25px -5px rgb(0 0 0/.1),0 8px 10px -6px rgb(0 0 0/.1);
      --radius-sm:6px;--radius:8px;--radius-md:12px;--radius-lg:16px;--radius-xl:24px;
    }
    *,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
    html{scroll-behavior:smooth}
    body{font-family:'Inter',-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:var(--white);color:var(--gray-800);line-height:1.6;-webkit-font-smoothing:antialiased}

    /* -- Nav -- */
    .nav{position:fixed;top:0;left:0;right:0;z-index:100;background:rgba(255,255,255,.92);backdrop-filter:blur(16px);-webkit-backdrop-filter:blur(16px);border-bottom:1px solid var(--gray-200)}
    .nav-inner{max-width:1200px;margin:0 auto;padding:0 24px;height:64px;display:flex;align-items:center;justify-content:space-between}
    .nav-logo{display:flex;align-items:center;gap:10px;text-decoration:none;color:var(--gray-900)}
    .nav-logo-icon{width:34px;height:34px;background:linear-gradient(135deg,var(--primary),var(--secondary));border-radius:var(--radius);display:flex;align-items:center;justify-content:center;color:var(--white)}
    .nav-logo-icon svg{width:20px;height:20px}
    .nav-logo-text{font-size:1.05rem;font-weight:800;letter-spacing:-.03em}
    .nav-links{display:flex;align-items:center;gap:6px}
    .nav-link{text-decoration:none;padding:8px 14px;font-size:.875rem;font-weight:600;color:var(--gray-600);border-radius:var(--radius);transition:all .2s ease}
    .nav-link:hover{color:var(--gray-900);background:var(--gray-50)}
    .nav-link.active{color:var(--primary);background:rgba(79,70,229,.06)}
    .nav-cta{display:inline-flex;align-items:center;gap:6px;padding:8px 18px;font-size:.875rem;font-weight:700;color:var(--white);background:linear-gradient(135deg,var(--primary),var(--primary-dark));border:none;border-radius:var(--radius);cursor:pointer;text-decoration:none;transition:all .2s ease;box-shadow:0 2px 8px rgba(79,70,229,.25)}
    .nav-cta:hover{transform:translateY(-1px);box-shadow:0 4px 16px rgba(79,70,229,.35)}
    .nav-cta svg{width:15px;height:15px}
    @media(max-width:600px){.nav-links{gap:2px}.nav-link{padding:6px 8px;font-size:.78rem}.nav-cta{padding:7px 12px;font-size:.8rem}}

    /* -- Sections -- */
    .section{padding:100px 24px}
    .section:first-of-type{padding-top:140px}
    .section-inner{max-width:1100px;margin:0 auto}
    .section-alt{background:linear-gradient(180deg,var(--gray-50),var(--white))}
    .section-dark{background:linear-gradient(135deg,var(--gray-900),#1a1a2e);color:var(--white)}

    /* -- Hero -- */
    .hero{text-align:center;padding-top:140px;padding-bottom:80px}
    .hero-badge{display:inline-flex;align-items:center;gap:6px;background:rgba(79,70,229,.08);border:1px solid rgba(79,70,229,.2);color:var(--primary);padding:6px 16px;border-radius:30px;font-size:.8rem;font-weight:700;margin-bottom:24px}
    .hero-badge svg{width:14px;height:14px}
    .hero h1{font-size:clamp(2.2rem,5.5vw,3.8rem);font-weight:900;line-height:1.1;letter-spacing:-.04em;color:var(--gray-900);margin-bottom:20px}
    .hero h1 .gradient{background:linear-gradient(135deg,var(--primary),var(--secondary));-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
    .hero-sub{font-size:clamp(1rem,2vw,1.25rem);color:var(--gray-500);max-width:640px;margin:0 auto 36px;line-height:1.65}
    .hero-actions{display:flex;gap:12px;justify-content:center;flex-wrap:wrap}
    .hero-btn{display:inline-flex;align-items:center;gap:8px;padding:14px 32px;border-radius:var(--radius-md);font-size:1rem;font-weight:700;cursor:pointer;transition:all .25s ease;text-decoration:none;border:none}
    .hero-btn.primary{background:linear-gradient(135deg,var(--primary),var(--primary-dark));color:var(--white);box-shadow:0 4px 20px rgba(79,70,229,.35)}
    .hero-btn.primary:hover{transform:translateY(-2px);box-shadow:0 8px 30px rgba(79,70,229,.45)}
    .hero-btn.secondary{background:var(--white);color:var(--gray-700);border:1px solid var(--gray-300);box-shadow:var(--shadow)}
    .hero-btn.secondary:hover{border-color:var(--gray-400);box-shadow:var(--shadow-md);transform:translateY(-1px)}
    .hero-btn svg{width:18px;height:18px}
    .hero-stat-row{display:flex;justify-content:center;gap:40px;margin-top:48px;flex-wrap:wrap}
    .hero-stat{text-align:center}
    .hero-stat-num{font-size:1.8rem;font-weight:900;color:var(--gray-900);letter-spacing:-.03em}
    .hero-stat-label{font-size:.8rem;color:var(--gray-500);font-weight:600}

    /* -- Workflow -- */
    .workflow-title{text-align:center;margin-bottom:60px}
    .workflow-title h2{font-size:clamp(1.6rem,3.5vw,2.4rem);font-weight:800;color:var(--gray-900);letter-spacing:-.03em;margin-bottom:12px}
    .workflow-title p{font-size:1.05rem;color:var(--gray-500);max-width:520px;margin:0 auto}
    .workflow-steps{display:grid;grid-template-columns:repeat(5,1fr);gap:0;position:relative}
    .workflow-step{display:flex;flex-direction:column;align-items:center;text-align:center;padding:0 12px;position:relative}
    .workflow-step-num{width:48px;height:48px;border-radius:50%;background:linear-gradient(135deg,var(--primary),var(--secondary));color:var(--white);font-size:1.1rem;font-weight:800;display:flex;align-items:center;justify-content:center;margin-bottom:16px;position:relative;z-index:2;box-shadow:0 4px 14px rgba(79,70,229,.3)}
    .workflow-step-icon{width:56px;height:56px;border-radius:var(--radius-md);background:var(--gray-50);border:1px solid var(--gray-200);display:flex;align-items:center;justify-content:center;margin-bottom:12px;color:var(--primary)}
    .workflow-step-icon svg{width:26px;height:26px}
    .workflow-step h3{font-size:.95rem;font-weight:700;color:var(--gray-900);margin-bottom:4px}
    .workflow-step p{font-size:.82rem;color:var(--gray-500);line-height:1.5}
    .workflow-connector{position:absolute;top:24px;left:calc(50% + 24px);right:calc(-50% + 24px);height:2px;background:linear-gradient(90deg,var(--primary-light),var(--secondary));z-index:1}
    .workflow-step:last-child .workflow-connector{display:none}
    @media(max-width:800px){
      .workflow-steps{grid-template-columns:1fr;gap:32px}
      .workflow-connector{display:none}
    }

    /* -- Feature groups -- */
    .fg-header{text-align:center;margin-bottom:48px}
    .fg-header h2{font-size:clamp(1.6rem,3.5vw,2.4rem);font-weight:800;color:var(--gray-900);letter-spacing:-.03em;margin-bottom:12px}
    .fg-header p{font-size:1.05rem;color:var(--gray-500);max-width:560px;margin:0 auto}
    .fg-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:20px}
    @media(max-width:700px){.fg-grid{grid-template-columns:1fr}}
    .fg-card{border:1px solid var(--gray-200);border-radius:var(--radius-lg);padding:28px;background:var(--white);transition:all .3s ease;position:relative;overflow:hidden}
    .fg-card:hover{border-color:var(--gray-300);box-shadow:var(--shadow-lg);transform:translateY(-3px)}
    .fg-card::before{content:'';position:absolute;top:0;left:0;right:0;height:3px;background:linear-gradient(90deg,var(--primary),var(--secondary));opacity:0;transition:opacity .3s ease}
    .fg-card:hover::before{opacity:1}
    .fg-card-icon{width:48px;height:48px;border-radius:var(--radius-md);display:flex;align-items:center;justify-content:center;margin-bottom:16px;flex-shrink:0}
    .fg-card-icon svg{width:24px;height:24px}
    .fg-card-icon.purple{background:rgba(79,70,229,.1);color:var(--primary)}
    .fg-card-icon.blue{background:rgba(14,165,233,.1);color:var(--secondary)}
    .fg-card-icon.green{background:rgba(16,185,129,.1);color:var(--success)}
    .fg-card-icon.amber{background:rgba(245,158,11,.1);color:var(--warning)}
    .fg-card h3{font-size:1.05rem;font-weight:700;color:var(--gray-900);margin-bottom:6px}
    .fg-card p{font-size:.88rem;color:var(--gray-500);line-height:1.6}

    /* -- Study modes showcase -- */
    .modes-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:16px}
    @media(max-width:900px){.modes-grid{grid-template-columns:repeat(2,1fr)}}
    @media(max-width:500px){.modes-grid{grid-template-columns:1fr}}
    .mode-card{border:1px solid var(--gray-200);border-radius:var(--radius-lg);padding:24px 20px;text-align:center;background:var(--white);transition:all .3s ease;position:relative;overflow:hidden}
    .mode-card:hover{border-color:var(--primary-light);box-shadow:0 8px 30px rgba(79,70,229,.12);transform:translateY(-4px)}
    .mode-card-icon{width:56px;height:56px;border-radius:50%;margin:0 auto 14px;display:flex;align-items:center;justify-content:center}
    .mode-card-icon svg{width:28px;height:28px;color:var(--white)}
    .mode-card-icon.mc-purple{background:linear-gradient(135deg,var(--primary),var(--primary-dark))}
    .mode-card-icon.mc-blue{background:linear-gradient(135deg,#38BDF8,#0EA5E9)}
    .mode-card-icon.mc-green{background:linear-gradient(135deg,#34D399,#10B981)}
    .mode-card-icon.mc-amber{background:linear-gradient(135deg,#FBBF24,#F59E0B)}
    .mode-card h3{font-size:.95rem;font-weight:700;color:var(--gray-900);margin-bottom:4px}
    .mode-card p{font-size:.82rem;color:var(--gray-500);line-height:1.5}
    .mode-card-tag{display:inline-block;margin-top:10px;font-size:.7rem;font-weight:700;text-transform:uppercase;letter-spacing:.05em;padding:3px 10px;border-radius:20px}
    .mode-card-tag.tag-new{background:rgba(79,70,229,.1);color:var(--primary)}
    .mode-card-tag.tag-popular{background:rgba(16,185,129,.1);color:var(--success)}

    /* -- Time calculator -- */
    .calc-wrap{max-width:680px;margin:0 auto;text-align:center}
    .calc-card{background:var(--white);border:1px solid var(--gray-200);border-radius:var(--radius-xl);padding:40px;box-shadow:var(--shadow-lg)}
    .calc-card h3{font-size:1.1rem;font-weight:700;color:var(--gray-900);margin-bottom:20px}
    .calc-slider-row{display:flex;align-items:center;gap:16px;margin-bottom:8px}
    .calc-slider-label{font-size:.85rem;color:var(--gray-600);font-weight:600;min-width:180px;text-align:right}
    .calc-slider{flex:1;-webkit-appearance:none;appearance:none;height:6px;border-radius:3px;background:var(--gray-200);outline:none;cursor:pointer}
    .calc-slider::-webkit-slider-thumb{-webkit-appearance:none;width:22px;height:22px;border-radius:50%;background:linear-gradient(135deg,var(--primary),var(--secondary));cursor:pointer;box-shadow:0 2px 8px rgba(79,70,229,.3)}
    .calc-slider-val{min-width:40px;font-size:.95rem;font-weight:700;color:var(--gray-900);text-align:left}
    .calc-divider{height:1px;background:var(--gray-200);margin:24px 0}
    .calc-result{display:flex;justify-content:center;gap:40px;flex-wrap:wrap}
    .calc-result-item{text-align:center}
    .calc-result-num{font-size:2.2rem;font-weight:900;letter-spacing:-.03em}
    .calc-result-num.highlight{background:linear-gradient(135deg,var(--primary),var(--secondary));-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
    .calc-result-label{font-size:.78rem;color:var(--gray-500);font-weight:600;margin-top:2px}

    /* -- Comparison table -- */
    .comparison{max-width:780px;margin:0 auto}
    .comparison-table{width:100%;border-collapse:collapse;border-radius:var(--radius-lg);overflow:hidden;box-shadow:var(--shadow-lg)}
    .comparison-table th,.comparison-table td{padding:16px 20px;text-align:left;font-size:.9rem}
    .comparison-table thead th{background:var(--gray-900);color:var(--white);font-weight:700;font-size:.82rem;text-transform:uppercase;letter-spacing:.05em}
    .comparison-table thead th:first-child{border-top-left-radius:var(--radius-md)}
    .comparison-table thead th:last-child{border-top-right-radius:var(--radius-md)}
    .comparison-table tbody tr{border-bottom:1px solid var(--gray-100)}
    .comparison-table tbody tr:nth-child(even){background:var(--gray-50)}
    .comparison-table tbody td{color:var(--gray-700)}
    .comparison-table .col-task{font-weight:600;color:var(--gray-900)}
    .comparison-table .col-manual{color:var(--error);font-weight:600}
    .comparison-table .col-lp{color:var(--success);font-weight:700}
    .comparison-table .col-lp svg{width:16px;height:16px;vertical-align:middle;margin-right:4px;color:var(--success)}

    /* -- CTA -- */
    .cta-section{text-align:center;padding:80px 24px 100px}
    .cta-card{max-width:700px;margin:0 auto;padding:60px 40px;background:linear-gradient(135deg,var(--primary),var(--primary-dark));border-radius:var(--radius-xl);box-shadow:0 20px 60px rgba(79,70,229,.3);position:relative;overflow:hidden}
    .cta-card::before{content:'';position:absolute;top:-50%;right:-30%;width:300px;height:300px;border-radius:50%;background:rgba(255,255,255,.06)}
    .cta-card::after{content:'';position:absolute;bottom:-40%;left:-20%;width:250px;height:250px;border-radius:50%;background:rgba(255,255,255,.04)}
    .cta-card h2{font-size:clamp(1.5rem,3vw,2rem);font-weight:800;color:var(--white);margin-bottom:12px;position:relative;z-index:1}
    .cta-card p{font-size:1.05rem;color:rgba(255,255,255,.8);margin-bottom:28px;position:relative;z-index:1}
    .cta-btn{display:inline-flex;align-items:center;gap:8px;padding:16px 36px;font-size:1.05rem;font-weight:700;border:none;border-radius:var(--radius-md);cursor:pointer;transition:all .25s ease;background:var(--white);color:var(--primary);text-decoration:none;position:relative;z-index:1;box-shadow:0 4px 20px rgba(0,0,0,.15)}
    .cta-btn:hover{transform:translateY(-2px);box-shadow:0 8px 30px rgba(0,0,0,.25)}
    .cta-btn svg{width:18px;height:18px}

    /* -- Footer -- */
    .footer{background:var(--gray-900);color:var(--gray-400);padding:40px 24px;text-align:center;font-size:.85rem}
    .footer a{color:var(--gray-300);text-decoration:none}
    .footer a:hover{color:var(--white)}

    /* -- Animations -- */
    .reveal{opacity:0;transform:translateY(30px);transition:all .6s ease-out}
    .reveal.visible{opacity:1;transform:translateY(0)}
    @media(prefers-reduced-motion:reduce){.reveal{opacity:1;transform:none;transition:none}}
  </style>
</head>
<body>
  <!-- Navigation -->
  <nav class="nav">
    <div class="nav-inner">
      <a href="/" class="nav-logo">
        <div class="nav-logo-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"></path><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"></path></svg></div>
        <span class="nav-logo-text">LectureProcessor</span>
      </a>
      <div class="nav-links">
        <a href="/" class="nav-link">Home</a>
        <a href="/features" class="nav-link active">Features</a>
        <a href="/dashboard" class="nav-cta" id="nav-auth-btn"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4"></path><polyline points="10 17 15 12 10 7"></polyline><line x1="15" y1="12" x2="3" y2="12"></line></svg><span id="nav-auth-label">Sign In</span></a>
      </div>
    </div>
  </nav>

  <!-- Hero -->
  <section class="section hero">
    <div class="section-inner">
      <div class="hero-badge"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"></polygon></svg> AI-Powered Study Platform</div>
      <h1>From Lecture to <span class="gradient">Mastery</span><br>in Minutes</h1>
      <p class="hero-sub">Stop wasting hours creating flashcards and study guides manually. Upload any lecture - audio, video, documents, or images - and get AI-generated notes, flashcards, practice tests, and interactive study modes instantly.</p>
      <div class="hero-actions">
        <a href="/dashboard" class="hero-btn primary"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="5 3 19 12 5 21 5 3"></polygon></svg> Start for Free</a>
        <a href="#workflow" class="hero-btn secondary"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg> See How It Works</a>
      </div>
      <div class="hero-stat-row reveal">
        <div class="hero-stat"><div class="hero-stat-num">5x</div><div class="hero-stat-label">Faster than manual notes</div></div>
        <div class="hero-stat"><div class="hero-stat-num">4</div><div class="hero-stat-label">Interactive study modes</div></div>
        <div class="hero-stat"><div class="hero-stat-num">100%</div><div class="hero-stat-label">AI-generated content</div></div>
      </div>
    </div>
  </section>

  <!-- Workflow -->
  <section class="section section-alt" id="workflow">
    <div class="section-inner">
      <div class="workflow-title reveal">
        <h2>Your Complete Study Pipeline</h2>
        <p>Five simple steps from raw lecture material to exam-ready confidence.</p>
      </div>
      <div class="workflow-steps reveal">
        <div class="workflow-step">
          <div class="workflow-step-num">1</div>
          <div class="workflow-step-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" y1="3" x2="12" y2="15"></line></svg></div>
          <h3>Upload</h3>
          <p>Drop in any audio, video, document, or image file from your lectures.</p>
          <div class="workflow-connector"></div>
        </div>
        <div class="workflow-step">
          <div class="workflow-step-num">2</div>
          <div class="workflow-step-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-4 0v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83-2.83l.06-.06A1.65 1.65 0 0 0 4.68 15a1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1 0-4h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 2.83-2.83l.06.06A1.65 1.65 0 0 0 9 4.68a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9c.26.6.77 1.05 1.37 1.22H21a2 2 0 0 1 0 4h-.09c-.6.17-1.11.62-1.37 1.22z"></path></svg></div>
          <h3>Process</h3>
          <p>AI transcribes, structures, and extracts key concepts automatically.</p>
          <div class="workflow-connector"></div>
        </div>
        <div class="workflow-step">
          <div class="workflow-step-num">3</div>
          <div class="workflow-step-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg></div>
          <h3>Generate</h3>
          <p>Get structured notes, flashcards, and practice tests in seconds.</p>
          <div class="workflow-connector"></div>
        </div>
        <div class="workflow-step">
          <div class="workflow-step-num">4</div>
          <div class="workflow-step-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="4" width="20" height="16" rx="2"></rect><line x1="2" y1="12" x2="22" y2="12"></line></svg></div>
          <h3>Study</h3>
          <p>Choose from four interactive study modes tailored to how you learn.</p>
          <div class="workflow-connector"></div>
        </div>
        <div class="workflow-step">
          <div class="workflow-step-num">5</div>
          <div class="workflow-step-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg></div>
          <h3>Master</h3>
          <p>Track progress with smart mastery algorithms and ace your exams.</p>
        </div>
      </div>
    </div>
  </section>

  <!-- Capture & Process -->
  <section class="section" id="capture">
    <div class="section-inner">
      <div class="fg-header reveal">
        <h2>Capture Any Lecture Format</h2>
        <p>No matter how your lecture is delivered, we process it into structured study material.</p>
      </div>
      <div class="fg-grid reveal">
        <div class="fg-card">
          <div class="fg-card-icon purple"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"></path><path d="M19 10v2a7 7 0 0 1-14 0v-2"></path><line x1="12" y1="19" x2="12" y2="23"></line><line x1="8" y1="23" x2="16" y2="23"></line></svg></div>
          <h3>Audio Recordings</h3>
          <p>Upload recorded lectures in any audio format. Our AI transcribes speech with high accuracy, then structures the content into organized study materials with key topics identified.</p>
        </div>
        <div class="fg-card">
          <div class="fg-card-icon blue"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="23 7 16 12 23 17 23 7"></polygon><rect x="1" y="5" width="15" height="14" rx="2" ry="2"></rect></svg></div>
          <h3>Video Lectures</h3>
          <p>From recorded seminars to screen-captured tutorials - extract the audio, transcribe it, and generate comprehensive study packs without watching the full video again.</p>
        </div>
        <div class="fg-card">
          <div class="fg-card-icon green"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line></svg></div>
          <h3>Documents &amp; PDFs</h3>
          <p>Upload lecture slides, textbook chapters, or handouts. The AI reads the content, identifies key concepts, and transforms dense text into digestible flashcards and practice questions.</p>
        </div>
        <div class="fg-card">
          <div class="fg-card-icon amber"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><circle cx="8.5" cy="8.5" r="1.5"></circle><polyline points="21 15 16 10 5 21"></polyline></svg></div>
          <h3>Images &amp; Photos</h3>
          <p>Snap a photo of a whiteboard, textbook page, or handwritten notes. OCR extracts the text, then AI transforms it into structured study material you can learn from interactively.</p>
        </div>
      </div>
    </div>
  </section>

  <!-- Study Modes -->
  <section class="section section-alt" id="modes">
    <div class="section-inner">
      <div class="fg-header reveal">
        <h2>Four Ways to Study, One Platform</h2>
        <p>Each study mode targets a different type of recall. Use them together for complete mastery.</p>
      </div>
      <div class="modes-grid reveal">
        <div class="mode-card">
          <div class="mode-card-icon mc-purple"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="4" width="20" height="16" rx="2"></rect><line x1="2" y1="12" x2="22" y2="12"></line></svg></div>
          <h3>Zen Cards</h3>
          <p>Distraction-free flashcards with smooth 3D flip animations. Navigate with keyboard shortcuts for fast-paced review sessions.</p>
          <span class="mode-card-tag tag-popular">Most Popular</span>
        </div>
        <div class="mode-card">
          <div class="mode-card-icon mc-blue"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 11l3 3L22 4"></path><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"></path></svg></div>
          <h3>Multiple Choice</h3>
          <p>AI-generated practice tests with instant feedback and explanations. Track your score as you progress through questions.</p>
          <span class="mode-card-tag tag-popular">Exam Prep</span>
        </div>
        <div class="mode-card">
          <div class="mode-card-icon mc-green"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 20h9"></path><path d="M16.5 3.5a2.12 2.12 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"></path></svg></div>
          <h3>Write</h3>
          <p>Type answers from memory with smart grading that respects your settings - case sensitivity, articles, brackets, and exact matching.</p>
          <span class="mode-card-tag tag-new">New</span>
        </div>
        <div class="mode-card">
          <div class="mode-card-icon mc-amber"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="7" height="7"></rect><rect x="14" y="3" width="7" height="7"></rect><rect x="3" y="14" width="7" height="7"></rect><rect x="14" y="14" width="7" height="7"></rect></svg></div>
          <h3>Match</h3>
          <p>Race the clock to pair terms with definitions. Compete against your own high scores with timed rounds on a 4x3 grid.</p>
          <span class="mode-card-tag tag-new">New</span>
        </div>
      </div>
    </div>
  </section>

  <!-- Smart Learning -->
  <section class="section" id="smart">
    <div class="section-inner">
      <div class="fg-header reveal">
        <h2>Smart Learning That Adapts to You</h2>
        <p>Our algorithm learns what you know and what you do not, so you spend time where it matters most.</p>
      </div>
      <div class="fg-grid reveal">
        <div class="fg-card">
          <div class="fg-card-icon purple"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg></div>
          <h3>Mastery Tracking</h3>
          <p>Every card you study is categorized as New, Familiar, or Mastered. Visual mastery rings give you instant clarity on where you stand before an exam - no guessing required.</p>
        </div>
        <div class="fg-card">
          <div class="fg-card-icon blue"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"></polyline></svg></div>
          <h3>5-Slot Algorithm Builder</h3>
          <p>Customize exactly how cards are selected for each session. Drag through five priority slots choosing from New, Familiar, Retry, Remaster, and Random - or pick a preset like Balanced or Fix Mistakes.</p>
        </div>
        <div class="fg-card">
          <div class="fg-card-icon green"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-4 0v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83-2.83l.06-.06A1.65 1.65 0 0 0 4.68 15a1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1 0-4h.09"></path></svg></div>
          <h3>Granular Session Settings</h3>
          <p>Fine-tune every session to your needs: swap question and answer sides, toggle case sensitivity, ignore articles and determiners, remove bracket content, or force exact matching for maximum rigor.</p>
        </div>
        <div class="fg-card">
          <div class="fg-card-icon amber"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 20V10"></path><path d="M12 20V4"></path><path d="M6 20v-6"></path></svg></div>
          <h3>Persistent Progress</h3>
          <p>Your mastery state, session settings, algorithm configuration, and high scores are all saved locally. Come back tomorrow and pick up exactly where you left off - no progress lost.</p>
        </div>
      </div>
    </div>
  </section>

  <!-- Organization -->
  <section class="section section-alt" id="organize">
    <div class="section-inner">
      <div class="fg-header reveal">
        <h2>Organize Your Entire Semester</h2>
        <p>Keep every lecture, course, and subject structured so nothing falls through the cracks.</p>
      </div>
      <div class="fg-grid reveal">
        <div class="fg-card">
          <div class="fg-card-icon purple"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path></svg></div>
          <h3>Folder System</h3>
          <p>Group study packs into folders by course, module, or topic. Drag and drop packs between folders to reorganize without losing any data or progress.</p>
        </div>
        <div class="fg-card">
          <div class="fg-card-icon blue"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="4" y1="9" x2="20" y2="9"></line><line x1="4" y1="15" x2="20" y2="15"></line><line x1="10" y1="3" x2="8" y2="21"></line><line x1="16" y1="3" x2="14" y2="21"></line></svg></div>
          <h3>Rich Metadata</h3>
          <p>Tag every pack and folder with course name, subject, semester, and block. Filter and search instantly across your entire library to find exactly what you need before an exam.</p>
        </div>
        <div class="fg-card">
          <div class="fg-card-icon green"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg></div>
          <h3>Search &amp; Filter</h3>
          <p>Instantly filter your entire study library by title, course, subject, or any metadata field. Find the right study pack in seconds, even with dozens of courses loaded.</p>
        </div>
        <div class="fg-card">
          <div class="fg-card-icon amber"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg></div>
          <h3>CSV Export</h3>
          <p>Export any set of flashcards or practice questions as a clean CSV file. Import into other tools, share with classmates, or print for offline study before exam day.</p>
        </div>
      </div>
    </div>
  </section>

  <!-- Time Calculator -->
  <section class="section" id="calculator">
    <div class="section-inner">
      <div class="fg-header reveal">
        <h2>See How Much Time You Save</h2>
        <p>Adjust the sliders to match your semester and see the real impact.</p>
      </div>
      <div class="calc-wrap reveal">
        <div class="calc-card">
          <h3>Your Study Time Calculator</h3>
          <div class="calc-slider-row">
            <span class="calc-slider-label">Lectures per week</span>
            <input type="range" class="calc-slider" id="calc-lectures" min="1" max="20" value="6">
            <span class="calc-slider-val" id="calc-lectures-val">6</span>
          </div>
          <div class="calc-slider-row">
            <span class="calc-slider-label">Weeks per semester</span>
            <input type="range" class="calc-slider" id="calc-weeks" min="4" max="30" value="15">
            <span class="calc-slider-val" id="calc-weeks-val">15</span>
          </div>
          <div class="calc-slider-row">
            <span class="calc-slider-label">Minutes per lecture (manual notes)</span>
            <input type="range" class="calc-slider" id="calc-minutes" min="10" max="90" value="40" step="5">
            <span class="calc-slider-val" id="calc-minutes-val">40</span>
          </div>
          <div class="calc-divider"></div>
          <div class="calc-result">
            <div class="calc-result-item">
              <div class="calc-result-num" id="calc-manual">60h</div>
              <div class="calc-result-label">Manual study prep</div>
            </div>
            <div class="calc-result-item">
              <div class="calc-result-num highlight" id="calc-lp">12h</div>
              <div class="calc-result-label">With LectureProcessor</div>
            </div>
            <div class="calc-result-item">
              <div class="calc-result-num highlight" id="calc-saved">48h</div>
              <div class="calc-result-label">Hours saved per semester</div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Comparison Table -->
  <section class="section section-alt" id="compare">
    <div class="section-inner">
      <div class="fg-header reveal">
        <h2>Manual Study Prep vs. LectureProcessor</h2>
        <p>A side-by-side look at the old way versus the smart way.</p>
      </div>
      <div class="comparison reveal">
        <table class="comparison-table">
          <thead>
            <tr>
              <th>Task</th>
              <th>Manual</th>
              <th>LectureProcessor</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td class="col-task">Transcribe a 1-hour lecture</td>
              <td class="col-manual">2 - 3 hours</td>
              <td class="col-lp"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg>2 - 3 minutes</td>
            </tr>
            <tr>
              <td class="col-task">Create structured notes</td>
              <td class="col-manual">30 - 60 minutes</td>
              <td class="col-lp"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg>Automatic</td>
            </tr>
            <tr>
              <td class="col-task">Build 30 flashcards</td>
              <td class="col-manual">45 - 90 minutes</td>
              <td class="col-lp"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg>Automatic</td>
            </tr>
            <tr>
              <td class="col-task">Write practice questions</td>
              <td class="col-manual">60+ minutes</td>
              <td class="col-lp"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg>Automatic</td>
            </tr>
            <tr>
              <td class="col-task">Organize by course/semester</td>
              <td class="col-manual">Manual filing</td>
              <td class="col-lp"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg>Built-in folders</td>
            </tr>
            <tr>
              <td class="col-task">Track mastery progress</td>
              <td class="col-manual">Not possible</td>
              <td class="col-lp"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg>Automatic tracking</td>
            </tr>
            <tr>
              <td class="col-task">Adaptive study algorithm</td>
              <td class="col-manual">Not possible</td>
              <td class="col-lp"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg>5-slot custom algo</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </section>

  <!-- CTA -->
  <section class="cta-section">
    <div class="cta-card reveal">
      <h2>Ready to Study Smarter?</h2>
      <p>Upload your first lecture and get AI-generated study materials in under 3 minutes. No credit card required.</p>
      <a href="/dashboard" class="cta-btn"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="5 3 19 12 5 21 5 3"></polygon></svg> Start Processing Lectures</a>
    </div>
  </section>

  <!-- Footer -->
  <footer class="footer">
    <p>LectureProcessor &middot; AI-powered study material generation &middot; <a href="/features">Features</a> &middot; <a href="/dashboard">Dashboard</a></p>
  </footer>

<script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth-compat.js"></script>
  <script>
    /* -- Firebase auth detection for nav -- */
    var firebaseConfig={apiKey:"AIzaSyBAAeEUCPNvP5qnqpP3M6HnFZ6vaaijUvM",authDomain:"lecture-processor-cdff6.firebaseapp.com",projectId:"lecture-processor-cdff6",storageBucket:"lecture-processor-cdff6.firebasestorage.app",messagingSenderId:"374793454161",appId:"1:374793454161:web:c68b21590e9a1fafa32e70"};
    firebase.initializeApp(firebaseConfig);
    var auth=firebase.auth();
    var navAuthBtn=document.getElementById('nav-auth-btn');
    var navAuthLabel=document.getElementById('nav-auth-label');

    auth.onAuthStateChanged(function(user){
      if(user){
        navAuthLabel.textContent='Dashboard';
        navAuthBtn.href='/dashboard';
      }else{
        navAuthLabel.textContent='Sign In';
        navAuthBtn.href='/dashboard';
      }
    });

    /* -- Time savings calculator -- */
    var calcLectures=document.getElementById('calc-lectures');
    var calcWeeks=document.getElementById('calc-weeks');
    var calcMinutes=document.getElementById('calc-minutes');
    var calcLecturesVal=document.getElementById('calc-lectures-val');
    var calcWeeksVal=document.getElementById('calc-weeks-val');
    var calcMinutesVal=document.getElementById('calc-minutes-val');
    var calcManual=document.getElementById('calc-manual');
    var calcLp=document.getElementById('calc-lp');
    var calcSaved=document.getElementById('calc-saved');

    function updateCalc(){
      var lectures=parseInt(calcLectures.value,10);
      var weeks=parseInt(calcWeeks.value,10);
      var minutes=parseInt(calcMinutes.value,10);
      calcLecturesVal.textContent=String(lectures);
      calcWeeksVal.textContent=String(weeks);
      calcMinutesVal.textContent=String(minutes);

      var totalLectures=lectures*weeks;
      var manualHours=Math.round((totalLectures*minutes)/60);
      // LectureProcessor estimate: ~3 min upload + ~2 min review per lecture
      var lpMinutesPerLecture=5;
      var lpHours=Math.round((totalLectures*lpMinutesPerLecture)/60);
      var saved=Math.max(0,manualHours-lpHours);

      calcManual.textContent=manualHours+'h';
      calcLp.textContent=lpHours+'h';
      calcSaved.textContent=saved+'h';
    }

    calcLectures.addEventListener('input',updateCalc);
    calcWeeks.addEventListener('input',updateCalc);
    calcMinutes.addEventListener('input',updateCalc);
    updateCalc();

    /* -- Scroll reveal animations -- */
    var revealElements=document.querySelectorAll('.reveal');

    function checkReveal(){
      var windowHeight=window.innerHeight;
      var triggerPoint=windowHeight*0.88;
      for(var i=0;i<revealElements.length;i++){
        var el=revealElements[i];
        var rect=el.getBoundingClientRect();
        if(rect.top<triggerPoint){
          el.classList.add('visible');
        }
      }
    }

    window.addEventListener('scroll',checkReveal,{passive:true});
    window.addEventListener('resize',checkReveal,{passive:true});
    // Initial check on load
    checkReveal();
    // Delayed check for elements that might be above fold
    setTimeout(checkReveal,100);

    /* -- Smooth scroll for anchor links -- */
    document.querySelectorAll('a[href^="#"]').forEach(function(link){
      link.addEventListener('click',function(e){
        var targetId=link.getAttribute('href');
        if(targetId.length<=1)return;
        var target=document.querySelector(targetId);
        if(target){
          e.preventDefault();
          var navHeight=64;
          var targetPosition=target.getBoundingClientRect().top+window.pageYOffset-navHeight;
          window.scrollTo({top:targetPosition,behavior:'smooth'});
        }
      });
    });
  </script>
</body>
</html>


===== templates/landing.html =====
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Lecture Processor ‚Äî From Lecture to Mastery</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
  <style>
    :root {
      --primary: #4F46E5;
      --primary-dark: #4338CA;
      --secondary: #0EA5E9;
      --success: #10B981;
      --gray-50: #F9FAFB;
      --gray-100: #F3F4F6;
      --gray-200: #E5E7EB;
      --gray-300: #D1D5DB;
      --gray-500: #6B7280;
      --gray-700: #374151;
      --gray-800: #1F2937;
      --gray-900: #111827;
      --white: #FFFFFF;
      --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
      --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
      --radius: 8px;
      --radius-md: 12px;
      --radius-lg: 16px;
      --radius-xl: 24px;
    }

    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    html { scroll-behavior: smooth; }
    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      color: var(--gray-800);
      background:
        radial-gradient(circle at 10% 0%, rgba(79,70,229,0.12), transparent 35%),
        radial-gradient(circle at 95% 20%, rgba(14,165,233,0.12), transparent 35%),
        linear-gradient(135deg, var(--gray-50) 0%, var(--white) 50%, var(--gray-100) 100%);
      min-height: 100vh;
      -webkit-font-smoothing: antialiased;
    }

    .container { max-width: 1160px; margin: 0 auto; padding: 0 24px; }

    .topbar {
      position: sticky;
      top: 12px;
      z-index: 20;
      margin: 16px auto;
      max-width: 1160px;
      border: 1px solid var(--gray-200);
      background: rgba(255,255,255,0.92);
      backdrop-filter: blur(14px);
      -webkit-backdrop-filter: blur(14px);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-lg);
      padding: 12px 18px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
    }

    .logo {
      display: inline-flex;
      align-items: center;
      gap: 12px;
      color: var(--gray-900);
      text-decoration: none;
      min-width: 0;
    }
    .logo-icon {
      width: 36px;
      height: 36px;
      border-radius: var(--radius-md);
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--white);
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      flex-shrink: 0;
    }
    .logo-icon svg { width: 21px; height: 21px; }
    .logo-title { font-weight: 800; font-size: 1.06rem; letter-spacing: -0.02em; }

    .nav-actions { display: flex; align-items: center; gap: 8px; }

    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 7px;
      border-radius: var(--radius);
      border: 1px solid var(--gray-300);
      background: var(--white);
      color: var(--gray-700);
      text-decoration: none;
      font-size: 0.86rem;
      font-weight: 700;
      padding: 10px 14px;
      transition: all 0.2s ease;
      white-space: nowrap;
      cursor: pointer;
    }
    .btn:hover { background: var(--gray-50); border-color: var(--gray-500); color: var(--gray-900); }
    .btn.primary {
      border: none;
      color: var(--white);
      background: linear-gradient(135deg, var(--primary), var(--primary-dark));
      box-shadow: 0 4px 14px rgba(79,70,229,0.28);
    }
    .btn.primary:hover { transform: translateY(-1px); box-shadow: 0 6px 18px rgba(79,70,229,0.35); }
    .btn svg { width: 16px; height: 16px; }

    .hero { padding: 78px 0 48px; text-align: center; }
    .badge {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 7px 14px;
      border-radius: 999px;
      font-size: 0.78rem;
      font-weight: 700;
      color: var(--primary-dark);
      border: 1px solid rgba(79,70,229,0.22);
      background: rgba(79,70,229,0.08);
      margin-bottom: 18px;
    }
    .badge svg { width: 14px; height: 14px; }
    h1 {
      color: var(--gray-900);
      font-size: clamp(2.1rem, 5vw, 3.5rem);
      line-height: 1.1;
      letter-spacing: -0.04em;
      margin-bottom: 14px;
      font-weight: 900;
    }
    .grad {
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    .sub {
      max-width: 740px;
      margin: 0 auto;
      font-size: clamp(1rem, 2vw, 1.14rem);
      color: var(--gray-500);
    }

    .hero-actions {
      margin-top: 28px;
      display: flex;
      justify-content: center;
      gap: 10px;
      flex-wrap: wrap;
    }

    .value-grid {
      margin-top: 44px;
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 16px;
    }
    .value-card {
      border: 1px solid var(--gray-200);
      background: rgba(255,255,255,0.92);
      border-radius: var(--radius-xl);
      padding: 22px;
      text-align: left;
      box-shadow: var(--shadow-sm);
    }
    .value-card-icon {
      width: 40px;
      height: 40px;
      border-radius: var(--radius-md);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      margin-bottom: 12px;
      color: var(--primary);
      background: rgba(79,70,229,0.1);
    }
    .value-card-icon svg { width: 20px; height: 20px; }
    .value-card h3 { font-size: 1rem; color: var(--gray-900); margin-bottom: 6px; }
    .value-card p { font-size: 0.88rem; color: var(--gray-500); }

    .bottom-cta {
      margin: 38px auto 64px;
      max-width: 920px;
      border-radius: var(--radius-xl);
      border: 1px solid rgba(79,70,229,0.22);
      background: linear-gradient(135deg, rgba(79,70,229,0.07), rgba(14,165,233,0.08));
      padding: 28px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 16px;
      flex-wrap: wrap;
    }
    .bottom-cta h2 { font-size: 1.15rem; color: var(--gray-900); margin-bottom: 4px; }
    .bottom-cta p { color: var(--gray-600); font-size: 0.9rem; }

    .footer {
      text-align: center;
      color: var(--gray-500);
      font-size: 0.83rem;
      padding: 24px 0 34px;
    }

    @media (max-width: 900px) {
      .value-grid { grid-template-columns: 1fr; }
    }

    @media (max-width: 650px) {
      .topbar { position: static; border-radius: var(--radius-md); }
      .hero { padding-top: 44px; }
      .logo-title { display: none; }
      .nav-actions .btn span { display: none; }
      .nav-actions .btn { padding: 10px; }
    }
  </style>
</head>
<body>
  <header class="topbar">
    <a href="/" class="logo">
      <span class="logo-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"></path><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"></path></svg></span>
      <span class="logo-title">Lecture Processor</span>
    </a>
    <div class="nav-actions">
      <a class="btn" href="/features"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"></polygon></svg><span>Features</span></a>
      <a class="btn primary" href="/dashboard" id="dashboard-btn"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 3h7v7H3z"></path><path d="M14 3h7v7h-7z"></path><path d="M14 14h7v7h-7z"></path><path d="M3 14h7v7H3z"></path></svg><span id="dashboard-btn-label">Open Dashboard</span></a>
    </div>
  </header>

  <main class="container">
    <section class="hero">
      <div class="badge"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M13 2L3 14h9l-1 8 10-12h-9z"></path></svg> AI-Powered Study Workflow</div>
      <h1>From lecture files to <span class="grad">exam-ready study</span> in minutes</h1>
      <p class="sub">Upload your class material once and generate structured notes, flashcards, and practice tests instantly. Then study in focused modes with mastery tracking and adaptive card ordering.</p>

      <div class="hero-actions">
        <a href="/dashboard" class="btn primary"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="5 3 19 12 5 21 5 3"></polygon></svg>Start Studying</a>
        <a href="/features" class="btn"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 20h9"></path><path d="M16.5 3.5a2.12 2.12 0 0 1 3 3L7 19l-4 1 1-4Z"></path></svg>Explore Features</a>
      </div>

      <div class="value-grid">
        <article class="value-card">
          <div class="value-card-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline></svg></div>
          <h3>Auto-Generated Notes</h3>
          <p>Turn slides, PDFs, and audio into clean study notes without manual rewriting.</p>
        </article>
        <article class="value-card">
          <div class="value-card-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="4" width="20" height="16" rx="2"></rect><line x1="2" y1="12" x2="22" y2="12"></line></svg></div>
          <h3>Focused Learn Modes</h3>
          <p>Flashcards, test, write, and match mode with mode selection and distraction-free sessions.</p>
        </article>
        <article class="value-card">
          <div class="value-card-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg></div>
          <h3>Mastery Tracking</h3>
          <p>Track seen, familiar, and mastered cards over time to focus review where needed.</p>
        </article>
      </div>
    </section>

    <section class="bottom-cta">
      <div>
        <h2>Ready to process your next lecture?</h2>
        <p>Open your dashboard to upload files, manage packs, and launch focused learn sessions.</p>
      </div>
      <a href="/dashboard" class="btn primary"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4"></path><polyline points="10 17 15 12 10 7"></polyline><line x1="15" y1="12" x2="3" y2="12"></line></svg>Go to Dashboard</a>
    </section>
  </main>

  <footer class="footer">Powered by Gemini AI ¬∑ Made for students</footer>

  <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth-compat.js"></script>
  <script>
    var firebaseConfig={apiKey:"AIzaSyBAAeEUCPNvP5qnqpP3M6HnFZ6vaaijUvM",authDomain:"lecture-processor-cdff6.firebaseapp.com",projectId:"lecture-processor-cdff6",storageBucket:"lecture-processor-cdff6.firebasestorage.app",messagingSenderId:"374793454161",appId:"1:374793454161:web:c68b21590e9a1fafa32e70"};
    firebase.initializeApp(firebaseConfig);
    var auth=firebase.auth();
    var dashboardBtnLabel=document.getElementById('dashboard-btn-label');
    auth.onAuthStateChanged(function(user){
      dashboardBtnLabel.textContent=user?'Dashboard':'Sign in';
    });
  </script>
</body>
</html>


===== templates/admin.html =====
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lecture Processor Admin</title>
    <style>
        :root {
            --primary: #4F46E5;
            --secondary: #0EA5E9;
            --success: #10B981;
            --danger: #EF4444;
            --bg: #F8FAFC;
            --card: #FFFFFF;
            --text: #0F172A;
            --muted: #64748B;
            --border: #E2E8F0;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: Inter, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #EFF6FF 0%, var(--bg) 45%, #F8FAFC 100%);
            color: var(--text);
            min-height: 100vh;
        }
        .container { max-width: 1250px; margin: 0 auto; padding: 24px; }
        .topbar {
            display: flex;
            justify-content: space-between;
            gap: 12px;
            align-items: center;
            margin-bottom: 16px;
            background: rgba(255, 255, 255, 0.85);
            border: 1px solid var(--border);
            padding: 14px 16px;
            border-radius: 14px;
            backdrop-filter: blur(8px);
        }
        .topbar h1 { font-size: 1.25rem; font-weight: 700; }
        .topbar .meta { color: var(--muted); font-size: 0.9rem; margin-top: 2px; }
        .actions { display: flex; gap: 8px; flex-wrap: wrap; }
        .filters {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
            background: rgba(255, 255, 255, 0.85);
            border: 1px solid var(--border);
            border-radius: 14px;
            padding: 10px;
            flex-wrap: wrap;
        }
        .btn {
            border: 1px solid var(--border);
            background: #fff;
            color: var(--text);
            padding: 9px 12px;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
        }
        .btn:hover { background: #F8FAFC; }
        .btn.primary {
            border: none;
            color: #fff;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
        }
        .btn.filter.active {
            border: 1px solid transparent;
            color: #fff;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
        }
        .metrics {
            display: grid;
            grid-template-columns: repeat(5, minmax(0, 1fr));
            gap: 12px;
            margin-bottom: 16px;
        }
        .metric {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 14px;
            padding: 14px;
        }
        .metric .label { color: var(--muted); font-size: 0.84rem; margin-bottom: 6px; }
        .metric .value { font-size: 1.3rem; font-weight: 800; }
        .metric .sub { font-size: 0.78rem; color: var(--muted); margin-top: 2px; }
        .charts {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-bottom: 12px;
        }
        .chart-panel {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 14px;
            padding: 14px;
        }
        .chart-panel h2 { font-size: 1rem; margin-bottom: 10px; }
        .chart-wrap {
            display: flex;
            align-items: flex-end;
            gap: 4px;
            height: 180px;
            border: 1px solid #F1F5F9;
            border-radius: 10px;
            padding: 8px;
            background: #F8FAFC;
            overflow: hidden;
        }
        .bar-col {
            flex: 1;
            min-width: 8px;
            display: flex;
            flex-direction: column;
            justify-content: flex-end;
            align-items: center;
            gap: 4px;
            height: 100%;
        }
        .bar {
            width: 100%;
            max-width: 20px;
            border-radius: 6px 6px 0 0;
            min-height: 2px;
        }
        .bar.success { background: linear-gradient(180deg, #34D399, #10B981); }
        .bar.revenue { background: linear-gradient(180deg, #60A5FA, #0EA5E9); }
        .bar-label {
            font-size: 0.64rem;
            color: var(--muted);
            transform: rotate(-40deg);
            transform-origin: top left;
            width: 32px;
            white-space: nowrap;
        }
        .chart-meta {
            margin-top: 8px;
            display: flex;
            justify-content: space-between;
            color: var(--muted);
            font-size: 0.78rem;
        }
        .mode-panel {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 14px;
            padding: 14px;
            margin-bottom: 12px;
        }
        .mode-panel-head {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 8px;
            margin-bottom: 10px;
            flex-wrap: wrap;
        }
        .mode-menu { display: flex; gap: 8px; flex-wrap: wrap; }
        .btn.mode-view.active {
            border: 1px solid transparent;
            color: #fff;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
        }
        .mode-bars { display: grid; gap: 10px; }
        .mode-row {
            display: grid;
            grid-template-columns: 160px 1fr 64px;
            align-items: center;
            gap: 10px;
        }
        .mode-label { font-size: 0.86rem; color: var(--text); font-weight: 600; }
        .mode-track {
            height: 14px;
            border-radius: 999px;
            background: #E2E8F0;
            overflow: hidden;
        }
        .mode-fill {
            height: 100%;
            border-radius: 999px;
            background: linear-gradient(135deg, #60A5FA, #2563EB);
            min-width: 2px;
        }
        .mode-value { font-size: 0.82rem; color: var(--muted); text-align: right; }
        .grid {
            display: grid;
            grid-template-columns: 2fr 1.4fr;
            gap: 12px;
        }
        .panel {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 14px;
            padding: 14px;
        }
        .panel h2 { font-size: 1rem; margin-bottom: 10px; }
        .table-wrap { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; font-size: 0.88rem; }
        th, td { text-align: left; padding: 8px 6px; border-bottom: 1px solid #F1F5F9; }
        th { color: var(--muted); font-weight: 600; font-size: 0.78rem; text-transform: uppercase; letter-spacing: 0.03em; }
        .status { font-weight: 700; font-size: 0.78rem; padding: 3px 8px; border-radius: 999px; display: inline-block; }
        .status.complete { color: #065F46; background: #D1FAE5; }
        .status.error { color: #991B1B; background: #FEE2E2; }
        .status.other { color: #1E40AF; background: #DBEAFE; }
        .empty { color: var(--muted); font-size: 0.9rem; padding: 6px 0; }
        .loading, .error, .blocked {
            background: #fff;
            border: 1px solid var(--border);
            border-radius: 14px;
            padding: 20px;
            text-align: center;
        }
        .error { color: #991B1B; border-color: #FECACA; background: #FEF2F2; }
        .blocked { color: #7C2D12; border-color: #FED7AA; background: #FFF7ED; }
        @media (max-width: 1100px) {
            .metrics { grid-template-columns: repeat(3, minmax(0, 1fr)); }
            .charts { grid-template-columns: 1fr; }
            .grid { grid-template-columns: 1fr; }
        }
        @media (max-width: 720px) {
            .metrics { grid-template-columns: repeat(2, minmax(0, 1fr)); }
            .mode-row { grid-template-columns: 1fr; }
            .mode-value { text-align: left; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="topbar">
            <div>
                <h1>Lecture Processor Admin</h1>
                <div class="meta" id="signed-in-meta">Checking sign-in...</div>
            </div>
            <div class="actions">
                <button class="btn" id="back-btn" type="button">Back to app</button>
                <button class="btn" id="refresh-btn" type="button">Refresh</button>
                <button class="btn" id="export-jobs-btn" type="button">Export jobs CSV</button>
                <button class="btn" id="export-purchases-btn" type="button">Export purchases CSV</button>
                <button class="btn primary" id="auth-btn" type="button">Sign in</button>
            </div>
        </div>

        <div class="filters">
            <button class="btn filter" data-window="24h" type="button">Last 24h</button>
            <button class="btn filter active" data-window="7d" type="button">Last 7d</button>
            <button class="btn filter" data-window="30d" type="button">Last 30d</button>
        </div>

        <div id="state-area" class="loading">Loading admin dashboard...</div>

        <div id="dashboard" style="display:none;">
            <section class="metrics">
                <article class="metric"><div class="label">Total users</div><div class="value" id="m-users">0</div><div class="sub" id="m-users-sub">0 new in window</div></article>
                <article class="metric"><div class="label">Jobs in window</div><div class="value" id="m-jobs">0</div></article>
                <article class="metric"><div class="label">Success rate</div><div class="value" id="m-success-rate">0%</div></article>
                <article class="metric"><div class="label">Revenue in window</div><div class="value" id="m-revenue">‚Ç¨0.00</div></article>
                <article class="metric"><div class="label">Purchases in window</div><div class="value" id="m-purchases">0</div></article>
                <article class="metric"><div class="label">Credits processed</div><div class="value" id="m-processed">0</div><div class="sub">All-time</div></article>
                <article class="metric"><div class="label">Refunded jobs</div><div class="value" id="m-refunds">0</div></article>
                <article class="metric"><div class="label">Avg duration</div><div class="value" id="m-duration">0s</div></article>
                <article class="metric"><div class="label">Successful jobs</div><div class="value" id="m-success-jobs">0</div></article>
                <article class="metric"><div class="label">Failed jobs</div><div class="value" id="m-failed-jobs">0</div></article>
            </section>

            <section class="charts">
                <div class="chart-panel">
                    <h2>Success Rate Trend</h2>
                    <div class="chart-wrap" id="success-chart"></div>
                    <div class="chart-meta"><span id="success-granularity">Granularity: day</span><span id="success-latest">Latest: 0%</span></div>
                </div>
                <div class="chart-panel">
                    <h2>Revenue Trend (EUR)</h2>
                    <div class="chart-wrap" id="revenue-chart"></div>
                    <div class="chart-meta"><span id="revenue-granularity">Granularity: day</span><span id="revenue-total">Window total: ‚Ç¨0.00</span></div>
                </div>
            </section>

            <section class="mode-panel">
                <div class="mode-panel-head">
                    <h2>Mode Breakdown</h2>
                    <div class="mode-menu">
                        <button class="btn mode-view active" data-mode-view="total" type="button">Total</button>
                        <button class="btn mode-view" data-mode-view="complete" type="button">Success</button>
                        <button class="btn mode-view" data-mode-view="error" type="button">Failed</button>
                    </div>
                </div>
                <div class="mode-bars" id="mode-breakdown-bars"></div>
            </section>

            <section class="grid">
                <div class="panel">
                    <h2>Recent Jobs</h2>
                    <div class="table-wrap">
                        <table>
                            <thead>
                                <tr>
                                    <th>Time</th>
                                    <th>User</th>
                                    <th>Mode</th>
                                    <th>Status</th>
                                    <th>Duration</th>
                                    <th>Refund</th>
                                </tr>
                            </thead>
                            <tbody id="jobs-body"></tbody>
                        </table>
                    </div>
                </div>
                <div class="panel">
                    <h2>Recent Purchases</h2>
                    <div class="table-wrap">
                        <table>
                            <thead>
                                <tr>
                                    <th>Time</th>
                                    <th>Bundle</th>
                                    <th>Amount</th>
                                </tr>
                            </thead>
                            <tbody id="purchases-body"></tbody>
                        </table>
                    </div>
                </div>
            </section>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth-compat.js"></script>
    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyBAAeEUCPNvP5qnqpP3M6HnFZ6vaaijUvM",
            authDomain: "lecture-processor-cdff6.firebaseapp.com",
            projectId: "lecture-processor-cdff6",
            storageBucket: "lecture-processor-cdff6.firebasestorage.app",
            messagingSenderId: "374793454161",
            appId: "1:374793454161:web:c68b21590e9a1fafa32e70"
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();

        const signedInMeta = document.getElementById('signed-in-meta');
        const stateArea = document.getElementById('state-area');
        const dashboard = document.getElementById('dashboard');
        const authBtn = document.getElementById('auth-btn');
        const refreshBtn = document.getElementById('refresh-btn');
        const backBtn = document.getElementById('back-btn');
        const exportJobsBtn = document.getElementById('export-jobs-btn');
        const exportPurchasesBtn = document.getElementById('export-purchases-btn');

        let currentWindow = '7d';
        let currentModeView = 'total';
        let latestModeBreakdown = {};

        function formatMoney(cents) {
            return `‚Ç¨${((cents || 0) / 100).toFixed(2)}`;
        }

        function formatDate(timestampSeconds) {
            if (!timestampSeconds) return '-';
            const dt = new Date(timestampSeconds * 1000);
            return dt.toLocaleString('en-GB', {
                day: '2-digit', month: 'short', year: 'numeric',
                hour: '2-digit', minute: '2-digit'
            });
        }

        function setState(message, type = 'loading') {
            stateArea.textContent = message;
            stateArea.className = type;
            stateArea.style.display = 'block';
            dashboard.style.display = 'none';
        }

        function renderRows(tbodyId, rowsHtml, emptyText, colspan = 8) {
            const tbody = document.getElementById(tbodyId);
            if (!rowsHtml.length) {
                tbody.innerHTML = `<tr><td colspan="${colspan}" class="empty">${emptyText}</td></tr>`;
                return;
            }
            tbody.innerHTML = rowsHtml.join('');
        }

        function renderBars(containerId, labels, values, type) {
            const container = document.getElementById(containerId);
            container.innerHTML = '';
            if (!labels.length) {
                container.innerHTML = '<div class="empty">No data for selected window.</div>';
                return;
            }
            const maxValue = Math.max(...values, 1);
            labels.forEach((label, idx) => {
                const value = values[idx] || 0;
                const heightPercent = (value / maxValue) * 100;
                const col = document.createElement('div');
                col.className = 'bar-col';
                col.title = `${label}: ${type === 'success' ? value + '%' : formatMoney(value)}`;
                const bar = document.createElement('div');
                bar.className = `bar ${type}`;
                bar.style.height = `${Math.max(heightPercent, 1)}%`;
                const labelEl = document.createElement('div');
                labelEl.className = 'bar-label';
                labelEl.textContent = label;
                col.appendChild(bar);
                if (labels.length <= 12 || idx % Math.ceil(labels.length / 10) === 0 || idx === labels.length - 1) {
                    col.appendChild(labelEl);
                }
                container.appendChild(col);
            });
        }

        function renderModeBreakdown() {
            const container = document.getElementById('mode-breakdown-bars');
            const entries = Object.values(latestModeBreakdown || {}).filter((item) => item && item.label);
            if (!entries.length) {
                container.innerHTML = '<div class=\"empty\">No mode data for selected window.</div>';
                return;
            }
            const maxValue = Math.max(...entries.map((entry) => entry[currentModeView] || 0), 1);
            const rows = entries.map((entry) => {
                const value = entry[currentModeView] || 0;
                const width = Math.max((value / maxValue) * 100, value > 0 ? 2 : 0);
                return `
                    <div class=\"mode-row\">
                        <div class=\"mode-label\">${entry.label}</div>
                        <div class=\"mode-track\"><div class=\"mode-fill\" style=\"width:${width}%;\"></div></div>
                        <div class=\"mode-value\">${value}</div>
                    </div>
                `;
            });
            container.innerHTML = rows.join('');
        }

        function renderDashboard(data) {
            const m = data.metrics || {};
            const t = data.trends || {};
            const successRate = m.job_count > 0 ? Math.round((m.success_jobs / m.job_count) * 100) : 0;

            document.getElementById('m-users').textContent = m.total_users || 0;
            document.getElementById('m-users-sub').textContent = `${m.new_users || 0} new in window`;
            document.getElementById('m-jobs').textContent = m.job_count || 0;
            document.getElementById('m-success-rate').textContent = `${successRate}%`;
            document.getElementById('m-revenue').textContent = formatMoney(m.total_revenue_cents || 0);
            document.getElementById('m-purchases').textContent = m.purchase_count || 0;
            document.getElementById('m-processed').textContent = m.total_processed || 0;
            document.getElementById('m-refunds').textContent = m.refunded_jobs || 0;
            document.getElementById('m-duration').textContent = `${m.avg_duration_seconds || 0}s`;
            document.getElementById('m-success-jobs').textContent = m.success_jobs || 0;
            document.getElementById('m-failed-jobs').textContent = m.failed_jobs || 0;

            const labels = t.labels || [];
            const successTrend = t.success_rate || [];
            const revenueTrend = t.revenue_cents || [];
            latestModeBreakdown = data.mode_breakdown || {};

            renderBars('success-chart', labels, successTrend, 'success');
            renderBars('revenue-chart', labels, revenueTrend, 'revenue');
            renderModeBreakdown();

            document.getElementById('success-granularity').textContent = `Granularity: ${t.granularity || 'day'}`;
            document.getElementById('revenue-granularity').textContent = `Granularity: ${t.granularity || 'day'}`;
            document.getElementById('success-latest').textContent = `Latest: ${successTrend.length ? successTrend[successTrend.length - 1] : 0}%`;
            const revenueTotal = revenueTrend.reduce((acc, value) => acc + (value || 0), 0);
            document.getElementById('revenue-total').textContent = `Window total: ${formatMoney(revenueTotal)}`;

            const jobRows = (data.recent_jobs || []).map((job) => {
                const status = job.status || 'unknown';
                const statusClass = status === 'complete' ? 'complete' : (status === 'error' ? 'error' : 'other');
                return `
                    <tr>
                        <td>${formatDate(job.finished_at)}</td>
                        <td>${(job.email || '').slice(0, 32) || '-'}</td>
                        <td>${job.mode || '-'}</td>
                        <td><span class="status ${statusClass}">${status}</span></td>
                        <td>${job.duration_seconds || 0}s</td>
                        <td>${job.credit_refunded ? 'Yes' : 'No'}</td>
                    </tr>
                `;
            });
            renderRows('jobs-body', jobRows, 'No jobs found in selected window.', 6);

            const purchaseRows = (data.recent_purchases || []).map((purchase) => `
                <tr>
                    <td>${formatDate(purchase.created_at)}</td>
                    <td>${purchase.bundle_name || '-'}</td>
                    <td>${formatMoney(purchase.price_cents || 0)}</td>
                </tr>
            `);
            renderRows('purchases-body', purchaseRows, 'No purchases found in selected window.', 3);

            stateArea.style.display = 'none';
            dashboard.style.display = 'block';
        }

        async function loadAdminOverview(user) {
            if (!user) {
                setState('Please sign in to continue.', 'blocked');
                return;
            }
            setState('Loading admin dashboard...', 'loading');
            try {
                const token = await user.getIdToken();
                const res = await fetch(`/api/admin/overview?window=${encodeURIComponent(currentWindow)}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (res.status === 403) {
                    setState('Your account is signed in but not configured as admin. Set ADMIN_EMAILS or ADMIN_UIDS on the server.', 'blocked');
                    return;
                }
                if (!res.ok) {
                    setState('Could not load dashboard data. Please refresh.', 'error');
                    return;
                }

                const data = await res.json();
                renderDashboard(data);
            } catch (error) {
                console.error(error);
                setState('Network error while loading dashboard.', 'error');
            }
        }

        async function exportCsv(type) {
            if (!auth.currentUser) {
                setState('Please sign in to export CSV.', 'blocked');
                return;
            }
            try {
                const token = await auth.currentUser.getIdToken();
                const res = await fetch(`/api/admin/export?type=${encodeURIComponent(type)}&window=${encodeURIComponent(currentWindow)}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (!res.ok) {
                    setState('Could not export CSV right now.', 'error');
                    return;
                }
                const blob = await res.blob();
                const disposition = res.headers.get('Content-Disposition') || '';
                const match = disposition.match(/filename=([^;]+)/i);
                const filename = match ? match[1].trim() : `admin-${type}-${currentWindow}.csv`;
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            } catch (error) {
                console.error(error);
                setState('Network error while exporting CSV.', 'error');
            }
        }

        function setActiveFilterButton() {
            document.querySelectorAll('.filter').forEach((btn) => {
                btn.classList.toggle('active', btn.dataset.window === currentWindow);
            });
        }

        function setActiveModeViewButton() {
            document.querySelectorAll('.mode-view').forEach((btn) => {
                btn.classList.toggle('active', btn.dataset.modeView === currentModeView);
            });
        }

        auth.onAuthStateChanged(async (user) => {
            if (user) {
                signedInMeta.textContent = `Signed in as ${user.email}`;
                authBtn.textContent = 'Sign out';
                await loadAdminOverview(user);
            } else {
                signedInMeta.textContent = 'Not signed in';
                authBtn.textContent = 'Sign in';
                setState('Please sign in with your admin account.', 'blocked');
            }
        });

        authBtn.addEventListener('click', async () => {
            if (auth.currentUser) {
                await auth.signOut();
                return;
            }
            window.location.href = '/';
        });

        refreshBtn.addEventListener('click', async () => {
            if (!auth.currentUser) {
                setState('Please sign in to refresh.', 'blocked');
                return;
            }
            await loadAdminOverview(auth.currentUser);
        });

        backBtn.addEventListener('click', () => {
            window.location.href = '/';
        });

        exportJobsBtn.addEventListener('click', async () => {
            await exportCsv('jobs');
        });

        exportPurchasesBtn.addEventListener('click', async () => {
            await exportCsv('purchases');
        });

        document.querySelectorAll('.filter').forEach((btn) => {
            btn.addEventListener('click', async () => {
                currentWindow = btn.dataset.window;
                setActiveFilterButton();
                if (auth.currentUser) {
                    await loadAdminOverview(auth.currentUser);
                }
            });
        });

        document.querySelectorAll('.mode-view').forEach((btn) => {
            btn.addEventListener('click', () => {
                currentModeView = btn.dataset.modeView;
                setActiveModeViewButton();
                renderModeBreakdown();
            });
        });

        setActiveFilterButton();
        setActiveModeViewButton();
    </script>
</body>
</html>


===== requirements.txt =====
flask==3.0.0
google-genai==1.0.0
python-dotenv==1.0.0
werkzeug==3.0.1
gunicorn==21.2.0
python-docx==1.1.0
firebase-admin==6.4.0
stripe==11.4.1
yt-dlp==2024.12.13
