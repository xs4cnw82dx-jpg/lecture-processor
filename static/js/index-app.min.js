const runtimeConfig=window.LectureProcessorRuntime||{},sentryFrontendDsn=runtimeConfig.sentryFrontendDsn||"",sentryEnvironment=runtimeConfig.sentryEnvironment||"",sentryRelease=runtimeConfig.sentryRelease||"";window.Sentry&&sentryFrontendDsn&&window.Sentry.init({dsn:sentryFrontendDsn,environment:sentryEnvironment||"production",release:sentryRelease||void 0,tracesSampleRate:0});const firebaseConfig={apiKey:"AIzaSyBAAeEUCPNvP5qnqpP3M6HnFZ6vaaijUvM",authDomain:"lecture-processor-cdff6.firebaseapp.com",projectId:"lecture-processor-cdff6",storageBucket:"lecture-processor-cdff6.firebasestorage.app",messagingSenderId:"374793454161",appId:"1:374793454161:web:c68b21590e9a1fafa32e70"};firebase.initializeApp(firebaseConfig);const auth=firebase.auth(),authUtils=window.LectureProcessorAuth||{},authClient=authUtils.createAuthClient?authUtils.createAuthClient(auth,{notSignedInMessage:"Please sign in"}):null,markdownUtils=window.LectureProcessorMarkdown||{},uxUtils=window.LectureProcessorUx||{},downloadUtils=window.LectureProcessorDownload||{},topbarUtils=window.LectureProcessorTopbar||{};let currentUser=null,userCredits=null,idToken=null,currentUserIsAdmin=!1,pdfFile=null,audioFile=null,currentJobId=null,pollInterval=null,pollFailures=0,pollStartedAt=0,currentMode="lecture-notes",resultMarkdown="",slideText="",transcript="",flashcards=[],testQuestions=[],activeResultsTab="notes",flashcardIndex=0,flashcardFlipped=!1,quizIndex=0,quizScore=0,quizAnswered=!1,studyGenerationError=null,currentStudyPackId=null,resultsLocked=!1,selectedStudyFeatures="both",selectedFlashcardAmount="20",selectedQuestionAmount="10",selectedInterviewFeatures=[],importedAudioToken="",importedAudioSizeBytes=0,importedAudioName="",languageOnboardingOpen=!1,languageOnboardingSaving=!1,userPreferences=null,languagePreferenceSaveTimer=null,suppressLanguagePreferencePersist=!1,interviewSummaryText="",interviewSectionsText="",interviewCombinedText="",currentBillingReceipt=null,exportCsvType="flashcards",progressSummaryCache=null,userTotalProcessed=0,trackedTerminalJobId="";const analyticsEndpoint="/api/lp-event",POLL_BASE_MS=2e3,POLL_MAX_MS=3e4,POLL_MAX_RUNTIME_MS=1800*1e3,DOWNLOAD_LABELS=Object.freeze({lectureNotes:"Lecture Notes",slideExtract:"Slide Extract",lectureTranscript:"Lecture Transcript",interviewTranscript:"Interview Transcript"}),OUTPUT_LANGUAGE_LABELS=Object.freeze({dutch:"\u{1F1F3}\u{1F1F1} Dutch",english:"\u{1F1EC}\u{1F1E7} English",spanish:"\u{1F1EA}\u{1F1F8} Spanish",french:"\u{1F1EB}\u{1F1F7} French",german:"\u{1F1E9}\u{1F1EA} German",chinese:"\u{1F1E8}\u{1F1F3} Chinese",other:"\u{1F310} Other"});function createAnalyticsSessionId(){try{if(window.crypto&&typeof window.crypto.randomUUID=="function")return window.crypto.randomUUID().replace(/[^A-Za-z0-9_-]/g,"").slice(0,64)}catch(e){}return`sess_${Date.now()}_${Math.random().toString(36).slice(2,12)}`}const analyticsSessionId=(()=>{const e="lp_analytics_session_id";try{const t=localStorage.getItem(e);if(t&&/^[A-Za-z0-9_-]{6,80}$/.test(t))return t;const n=createAnalyticsSessionId();return localStorage.setItem(e,n),n}catch(t){return createAnalyticsSessionId()}})();function captureClientError(e,t=""){if(!(!window.Sentry||!e)){if(t){window.Sentry.withScope(n=>{n.setTag("context",t),window.Sentry.captureException(e)});return}window.Sentry.captureException(e)}}function trackEvent(e,t={},n={}){const s=String(e||"").trim().toLowerCase();if(!s)return Promise.resolve(!1);const o={event:s,session_id:analyticsSessionId,page:"dashboard",path:window.location.pathname,properties:Object.assign({},t||{},{mode:currentMode})},i=JSON.stringify(o);if(n.preferBeacon&&navigator.sendBeacon)try{const a=new Blob([i],{type:"application/json"});return Promise.resolve(navigator.sendBeacon(analyticsEndpoint,a))}catch(a){}const r={"Content-Type":"application/json"};return idToken&&(r.Authorization=`Bearer ${idToken}`),fetch(analyticsEndpoint,{method:"POST",headers:r,body:i,keepalive:!0}).then(a=>a.ok).catch(()=>!1)}const modeConfig={"lecture-notes":{description:"Upload lecture slides (PDF or PPTX) and audio recording to generate complete, integrated study notes.",creditCost:"Uses <strong>1 lecture credit</strong>",creditType:"lecture",needsPdf:!0,needsAudio:!0,audioTitle:"Lecture Recording",buttonText:"Process Lecture",resultTitle:"Study Dashboard",steps:[{num:1,label:"Extract Slides"},{num:2,label:"Transcribe Audio"},{num:3,label:"Merge Notes"},{num:4,label:"Build Study Tools"}]},"slides-only":{description:"Upload lecture slides (PDF or PPTX) to run slide extraction and generate clean text notes.",creditCost:"Uses <strong>1 slides credit</strong>",creditType:"slides",needsPdf:!0,needsAudio:!1,audioTitle:"Lecture Recording",buttonText:"Extract Slides",resultTitle:"Study Dashboard",steps:[{num:1,label:"Extract Text"},{num:2,label:"Build Study Tools"}]},interview:{description:"Upload an interview recording to generate a timestamped transcript with speaker identification. Optional extras run through the slide-processing pipeline.",creditCost:"Uses <strong>1 interview credit</strong> (+ <strong>1 slides credit</strong> per selected extra)",creditType:"interview",needsPdf:!1,needsAudio:!0,audioTitle:"Interview Recording",buttonText:"Transcribe Interview",resultTitle:"Interview Transcript",steps:[{num:1,label:"Transcribe"}]}},allowedSlideExtensions=[".pdf",".pptx"],allowedSlideMimeTypes=["application/pdf","application/vnd.openxmlformats-officedocument.presentationml.presentation","application/vnd.ms-powerpoint","application/octet-stream",""],headerSignInBtn=document.getElementById("header-sign-in-btn"),headerStudyLibraryBtn=document.getElementById("header-study-library-btn"),progressMenu=document.getElementById("progress-menu"),progressButton=document.getElementById("progress-button"),progressDropdown=document.getElementById("progress-dropdown"),progressStreakCount=document.getElementById("progress-streak-count"),progressDueCount=document.getElementById("progress-due-count"),progressGoalText=document.getElementById("progress-goal-text"),progressSetGoalBtn=document.getElementById("progress-set-goal-btn"),progressOpenPlanBtn=document.getElementById("progress-open-plan-btn"),goalModalOverlay=document.getElementById("goal-modal-overlay"),goalModalInput=document.getElementById("goal-modal-input"),goalModalError=document.getElementById("goal-modal-error"),goalModalCancelBtn=document.getElementById("goal-modal-cancel-btn"),goalModalSaveBtn=document.getElementById("goal-modal-save-btn"),creditsDisplay=document.getElementById("credits-display"),creditsCount=document.getElementById("credits-count"),creditsTooltip=document.getElementById("credits-tooltip"),userMenu=document.getElementById("user-menu"),userButton=document.getElementById("user-button"),userDropdown=document.getElementById("user-dropdown"),userAvatar=document.getElementById("user-avatar"),userName=document.getElementById("user-name"),userEmail=document.getElementById("user-email"),dropdownLectureCredits=document.getElementById("dropdown-lecture-credits"),dropdownSlidesCredits=document.getElementById("dropdown-slides-credits"),dropdownInterviewCredits=document.getElementById("dropdown-interview-credits"),buyCreditsBtn=document.getElementById("buy-credits-btn"),featuresPageBtn=document.getElementById("features-page-btn"),plannerPageBtn=document.getElementById("planner-page-btn"),purchaseHistoryBtn=document.getElementById("purchase-history-btn"),exportDataBtn=document.getElementById("export-data-btn"),adminDashboardBtn=document.getElementById("admin-dashboard-btn"),deleteAccountBtn=document.getElementById("delete-account-btn"),signOutBtn=document.getElementById("sign-out-btn"),authOverlay=document.getElementById("auth-overlay"),authModalClose=document.getElementById("auth-modal-close"),signinView=document.getElementById("signin-view"),signupView=document.getElementById("signup-view"),resetView=document.getElementById("reset-view"),signinForm=document.getElementById("signin-form"),signupForm=document.getElementById("signup-form"),resetForm=document.getElementById("reset-form"),signinEmail=document.getElementById("signin-email"),signinPassword=document.getElementById("signin-password"),signupEmail=document.getElementById("signup-email"),signupPassword=document.getElementById("signup-password"),signupPasswordConfirm=document.getElementById("signup-password-confirm"),resetEmail=document.getElementById("reset-email"),signinError=document.getElementById("signin-error"),signupError=document.getElementById("signup-error"),resetError=document.getElementById("reset-error"),resetSuccess=document.getElementById("reset-success"),googleSignInBtn=document.getElementById("google-sign-in-btn"),googleSignUpBtn=document.getElementById("google-sign-up-btn"),switchToSignup=document.getElementById("switch-to-signup"),switchToSignin=document.getElementById("switch-to-signin"),forgotPasswordLink=document.getElementById("forgot-password-link"),backToSignin=document.getElementById("back-to-signin"),signInRequired=document.getElementById("sign-in-required"),signInToProcessBtn=document.getElementById("sign-in-to-process-btn"),modeTabs=document.querySelectorAll(".mode-tab"),modeDescriptionText=document.getElementById("mode-description-text"),modeCreditCost=document.getElementById("mode-credit-cost"),modeCostSummary=document.getElementById("mode-cost-summary"),uploadEstimate=document.getElementById("upload-estimate"),uploadEstimateTime=document.getElementById("upload-estimate-time"),uploadEstimateMeta=document.getElementById("upload-estimate-meta"),uploadSection=document.getElementById("upload-section"),buttonSection=document.getElementById("button-section"),generationControls=document.getElementById("generation-controls"),interviewControls=document.getElementById("interview-controls"),languageControls=document.getElementById("language-controls"),quickstartCard=document.getElementById("quickstart-card"),quickstartApplyBtn=document.getElementById("quickstart-apply-btn"),quickstartDismissBtn=document.getElementById("quickstart-dismiss-btn"),advancedSettingsToggle=document.getElementById("advanced-settings-toggle"),advancedSettingsBody=document.getElementById("advanced-settings-body"),studyToolsToggle=document.getElementById("study-tools-toggle"),studyToolsToggleText=document.getElementById("study-tools-toggle-text"),studyToolsPanel=document.getElementById("study-tools-panel"),studyToolsNote=document.getElementById("study-tools-note"),flashcardAmountControl=document.getElementById("flashcard-amount-control"),questionAmountControl=document.getElementById("question-amount-control"),studyToolChips=document.querySelectorAll(".tool-chip[data-study-features]"),flashcardAmountChips=document.querySelectorAll("#flashcard-amount-chips .amount-chip"),questionAmountChips=document.querySelectorAll("#question-amount-chips .amount-chip"),interviewOptionButtons=document.querySelectorAll(".interview-option[data-feature]"),interviewExtraNote=document.getElementById("interview-extra-note"),outputLanguageSelect=document.getElementById("output-language-select"),outputLanguagePicker=document.getElementById("output-language-picker"),outputLanguageButton=document.getElementById("output-language-button"),outputLanguageLabel=document.getElementById("output-language-label"),outputLanguageMenu=document.getElementById("output-language-menu"),outputLanguageItems=document.querySelectorAll("#output-language-menu .app-select-item"),outputLanguageCustom=document.getElementById("output-language-custom"),pdfZone=document.getElementById("pdf-zone"),audioZone=document.getElementById("audio-zone"),audioZoneTitle=document.getElementById("audio-zone-title"),pdfInput=document.getElementById("pdf-input"),audioInput=document.getElementById("audio-input"),pdfInfo=document.getElementById("pdf-info"),audioInfo=document.getElementById("audio-info"),pdfName=document.getElementById("pdf-name"),pdfSize=document.getElementById("pdf-size"),audioName=document.getElementById("audio-name"),audioSize=document.getElementById("audio-size"),pdfRemove=document.getElementById("pdf-remove"),audioRemove=document.getElementById("audio-remove"),audioUrlImport=document.getElementById("audio-url-import"),audioUrlInput=document.getElementById("audio-url-input"),audioUrlFetchBtn=document.getElementById("audio-url-fetch-btn"),audioUrlStatus=document.getElementById("audio-url-status"),languageOnboardingOverlay=document.getElementById("language-onboarding-overlay"),languageOnboardingGrid=document.getElementById("language-onboarding-grid"),languageOnboardingButtons=document.querySelectorAll("#language-onboarding-grid .onboarding-language-btn"),languageOnboardingCustom=document.getElementById("language-onboarding-custom"),languageOnboardingError=document.getElementById("language-onboarding-error"),languageOnboardingSaveBtn=document.getElementById("language-onboarding-save-btn"),processButton=document.getElementById("process-button"),noCreditsWarning=document.getElementById("no-credits-warning"),buyCreditsLink=document.getElementById("buy-credits-link"),progressSection=document.getElementById("progress-section"),progressSteps=document.getElementById("progress-steps"),progressStatus=document.getElementById("progress-status"),statusText=document.getElementById("status-text"),progressRetry=document.getElementById("progress-retry"),progressRetryBtn=document.getElementById("progress-retry-btn"),resultsSection=document.getElementById("results-section"),resultsTitleText=document.getElementById("results-title-text"),resultsContent=document.getElementById("results-content"),studyWarning=document.getElementById("study-warning"),billingReceiptPanel=document.getElementById("billing-receipt"),copyButton=document.getElementById("copy-button"),copyButtonText=document.getElementById("copy-button-text"),downloadButton=document.getElementById("download-button"),downloadDropdown=document.getElementById("download-dropdown"),downloadDropdownContent=document.getElementById("download-dropdown-content"),moreActionsDropdown=document.getElementById("more-actions-dropdown"),moreActionsButton=document.getElementById("more-actions-button"),moreActionsContent=document.getElementById("more-actions-content"),exportStudyCsvBtn=document.getElementById("export-study-csv-btn"),exportStudyCsvText=document.getElementById("export-study-csv-text"),studyNowBtn=document.getElementById("study-now-btn"),studyLibraryBtn=document.getElementById("study-library-btn"),newLectureButton=document.getElementById("new-lecture-button"),tabButtons=document.querySelectorAll(".focus-tab"),paneNotes=document.getElementById("pane-notes"),paneFlashcards=document.getElementById("pane-flashcards"),paneTest=document.getElementById("pane-test"),flashcardCountBadge=document.getElementById("flashcard-count-badge"),testCountBadge=document.getElementById("test-count-badge"),flashcardCard=document.getElementById("flashcard-card"),flashcardInner=document.getElementById("flashcard-inner"),flashcardFrontText=document.getElementById("flashcard-front-text"),flashcardBackText=document.getElementById("flashcard-back-text"),flashcardPrevBtn=document.getElementById("flashcard-prev-btn"),flashcardFlipBtn=document.getElementById("flashcard-flip-btn"),flashcardNextBtn=document.getElementById("flashcard-next-btn"),flashcardProgress=document.getElementById("flashcard-progress"),flashcardEmpty=document.getElementById("flashcard-empty"),quizProgress=document.getElementById("quiz-progress"),quizScoreEl=document.getElementById("quiz-score"),quizQuestionText=document.getElementById("quiz-question-text"),quizOptions=document.getElementById("quiz-options"),quizExplanation=document.getElementById("quiz-explanation"),quizNextBtn=document.getElementById("quiz-next-btn"),quizEmpty=document.getElementById("quiz-empty"),pricingOverlay=document.getElementById("pricing-overlay"),pricingModalClose=document.getElementById("pricing-modal-close"),historyOverlay=document.getElementById("history-overlay"),historyModalClose=document.getElementById("history-modal-close"),historyList=document.getElementById("history-list"),toast=document.getElementById("toast"),toastIcon=document.getElementById("toast-icon"),toastText=document.getElementById("toast-text");function localDateString(e){const t=e?new Date(e):new Date,n=t.getFullYear(),s=String(t.getMonth()+1).padStart(2,"0"),o=String(t.getDate()).padStart(2,"0");return`${n}-${s}-${o}`}const htmlUtils=window.LectureProcessorHtml||{},escapeHtml=htmlUtils.escapeHtml||function(e){return String(e!=null?e:"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")},setSanitizedHtml=htmlUtils.setSanitizedHtml||function(e,t,n=null){if(!e)return;const s=String(t!=null?t:"");if(window.DOMPurify&&typeof window.DOMPurify.sanitize=="function"){e.innerHTML=window.DOMPurify.sanitize(s,n||{});return}e.textContent=s};function formatCreditTypeLabel(e){const t=String(e||"").trim();return{lecture_credits_standard:"lecture credit",lecture_credits_extended:"lecture extended credit",slides_credits:"slides credit",interview_credits_short:"interview short credit",interview_credits_medium:"interview medium credit",interview_credits_long:"interview long credit"}[t]||t.replace(/_/g," ")}function formatCreditLedger(e){return!e||typeof e!="object"?"":Object.entries(e).map(([n,s])=>[formatCreditTypeLabel(n),Number(s||0)]).filter(([,n])=>Number.isFinite(n)&&n>0).map(([n,s])=>`${s} ${n}${s===1?"":"s"}`).join(" + ")}function buildBillingReceiptText(e){if(!e||typeof e!="object")return"";const t=formatCreditLedger(e.charged||{}),n=formatCreditLedger(e.refunded||{});return!t&&!n?"":t&&n?`Billing receipt: Charged ${t}. Refunded ${n}.`:t?`Billing receipt: Charged ${t}.`:`Billing receipt: Refunded ${n}.`}function renderBillingReceipt(e){if(currentBillingReceipt=e&&typeof e=="object"?e:null,!billingReceiptPanel)return;const t=buildBillingReceiptText(currentBillingReceipt);if(!t){billingReceiptPanel.textContent="",billingReceiptPanel.classList.remove("visible"),billingReceiptPanel.style.display="none";return}billingReceiptPanel.textContent=t,billingReceiptPanel.style.display="block",billingReceiptPanel.classList.add("visible")}function getDailyGoalStorage(e){const t=parseInt(localStorage.getItem(`daily_goal_${e}`)||"20",10);return Number.isFinite(t)&&t>0?Math.min(t,500):20}function getProgressSummaryForHeader(e){const t=progressSummaryCache&&typeof progressSummaryCache=="object"?progressSummaryCache:{},n=Number(t.daily_goal||getDailyGoalStorage(e)||20);return{current_streak:Number(t.current_streak||0),due_today:Number(t.due_today||0),today_progress:Number(t.today_progress||0),daily_goal:Number.isFinite(n)&&n>0?n:20}}function refreshStudyHeaderMetrics(){if(!currentUser){progressMenu.style.display="none";return}const e=currentUser.uid,t=getProgressSummaryForHeader(e),n=t.current_streak,s=t.due_today,o=t.daily_goal,i=t.today_progress;progressStreakCount.textContent=String(n),progressDueCount.textContent=String(s),progressGoalText.textContent=`${Math.min(i,o)} / ${o}`,progressButton.title=`Streak ${n} days \xB7 ${s} due today \xB7 Goal ${Math.min(i,o)}/${o}`,progressMenu.style.display="block"}async function fetchStudyProgressSummary(){if(currentUser)try{const e=await authenticatedFetch("/api/study-progress");if(!e.ok)return;const t=await e.json(),n=t&&t.summary&&typeof t.summary=="object"?t.summary:null;if(!n)return;if(progressSummaryCache=n,typeof n.daily_goal=="number"&&n.daily_goal>0)try{localStorage.setItem(`daily_goal_${currentUser.uid}`,String(n.daily_goal))}catch(s){}refreshStudyHeaderMetrics()}catch(e){console.warn("Could not fetch study progress summary:",e)}}let activeModalOverlay=null,modalStateStack=[],accountActionInFlight=!1,checkoutCooldownUntilMs=0,checkoutCooldownTimer=null,checkoutRequestInFlight=!1,uploadCooldownUntilMs=0,uploadCooldownTimer=null;function getModalContainer(e){return uxUtils.getModalContainer?uxUtils.getModalContainer(e):e?e.querySelector('[role="dialog"]')||e.firstElementChild||e:null}function getFocusableElements(e){if(uxUtils.getFocusableElements)return uxUtils.getFocusableElements(e);const t=getModalContainer(e);return t?Array.from(t.querySelectorAll('a[href],button:not([disabled]),textarea:not([disabled]),input:not([disabled]),select:not([disabled]),[tabindex]:not([tabindex="-1"])')).filter(s=>s.offsetParent!==null||s===document.activeElement):[]}function openOverlay(e){if(!e)return;modalStateStack.push({overlay:e,restore:document.activeElement}),e.classList.add("visible"),e.setAttribute("aria-hidden","false"),activeModalOverlay=e;const t=getFocusableElements(e);t.length&&setTimeout(()=>t[0].focus(),30)}function closeOverlay(e){if(!e)return;e.classList.remove("visible"),e.setAttribute("aria-hidden","true");let t=null;for(let n=modalStateStack.length-1;n>=0;n-=1)if(modalStateStack[n].overlay===e){t=modalStateStack[n].restore||null,modalStateStack.splice(n,1);break}if(activeModalOverlay=modalStateStack.length?modalStateStack[modalStateStack.length-1].overlay:null,t&&typeof t.focus=="function")try{t.focus()}catch(n){}}function getVisibleMenuItems(e,t="button:not([disabled])"){return uxUtils.getVisibleMenuItems?uxUtils.getVisibleMenuItems(e,t):e?Array.from(e.querySelectorAll(t)).filter(n=>(n.offsetParent!==null||n===document.activeElement)&&!n.disabled):[]}function focusMenuItem(e,t,n="first"){if(uxUtils.focusMenuItem){uxUtils.focusMenuItem(e,t,n);return}const s=getVisibleMenuItems(e,t);if(!s.length)return;if(n==="last"){s[s.length-1].focus();return}const o=s.indexOf(document.activeElement);if(n==="next"){s[(o+1+s.length)%s.length].focus();return}if(n==="prev"){s[(o-1+s.length)%s.length].focus();return}if(n==="active"){(s.find(r=>r.classList.contains("active")||r.getAttribute("aria-selected")==="true")||s[0]).focus();return}s[0].focus()}function setUserDropdownVisible(e){userDropdown.classList.toggle("visible",e),userButton.setAttribute("aria-expanded",e?"true":"false")}function setProgressDropdownVisible(e){progressDropdown.classList.toggle("visible",e),progressButton.classList.toggle("open",e),progressButton.setAttribute("aria-expanded",e?"true":"false")}function setDownloadDropdownVisible(e){downloadDropdownContent.classList.toggle("visible",e),downloadButton.setAttribute("aria-expanded",e?"true":"false")}function setMoreActionsDropdownVisible(e){moreActionsContent.classList.toggle("visible",e),moreActionsButton.setAttribute("aria-expanded",e?"true":"false")}function setAdvancedSettingsVisible(e){advancedSettingsBody.classList.toggle("visible",e),advancedSettingsToggle.classList.toggle("open",e),advancedSettingsToggle.setAttribute("aria-expanded",e?"true":"false")}function setOutputLanguageMenuVisible(e){outputLanguageMenu.classList.toggle("visible",e),outputLanguageButton.classList.toggle("open",e),outputLanguageButton.setAttribute("aria-expanded",e?"true":"false")}function closeHeaderDropdowns(e){e!=="user"&&setUserDropdownVisible(!1),e!=="progress"&&setProgressDropdownVisible(!1),e!=="download"&&setDownloadDropdownVisible(!1),e!=="more-actions"&&setMoreActionsDropdownVisible(!1),e!=="language"&&setOutputLanguageMenuVisible(!1)}function showAuthModal(e="signin"){openOverlay(authOverlay),showAuthView(e),clearAuthErrors(),trackEvent("auth_modal_opened",{view:e||"signin"})}function hideAuthModal(){closeOverlay(authOverlay),clearAuthErrors(),signinForm.reset(),signupForm.reset(),resetForm.reset()}function showAuthView(e){signinView.classList.remove("active"),signupView.classList.remove("active"),resetView.classList.remove("active"),clearAuthErrors(),e==="signin"&&signinView.classList.add("active"),e==="signup"&&signupView.classList.add("active"),e==="reset"&&resetView.classList.add("active")}function clearAuthErrors(){[signinError,signupError,resetError,resetSuccess].forEach(e=>{e.classList.remove("visible"),e.textContent=""})}function showAuthError(e,t){e.textContent=t,e.classList.add("visible")}function getFirebaseErrorMessage(e){return{"auth/email-already-in-use":"This email is already registered. Please sign in instead.","auth/invalid-email":"Please enter a valid email address.","auth/weak-password":"Password should be at least 6 characters.","auth/user-not-found":"No account found with this email.","auth/wrong-password":"Incorrect password. Please try again.","auth/invalid-credential":"Invalid email or password. Please try again.","auth/too-many-requests":"Too many failed attempts. Please try again later.","auth/network-request-failed":"Network error. Please check your connection."}[e.code]||e.message||"An error occurred. Please try again."}async function checkEmailAllowed(e){try{return await(await fetch("/api/verify-email",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:e})})).json()}catch(t){return{allowed:!1,message:"Could not verify email. Please try again."}}}async function signInWithEmail(e,t){try{const n=await checkEmailAllowed(e);if(!n.allowed){trackEvent("auth_failed",{method:"email",reason:"disallowed_email"}),showAuthError(signinError,n.message);return}await auth.signInWithEmailAndPassword(e,t),hideAuthModal(),showToast("Signed in successfully!","success"),trackEvent("auth_success",{method:"email"})}catch(n){trackEvent("auth_failed",{method:"email",reason:n.code||"unknown"}),captureClientError(n,"signin_email"),showAuthError(signinError,getFirebaseErrorMessage(n))}}async function signUpWithEmail(e,t){try{const n=await checkEmailAllowed(e);if(!n.allowed){trackEvent("auth_failed",{method:"signup_email",reason:"disallowed_email"}),showAuthError(signupError,n.message);return}await auth.createUserWithEmailAndPassword(e,t),hideAuthModal(),showToast("Account created successfully!","success"),trackEvent("auth_success",{method:"signup_email"})}catch(n){trackEvent("auth_failed",{method:"signup_email",reason:n.code||"unknown"}),captureClientError(n,"signup_email"),showAuthError(signupError,getFirebaseErrorMessage(n))}}async function signInWithGoogle(){const e=new firebase.auth.GoogleAuthProvider;try{const t=await auth.signInWithPopup(e),n=t.user.email||"",s=await checkEmailAllowed(n);if(!s.allowed){try{await t.user.delete()}catch(o){console.warn("Could not delete disallowed Google user immediately:",o)}await auth.signOut(),trackEvent("auth_failed",{method:"google",reason:"disallowed_email"}),showAuthError(signinView.classList.contains("active")?signinError:signupError,s.message);return}hideAuthModal(),showToast("Signed in successfully!","success"),trackEvent("auth_success",{method:"google"})}catch(t){trackEvent("auth_failed",{method:"google",reason:t.code||"unknown"}),captureClientError(t,"signin_google"),showAuthError(signinView.classList.contains("active")?signinError:signupError,getFirebaseErrorMessage(t))}}async function sendPasswordReset(e){try{await auth.sendPasswordResetEmail(e),resetSuccess.textContent="Password reset email sent! Check your inbox.",resetSuccess.classList.add("visible")}catch(t){showAuthError(resetError,getFirebaseErrorMessage(t))}}async function signOut(){try{await releaseImportedAudioToken({clearStatus:!0});try{await fetch("/api/session/logout",{method:"POST",credentials:"include"})}catch(e){}await auth.signOut(),showToast("Signed out","success")}catch(e){console.error(e),captureClientError(e,"fetch_user_data")}}async function fetchUserData(){if(currentUser)try{const e=await authenticatedFetch("/api/auth/user");if(!e.ok){(e.status===401||e.status===403)&&(currentUserIsAdmin=!1,userPreferences=null,closeLanguageOnboarding(),adminDashboardBtn.style.display="none");return}const t=await e.json();userCredits=t.credits,userTotalProcessed=Number(t.total_processed||0),currentUserIsAdmin=!!t.is_admin,userPreferences=t.preferences&&typeof t.preferences=="object"?t.preferences:null,adminDashboardBtn.style.display=currentUserIsAdmin?"flex":"none",userPreferences&&applyPreferencesToOutputLanguage(userPreferences,{forceOnboardingOpen:!0}),updateCreditsDisplay(),await fetchStudyProgressSummary(),refreshStudyHeaderMetrics(),updateQuickstartVisibility()}catch(e){console.error(e)}}function updateCreditsDisplay(){if(!userCredits)return;const e=userCredits.lecture_standard+userCredits.lecture_extended,t=userCredits.interview_short+userCredits.interview_medium+userCredits.interview_long,n=e+userCredits.slides+t,s=`Lecture: ${e}
Slides: ${userCredits.slides}
Interview: ${t}
Total: ${n}`;creditsCount.textContent=n,creditsDisplay.setAttribute("data-tooltip",s),creditsTooltip&&(creditsTooltip.textContent=s),dropdownLectureCredits.textContent=e,dropdownSlidesCredits.textContent=userCredits.slides,dropdownInterviewCredits.textContent=t,updateInterviewOptionAvailability(),updateModeCostSummary(),updateProcessButton(),refreshStudyHeaderMetrics()}function getTotalInterviewCredits(){return userCredits?userCredits.interview_short+userCredits.interview_medium+userCredits.interview_long:0}function getInterviewExtraCost(){return currentMode==="interview"?selectedInterviewFeatures.length:0}function getInterviewFeaturesValue(){return selectedInterviewFeatures.length?selectedInterviewFeatures.length===2?"both":selectedInterviewFeatures[0]:"none"}function updateModeCostSummary(){if(!modeCostSummary)return;if(!userCredits){modeCostSummary.textContent="Sign in to view run cost and available credits.";return}const e=userCredits.lecture_standard+userCredits.lecture_extended,t=userCredits.slides,n=getTotalInterviewCredits();if(currentMode==="lecture-notes"){modeCostSummary.textContent=`This run costs 1 lecture credit. You have ${e} lecture credits.`;return}if(currentMode==="slides-only"){modeCostSummary.textContent=`This run costs 1 slides credit. You have ${t} slides credits.`;return}const s=getInterviewExtraCost();s>0?modeCostSummary.textContent=`This run costs 1 interview credit + ${s} slides credits for slide-pipeline extras. You have ${n} interview credits and ${t} slides credits.`:modeCostSummary.textContent=`This run costs 1 interview credit. Optional extras use slides credits (slide pipeline). You have ${n} interview credits and ${t} slides credits.`}function updateInterviewOptionAvailability(){const e=userCredits?Number(userCredits.slides||0):Number.POSITIVE_INFINITY,t=selectedInterviewFeatures.length;interviewOptionButtons.forEach(n=>{const s=n.dataset.feature,o=selectedInterviewFeatures.includes(s),i=o?Math.max(0,t-1):t+1,r=e>=i;n.disabled=!r&&!o,n.classList.toggle("disabled",n.disabled),n.title=n.disabled?"Not enough slides credits for this extra.":"",n.setAttribute("aria-disabled",n.disabled?"true":"false")})}function updateModeCreditDisplay(){if(currentMode!=="interview"){setSanitizedHtml(modeCreditCost,modeConfig[currentMode].creditCost),updateModeCostSummary();return}const e=getInterviewExtraCost();e?setSanitizedHtml(modeCreditCost,`Uses <strong>1 interview credit</strong> + <strong>${e} slides credits</strong> for selected extras.`):setSanitizedHtml(modeCreditCost,"Uses <strong>1 interview credit</strong>. Optional extras cost <strong>1 slides credit</strong> each."),updateModeCostSummary()}function setStudyFeature(e){selectedStudyFeatures=["none","flashcards","test","both"].includes(e)?e:"none";const t={none:"No study tools",flashcards:"Flashcards only",test:"Practice test only",both:"Flashcards + test"};if(studyToolsToggleText.textContent=t[selectedStudyFeatures],studyToolChips.forEach(o=>{o.classList.toggle("active",o.dataset.studyFeatures===selectedStudyFeatures)}),selectedStudyFeatures==="none"?studyToolsNote.textContent="Notes-only output. No flashcards or test questions will be generated.":selectedStudyFeatures==="flashcards"?studyToolsNote.textContent="Only flashcards will be generated.":selectedStudyFeatures==="test"?studyToolsNote.textContent="Only practice test questions will be generated.":studyToolsNote.textContent="Recommended for first runs: both flashcards and practice test questions will be generated.",currentUser&&currentUser.uid)try{localStorage.setItem(`study_tools_pref_${currentUser.uid}`,selectedStudyFeatures)}catch(o){}const n=currentMode==="interview"||selectedStudyFeatures==="none"||selectedStudyFeatures==="test",s=currentMode==="interview"||selectedStudyFeatures==="none"||selectedStudyFeatures==="flashcards";flashcardAmountChips.forEach(o=>{o.disabled=n}),questionAmountChips.forEach(o=>{o.disabled=s}),flashcardAmountControl.style.display=n?"none":"",questionAmountControl.style.display=s?"none":"",updateProcessButton()}function setAmountSelection(e,t){e==="flashcards"?(selectedFlashcardAmount=t,flashcardAmountChips.forEach(n=>n.classList.toggle("active",n.dataset.value===t))):(selectedQuestionAmount=t,questionAmountChips.forEach(n=>n.classList.toggle("active",n.dataset.value===t)))}function updateInterviewOptionsUI(){if(userCredits){const t=Math.max(0,Number(userCredits.slides||0));selectedInterviewFeatures.length>t&&(selectedInterviewFeatures=selectedInterviewFeatures.slice(0,t))}updateInterviewOptionAvailability(),interviewOptionButtons.forEach(t=>{t.classList.toggle("active",selectedInterviewFeatures.includes(t.dataset.feature))});const e=userCredits?Number(userCredits.slides||0):0;!selectedInterviewFeatures.length&&userCredits&&e<=0?interviewExtraNote.textContent="No extras selected. You currently have 0 slides credits, so slide-pipeline extras are disabled.":selectedInterviewFeatures.length?selectedInterviewFeatures.length===1?interviewExtraNote.textContent="Selected 1 extra option. This adds 1 slides credit (slide-processing pipeline).":interviewExtraNote.textContent="Selected both extra options. This adds 2 slides credits (slide-processing pipeline).":interviewExtraNote.textContent="No extras selected. Select one or both options (1 slides credit per option via the slide-processing pipeline).",updateModeCreditDisplay(),updateProcessButton()}function updateOutputLanguageInput(){const e=outputLanguageSelect.value==="other";outputLanguageCustom.style.display=e?"block":"none",e||(outputLanguageCustom.value="")}function getLanguageLabel(e,t=""){const n=String(e||"english").trim().toLowerCase();if(n==="other"){const s=String(t||"").trim();return s?`\u{1F310} ${s}`:OUTPUT_LANGUAGE_LABELS.other}return OUTPUT_LANGUAGE_LABELS[n]||OUTPUT_LANGUAGE_LABELS.english}function setOutputLanguage(e,t){const n=Object.prototype.hasOwnProperty.call(OUTPUT_LANGUAGE_LABELS,e)?e:"english";outputLanguageSelect.value=n,outputLanguageLabel.textContent=t||getLanguageLabel(n,outputLanguageCustom.value),outputLanguageItems.forEach(s=>{const o=s.dataset.value===n;s.classList.toggle("active",o),s.setAttribute("aria-selected",o?"true":"false")}),updateOutputLanguageInput()}function clearLanguagePreferenceSaveTimer(){languagePreferenceSaveTimer&&(clearTimeout(languagePreferenceSaveTimer),languagePreferenceSaveTimer=null)}async function saveUserPreferences(e){if(!currentUser)return{ok:!1,error:"Please sign in"};try{const t=await authenticatedFetch("/api/user-preferences",{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(e||{})}),n=await t.json().catch(()=>({}));return t.ok?(n.preferences&&typeof n.preferences=="object"&&(userPreferences=n.preferences),{ok:!0,preferences:userPreferences}):{ok:!1,error:n.error||"Could not save preferences."}}catch(t){return captureClientError(t,"save_user_preferences"),{ok:!1,error:"Could not save preferences."}}}function setOnboardingError(e){if(!languageOnboardingError)return;const t=String(e||"").trim();languageOnboardingError.textContent=t,languageOnboardingError.classList.toggle("visible",!!t)}function setOnboardingLanguageSelection(e){const t=String(e||"english").trim().toLowerCase();languageOnboardingButtons.forEach(s=>{s.classList.toggle("active",s.dataset.value===t)});const n=t==="other";languageOnboardingCustom.style.display=n?"block":"none",n||(languageOnboardingCustom.value="")}function getOnboardingLanguageSelection(){const e=Array.from(languageOnboardingButtons).find(n=>n.classList.contains("active")),t=e?String(e.dataset.value||"english").trim().toLowerCase():"english";return{value:t,custom:t==="other"?String(languageOnboardingCustom.value||"").trim():""}}function closeLanguageOnboarding(){languageOnboardingOpen&&(languageOnboardingOpen=!1,setOnboardingError(""),closeOverlay(languageOnboardingOverlay))}function openLanguageOnboarding(e=null){if(!currentUser||languageOnboardingOpen)return;const t=e&&typeof e=="object"?e:userPreferences||{},n=String(t.output_language||outputLanguageSelect.value||"english").trim().toLowerCase(),s=String(t.output_language_custom||outputLanguageCustom.value||"").trim();setOnboardingLanguageSelection(n),languageOnboardingCustom.value=s,n==="other"&&(languageOnboardingCustom.style.display="block"),languageOnboardingSaveBtn.disabled=!1,setOnboardingError(""),languageOnboardingOpen=!0,openOverlay(languageOnboardingOverlay)}async function saveLanguageOnboardingPreference(){if(!currentUser||languageOnboardingSaving)return;const e=getOnboardingLanguageSelection();if(e.value==="other"&&!e.custom){setOnboardingError("Please enter a custom language.");return}languageOnboardingSaving=!0,languageOnboardingSaveBtn.disabled=!0,setOnboardingError("");const t=await saveUserPreferences({output_language:e.value,output_language_custom:e.custom,onboarding_completed:!0});if(languageOnboardingSaving=!1,languageOnboardingSaveBtn.disabled=!1,!t.ok){setOnboardingError(t.error||"Could not save preference.");return}suppressLanguagePreferencePersist=!0,setOutputLanguage(e.value,getLanguageLabel(e.value,e.custom)),e.value==="other"&&(outputLanguageCustom.value=e.custom),suppressLanguagePreferencePersist=!1,closeLanguageOnboarding(),showToast("Default language saved.","success")}async function persistCurrentOutputLanguage(e={}){if(!currentUser||suppressLanguagePreferencePersist)return;const t=String(outputLanguageSelect.value||"english").trim().toLowerCase(),n=t==="other"?String(outputLanguageCustom.value||"").trim():"";if(t==="other"&&!n){e.strict&&showToast("Please enter a custom language before saving.","info");return}const s={output_language:t,output_language_custom:n};Object.prototype.hasOwnProperty.call(e,"onboarding_completed")&&(s.onboarding_completed=!!e.onboarding_completed);const o=await saveUserPreferences(s);!o.ok&&e.showErrorToast&&showToast(o.error||"Could not save language preference.","error")}function scheduleLanguagePreferenceSave(){!currentUser||suppressLanguagePreferencePersist||languageOnboardingOpen||(clearLanguagePreferenceSaveTimer(),languagePreferenceSaveTimer=setTimeout(()=>{persistCurrentOutputLanguage({showErrorToast:!0})},500))}function applyPreferencesToOutputLanguage(e,t={}){const n=e&&typeof e=="object"?e:{},s=String(n.output_language||"english").trim().toLowerCase(),o=["dutch","english","spanish","french","german","chinese","other"].includes(s)?s:"english",i=String(n.output_language_custom||"").trim();suppressLanguagePreferencePersist=!0,setOutputLanguage(o,getLanguageLabel(o,i)),o==="other"&&(outputLanguageCustom.value=i),suppressLanguagePreferencePersist=!1,t.forceOnboardingOpen&&(n.onboarding_completed?closeLanguageOnboarding():openLanguageOnboarding(n))}function setQuickstartVisible(e){quickstartCard&&(quickstartCard.style.display=e?"":"none")}function applyStoredStudyFeaturePreference(e){if(!e||!e.uid)return;let t="";try{t=localStorage.getItem(`study_tools_pref_${e.uid}`)||""}catch(s){}const n=["none","flashcards","test","both"].includes(t)?t:"both";setStudyFeature(n)}function applyRecommendedSetup(){switchMode("lecture-notes"),setStudyFeature("both"),setAdvancedSettingsVisible(!0),showToast("Recommended setup applied: Lecture Notes + Flashcards + Test.","success");try{uploadSection.scrollIntoView({behavior:"smooth",block:"start"})}catch(e){}}function updateQuickstartVisibility(){if(!currentUser||!quickstartCard){setQuickstartVisible(!1);return}const e=Number(userTotalProcessed||0)<=0;let t=!1;try{t=localStorage.getItem(`quickstart_dismissed_${currentUser.uid}`)==="1"}catch(n){}setQuickstartVisible(e&&!t&&!resultsLocked)}function updateUIForAuthState(e){if(e){closeHeaderDropdowns(""),headerSignInBtn.style.display="none",creditsDisplay.style.display="flex",headerStudyLibraryBtn.style.display="inline-flex",progressMenu.style.display="block",userMenu.style.display="block",adminDashboardBtn.style.display="none",signInRequired.classList.remove("visible"),uploadSection.style.display="grid",uploadEstimate.style.display="",buttonSection.style.display="block",languageControls.style.display="grid",setAdvancedSettingsVisible(!1),applyStoredStudyFeaturePreference(e);const t=e.displayName||e.email.split("@")[0],n=t.charAt(0).toUpperCase();if(userAvatar.innerHTML="",e.photoURL){const s=document.createElement("img");s.src=e.photoURL,s.alt=t,userAvatar.appendChild(s)}else{const s=document.createElement("span");s.textContent=n,userAvatar.appendChild(s)}userName.textContent=t,topbarUtils.applyAuthState?topbarUtils.applyAuthState({user:e,userTextEl:userEmail,signedInText:function(s){return s&&s.email?s.email:""}}):userEmail.textContent=e.email,switchMode(currentMode),updateModeCostSummary(),refreshStudyHeaderMetrics(),updateQuickstartVisibility()}else closeHeaderDropdowns(""),headerSignInBtn.style.display="flex",creditsDisplay.style.display="none",headerStudyLibraryBtn.style.display="none",progressMenu.style.display="none",userMenu.style.display="none",signInRequired.classList.add("visible"),uploadSection.style.display="none",uploadEstimate.style.display="none",buttonSection.style.display="none",generationControls.classList.add("hidden"),generationControls.style.display="none",interviewControls.classList.add("hidden"),languageControls.style.display="none",setAdvancedSettingsVisible(!1),releaseImportedAudioToken({clearStatus:!0}),currentUser=null,userCredits=null,idToken=null,authClient&&typeof authClient.clearToken=="function"&&authClient.clearToken(),progressSummaryCache=null,userTotalProcessed=0,currentUserIsAdmin=!1,userPreferences=null,clearLanguagePreferenceSaveTimer(),closeLanguageOnboarding(),uploadCooldownUntilMs=0,clearUploadCooldownTimer(),modalStateStack=[],activeModalOverlay=null,adminDashboardBtn.style.display="none",updateInterviewOptionAvailability(),updateModeCostSummary(),setQuickstartVisible(!1)}let handlingDisallowedAuthState=!1;auth.onAuthStateChanged(async e=>{if(!handlingDisallowedAuthState)if(currentUser=e,e){const t=await checkEmailAllowed(e.email||"");if(!t.allowed){handlingDisallowedAuthState=!0;try{await auth.signOut()}catch(s){console.error(s),captureClientError(s,"disallowed_signout")}finally{handlingDisallowedAuthState=!1}updateUIForAuthState(null);const n=signupView.classList.contains("active")?"signup":"signin";showAuthModal(n),showAuthError(n==="signup"?signupError:signinError,t.message||"This email is not allowed.");return}idToken=await e.getIdToken(),authClient&&typeof authClient.setToken=="function"&&authClient.setToken(idToken),updateUIForAuthState(e),await fetchUserData(),await checkPaymentResult()}else updateUIForAuthState(null)}),setInterval(async()=>{currentUser&&(idToken=await currentUser.getIdToken(!0),authClient&&typeof authClient.setToken=="function"&&authClient.setToken(idToken))},600*1e3);function formatFileSize(e){if(!e)return"0 Bytes";const t=1024,n=["Bytes","KB","MB","GB"],s=Math.floor(Math.log(e)/Math.log(t));return`${parseFloat((e/Math.pow(t,s)).toFixed(2))} ${n[s]}`}function currentAudioBytes(){return audioFile?Number(audioFile.size||0):currentMode!=="lecture-notes"?0:Number(importedAudioSizeBytes||0)}function setAudioImportStatus(e="",t=!1){if(!audioUrlStatus)return;const n=String(e||"").trim();audioUrlStatus.textContent=n,audioUrlStatus.classList.toggle("error",!!(t&&n))}function setAudioImportPending(e){audioUrlFetchBtn&&(audioUrlFetchBtn.dataset.defaultLabel||(audioUrlFetchBtn.dataset.defaultLabel=audioUrlFetchBtn.textContent||"Import Audio"),audioUrlFetchBtn.disabled=!!e,audioUrlFetchBtn.textContent=e?"Importing...":audioUrlFetchBtn.dataset.defaultLabel||"Import Audio")}function syncAudioInfoUI(){if(audioFile){audioName.textContent=audioFile.name,audioSize.textContent=formatFileSize(audioFile.size),audioInfo.style.display="flex",audioZone.classList.add("has-file");return}if(importedAudioToken){audioName.textContent=importedAudioName||"Imported audio",audioSize.textContent=importedAudioSizeBytes>0?`${formatFileSize(importedAudioSizeBytes)} \xB7 Imported from URL`:"Imported from URL",audioInfo.style.display="flex",audioZone.classList.add("has-file");return}audioInfo.style.display="none",audioZone.classList.remove("has-file")}function clearImportedAudioLocalState(){importedAudioToken="",importedAudioSizeBytes=0,importedAudioName=""}async function releaseImportedAudioToken(e={}){const t=String(importedAudioToken||"").trim(),n=e.clearStatus!==!1;if(!t){n&&setAudioImportStatus("");return}if(clearImportedAudioLocalState(),audioFile||syncAudioInfoUI(),n&&setAudioImportStatus(""),!!currentUser)try{await authenticatedFetch("/api/import-audio-url/release",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({audio_import_token:t})})}catch(s){}}async function applyImportedAudio(e,t=""){const n=String(e&&e.audio_import_token?e.audio_import_token:"").trim();if(!n)return!1;importedAudioToken=n,importedAudioName=String(e.file_name||"Imported audio.mp3").trim(),importedAudioSizeBytes=Math.max(0,Number(e.size_bytes||0)),audioFile&&(audioFile=null,audioInput.value=""),syncAudioInfoUI(),updateProcessButton();const s=Math.max(0,Number(e.expires_in_seconds||0));if(s>0){const o=Math.max(1,Math.round(s/60));setAudioImportStatus(`Imported ${importedAudioName}. Token expires in about ${o} minute${o===1?"":"s"}.`)}else setAudioImportStatus(`Imported ${importedAudioName}.`);if(t&&t!==n&&currentUser)try{await authenticatedFetch("/api/import-audio-url/release",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({audio_import_token:t})})}catch(o){}return!0}async function importAudioFromUrl(){if(!currentUser){showAuthModal("signin");return}if(currentMode!=="lecture-notes"){setAudioImportStatus("URL import is only available in Lecture Notes mode.",!0);return}const e=String(audioUrlInput.value||"").trim();if(!e){setAudioImportStatus("Paste the Brightspace/Kaltura m3u8 URL first.",!0);return}setAudioImportPending(!0),setAudioImportStatus("Importing audio from URL...");const t=String(importedAudioToken||"").trim();try{const n=await authenticatedFetch("/api/import-audio-url",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({url:e})}),s=await n.json().catch(()=>({}));if(!n.ok){const i=getRetryAfterSeconds(n,s),r=String(s.error||"Could not import audio from URL.");n.status===429&&i>0?setAudioImportStatus(`${r} Try again in ${formatRetryDelay(i)}.`,!0):setAudioImportStatus(r,!0);return}await applyImportedAudio(s,t)&&showToast("Audio imported from URL.","success")}catch(n){captureClientError(n,"import_audio_url"),setAudioImportStatus("Could not import audio from URL. Please try again.",!0)}finally{setAudioImportPending(!1)}}function renderToastIcon(e){for(;toastIcon.firstChild;)toastIcon.removeChild(toastIcon.firstChild);const t="http://www.w3.org/2000/svg",n=(s,o)=>{const i=document.createElementNS(t,s);Object.entries(o||{}).forEach(([r,a])=>i.setAttribute(r,String(a))),toastIcon.appendChild(i)};if(e==="success"){n("polyline",{points:"20 6 9 17 4 12"});return}if(e==="error"){n("circle",{cx:"12",cy:"12",r:"10"}),n("line",{x1:"15",y1:"9",x2:"9",y2:"15"}),n("line",{x1:"9",y1:"9",x2:"15",y2:"15"});return}n("circle",{cx:"12",cy:"12",r:"10"}),n("line",{x1:"12",y1:"16",x2:"12",y2:"12"}),n("line",{x1:"12",y1:"8",x2:"12.01",y2:"8"})}function showToast(e,t="success",n=3e3){toastText.textContent=e,toast.className=`toast visible ${t}`,renderToastIcon(t),setTimeout(()=>toast.classList.remove("visible"),n)}function getRetryAfterSeconds(e,t){const n=Number(t&&t.retry_after_seconds||0);if(Number.isFinite(n)&&n>0)return Math.ceil(n);const s=Number(e&&e.headers&&e.headers.get("Retry-After")||0);return Number.isFinite(s)&&s>0?Math.ceil(s):0}function formatRetryDelay(e){const t=Math.max(0,Number(e)||0);if(!t)return"";if(t<60)return`${t}s`;const n=Math.floor(t/60),s=t%60;return s?`${n}m ${s}s`:`${n}m`}function ensureBundleButtonDefaults(){document.querySelectorAll(".bundle-buy-btn").forEach(e=>{e.dataset.defaultLabel||(e.dataset.defaultLabel=e.textContent||"Buy now")})}function getCheckoutCooldownSeconds(){return checkoutCooldownUntilMs?Math.max(0,Math.ceil((checkoutCooldownUntilMs-Date.now())/1e3)):0}function clearCheckoutCooldownTimer(){checkoutCooldownTimer&&(clearInterval(checkoutCooldownTimer),checkoutCooldownTimer=null)}function applyCheckoutButtonsState(){ensureBundleButtonDefaults();const e=document.querySelectorAll(".bundle-buy-btn"),t=getCheckoutCooldownSeconds();if(t>0){const n=`Try again in ${formatRetryDelay(t)}`;e.forEach(s=>{s.disabled=!0,s.textContent=n});return}if(checkoutRequestInFlight){e.forEach(n=>{n.disabled=!0});return}e.forEach(n=>{n.disabled=!1,n.textContent=n.dataset.defaultLabel||"Buy now"})}function startCheckoutCooldown(e){const t=Math.max(1,Math.ceil(Number(e)||0));checkoutCooldownUntilMs=Date.now()+t*1e3,clearCheckoutCooldownTimer(),applyCheckoutButtonsState(),checkoutCooldownTimer=setInterval(()=>{getCheckoutCooldownSeconds()<=0&&(checkoutCooldownUntilMs=0,clearCheckoutCooldownTimer()),applyCheckoutButtonsState()},1e3)}function getUploadCooldownSeconds(){return uploadCooldownUntilMs?Math.max(0,Math.ceil((uploadCooldownUntilMs-Date.now())/1e3)):0}function clearUploadCooldownTimer(){uploadCooldownTimer&&(clearInterval(uploadCooldownTimer),uploadCooldownTimer=null)}function startUploadCooldown(e){const t=Math.max(1,Math.ceil(Number(e)||0));uploadCooldownUntilMs=Date.now()+t*1e3,clearUploadCooldownTimer(),updateProcessButton(),uploadCooldownTimer=setInterval(()=>{getUploadCooldownSeconds()<=0&&(uploadCooldownUntilMs=0,clearUploadCooldownTimer()),updateProcessButton()},1e3)}function hasEnoughCredits(){if(!userCredits)return!1;const e=modeConfig[currentMode];if(e.creditType==="lecture")return userCredits.lecture_standard+userCredits.lecture_extended>0;if(e.creditType==="slides")return userCredits.slides>0;if(e.creditType==="interview"){const t=getInterviewExtraCost();return getTotalInterviewCredits()>0&&userCredits.slides>=t}return!1}function formatEstimateDuration(e){const t=Math.max(20,Math.round(Number(e)||0));return t<60?`${t}s`:`${Math.round(t/60)} min`}function calculateProcessingEstimateSeconds(){const e=pdfFile?pdfFile.size/1048576:0,t=currentAudioBytes()/(1024*1024);if(currentMode==="lecture-notes")return 55+e*.6+t*1;if(currentMode==="slides-only")return 20+e*.55;const n=getInterviewExtraCost();return 35+t*1.15+n*18}function updateUploadEstimatePanel(){if(!uploadEstimate||!uploadEstimateTime||!uploadEstimateMeta)return;if(!currentUser||resultsLocked){uploadEstimate.style.display="none";return}uploadEstimate.style.display="";const e=modeConfig[currentMode],t=!e.needsPdf||!!pdfFile,n=!e.needsAudio||!!(audioFile||currentMode==="lecture-notes"&&importedAudioToken),s=calculateProcessingEstimateSeconds(),o=Math.max(20,Math.round(s*.7)),i=Math.max(o+10,Math.round(s*1.35)),r=t&&n?`Estimated processing time: ${formatEstimateDuration(o)} - ${formatEstimateDuration(i)}`:"Upload required files to get a better estimate.";uploadEstimateTime.textContent=r;const l=((pdfFile?Number(pdfFile.size||0):0)+currentAudioBytes())/(1024*1024);if(currentMode==="lecture-notes")uploadEstimateMeta.textContent=`Requires PDF or PPTX (max 50 MB) + audio (max 500 MB). Current upload: ${l.toFixed(1)} MB.`;else if(currentMode==="slides-only")uploadEstimateMeta.textContent=`Requires PDF or PPTX (max 50 MB). Current upload: ${l.toFixed(1)} MB.`;else{const c=getInterviewExtraCost();uploadEstimateMeta.textContent=`Requires audio only (max 500 MB). Selected extras: ${c} (${c} slides credits). Current upload: ${l.toFixed(1)} MB.`}}function updateProcessButton(){const e=modeConfig[currentMode],t=!e.needsPdf||pdfFile,n=!e.needsAudio||audioFile||currentMode==="lecture-notes"&&importedAudioToken,s=hasEnoughCredits(),o=getUploadCooldownSeconds();if(updateUploadEstimatePanel(),o>0){processButton.disabled=!0,processButton.querySelector("span").textContent=`Try again in ${formatRetryDelay(o)}`,noCreditsWarning.classList.remove("visible");return}if(processButton.disabled=!(t&&n&&s)||resultsLocked,processButton.querySelector("span").textContent=e.buttonText,currentUser&&!s&&!resultsLocked){currentMode==="interview"&&getTotalInterviewCredits()>0&&userCredits.slides<getInterviewExtraCost()?setSanitizedHtml(noCreditsWarning,`You don't have enough slides credits for the selected interview extras (slide-processing pipeline). <a href="#" id="buy-credits-link-inline">Buy more credits</a>`):setSanitizedHtml(noCreditsWarning,`You don't have enough credits. <a href="#" id="buy-credits-link-inline">Buy more credits</a>`),noCreditsWarning.classList.add("visible");const i=document.getElementById("buy-credits-link-inline");i&&i.addEventListener("click",r=>{r.preventDefault(),showPricingModal()})}else noCreditsWarning.classList.remove("visible")}function switchMode(e){currentMode=e;const t=modeConfig[e];modeTabs.forEach(n=>{const s=n.dataset.mode===e;n.classList.toggle("active",s),n.setAttribute("aria-selected",s?"true":"false"),n.tabIndex=s?0:-1}),modeDescriptionText.textContent=t.description,audioZoneTitle.textContent=t.audioTitle,generationControls.classList.toggle("hidden",e==="interview"),generationControls.style.display=e==="interview"?"none":"grid",interviewControls.classList.toggle("hidden",e!=="interview"),e==="interview"&&(studyToolsPanel.classList.remove("visible"),studyToolsToggle.classList.remove("open")),updateModeCreditDisplay(),t.needsPdf&&t.needsAudio?(uploadSection.classList.remove("single-upload"),pdfZone.classList.remove("hidden"),audioZone.classList.remove("hidden")):t.needsPdf?(uploadSection.classList.add("single-upload"),pdfZone.classList.remove("hidden"),audioZone.classList.add("hidden")):(uploadSection.classList.add("single-upload"),pdfZone.classList.add("hidden"),audioZone.classList.remove("hidden")),t.needsPdf||(pdfFile=null,pdfInput.value="",pdfInfo.style.display="none",pdfZone.classList.remove("has-file")),t.needsAudio||(audioFile=null,audioInput.value="",releaseImportedAudioToken({clearStatus:!0}),syncAudioInfoUI()),e!=="lecture-notes"&&importedAudioToken&&(releaseImportedAudioToken({clearStatus:!0}),syncAudioInfoUI()),audioUrlImport&&(audioUrlImport.style.display=e==="lecture-notes"?"":"none"),setStudyFeature(selectedStudyFeatures),updateInterviewOptionsUI(),updateProcessButton()}modeTabs.forEach(e=>e.addEventListener("click",()=>switchMode(e.dataset.mode))),modeTabs.forEach((e,t)=>e.addEventListener("keydown",n=>{if(modeTabs.length){if(n.key==="ArrowRight"||n.key==="ArrowDown"){n.preventDefault();const s=modeTabs[(t+1)%modeTabs.length];switchMode(s.dataset.mode),s.focus()}else if(n.key==="ArrowLeft"||n.key==="ArrowUp"){n.preventDefault();const s=modeTabs[(t-1+modeTabs.length)%modeTabs.length];switchMode(s.dataset.mode),s.focus()}else if(n.key==="Home"){n.preventDefault();const s=modeTabs[0];switchMode(s.dataset.mode),s.focus()}else if(n.key==="End"){n.preventDefault();const s=modeTabs[modeTabs.length-1];switchMode(s.dataset.mode),s.focus()}}})),advancedSettingsToggle.addEventListener("click",()=>{const e=!advancedSettingsBody.classList.contains("visible");setAdvancedSettingsVisible(e),e||(setOutputLanguageMenuVisible(!1),studyToolsPanel.classList.remove("visible"),studyToolsToggle.classList.remove("open"))});function handlePdfFile(e){if(!e)return;const t=String(e.name||"").toLowerCase(),n=allowedSlideExtensions.some(i=>t.endsWith(i)),s=String(e.type||"").toLowerCase(),o=allowedSlideMimeTypes.includes(s);if(!n||!o){showToast("Please select a valid PDF or PPTX file","error");return}if(e.size>50*1024*1024){showToast("Slide file must be under 50 MB","error");return}pdfFile=e,pdfName.textContent=e.name,pdfSize.textContent=formatFileSize(e.size),pdfInfo.style.display="flex",pdfZone.classList.add("has-file"),updateProcessButton()}function handleAudioFile(e){if(!e)return;if(![".mp3",".m4a",".wav",".aac",".ogg",".flac"].some(n=>e.name.toLowerCase().endsWith(n))){showToast("Please select a valid audio file","error");return}if(e.size>500*1024*1024){showToast("Audio file must be under 500 MB","error");return}importedAudioToken&&releaseImportedAudioToken({clearStatus:!0}),audioFile=e,syncAudioInfoUI(),updateProcessButton()}function setupDropZone(e,t,n){e.addEventListener("click",s=>{s.target.closest(".file-remove")||t.click()}),t.addEventListener("change",s=>{s.target.files.length&&n(s.target.files[0])}),e.addEventListener("dragover",s=>{s.preventDefault(),e.classList.add("drag-over")}),e.addEventListener("dragleave",s=>{s.preventDefault(),e.classList.remove("drag-over")}),e.addEventListener("drop",s=>{s.preventDefault(),e.classList.remove("drag-over"),s.dataTransfer.files.length&&n(s.dataTransfer.files[0])})}setupDropZone(pdfZone,pdfInput,handlePdfFile),setupDropZone(audioZone,audioInput,handleAudioFile),pdfRemove.addEventListener("click",e=>{e.stopPropagation(),pdfFile=null,pdfInput.value="",pdfInfo.style.display="none",pdfZone.classList.remove("has-file"),updateProcessButton()}),audioRemove.addEventListener("click",e=>{e.stopPropagation(),audioFile=null,audioInput.value="",importedAudioToken&&releaseImportedAudioToken({clearStatus:!0}),syncAudioInfoUI(),updateProcessButton()});function buildProgressSteps(e){progressSteps.innerHTML="",progressSteps.classList.toggle("single-step",e.length===1),e.forEach(t=>{const n=document.createElement("div");n.className="progress-step",n.id=`step-${t.num}`;const s=document.createElement("div");s.className="step-indicator",s.textContent=String(t.num);const o=document.createElement("div");o.className="step-label",o.textContent=String(t.label||""),n.appendChild(s),n.appendChild(o),progressSteps.appendChild(n)})}function updateProgressUI(e,t,n){for(let s=1;s<=n;s++){const o=document.getElementById(`step-${s}`);o&&(o.classList.remove("active","complete"),s<e?o.classList.add("complete"):s===e&&o.classList.add("active"))}statusText.textContent=t||"Processing..."}function getCurrentModeSteps(){return currentMode==="lecture-notes"?selectedStudyFeatures==="none"?modeConfig["lecture-notes"].steps.slice(0,3):modeConfig["lecture-notes"].steps:currentMode==="slides-only"?selectedStudyFeatures==="none"?modeConfig["slides-only"].steps.slice(0,1):modeConfig["slides-only"].steps:selectedInterviewFeatures.length>0?[{num:1,label:"Transcribe"},{num:2,label:"Create Extras"}]:modeConfig.interview.steps}function scheduleNextPoll(e){pollInterval&&clearTimeout(pollInterval),pollInterval=setTimeout(pollStatus,Math.max(0,e||0))}function setProgressRetryVisible(e){!progressRetry||!progressRetryBtn||(progressRetry.style.display=e?"flex":"none",e&&(progressRetryBtn.disabled=!1))}function retryStatusCheckNow(){if(!currentJobId){showToast("No active job to retry.","info"),setProgressRetryVisible(!1);return}setProgressRetryVisible(!1),progressStatus.classList.remove("error"),progressStatus.querySelector(".spinner").style.display="block",statusText.textContent="Re-checking job status...",trackEvent("processing_retry_requested",{job_id:currentJobId}),startPolling()}function startPolling(){stopPolling(),pollFailures=0,pollStartedAt=Date.now(),setProgressRetryVisible(!1),scheduleNextPoll(0)}function stopPolling(){pollInterval&&clearTimeout(pollInterval),pollInterval=null,pollFailures=0,pollStartedAt=0}async function authenticatedFetch(e,t={},n=!0){if(!currentUser)throw new Error("Please sign in");if(authClient&&typeof authClient.authFetch=="function"){const i=await authClient.authFetch(e,t,{retryOn401:n!==!1});if(authClient&&typeof authClient.getToken=="function"){const r=authClient.getToken();r&&(idToken=r)}return i}idToken||(idToken=await currentUser.getIdToken());const s={...t.headers||{},Authorization:`Bearer ${idToken}`},o=await fetch(e,{...t,headers:s});return o.status===401&&n?(idToken=await currentUser.getIdToken(!0),fetch(e,{...t,headers:{...t.headers||{},Authorization:`Bearer ${idToken}`}})):o}async function downloadAuthenticatedFile(e,t){const n=await authenticatedFetch(e);if(!n.ok){let r="Could not download file.";try{r=(await n.json()).error||r}catch(a){}throw new Error(r)}if(downloadUtils.downloadResponseBlob){await downloadUtils.downloadResponseBlob(n,t);return}const s=await n.blob(),o=URL.createObjectURL(s),i=document.createElement("a");i.href=o,i.download=t,document.body.appendChild(i),i.click(),document.body.removeChild(i),URL.revokeObjectURL(o)}async function exportMyAccountData(){if(!currentUser){showAuthModal("signin");return}if(!accountActionInFlight){accountActionInFlight=!0;try{const e=`lecture-processor-account-export-${localDateString()}.json`;await downloadAuthenticatedFile("/api/account/export",e),showToast("Your data export has been downloaded.","success",5e3)}catch(e){captureClientError(e,"account_export"),showToast(e.message||"Could not export your data.","error",5e3)}finally{accountActionInFlight=!1}}}async function deleteMyAccountData(){if(!currentUser){showAuthModal("signin");return}if(accountActionInFlight)return;const e=String(currentUser.email||"").trim();if(!e){showToast("Could not verify account email. Please sign in again.","error",5e3);return}const t=window.prompt(`This will permanently delete your account and stored data.

Type DELETE MY ACCOUNT to continue.`);if(t===null)return;if(t.trim().toUpperCase()!=="DELETE MY ACCOUNT"){showToast("Deletion cancelled: confirmation text did not match.","info",4500);return}const n=window.prompt(`Type your account email to confirm:
${e}`);if(n!==null){if(n.trim().toLowerCase()!==e.toLowerCase()){showToast("Deletion cancelled: email did not match.","info",4500);return}if(window.confirm("Final confirmation: this action is permanent and cannot be undone. Delete now?")){accountActionInFlight=!0;try{const s=await authenticatedFetch("/api/account/delete",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({confirm_text:"DELETE MY ACCOUNT",confirm_email:e})}),o=await s.json().catch(()=>({}));if(!s.ok)throw new Error(o.error||"Could not delete account data.");showToast("Account deleted. Signing out...","success",5e3);try{await auth.signOut()}catch(i){}window.location.href="/"}catch(s){captureClientError(s,"account_delete"),showToast(s.message||"Could not delete account data.","error",6e3)}finally{accountActionInFlight=!1}}}}async function pollStatus(){if(currentJobId){if(pollStartedAt&&Date.now()-pollStartedAt>POLL_MAX_RUNTIME_MS){stopPolling(),progressStatus.classList.add("error"),progressStatus.querySelector(".spinner").style.display="none",statusText.textContent="Still processing on the server. Use retry to check now, or check again in a minute.",showToast("Processing is taking longer than expected. Please check again shortly.","info",6e3),currentJobId&&trackedTerminalJobId!==currentJobId&&(trackedTerminalJobId=currentJobId,trackEvent("processing_timeout",{job_id:currentJobId})),setProgressRetryVisible(!0),updateProcessButton();return}try{const e=await authenticatedFetch(`/status/${currentJobId}`);if(e.status===401){stopPolling(),setProgressRetryVisible(!1),showAuthModal("signin");return}if(e.status===403){stopPolling(),setProgressRetryVisible(!1),showError("You do not have access to this job.");return}const t=await e.json();if(t.error&&t.status!=="error"){stopPolling(),setProgressRetryVisible(!1),showToast("Error: Job not found","error");return}updateProgressUI(t.step,t.step_description,t.total_steps),t.status==="complete"?(stopPolling(),setProgressRetryVisible(!1),currentJobId&&trackedTerminalJobId!==currentJobId&&(trackedTerminalJobId=currentJobId,trackEvent("processing_completed",{job_id:currentJobId})),showResults(t.result,t.slide_text,t.transcript,t.flashcards||[],t.test_questions||[],t.study_generation_error||null,t.study_pack_id||null,t.study_features||"none",t.interview_summary||"",t.interview_sections||"",t.interview_combined||"",t.interview_features_successful||[],t.billing_receipt||null),fetchUserData()):t.status==="error"?(stopPolling(),setProgressRetryVisible(!1),currentJobId&&trackedTerminalJobId!==currentJobId&&(trackedTerminalJobId=currentJobId,trackEvent("processing_failed",{job_id:currentJobId,credit_refunded:!!t.credit_refunded})),showError(t.error,t.credit_refunded,t.billing_receipt||null)):(setProgressRetryVisible(!1),pollFailures=0,scheduleNextPoll(POLL_BASE_MS))}catch(e){console.error(e),captureClientError(e,"poll_status"),pollFailures+=1;const t=Math.min(POLL_MAX_MS,POLL_BASE_MS*Math.pow(2,Math.min(pollFailures,5)));statusText.textContent=`Temporary connection issue. Retrying in ${Math.ceil(t/1e3)}s...`,scheduleNextPoll(t)}}}async function processFiles(){if(!currentUser){showAuthModal("signin");return}if(resultsLocked){showToast('Click "Process Another File" to start a new generation.',"info");return}const e=getUploadCooldownSeconds();if(e>0){showToast(`Upload temporarily limited. Try again in ${formatRetryDelay(e)}.`,"info",4500),updateProcessButton();return}const t=modeConfig[currentMode],n=new FormData;n.append("mode",currentMode),t.needsPdf&&pdfFile&&n.append("pdf",pdfFile),t.needsAudio&&audioFile&&n.append("audio",audioFile),currentMode==="lecture-notes"&&t.needsAudio&&importedAudioToken&&!audioFile&&n.append("audio_import_token",importedAudioToken);const s=outputLanguageSelect.value||"english";if(n.append("output_language",s),s==="other"){const i=outputLanguageCustom.value.trim();if(!i){showToast("Please enter a custom output language.","error");return}n.append("output_language_custom",i)}currentMode!=="interview"?(n.append("flashcard_amount",selectedFlashcardAmount),n.append("question_amount",selectedQuestionAmount),n.append("study_features",selectedStudyFeatures)):n.append("interview_features",getInterviewFeaturesValue());const o=getCurrentModeSteps();buildProgressSteps(o),processButton.disabled=!0,setProgressRetryVisible(!1),progressSection.classList.add("visible"),resultsSection.classList.remove("visible"),progressStatus.classList.remove("error"),progressStatus.querySelector(".spinner").style.display="block",updateProgressUI(0,"Uploading files...",o.length),trackEvent("process_clicked",{study_features:selectedStudyFeatures,flashcard_amount:selectedFlashcardAmount,question_amount:selectedQuestionAmount,interview_features_count:selectedInterviewFeatures.length});try{const i=await authenticatedFetch("/upload",{method:"POST",body:n}),r=await i.json();if(r.error){if(trackEvent("processing_failed",{reason:r.error||"upload_failed"}),typeof r.error=="string"&&r.error.toLowerCase().includes("imported audio token")&&(clearImportedAudioLocalState(),syncAudioInfoUI()),i.status===401)showAuthModal();else if(i.status===402)showError("No credits remaining. Please purchase more credits."),noCreditsWarning.classList.add("visible");else if(i.status===429){const a=getRetryAfterSeconds(i,r),l=a?`${r.error} Try again in ${formatRetryDelay(a)}.`:r.error;a>0&&startUploadCooldown(a),showError(l),showToast(l,"info",6e3)}else showError(r.error);return}currentJobId=r.job_id,trackedTerminalJobId="",trackEvent("processing_started",{job_id:currentJobId,study_features:selectedStudyFeatures,interview_features_count:selectedInterviewFeatures.length}),startPolling()}catch(i){captureClientError(i,"process_files"),showError("Failed to upload files. Please try again.")}}processButton.addEventListener("click",processFiles);function simpleMarkdownToHtml(e){return markdownUtils.parseMarkdownToSafeHtml?markdownUtils.parseMarkdownToSafeHtml(e):escapeHtml(String(e||"")).replace(/\n/g,"<br>")}function buildDownloadDropdown(){const e=[],t=(n,s)=>{e.push({type:n,format:"md",label:s,detail:"Markdown (.md)"}),e.push({type:n,format:"docx",label:s,detail:"Word Document (.docx)"})};for(currentMode==="lecture-notes"?(t("result",DOWNLOAD_LABELS.lectureNotes),e.push({divider:!0}),t("slides",DOWNLOAD_LABELS.slideExtract),e.push({divider:!0}),t("transcript",DOWNLOAD_LABELS.lectureTranscript)):currentMode==="slides-only"?t("result",DOWNLOAD_LABELS.slideExtract):(t("result",DOWNLOAD_LABELS.interviewTranscript),interviewSummaryText&&interviewSectionsText&&interviewCombinedText?(e.push({divider:!0}),t("combined","Summary + Structured Transcript")):(interviewSummaryText&&(e.push({divider:!0}),t("summary","Interview Summary")),interviewSectionsText&&(e.push({divider:!0}),t("sections","Structured Transcript"))),transcript&&(e.push({divider:!0}),t("transcript","Raw Transcript")));downloadDropdownContent.firstChild;)downloadDropdownContent.removeChild(downloadDropdownContent.firstChild);e.forEach(n=>{if(n.divider){const i=document.createElement("div");i.className="dropdown-divider",downloadDropdownContent.appendChild(i);return}const s=document.createElement("button");s.type="button",s.className="dropdown-item",s.setAttribute("role","menuitem"),s.dataset.type=n.type,s.dataset.format=n.format,s.append(document.createTextNode(n.label));const o=document.createElement("span");o.textContent=n.detail,s.appendChild(o),s.addEventListener("click",()=>{downloadFile(n.type,n.format),setDownloadDropdownVisible(!1)}),downloadDropdownContent.appendChild(s)})}async function downloadFile(e,t){let n=resultMarkdown,s="output.md";if(e==="slides"?(n=slideText,s=t==="md"?"slide-extract.md":"slide-extract.docx"):e==="transcript"?(n=transcript,s=t==="md"?"lecture-transcript.md":"lecture-transcript.docx"):e==="summary"?(n=interviewSummaryText||resultMarkdown,s=t==="md"?"interview-summary.md":"interview-summary.docx"):e==="sections"?(n=interviewSectionsText||resultMarkdown,s=t==="md"?"interview-structured.md":"interview-structured.docx"):e==="combined"?(n=interviewCombinedText||resultMarkdown,s=t==="md"?"interview-summary-structured.md":"interview-summary-structured.docx"):currentMode==="lecture-notes"?s=t==="md"?"lecture-notes.md":"lecture-notes.docx":currentMode==="slides-only"?s=t==="md"?"slide-extract.md":"slide-extract.docx":s=t==="md"?"interview-transcript.md":"interview-transcript.docx",t==="md"){const o=new Blob([n],{type:"text/markdown"});if(downloadUtils.saveBlobAsFile)downloadUtils.saveBlobAsFile(o,s);else{const i=URL.createObjectURL(o),r=document.createElement("a");r.href=i,r.download=s,document.body.appendChild(r),r.click(),document.body.removeChild(r),URL.revokeObjectURL(i)}showToast("Download started","success")}else{if(!currentJobId)return;try{await downloadAuthenticatedFile(`/download-docx/${currentJobId}?type=${encodeURIComponent(e)}`,s),showToast("Download started","success")}catch(o){showToast(o.message||"Could not download file.","error")}}}function updateExportCsvButton(){if(currentMode==="interview"){exportStudyCsvBtn.style.display="none";return}if(activeResultsTab==="test"&&testQuestions.length){exportCsvType="test",exportStudyCsvText.textContent="Export Practice Test CSV",exportStudyCsvBtn.style.display="flex";return}if(flashcards.length){exportCsvType="flashcards",exportStudyCsvText.textContent="Export Flashcards CSV",exportStudyCsvBtn.style.display="flex";return}if(testQuestions.length){exportCsvType="test",exportStudyCsvText.textContent="Export Practice Test CSV",exportStudyCsvBtn.style.display="flex";return}exportStudyCsvBtn.style.display="none"}function setActiveResultsTab(e){activeResultsTab=e,tabButtons.forEach(t=>{const n=t.dataset.tab===e;t.classList.toggle("active",n),t.setAttribute("aria-selected",n?"true":"false"),t.tabIndex=n?0:-1}),paneNotes.classList.toggle("active",e==="notes"),paneNotes.hidden=e!=="notes",paneFlashcards.classList.toggle("active",e==="flashcards"),paneFlashcards.hidden=e!=="flashcards",paneTest.classList.toggle("active",e==="test"),paneTest.hidden=e!=="test",updateExportCsvButton()}tabButtons.forEach(e=>e.addEventListener("click",()=>setActiveResultsTab(e.dataset.tab))),tabButtons.forEach((e,t)=>e.addEventListener("keydown",n=>{if(tabButtons.length){if(n.key==="ArrowRight"||n.key==="ArrowDown"){n.preventDefault();const s=tabButtons[(t+1)%tabButtons.length];setActiveResultsTab(s.dataset.tab),s.focus()}else if(n.key==="ArrowLeft"||n.key==="ArrowUp"){n.preventDefault();const s=tabButtons[(t-1+tabButtons.length)%tabButtons.length];setActiveResultsTab(s.dataset.tab),s.focus()}else if(n.key==="Home"){n.preventDefault();const s=tabButtons[0];setActiveResultsTab(s.dataset.tab),s.focus()}else if(n.key==="End"){n.preventDefault();const s=tabButtons[tabButtons.length-1];setActiveResultsTab(s.dataset.tab),s.focus()}}}));function renderFlashcard(){if(!flashcards.length){flashcardEmpty.style.display="block",flashcardCard.style.display="none",flashcardProgress.textContent="Card 0 of 0",flashcardPrevBtn.disabled=!0,flashcardNextBtn.disabled=!0,flashcardFlipBtn.disabled=!0;return}flashcardEmpty.style.display="none",flashcardCard.style.display="block";const e=flashcards[flashcardIndex];flashcardFrontText.textContent=e.front,flashcardBackText.textContent=e.back,flashcardInner.classList.toggle("flipped",flashcardFlipped),flashcardProgress.textContent=`Card ${flashcardIndex+1} of ${flashcards.length}`,flashcardPrevBtn.disabled=flashcardIndex===0,flashcardNextBtn.disabled=flashcardIndex===flashcards.length-1,flashcardFlipBtn.disabled=!1}function goFlashcard(e){flashcards.length&&(flashcardIndex=Math.max(0,Math.min(flashcards.length-1,flashcardIndex+e)),flashcardFlipped=!1,renderFlashcard())}function flipFlashcard(){flashcards.length&&(flashcardFlipped=!flashcardFlipped,renderFlashcard())}flashcardCard.addEventListener("click",flipFlashcard),flashcardPrevBtn.addEventListener("click",()=>goFlashcard(-1)),flashcardNextBtn.addEventListener("click",()=>goFlashcard(1)),flashcardFlipBtn.addEventListener("click",flipFlashcard);function renderQuizQuestion(){if(!testQuestions.length){quizEmpty.style.display="block",quizQuestionText.textContent="",quizOptions.innerHTML="",quizExplanation.classList.remove("visible"),quizNextBtn.style.display="none",quizProgress.textContent="Question 0 of 0",quizScoreEl.textContent="Score: 0/0";return}quizEmpty.style.display="none";const e=testQuestions[quizIndex];quizAnswered=!1,quizProgress.textContent=`Question ${quizIndex+1} of ${testQuestions.length}`,quizScoreEl.textContent=`Score: ${quizScore}/${testQuestions.length}`,quizQuestionText.textContent=e.question,quizOptions.innerHTML="",quizExplanation.classList.remove("visible"),quizExplanation.textContent="",e.options.forEach(t=>{const n=document.createElement("button");n.type="button",n.className="quiz-option",n.textContent=t,n.addEventListener("click",()=>answerQuizOption(n,t)),quizOptions.appendChild(n)}),quizNextBtn.style.display="none"}function answerQuizOption(e,t){if(quizAnswered)return;quizAnswered=!0;const n=testQuestions[quizIndex];[...quizOptions.querySelectorAll(".quiz-option")].forEach(o=>{o.disabled=!0,o.textContent===n.answer&&o.classList.add("correct")}),t===n.answer?(e.classList.add("correct"),quizScore+=1):e.classList.add("wrong"),quizScoreEl.textContent=`Score: ${quizScore}/${testQuestions.length}`,quizExplanation.textContent=n.explanation,quizExplanation.classList.add("visible"),quizNextBtn.style.display=quizIndex<testQuestions.length-1?"inline-flex":"none"}quizNextBtn.addEventListener("click",()=>{quizIndex<testQuestions.length-1&&(quizIndex+=1,renderQuizQuestion())});function showResults(e,t,n,s,o,i,r,a,l,c,m,u,d){const p=modeConfig[currentMode];resultMarkdown=e||"",slideText=t||"",transcript=n||"",flashcards=Array.isArray(s)?s:[],testQuestions=Array.isArray(o)?o:[],interviewSummaryText=l||"",interviewSectionsText=c||"",interviewCombinedText=m||"",studyGenerationError=i,currentStudyPackId=r,currentBillingReceipt=d&&typeof d=="object"?d:null,resultsLocked=!0,updateQuickstartVisibility(),resultsTitleText.textContent=p.resultTitle,setSanitizedHtml(resultsContent,simpleMarkdownToHtml(resultMarkdown),{ALLOWED_TAGS:["h1","h2","h3","p","br","strong","em","code","pre","ul","ol","li","blockquote","a","hr"],ALLOWED_ATTR:["href","title","target","rel"]}),flashcardCountBadge.textContent=String(flashcards.length),testCountBadge.textContent=String(testQuestions.length);const f=new Set(Array.isArray(u)?u:[]);if(currentMode==="interview")if(studyGenerationError)studyWarning.style.display="block",studyWarning.textContent=studyGenerationError;else if(!selectedInterviewFeatures.length)studyWarning.style.display="block",studyWarning.textContent="No interview extras selected. Showing the transcript only.";else if(f.size<selectedInterviewFeatures.length){const g=selectedInterviewFeatures.length-f.size;studyWarning.style.display="block",studyWarning.textContent=`Some interview extras could not be generated (${g} failed). Failed extras were refunded as slides credits.`}else studyWarning.style.display="none",studyWarning.textContent="";else studyGenerationError?(studyWarning.style.display="block",studyWarning.textContent=studyGenerationError):a==="none"?(studyWarning.style.display="block",studyWarning.textContent="Study tools were disabled for this generation (Notes-only mode)."):(studyWarning.style.display="none",studyWarning.textContent="");renderBillingReceipt(currentMode==="interview"?currentBillingReceipt:null),flashcardIndex=0,flashcardFlipped=!1,quizIndex=0,quizScore=0,renderFlashcard(),renderQuizQuestion(),document.getElementById("tab-flashcards").style.display=currentMode==="interview"?"none":"flex",document.getElementById("tab-test").style.display=currentMode==="interview"?"none":"flex",setActiveResultsTab("notes"),document.getElementById("tab-flashcards").disabled=currentMode==="interview"||!flashcards.length,document.getElementById("tab-test").disabled=currentMode==="interview"||!testQuestions.length,progressSection.classList.remove("visible"),setProgressRetryVisible(!1),resultsSection.classList.add("visible"),buildDownloadDropdown(),updateExportCsvButton(),updateProcessButton(),showToast("Processing complete!","success")}function showError(e,t,n){setProgressRetryVisible(!1),renderBillingReceipt(null),progressStatus.classList.add("error"),progressStatus.querySelector(".spinner").style.display="none";const s=buildBillingReceiptText(n);t?(statusText.textContent=`Error: ${e} \u2014 Your credit has been refunded.`,showToast("Processing failed. Your credit has been refunded.","info",5e3),fetchUserData()):statusText.textContent=`Error: ${e}`,s&&showToast(s,"info",5500),updateProcessButton()}function resetResultsState(){resultMarkdown="",slideText="",transcript="",flashcards=[],testQuestions=[],interviewSummaryText="",interviewSectionsText="",interviewCombinedText="",currentBillingReceipt=null,currentStudyPackId=null,resultsLocked=!1,updateQuickstartVisibility(),flashcardCountBadge.textContent="0",testCountBadge.textContent="0",studyWarning.style.display="none",renderBillingReceipt(null),exportStudyCsvBtn.style.display="none",document.getElementById("tab-flashcards").style.display="flex",document.getElementById("tab-test").style.display="flex",document.getElementById("tab-flashcards").disabled=!1,document.getElementById("tab-test").disabled=!1,setActiveResultsTab("notes")}function showPricingModal(){openOverlay(pricingOverlay),applyCheckoutButtonsState()}function hidePricingModal(){closeOverlay(pricingOverlay)}function showHistoryModal(){openOverlay(historyOverlay),loadPurchaseHistory()}function hideHistoryModal(){closeOverlay(historyOverlay)}function formatPrice(e,t){const n=(e/100).toFixed(2);return t==="eur"?`\u20AC${n}`:`${n} ${t.toUpperCase()}`}function formatCreditsText(e){return Object.entries(e).map(([t,n])=>`${n} ${t.replace(/_/g," ").replace("credits ","").replace("credits","").trim()}`).join(", ")}function setHistoryMessage(e,t=!1){for(;historyList.firstChild;)historyList.removeChild(historyList.firstChild);const n=document.createElement("div");if(n.className=t?"history-loading":"history-empty",t){const o=document.createElement("div");o.className="spinner",n.appendChild(o)}const s=document.createElement("span");s.textContent=e,n.appendChild(s),historyList.appendChild(n)}function setHistoryLoadingSkeleton(){for(;historyList.firstChild;)historyList.removeChild(historyList.firstChild);const e=document.createElement("div");e.className="history-skeleton-list";for(let t=0;t<3;t+=1){const n=document.createElement("div");n.className="history-skeleton-item";const s=document.createElement("div");s.className="history-skeleton-left";const o=document.createElement("div");o.className="history-skeleton-line title";const i=document.createElement("div");i.className="history-skeleton-line meta";const r=document.createElement("div");r.className="history-skeleton-line submeta",s.appendChild(o),s.appendChild(i),s.appendChild(r);const a=document.createElement("div");a.className="history-skeleton-price",n.appendChild(s),n.appendChild(a),e.appendChild(n)}historyList.appendChild(e)}function setHistoryEmptyState(){for(;historyList.firstChild;)historyList.removeChild(historyList.firstChild);const e=document.createElement("div");e.className="history-empty";const t=document.createElement("span");t.textContent="No purchases yet";const n=document.createElement("div");n.className="history-empty-note",n.textContent="You can keep using free credits or buy a bundle when you need more.";const s=document.createElement("button");s.type="button",s.className="history-empty-action",s.textContent="Buy credits",s.addEventListener("click",()=>{hideHistoryModal(),showPricingModal()}),e.appendChild(t),e.appendChild(n),e.appendChild(s),historyList.appendChild(e)}async function loadPurchaseHistory(){if(setHistoryLoadingSkeleton(),!!currentUser)try{const t=await(await authenticatedFetch("/api/purchase-history")).json();if(!t.purchases||!t.purchases.length){setHistoryEmptyState();return}for(;historyList.firstChild;)historyList.removeChild(historyList.firstChild);t.purchases.forEach(n=>{const s=new Date(n.created_at*1e3),o=document.createElement("div");o.className="history-item";const i=document.createElement("div");i.className="history-item-left";const r=document.createElement("div");r.className="history-item-name",r.textContent=n.bundle_name||"-";const a=document.createElement("div");a.className="history-item-date",a.textContent=`${s.toLocaleDateString("en-GB")} at ${s.toLocaleTimeString("en-GB",{hour:"2-digit",minute:"2-digit"})}`;const l=document.createElement("div");l.className="history-item-credits",l.textContent=formatCreditsText(n.credits||{}),i.appendChild(r),i.appendChild(a),i.appendChild(l);const c=document.createElement("div");c.className="history-item-price",c.textContent=formatPrice(n.price_cents||0,n.currency||"eur"),o.appendChild(i),o.appendChild(c),historyList.appendChild(o)})}catch(e){setHistoryMessage("Could not load purchase history. Please try again.")}}async function purchaseBundle(e){if(!currentUser){hidePricingModal(),showAuthModal();return}const t=getCheckoutCooldownSeconds();if(t>0){applyCheckoutButtonsState(),showToast(`Checkout temporarily limited. Try again in ${formatRetryDelay(t)}.`,"info",4500);return}if(checkoutRequestInFlight)return;checkoutRequestInFlight=!0,document.querySelectorAll(".bundle-buy-btn").forEach(s=>{s.disabled=!0,s.dataset.bundleId===e&&(s.textContent="Redirecting...")});try{trackEvent("checkout_started",{bundle_id:e},{preferBeacon:!0});const s=await authenticatedFetch("/api/create-checkout-session",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({bundle_id:e})}),o=await s.json();if(o.error){if(s.status===429){const i=getRetryAfterSeconds(s,o),r=i?`${o.error} Try again in ${formatRetryDelay(i)}.`:o.error;showToast(r,"info",6e3),checkoutRequestInFlight=!1,i>0?startCheckoutCooldown(i):applyCheckoutButtonsState()}else showToast(o.error,"error"),checkoutRequestInFlight=!1,applyCheckoutButtonsState();return}if(o.checkout_url){window.location.href=o.checkout_url;return}showToast("Could not start checkout. Please try again.","error"),checkoutRequestInFlight=!1,applyCheckoutButtonsState()}catch(s){captureClientError(s,"purchase_bundle"),showToast("Something went wrong. Please try again.","error"),checkoutRequestInFlight=!1,applyCheckoutButtonsState()}}async function confirmCheckoutSession(e){if(!e)return{ok:!1,status:"missing_session"};if(!currentUser)return{ok:!1,status:"not_signed_in"};try{const t=await authenticatedFetch(`/api/confirm-checkout-session?session_id=${encodeURIComponent(e)}`),n=await t.json();return t.ok?{ok:!0,status:n.status||"granted"}:{ok:!1,status:n.error||"confirm_failed"}}catch(t){return captureClientError(t,"confirm_checkout_session"),{ok:!1,status:"confirm_failed"}}}async function checkPaymentResult(){const e=new URLSearchParams(window.location.search),t=e.get("payment"),n=e.get("session_id");if(t==="success"){let s=!1;n&&(s=(await confirmCheckoutSession(n)).ok),s?(showToast("Payment successful! Your credits have been added.","success",5e3),trackEvent("payment_confirmed",{session_id:n||""},{preferBeacon:!0})):showToast("Payment received. Credits may take a few seconds to appear.","info",5e3),window.history.replaceState({},"",window.location.pathname),setTimeout(()=>{currentUser&&fetchUserData()},1e3),setTimeout(()=>{currentUser&&fetchUserData()},4e3)}else t==="cancelled"&&(showToast("Payment cancelled. No charges were made.","info",4e3),trackEvent("payment_cancelled",{},{preferBeacon:!0}),window.history.replaceState({},"",window.location.pathname))}headerSignInBtn.addEventListener("click",()=>showAuthModal("signin")),signInToProcessBtn.addEventListener("click",()=>showAuthModal("signin")),authModalClose.addEventListener("click",hideAuthModal),authOverlay.addEventListener("click",e=>{e.target===authOverlay&&hideAuthModal()}),switchToSignup.addEventListener("click",e=>{e.preventDefault(),showAuthView("signup")}),switchToSignin.addEventListener("click",e=>{e.preventDefault(),showAuthView("signin")}),forgotPasswordLink.addEventListener("click",e=>{e.preventDefault(),showAuthView("reset")}),backToSignin.addEventListener("click",e=>{e.preventDefault(),showAuthView("signin")}),signinForm.addEventListener("submit",async e=>{e.preventDefault(),await signInWithEmail(signinEmail.value.trim(),signinPassword.value)}),signupForm.addEventListener("submit",async e=>{if(e.preventDefault(),signupPassword.value!==signupPasswordConfirm.value){showAuthError(signupError,"Passwords do not match.");return}await signUpWithEmail(signupEmail.value.trim(),signupPassword.value)}),resetForm.addEventListener("submit",async e=>{e.preventDefault(),await sendPasswordReset(resetEmail.value.trim())}),googleSignInBtn.addEventListener("click",signInWithGoogle),googleSignUpBtn.addEventListener("click",signInWithGoogle),document.querySelectorAll(".password-toggle").forEach(e=>{e.addEventListener("click",()=>{const t=document.getElementById(e.dataset.target),n=e.querySelector(".eye-open"),s=e.querySelector(".eye-closed");t.type==="password"?(t.type="text",n.style.display="none",s.style.display="block"):(t.type="password",n.style.display="block",s.style.display="none")})}),signOutBtn.addEventListener("click",signOut),userButton.addEventListener("click",e=>{e.stopPropagation();const t=!userDropdown.classList.contains("visible");closeHeaderDropdowns(t?"user":""),setUserDropdownVisible(t)}),userButton.addEventListener("keydown",e=>{if(e.key==="ArrowDown"&&(e.preventDefault(),closeHeaderDropdowns("user"),setUserDropdownVisible(!0),focusMenuItem(userDropdown,".user-dropdown-item","first")),e.key==="ArrowUp"&&(e.preventDefault(),closeHeaderDropdowns("user"),setUserDropdownVisible(!0),focusMenuItem(userDropdown,".user-dropdown-item","last")),e.key==="Enter"||e.key===" "){e.preventDefault();const t=!userDropdown.classList.contains("visible");closeHeaderDropdowns(t?"user":""),setUserDropdownVisible(t)}e.key==="Escape"&&(e.preventDefault(),setUserDropdownVisible(!1))}),userDropdown.addEventListener("keydown",e=>{e.key==="ArrowDown"&&(e.preventDefault(),focusMenuItem(userDropdown,".user-dropdown-item","next")),e.key==="ArrowUp"&&(e.preventDefault(),focusMenuItem(userDropdown,".user-dropdown-item","prev")),e.key==="Home"&&(e.preventDefault(),focusMenuItem(userDropdown,".user-dropdown-item","first")),e.key==="End"&&(e.preventDefault(),focusMenuItem(userDropdown,".user-dropdown-item","last")),e.key==="Escape"&&(e.preventDefault(),setUserDropdownVisible(!1),userButton.focus()),e.key==="Tab"&&setUserDropdownVisible(!1)}),document.addEventListener("click",e=>{userMenu.contains(e.target)||setUserDropdownVisible(!1)}),buyCreditsBtn.addEventListener("click",()=>{setUserDropdownVisible(!1),showPricingModal()}),featuresPageBtn.addEventListener("click",()=>{setUserDropdownVisible(!1),window.location.href="/features"}),plannerPageBtn.addEventListener("click",()=>{setUserDropdownVisible(!1),window.location.href="/plan"}),purchaseHistoryBtn.addEventListener("click",()=>{setUserDropdownVisible(!1),showHistoryModal()}),exportDataBtn.addEventListener("click",async()=>{setUserDropdownVisible(!1),await exportMyAccountData()}),deleteAccountBtn.addEventListener("click",async()=>{setUserDropdownVisible(!1),await deleteMyAccountData()}),headerStudyLibraryBtn.addEventListener("click",()=>{trackEvent("study_mode_opened",{source:"header_study_library"},{preferBeacon:!0}),window.location.href="/study"});function openGoalModal(){currentUser&&(goalModalError.classList.remove("visible"),goalModalError.textContent="",goalModalInput.value=String(getDailyGoalStorage(currentUser.uid)),openOverlay(goalModalOverlay),setTimeout(()=>goalModalInput.focus(),30),setTimeout(()=>goalModalInput.select(),30))}function closeGoalModal(){closeOverlay(goalModalOverlay)}async function saveGoalFromModal(){if(!currentUser)return;const e=parseInt(String(goalModalInput.value||"").trim(),10);if(!Number.isFinite(e)||e<1||e>500){goalModalError.textContent="Use a number between 1 and 500.",goalModalError.classList.add("visible");return}localStorage.setItem(`daily_goal_${currentUser.uid}`,String(e)),progressSummaryCache=Object.assign({},progressSummaryCache||{},{daily_goal:e}),refreshStudyHeaderMetrics();try{await authenticatedFetch("/api/study-progress",{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({daily_goal:e,timezone:Intl.DateTimeFormat().resolvedOptions().timeZone||""})}),await fetchStudyProgressSummary()}catch(t){console.warn("Could not sync daily goal:",t)}closeGoalModal(),showToast("Daily goal updated.","success",1800)}progressButton.addEventListener("click",e=>{e.stopPropagation();const t=!progressDropdown.classList.contains("visible");closeHeaderDropdowns(t?"progress":""),setProgressDropdownVisible(t),t&&refreshStudyHeaderMetrics()}),progressButton.addEventListener("keydown",e=>{if(e.key==="ArrowDown"&&(e.preventDefault(),closeHeaderDropdowns("progress"),setProgressDropdownVisible(!0),refreshStudyHeaderMetrics(),focusMenuItem(progressDropdown,".progress-action-btn","first")),e.key==="ArrowUp"&&(e.preventDefault(),closeHeaderDropdowns("progress"),setProgressDropdownVisible(!0),refreshStudyHeaderMetrics(),focusMenuItem(progressDropdown,".progress-action-btn","last")),e.key==="Enter"||e.key===" "){e.preventDefault();const t=!progressDropdown.classList.contains("visible");closeHeaderDropdowns(t?"progress":""),setProgressDropdownVisible(t),t&&refreshStudyHeaderMetrics()}e.key==="Escape"&&(e.preventDefault(),setProgressDropdownVisible(!1))}),progressDropdown.addEventListener("keydown",e=>{e.key==="ArrowDown"&&(e.preventDefault(),focusMenuItem(progressDropdown,".progress-action-btn","next")),e.key==="ArrowUp"&&(e.preventDefault(),focusMenuItem(progressDropdown,".progress-action-btn","prev")),e.key==="Home"&&(e.preventDefault(),focusMenuItem(progressDropdown,".progress-action-btn","first")),e.key==="End"&&(e.preventDefault(),focusMenuItem(progressDropdown,".progress-action-btn","last")),e.key==="Escape"&&(e.preventDefault(),setProgressDropdownVisible(!1),progressButton.focus()),e.key==="Tab"&&setProgressDropdownVisible(!1)}),progressSetGoalBtn.addEventListener("click",e=>{e.stopPropagation(),setProgressDropdownVisible(!1),openGoalModal()}),progressOpenPlanBtn.addEventListener("click",()=>{setProgressDropdownVisible(!1),window.location.href="/plan"});let mobileCreditsTooltipTimer=null;creditsDisplay.addEventListener("click",e=>{if(!window.matchMedia("(hover: none), (pointer: coarse)").matches){showPricingModal();return}if(!creditsDisplay.classList.contains("tooltip-open")){e.preventDefault(),creditsDisplay.classList.add("tooltip-open"),mobileCreditsTooltipTimer&&clearTimeout(mobileCreditsTooltipTimer),mobileCreditsTooltipTimer=setTimeout(()=>{creditsDisplay.classList.remove("tooltip-open")},2600);return}creditsDisplay.classList.remove("tooltip-open"),mobileCreditsTooltipTimer&&clearTimeout(mobileCreditsTooltipTimer),showPricingModal()}),document.addEventListener("click",e=>{creditsDisplay.contains(e.target)||(creditsDisplay.classList.remove("tooltip-open"),mobileCreditsTooltipTimer&&clearTimeout(mobileCreditsTooltipTimer)),progressMenu.contains(e.target)||setProgressDropdownVisible(!1)}),goalModalCancelBtn.addEventListener("click",closeGoalModal),goalModalSaveBtn.addEventListener("click",saveGoalFromModal),goalModalInput.addEventListener("keydown",e=>{e.key==="Enter"&&(e.preventDefault(),saveGoalFromModal()),e.key==="Escape"&&(e.preventDefault(),closeGoalModal())}),goalModalOverlay.addEventListener("click",e=>{e.target===goalModalOverlay&&closeGoalModal()}),window.addEventListener("focus",()=>{currentUser?fetchStudyProgressSummary():refreshStudyHeaderMetrics()}),document.addEventListener("visibilitychange",()=>{document.hidden||(currentUser?fetchStudyProgressSummary():refreshStudyHeaderMetrics())}),adminDashboardBtn.addEventListener("click",async()=>{if(setUserDropdownVisible(!1),!currentUser||!currentUserIsAdmin){showToast("Admin access is only available for configured admin accounts.","error",4200);return}try{if(!(await authenticatedFetch("/api/session/login",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({})})).ok)throw new Error("Could not start admin session.");window.location.href="/admin"}catch(e){captureClientError(e,"admin_session_login"),showToast("Could not open admin dashboard right now. Please retry.","error",4500)}}),buyCreditsLink.addEventListener("click",e=>{e.preventDefault(),showPricingModal()}),pricingModalClose.addEventListener("click",hidePricingModal),pricingOverlay.addEventListener("click",e=>{e.target===pricingOverlay&&hidePricingModal()}),historyModalClose.addEventListener("click",hideHistoryModal),historyOverlay.addEventListener("click",e=>{e.target===historyOverlay&&hideHistoryModal()}),document.addEventListener("keydown",e=>{if(!activeModalOverlay)return;if(e.key==="Escape"){e.preventDefault(),activeModalOverlay===authOverlay?hideAuthModal():activeModalOverlay===pricingOverlay?hidePricingModal():activeModalOverlay===historyOverlay?hideHistoryModal():activeModalOverlay===goalModalOverlay&&closeGoalModal();return}if(e.key!=="Tab")return;const t=getFocusableElements(activeModalOverlay);if(!t.length)return;const n=t[0],s=t[t.length-1],o=document.activeElement;e.shiftKey&&o===n?(e.preventDefault(),s.focus()):!e.shiftKey&&o===s&&(e.preventDefault(),n.focus())}),document.querySelectorAll(".bundle-buy-btn").forEach(e=>e.addEventListener("click",()=>purchaseBundle(e.dataset.bundleId))),downloadButton.addEventListener("click",e=>{e.stopPropagation();const t=!downloadDropdownContent.classList.contains("visible");closeHeaderDropdowns(t?"download":""),setDownloadDropdownVisible(t),t&&focusMenuItem(downloadDropdownContent,".dropdown-item","first")}),downloadButton.addEventListener("keydown",e=>{if(e.key==="ArrowDown"&&(e.preventDefault(),closeHeaderDropdowns("download"),setDownloadDropdownVisible(!0),focusMenuItem(downloadDropdownContent,".dropdown-item","first")),e.key==="ArrowUp"&&(e.preventDefault(),closeHeaderDropdowns("download"),setDownloadDropdownVisible(!0),focusMenuItem(downloadDropdownContent,".dropdown-item","last")),e.key==="Enter"||e.key===" "){e.preventDefault();const t=!downloadDropdownContent.classList.contains("visible");closeHeaderDropdowns(t?"download":""),setDownloadDropdownVisible(t),t&&focusMenuItem(downloadDropdownContent,".dropdown-item","first")}e.key==="Escape"&&(e.preventDefault(),setDownloadDropdownVisible(!1))}),downloadDropdownContent.addEventListener("keydown",e=>{e.key==="ArrowDown"&&(e.preventDefault(),focusMenuItem(downloadDropdownContent,".dropdown-item","next")),e.key==="ArrowUp"&&(e.preventDefault(),focusMenuItem(downloadDropdownContent,".dropdown-item","prev")),e.key==="Home"&&(e.preventDefault(),focusMenuItem(downloadDropdownContent,".dropdown-item","first")),e.key==="End"&&(e.preventDefault(),focusMenuItem(downloadDropdownContent,".dropdown-item","last")),e.key==="Escape"&&(e.preventDefault(),setDownloadDropdownVisible(!1),downloadButton.focus()),e.key==="Tab"&&setDownloadDropdownVisible(!1)}),moreActionsButton.addEventListener("click",e=>{e.stopPropagation();const t=!moreActionsContent.classList.contains("visible");closeHeaderDropdowns(t?"more-actions":""),setMoreActionsDropdownVisible(t),t&&focusMenuItem(moreActionsContent,".dropdown-item","first")}),moreActionsButton.addEventListener("keydown",e=>{if(e.key==="ArrowDown"&&(e.preventDefault(),closeHeaderDropdowns("more-actions"),setMoreActionsDropdownVisible(!0),focusMenuItem(moreActionsContent,".dropdown-item","first")),e.key==="ArrowUp"&&(e.preventDefault(),closeHeaderDropdowns("more-actions"),setMoreActionsDropdownVisible(!0),focusMenuItem(moreActionsContent,".dropdown-item","last")),e.key==="Enter"||e.key===" "){e.preventDefault();const t=!moreActionsContent.classList.contains("visible");closeHeaderDropdowns(t?"more-actions":""),setMoreActionsDropdownVisible(t),t&&focusMenuItem(moreActionsContent,".dropdown-item","first")}e.key==="Escape"&&(e.preventDefault(),setMoreActionsDropdownVisible(!1))}),moreActionsContent.addEventListener("keydown",e=>{e.key==="ArrowDown"&&(e.preventDefault(),focusMenuItem(moreActionsContent,".dropdown-item","next")),e.key==="ArrowUp"&&(e.preventDefault(),focusMenuItem(moreActionsContent,".dropdown-item","prev")),e.key==="Home"&&(e.preventDefault(),focusMenuItem(moreActionsContent,".dropdown-item","first")),e.key==="End"&&(e.preventDefault(),focusMenuItem(moreActionsContent,".dropdown-item","last")),e.key==="Escape"&&(e.preventDefault(),setMoreActionsDropdownVisible(!1),moreActionsButton.focus()),e.key==="Tab"&&setMoreActionsDropdownVisible(!1)}),document.addEventListener("click",e=>{downloadDropdown.contains(e.target)||setDownloadDropdownVisible(!1),moreActionsDropdown.contains(e.target)||setMoreActionsDropdownVisible(!1)}),copyButton.addEventListener("click",async()=>{setMoreActionsDropdownVisible(!1);try{await navigator.clipboard.writeText(resultMarkdown),copyButtonText.textContent="Copied!",showToast("Notes copied to clipboard","success"),setTimeout(()=>{copyButtonText.textContent="Copy notes"},1800)}catch(e){showToast("Failed to copy notes","error")}}),exportStudyCsvBtn.addEventListener("click",async()=>{if(setMoreActionsDropdownVisible(!1),!currentJobId)return;const e=exportCsvType==="test"?`practice-test-${currentJobId}.csv`:`flashcards-${currentJobId}.csv`;try{await downloadAuthenticatedFile(`/download-flashcards-csv/${currentJobId}?type=${encodeURIComponent(exportCsvType)}`,e),showToast("CSV download started.","success")}catch(t){showToast(t.message||"Could not export CSV.","error")}}),studyLibraryBtn.addEventListener("click",()=>{setMoreActionsDropdownVisible(!1),trackEvent("study_mode_opened",{source:"results_library"},{preferBeacon:!0}),window.location.href="/study"}),studyNowBtn.addEventListener("click",()=>{if(closeHeaderDropdowns(""),!currentStudyPackId){showToast("No saved study pack available yet for this result.","info");return}trackEvent("study_mode_opened",{source:"results_study_now",pack_id:currentStudyPackId},{preferBeacon:!0}),window.open(`/study?pack_id=${encodeURIComponent(currentStudyPackId)}&mode=learn`,"_blank")}),newLectureButton.addEventListener("click",()=>{setMoreActionsDropdownVisible(!1),pdfFile=null,audioFile=null,releaseImportedAudioToken({clearStatus:!0}),currentJobId=null,trackedTerminalJobId="",pdfInput.value="",audioInput.value="",pdfInfo.style.display="none",pdfZone.classList.remove("has-file"),syncAudioInfoUI(),progressSection.classList.remove("visible"),setProgressRetryVisible(!1),resultsSection.classList.remove("visible"),progressStatus.classList.remove("error"),progressStatus.querySelector(".spinner").style.display="block",resetResultsState(),switchMode(currentMode),updateProcessButton(),window.scrollTo({top:0,behavior:"smooth"})}),quickstartApplyBtn&&quickstartApplyBtn.addEventListener("click",()=>{applyRecommendedSetup(),updateQuickstartVisibility()}),quickstartDismissBtn&&quickstartDismissBtn.addEventListener("click",()=>{if(currentUser&&currentUser.uid)try{localStorage.setItem(`quickstart_dismissed_${currentUser.uid}`,"1")}catch(e){}setQuickstartVisible(!1)}),progressRetryBtn.addEventListener("click",retryStatusCheckNow),studyToolsToggle.addEventListener("click",e=>{e.stopPropagation(),studyToolsPanel.classList.toggle("visible"),studyToolsToggle.classList.toggle("open",studyToolsPanel.classList.contains("visible"))}),studyToolChips.forEach(e=>{e.addEventListener("click",()=>{setStudyFeature(e.dataset.studyFeatures||"none")})}),flashcardAmountChips.forEach(e=>{e.addEventListener("click",()=>{e.disabled||setAmountSelection("flashcards",e.dataset.value)})}),questionAmountChips.forEach(e=>{e.addEventListener("click",()=>{e.disabled||setAmountSelection("questions",e.dataset.value)})}),interviewOptionButtons.forEach(e=>{e.addEventListener("click",()=>{if(e.disabled)return;const t=e.dataset.feature;if(t){if(selectedInterviewFeatures.includes(t))selectedInterviewFeatures=selectedInterviewFeatures.filter(n=>n!==t);else{const n=userCredits?Math.max(0,Number(userCredits.slides||0)):2;if(selectedInterviewFeatures.length>=n){showToast("Not enough slides credits for more interview extras.","info",2600),updateInterviewOptionsUI();return}selectedInterviewFeatures.push(t)}selectedInterviewFeatures=selectedInterviewFeatures.slice(0,2),updateInterviewOptionsUI()}})}),outputLanguageButton.addEventListener("click",e=>{e.stopPropagation();const t=!outputLanguageMenu.classList.contains("visible");closeHeaderDropdowns(t?"language":""),setOutputLanguageMenuVisible(t),t&&focusMenuItem(outputLanguageMenu,".app-select-item","active")}),outputLanguageButton.addEventListener("keydown",e=>{if(e.key==="ArrowDown"&&(e.preventDefault(),closeHeaderDropdowns("language"),setOutputLanguageMenuVisible(!0),focusMenuItem(outputLanguageMenu,".app-select-item","active")),e.key==="ArrowUp"&&(e.preventDefault(),closeHeaderDropdowns("language"),setOutputLanguageMenuVisible(!0),focusMenuItem(outputLanguageMenu,".app-select-item","last")),e.key==="Enter"||e.key===" "){e.preventDefault();const t=!outputLanguageMenu.classList.contains("visible");closeHeaderDropdowns(t?"language":""),setOutputLanguageMenuVisible(t),t&&focusMenuItem(outputLanguageMenu,".app-select-item","active")}e.key==="Escape"&&(e.preventDefault(),setOutputLanguageMenuVisible(!1))}),outputLanguageMenu.addEventListener("keydown",e=>{e.key==="ArrowDown"&&(e.preventDefault(),focusMenuItem(outputLanguageMenu,".app-select-item","next")),e.key==="ArrowUp"&&(e.preventDefault(),focusMenuItem(outputLanguageMenu,".app-select-item","prev")),e.key==="Home"&&(e.preventDefault(),focusMenuItem(outputLanguageMenu,".app-select-item","first")),e.key==="End"&&(e.preventDefault(),focusMenuItem(outputLanguageMenu,".app-select-item","last")),e.key==="Escape"&&(e.preventDefault(),setOutputLanguageMenuVisible(!1),outputLanguageButton.focus()),e.key==="Tab"&&setOutputLanguageMenuVisible(!1)}),outputLanguageItems.forEach(e=>{e.addEventListener("click",()=>{const t=e.dataset.value||"english";setOutputLanguage(t,e.textContent.trim()),setOutputLanguageMenuVisible(!1),t==="other"?(outputLanguageCustom.focus(),outputLanguageCustom.select()):(scheduleLanguagePreferenceSave(),outputLanguageButton.focus())})}),outputLanguageCustom.addEventListener("input",()=>{outputLanguageSelect.value==="other"&&(outputLanguageLabel.textContent=getLanguageLabel("other",outputLanguageCustom.value),scheduleLanguagePreferenceSave())}),outputLanguageCustom.addEventListener("blur",()=>{outputLanguageSelect.value==="other"&&(outputLanguageLabel.textContent=getLanguageLabel("other",outputLanguageCustom.value),scheduleLanguagePreferenceSave())}),audioUrlFetchBtn&&audioUrlFetchBtn.addEventListener("click",importAudioFromUrl),audioUrlInput&&audioUrlInput.addEventListener("keydown",e=>{e.key==="Enter"&&(e.preventDefault(),importAudioFromUrl())}),languageOnboardingButtons.forEach(e=>{e.addEventListener("click",()=>{setOnboardingLanguageSelection(e.dataset.value||"english"),setOnboardingError(""),(e.dataset.value||"")==="other"&&languageOnboardingCustom.focus()})}),languageOnboardingCustom.addEventListener("input",()=>setOnboardingError("")),languageOnboardingCustom.addEventListener("keydown",e=>{e.key==="Enter"&&(e.preventDefault(),saveLanguageOnboardingPreference())}),languageOnboardingSaveBtn.addEventListener("click",saveLanguageOnboardingPreference),languageOnboardingOverlay.addEventListener("click",e=>{e.target===languageOnboardingOverlay&&languageOnboardingCustom.focus()}),document.addEventListener("click",e=>{!studyToolsPanel.contains(e.target)&&!studyToolsToggle.contains(e.target)&&(studyToolsPanel.classList.remove("visible"),studyToolsToggle.classList.remove("open")),outputLanguagePicker.contains(e.target)||setOutputLanguageMenuVisible(!1)}),window.addEventListener("keydown",e=>{resultsSection.classList.contains("visible")&&activeResultsTab==="flashcards"&&(e.key==="ArrowLeft"&&(e.preventDefault(),goFlashcard(-1)),e.key==="ArrowRight"&&(e.preventDefault(),goFlashcard(1)),e.code==="Space"&&(e.preventDefault(),flipFlashcard()))}),window.addEventListener("beforeunload",e=>{currentJobId&&pollInterval&&(e.preventDefault(),e.returnValue="")});function updateHeaderNavActiveState(){const e=window.location.pathname.replace(/\/+$/,"")||"/";document.querySelectorAll(".header-nav-link").forEach(t=>{const n=(t.getAttribute("href")||"").replace(/\/+$/,"")||"/",s=e==="/dashboard"&&n==="/";t.classList.toggle("active",n===e||s)})}setAmountSelection("flashcards",selectedFlashcardAmount),setAmountSelection("questions",selectedQuestionAmount),setStudyFeature("both"),updateInterviewOptionsUI(),setOutputLanguage("english","\u{1F1EC}\u{1F1E7} English"),switchMode("lecture-notes"),resetResultsState(),updateHeaderNavActiveState();
