const firebaseConfig={apiKey:"AIzaSyBAAeEUCPNvP5qnqpP3M6HnFZ6vaaijUvM",authDomain:"lecture-processor-cdff6.firebaseapp.com",projectId:"lecture-processor-cdff6",storageBucket:"lecture-processor-cdff6.firebasestorage.app",messagingSenderId:"374793454161",appId:"1:374793454161:web:c68b21590e9a1fafa32e70"};firebase.initializeApp(firebaseConfig);const auth=firebase.auth(),authUtils=window.LectureProcessorAuth||{},authClient=authUtils.createAuthClient?authUtils.createAuthClient(auth,{notSignedInMessage:"Not signed in"}):null,downloadUtils=window.LectureProcessorDownload||{},signedInMeta=document.getElementById("signed-in-meta"),stateArea=document.getElementById("state-area"),dashboard=document.getElementById("dashboard"),authBtn=document.getElementById("auth-btn"),refreshBtn=document.getElementById("refresh-btn"),backBtn=document.getElementById("back-btn"),exportJobsBtn=document.getElementById("export-jobs-btn"),exportPurchasesBtn=document.getElementById("export-purchases-btn"),exportFunnelBtn=document.getElementById("export-funnel-btn"),exportFunnelDailyBtn=document.getElementById("export-funnel-daily-btn");let currentWindow="7d",currentModeView="total",latestModeBreakdown={};function authFetch(e,t){return authClient&&typeof authClient.authFetch=="function"?authClient.authFetch(e,t,{retryOn401:!0}):auth.currentUser?auth.currentUser.getIdToken().then(d=>{const n=t||{},c=Object.assign({},n.headers||{},{Authorization:`Bearer ${d}`});return fetch(e,Object.assign({},n,{headers:c}))}):Promise.reject(new Error("Not signed in"))}function formatMoney(e){return`\u20AC${((e||0)/100).toFixed(2)}`}function formatDate(e){return e?new Date(e*1e3).toLocaleString("en-GB",{day:"2-digit",month:"short",year:"numeric",hour:"2-digit",minute:"2-digit"}):"-"}function formatRateLimitLabel(e){const t=String(e||"").trim().toLowerCase();return t==="upload"?"Upload":t==="checkout"?"Checkout":t==="analytics"?"Analytics":"Other"}function setState(e,t="loading"){stateArea.textContent=e,stateArea.className=t,stateArea.style.display="block",dashboard.style.display="none"}function clearChildren(e){for(;e.firstChild;)e.removeChild(e.firstChild)}function renderRows(e,t,d,n=8){const c=document.getElementById(e);if(clearChildren(c),!t.length){const a=document.createElement("tr"),r=document.createElement("td");r.colSpan=n,r.className="empty",r.textContent=d,a.appendChild(r),c.appendChild(a);return}t.forEach(a=>c.appendChild(a))}function renderBars(e,t,d,n){const c=document.getElementById(e);if(clearChildren(c),!t.length){const r=document.createElement("div");r.className="empty",r.textContent="No data for selected window.",c.appendChild(r);return}const a=Math.max(...d,1);t.forEach((r,l)=>{const m=d[l]||0,h=m/a*100,u=document.createElement("div");u.className="bar-col",u.title=`${r}: ${n==="success"?m+"%":formatMoney(m)}`;const o=document.createElement("div");o.className=`bar ${n}`,o.style.height=`${Math.max(h,1)}%`;const s=document.createElement("div");s.className="bar-label",s.textContent=r,u.appendChild(o),(t.length<=12||l%Math.ceil(t.length/10)===0||l===t.length-1)&&u.appendChild(s),c.appendChild(u)})}function renderModeBreakdown(){const e=document.getElementById("mode-breakdown-bars");clearChildren(e);const t=Object.values(latestModeBreakdown||{}).filter(n=>n&&n.label);if(!t.length){const n=document.createElement("div");n.className="empty",n.textContent="No mode data for selected window.",e.appendChild(n);return}const d=Math.max(...t.map(n=>n[currentModeView]||0),1);t.forEach(n=>{const c=n[currentModeView]||0,a=Math.max(c/d*100,c>0?2:0),r=document.createElement("div");r.className="mode-row";const l=document.createElement("div");l.className="mode-label",l.textContent=String(n.label||"-");const m=document.createElement("div");m.className="mode-track";const h=document.createElement("div");h.className="mode-fill",h.style.width=`${a}%`,m.appendChild(h);const u=document.createElement("div");u.className="mode-value",u.textContent=String(c),r.appendChild(l),r.appendChild(m),r.appendChild(u),e.appendChild(r)})}function renderFunnel(e){const t=document.getElementById("funnel-list"),d=document.getElementById("funnel-meta"),n=e&&Array.isArray(e.steps)?e.steps:[];if(clearChildren(t),!n.length){d.textContent="No funnel events captured in the selected window.";const a=document.createElement("div");a.className="empty",a.textContent="No conversion data yet.",t.appendChild(a);return}d.textContent="Counts are unique users/sessions that reached each stage.";const c=Math.max(...n.map(a=>Number(a.count||0)),1);n.forEach((a,r)=>{const l=Number(a.count||0),m=Math.max(l/c*100,l>0?2:0),h=Number(a.conversion_from_prev||0),u=r===0?"Start":`${h}% from previous`,o=document.createElement("div");o.className="funnel-row";const s=document.createElement("div");s.className="funnel-label",s.textContent=String(a.label||a.event||"-");const f=document.createElement("div");f.className="funnel-track";const i=document.createElement("div");i.className="funnel-fill",i.style.width=`${m}%`,f.appendChild(i);const p=document.createElement("div");p.className="funnel-count",p.textContent=String(l);const C=document.createElement("div");C.className="funnel-conversion",C.textContent=u,o.appendChild(s),o.appendChild(f),o.appendChild(p),o.appendChild(C),t.appendChild(o)})}function renderDashboard(e){const t=e.metrics||{},d=e.trends||{},n=t.job_count>0?Math.round(t.success_jobs/t.job_count*100):0;document.getElementById("m-users").textContent=t.total_users||0,document.getElementById("m-users-sub").textContent=`${t.new_users||0} new in window`,document.getElementById("m-jobs").textContent=t.job_count||0,document.getElementById("m-success-rate").textContent=`${n}%`,document.getElementById("m-revenue").textContent=formatMoney(t.total_revenue_cents||0),document.getElementById("m-purchases").textContent=t.purchase_count||0,document.getElementById("m-processed").textContent=t.total_processed||0,document.getElementById("m-refunds").textContent=t.refunded_jobs||0,document.getElementById("m-duration").textContent=`${t.avg_duration_seconds||0}s`,document.getElementById("m-success-jobs").textContent=t.success_jobs||0,document.getElementById("m-failed-jobs").textContent=t.failed_jobs||0,document.getElementById("m-rate-limit-total").textContent=t.rate_limit_429_total||0,document.getElementById("m-rate-limit-sub").textContent=`U: ${t.rate_limit_upload_429||0} \xB7 C: ${t.rate_limit_checkout_429||0} \xB7 A: ${t.rate_limit_analytics_429||0}`;const c=d.labels||[],a=d.success_rate||[],r=d.revenue_cents||[];latestModeBreakdown=e.mode_breakdown||{},renderBars("success-chart",c,a,"success"),renderBars("revenue-chart",c,r,"revenue"),renderModeBreakdown(),renderFunnel(e.funnel||{}),document.getElementById("success-granularity").textContent=`Granularity: ${d.granularity||"day"}`,document.getElementById("revenue-granularity").textContent=`Granularity: ${d.granularity||"day"}`,document.getElementById("success-latest").textContent=`Latest: ${a.length?a[a.length-1]:0}%`;const l=r.reduce((o,s)=>o+(s||0),0);document.getElementById("revenue-total").textContent=`Window total: ${formatMoney(l)}`;const m=(e.recent_jobs||[]).map(o=>{const s=o.status||"unknown",f=s==="complete"?"complete":s==="error"?"error":"other",i=document.createElement("tr"),p=document.createElement("td");p.textContent=formatDate(o.finished_at);const C=document.createElement("td");C.textContent=(o.email||"").slice(0,32)||"-";const g=document.createElement("td");g.textContent=o.mode||"-";const w=document.createElement("td"),y=document.createElement("span");y.className=`status ${f}`,y.textContent=s,w.appendChild(y);const E=document.createElement("td");E.textContent=`${o.duration_seconds||0}s`;const b=document.createElement("td");return b.textContent=o.credit_refunded?"Yes":"No",i.appendChild(p),i.appendChild(C),i.appendChild(g),i.appendChild(w),i.appendChild(E),i.appendChild(b),i});renderRows("jobs-body",m,"No jobs found in selected window.",6);const h=(e.recent_purchases||[]).map(o=>{const s=document.createElement("tr"),f=document.createElement("td");f.textContent=formatDate(o.created_at);const i=document.createElement("td");i.textContent=o.bundle_name||"-";const p=document.createElement("td");return p.textContent=formatMoney(o.price_cents||0),s.appendChild(f),s.appendChild(i),s.appendChild(p),s});renderRows("purchases-body",h,"No purchases found in selected window.",3);const u=(e.recent_rate_limits||[]).map(o=>`
                <tr>
                    <td>${formatDate(o.created_at)}</td>
                    <td>${formatRateLimitLabel(o.limit_name)}</td>
                    <td>${o.retry_after_seconds||0}s</td>
                </tr>
            `);renderRows("rate-limit-body",u,"No rate-limit hits found in selected window.",3),stateArea.style.display="none",dashboard.style.display="block"}async function loadAdminOverview(e){if(!e){setState("Please sign in to continue.","blocked");return}setState("Loading admin dashboard...","loading");try{const t=await authFetch(`/api/admin/overview?window=${encodeURIComponent(currentWindow)}`);if(t.status===403){setState("Your account is signed in but not configured as admin. Set ADMIN_EMAILS or ADMIN_UIDS on the server.","blocked");return}if(!t.ok){setState("Could not load dashboard data. Please refresh.","error");return}const d=await t.json();renderDashboard(d)}catch(t){console.error(t),setState("Network error while loading dashboard.","error")}}async function exportCsv(e){if(!auth.currentUser){setState("Please sign in to export CSV.","blocked");return}try{const t=await authFetch(`/api/admin/export?type=${encodeURIComponent(e)}&window=${encodeURIComponent(currentWindow)}`);if(!t.ok){setState("Could not export CSV right now.","error");return}if(downloadUtils.downloadResponseBlob){await downloadUtils.downloadResponseBlob(t,`admin-${e}-${currentWindow}.csv`);return}const d=await t.blob(),n=URL.createObjectURL(d),c=document.createElement("a");c.href=n,c.download=`admin-${e}-${currentWindow}.csv`,document.body.appendChild(c),c.click(),document.body.removeChild(c),URL.revokeObjectURL(n)}catch(t){console.error(t),setState("Network error while exporting CSV.","error")}}function setActiveFilterButton(){document.querySelectorAll(".filter").forEach(e=>{e.classList.toggle("active",e.dataset.window===currentWindow)})}function setActiveModeViewButton(){document.querySelectorAll(".mode-view").forEach(e=>{e.classList.toggle("active",e.dataset.modeView===currentModeView)})}auth.onAuthStateChanged(async e=>{if(e){if(authClient&&typeof authClient.setToken=="function")try{authClient.setToken(await e.getIdToken())}catch(t){}signedInMeta.textContent=`Signed in as ${e.email}`,authBtn.textContent="Sign out",await loadAdminOverview(e)}else authClient&&typeof authClient.clearToken=="function"&&authClient.clearToken(),signedInMeta.textContent="Not signed in",authBtn.textContent="Sign in",setState("Please sign in with your admin account.","blocked")}),authBtn.addEventListener("click",async()=>{if(auth.currentUser){try{await fetch("/api/session/logout",{method:"POST",credentials:"include"})}catch(e){}await auth.signOut();return}window.location.href="/"}),refreshBtn.addEventListener("click",async()=>{if(!auth.currentUser){setState("Please sign in to refresh.","blocked");return}await loadAdminOverview(auth.currentUser)}),backBtn.addEventListener("click",()=>{window.location.href="/"}),exportJobsBtn.addEventListener("click",async()=>{await exportCsv("jobs")}),exportPurchasesBtn.addEventListener("click",async()=>{await exportCsv("purchases")}),exportFunnelBtn.addEventListener("click",async()=>{await exportCsv("funnel")}),exportFunnelDailyBtn.addEventListener("click",async()=>{await exportCsv("funnel-daily")}),document.querySelectorAll(".filter").forEach(e=>{e.addEventListener("click",async()=>{currentWindow=e.dataset.window,setActiveFilterButton(),auth.currentUser&&await loadAdminOverview(auth.currentUser)})}),document.querySelectorAll(".mode-view").forEach(e=>{e.addEventListener("click",()=>{currentModeView=e.dataset.modeView,setActiveModeViewButton(),renderModeBreakdown()})}),setActiveFilterButton(),setActiveModeViewButton();
