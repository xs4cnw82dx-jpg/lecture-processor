const firebaseConfig={apiKey:"AIzaSyBAAeEUCPNvP5qnqpP3M6HnFZ6vaaijUvM",authDomain:"lecture-processor-cdff6.firebaseapp.com",projectId:"lecture-processor-cdff6",storageBucket:"lecture-processor-cdff6.firebasestorage.app",messagingSenderId:"374793454161",appId:"1:374793454161:web:c68b21590e9a1fafa32e70"};firebase.initializeApp(firebaseConfig);const auth=firebase.auth(),authUtils=window.LectureProcessorAuth||{},authClient=authUtils.createAuthClient?authUtils.createAuthClient(auth,{notSignedInMessage:"Please sign in"}):null,markdownUtils=window.LectureProcessorMarkdown||{},uxUtils=window.LectureProcessorUx||{},downloadUtils=window.LectureProcessorDownload||{},topbarUtils=window.LectureProcessorTopbar||{};let token=null,folders=[],packs=[],selectedFolderId="",selectedPackId="",selectedPack=null,activeEditorPane="notes",exportType="flashcards",draggedPackId="",folderModalMode="create",editingFolderId="",pendingOpenPackId="",confirmModalResolver=null,builderDraft=null,builderMode="edit",builderPane="info",builderDirty=!1,builderPackId="",builderExitResolver=null,builderImportParsed=null,builderAutoSaveTimer=null,builderAutoSaving=!1,builderAutoSaveQueued=!1,learnFlashcardIndex=0,learnFlashcardFlipped=!1,learnQuestionIndex=0,learnScore=0,learnAnswered=!1,activeLearnMode="",orderedFlashcards=[],learnSessionRecorded=!1,flashcardReviewedThisCard=!1,audioSections=[],audioMap=[],audioReady=!1,audioSpeedIndex=1,audioHiddenForLearn=!1,remoteProgressCardStates={},progressTimezone=Intl.DateTimeFormat().resolvedOptions().timeZone||"UTC",progressSyncTimer=null,progressSyncInFlight=!1,creatingDemoPack=!1,progressHydrationDone=!1,packAdvancedMetadataOpen=!1,builderAdvancedMetadataOpen=!1;const audioSpeeds=[.75,1,1.25,1.5,2];let difficultyFadeTimer=null,keyboardHintFadeTimer=null,notesFullscreenFadeTimer=null;const HINT_FADE_DELAY_MS=1e4,NOTES_ICON_IDLE_MS=5e3,urlParams=new URLSearchParams(window.location.search),learnPackFromUrl=urlParams.get("pack_id")||"",openLearnFromUrl=urlParams.get("mode")==="learn",fullscreenFromUrl=urlParams.get("fullscreen")==="1",focusFromUrl=urlParams.get("focus")||"";let autoLearnConsumed=!1,writeIndex=0,writeRevealed=!1,writeChecked=!1,writePromptSwapped=!1,matchCards=[],matchSelected=null,matchMatched=0,matchTotal=0,matchTimerInterval=null,matchStartTime=0,matchElapsed=0,matchRunning=!1;const MATCH_MIN_CARDS=6,BUILDER_AUTOSAVE_DELAY_MS=1500,BUILTIN_ALL_FOLDER_ID="",BUILTIN_INTERVIEWS_FOLDER_ID="__interviews__",MAX_PINNED_FOLDERS=5;let pinnedFolderIds=[];const ALGO_PRESETS={balanced:["new","new","familiar","retry","remaster"],random:["random","random","random","random","random"],lastminute:["new","new","new","new","retry"],fixmistakes:["new","retry","new","retry","retry"],hardfirst:["hard","hard","retry","new","familiar"]},ALGO_TYPES=["new","familiar","retry","remaster","hard","random"],ALGO_ICONS={new:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="5" y="2" width="14" height="20" rx="2"></rect><line x1="12" y1="18" x2="12.01" y2="18"></line></svg>',familiar:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path></svg>',retry:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="23 4 23 10 17 10"></polyline><path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"></path></svg>',remaster:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 9H4.5a2.5 2.5 0 0 1 0-5C5.7 4 7 4.8 8 6c1-1.2 2.3-2 3.5-2a2.5 2.5 0 0 1 0 5H10"></path><path d="M6 9l6 6 6-6"></path></svg>',hard:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2l2.7 5.5L21 8.4l-4.5 4.4 1 6.2L12 16.8 6.5 19l1-6.2L3 8.4l6.3-.9L12 2z"></path></svg>',random:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="16 3 21 3 21 8"></polyline><line x1="4" y1="20" x2="21" y2="3"></line><polyline points="21 16 21 21 16 21"></polyline><line x1="15" y1="15" x2="21" y2="21"></line><line x1="4" y1="4" x2="9" y2="9"></line></svg>'},MODE_ICONS={flashcards:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="4" width="20" height="16" rx="2"></rect><line x1="2" y1="12" x2="22" y2="12"></line></svg>',test:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M9 11l3 3L22 4"></path><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"></path></svg>',write:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M12 20h9"></path><path d="M16.5 3.5a2.12 2.12 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"></path></svg>',match:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="7" height="7"></rect><rect x="14" y="3" width="7" height="7"></rect><rect x="3" y="14" width="7" height="7"></rect><rect x="14" y="14" width="7" height="7"></rect></svg>'},MODE_NAMES={flashcards:"Zen Cards",test:"Multiple Choice",write:"Write",match:"Match"},MODE_DESCS={flashcards:"Flip through cards at your pace",test:"Answer multiple choice questions",write:"Type answers from memory",match:"Pair terms with definitions"};let sessionSettings={swapAnswerQuestion:!1,randomSwap:!1,caseSensitive:!1,forceExactMatch:!1,addMissedToReview:!0,ignoreArticles:!1,ignoreDeterminers:!1,ignoreBrackets:!1},sessionAlgo=["new","new","familiar","retry","remaster"],sessionAlgoPreset="balanced",sessionLessons={flashcards:!0,test:!0,write:!1,match:!1},activeSetupPane="mastery";const SR_MIN_INTERVAL_DAYS=1,SR_MAX_INTERVAL_DAYS=120,SR_DIFFICULTY_MULTIPLIER={easy:2.4,medium:2,hard:1.45};function getBrowserTimezone(){var e="UTC";try{e=Intl.DateTimeFormat().resolvedOptions().timeZone||"UTC"}catch(t){}return String(e||"UTC")}function normalizeTimezoneName(e){var t=String(e||"").trim();if(!t)return"";try{return Intl.DateTimeFormat("en-CA",{timeZone:t}).format(new Date),t}catch(n){return""}}function getDateStringInTimezone(e,t){var n=normalizeTimezoneName(t)||getBrowserTimezone(),r=e?new Date(e):new Date;try{for(var a=Intl.DateTimeFormat("en-CA",{timeZone:n,year:"numeric",month:"2-digit",day:"2-digit"}).formatToParts(r),i="",s="",o="",l=0;l<a.length;l++)a[l].type==="year"&&(i=a[l].value),a[l].type==="month"&&(s=a[l].value),a[l].type==="day"&&(o=a[l].value);if(i&&s&&o)return i+"-"+s+"-"+o}catch(d){}return localDateStringFromTimestamp(e)}function localDateStringFromTimestamp(e){var t=e?new Date(e):new Date,n=t.getFullYear(),r=String(t.getMonth()+1).padStart(2,"0"),a=String(t.getDate()).padStart(2,"0");return n+"-"+r+"-"+a}function todayLocalDateString(){return getDateStringInTimezone(Date.now(),progressTimezone)}function addDaysToLocalDate(e,t){var n=String(e||todayLocalDateString()).split("-");if(n.length!==3)return todayLocalDateString();var r=parseInt(n[0],10),a=parseInt(n[1],10),i=parseInt(n[2],10);if(!Number.isFinite(r)||!Number.isFinite(a)||!Number.isFinite(i))return todayLocalDateString();var s=new Date(Date.UTC(r,a-1,i));return s.setUTCDate(s.getUTCDate()+Math.max(0,parseInt(t,10)||0)),s.toISOString().slice(0,10)}function isDueDate(e){var t=String(e||"").trim();return t?t<=todayLocalDateString():!0}function getCardStateIndexKey(){return"card_state_index_"+(auth.currentUser?auth.currentUser.uid:"anon")}function readCardStateIndex(){try{var e=JSON.parse(localStorage.getItem(getCardStateIndexKey())||"[]");if(!Array.isArray(e))return[];var t={},n=[];return e.forEach(function(r){var a=String(r||"").trim();!a||t[a]||(t[a]=!0,n.push(a))}),n}catch(r){return[]}}function writeCardStateIndex(e){var t={},n=[];(e||[]).forEach(function(r){var a=String(r||"").trim();!a||t[a]||(t[a]=!0,n.push(a))});try{localStorage.setItem(getCardStateIndexKey(),JSON.stringify(n))}catch(r){}return n}function addPackToCardStateIndex(e){var t=String(e||"").trim();if(t){var n=readCardStateIndex();n.indexOf(t)<0&&(n.push(t),writeCardStateIndex(n))}}function removePackFromCardStateIndex(e){var t=String(e||"").trim();if(t){var n=readCardStateIndex().filter(function(r){return r!==t});writeCardStateIndex(n)}}function removePackLocalCaches(e){if(auth.currentUser){var t=String(e||"").trim();if(t){var n=auth.currentUser.uid;try{localStorage.removeItem(getCardStateKeyForPack(t))}catch(r){}try{localStorage.removeItem("match_scores_"+n+"_"+t)}catch(r){}try{localStorage.removeItem("study_session_"+n+"_"+t)}catch(r){}removePackFromCardStateIndex(t)}}}function cleanupCardStateCacheForKnownPacks(){if(auth.currentUser){var e=auth.currentUser.uid,t={};(packs||[]).forEach(function(l){var d=String(l&&l.study_pack_id||"").trim();d&&(t[d]=!0)});for(var n=readCardStateIndex(),r="card_state_"+e+"_",a=0;a<localStorage.length;a++){var i=localStorage.key(a);if(!(!i||i.indexOf(r)!==0)){var s=i.slice(r.length);s&&n.indexOf(s)<0&&n.push(s)}}var o=[];n.forEach(function(l){if(!t[l]){removePackLocalCaches(l);return}var d={};try{d=JSON.parse(localStorage.getItem(getCardStateKeyForPack(l))||"{}")||{}}catch(f){d={}}if(d&&typeof d=="object"&&Object.keys(d).length)o.push(l);else try{localStorage.removeItem(getCardStateKeyForPack(l))}catch(f){}}),writeCardStateIndex(o)}}function getCardStateKey(){return"card_state_"+(auth.currentUser?auth.currentUser.uid:"anon")+"_"+selectedPackId}function loadCardState(){try{return JSON.parse(localStorage.getItem(getCardStateKey()))||{}}catch(e){return{}}}function saveCardState(e){try{localStorage.setItem(getCardStateKey(),JSON.stringify(e))}catch(t){}selectedPackId&&addPackToCardStateIndex(selectedPackId),queueProgressSync(!0)}function getStreakKey(){return"study_streak_"+(auth.currentUser?auth.currentUser.uid:"anon")}function loadStreakData(){try{var e=localStorage.getItem(getStreakKey());if(!e)return{last_study_date:"",current_streak:0,daily_progress_date:"",daily_progress_count:0};var t=JSON.parse(e)||{};return{last_study_date:t.last_study_date||"",current_streak:parseInt(t.current_streak,10)||0,daily_progress_date:t.daily_progress_date||"",daily_progress_count:parseInt(t.daily_progress_count,10)||0}}catch(n){return{last_study_date:"",current_streak:0,daily_progress_date:"",daily_progress_count:0}}}function saveStreakData(e){try{localStorage.setItem(getStreakKey(),JSON.stringify(e||{}))}catch(t){}queueProgressSync(!1)}function getDailyGoalKey(){return"daily_goal_"+(auth.currentUser?auth.currentUser.uid:"anon")}function loadDailyGoal(){try{var e=parseInt(localStorage.getItem(getDailyGoalKey())||"20",10);return Number.isFinite(e)&&e>0?Math.min(e,500):20}catch(t){return 20}}function saveDailyGoal(e){var t=parseInt(e,10);if(!(!Number.isFinite(t)||t<=0)){try{localStorage.setItem(getDailyGoalKey(),String(Math.min(t,500)))}catch(n){}queueProgressSync(!1)}}function readLocalProgressSnapshot(){if(!auth.currentUser)return{daily_goal:20,streak_data:{},card_states:{}};var e=auth.currentUser.uid,t=loadDailyGoal(),n=loadStreakData(),r={},a=readCardStateIndex();if(!a.length)for(var i="card_state_"+e+"_",s=0;s<localStorage.length;s++){var o=localStorage.key(s);if(!(!o||o.indexOf(i)!==0)){var l=o.slice(i.length);l&&a.indexOf(l)<0&&a.push(l)}}var d={};(packs||[]).forEach(function(c){var u=String(c&&c.study_pack_id||"").trim();u&&(d[u]=!0)});var f=[];return a.forEach(function(c){if(c){if(Object.keys(d).length&&!d[c]){removePackLocalCaches(c);return}var u=getCardStateKeyForPack(c);try{var m=JSON.parse(localStorage.getItem(u)||"{}")||{};m&&typeof m=="object"&&Object.keys(m).length?(r[c]=m,f.push(c)):localStorage.removeItem(u)}catch(v){try{localStorage.removeItem(u)}catch(h){}}}}),writeCardStateIndex(f),{daily_goal:t,streak_data:n,card_states:r}}function mergeProgressFromServer(e){if(!(!auth.currentUser||!e)){var t=auth.currentUser.uid,n=normalizeTimezoneName(e.timezone||"");if(n&&(progressTimezone=n),typeof e.daily_goal=="number"&&e.daily_goal>0)try{localStorage.setItem("daily_goal_"+t,String(Math.min(500,Math.max(1,parseInt(e.daily_goal,10)||20))))}catch(l){}if(e.streak_data&&typeof e.streak_data=="object"){var r=loadStreakData(),a=parseInt(e.streak_data.daily_progress_count,10)||0,i=parseInt(r.daily_progress_count,10)||0,s=String(r.daily_progress_date||""),o=String(e.streak_data.daily_progress_date||"");(!r.last_study_date||o&&o>=s&&a>=i)&&saveStreakData(e.streak_data)}remoteProgressCardStates=e.card_states&&typeof e.card_states=="object"?e.card_states:{},Object.keys(remoteProgressCardStates).forEach(function(l){if(l){var d=remoteProgressCardStates[l]||{},f="card_state_"+t+"_"+l,c={};try{c=JSON.parse(localStorage.getItem(f)||"{}")||{}}catch(u){}if(!Object.keys(c).length&&Object.keys(d).length)try{localStorage.setItem(f,JSON.stringify(d))}catch(u){}(Object.keys(d).length||Object.keys(c).length)&&addPackToCardStateIndex(l)}})}}function loadRemoteProgress(){return!auth.currentUser||!token?Promise.resolve():apiCall("/api/study-progress").then(function(e){progressHydrationDone=!0,mergeProgressFromServer(e||{})}).catch(function(e){console.warn("Could not load remote study progress:",e&&e.message?e.message:e)})}function flushProgressSync(e){if(!(progressSyncInFlight||!auth.currentUser||!token)){progressSyncInFlight=!0;var t=readLocalProgressSnapshot(),n={daily_goal:t.daily_goal,streak_data:t.streak_data,timezone:progressTimezone||getBrowserTimezone()};e?n.card_states=t.card_states:selectedPackId&&(n.card_states={},n.card_states[selectedPackId]=loadCardState()),apiCall("/api/study-progress",{method:"PUT",body:JSON.stringify(n)}).catch(function(r){console.warn("Could not sync study progress:",r&&r.message?r.message:r)}).finally(function(){progressSyncInFlight=!1})}}function queueProgressSync(e){!auth.currentUser||!token||(progressSyncTimer&&clearTimeout(progressSyncTimer),progressSyncTimer=setTimeout(function(){progressSyncTimer=null,flushProgressSync(!e)},700))}function clampIntervalDays(e){var t=Math.round(parseFloat(e)||0);return t<SR_MIN_INTERVAL_DAYS?SR_MIN_INTERVAL_DAYS:t>SR_MAX_INTERVAL_DAYS?SR_MAX_INTERVAL_DAYS:t}function getNextIntervalDays(e,t,n){var r=Math.max(0,parseInt(e,10)||0),a=String(n||"medium").toLowerCase();if(SR_DIFFICULTY_MULTIPLIER[a]||(a="medium"),!t)return r<=1?SR_MIN_INTERVAL_DAYS:clampIntervalDays(r*.45);if(r<=0)return a==="easy"?2:1;var i=Math.max(r+1,r*SR_DIFFICULTY_MULTIPLIER[a]);return a==="easy"&&(i=Math.max(i,r+2)),clampIntervalDays(i)}function ensureStudyActivityRecorded(){var e=todayLocalDateString(),t=addDaysToLocalDate(e,-1),n=loadStreakData();return n.last_study_date!==e&&(n.last_study_date===t?n.current_streak=Math.max(1,(n.current_streak||0)+1):n.current_streak=1,n.last_study_date=e),n.daily_progress_date!==e&&(n.daily_progress_date=e,n.daily_progress_count=0),n}function recordStudyActivity(){var e=ensureStudyActivityRecorded();return e.daily_progress_count=Math.max(0,parseInt(e.daily_progress_count,10)||0)+1,saveStreakData(e),e}function setCardDifficulty(e,t){if(e){var n=String(t||"").toLowerCase();if(!(["easy","medium","hard"].indexOf(n)<0)){var r=loadCardState();r[e]||(r[e]={seen:0,correct:0,wrong:0,level:"new",interval_days:0,next_review_date:"",difficulty:"medium"}),r[e].difficulty=n,saveCardState(r),updateDifficultyToolbar(),renderMasteryGauge()}}}function markCardReview(e,t){if(e){var n=loadCardState();n[e]||(n[e]={seen:0,correct:0,wrong:0,level:"new",interval_days:0,next_review_date:"",difficulty:"medium",last_review_date:""});var r=n[e];r.seen=(r.seen||0)+1,t?r.correct=(r.correct||0)+1:r.wrong=(r.wrong||0)+1,r.interval_days=getNextIntervalDays(r.interval_days,t,r.difficulty||"medium"),r.last_review_date=todayLocalDateString(),r.next_review_date=addDaysToLocalDate(r.last_review_date,r.interval_days),r.interval_days>=14?r.level="mastered":r.seen>0?r.level="familiar":r.level="new",r.difficulty||(r.difficulty="medium"),n[e]=r,saveCardState(n),recordStudyActivity(),renderMasteryGauge(),updateTopbarDueCount()}}function markCardViewed(e){if(e){var t=loadCardState();t[e]||(t[e]={seen:0,correct:0,wrong:0,level:"new",interval_days:0,next_review_date:"",difficulty:"medium",last_review_date:""});var n=t[e];n.seen=(n.seen||0)+1,n.last_review_date=todayLocalDateString(),n.level!=="mastered"&&(n.level="familiar"),n.difficulty||(n.difficulty="medium"),t[e]=n,saveCardState(t),recordStudyActivity(),renderMasteryGauge(),updateTopbarDueCount()}}function markCardSeen(e,t){markCardReview(e,t)}function getCardStateKeyForPack(e){return"card_state_"+(auth.currentUser?auth.currentUser.uid:"anon")+"_"+String(e||"")}function loadCardStateForPack(e){try{return JSON.parse(localStorage.getItem(getCardStateKeyForPack(e))||"{}")||{}}catch(t){return{}}}function updateDailyGoalDisplays(){}function recordLearnSessionCompletion(){if(!learnSessionRecorded){var e=todayLocalDateString(),t=addDaysToLocalDate(e,-1),n=loadStreakData();n.last_study_date!==e&&(n.last_study_date===t?n.current_streak=Math.max(1,(n.current_streak||0)+1):n.current_streak=1,n.last_study_date=e),n.daily_progress_date!==e&&(n.daily_progress_date=e,n.daily_progress_count=Math.max(0,parseInt(n.daily_progress_count,10)||0)),saveStreakData(n),learnSessionRecorded=!0}}function countDueCardsInState(e){var t=0;return Object.keys(e||{}).forEach(function(n){if(n.indexOf("fc_")===0){var r=e[n]||{};parseInt(r.seen,10)>0&&isDueDate(r.next_review_date)&&t++}}),t}function updateTopbarDueCount(){if(topbarDueText){var e=0;Array.isArray(packs)&&packs.length?packs.forEach(function(t){e+=countDueCardsInState(loadCardStateForPack(t.study_pack_id))}):selectedPackId&&(e=countDueCardsInState(loadCardState())),topbarDueText.textContent=e+" due today"}}function getMatchScoreKey(){return"match_scores_"+(auth.currentUser?auth.currentUser.uid:"anon")+"_"+selectedPackId}function loadMatchScores(){try{return JSON.parse(localStorage.getItem(getMatchScoreKey()))||[]}catch(e){return[]}}function saveMatchScore(e){var t=loadMatchScores();t.push(e),t.sort(function(n,r){return n-r}),t.length>10&&(t=t.slice(0,10));try{localStorage.setItem(getMatchScoreKey(),JSON.stringify(t))}catch(n){}return t}function getScoreRank(e,t){for(var n=0;n<e.length;n++)if(e[n]===t)return n+1;return e.length}function getSessionStorageKey(){return"study_session_"+(auth.currentUser?auth.currentUser.uid:"anon")+"_"+selectedPackId}function loadSessionState(){try{var e=localStorage.getItem(getSessionStorageKey());if(!e)return;var t=JSON.parse(e);t.settings&&(sessionSettings=Object.assign({},sessionSettings,t.settings)),t.algo&&Array.isArray(t.algo)&&t.algo.length===5&&(sessionAlgo=t.algo),t.algoPreset&&(sessionAlgoPreset=t.algoPreset),t.lessons&&(sessionLessons=Object.assign({},sessionLessons,t.lessons))}catch(n){}}function saveSessionState(){try{localStorage.setItem(getSessionStorageKey(),JSON.stringify({settings:sessionSettings,algo:sessionAlgo,algoPreset:sessionAlgoPreset,lessons:sessionLessons}))}catch(e){}}function orderCardsByAlgo(e){if(!e||!e.length)return[];var t=loadCardState(),n={new:[],familiar:[],retry:[],remaster:[],hard:[],random:[]},r=[];e.forEach(function(s,o){var l="fc_"+o,d=t[l],f={card:s,idx:o},c=!d||!d.seen||isDueDate(d.next_review_date);c?(!d||d.level==="new"?n.new.push(f):d.level==="familiar"?n.familiar.push(f):d.level==="mastered"&&n.remaster.push(f),d&&d.wrong>0&&n.retry.push(f),d&&d.difficulty==="hard"&&n.hard.push(f)):r.push(f),n.random.push({card:s,idx:o})}),Object.keys(n).forEach(function(s){n[s].sort(function(){return Math.random()-.5})});var a=[],i={};return sessionAlgo.forEach(function(s){for(var o=n[s]||n.random,l=0;l<o.length;l++)if(!i[o[l].idx]){a.push(o[l]),i[o[l].idx]=!0;break}}),e.forEach(function(s,o){!i[o]&&!r.find(function(l){return l.idx===o})&&a.push({card:s,idx:o})}),r.forEach(function(s){i[s.idx]||a.push(s)}),a}function getFlashcardQueue(){if(orderedFlashcards.length)return orderedFlashcards;var e=selectedPack&&Array.isArray(selectedPack.flashcards)?selectedPack.flashcards:[];return e.map(function(t,n){return{card:t,idx:n}})}function getCurrentDifficultyCardId(){if(!selectedPack)return"";if(activeLearnMode==="flashcards"){var e=getFlashcardQueue();if(e[learnFlashcardIndex])return"fc_"+e[learnFlashcardIndex].idx}if(activeLearnMode==="write"){var t=getWriteCards();if(t[writeIndex])return"fc_"+t[writeIndex].idx}return activeLearnMode==="test"?"q_"+learnQuestionIndex:""}function updateDifficultyToolbar(){if(difficultyToolbar){if(!learnStage.classList.contains("visible")){difficultyToolbar.classList.remove("visible"),difficultyToolbar.classList.remove("faded");return}if(["flashcards","write","test"].indexOf(activeLearnMode)<0){difficultyToolbar.classList.remove("visible"),difficultyToolbar.classList.remove("faded");return}var e=getCurrentDifficultyCardId();if(!e){difficultyToolbar.classList.remove("visible"),difficultyToolbar.classList.remove("faded");return}var t=loadCardState(),n=(t[e]&&t[e].difficulty||"medium").toLowerCase();difficultyButtons.forEach(function(r){var a=r.dataset.difficulty;r.classList.toggle("active",a===n)}),difficultyToolbar.classList.add("visible"),difficultyToolbar.classList.remove("faded")}}function normalizeAnswer(e){var t=e.trim();return sessionSettings.caseSensitive||(t=t.toLowerCase()),sessionSettings.ignoreBrackets&&(t=t.replace(/\([^)]*\)/g,"").replace(/\[[^\]]*\]/g,"")),sessionSettings.ignoreArticles&&(t=t.replace(/\b(a|an|the)\b/gi,"")),sessionSettings.ignoreDeterminers&&(t=t.replace(/[;,\/]/g,"")),t=t.replace(/\s+/g," ").trim(),t}function gradeAnswer(e,t){var n=normalizeAnswer(e),r=normalizeAnswer(t);return sessionSettings.forceExactMatch,n===r}var userMeta=document.getElementById("user-meta"),backAppBtn=document.getElementById("back-app-btn"),fullscreenBtn=document.getElementById("fullscreen-btn"),topbarDueText=document.getElementById("topbar-due-text"),searchInput=document.getElementById("search-input"),folderList=document.getElementById("folder-list"),packList=document.getElementById("pack-list"),newFolderBtn=document.getElementById("new-folder-btn"),deleteFolderBtn=document.getElementById("delete-folder-btn"),packEmpty=document.getElementById("pack-empty"),packEmptyDefault=document.getElementById("pack-empty-default"),packEmptyOnboarding=document.getElementById("pack-empty-onboarding"),packEmptyCreateBtn=document.getElementById("pack-empty-create-btn"),packEmptyDemoBtn=document.getElementById("pack-empty-demo-btn"),packEditorWrap=document.getElementById("pack-editor-wrap"),packTitle=document.getElementById("pack-title"),packFolderSelect=document.getElementById("pack-folder-select"),packFolderPicker=document.getElementById("pack-folder-picker"),packFolderButton=document.getElementById("pack-folder-button"),packFolderLabel=document.getElementById("pack-folder-label"),packFolderMenu=document.getElementById("pack-folder-menu"),packCourse=document.getElementById("pack-course"),packSubject=document.getElementById("pack-subject"),packSemester=document.getElementById("pack-semester"),packBlock=document.getElementById("pack-block"),notesView=document.getElementById("notes-view"),packAdvancedMetaBtn=document.getElementById("pack-advanced-meta-btn"),packAdvancedMetaPanel=document.getElementById("pack-advanced-meta-panel"),packSummary=document.getElementById("pack-summary"),packSummaryTitle=document.getElementById("pack-summary-title"),packSummaryMeta=document.getElementById("pack-summary-meta"),packStatNotes=document.getElementById("pack-stat-notes"),packStatCards=document.getElementById("pack-stat-cards"),packStatTest=document.getElementById("pack-stat-test"),packStorageNote=document.getElementById("pack-storage-note"),createPackBtn=document.getElementById("create-pack-btn"),openBuilderBtn=document.getElementById("open-builder-btn"),savePackBtn=document.getElementById("save-pack-btn"),deletePackBtn=document.getElementById("delete-pack-btn"),exportPackNotesBtn=document.getElementById("export-pack-notes-btn"),openLearnBtn=document.getElementById("open-learn-btn"),exportMenu=document.getElementById("export-menu"),exportMenuBtn=document.getElementById("export-menu-btn"),exportMenuList=document.getElementById("export-menu-list"),exportPdfSubmenu=document.getElementById("export-pdf-submenu"),editorTabs=document.querySelectorAll(".editor-tab"),flashcardCount=document.getElementById("flashcard-count"),questionCount=document.getElementById("question-count"),addFlashcardBtn=document.getElementById("add-flashcard-btn"),addQuestionBtn=document.getElementById("add-question-btn"),flashcardEditorList=document.getElementById("flashcard-editor-list"),questionEditorList=document.getElementById("question-editor-list"),learnStage=document.getElementById("learn-stage"),learnTitle=document.getElementById("learn-title"),learnSub=document.getElementById("learn-sub"),learnBackAppBtn=document.getElementById("learn-back-app-btn"),learnBackLibraryBtn=document.getElementById("learn-back-library-btn"),learnFullscreenBtn=document.getElementById("learn-fullscreen-btn"),notesPaneShell=document.getElementById("notes-pane-shell"),notesFullscreenBtn=document.getElementById("notes-fullscreen-btn"),learnModeLabel=document.getElementById("learn-mode-label"),learnFlashcard3d=document.getElementById("learn-flashcard-3d"),learnFlashcardInner=document.getElementById("learn-flashcard-inner"),learnFlashcardFront=document.getElementById("learn-flashcard-front"),learnFlashcardBack=document.getElementById("learn-flashcard-back"),learnFPrev=document.getElementById("learn-f-prev"),learnFFlip=document.getElementById("learn-f-flip"),learnFNext=document.getElementById("learn-f-next"),learnFProgress=document.getElementById("learn-f-progress"),learnProgressFill=document.getElementById("learn-progress-fill"),learnProgressText=document.getElementById("learn-progress-text"),learnQProgress=document.getElementById("learn-q-progress"),learnQScore=document.getElementById("learn-q-score"),learnQText=document.getElementById("learn-q-text"),learnQOptions=document.getElementById("learn-q-options"),learnQExpl=document.getElementById("learn-q-expl"),learnQNext=document.getElementById("learn-q-next"),writePromptEl=document.getElementById("write-prompt"),writeInputEl=document.getElementById("write-input"),writeCheckBtn=document.getElementById("write-check-btn"),writeRevealBtn=document.getElementById("write-reveal-btn"),writeFeedbackEl=document.getElementById("write-feedback"),writeNextBtn=document.getElementById("write-next-btn"),writeProgressEl=document.getElementById("write-progress"),matchGridEl=document.getElementById("match-grid"),matchTimerEl=document.getElementById("match-timer"),matchResultsEl=document.getElementById("match-results"),matchResultsTime=document.getElementById("match-results-time"),matchResultsBadge=document.getElementById("match-results-badge"),matchResultsHistory=document.getElementById("match-results-history"),matchPlayAgainBtn=document.getElementById("match-play-again"),setupOverlay=document.getElementById("setup-overlay"),setupPackName=document.getElementById("setup-pack-name"),setupCloseBtn=document.getElementById("setup-close-btn"),setupStartBtn=document.getElementById("setup-start-btn"),setupMainContent=document.getElementById("setup-main-content"),setupTabs=document.querySelectorAll(".setup-tab"),algoLane=document.getElementById("algo-lane"),algoPresets=document.querySelectorAll(".algo-preset"),masterySeenEl=document.getElementById("mastery-seen"),masteryTotalEl=document.getElementById("mastery-total"),masteryNewPctEl=document.getElementById("mastery-new-pct"),masteryFamiliarPctEl=document.getElementById("mastery-familiar-pct"),masteryMasteredPctEl=document.getElementById("mastery-mastered-pct"),masteryDueTodayEl=document.getElementById("mastery-due-today"),masteryUnmasteredEl=document.getElementById("mastery-unmastered"),diffEasyCountEl=document.getElementById("diff-easy-count"),diffMediumCountEl=document.getElementById("diff-medium-count"),diffHardCountEl=document.getElementById("diff-hard-count"),examRecommendationEl=document.getElementById("exam-recommendation"),modePicker=document.getElementById("mode-picker"),modePickerGrid=document.getElementById("mode-picker-grid"),modePickerBack=document.getElementById("mode-picker-back"),builderOverlay=document.getElementById("builder-overlay"),builderBrandSub=document.getElementById("builder-brand-sub"),builderSaveBtn=document.getElementById("builder-save-btn"),builderExitBtn=document.getElementById("builder-exit-btn"),builderShareBtn=document.getElementById("builder-share-btn"),builderTitleEl=document.getElementById("builder-title"),builderSubEl=document.getElementById("builder-sub"),builderSummary=document.getElementById("builder-summary"),builderOpenLearnShortcut=document.getElementById("builder-open-learn-shortcut"),builderPaneButtons=document.querySelectorAll(".builder-nav-btn[data-builder-pane]"),builderStatCards=document.getElementById("builder-stat-cards"),builderStatQuestions=document.getElementById("builder-stat-questions"),builderStatDirty=document.getElementById("builder-stat-dirty"),builderTitleInput=document.getElementById("builder-title-input"),builderFolderSelect=document.getElementById("builder-folder-select"),builderCourseInput=document.getElementById("builder-course-input"),builderSubjectInput=document.getElementById("builder-subject-input"),builderSemesterInput=document.getElementById("builder-semester-input"),builderBlockInput=document.getElementById("builder-block-input"),builderNotesInput=document.getElementById("builder-notes-input"),builderAdvancedMetaBtn=document.getElementById("builder-advanced-meta-btn"),builderAdvancedMetaPanel=document.getElementById("builder-advanced-meta-panel"),builderFlashcardList=document.getElementById("builder-flashcard-list"),builderQuestionList=document.getElementById("builder-question-list"),builderAddCardBtn=document.getElementById("builder-add-card-btn"),builderAddCardBatchBtn=document.getElementById("builder-add-card-batch-btn"),builderAddQuestionBtn=document.getElementById("builder-add-question-btn"),builderAddQuestionBatchBtn=document.getElementById("builder-add-question-batch-btn"),builderImportType=document.getElementById("builder-import-type"),builderImportMode=document.getElementById("builder-import-mode"),builderCsvDrop=document.getElementById("builder-csv-drop"),builderCsvInput=document.getElementById("builder-csv-input"),builderTemplateBtn=document.getElementById("builder-template-btn"),builderApplyImportBtn=document.getElementById("builder-apply-import-btn"),builderImportSummary=document.getElementById("builder-import-summary"),builderPreview=document.getElementById("builder-preview"),builderPreviewTable=document.getElementById("builder-preview-table"),builderImportErrors=document.getElementById("builder-import-errors"),builderExitOverlay=document.getElementById("builder-exit-overlay"),builderExitSave=document.getElementById("builder-exit-save"),builderExitDiscard=document.getElementById("builder-exit-discard"),builderExitCancel=document.getElementById("builder-exit-cancel"),learnNotesContent=document.getElementById("learn-notes-content"),folderModalOverlay=document.getElementById("folder-modal-overlay"),folderModalTitle=document.getElementById("folder-modal-title"),folderModalClose=document.getElementById("folder-modal-close"),folderModalCancel=document.getElementById("folder-modal-cancel"),folderModalSave=document.getElementById("folder-modal-save"),folderNameInput=document.getElementById("folder-name-input"),folderCourseInput=document.getElementById("folder-course-input"),folderSubjectInput=document.getElementById("folder-subject-input"),folderSemesterInput=document.getElementById("folder-semester-input"),folderBlockInput=document.getElementById("folder-block-input"),folderExamDateInput=document.getElementById("folder-exam-date-input"),confirmModalOverlay=document.getElementById("confirm-modal-overlay"),confirmModalTitle=document.getElementById("confirm-modal-title"),confirmModalMessage=document.getElementById("confirm-modal-message"),confirmModalClose=document.getElementById("confirm-modal-close"),confirmModalCancel=document.getElementById("confirm-modal-cancel"),confirmModalConfirm=document.getElementById("confirm-modal-confirm"),toastEl=document.getElementById("toast"),audioPlayerBar=document.getElementById("audio-player-bar"),audioPlayerEl=document.getElementById("audio-player-el"),audioPlayBtn=document.getElementById("audio-play-btn"),audioPlayIcon=document.getElementById("audio-play-icon"),audioPauseIcon=document.getElementById("audio-pause-icon"),audioTime=document.getElementById("audio-time"),audioProgressWrap=document.getElementById("audio-progress-wrap"),audioProgressFill=document.getElementById("audio-progress-fill"),audioSpeedBtn=document.getElementById("audio-speed-btn"),audioPackTitle=document.getElementById("audio-pack-title"),audioCloseBtn=document.getElementById("audio-close-btn"),audioBlobUrl="",difficultyToolbar=document.getElementById("difficulty-toolbar"),difficultyButtons=document.querySelectorAll(".difficulty-btn[data-difficulty]"),keyboardHints=document.querySelector(".keyboard-hints");function showToast(e,t){toastEl.textContent=e,toastEl.className="toast visible "+(t||"success"),setTimeout(function(){toastEl.classList.remove("visible")},2800)}function getVisibleMenuItems(e,t){return uxUtils.getVisibleMenuItems?uxUtils.getVisibleMenuItems(e,t||"button:not([disabled])"):e?Array.from(e.querySelectorAll(t||"button:not([disabled])")).filter(function(n){return n.offsetParent!==null&&!n.disabled}):[]}function focusMenuItem(e,t,n){if(uxUtils.focusMenuItem){uxUtils.focusMenuItem(e,t,n);return}var r=getVisibleMenuItems(e,t);if(r.length){if(n==="last"){r[r.length-1].focus();return}var a=document.activeElement,i=r.indexOf(a);if(n==="next"){r[(i+1+r.length)%r.length].focus();return}if(n==="prev"){r[(i-1+r.length)%r.length].focus();return}if(n==="active"){var s=r.find(function(o){return o.classList.contains("active")||o.getAttribute("aria-selected")==="true"});(s||r[0]).focus();return}r[0].focus()}}function updatePackEmptyState(){var e=(packs||[]).length>0;packEmptyDefault&&packEmptyDefault.classList.toggle("visible",e),packEmptyOnboarding&&packEmptyOnboarding.classList.toggle("visible",!e)}function setAdvancedMetadataPanelState(e,t,n){if(!(!e||!t)){var r=!!n;t.classList.toggle("visible",r),t.setAttribute("aria-hidden",r?"false":"true"),e.setAttribute("aria-expanded",r?"true":"false"),e.textContent=r?"Hide advanced metadata":"Show advanced metadata"}}function applyPackAdvancedMetadataState(e){packAdvancedMetadataOpen=!!e,setAdvancedMetadataPanelState(packAdvancedMetaBtn,packAdvancedMetaPanel,packAdvancedMetadataOpen)}function applyBuilderAdvancedMetadataState(e){builderAdvancedMetadataOpen=!!e,setAdvancedMetadataPanelState(builderAdvancedMetaBtn,builderAdvancedMetaPanel,builderAdvancedMetadataOpen)}function syncPackAdvancedMetadataState(){if(!(!packSemester||!packBlock)){var e=!!String(packSemester.value||"").trim()||!!String(packBlock.value||"").trim();applyPackAdvancedMetadataState(packAdvancedMetadataOpen||e)}}function syncBuilderAdvancedMetadataState(){if(!(!builderSemesterInput||!builderBlockInput)){var e=!!String(builderSemesterInput.value||"").trim()||!!String(builderBlockInput.value||"").trim();applyBuilderAdvancedMetadataState(builderAdvancedMetadataOpen||e)}}applyPackAdvancedMetadataState(!1),applyBuilderAdvancedMetadataState(!1);function setPackFolderMenuOpen(e,t){if(!(!packFolderMenu||!packFolderButton)){var n=!!e;packFolderMenu.classList.toggle("visible",n),packFolderButton.classList.toggle("open",n),packFolderButton.setAttribute("aria-expanded",n?"true":"false"),n&&t&&focusMenuItem(packFolderMenu,".app-select-item",t)}}function closeQuestionAnswerMenus(){questionEditorList.querySelectorAll("[data-answer-menu]").forEach(function(e){e.classList.remove("visible")}),questionEditorList.querySelectorAll("[data-answer-button]").forEach(function(e){e.classList.remove("open"),e.setAttribute("aria-expanded","false")})}function setQuestionAnswerMenuOpen(e,t,n,r){!e||!t||(closeQuestionAnswerMenus(),n&&(t.classList.add("visible"),e.classList.add("open"),e.setAttribute("aria-expanded","true"),r&&focusMenuItem(t,"[data-answer-item]",r)))}function setExportPdfSubmenuOpen(e){if(exportPdfSubmenu){var t=!!e;exportPdfSubmenu.classList.toggle("visible",t);var n=exportMenuList?exportMenuList.querySelector('[data-export-kind="pdf-menu"]'):null;n&&n.setAttribute("aria-expanded",t?"true":"false")}}function setExportMenuOpen(e,t){if(!(!exportMenuList||!exportMenuBtn)){var n=!!e;if(exportMenuList.classList.toggle("visible",n),exportMenuBtn.setAttribute("aria-expanded",n?"true":"false"),!n){setExportPdfSubmenuOpen(!1);return}t&&focusMenuItem(exportMenuList,".export-menu-item",t)}}function mdToHtml(e){return markdownUtils.parseMarkdownToSafeHtml?markdownUtils.parseMarkdownToSafeHtml(e,{preprocess:function(t){return String(t||"").replace(/\r\n/g,`
`).replace(/^\s*<!--\s*audio:\d+\s*-\s*\d+\s*-->\s*$/gim,"").replace(/^\s*[→>-]?\s*audio:\d+\s*-\s*\d+\s*[→-]?\s*$/gim,"").replace(/^\s*\[\s*audio:\d+\s*-\s*\d+\s*\]\s*$/gim,"").replace(/[→>\-]?\s*audio:\d+\s*-\s*\d+\s*[→>\-]?/gim,"")}}):escapeHtml(String(e||"")).replace(/\n/g,"<br>")}function fmtAudioTime(e){if(!isFinite(e)||e<0)return"0:00";var t=Math.floor(e/60),n=Math.floor(e%60);return t+":"+String(n).padStart(2,"0")}function updateAudioBarVisibility(){if(audioPlayerBar){var e=audioReady&&!audioHiddenForLearn;audioPlayerBar.classList.toggle("visible",e)}}function setAudioHiddenForLearn(e){if(audioHiddenForLearn=!!e,audioHiddenForLearn&&audioPlayerEl)try{audioPlayerEl.pause()}catch(t){}updateAudioBarVisibility()}function updateAudioControls(){var e=!audioPlayerEl||audioPlayerEl.paused;audioPlayIcon&&(audioPlayIcon.style.display=e?"":"none"),audioPauseIcon&&(audioPauseIcon.style.display=e?"none":"");var t=audioPlayerEl&&isFinite(audioPlayerEl.duration)?audioPlayerEl.duration:0,n=audioPlayerEl?audioPlayerEl.currentTime:0;audioTime&&(audioTime.textContent=fmtAudioTime(n)+" / "+fmtAudioTime(t));var r=t>0?n/t*100:0;audioProgressFill&&(audioProgressFill.style.width=r+"%")}function clearAudioActiveSections(){audioSections.forEach(function(e){e.el.classList.remove("audio-active")})}function updateAudioActiveSection(){if(!audioMap.length){clearAudioActiveSections();return}for(var e=(audioPlayerEl.currentTime||0)*1e3,t=-1,n=0;n<audioMap.length;n++){var r=audioMap[n];if(e>=r.start_ms&&e<=r.end_ms){t=r.section_index;break}}audioSections.forEach(function(a){a.el.classList.toggle("audio-active",a.sectionIndex===t)})}function seekAudioTo(e){!audioReady||!audioPlayerEl||(audioPlayerEl.currentTime=Math.max(0,e/1e3),audioPlayerEl.play().catch(function(){}),updateAudioControls(),updateAudioActiveSection())}function closeAudioPlayer(){audioPlayerEl&&(audioPlayerEl.pause(),audioPlayerEl.removeAttribute("src"),audioPlayerEl.load()),audioBlobUrl&&(URL.revokeObjectURL(audioBlobUrl),audioBlobUrl=""),audioPlayerBar&&audioPlayerBar.classList.remove("visible"),document.querySelectorAll(".notes-audio-section.audio-active").forEach(function(e){e.classList.remove("audio-active")}),audioReady=!1,audioMap=[],audioSections=[]}function decorateNotesWithAudio(e){if(!(!e||!audioMap.length)){var t={};audioMap.forEach(function(d){t[d.section_index]=d});for(var n=e.querySelectorAll("h1,h2,h3"),r=0;r<n.length;r++){var a=n[r],i=t[r],s=document.createElement("div");s.className="notes-audio-section"+(i?" has-audio":""),s.dataset.sectionIndex=String(r),a.parentNode.insertBefore(s,a);for(var o=a;o;){var l=o.nextElementSibling;if(s.appendChild(o),!l||/^(H1|H2|H3)$/.test(l.tagName))break;o=l}i&&(function(d,f,c){audioSections.push({el:c,sectionIndex:f});var u=document.createElement("button");u.type="button",u.className="notes-audio-btn";var m=document.createElementNS("http://www.w3.org/2000/svg","svg");m.setAttribute("viewBox","0 0 24 24"),m.setAttribute("fill","currentColor");var v=document.createElementNS("http://www.w3.org/2000/svg","path");v.setAttribute("d","M8 5v14l11-7z"),m.appendChild(v),u.appendChild(m),u.addEventListener("click",function(h){h.stopPropagation(),seekAudioTo(d.start_ms)}),c.appendChild(u),c.addEventListener("click",function(h){h.target.tagName!=="A"&&seekAudioTo(d.start_ms)})})(i,r,s)}}}function initAudioForSelectedPack(){closeAudioPlayer(),!(!selectedPack||!selectedPack.has_audio_playback)&&(audioMap=selectedPack.has_audio_sync&&Array.isArray(selectedPack.notes_audio_map)?selectedPack.notes_audio_map.slice():[],audioPackTitle&&(audioPackTitle.textContent=selectedPack.title||"Lecture audio"),authenticatedFetch("/api/study-packs/"+encodeURIComponent(selectedPack.study_pack_id)+"/audio").then(function(e){return e.ok?e.blob():e.json().catch(function(){return{}}).then(function(t){throw new Error(t&&t.error||"Could not load audio")})}).then(function(e){!e||!e.size||(audioBlobUrl=URL.createObjectURL(e),audioPlayerEl.src=audioBlobUrl,audioPlayerEl.playbackRate=audioSpeeds[audioSpeedIndex],audioSpeedBtn.textContent=audioSpeeds[audioSpeedIndex]+"x",audioReady=!0,updateAudioBarVisibility(),updateAudioControls())}).catch(function(e){console.warn("Audio sync unavailable:",e&&e.message?e.message:e)}))}function clearHintFadeTimers(){difficultyFadeTimer&&(clearTimeout(difficultyFadeTimer),difficultyFadeTimer=null),keyboardHintFadeTimer&&(clearTimeout(keyboardHintFadeTimer),keyboardHintFadeTimer=null)}function scheduleHintFade(){clearHintFadeTimers(),learnStage.classList.contains("visible")&&(difficultyFadeTimer=setTimeout(function(){learnStage.classList.contains("visible")&&difficultyToolbar&&difficultyToolbar.classList.contains("visible")&&difficultyToolbar.classList.add("faded")},HINT_FADE_DELAY_MS),activeLearnMode==="flashcards"&&(keyboardHintFadeTimer=setTimeout(function(){learnStage.classList.contains("visible")&&keyboardHints&&keyboardHints.classList.add("faded")},HINT_FADE_DELAY_MS)))}function resetLearnHintVisibility(){difficultyToolbar&&difficultyToolbar.classList.remove("faded"),keyboardHints&&keyboardHints.classList.remove("faded"),scheduleHintFade()}function scheduleNotesFullscreenIdle(){notesFullscreenBtn&&(notesFullscreenFadeTimer&&(clearTimeout(notesFullscreenFadeTimer),notesFullscreenFadeTimer=null),notesFullscreenBtn.classList.remove("idle"),activeEditorPane==="notes"&&(notesFullscreenFadeTimer=setTimeout(function(){activeEditorPane==="notes"&&notesFullscreenBtn&&notesFullscreenBtn.classList.add("idle")},NOTES_ICON_IDLE_MS)))}function openNotesFullscreen(){var e=notesPaneShell||notesView;if(e)try{document.fullscreenElement===e?document.exitFullscreen():e.requestFullscreen()}catch(t){showToast("Fullscreen not available.","error")}}function ensureAuthToken(e){return authClient&&typeof authClient.ensureToken=="function"?authClient.ensureToken(!!e).then(function(t){return token=t,t}):auth.currentUser?token&&!e?Promise.resolve(token):auth.currentUser.getIdToken(!!e).then(function(t){return token=t,t}):Promise.reject(new Error("Please sign in"))}function withAuthHeaders(e,t){var n=e||{},r=Object.assign({},n.headers||{},{Authorization:"Bearer "+(t||token||"")}),a=typeof FormData!="undefined"&&n.body instanceof FormData;return n.body&&!a&&!r["Content-Type"]&&(r["Content-Type"]="application/json"),Object.assign({},n,{headers:r})}function performAuthenticatedFetch(e,t,n){return authClient&&typeof authClient.authFetch=="function"?authClient.authFetch(e,t,{retryOn401:n!==!1,ensureJsonContentType:!0}).then(function(r){if(typeof authClient.getToken=="function"){var a=authClient.getToken();a&&(token=a)}return r}):ensureAuthToken(!1).then(function(){return fetch(e,withAuthHeaders(t,token))}).then(function(r){return r.status===401&&n!==!1?ensureAuthToken(!0).then(function(){return fetch(e,withAuthHeaders(t,token))}):r})}function apiCall(e,t){return performAuthenticatedFetch(e,t,!0).then(function(n){var r=(n.headers.get("content-type")||"").indexOf("application/json")>=0;return(r?n.json():Promise.resolve(null)).then(function(a){if(!n.ok)throw n.status===401?new Error("Session expired. Please sign in again."):new Error(a&&a.error||"Request failed");return a})})}function authenticatedFetch(e,t,n){return performAuthenticatedFetch(e,t,n!==!1)}function downloadStudyPackCsv(e,t){var n=t==="test"?"study-pack-"+e+"-practice-test.csv":"study-pack-"+e+"-flashcards.csv";return authenticatedFetch("/api/study-packs/"+encodeURIComponent(e)+"/export-flashcards-csv?type="+encodeURIComponent(t)).then(function(r){return r.ok?downloadUtils.downloadResponseBlob?downloadUtils.downloadResponseBlob(r,n):r.blob().then(function(a){var i=URL.createObjectURL(a),s=document.createElement("a");s.href=i,s.download=n,document.body.appendChild(s),s.click(),document.body.removeChild(s),URL.revokeObjectURL(i)}):r.json().catch(function(){return{}}).then(function(a){throw new Error(a.error||"Could not export CSV")})})}function downloadStudyPackNotes(e,t){var n=(t||"docx").toLowerCase(),r="study-pack-"+e+"-notes."+(n==="md"?"md":"docx");return authenticatedFetch("/api/study-packs/"+encodeURIComponent(e)+"/export-notes?format="+encodeURIComponent(n)).then(function(a){return a.ok?downloadUtils.downloadResponseBlob?downloadUtils.downloadResponseBlob(a,r):a.blob().then(function(i){var s=URL.createObjectURL(i),o=document.createElement("a");o.href=s,o.download=r,document.body.appendChild(o),o.click(),document.body.removeChild(o),URL.revokeObjectURL(s)}):a.json().catch(function(){return{}}).then(function(i){throw new Error(i.error||"Could not export notes")})})}function downloadStudyPackPdf(e,t){var n=t!==!1,r="study-pack-"+e+(n?"":"-no-answers")+".pdf",a="include_answers="+(n?"1":"0");return authenticatedFetch("/api/study-packs/"+encodeURIComponent(e)+"/export-pdf?"+a).then(function(i){return i.ok?downloadUtils.downloadResponseBlob?downloadUtils.downloadResponseBlob(i,r):i.blob().then(function(s){var o=URL.createObjectURL(s),l=document.createElement("a");l.href=o,l.download=r,document.body.appendChild(l),l.click(),document.body.removeChild(l),URL.revokeObjectURL(o)}):i.json().catch(function(){return{}}).then(function(s){throw new Error(s.error||"Could not export PDF")})})}let activeModalOverlay=null,modalStateStack=[];function getModalContainer(e){return uxUtils.getModalContainer?uxUtils.getModalContainer(e,{containerSelector:".modal,.setup-modal,.builder-shell"}):e?e.querySelector('[role="dialog"]')||e.querySelector(".modal,.setup-modal,.builder-shell")||e.firstElementChild||e:null}function getModalFocusableElements(e){if(uxUtils.getFocusableElements)return uxUtils.getFocusableElements(e,{containerSelector:".modal,.setup-modal,.builder-shell"});var t=getModalContainer(e);if(!t)return[];var n='a[href],button:not([disabled]),textarea:not([disabled]),input:not([disabled]),select:not([disabled]),[tabindex]:not([tabindex="-1"])';return Array.from(t.querySelectorAll(n)).filter(function(r){return r.offsetParent!==null||r===document.activeElement})}function closeActiveModalFromEscape(){if(activeModalOverlay){if(activeModalOverlay===builderOverlay){handleBuilderExitRequest();return}if(activeModalOverlay===setupOverlay){closeSessionSetup();return}if(activeModalOverlay===folderModalOverlay){closeFolderModal();return}if(activeModalOverlay===confirmModalOverlay){closeConfirmModal(!1);return}if(activeModalOverlay===builderExitOverlay){closeBuilderExitModal("cancel");return}closeModal(activeModalOverlay)}}function openModal(e){e&&(modalStateStack.push({overlay:e,restore:document.activeElement}),e.classList.add("entering"),e.setAttribute("aria-hidden","false"),activeModalOverlay=e,requestAnimationFrame(function(){requestAnimationFrame(function(){e.classList.replace("entering","visible");var t=getModalFocusableElements(e);t.length&&t[0].focus()})}))}function closeModal(e){if(e){e.classList.remove("visible"),e.classList.remove("entering"),e.setAttribute("aria-hidden","true");for(var t=null,n=modalStateStack.length-1;n>=0;n--)if(modalStateStack[n].overlay===e){t=modalStateStack[n].restore||null,modalStateStack.splice(n,1);break}if(activeModalOverlay=modalStateStack.length?modalStateStack[modalStateStack.length-1].overlay:null,t&&typeof t.focus=="function")try{t.focus()}catch(r){}}}function openConfirmModal(e,t,n){return confirmModalTitle.textContent=e,confirmModalMessage.textContent=t,confirmModalConfirm.textContent=n||"Delete",openModal(confirmModalOverlay),new Promise(function(r){confirmModalResolver=r})}function closeConfirmModal(e){closeModal(confirmModalOverlay),confirmModalResolver&&(confirmModalResolver(!!e),confirmModalResolver=null)}var htmlUtils=window.LectureProcessorHtml||{},escapeHtml=htmlUtils.escapeHtml||function(e){return String(e||"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")},sanitizeHtmlFragment=htmlUtils.sanitizeHtmlFragment||function(e){var t=String(e||"");return window.DOMPurify&&typeof window.DOMPurify.sanitize=="function"?window.DOMPurify.sanitize(t):escapeHtml(t)},setSafeInnerHtml=htmlUtils.setSafeInnerHtml||function(e,t){e&&(e.innerHTML=sanitizeHtmlFragment(t))};function createDefaultQuestion(){return normalizeQuestion({question:"New question",options:["Option A","Option B","Option C","Option D"],answer:"Option A",explanation:""})}function buildDraftFromPack(e){var t=e||{};return{title:t.title||"",folder_id:t.folder_id||"",course:t.course||"",subject:t.subject||"",semester:t.semester||"",block:t.block||"",notes_markdown:t.notes_markdown||"",flashcards:(t.flashcards||[]).map(function(n){return{front:n.front||"",back:n.back||""}}),test_questions:(t.test_questions||[]).map(function(n){return normalizeQuestion(n)})}}function clearBuilderAutoSaveTimer(){builderAutoSaveTimer&&(window.clearTimeout(builderAutoSaveTimer),builderAutoSaveTimer=null)}function updateBuilderDirtyIndicator(){if(builderAutoSaving){builderStatDirty.textContent="Saving...",builderStatDirty.style.color="var(--gray-700)";return}builderStatDirty.textContent=builderDirty?"Yes":"No",builderStatDirty.style.color=builderDirty?"#991B1B":"var(--gray-900)"}function scheduleBuilderAutoSave(){if(!(builderMode!=="edit"||!builderDraft)&&builderOverlay.classList.contains("visible")){if(builderAutoSaving){builderAutoSaveQueued=!0;return}clearBuilderAutoSaveTimer(),builderAutoSaveTimer=window.setTimeout(function(){builderAutoSaveTimer=null,!(!builderDirty||builderMode!=="edit"||!builderDraft)&&builderOverlay.classList.contains("visible")&&(builderAutoSaving=!0,updateBuilderDirtyIndicator(),saveBuilderPack(!1,{silent:!0,refreshAfterSave:!1,skipAutoSave:!0}).finally(function(){builderAutoSaving=!1,updateBuilderDirtyIndicator(),builderAutoSaveQueued&&(builderAutoSaveQueued=!1,scheduleBuilderAutoSave())}))},BUILDER_AUTOSAVE_DELAY_MS)}}function markBuilderDirty(e,t){var n=t||{};builderDirty=e!==!1,builderDirty||(builderAutoSaveQueued=!1,clearBuilderAutoSaveTimer()),updateBuilderDirtyIndicator(),builderDirty&&!n.skipAutoSave&&scheduleBuilderAutoSave()}function updateBuilderStats(){builderDraft&&(builderStatCards.textContent=String((builderDraft.flashcards||[]).length),builderStatQuestions.textContent=String((builderDraft.test_questions||[]).length),builderSummary.textContent=(builderDraft.flashcards||[]).length+" cards \xB7 "+(builderDraft.test_questions||[]).length+" questions")}function renderBuilderFolderSelect(){var e=[{folder_id:"",name:"No folder"}].concat(folders.map(function(t){return{folder_id:t.folder_id,name:t.name}}));setSafeInnerHtml(builderFolderSelect,e.map(function(t){return'<option value="'+escapeHtml(t.folder_id)+'">'+escapeHtml(t.name)+"</option>"}).join("")),builderFolderSelect.value=builderDraft&&builderDraft.folder_id?builderDraft.folder_id:""}function renderBuilderInfoPane(){builderDraft&&(builderTitleInput.value=builderDraft.title||"",builderCourseInput.value=builderDraft.course||"",builderSubjectInput.value=builderDraft.subject||"",builderSemesterInput.value=builderDraft.semester||"",builderBlockInput.value=builderDraft.block||"",builderNotesInput.value=builderDraft.notes_markdown||"",renderBuilderFolderSelect(),syncBuilderAdvancedMetadataState())}function renderBuilderFlashcards(){if(builderDraft){var e=builderDraft.flashcards||[];if(!e.length){setSafeInnerHtml(builderFlashcardList,'<div class="builder-list-empty">No flashcards yet. Add one to start building your deck.<div class="builder-list-empty-actions"><button type="button" class="btn" id="builder-empty-add-card-btn">Add flashcard</button><button type="button" class="btn" id="builder-empty-import-card-btn">Import CSV</button></div></div>');var t=document.getElementById("builder-empty-add-card-btn"),n=document.getElementById("builder-empty-import-card-btn");t&&t.addEventListener("click",function(){builderAddCardBtn.click()}),n&&n.addEventListener("click",function(){setBuilderPane("import"),builderImportType.value="flashcards"}),updateBuilderStats();return}setSafeInnerHtml(builderFlashcardList,e.map(function(r,a){return'<div class="builder-row" data-fc-row="'+a+'"><div class="builder-row-head"><span class="builder-row-title">Flashcard '+(a+1)+'</span><button class="btn danger" data-delete-fc="'+a+'" style="padding:5px 8px;font-size:.75rem">Delete</button></div><div class="builder-split"><div class="field"><label>Front</label><textarea data-fc-field="front" data-fc-index="'+a+'" style="min-height:92px">'+escapeHtml(r.front||"")+'</textarea></div><div class="field"><label>Back</label><textarea data-fc-field="back" data-fc-index="'+a+'" style="min-height:92px">'+escapeHtml(r.back||"")+"</textarea></div></div></div>"}).join("")),updateBuilderStats()}}function renderBuilderQuestions(){if(builderDraft){var e=(builderDraft.test_questions||[]).map(normalizeQuestion);if(builderDraft.test_questions=e,!e.length){setSafeInnerHtml(builderQuestionList,'<div class="builder-list-empty">No practice questions yet. Add one to begin.<div class="builder-list-empty-actions"><button type="button" class="btn" id="builder-empty-add-question-btn">Add question</button><button type="button" class="btn" id="builder-empty-import-question-btn">Import CSV</button></div></div>');var t=document.getElementById("builder-empty-add-question-btn"),n=document.getElementById("builder-empty-import-question-btn");t&&t.addEventListener("click",function(){builderAddQuestionBtn.click()}),n&&n.addEventListener("click",function(){setBuilderPane("import"),builderImportType.value="questions"}),updateBuilderStats();return}setSafeInnerHtml(builderQuestionList,e.map(function(r,a){var i=(r.options||[]).map(function(s,o){var l=["A","B","C","D"][o]||"";return'<option value="'+escapeHtml(s)+'" '+(r.answer===s?"selected":"")+">"+l+": "+escapeHtml(s||"(empty)")+"</option>"}).join("");return'<div class="builder-row" data-q-row="'+a+'"><div class="builder-row-head"><span class="builder-row-title">Question '+(a+1)+'</span><button class="btn danger" data-delete-q="'+a+'" style="padding:5px 8px;font-size:.75rem">Delete</button></div><div class="field"><label>Question</label><textarea data-q-field="question" data-q-index="'+a+'" style="min-height:86px">'+escapeHtml(r.question||"")+'</textarea></div><div class="builder-grid-3" style="margin-top:8px"><div class="field"><label>Option A</label><input data-q-option="0" data-q-index="'+a+'" value="'+escapeHtml(r.options[0]||"")+'"></div><div class="field"><label>Option B</label><input data-q-option="1" data-q-index="'+a+'" value="'+escapeHtml(r.options[1]||"")+'"></div><div class="field"><label>Option C</label><input data-q-option="2" data-q-index="'+a+'" value="'+escapeHtml(r.options[2]||"")+'"></div></div><div class="builder-grid" style="margin-top:8px"><div class="field"><label>Option D</label><input data-q-option="3" data-q-index="'+a+'" value="'+escapeHtml(r.options[3]||"")+'"></div><div class="field"><label>Correct Answer</label><select class="builder-select" data-q-answer="'+a+'">'+i+'</select></div></div><div class="field" style="margin-top:8px"><label>Explanation (optional)</label><textarea data-q-field="explanation" data-q-index="'+a+'" style="min-height:72px">'+escapeHtml(r.explanation||"")+"</textarea></div></div>"}).join("")),updateBuilderStats()}}function setBuilderPane(e){builderPane=e,document.querySelectorAll(".builder-pane").forEach(function(t){t.classList.toggle("active",t.id==="builder-pane-"+e)}),builderPaneButtons.forEach(function(t){t.classList.toggle("active",t.dataset.builderPane===e)})}function clearBuilderImportState(){builderImportParsed=null,builderApplyImportBtn.disabled=!0,builderPreview.style.display="none",builderImportErrors.style.display="none",builderImportErrors.textContent="",builderImportSummary.textContent="No file loaded."}function openBuilderOverlay(e,t){var n=e==="create";builderMode=n?"create":"edit",builderAutoSaving=!1,builderAutoSaveQueued=!1,clearBuilderAutoSaveTimer(),builderPackId=n?"":t&&t.study_pack_id?t.study_pack_id:selectedPackId,builderDraft=buildDraftFromPack(n?{title:"",notes_markdown:"",flashcards:[],test_questions:[]}:t||selectedPack||{}),builderAdvancedMetadataOpen=!n&&(!!String(builderDraft.semester||"").trim()||!!String(builderDraft.block||"").trim()),builderTitleEl.textContent=n?"Create Study Pack":"Edit Study Pack",builderSubEl.textContent=n?"Start from scratch in a focused fullscreen workspace":"Refine cards, metadata, and imports in one place",builderBrandSub.textContent=n?"Manual creation flow":"Editing "+(builderDraft.title||"Untitled pack"),renderBuilderInfoPane(),renderBuilderFlashcards(),renderBuilderQuestions(),clearBuilderImportState(),setBuilderPane("info"),markBuilderDirty(!1),updateBuilderStats(),openModal(builderOverlay),document.body.style.overflow="hidden"}function closeBuilderOverlay(){builderAutoSaving=!1,builderAutoSaveQueued=!1,clearBuilderAutoSaveTimer(),closeModal(builderOverlay),document.body.style.overflow="",builderDraft=null,builderPackId="",builderImportParsed=null}function openBuilderExitModal(){return openModal(builderExitOverlay),new Promise(function(e){builderExitResolver=e})}function closeBuilderExitModal(e){closeModal(builderExitOverlay),builderExitResolver&&(builderExitResolver(e),builderExitResolver=null)}function handleBuilderExitRequest(){if(!builderDirty){closeBuilderOverlay();return}openBuilderExitModal().then(function(e){if(e==="save"){saveBuilderPack(!0);return}e==="discard"&&(markBuilderDirty(!1),closeBuilderOverlay())})}function getBuilderPayload(){return{title:(builderDraft.title||"").trim(),folder_id:builderDraft.folder_id||"",course:(builderDraft.course||"").trim(),subject:(builderDraft.subject||"").trim(),semester:(builderDraft.semester||"").trim(),block:(builderDraft.block||"").trim(),notes_markdown:builderDraft.notes_markdown||"",flashcards:builderDraft.flashcards||[],test_questions:(builderDraft.test_questions||[]).map(normalizeQuestion)}}function getDemoPackPayload(){return{title:"Demo Pack: Active Recall Basics",course:"Study Skills",subject:"Active Recall",semester:"Demo",block:"Starter",notes_markdown:`# Active Recall Starter Notes

## What active recall means

Active recall is studying by forcing yourself to retrieve information from memory instead of rereading notes.

## Quick method

1. Read a short section.
2. Hide the notes.
3. Write or say what you remember.
4. Check gaps and repeat.

## Spaced repetition link

Use increasing review intervals to revisit material before you forget it. Keep difficult cards in shorter intervals.`,flashcards:[{front:"What is active recall?",back:"A study method where you retrieve information from memory instead of passively rereading."},{front:"What should you do immediately after reading a short section?",back:"Hide the notes and try to recall the key points from memory."},{front:"Why combine active recall with spaced repetition?",back:"It improves long-term retention by reviewing just before forgetting."},{front:"What should you do after checking recall mistakes?",back:"Correct the gaps and test yourself again."}],test_questions:[{question:"Which action best matches active recall?",options:["Highlighting without testing","Rereading the same paragraph","Explaining the topic from memory","Copying slides word-for-word"],answer:"Explaining the topic from memory",explanation:"Active recall focuses on retrieval practice."},{question:"What is the main goal of spaced repetition?",options:["Study once for a long time","Review right before forgetting","Memorize only definitions","Avoid testing"],answer:"Review right before forgetting",explanation:"Spacing review sessions strengthens memory efficiently."},{question:"After a failed recall attempt, what should you do next?",options:["Skip the topic","Check notes and retry","Only read summaries","Delete the card"],answer:"Check notes and retry",explanation:"Feedback plus another recall attempt closes the memory gap."}]}}function createDemoPack(){if(!auth.currentUser){showToast("Please sign in first.","error");return}if(!creatingDemoPack){creatingDemoPack=!0;var e=packEmptyDemoBtn?packEmptyDemoBtn.textContent:"Create demo pack";packEmptyDemoBtn&&(packEmptyDemoBtn.disabled=!0,packEmptyDemoBtn.textContent="Creating demo pack..."),apiCall("/api/study-packs",{method:"POST",body:JSON.stringify(getDemoPackPayload())}).then(function(t){var n=t&&t.study_pack_id?t.study_pack_id:"";if(!n)throw new Error("Could not create demo pack");return selectedPackId=n,showToast("Demo pack created."),loadData(n)}).catch(function(t){showToast(t.message||"Could not create demo pack.","error")}).finally(function(){creatingDemoPack=!1,packEmptyDemoBtn&&(packEmptyDemoBtn.disabled=!1,packEmptyDemoBtn.textContent=e)})}}function saveBuilderPack(e,t){if(!builderDraft)return Promise.resolve();var n=t||{},r=getBuilderPayload();r.title||(r.title="Untitled pack"),clearBuilderAutoSaveTimer(),builderAutoSaveQueued=!1;var a;return builderMode==="create"?a=apiCall("/api/study-packs",{method:"POST",body:JSON.stringify(r)}):a=apiCall("/api/study-packs/"+encodeURIComponent(builderPackId||selectedPackId),{method:"PATCH",body:JSON.stringify(r)}),a.then(function(i){return builderMode==="create"&&i&&i.study_pack_id&&(builderPackId=i.study_pack_id,selectedPackId=i.study_pack_id,builderMode="edit"),n.refreshAfterSave===!1?(selectedPack&&selectedPackId&&(builderPackId||selectedPackId)===selectedPackId&&(selectedPack=Object.assign({},selectedPack,r,{study_pack_id:selectedPackId})),null):loadData(builderPackId||selectedPackId)}).then(function(){return markBuilderDirty(!1,{skipAutoSave:!0}),n.silent||showToast("Study pack saved."),e?closeBuilderOverlay():builderBrandSub.textContent="Editing "+(builderDraft&&builderDraft.title||"Untitled pack"),!0}).catch(function(i){return n.silent||showToast(i.message||"Could not save builder changes.","error"),!1})}function parseCsvRows(e){if(!(window.Papa&&typeof window.Papa.parse=="function"))return{rows:[],errors:["CSV parser is unavailable. Reload this page and try again."]};var t=window.Papa.parse(String(e||""),{delimiter:"",newline:"",quoteChar:'"',escapeChar:'"',skipEmptyLines:"greedy",dynamicTyping:!1}),n=t&&Array.isArray(t.data)?t.data:[],r=(t&&Array.isArray(t.errors)?t.errors:[]).map(function(a){var i=typeof a.row=="number"&&a.row>=0?" row "+(a.row+1):"",s=String(a.message||"Invalid CSV format");return"CSV parse error"+i+": "+s});return{rows:n,errors:r}}function normalizeHeader(e){return String(e||"").trim().toLowerCase().replace(/[\s\-]+/g,"_")}function parseBuilderCsvContent(e,t){var n=parseCsvRows(e||""),r=n.rows||[],a=(n.errors||[]).slice();if(a.length)return{type:t,items:[],errors:a,preview:[]};if(!r.length||r.every(function(_){return!_.join("").trim()}))return{type:t,items:[],errors:["The file appears to be empty."],preview:[]};if(r.length>5001)return{type:t,items:[],errors:["CSV has too many rows. Please keep imports to 5,000 data rows or fewer."],preview:[]};var i=(r[0]||[]).map(function(_){return normalizeHeader(_.replace(/^\uFEFF/,""))}),s=[],o=[];function l(_){return i.indexOf(_)}if(t==="flashcards"){var d=l("front"),f=l("back");if((d<0||f<0)&&(d=l("question"),f=l("answer")),d<0||f<0)return{type:t,items:[],errors:["Missing required headers. Use: front, back"],preview:[]};for(var c=1;c<r.length;c++){var u=r[c]||[];if(u.join("").trim()){if(u.length<i.length){s.push("Row "+(c+1)+": has fewer columns than the header row.");continue}var m=String(u[d]||"").trim(),v=String(u[f]||"").trim();if(!m||!v){s.push("Row "+(c+1)+": front and back are required.");continue}o.push({front:m,back:v})}}}else{var h=l("question"),b=l("option_a"),k=l("option_b"),g=l("option_c"),y=l("option_d"),I=l("answer"),w=l("explanation");if(h<0||b<0||k<0||g<0||y<0||I<0)return{type:t,items:[],errors:["Missing required headers. Use: question, option_a, option_b, option_c, option_d, answer (optional explanation)"],preview:[]};for(var E=1;E<r.length;E++){var p=r[E]||[];if(p.join("").trim()){if(p.length<i.length){s.push("Row "+(E+1)+": has fewer columns than the header row.");continue}var x=String(p[h]||"").trim(),S=[String(p[b]||"").trim(),String(p[k]||"").trim(),String(p[g]||"").trim(),String(p[y]||"").trim()],L=String(p[I]||"").trim(),C=w>=0?String(p[w]||"").trim():"";if(!x||S.some(function(_){return!_})){s.push("Row "+(E+1)+": question and all options are required.");continue}if(new Set(S).size!==4){s.push("Row "+(E+1)+": options must be unique.");continue}var B=L;if(/^[ABCD]$/i.test(L)&&(B=S["ABCD".indexOf(L.toUpperCase())]),S.indexOf(B)<0){s.push("Row "+(E+1)+": answer must match one option or use A-D.");continue}o.push({question:x,options:S,answer:B,explanation:C})}}}return{type:t,items:o,errors:s,preview:o.slice(0,10)}}function renderBuilderImportPreview(){if(!builderImportParsed||!builderImportParsed.items.length){builderPreview.style.display="none";return}var e=builderImportParsed,t=e.type==="flashcards"?["Front","Back"]:["Question","Answer","Explanation"],n=e.preview.map(function(r){return e.type==="flashcards"?"<tr><td>"+escapeHtml(r.front)+"</td><td>"+escapeHtml(r.back)+"</td></tr>":"<tr><td>"+escapeHtml(r.question)+"</td><td>"+escapeHtml(r.answer)+"</td><td>"+escapeHtml(r.explanation||"")+"</td></tr>"}).join("");setSafeInnerHtml(builderPreviewTable,"<thead><tr>"+t.map(function(r){return"<th>"+escapeHtml(r)+"</th>"}).join("")+"</tr></thead><tbody>"+n+"</tbody>"),builderPreview.style.display=""}function handleBuilderCsvFile(e){if(e){var t=new FileReader;t.onload=function(){var n=parseBuilderCsvContent(String(t.result||""),builderImportType.value);builderImportParsed=n,builderApplyImportBtn.disabled=!n.items.length,builderImportSummary.textContent="Loaded "+n.items.length+" valid row(s).",n.errors.length?(builderImportErrors.style.display="",setSafeInnerHtml(builderImportErrors,n.errors.map(function(r){return"<div>"+escapeHtml(r)+"</div>"}).join(""))):(builderImportErrors.style.display="none",builderImportErrors.textContent=""),renderBuilderImportPreview()},t.onerror=function(){showToast("Could not read CSV file.","error")},t.readAsText(e,"utf-8")}}function applyBuilderImport(){if(!(!builderDraft||!builderImportParsed||!builderImportParsed.items.length)){var e=builderImportMode.value==="replace";if(builderImportParsed.type==="flashcards")builderDraft.flashcards=e?builderImportParsed.items.slice():(builderDraft.flashcards||[]).concat(builderImportParsed.items),renderBuilderFlashcards();else{var t=builderImportParsed.items.map(normalizeQuestion);builderDraft.test_questions=e?t:(builderDraft.test_questions||[]).concat(t),renderBuilderQuestions()}markBuilderDirty(!0),updateBuilderStats(),showToast("Imported "+builderImportParsed.items.length+" row(s).")}}function downloadBuilderTemplate(){var e="",t="";builderImportType.value==="flashcards"?(e=`front,back
Cell membrane,Selective barrier surrounding the cell
Mitochondria,Organelle that produces ATP`,t="flashcards-template.csv"):(e=`question,option_a,option_b,option_c,option_d,answer,explanation
Which organelle produces ATP?,Nucleus,Mitochondria,Golgi apparatus,Ribosome,B,Mitochondria are the powerhouse of the cell.`,t="practice-test-template.csv");var n=new Blob([e],{type:"text/csv;charset=utf-8;"});if(downloadUtils.saveBlobAsFile)downloadUtils.saveBlobAsFile(n,t);else{var r=document.createElement("a");r.href=URL.createObjectURL(n),r.download=t,document.body.appendChild(r),r.click(),document.body.removeChild(r),URL.revokeObjectURL(r.href)}}function renderAlgoLane(){algoLane.innerHTML="",sessionAlgo.forEach(function(e,t){if(t>0){var n=document.createElement("div");n.className="algo-chevron",setSafeInnerHtml(n,'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="9 18 15 12 9 6"></polyline></svg>'),algoLane.appendChild(n)}var r=document.createElement("div");r.className="algo-slot",r.dataset.type=e,r.dataset.index=String(t),setSafeInnerHtml(r,(ALGO_ICONS[e]||"")+"<span>"+e.charAt(0).toUpperCase()+e.slice(1)+"</span>"),r.addEventListener("click",function(){var a=(ALGO_TYPES.indexOf(e)+1)%ALGO_TYPES.length;sessionAlgo[t]=ALGO_TYPES[a],sessionAlgoPreset="",renderAlgoLane(),renderAlgoPresets(),saveSessionState()}),algoLane.appendChild(r)})}function renderAlgoPresets(){algoPresets.forEach(function(e){e.classList.toggle("active",e.dataset.preset===sessionAlgoPreset)})}function applyAlgoPreset(e){ALGO_PRESETS[e]&&(sessionAlgo=ALGO_PRESETS[e].slice(),sessionAlgoPreset=e,renderAlgoLane(),renderAlgoPresets(),saveSessionState())}function renderSettingsRows(){document.querySelectorAll(".setting-row[data-setting]").forEach(function(e){e.classList.toggle("active",!!sessionSettings[e.dataset.setting])})}function renderLessonCards(){var e=selectedPack&&selectedPack.flashcards&&selectedPack.flashcards.length>0,t=selectedPack&&selectedPack.test_questions&&selectedPack.test_questions.length>0,n=selectedPack?(selectedPack.flashcards||[]).length:0,r=n>=MATCH_MIN_CARDS,a=document.getElementById("lesson-card-flashcards"),i=document.getElementById("lesson-card-test"),s=document.getElementById("lesson-card-write"),o=document.getElementById("lesson-card-match"),l=document.getElementById("match-min-badge");a.style.display=e?"":"none",i.style.display=t?"":"none",s.style.display=e?"":"none",o.style.display=e?"":"none",e&&!r?(o.classList.add("unavailable"),o.classList.remove("selected"),sessionLessons.match=!1,l.style.display="",l.textContent="Needs "+MATCH_MIN_CARDS+"+ cards"):(o.classList.remove("unavailable"),l.style.display="none"),e||(sessionLessons.flashcards=!1,sessionLessons.write=!1,sessionLessons.match=!1),t||(sessionLessons.test=!1),a.classList.toggle("selected",sessionLessons.flashcards),i.classList.toggle("selected",sessionLessons.test),s.classList.toggle("selected",sessionLessons.write),o.classList.toggle("selected",sessionLessons.match)}function renderMasteryGauge(){var e=selectedPack?selectedPack.flashcards||[]:[],t=e.length,n=loadCardState(),r=0,a=0,i=0,s=0,o=0,l=0,d=0;e.forEach(function(w,E){var p=n["fc_"+E];p&&parseInt(p.seen,10)>0&&(r++,p.level==="mastered"?i++:p.level==="familiar"&&a++,isDueDate(p.next_review_date)&&s++);var x=(p&&p.difficulty||"medium").toLowerCase();x==="easy"?o++:x==="hard"?d++:l++});var f=t-r,c=Math.max(0,t-i);if(masteryTotalEl.textContent=String(t),masterySeenEl.textContent=String(r),masteryNewPctEl.textContent=t?Math.round(f/t*100)+"%":"0%",masteryFamiliarPctEl.textContent=t?Math.round(a/t*100)+"%":"0%",masteryMasteredPctEl.textContent=t?Math.round(i/t*100)+"%":"0%",masteryDueTodayEl&&(masteryDueTodayEl.textContent=String(s)),masteryUnmasteredEl&&(masteryUnmasteredEl.textContent=String(c)),diffEasyCountEl&&(diffEasyCountEl.textContent=String(o)),diffMediumCountEl&&(diffMediumCountEl.textContent=String(l)),diffHardCountEl&&(diffHardCountEl.textContent=String(d)),examRecommendationEl){var u=selectedPack&&selectedPack.folder_id?folders.find(function(w){return w.folder_id===selectedPack.folder_id}):null,m=u&&u.exam_date?String(u.exam_date):"";if(!m)examRecommendationEl.textContent="Set an exam date in Planning mode to get a daily target recommendation.";else{var v=m.split("-"),h=new Date(parseInt(v[0],10),parseInt(v[1],10)-1,parseInt(v[2],10)),b=todayLocalDateString().split("-"),k=new Date(parseInt(b[0],10),parseInt(b[1],10)-1,parseInt(b[2],10)),g=Math.ceil((h.getTime()-k.getTime())/864e5);if(g<0)examRecommendationEl.textContent="Exam date has passed. Update the folder exam date to get a recommendation.";else{var y=Math.max(1,g===0?1:g),I=Math.max(0,Math.ceil(c/y));setSafeInnerHtml(examRecommendationEl,"Exam in <strong>"+Math.max(0,g)+"</strong> day"+(g===1?"":"s")+". Recommended: <strong>"+I+"</strong> unmastered cards/day.")}}}}function setSetupPane(e){activeSetupPane=e,setupTabs.forEach(function(t){t.classList.toggle("active",t.dataset.setupPane===e)}),["mastery","lessons","settings","algorithm"].forEach(function(t){var n=document.getElementById("setup-pane-"+t);n&&n.classList.toggle("active",t===e)})}function getEnabledModes(){var e=[];return sessionLessons.flashcards&&e.push("flashcards"),sessionLessons.test&&e.push("test"),sessionLessons.write&&e.push("write"),sessionLessons.match&&e.push("match"),e}function showModePicker(e){setupMainContent.style.display="none",modePicker.classList.add("active"),modePickerGrid.innerHTML="",e.forEach(function(t){var n=document.createElement("div");n.className="mode-picker-card",n.innerHTML=(MODE_ICONS[t]||"")+'<div class="mode-picker-card-title">'+(MODE_NAMES[t]||t)+'</div><div class="mode-picker-card-desc">'+(MODE_DESCS[t]||"")+"</div>",n.addEventListener("click",function(){closeSessionSetup(),openLearnStageWithMode(t,!1)}),modePickerGrid.appendChild(n)})}function hideModePicker(){modePicker.classList.remove("active"),setupMainContent.style.display=""}function openSessionSetup(){if(!selectedPack){showToast("Select a study pack first.","error");return}setAudioHiddenForLearn(!0),loadSessionState(),setupPackName.textContent=selectedPack.title||"Untitled pack",hideModePicker(),renderMasteryGauge(),renderLessonCards(),renderSettingsRows(),renderAlgoLane(),renderAlgoPresets(),setSetupPane("mastery"),openModal(setupOverlay)}function closeSessionSetup(){closeModal(setupOverlay),hideModePicker(),learnStage.classList.contains("visible")||setAudioHiddenForLearn(!1)}setupTabs.forEach(function(e){e.addEventListener("click",function(){setSetupPane(e.dataset.setupPane)})}),setupCloseBtn.addEventListener("click",closeSessionSetup),setupOverlay.addEventListener("click",function(e){e.target===setupOverlay&&closeSessionSetup()}),algoPresets.forEach(function(e){e.addEventListener("click",function(){applyAlgoPreset(e.dataset.preset)})}),document.querySelectorAll(".setting-row[data-setting]").forEach(function(e){e.addEventListener("click",function(){sessionSettings[e.dataset.setting]=!sessionSettings[e.dataset.setting],renderSettingsRows(),saveSessionState()})}),document.querySelectorAll(".lesson-card:not(.unavailable)").forEach(function(e){e.addEventListener("click",function(){var t=e.dataset.lesson;e.classList.contains("unavailable")||(t==="flashcards"&&(sessionLessons.flashcards=!sessionLessons.flashcards),t==="test"&&(sessionLessons.test=!sessionLessons.test),t==="write"&&(sessionLessons.write=!sessionLessons.write),t==="match"&&(sessionLessons.match=!sessionLessons.match),renderLessonCards(),saveSessionState())})}),modePickerBack.addEventListener("click",hideModePicker),setupStartBtn.addEventListener("click",function(){saveSessionState();var e=getEnabledModes();if(e.length===0){showToast("Select at least one lesson type.","error"),setSetupPane("lessons");return}e.length===1?(closeSessionSetup(),openLearnStageWithMode(e[0],!1)):showModePicker(e)});function initWriteMode(){writeIndex=0,writeRevealed=!1,writeChecked=!1,writePromptSwapped=!1,renderWriteCard()}function getWriteCards(){return getFlashcardQueue()}function renderWriteCard(){var e=getWriteCards();if(!e.length){writePromptEl.textContent="No flashcards available.",writeInputEl.style.display="none",writeCheckBtn.style.display="none",writeRevealBtn.style.display="none",writeNextBtn.style.display="none";return}var t=e[writeIndex],n=t.card||{};writePromptSwapped=sessionSettings.swapAnswerQuestion||sessionSettings.randomSwap&&Math.random()>.5,writePromptEl.textContent=writePromptSwapped?n.back||"":n.front||"",writeInputEl.value="",writeInputEl.disabled=!1,writeInputEl.className="write-input",writeInputEl.style.display="",writeCheckBtn.style.display="",writeRevealBtn.style.display="",writeFeedbackEl.className="write-feedback",writeFeedbackEl.style.display="",writeFeedbackEl.classList.remove("visible"),writeChecked=!1,writeRevealed=!1,writeProgressEl.textContent=writeIndex+1+" / "+e.length,writeNextBtn.style.display="",writeInputEl.focus(),updateLearnProgressBar(),updateDifficultyToolbar()}function checkWriteAnswer(){if(!(writeChecked||writeRevealed)){writeChecked=!0;var e=getWriteCards(),t=e[writeIndex]||{card:{},idx:writeIndex},n=t.card||{},r=writePromptSwapped?n.front||"":n.back||"",a=gradeAnswer(writeInputEl.value,r);writeInputEl.disabled=!0,markCardSeen("fc_"+t.idx,a),a?(writeInputEl.className="write-input correct-input",writeFeedbackEl.className="write-feedback visible correct-fb",writeFeedbackEl.textContent="Correct!"):(writeInputEl.className="write-input wrong-input",writeFeedbackEl.className="write-feedback visible wrong-fb",writeFeedbackEl.textContent="Incorrect. Expected: "+r)}}function revealWriteAnswer(){if(!writeRevealed){writeRevealed=!0,writeChecked=!0;var e=getWriteCards(),t=e[writeIndex]||{card:{},idx:writeIndex},n=t.card||{},r=writePromptSwapped?n.front||"":n.back||"";writeInputEl.disabled=!0,writeInputEl.className="write-input wrong-input",writeFeedbackEl.className="write-feedback visible wrong-fb",writeFeedbackEl.textContent="Answer: "+r,markCardSeen("fc_"+t.idx,!1)}}writeCheckBtn.addEventListener("click",function(){checkWriteAnswer(),resetLearnHintVisibility()}),writeRevealBtn.addEventListener("click",function(){revealWriteAnswer(),resetLearnHintVisibility()}),writeNextBtn.addEventListener("click",function(){var e=getWriteCards();writeIndex<e.length-1?(writeIndex++,renderWriteCard(),resetLearnHintVisibility()):showToast("All cards completed!")}),writeInputEl.addEventListener("keydown",function(e){e.key==="Enter"&&(e.preventDefault(),writeChecked?writeNextBtn.click():checkWriteAnswer())});function initMatchMode(){stopMatchTimer(),matchResultsEl.style.display="none",matchGridEl.style.display="",matchSelected=null,matchMatched=0;var e=selectedPack&&selectedPack.flashcards?selectedPack.flashcards:[],t=Math.min(6,Math.floor(e.length)),n=e.map(function(i,s){return{card:i,idx:s}}).sort(function(){return Math.random()-.5}),r=n.slice(0,t);matchTotal=t;var a=[];r.forEach(function(i,s){var o=i.card||{};a.push({id:"m_"+s,side:"front",text:o.front||"",pairId:s,cardIdx:i.idx}),a.push({id:"m_"+s,side:"back",text:o.back||"",pairId:s,cardIdx:i.idx})}),a.sort(function(){return Math.random()-.5}),matchCards=a,renderMatchGrid(),startMatchTimer()}function renderMatchGrid(){matchGridEl.innerHTML="",matchCards.forEach(function(e,t){var n=document.createElement("div");n.className="match-cell",n.textContent=e.text,n.dataset.idx=String(t),n.dataset.pairId=String(e.pairId),n.dataset.side=e.side,e.matched&&n.classList.add("matched"),n.addEventListener("click",function(){handleMatchClick(t)}),matchGridEl.appendChild(n)})}function handleMatchClick(e){var t=matchCards[e];if(!t.matched){var n=matchGridEl.children[e];if(matchSelected===null)matchSelected=e,n.classList.add("selected");else if(matchSelected===e)n.classList.remove("selected"),matchSelected=null;else{var r=matchCards[matchSelected],a=matchGridEl.children[matchSelected];if(r.pairId===t.pairId&&r.side!==t.side)r.matched=!0,t.matched=!0,a.classList.remove("selected"),a.classList.add("matched"),n.classList.add("matched"),matchMatched++,markCardSeen("fc_"+t.cardIdx,!0),matchMatched>=matchTotal&&(stopMatchTimer(),showMatchResults());else{n.classList.add("wrong-flash"),a.classList.add("wrong-flash");var i=matchSelected;setTimeout(function(){n.classList.remove("wrong-flash"),matchGridEl.children[i]&&matchGridEl.children[i].classList.remove("wrong-flash","selected")},500)}matchSelected=null}updateLearnProgressBar()}}function startMatchTimer(){matchStartTime=Date.now(),matchRunning=!0,matchElapsed=0,matchTimerEl.textContent="0.0s",matchTimerInterval=setInterval(function(){matchRunning&&(matchElapsed=Date.now()-matchStartTime,matchTimerEl.textContent=(matchElapsed/1e3).toFixed(1)+"s")},100)}function stopMatchTimer(){matchRunning=!1,matchTimerInterval&&(clearInterval(matchTimerInterval),matchTimerInterval=null)}function showMatchResults(){matchGridEl.style.display="none",matchResultsEl.style.display="";var e=matchElapsed,t=(e/1e3).toFixed(2);matchResultsTime.textContent=t+"s";var n=saveMatchScore(e),r=getScoreRank(n,e);r===1?(matchResultsBadge.textContent="New High Score!",matchResultsBadge.className="match-results-badge gold"):r===2?(matchResultsBadge.textContent="2nd Best Time!",matchResultsBadge.className="match-results-badge silver"):r===3?(matchResultsBadge.textContent="3rd Best Time!",matchResultsBadge.className="match-results-badge bronze"):(matchResultsBadge.textContent="",matchResultsBadge.className="match-results-badge");for(var a=[],i=["1st","2nd","3rd"],s=0;s<Math.min(3,n.length);s++)a.push(i[s]+": "+(n[s]/1e3).toFixed(2)+"s");matchResultsHistory.textContent=a.join(" \xB7 ")}matchPlayAgainBtn.addEventListener("click",function(){initMatchMode()});function setEditorPane(e){activeEditorPane=e,editorTabs.forEach(function(t){t.classList.toggle("active",t.dataset.editorPane===e)}),document.getElementById("editor-pane-notes").classList.toggle("active",e==="notes"),document.getElementById("editor-pane-flashcards").classList.toggle("active",e==="flashcards"),document.getElementById("editor-pane-test").classList.toggle("active",e==="test"),exportType=e==="test"?"test":"flashcards",e==="notes"&&scheduleNotesFullscreenIdle()}function getFolderPinsStorageKey(){return auth.currentUser?"pinned_folder_ids_"+auth.currentUser.uid:""}function isBuiltInFolderId(e){return e===BUILTIN_ALL_FOLDER_ID||e===BUILTIN_INTERVIEWS_FOLDER_ID}function sanitizePinnedFolderIds(e){if(!Array.isArray(e))return[];var t=new Set(folders.map(function(r){return String(r.folder_id||"")})),n=[];return e.forEach(function(r){var a=String(r||"").trim();!a||!t.has(a)||n.indexOf(a)>=0||n.push(a)}),n.slice(0,MAX_PINNED_FOLDERS)}function persistPinnedFolderIds(){var e=getFolderPinsStorageKey();if(e)try{localStorage.setItem(e,JSON.stringify(pinnedFolderIds))}catch(t){}}function loadPinnedFolderIds(){var e=getFolderPinsStorageKey();if(!e){pinnedFolderIds=[];return}try{pinnedFolderIds=sanitizePinnedFolderIds(JSON.parse(localStorage.getItem(e)||"[]"))}catch(t){pinnedFolderIds=[]}}function syncPinnedFolderIds(){pinnedFolderIds=sanitizePinnedFolderIds(pinnedFolderIds),persistPinnedFolderIds()}function isPinnedFolder(e){return pinnedFolderIds.indexOf(String(e||""))>=0}function togglePinnedFolder(e){var t=String(e||"").trim();if(t){var n=pinnedFolderIds.indexOf(t);if(n>=0){pinnedFolderIds.splice(n,1),persistPinnedFolderIds(),showToast("Folder unpinned."),renderFolders();return}if(pinnedFolderIds.length>=MAX_PINNED_FOLDERS){showToast("You can pin up to 5 folders. Unpin one first.","error");return}pinnedFolderIds.push(t),syncPinnedFolderIds(),showToast("Folder pinned."),renderFolders()}}function buildFolderItemsForSidebar(){var e=new Set(pinnedFolderIds),t=pinnedFolderIds.map(function(r){return folders.find(function(a){return a.folder_id===r})||null}).filter(Boolean).map(function(r){return Object.assign({},r,{is_pinned:!0,is_builtin:!1,is_fixed:!1})}),n=folders.filter(function(r){return!e.has(r.folder_id)}).map(function(r){return Object.assign({},r,{is_pinned:!1,is_builtin:!1,is_fixed:!1})});return[{folder_id:BUILTIN_ALL_FOLDER_ID,name:"All Study Packs",course:"",subject:"",semester:"",block:"",exam_date:"",is_pinned:!0,is_builtin:!0,is_fixed:!0,meta_default:"All packs"},{folder_id:BUILTIN_INTERVIEWS_FOLDER_ID,name:"Interviews",course:"",subject:"",semester:"",block:"",exam_date:"",is_pinned:!0,is_builtin:!0,is_fixed:!0,meta_default:"Interview transcript packs"}].concat(t,n)}function filteredPacks(){var e=searchInput.value.trim().toLowerCase();return packs.filter(function(t){if(selectedFolderId===BUILTIN_INTERVIEWS_FOLDER_ID){if((t.mode||"")!=="interview")return!1}else if(selectedFolderId&&selectedFolderId!==BUILTIN_ALL_FOLDER_ID&&t.folder_id!==selectedFolderId)return!1;if(!e)return!0;var n=((t.title||"")+" "+(t.course||"")+" "+(t.subject||"")+" "+(t.semester||"")+" "+(t.block||"")).toLowerCase();return n.indexOf(e)>=0})}function movePackToFolder(e,t){return apiCall("/api/study-packs/"+encodeURIComponent(e),{method:"PATCH",body:JSON.stringify({folder_id:t})}).then(function(){return showToast("Study pack moved."),loadData(e)}).catch(function(n){showToast(n.message||"Could not move pack.","error")})}function renderFolders(){var e=buildFolderItemsForSidebar();folderList.innerHTML="",e.forEach(function(t){var n=document.createElement("div");n.className="item"+(selectedFolderId===t.folder_id?" active":""),n.dataset.folderId=t.folder_id;var r=[t.course,t.subject,t.semester,t.block].filter(Boolean).map(escapeHtml),a=r.join(" &middot; ")||t.meta_default||"No metadata",i=t.is_pinned?'<div class="item-sub pinned-note">Pinned</div>':"",s="";if(t.folder_id&&!t.is_builtin&&t.exam_date){var o=String(t.exam_date).split("-");if(o.length===3){var l=new Date(parseInt(o[0],10),parseInt(o[1],10)-1,parseInt(o[2],10)),d=todayLocalDateString().split("-"),f=new Date(parseInt(d[0],10),parseInt(d[1],10)-1,parseInt(d[2],10)),c=Math.ceil((l.getTime()-f.getTime())/864e5),u="later",m="";c>0?m=c+" day"+(c===1?"":"s")+" until exam":c===0?(m="Exam today",u="overdue"):(m="Exam passed "+Math.abs(c)+" day"+(Math.abs(c)===1?"":"s")+" ago",u="overdue"),s='<div class="item-sub exam-countdown '+u+'">'+m+"</div>"}}var v="";if(!t.is_builtin){var h=t.is_pinned?"Unpin":"Pin";v='<span class="folder-head-actions"><button class="btn folder-mini-btn" data-toggle-pin="1">'+h+'</button><button class="btn folder-mini-btn" data-edit-folder="1">Edit</button></span>'}if(setSafeInnerHtml(n,'<div class="item-head"><span class="item-title">'+escapeHtml(t.name)+"</span>"+v+'</div><div class="item-sub">'+a+"</div>"+i+s),n.addEventListener("click",function(y){y.target.closest("[data-edit-folder]")||y.target.closest("[data-toggle-pin]")||(selectedFolderId=t.folder_id,renderFolders(),renderPacks())}),!t.is_builtin){var b=n.querySelector("[data-edit-folder]");b&&b.addEventListener("click",function(y){y.stopPropagation(),openFolderModal("edit",t)});var k=n.querySelector("[data-toggle-pin]");k&&k.addEventListener("click",function(y){y.stopPropagation(),togglePinnedFolder(t.folder_id)})}var g=!!(t.folder_id&&!t.is_builtin);n.addEventListener("dragover",function(y){y.preventDefault(),draggedPackId&&g&&n.classList.add("drop-target")}),n.addEventListener("dragleave",function(){n.classList.remove("drop-target")}),n.addEventListener("drop",function(y){y.preventDefault(),n.classList.remove("drop-target"),!(!draggedPackId||!g)&&(movePackToFolder(draggedPackId,t.folder_id),draggedPackId="")}),folderList.appendChild(n)})}function getFolderNameById(e){if(!e)return"No folder";if(e===BUILTIN_INTERVIEWS_FOLDER_ID)return"Interviews";var t=folders.find(function(n){return n.folder_id===e});return t?t.name:"No folder"}function setPackFolderSelection(e){packFolderSelect.value=e||"",packFolderLabel.textContent=getFolderNameById(e||""),packFolderMenu.querySelectorAll(".app-select-item").forEach(function(t){var n=t.dataset.value===(e||"");t.classList.toggle("active",n),t.setAttribute("aria-selected",n?"true":"false")})}function renderFolderSelect(){var e=[{folder_id:"",name:"No folder"}].concat(folders.map(function(t){return{folder_id:t.folder_id,name:t.name}}));packFolderMenu.innerHTML="",e.forEach(function(t){var n=document.createElement("button");n.type="button",n.className="app-select-item",n.dataset.value=t.folder_id,n.textContent=t.name,n.setAttribute("role","option"),n.setAttribute("aria-selected","false"),n.addEventListener("click",function(){setPackFolderSelection(t.folder_id),setPackFolderMenuOpen(!1),packFolderButton.focus()}),packFolderMenu.appendChild(n)}),setPackFolderSelection(packFolderSelect.value||"")}function renderPacks(){var e=filteredPacks();if(packList.innerHTML="",updatePackEmptyState(),!e.length){setSafeInnerHtml(packList,'<div class="empty">No study packs match this filter.<div class="builder-list-empty-actions"><button type="button" class="btn" id="clear-pack-filters-btn">Clear filters</button></div></div>');var t=document.getElementById("clear-pack-filters-btn");t&&t.addEventListener("click",function(){searchInput.value="",selectedFolderId="",renderFolders(),renderPacks()});return}e.forEach(function(n){var r=document.createElement("div");r.className="item"+(selectedPackId===n.study_pack_id?" active":""),r.draggable=!0,r.dataset.packId=n.study_pack_id;var a=escapeHtml(n.title||"Untitled pack"),i=escapeHtml(n.mode||""),s=[n.course,n.subject,n.semester,n.block].filter(Boolean).map(escapeHtml),o=n.mode==="interview"?"Folder: Interviews":"No metadata",l=s.join(" &middot; ")||(n.folder_name?"Folder: "+escapeHtml(n.folder_name):o);setSafeInnerHtml(r,'<div class="item-head"><span class="item-title">'+a+'</span></div><div class="item-sub">'+i+" &middot; "+n.flashcards_count+" cards &middot; "+n.test_questions_count+' questions</div><div class="item-sub">'+l+"</div>"),r.addEventListener("click",function(){selectedPackId=n.study_pack_id,renderPacks(),openPack(n.study_pack_id)}),r.addEventListener("dragstart",function(d){draggedPackId=n.study_pack_id,r.classList.add("dragging"),d.dataTransfer.effectAllowed="move",d.dataTransfer.setData("text/plain",n.study_pack_id)}),r.addEventListener("dragend",function(){r.classList.remove("dragging"),draggedPackId=""}),packList.appendChild(r)})}function showPackEditor(e){packEmpty.style.display=e?"none":"block",packEditorWrap.classList.toggle("visible",e),e||updatePackEmptyState()}function updatePackSummary(){if(!selectedPack){packSummary.classList.remove("visible");return}if(packSummary.classList.add("visible"),packSummaryTitle.textContent=selectedPack.title||"Untitled pack",packSummaryMeta.textContent=[selectedPack.course,selectedPack.subject,selectedPack.semester,selectedPack.block].filter(Boolean).join(" \xB7 ")||selectedPack.mode||"",packStatNotes.textContent=selectedPack.notes_markdown?"Has notes":"No notes",packStatCards.textContent=(selectedPack.flashcards||[]).length+" flashcards",packStatTest.textContent=(selectedPack.test_questions||[]).length+" questions",packStorageNote)if(selectedPack.has_audio_playback){var e=selectedPack.has_audio_sync?"Timestamp-linked note sections are enabled for this pack.":"Timestamp-linked sections are not enabled for this pack.";packStorageNote.textContent="Audio and transcript storage: This pack includes a private audio file for playback. "+e+' To remove stored audio/transcript data, delete this study pack or use "Delete account and data" from the user menu.'}else packStorageNote.textContent="Audio and transcript storage: This pack does not currently include a stored audio playback file."}function renderFlashcardEditor(e){var t=typeof e=="number"?e:-1,n=selectedPack&&Array.isArray(selectedPack.flashcards)?selectedPack.flashcards:[];if(flashcardCount.textContent=n.length+" flashcards",flashcardEditorList.innerHTML="",!n.length){setSafeInnerHtml(flashcardEditorList,'<div class="empty">No flashcards yet. Add one to start editing.</div>');return}if(n.forEach(function(i,s){var o=document.createElement("div");o.className="editor-card"+(s===t?" newly-added":""),o.dataset.rowIndex=String(s);var l=escapeHtml(i.front||""),d=escapeHtml(i.back||"");setSafeInnerHtml(o,'<div class="editor-card-head"><span class="editor-card-title">Flashcard '+(s+1)+'</span><button class="btn danger" data-delete-card="'+s+'" style="padding:5px 8px;font-size:0.75rem;">Delete</button></div><div class="field"><label>Front</label><input data-card-field="front" data-card-index="'+s+'" value="'+l+'"></div><div class="field" style="margin-top:8px;"><label>Back</label><textarea data-card-field="back" data-card-index="'+s+'">'+d+"</textarea></div>"),flashcardEditorList.appendChild(o)}),flashcardEditorList.querySelectorAll("[data-card-field]").forEach(function(i){i.addEventListener("input",function(){selectedPack.flashcards[parseInt(i.dataset.cardIndex,10)][i.dataset.cardField]=i.value})}),flashcardEditorList.querySelectorAll("[data-delete-card]").forEach(function(i){i.addEventListener("click",function(){selectedPack.flashcards.splice(parseInt(i.dataset.deleteCard,10),1),learnFlashcardIndex>=selectedPack.flashcards.length&&(learnFlashcardIndex=Math.max(0,selectedPack.flashcards.length-1)),renderFlashcardEditor(),showToast("Flashcard deleted.")})}),t>=0){var r=flashcardEditorList.querySelector('[data-row-index="'+t+'"]');if(r){r.scrollIntoView({behavior:"smooth",block:"center"});var a=r.querySelector('input[data-card-field="front"]');a&&a.focus()}}}function normalizeQuestion(e){for(var t={question:e.question||"",options:Array.isArray(e.options)?e.options.slice(0,4):[],answer:e.answer||"",explanation:e.explanation||""};t.options.length<4;)t.options.push("");return t.options.indexOf(t.answer)<0&&(t.answer=t.options[0]||""),t}function getAnswerDisplay(e){var t=Array.isArray(e.options)?e.options:[],n=t.indexOf(e.answer),r=n>=0?n:0;return(["A","B","C","D"][r]||"A")+": "+(t[r]||"(empty)")}function renderQuestionEditor(e){var t=typeof e=="number"?e:-1;selectedPack.test_questions=(selectedPack.test_questions||[]).map(normalizeQuestion);var n=selectedPack.test_questions;if(questionCount.textContent=n.length+" practice questions",questionEditorList.innerHTML="",!n.length){setSafeInnerHtml(questionEditorList,'<div class="empty">No practice questions yet. Add one to start editing.</div>');return}if(n.forEach(function(i,s){var o=document.createElement("div");o.className="editor-card"+(s===t?" newly-added":""),o.dataset.rowIndex=String(s);var l=escapeHtml(getAnswerDisplay(i)),d="q-answer-menu-"+s,f=escapeHtml(i.question||""),c=escapeHtml(i.options[0]||""),u=escapeHtml(i.options[1]||""),m=escapeHtml(i.options[2]||""),v=escapeHtml(i.options[3]||""),h=escapeHtml(i.explanation||"");setSafeInnerHtml(o,'<div class="editor-card-head"><span class="editor-card-title">Question '+(s+1)+'</span><button class="btn danger" data-delete-question="'+s+'" style="padding:5px 8px;font-size:0.75rem;">Delete</button></div><div class="field"><label>Question</label><textarea data-question-field="question" data-question-index="'+s+'">'+f+'</textarea></div><div class="q-options-grid" style="margin-top:8px;"><div class="field"><label>Option A</label><input data-option-index="0" data-question-index="'+s+'" value="'+c+'"></div><div class="field"><label>Option B</label><input data-option-index="1" data-question-index="'+s+'" value="'+u+'"></div><div class="field"><label>Option C</label><input data-option-index="2" data-question-index="'+s+'" value="'+m+'"></div><div class="field"><label>Option D</label><input data-option-index="3" data-question-index="'+s+'" value="'+v+'"></div></div><div class="field" style="margin-top:8px;"><label>Correct Answer</label><div class="app-select q-answer-picker" data-question-index="'+s+'"><button type="button" class="app-select-button" data-answer-button data-question-index="'+s+'" aria-haspopup="listbox" aria-expanded="false" aria-controls="'+d+'"><span class="app-select-label">'+l+'</span><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"></polyline></svg></button><div class="app-select-menu" id="'+d+'" role="listbox" data-answer-menu data-question-index="'+s+'">'+i.options.map(function(b,k){var g=i.answer===b;return'<button type="button" role="option" aria-selected="'+(g?"true":"false")+'" class="app-select-item'+(g?" active":"")+'" data-answer-item data-question-index="'+s+'" data-option-index="'+k+'">'+["A","B","C","D"][k]+": "+escapeHtml(b||"(empty)")+"</button>"}).join("")+'</div></div></div><div class="field" style="margin-top:8px;"><label>Explanation</label><textarea data-question-field="explanation" data-question-index="'+s+'">'+h+"</textarea></div>"),questionEditorList.appendChild(o)}),questionEditorList.querySelectorAll('[data-question-field="question"],[data-question-field="explanation"]').forEach(function(i){i.addEventListener("input",function(){selectedPack.test_questions[parseInt(i.dataset.questionIndex,10)][i.dataset.questionField]=i.value})}),questionEditorList.querySelectorAll("input[data-option-index]").forEach(function(i){i.addEventListener("input",function(){var s=parseInt(i.dataset.questionIndex,10),o=parseInt(i.dataset.optionIndex,10),l=selectedPack.test_questions[s];l.options[o]=i.value,l.options.indexOf(l.answer)<0&&(l.answer=l.options[0]||""),renderQuestionEditor(s)})}),questionEditorList.querySelectorAll("[data-answer-button]").forEach(function(i){i.addEventListener("click",function(s){s.stopPropagation();var o=i.parentElement.querySelector("[data-answer-menu]"),l=!o.classList.contains("visible");setQuestionAnswerMenuOpen(i,o,l,l?"active":null)}),i.addEventListener("keydown",function(s){var o=i.parentElement.querySelector("[data-answer-menu]");if(o){if(s.key==="ArrowDown"&&(s.preventDefault(),setQuestionAnswerMenuOpen(i,o,!0,"first")),s.key==="ArrowUp"&&(s.preventDefault(),setQuestionAnswerMenuOpen(i,o,!0,"last")),s.key==="Enter"||s.key===" "){s.preventDefault();var l=!o.classList.contains("visible");setQuestionAnswerMenuOpen(i,o,l,l?"active":null)}s.key==="Escape"&&(s.preventDefault(),setQuestionAnswerMenuOpen(i,o,!1,null))}})}),questionEditorList.querySelectorAll("[data-answer-menu]").forEach(function(i){i.addEventListener("keydown",function(s){if(s.key==="ArrowDown"&&(s.preventDefault(),focusMenuItem(i,"[data-answer-item]","next")),s.key==="ArrowUp"&&(s.preventDefault(),focusMenuItem(i,"[data-answer-item]","prev")),s.key==="Home"&&(s.preventDefault(),focusMenuItem(i,"[data-answer-item]","first")),s.key==="End"&&(s.preventDefault(),focusMenuItem(i,"[data-answer-item]","last")),s.key==="Escape"){s.preventDefault();var o=i.parentElement.querySelector("[data-answer-button]");setQuestionAnswerMenuOpen(o,i,!1,null),o&&o.focus()}s.key==="Tab"&&setQuestionAnswerMenuOpen(i.parentElement.querySelector("[data-answer-button]"),i,!1,null)})}),questionEditorList.querySelectorAll("[data-answer-item]").forEach(function(i){i.addEventListener("click",function(){var s=parseInt(i.dataset.questionIndex,10),o=parseInt(i.dataset.optionIndex,10);selectedPack.test_questions[s].answer=selectedPack.test_questions[s].options[o]||"",renderQuestionEditor(s)})}),questionEditorList.querySelectorAll("[data-delete-question]").forEach(function(i){i.addEventListener("click",function(){selectedPack.test_questions.splice(parseInt(i.dataset.deleteQuestion,10),1),learnQuestionIndex>=selectedPack.test_questions.length&&(learnQuestionIndex=Math.max(0,selectedPack.test_questions.length-1)),renderQuestionEditor(),showToast("Practice question deleted.")})}),t>=0){var r=questionEditorList.querySelector('[data-row-index="'+t+'"]');if(r){r.scrollIntoView({behavior:"smooth",block:"center"});var a=r.querySelector('textarea[data-question-field="question"]');a&&a.focus()}}}function updateLearnProgressBar(){var e=0,t=0;if(activeLearnMode==="flashcards"){var n=getFlashcardQueue();e=learnFlashcardIndex+1,t=n.length}else if(activeLearnMode==="test"){var r=selectedPack?selectedPack.test_questions||[]:[];e=learnQuestionIndex+1,t=r.length}else if(activeLearnMode==="write"){var a=getWriteCards();e=writeIndex+1,t=a.length}else activeLearnMode==="match"?(e=matchMatched,t=matchTotal):(e=1,t=1);learnProgressFill.style.width=t>0?e/t*100+"%":"0%",learnProgressText.textContent=t>0?e+"/"+t:""}var fcSliding=!1;function updateFlashcardContent(){var e=getFlashcardQueue();if(!e.length){learnFlashcardFront.textContent="No flashcards available.",learnFlashcardBack.textContent="",learnFProgress.textContent="Card 0 of 0",learnFPrev.disabled=!0,learnFNext.disabled=!0,learnFFlip.disabled=!0,updateLearnProgressBar();return}var t=e[learnFlashcardIndex]||{card:{},idx:learnFlashcardIndex},n=t.card||{},r=sessionSettings.swapAnswerQuestion||sessionSettings.randomSwap&&Math.random()>.5;learnFlashcardFront.textContent=r?n.back||"":n.front||"",learnFlashcardBack.textContent=r?n.front||"":n.back||"",learnFProgress.textContent="Card "+(learnFlashcardIndex+1)+" of "+e.length,learnFPrev.disabled=learnFlashcardIndex===0,learnFNext.disabled=learnFlashcardIndex===e.length-1,learnFFlip.disabled=!1,flashcardReviewedThisCard=!1,updateDifficultyToolbar(),updateLearnProgressBar()}function renderLearnFlashcard(){learnFlashcardInner.classList.toggle("flipped",learnFlashcardFlipped),updateFlashcardContent()}function doFlashcardSlide(e){if(!fcSliding){var t=getFlashcardQueue();if(t.length){var n;if(e==="next"){if(learnFlashcardIndex>=t.length-1)return;n=learnFlashcardIndex+1}else{if(learnFlashcardIndex<=0)return;n=learnFlashcardIndex-1}fcSliding=!0,learnFlashcardFlipped=!1,learnFlashcardInner.classList.remove("flipped");var r=e==="next"?"slide-left":"slide-right";learnFlashcardInner.classList.add(r),setTimeout(function(){learnFlashcardIndex=n,updateFlashcardContent()},130),setTimeout(function(){learnFlashcardInner.classList.remove(r),fcSliding=!1},320)}}}function renderLearnQuestion(){var e=selectedPack&&Array.isArray(selectedPack.test_questions)?selectedPack.test_questions:[];if(!e.length){learnQProgress.textContent="Question 0 of 0",learnQScore.textContent="Score: 0/0",learnQText.textContent="No practice questions available.",learnQOptions.innerHTML="",learnQExpl.classList.remove("visible"),learnQExpl.textContent="",updateLearnProgressBar();return}var t=e[learnQuestionIndex];learnAnswered=!1,learnQProgress.textContent="Question "+(learnQuestionIndex+1)+" of "+e.length,learnQScore.textContent="Score: "+learnScore+"/"+e.length,learnQText.textContent=t.question||"",learnQOptions.innerHTML="",learnQExpl.classList.remove("visible"),learnQExpl.textContent="",(t.options||[]).forEach(function(n){var r=document.createElement("button");r.type="button",r.className="quiz-option",r.textContent=n,r.addEventListener("click",function(){if(!learnAnswered){learnAnswered=!0;for(var a=n===t.answer,i=learnQOptions.querySelectorAll(".quiz-option"),s=0;s<i.length;s++)i[s].disabled=!0,i[s].textContent===t.answer&&i[s].classList.add("correct");a?(r.classList.add("correct"),learnScore+=1):r.classList.add("wrong"),markCardSeen("q_"+learnQuestionIndex,a),learnQScore.textContent="Score: "+learnScore+"/"+e.length,learnQExpl.textContent=t.explanation||"",learnQExpl.classList.add("visible"),updateLearnProgressBar(),resetLearnHintVisibility()}}),learnQOptions.appendChild(r)}),updateDifficultyToolbar(),updateLearnProgressBar()}function openLearnStageWithMode(e,t){if(!selectedPack){showToast("Select a study pack first.","error");return}learnSessionRecorded=!1,activeLearnMode=e,setAudioHiddenForLearn(!0),learnTitle.textContent=selectedPack.title||"Learn Mode",learnSub.textContent=(MODE_NAMES[e]||e)+" \xB7 Focused session",learnModeLabel.textContent=MODE_NAMES[e]||e;for(var n=document.querySelectorAll("#learn-stage .learn-pane"),r=0;r<n.length;r++)n[r].classList.remove("active");if(learnFlashcardIndex=0,learnFlashcardFlipped=!1,learnQuestionIndex=0,learnScore=0,orderedFlashcards=orderCardsByAlgo(selectedPack.flashcards||[]),fcSliding=!1,e==="flashcards"?(document.getElementById("learn-pane-flashcards").classList.add("active"),renderLearnFlashcard()):e==="test"?(document.getElementById("learn-pane-test").classList.add("active"),renderLearnQuestion()):e==="write"?(document.getElementById("learn-pane-write").classList.add("active"),initWriteMode()):e==="match"?(document.getElementById("learn-pane-match").classList.add("active"),initMatchMode()):(document.getElementById("learn-pane-notes").classList.add("active"),setSafeInnerHtml(learnNotesContent,mdToHtml(selectedPack.notes_markdown||"")),updateDifficultyToolbar()),updateLearnProgressBar(),learnStage.classList.add("entering"),requestAnimationFrame(function(){requestAnimationFrame(function(){learnStage.classList.replace("entering","visible")})}),resetLearnHintVisibility(),t)try{document.documentElement.requestFullscreen()}catch(a){}}function closeLearnStage(){if(recordLearnSessionCompletion(),learnStage.classList.remove("visible"),orderedFlashcards=[],stopMatchTimer(),activeLearnMode="",clearHintFadeTimers(),keyboardHints&&keyboardHints.classList.remove("faded"),setAudioHiddenForLearn(!1),updateDifficultyToolbar(),document.fullscreenElement)try{document.exitFullscreen()}catch(e){}}function openFolderModal(e,t){folderModalMode=e,editingFolderId=t&&t.folder_id?t.folder_id:"",folderModalTitle.textContent=e==="edit"?"Edit Folder":"Create Folder",folderNameInput.value=t&&t.name||"",folderCourseInput.value=t&&t.course||"",folderSubjectInput.value=t&&t.subject||"",folderSemesterInput.value=t&&t.semester||"",folderBlockInput.value=t&&t.block||"",folderExamDateInput.value=t&&t.exam_date||"",openModal(folderModalOverlay),setTimeout(function(){folderNameInput.focus()},100)}function closeFolderModal(){closeModal(folderModalOverlay),folderModalMode="create",editingFolderId="",folderNameInput.value="",folderCourseInput.value="",folderSubjectInput.value="",folderSemesterInput.value="",folderBlockInput.value="",folderExamDateInput.value=""}function saveFolderFromModal(){var e={name:folderNameInput.value.trim(),course:folderCourseInput.value.trim(),subject:folderSubjectInput.value.trim(),semester:folderSemesterInput.value.trim(),block:folderBlockInput.value.trim(),exam_date:folderExamDateInput.value||""};if(!e.name){showToast("Folder name is required.","error"),folderNameInput.focus();return}var t;folderModalMode==="edit"&&editingFolderId?t=apiCall("/api/study-folders/"+encodeURIComponent(editingFolderId),{method:"PATCH",body:JSON.stringify(e)}).then(function(){showToast("Folder updated.")}):t=apiCall("/api/study-folders",{method:"POST",body:JSON.stringify(e)}).then(function(){showToast("Folder created.")}),t.then(function(){return closeFolderModal(),loadData(selectedPackId||pendingOpenPackId)}).catch(function(n){showToast(n.message||"Could not save folder.","error")})}function openPack(e){return apiCall("/api/study-packs/"+encodeURIComponent(e)).then(function(t){if(selectedPack=t,selectedPack.flashcards=Array.isArray(selectedPack.flashcards)?selectedPack.flashcards:[],selectedPack.test_questions=Array.isArray(selectedPack.test_questions)?selectedPack.test_questions.map(normalizeQuestion):[],selectedPack.has_audio_playback=!!selectedPack.has_audio_playback,selectedPack.has_audio_sync=!!selectedPack.has_audio_sync,selectedPack.notes_audio_map=Array.isArray(selectedPack.notes_audio_map)?selectedPack.notes_audio_map:[],showPackEditor(!0),updatePackSummary(),packTitle.value=selectedPack.title||"",setPackFolderSelection(selectedPack.folder_id||""),packCourse.value=selectedPack.course||"",packSubject.value=selectedPack.subject||"",packSemester.value=selectedPack.semester||"",packBlock.value=selectedPack.block||"",packAdvancedMetadataOpen=!!String(selectedPack.semester||"").trim()||!!String(selectedPack.block||"").trim(),syncPackAdvancedMetadataState(),setSafeInnerHtml(notesView,mdToHtml(selectedPack.notes_markdown||"")),audioMap=selectedPack.has_audio_sync?selectedPack.notes_audio_map.slice():[],audioSections=[],selectedPack.has_audio_sync&&audioMap.length&&decorateNotesWithAudio(notesView),initAudioForSelectedPack(),renderFlashcardEditor(),renderQuestionEditor(),setEditorPane(activeEditorPane),openLearnFromUrl&&!autoLearnConsumed&&selectedPack.study_pack_id===learnPackFromUrl){autoLearnConsumed=!0;var n=focusFromUrl||"";n&&["flashcards","test","write","match"].indexOf(n)>=0?openLearnStageWithMode(n,fullscreenFromUrl):openSessionSetup()}})}function hydratePackStatesForKnownPacks(){if(auth.currentUser){cleanupCardStateCacheForKnownPacks();var e=auth.currentUser.uid,t=remoteProgressCardStates&&typeof remoteProgressCardStates=="object"?remoteProgressCardStates:{};packs.forEach(function(n){var r=String(n&&n.study_pack_id||"");if(r){var a="card_state_"+e+"_"+r,i={};try{i=JSON.parse(localStorage.getItem(a)||"{}")||{}}catch(o){i={}}var s=t[r]||{};if(!Object.keys(i).length&&Object.keys(s).length)try{localStorage.setItem(a,JSON.stringify(s))}catch(o){}(Object.keys(s).length||Object.keys(i).length)&&addPackToCardStateIndex(r)}}),cleanupCardStateCacheForKnownPacks()}}function loadData(e){var t=e||"";return Promise.all([apiCall("/api/study-folders"),apiCall("/api/study-packs")]).then(function(n){folders=n[0].folders||[],packs=n[1].study_packs||[],loadPinnedFolderIds(),syncPinnedFolderIds(),selectedFolderId&&selectedFolderId!==BUILTIN_INTERVIEWS_FOLDER_ID&&selectedFolderId!==BUILTIN_ALL_FOLDER_ID&&!folders.some(function(a){return a.folder_id===selectedFolderId})&&(selectedFolderId=""),hydratePackStatesForKnownPacks(),updateTopbarDueCount(),renderFolderSelect(),renderFolders(),renderPacks();var r=t||selectedPackId||"";if(r&&packs.find(function(a){return a.study_pack_id===r}))return selectedPackId=r,renderPacks(),openPack(r);if(learnPackFromUrl&&packs.find(function(a){return a.study_pack_id===learnPackFromUrl}))return selectedPackId=learnPackFromUrl,renderPacks(),openPack(learnPackFromUrl);selectedPack=null,showPackEditor(!1),updatePackSummary(),closeAudioPlayer()})}auth.onAuthStateChanged(function(e){if(!e){token=null,authClient&&typeof authClient.clearToken=="function"&&authClient.clearToken(),activeModalOverlay=null,modalStateStack=[],pinnedFolderIds=[],progressTimezone=getBrowserTimezone(),progressHydrationDone=!1,remoteProgressCardStates={},progressSyncTimer&&(clearTimeout(progressSyncTimer),progressSyncTimer=null),progressSyncInFlight=!1,builderOverlay.classList.contains("visible")&&(markBuilderDirty(!1),closeBuilderOverlay()),topbarUtils.applyAuthState?topbarUtils.applyAuthState({user:null,userTextEl:userMeta,signedOutText:"Not signed in"}):userMeta.textContent="Not signed in",topbarDueText&&(topbarDueText.textContent="0 due today");return}e.getIdToken().then(function(t){return token=t,authClient&&typeof authClient.setToken=="function"&&authClient.setToken(t),topbarUtils.applyAuthState?topbarUtils.applyAuthState({user:e,userTextEl:userMeta,signedInPrefix:"Signed in as "}):userMeta.textContent="Signed in as "+e.email,loadRemoteProgress().then(function(){return loadData()}).then(function(){queueProgressSync(!1)})}).catch(function(t){showToast(t.message||"Could not load study library.","error")})}),setInterval(function(){auth.currentUser&&auth.currentUser.getIdToken(!0).then(function(e){token=e,authClient&&typeof authClient.setToken=="function"&&authClient.setToken(e)}).catch(function(){})},600*1e3),createPackBtn.addEventListener("click",function(){if(!auth.currentUser){showToast("Please sign in first.","error");return}openBuilderOverlay("create",null)}),openBuilderBtn.addEventListener("click",function(){if(!auth.currentUser){showToast("Please sign in first.","error");return}if(!selectedPack){showToast("Select a study pack first.","error");return}openBuilderOverlay("edit",selectedPack)}),builderSaveBtn.addEventListener("click",function(){saveBuilderPack(!1)}),builderExitBtn.addEventListener("click",function(){handleBuilderExitRequest()}),builderPaneButtons.forEach(function(e){e.addEventListener("click",function(){setBuilderPane(e.dataset.builderPane)})}),builderOpenLearnShortcut.addEventListener("click",function(){if(builderDirty){showToast("Save changes before opening Learn mode.","error");return}if(!builderPackId){showToast("Save this new pack first.","error");return}openPack(builderPackId).then(function(){closeBuilderOverlay(),openSessionSetup()})}),builderTitleInput.addEventListener("input",function(){builderDraft&&(builderDraft.title=builderTitleInput.value,builderBrandSub.textContent="Editing "+(builderDraft.title||"Untitled pack"),markBuilderDirty(!0))}),builderFolderSelect.addEventListener("change",function(){builderDraft&&(builderDraft.folder_id=builderFolderSelect.value||"",markBuilderDirty(!0))}),builderCourseInput.addEventListener("input",function(){builderDraft&&(builderDraft.course=builderCourseInput.value,markBuilderDirty(!0))}),builderSubjectInput.addEventListener("input",function(){builderDraft&&(builderDraft.subject=builderSubjectInput.value,markBuilderDirty(!0))}),builderSemesterInput.addEventListener("input",function(){builderDraft&&(builderDraft.semester=builderSemesterInput.value,builderAdvancedMetadataOpen=!0,syncBuilderAdvancedMetadataState(),markBuilderDirty(!0))}),builderBlockInput.addEventListener("input",function(){builderDraft&&(builderDraft.block=builderBlockInput.value,builderAdvancedMetadataOpen=!0,syncBuilderAdvancedMetadataState(),markBuilderDirty(!0))}),builderNotesInput.addEventListener("input",function(){builderDraft&&(builderDraft.notes_markdown=builderNotesInput.value,markBuilderDirty(!0))}),builderAddCardBtn.addEventListener("click",function(){builderDraft&&(builderDraft.flashcards.push({front:"",back:""}),renderBuilderFlashcards(),markBuilderDirty(!0))}),builderAddCardBatchBtn.addEventListener("click",function(){if(builderDraft){for(var e=0;e<5;e++)builderDraft.flashcards.push({front:"",back:""});renderBuilderFlashcards(),markBuilderDirty(!0)}}),builderAddQuestionBtn.addEventListener("click",function(){builderDraft&&(builderDraft.test_questions.push(createDefaultQuestion()),renderBuilderQuestions(),markBuilderDirty(!0))}),builderAddQuestionBatchBtn.addEventListener("click",function(){if(builderDraft){for(var e=0;e<3;e++)builderDraft.test_questions.push(createDefaultQuestion());renderBuilderQuestions(),markBuilderDirty(!0)}}),builderFlashcardList.addEventListener("input",function(e){if(builderDraft){var t=e.target;if(t.matches("[data-fc-field]")){var n=parseInt(t.dataset.fcIndex,10),r=t.dataset.fcField;builderDraft.flashcards[n]&&(builderDraft.flashcards[n][r]=t.value,markBuilderDirty(!0))}}}),builderFlashcardList.addEventListener("click",function(e){if(builderDraft){var t=e.target.closest("[data-delete-fc]");if(t){var n=parseInt(t.dataset.deleteFc,10);builderDraft.flashcards.splice(n,1),renderBuilderFlashcards(),markBuilderDirty(!0)}}}),builderQuestionList.addEventListener("input",function(e){if(builderDraft){var t=e.target;if(t.matches("[data-q-field]")){var n=parseInt(t.dataset.qIndex,10),r=t.dataset.qField;builderDraft.test_questions[n]&&(builderDraft.test_questions[n][r]=t.value,markBuilderDirty(!0))}else if(t.matches("[data-q-option]")){var a=parseInt(t.dataset.qIndex,10),i=parseInt(t.dataset.qOption,10),s=builderDraft.test_questions[a];s&&(s.options[i]=t.value,s.options.indexOf(s.answer)<0&&(s.answer=s.options[0]||""),renderBuilderQuestions(),markBuilderDirty(!0))}}}),builderQuestionList.addEventListener("change",function(e){if(builderDraft){var t=e.target;if(t.matches("[data-q-answer]")){var n=parseInt(t.dataset.qAnswer,10);builderDraft.test_questions[n]&&(builderDraft.test_questions[n].answer=t.value,markBuilderDirty(!0))}}}),builderQuestionList.addEventListener("click",function(e){if(builderDraft){var t=e.target.closest("[data-delete-q]");if(t){var n=parseInt(t.dataset.deleteQ,10);builderDraft.test_questions.splice(n,1),renderBuilderQuestions(),markBuilderDirty(!0)}}}),builderImportType.addEventListener("change",clearBuilderImportState),builderCsvDrop.addEventListener("click",function(){builderCsvInput.click()}),builderCsvDrop.addEventListener("dragover",function(e){e.preventDefault(),builderCsvDrop.classList.add("dragover")}),builderCsvDrop.addEventListener("dragleave",function(){builderCsvDrop.classList.remove("dragover")}),builderCsvDrop.addEventListener("drop",function(e){e.preventDefault(),builderCsvDrop.classList.remove("dragover");var t=e.dataTransfer&&e.dataTransfer.files;t&&t[0]&&handleBuilderCsvFile(t[0])}),builderCsvInput.addEventListener("change",function(){builderCsvInput.files&&builderCsvInput.files[0]&&handleBuilderCsvFile(builderCsvInput.files[0])}),builderApplyImportBtn.addEventListener("click",applyBuilderImport),builderTemplateBtn.addEventListener("click",downloadBuilderTemplate),builderExitSave.addEventListener("click",function(){closeBuilderExitModal("save")}),builderExitDiscard.addEventListener("click",function(){closeBuilderExitModal("discard")}),builderExitCancel.addEventListener("click",function(){closeBuilderExitModal("cancel")}),builderExitOverlay.addEventListener("click",function(e){e.target===builderExitOverlay&&closeBuilderExitModal("cancel")}),window.addEventListener("beforeunload",function(e){builderDirty&&builderOverlay.classList.contains("visible")&&(e.preventDefault(),e.returnValue="")}),topbarUtils.bindRedirectButton?topbarUtils.bindRedirectButton(backAppBtn,"/dashboard"):backAppBtn.addEventListener("click",function(){window.location.href="/dashboard"}),fullscreenBtn.addEventListener("click",function(){if(!selectedPack){showToast("Select a study pack first.","error");return}openSessionSetup()}),searchInput.addEventListener("input",renderPacks),packEmptyCreateBtn&&packEmptyCreateBtn.addEventListener("click",function(){openBuilderOverlay("create",null)}),packEmptyDemoBtn&&packEmptyDemoBtn.addEventListener("click",createDemoPack),packAdvancedMetaBtn&&packAdvancedMetaBtn.addEventListener("click",function(){applyPackAdvancedMetadataState(!packAdvancedMetadataOpen)}),builderAdvancedMetaBtn&&builderAdvancedMetaBtn.addEventListener("click",function(){applyBuilderAdvancedMetadataState(!builderAdvancedMetadataOpen)}),packFolderButton.addEventListener("click",function(e){e.stopPropagation();var t=!packFolderMenu.classList.contains("visible");setPackFolderMenuOpen(t,t?"active":null)}),packFolderButton.addEventListener("keydown",function(e){if(e.key==="ArrowDown"&&(e.preventDefault(),setPackFolderMenuOpen(!0,"first")),e.key==="ArrowUp"&&(e.preventDefault(),setPackFolderMenuOpen(!0,"last")),e.key==="Enter"||e.key===" "){e.preventDefault();var t=!packFolderMenu.classList.contains("visible");setPackFolderMenuOpen(t,t?"active":null)}e.key==="Escape"&&(e.preventDefault(),setPackFolderMenuOpen(!1))}),packFolderMenu.addEventListener("keydown",function(e){e.key==="ArrowDown"&&(e.preventDefault(),focusMenuItem(packFolderMenu,".app-select-item","next")),e.key==="ArrowUp"&&(e.preventDefault(),focusMenuItem(packFolderMenu,".app-select-item","prev")),e.key==="Home"&&(e.preventDefault(),focusMenuItem(packFolderMenu,".app-select-item","first")),e.key==="End"&&(e.preventDefault(),focusMenuItem(packFolderMenu,".app-select-item","last")),e.key==="Escape"&&(e.preventDefault(),setPackFolderMenuOpen(!1),packFolderButton.focus()),e.key==="Tab"&&setPackFolderMenuOpen(!1)}),newFolderBtn.addEventListener("click",function(){openFolderModal("create",null)}),deleteFolderBtn.addEventListener("click",function(){if(!selectedFolderId){showToast("Select a folder first.","error");return}if(isBuiltInFolderId(selectedFolderId)){showToast("This folder is pinned by default and cannot be deleted.","error");return}openConfirmModal("Delete Folder","Delete this folder? Packs inside will move to no folder.","Delete Folder").then(function(e){e&&apiCall("/api/study-folders/"+encodeURIComponent(selectedFolderId),{method:"DELETE"}).then(function(){return pinnedFolderIds=pinnedFolderIds.filter(function(t){return t!==selectedFolderId}),persistPinnedFolderIds(),selectedFolderId="",showToast("Folder deleted."),loadData(selectedPackId)}).catch(function(t){showToast(t.message||"Could not delete folder.","error")})})}),savePackBtn.addEventListener("click",function(){if(!selectedPackId||!selectedPack){showToast("Select a study pack first.","error");return}apiCall("/api/study-packs/"+encodeURIComponent(selectedPackId),{method:"PATCH",body:JSON.stringify({title:packTitle.value.trim(),folder_id:packFolderSelect.value,course:packCourse.value.trim(),subject:packSubject.value.trim(),semester:packSemester.value.trim(),block:packBlock.value.trim(),flashcards:selectedPack.flashcards||[],test_questions:selectedPack.test_questions||[]})}).then(function(){return pendingOpenPackId=selectedPackId,loadData(selectedPackId)}).then(function(){pendingOpenPackId="",showToast("Study pack saved.")}).catch(function(e){showToast(e.message||"Could not save study pack.","error")})}),deletePackBtn.addEventListener("click",function(){if(!selectedPackId){showToast("Select a study pack first.","error");return}openConfirmModal("Delete Study Pack","Delete this study pack permanently? This cannot be undone.","Delete Pack").then(function(e){if(e){var t=selectedPackId;apiCall("/api/study-packs/"+encodeURIComponent(selectedPackId),{method:"DELETE"}).then(function(){return apiCall("/api/study-progress",{method:"PUT",body:JSON.stringify({remove_pack_ids:[t]})}).catch(function(){})}).then(function(){return removePackLocalCaches(t),selectedPackId="",selectedPack=null,showPackEditor(!1),updatePackSummary(),loadData()}).then(function(){showToast("Study pack deleted.")}).catch(function(n){showToast(n.message||"Could not delete study pack.","error")})}})}),exportPackNotesBtn.addEventListener("click",function(){if(!selectedPackId){showToast("Select a study pack first.","error");return}downloadStudyPackNotes(selectedPackId,"docx").then(function(){showToast("Lecture notes export started.")}).catch(function(e){showToast(e.message||"Could not export notes.","error")})}),exportMenuBtn&&exportMenuList&&(exportMenuBtn.addEventListener("click",function(e){e.stopPropagation();var t=!exportMenuList.classList.contains("visible");setExportMenuOpen(t,t?"first":null)}),exportMenuBtn.addEventListener("keydown",function(e){if(e.key==="ArrowDown"&&(e.preventDefault(),setExportMenuOpen(!0,"first")),e.key==="ArrowUp"&&(e.preventDefault(),setExportMenuOpen(!0,"last")),e.key==="Enter"||e.key===" "){e.preventDefault();var t=!exportMenuList.classList.contains("visible");setExportMenuOpen(t,t?"first":null)}e.key==="Escape"&&(e.preventDefault(),setExportMenuOpen(!1))}),exportMenuList.addEventListener("click",function(e){var t=e.target.closest(".export-menu-item[data-export-kind]");if(t){if(!selectedPackId){showToast("Select a study pack first.","error");return}var n=t.dataset.exportKind;if(n==="pdf-menu"){if(e.stopPropagation(),exportPdfSubmenu){var r=!exportPdfSubmenu.classList.contains("visible");setExportPdfSubmenuOpen(r),r&&focusMenuItem(exportPdfSubmenu,".export-menu-item","first")}return}if(setExportMenuOpen(!1),n==="pdf-with-answers"){downloadStudyPackPdf(selectedPackId,!0).then(function(){showToast("PDF export started.")}).catch(function(i){showToast(i.message||"Could not export PDF.","error")});return}if(n==="pdf-no-answers"){downloadStudyPackPdf(selectedPackId,!1).then(function(){showToast("Practice PDF export started.")}).catch(function(i){showToast(i.message||"Could not export PDF.","error")});return}var a=n==="test"?"test":"flashcards";downloadStudyPackCsv(selectedPackId,a).then(function(){showToast("CSV export started.")}).catch(function(i){showToast(i.message||"Could not export CSV.","error")})}}),exportMenuList.addEventListener("keydown",function(e){var t=document.activeElement,n=t&&t.closest(".export-menu-item");if(e.key==="ArrowDown"&&(e.preventDefault(),focusMenuItem(exportMenuList,".export-menu-item","next")),e.key==="ArrowUp"&&(e.preventDefault(),focusMenuItem(exportMenuList,".export-menu-item","prev")),e.key==="Home"&&(e.preventDefault(),focusMenuItem(exportMenuList,".export-menu-item","first")),e.key==="End"&&(e.preventDefault(),focusMenuItem(exportMenuList,".export-menu-item","last")),e.key==="Escape"&&(e.preventDefault(),setExportMenuOpen(!1),exportMenuBtn.focus()),e.key==="ArrowRight"&&n&&n.dataset.exportKind==="pdf-menu"&&(e.preventDefault(),setExportPdfSubmenuOpen(!0),focusMenuItem(exportPdfSubmenu,".export-menu-item","first")),e.key==="ArrowLeft"&&n&&n.closest("#export-pdf-submenu")){e.preventDefault(),setExportPdfSubmenuOpen(!1);var r=exportMenuList.querySelector('[data-export-kind="pdf-menu"]');r&&r.focus()}e.key==="Tab"&&setExportMenuOpen(!1)})),openLearnBtn.addEventListener("click",function(){openSessionSetup()}),editorTabs.forEach(function(e){e.addEventListener("click",function(){setEditorPane(e.dataset.editorPane)})}),addFlashcardBtn.addEventListener("click",function(){if(selectedPack){selectedPack.flashcards=selectedPack.flashcards||[],selectedPack.flashcards.push({front:"New concept",back:"New explanation"});var e=selectedPack.flashcards.length-1;learnFlashcardIndex=e,learnFlashcardFlipped=!1,renderFlashcardEditor(e),setEditorPane("flashcards"),showToast("New flashcard added.")}}),addQuestionBtn.addEventListener("click",function(){if(selectedPack){selectedPack.test_questions=selectedPack.test_questions||[],selectedPack.test_questions.push(normalizeQuestion({question:"New question",options:["Option A","Option B","Option C","Option D"],answer:"Option A",explanation:"Add explanation here."}));var e=selectedPack.test_questions.length-1;learnQuestionIndex=e,renderQuestionEditor(e),setEditorPane("test"),showToast("New practice question added.")}}),topbarUtils.bindRedirectButton?topbarUtils.bindRedirectButton(learnBackAppBtn,"/dashboard"):learnBackAppBtn.addEventListener("click",function(){window.location.href="/dashboard"}),learnBackLibraryBtn.addEventListener("click",closeLearnStage),learnFullscreenBtn.addEventListener("click",function(){try{document.fullscreenElement?document.exitFullscreen():document.documentElement.requestFullscreen()}catch(e){showToast("Fullscreen not available.","error")}}),notesFullscreenBtn&&(notesFullscreenBtn.addEventListener("click",openNotesFullscreen),notesFullscreenBtn.addEventListener("mouseenter",function(){notesFullscreenBtn.classList.remove("idle")})),notesPaneShell&&notesPaneShell.addEventListener("mouseenter",function(){activeEditorPane==="notes"&&scheduleNotesFullscreenIdle()}),audioPlayBtn.addEventListener("click",function(){audioReady&&(audioPlayerEl.paused?audioPlayerEl.play().catch(function(){}):audioPlayerEl.pause())}),audioCloseBtn.addEventListener("click",closeAudioPlayer),audioSpeedBtn.addEventListener("click",function(){audioReady&&(audioSpeedIndex=(audioSpeedIndex+1)%audioSpeeds.length,audioPlayerEl.playbackRate=audioSpeeds[audioSpeedIndex],audioSpeedBtn.textContent=audioSpeeds[audioSpeedIndex]+"x")}),audioProgressWrap.addEventListener("click",function(e){if(!(!audioReady||!audioPlayerEl.duration)){var t=audioProgressWrap.getBoundingClientRect(),n=Math.max(0,Math.min(1,(e.clientX-t.left)/t.width));audioPlayerEl.currentTime=n*audioPlayerEl.duration,updateAudioControls(),updateAudioActiveSection()}}),audioPlayerEl.addEventListener("loadedmetadata",updateAudioControls),audioPlayerEl.addEventListener("play",updateAudioControls),audioPlayerEl.addEventListener("pause",updateAudioControls),audioPlayerEl.addEventListener("ended",function(){updateAudioControls(),clearAudioActiveSections()}),audioPlayerEl.addEventListener("timeupdate",function(){updateAudioControls(),updateAudioActiveSection()}),difficultyButtons.forEach(function(e){e.addEventListener("click",function(){var t=getCurrentDifficultyCardId();t&&(setCardDifficulty(t,e.dataset.difficulty),resetLearnHintVisibility())})}),learnFlashcard3d.addEventListener("click",function(){if(!fcSliding){if(learnFlashcardFlipped=!learnFlashcardFlipped,learnFlashcardFlipped&&!flashcardReviewedThisCard){var e=getFlashcardQueue(),t=e[learnFlashcardIndex];t&&(markCardViewed("fc_"+t.idx),flashcardReviewedThisCard=!0)}renderLearnFlashcard(),resetLearnHintVisibility()}}),learnFPrev.addEventListener("click",function(){doFlashcardSlide("prev"),resetLearnHintVisibility()}),learnFNext.addEventListener("click",function(){doFlashcardSlide("next"),resetLearnHintVisibility()}),learnFFlip.addEventListener("click",function(){if(!fcSliding){if(learnFlashcardFlipped=!learnFlashcardFlipped,learnFlashcardFlipped&&!flashcardReviewedThisCard){var e=getFlashcardQueue(),t=e[learnFlashcardIndex];t&&(markCardViewed("fc_"+t.idx),flashcardReviewedThisCard=!0)}renderLearnFlashcard(),resetLearnHintVisibility()}}),learnQNext.addEventListener("click",function(){var e=selectedPack&&selectedPack.test_questions?selectedPack.test_questions:[];e.length&&(learnQuestionIndex<e.length-1?(learnQuestionIndex++,renderLearnQuestion(),resetLearnHintVisibility()):showToast("All questions completed!"))}),window.addEventListener("keydown",function(e){if(activeModalOverlay){if(e.key==="Escape"){e.preventDefault(),closeActiveModalFromEscape();return}if(e.key==="Tab"){var t=getModalFocusableElements(activeModalOverlay);if(!t.length)return;var n=t[0],r=t[t.length-1],a=document.activeElement;if(e.shiftKey&&a===n){e.preventDefault(),r.focus();return}if(!e.shiftKey&&a===r){e.preventDefault(),n.focus();return}}return}if(builderOverlay.classList.contains("visible")&&e.key==="Escape"){e.preventDefault(),handleBuilderExitRequest();return}if(learnStage.classList.contains("visible")){var i=document.activeElement,s=i&&(i.tagName==="INPUT"||i.tagName==="TEXTAREA"||i.tagName==="SELECT"||i.isContentEditable);if(!s&&["flashcards","write","test"].indexOf(activeLearnMode)>=0&&(e.key==="1"||e.key==="2"||e.key==="3")){e.preventDefault();var o=getCurrentDifficultyCardId();if(o){var l=e.key==="1"?"easy":e.key==="2"?"medium":"hard";setCardDifficulty(o,l),resetLearnHintVisibility()}return}activeLearnMode==="flashcards"&&(e.key==="ArrowLeft"&&(e.preventDefault(),doFlashcardSlide("prev"),resetLearnHintVisibility()),e.key==="ArrowRight"&&(e.preventDefault(),doFlashcardSlide("next"),resetLearnHintVisibility()),e.code==="Space"&&(e.preventDefault(),learnFFlip.click(),resetLearnHintVisibility()))}}),folderModalClose.addEventListener("click",closeFolderModal),folderModalCancel.addEventListener("click",closeFolderModal),folderModalSave.addEventListener("click",saveFolderFromModal),folderModalOverlay.addEventListener("click",function(e){e.target===folderModalOverlay&&closeFolderModal()}),document.addEventListener("click",function(e){packFolderPicker.contains(e.target)||setPackFolderMenuOpen(!1),exportMenu&&!exportMenu.contains(e.target)&&exportMenuList&&setExportMenuOpen(!1),e.target.closest(".q-answer-picker")||closeQuestionAnswerMenus()}),confirmModalClose.addEventListener("click",function(){closeConfirmModal(!1)}),confirmModalCancel.addEventListener("click",function(){closeConfirmModal(!1)}),confirmModalConfirm.addEventListener("click",function(){closeConfirmModal(!0)}),confirmModalOverlay.addEventListener("click",function(e){e.target===confirmModalOverlay&&closeConfirmModal(!1)});
